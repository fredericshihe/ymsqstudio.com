<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0" />
	<title>é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ ç´æˆ¿ç®¡ç†ç³»ç»Ÿ Â· å…¨æ–°</title>
	<style>
		:root {
			--bg:#0e1116; --bg-alt:#161b22; --surface:#1f252d; --surface-alt:#242b35; --outline:#2f3844; --outline-hover:#3d4957; --divider:#212a33;
			--accent:#4c8dff; --accent-hover:#6aa1ff; --danger:#ff5f56; --warn:#ffb347; --ok:#3fbf6b; --text:#e6ecf3; --text-dim:#9aa7b4; --focus:0 0 0 2px rgba(76,141,255,.45);
			--radius-sm:6px; --radius:12px; --radius-lg:18px; --transition:.18s cubic-bezier(.4,0,.2,1);
			--card-min-h:150px; --grid-gap:16px; --shadow:0 4px 14px -6px rgba(0,0,0,.55);
			font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif; color:var(--text);
		}

	.sl-btn {
		display:inline-flex;
		align-items:center;
		justify-content:center;
		padding:8px 14px;
		font-size:13px;
		font-weight:600;
		line-height:1;
		text-align:center;
		border:1px solid;
		border-radius:6px;
		cursor:pointer;
		transition:all 0.2s ease;
		text-decoration:none;
		white-space:nowrap;
		letter-spacing:.3px;
		min-height:32px;
	}

		.sl-btn:hover {
			transform: translateY(-1px);
			box-shadow: 0 2px 6px rgba(0,0,0,0.1);
		}

		.sl-btn:active {
			transform: translateY(0);
			box-shadow: 0 1px 3px rgba(0,0,0,0.1);
		}

		.sl-btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* ä¸»è¦æŒ‰é’® - è“è‰² */
		.sl-btn-primary {
			background: #2563eb;
			border-color: #1d4ed8;
			color: #ffffff;
		}

		.sl-btn-primary:hover {
			background: #1d4ed8;
			border-color: #1e40af;
		}

		/* æˆåŠŸæŒ‰é’® - ç»¿è‰² */
		.sl-btn-success {
			background: #16a34a;
			border-color: #15803d;
			color: #ffffff;
		}

		.sl-btn-success:hover {
			background: #15803d;
			border-color: #166534;
		}

		/* å±é™©æŒ‰é’® - çº¢è‰² */
		.sl-btn-danger {
			background: #dc2626;
			border-color: #b91c1c;
			color: #ffffff;
		}

		.sl-btn-danger:hover {
			background: #b91c1c;
			border-color: #991b1b;
		}

		/* æ¬¡è¦æŒ‰é’® - ç°è‰² */
		.sl-btn-secondary {
			background: #f1f5f9;
			border-color: #cbd5e1;
			color: #475569;
		}

		.sl-btn-secondary:hover {
			background: #e2e8f0;
			border-color: #94a3b8;
			color: #334155;
		}

		/* å¼ºè°ƒæŒ‰é’® - æ·±ç°è‰² */
		.sl-btn-accent {
			background: #475569;
			border-color: #334155;
			color: #ffffff;
		}

		.sl-btn-accent:hover {
			background: #334155;
			border-color: #1e293b;
		}

		/* è½®å»“æŒ‰é’® - é€æ˜èƒŒæ™¯ */
		.sl-btn-outline {
			background: transparent;
			border-color: #64748b;
			color: #475569;
		}

		.sl-btn-outline:hover {
			background: #f8fafc;
			border-color: #475569;
			color: #334155;
		}

		/* å°å‹æŒ‰é’® */
		.sl-btn-sm {
			padding: 6px 10px;
			font-size: 12px;
			min-height: 28px;
		}

		/* è¿·ä½ æŒ‰é’®ï¼ˆç”¨äºåˆ—è¡¨é¡¹ï¼‰ */
		.sl-btn-mini {
			padding: 4px 8px;
			font-size: 11px;
			font-weight: 500;
			min-height: 24px;
			border-radius: 4px;
		}

		/* è¾“å…¥æ¡†æ ·å¼ */
		.sl-input {
			padding: 8px 12px;
			border: 1px solid #cbd5e1;
			border-radius: 6px;
			color: #1a1a1a;
			background: #ffffff;
			font-size: 13px;
			transition: all 0.2s ease;
		}

		.sl-input:focus {
			outline: none;
			border-color: #2563eb;
			box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
		}

		.sl-input::placeholder {
			color: #9ca3af;
		}

		/* è­¦å‘Šæ ·å¼æŒ‰é’® */
		.sl-btn-warning {
			background: #f59e0b;
			border-color: #d97706;
			color: #ffffff;
		}

		.sl-btn-warning:hover {
			background: #d97706;
			border-color: #b45309;
		}

		/* å­¦ç”Ÿåº“ç‰¹å®šæ ·å¼è°ƒæ•´ */
		#studentLibraryPanel .sl-btn {
			font-weight: 500;
			letter-spacing: 0.2px;
		}

		#studentLibraryPanel .sl-btn:focus {
			outline: none;
			box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5);
		}

		/* å­¦ç”Ÿåˆ—è¡¨è¡Œæ ·å¼ */
		.sl-row {
			transition: all 0.2s ease;
			position: relative;
			z-index: 1;
		}

		.sl-row:hover {
			background: #f8fafc !important;
			border-color: #cbd5e1 !important;
			transform: translateY(-1px);
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			z-index: 10;
		}

		/* æŒ‰é’®ç»„é—´è·ä¼˜åŒ– */
		.sl-row .sl-btn + .sl-btn {
			margin-left: 4px;
		}
		* {box-sizing:border-box;}
		body {margin:0; background:linear-gradient(180deg,#0d1014,#11161d); min-height:100vh; display:flex; flex-direction:column;}
		header {padding:18px 26px 10px; display:flex; flex-wrap:wrap; align-items:flex-start; gap:16px;}
		header h1 {margin:0;font-size:20px;font-weight:600;letter-spacing:.5px;background:linear-gradient(90deg,#91bdff,#c3daff);background-clip:text;-webkit-background-clip:text;color:transparent;}
		header .subtitle {margin:0 0 0 4px;font-size:14px;font-weight:400;color:var(--text-dim);letter-spacing:.3px;align-self:flex-end;padding-bottom:2px;}
		.toolbar {display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-left:auto;}
		.sync-status {display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-dim);padding:6px 10px;border-radius:var(--radius-sm);background:var(--surface-alt);}
		.sync-dot {width:8px;height:8px;border-radius:50%;background:var(--text-dim);transition:var(--transition);}
		.sync-dot.connected {background:var(--ok);box-shadow:0 0 0 2px rgba(34,197,94,.3);}
		.sync-dot.error {background:var(--danger);box-shadow:0 0 0 2px rgba(239,68,68,.3);}
		.sync-dot.connecting {background:var(--warn);animation:pulse 1.5s infinite;}
		@keyframes pulse {0%,100%{opacity:1}50%{opacity:.5}}
		button {cursor:pointer; border:1px solid var(--outline); background:var(--surface-alt); color:var(--text-dim); padding:8px 14px; font-size:13px; border-radius:var(--radius-sm); display:inline-flex; gap:6px; align-items:center; line-height:1; transition:var(--transition);}
		button:hover {border-color:var(--outline-hover); color:var(--text);} button.primary {background:var(--accent); border-color:var(--accent); color:#fff;} button.primary:hover{background:var(--accent-hover);} button.danger{background:var(--danger);border-color:var(--danger);color:#fff;} button.danger:hover{filter:brightness(1.08);} button.ghost{background:transparent;}
		input[type=text],input[type=search]{background:var(--surface);border:1px solid var(--outline);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);font-size:13px;min-width:200px;}
		input:focus{outline:none; box-shadow:var(--focus); border-color:var(--accent);} select {background:var(--surface); border:1px solid var(--outline); color:var(--text); padding:7px 10px; border-radius:var(--radius-sm); font-size:13px;} select:focus{outline:none; box-shadow:var(--focus); border-color:var(--accent);} 
		main {flex:1; display:flex; padding:0 26px 36px; gap:26px; align-items:flex-start;}
		.panel {background:var(--surface); border:1px solid var(--outline); border-radius:var(--radius-lg); padding:18px 18px 20px; width:100%; display:flex; flex-direction:column; gap:18px; box-shadow:var(--shadow); position:relative;}
		/* æ—§æµ®åŠ¨ç¼–è¾‘æŒ‰é’®æ ·å¼å·²ç§»é™¤ï¼›ç¼–è¾‘æŒ‰é’®ç°åœ¨ä¸æ¥¼å±‚è¿‡æ»¤åŒè¡Œæ˜¾ç¤º */
		.panel-header {display:flex; align-items:center; gap:14px;}
		.panel-header h2 {margin:0;font-size:16px;font-weight:600;letter-spacing:.5px;color:var(--text);} .panel-header .badge{background:var(--surface-alt);padding:4px 8px;font-size:11px;border-radius:var(--radius-sm);color:var(--text-dim);} 
		.divider{height:1px;background:var(--divider);margin:0;}
		.filters {display:flex;flex-wrap:wrap;gap:8px;}
		.filters button {padding:6px 12px;font-size:12px;border-radius:999px;background:var(--surface-alt);} .filters button[data-active='1']{background:var(--accent);color:#fff;border-color:var(--accent);} .filters button:hover{border-color:var(--outline-hover);} 
		.grid {display:grid; gap:var(--grid-gap); grid-template-columns:repeat(auto-fill,minmax(180px,1fr));}
		@media (min-width:1250px){ .grid{grid-template-columns:repeat(5,1fr);} }
		.room-card {position:relative; background:linear-gradient(150deg,#232b35,#1b2129); border:1px solid var(--outline); border-radius:var(--radius); padding:12px 12px 10px; display:flex; flex-direction:column; gap:6px; min-height:var(--card-min-h); cursor:pointer; transition:var(--transition); overflow:hidden;}
		.room-card:hover {border-color:var(--outline-hover); transform:translateY(-3px);} 
		.room-card[data-status='occupied']{
			background:linear-gradient(135deg,#2a4158 0%,#1d3245 40%,#16252f 100%); 
			border:1px solid #4a90e2; 
			box-shadow:
				0 0 0 1px rgba(74,144,226,0.4),
				0 2px 12px rgba(74,144,226,0.15),
				0 6px 25px rgba(74,144,226,0.08),
				inset 0 1px 0 rgba(255,255,255,0.05);
			position:relative;
		}
		.room-card[data-status='occupied']:hover{
			border-color:#5fa3ff;
			box-shadow:
				0 0 0 1px rgba(95,163,255,0.5),
				0 3px 16px rgba(74,144,226,0.25),
				0 8px 35px rgba(74,144,226,0.12),
				inset 0 1px 0 rgba(255,255,255,0.08);
			transform:translateY(-4px);
		}

		.room-card[data-status='preparing']{background:linear-gradient(160deg,#3d2a19,#2a1e0f); border:2px solid #f39c12; box-shadow:0 0 15px rgba(243,156,18,0.3); animation:preparing-pulse 2s infinite;} 
		.room-card[data-status='overtime']{
			background:linear-gradient(135deg,#4a2728 0%,#3d1f20 40%,#2a1415 100%); 
			border:1px solid #ff4757; 
			box-shadow:
				0 0 0 1px rgba(255,71,87,0.4),
				0 2px 12px rgba(255,71,87,0.15),
				0 6px 25px rgba(255,71,87,0.08),
				inset 0 1px 0 rgba(255,255,255,0.05);
		}
		.room-card[data-status='overtime']:hover{
			border-color:#ff6b7a;
			box-shadow:
				0 0 0 1px rgba(255,107,122,0.5),
				0 3px 16px rgba(255,71,87,0.25),
				0 8px 35px rgba(255,71,87,0.12),
				inset 0 1px 0 rgba(255,255,255,0.08);
			transform:translateY(-4px);
		}
		.room-card[data-status='empty']{background:linear-gradient(160deg,#1e242c,#181d23);} 
		.room-card[data-status='syncing']{background:linear-gradient(160deg,#1f2a3d,#1a2234); border-color:#4a90e2;} 
		.room-card.pending-operation{position:relative; pointer-events:none;} 
		.room-card.pending-operation::before{content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(74,144,226,0.1); border:2px solid #4a90e2; border-radius:var(--radius); z-index:10; animation:pulse-border 1.5s infinite;}
		/* è½»é‡åŠ è½½æç¤ºï¼šæäº¤ä¸­å¾½æ ‡ */
		.room-card .sync-hint{ position:absolute; top:8px; right:8px; display:none; align-items:center; gap:6px; padding:3px 7px; border-radius:14px; font-size:11px; line-height:1; background:rgba(74,144,226,0.16); border:1px solid rgba(74,144,226,0.35); color:#a9c9ff; z-index:11; backdrop-filter:blur(2px); box-shadow:0 2px 6px rgba(0,0,0,.25); }
		.room-card .sync-hint .dot{ width:8px; height:8px; border-radius:50%; background:#7fb1ff; box-shadow:0 0 0 1px rgba(255,255,255,0.25) inset; animation:sync-dot 1s ease-in-out infinite; }
		.room-card.pending-operation .sync-hint{ display:flex; }
		
		/* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
		.edit-mode-btn{padding:6px 12px;font-size:12px;background:var(--accent);color:#fff;border-color:var(--accent);}
		.edit-mode-btn.active{background:var(--ok);border-color:var(--ok);}
		.clear-all-btn{
			padding:6px 14px;
			font-size:12px;
			background:#dc3545;
			color:#fff;
			border:1px solid #dc3545;
			border-radius:4px;
			cursor:pointer;
			transition:all 0.25s ease;
			font-weight:600;
			letter-spacing:0.3px;
		}
		.clear-all-btn:hover{
			background:#c82333;
			border-color:#c82333;
			transform:translateY(-2px);
			box-shadow:0 4px 12px rgba(220,53,69,0.3);
		}
		.clear-all-btn:active{
			transform:translateY(0);
			box-shadow:0 2px 6px rgba(220,53,69,0.2);
		}
		.room-card.edit-mode{position:relative;pointer-events:auto;overflow:visible;}
		.room-card.edit-mode .delete-btn{
			position:absolute;top:-8px;right:-8px;width:20px;height:20px;
			border-radius:50%;background:#ff4757;border:2px solid #fff;
			color:#fff;font-size:14px;font-weight:bold;cursor:pointer;
			display:flex;align-items:center;justify-content:center;
			z-index:15;transition:var(--transition);
		}
		.room-card.edit-mode .delete-btn:hover{background:#ff3742;transform:scale(1.1);}
		.room-card.edit-mode .edit-row{
			display:flex;align-items:center;gap:8px;margin-bottom:6px;
		}
		.room-card.edit-mode .room-name.compact{
			flex:1;min-width:0;border:1px dashed var(--outline);
			padding:4px 6px;border-radius:4px;cursor:text;
		}
		.room-card.edit-mode .piano-type-selector{
			flex-shrink:0;min-width:80px;padding:4px 6px;
			background:var(--surface);border:1px solid var(--outline);
			border-radius:4px;font-size:12px;color:var(--text);
			cursor:pointer;outline:none;transition:var(--transition);
		}
		.room-card.edit-mode .piano-type-selector:hover,
		.room-card.edit-mode .piano-type-selector:focus{
			border-color:var(--accent);background:rgba(76,141,255,0.05);
		}
		.room-card.edit-mode .room-name{border:1px dashed var(--outline);padding:4px 6px;border-radius:4px;cursor:text;}
		.room-card.edit-mode .remark{border:1px dashed var(--outline);padding:4px 6px;border-radius:4px;cursor:text;min-height:24px;}
		.room-card.edit-mode .location-field{border:1px dashed var(--outline);padding:4px 6px;border-radius:4px;cursor:text;min-height:20px;}
		.room-card.edit-mode .room-name:hover,.room-card.edit-mode .remark:hover,.room-card.edit-mode .location-field:hover{border-color:var(--accent);background:rgba(76,141,255,0.05);}
		.room-card.edit-mode .room-name.compact:hover{border-color:var(--accent);background:rgba(76,141,255,0.05);}
		.add-room-btn{
			background: linear-gradient(135deg, var(--ok) 0%, #2ecc71 100%);
			color: #fff;
			border: 1px solid var(--ok);
			margin-left: 8px;
			font-size: 12px;
			padding: 6px 12px;
			border-radius: 6px;
			font-weight: 600;
			display: inline-flex;
			align-items: center;
			gap: 4px;
			box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
			transition: all 0.2s ease;
		}
		.add-room-btn:hover{
			background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
			border-color: #2ecc71;
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
		}
		.add-room-btn:active {
			transform: translateY(0);
			box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
		}
		
		/* === æ–°å¢ç´æˆ¿æ¨¡æ€æ¡†ä¸“ç”¨æ ·å¼ === */
		.add-room-modal .modal-header {
			background: linear-gradient(135deg, var(--surface-alt) 0%, #2c3e50 100%);
			border-bottom: 1px solid var(--outline);
		}
		.add-room-modal .modal-header h3 {
			color: var(--text);
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.add-room-modal .modal-header h3::before {
			content: "ğŸ¹";
			font-size: 18px;
		}
		.add-room-modal .form-grid {
			display: grid;
			gap: 18px;
		}
		.add-room-modal .form-field {
			display: flex;
			flex-direction: column;
			gap: 6px;
		}
		.add-room-modal .form-field label {
			font-size: 13px;
			font-weight: 600;
			color: var(--text);
			display: flex;
			align-items: center;
			gap: 6px;
		}
		.add-room-modal .form-field label .required {
			color: var(--danger);
			font-weight: bold;
		}
		.add-room-modal .form-field label .icon {
			font-size: 14px;
			opacity: 0.7;
		}
		.add-room-modal input,
		.add-room-modal select,
		.add-room-modal textarea {
			font-size: 14px;
			padding: 10px 12px;
			border: 1px solid var(--outline);
			border-radius: 8px;
			background: var(--surface);
			color: var(--text);
			transition: all 0.2s ease;
		}
		.add-room-modal input:focus,
		.add-room-modal select:focus,
		.add-room-modal textarea:focus {
			outline: none;
			border-color: var(--accent);
			box-shadow: 0 0 0 3px rgba(76, 141, 255, 0.1);
			background: var(--surface-alt);
		}
		.add-room-modal textarea {
			resize: vertical;
			min-height: 60px;
			font-family: inherit;
			line-height: 1.4;
		}
		.add-room-modal .piano-type-display {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 8px;
			margin-top: 4px;
		}
		.add-room-modal .piano-type-option {
			padding: 8px 12px;
			border: 1px solid var(--outline);
			border-radius: 6px;
			background: var(--surface-alt);
			color: var(--text-dim);
			text-align: center;
			font-size: 12px;
			cursor: pointer;
			transition: all 0.2s ease;
		}
		.add-room-modal .piano-type-option:hover {
			border-color: var(--accent);
			background: var(--accent-fade, rgba(76, 141, 255, 0.1));
		}
		.add-room-modal .piano-type-option.selected {
			background: var(--accent);
			color: #fff;
			border-color: var(--accent);
			font-weight: 600;
		}
		.add-room-modal .modal-footer {
			background: var(--surface-alt);
			border-top: 1px solid var(--outline);
			padding: 16px 20px;
		}
		.add-room-modal .modal-footer button {
			padding: 10px 20px;
			font-size: 14px;
			font-weight: 600;
			border-radius: 8px;
			transition: all 0.2s ease;
		}
		.add-room-modal .form-field.error input,
		.add-room-modal .form-field.error select,
		.add-room-modal .form-field.error textarea {
			border-color: var(--danger);
			background: rgba(255, 77, 77, 0.05);
		}
		.add-room-modal .form-field.error label {
			color: var(--danger);
		}
		.add-room-modal .error-message {
			color: var(--danger);
			font-size: 12px;
			margin-top: 4px;
			display: flex;
			align-items: center;
			gap: 4px;
		}
		.add-room-modal .error-message::before {
			content: "âš ï¸";
			font-size: 10px;
		}
		.floor-filter-edit{position:relative;}
		.floor-filter-edit .add-floor-btn{
			position:absolute;right:-30px;top:50%;transform:translateY(-50%);
			width:24px;height:24px;border-radius:50%;background:var(--ok);
			color:#fff;font-size:16px;cursor:pointer;border:none;
			display:flex;align-items:center;justify-content:center;
		}
		.editable-input{
			background:var(--surface);border:1px solid var(--accent);
			border-radius:4px;padding:4px 6px;font-size:inherit;
			color:var(--text);width:100%;outline:none;
		}
		
		@keyframes pulse-border { 0%, 100% { border-color: #4a90e2; opacity: 0.8; } 50% { border-color: #7fb1ff; opacity: 1; } }
		@keyframes sync-dot { 0% { opacity:.35; transform:scale(.8); } 50% { opacity:1; transform:scale(1);} 100% { opacity:.35; transform:scale(.8);} }
		@keyframes preparing-pulse { 0%, 100% { border-color: #f39c12; box-shadow: 0 0 15px rgba(243,156,18,0.3); } 50% { border-color: #e67e22; box-shadow: 0 0 25px rgba(243,156,18,0.5), 0 0 35px rgba(243,156,18,0.2); } } 
		.room-name {font-size:15px;font-weight:600;letter-spacing:.5px; display:flex;align-items:center; gap:6px; color:var(--text);} .pill {font-size:10px;padding:2px 6px;border-radius:6px;background:var(--surface-alt);color:var(--text-dim); font-weight:500; letter-spacing:.3px;transition:var(--transition);}
		.pill-grand {background:linear-gradient(135deg,#3b82f6,#1e40af);color:#fff;box-shadow:0 1px 3px rgba(59,130,246,0.3);}
		.pill-upright {background:linear-gradient(135deg,#10b981,#059669);color:#fff;box-shadow:0 1px 3px rgba(16,185,129,0.3);}
		.pill-other {background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;box-shadow:0 1px 3px rgba(139,92,246,0.3);}
		.room-card:hover .pill-grand {box-shadow:0 2px 6px rgba(59,130,246,0.5);}
		.room-card:hover .pill-upright {box-shadow:0 2px 6px rgba(16,185,129,0.5);}
		.room-card:hover .pill-other {box-shadow:0 2px 6px rgba(139,92,246,0.5);}
		.remark {font-size:11px;color:var(--text-dim); line-height:1.3; max-height:30px; overflow:hidden;text-overflow:ellipsis;}
		.occupant-line {display:flex;align-items:center; gap:6px; font-size:13px; font-weight:500; color:#fff; margin-top:2px; white-space:nowrap;overflow:hidden;}
		.dot {width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 3px rgba(76,141,255,.25);} 
		.status-row {margin-top:auto; display:flex; align-items:center; justify-content:space-between; gap:8px;}
		.chip {font-size:11px; padding:3px 8px; border-radius:8px; background:var(--surface-alt); color:var(--text-dim); font-weight:500; letter-spacing:.3px; line-height:1;}
		.chip.accent{color:var(--accent);} .chip.warn{color:var(--warn);} .chip.good{color:var(--ok);} .chip.danger{color:var(--danger);} 
		.chip.preparing{background:linear-gradient(135deg,#f39c12,#e67e22); color:#fff; font-weight:600; text-shadow:0 1px 2px rgba(0,0,0,0.3); box-shadow:0 2px 8px rgba(243,156,18,0.4); animation:chip-glow 2s infinite; position:relative;}
		.chip.preparing::before{content:'âš¡'; margin-right:3px; animation:preparing-icon 1.5s infinite;}
		@keyframes chip-glow { 0%, 100% { box-shadow: 0 2px 8px rgba(243,156,18,0.4); } 50% { box-shadow: 0 2px 15px rgba(243,156,18,0.7), 0 0 20px rgba(243,156,18,0.3); } }
		@keyframes preparing-icon { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } } 
		.actions {display:flex;gap:4px;} .actions button {padding:4px 7px; font-size:11px; background:var(--surface-alt);} .actions button.primary{background:var(--accent);color:#fff;border-color:var(--accent);} .actions button.primary:hover{background:var(--accent-hover);} .actions button.danger{background:var(--danger);border-color:var(--danger);} 
		/* === å¯è¯»æ€§å¢å¼ºè¦†ç›–æ ·å¼ === */
		.room-card{color:#dbe5ef;}
		.room-card .room-name{font-weight:600; letter-spacing:.5px; color:#ffffff; text-shadow:0 1px 2px rgba(0,0,0,.4);} 
		.room-card .occupant-line span:last-child{font-weight:600; color:#fff;}
		
		/* === ç©ºé—²çŠ¶æ€é‡æ–°è®¾è®¡ - æ ¹æ®é’¢ç´ç±»å‹æ˜¾ç¤ºä¸åŒé¢œè‰² === */
		/* é»˜è®¤ç©ºé—²çŠ¶æ€ï¼ˆå…¶ä»–ç±»å‹ï¼‰ - ç´«è‰²ï¼Œä¸åˆ†å‰²çº¿ä¿æŒä¸€è‡´ */
		.room-card.empty{
			background:linear-gradient(135deg, #241530 0%, #322038 35%, #1c1625 100%);
			border:1px solid #604d85; 
			box-shadow:
				0 0 0 1px rgba(120,50,160,0.25),
				0 2px 12px -2px rgba(0,0,0,0.65),
				0 6px 22px -8px rgba(0,0,0,0.7),
				inset 0 0 0 1px rgba(255,255,255,0.03),
				inset 0 4px 18px -6px rgba(130,70,180,0.08);
			filter:saturate(.88) brightness(.85);
		}
		.room-card.empty:hover{
			border-color:#7a65a8;
			background:linear-gradient(135deg, #322038 0%, #3d2a45 35%, #241a30 100%);
			box-shadow:
				0 0 0 1px rgba(140,60,180,0.35),
				0 6px 18px -6px rgba(0,0,0,0.7),
				0 10px 38px -12px rgba(0,0,0,0.65),
				inset 0 1px 0 rgba(255,255,255,0.06),
				inset 0 4px 22px -8px rgba(130,70,180,0.12);
			transform:translateY(-3px);
		}
		
		/* ä¸‰è§’é’¢ç´ç©ºé—²çŠ¶æ€ - è“è‰² */
		.room-card.empty[data-grand="1"]{
			background:linear-gradient(135deg, #152030 0%, #202f38 35%, #141c25 100%);
			border:1px solid #4d6085;
			box-shadow:
				0 0 0 1px rgba(76,135,215,0.25),
				0 2px 12px -2px rgba(0,0,0,0.65),
				0 6px 22px -8px rgba(0,0,0,0.7),
				inset 0 0 0 1px rgba(255,255,255,0.03),
				inset 0 4px 18px -6px rgba(76,135,215,0.08);
		}
		.room-card.empty[data-grand="1"]:hover{
			border-color:#6078c8;
			background:linear-gradient(135deg, #202f38 0%, #2a3845 35%, #181f30 100%);
			box-shadow:
				0 0 0 1px rgba(76,135,215,0.35),
				0 6px 18px -6px rgba(0,0,0,0.7),
				0 10px 38px -12px rgba(0,0,0,0.65),
				inset 0 1px 0 rgba(255,255,255,0.06),
				inset 0 4px 22px -8px rgba(76,135,215,0.12);
		}
		
		/* ç«‹å¼é’¢ç´ç©ºé—²çŠ¶æ€ - ç»¿è‰² */
		.room-card.empty[data-grand="0"]{
			background:linear-gradient(135deg, #153025 0%, #203830 35%, #141c1a 100%);
			border:1px solid #2aa876;
			box-shadow:
				0 0 0 1px rgba(42,168,118,0.25),
				0 2px 12px -2px rgba(0,0,0,0.65),
				0 6px 22px -8px rgba(0,0,0,0.7),
				inset 0 0 0 1px rgba(255,255,255,0.03),
				inset 0 4px 18px -6px rgba(42,168,118,0.08);
		}
		.room-card.empty[data-grand="0"]:hover{
			border-color:#3ec490;
			background:linear-gradient(135deg, #203830 0%, #2a4538 35%, #181f25 100%);
			box-shadow:
				0 0 0 1px rgba(42,168,118,0.35),
				0 6px 18px -6px rgba(0,0,0,0.7),
				0 10px 38px -12px rgba(0,0,0,0.65),
				inset 0 1px 0 rgba(255,255,255,0.06),
				inset 0 4px 22px -8px rgba(42,168,118,0.12);
		} 
		/* ç©ºé—²ç†„ç­ chip æ ·å¼ */
		.chip-dim[data-empty="1"]{
			background:linear-gradient(135deg,rgba(70,90,80,0.25),rgba(40,55,48,0.18));
			color:#d9e7dd; 
			font-weight:500;
			letter-spacing:.4px;
			border:1px solid rgba(120,170,150,0.25);
			box-shadow:0 1px 2px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.02);
			text-shadow:0 1px 2px rgba(0,0,0,0.45);
			filter:brightness(.95) saturate(.9);
		}
		.room-card.empty .status-row .chip-dim[data-empty="1"]:hover{background:linear-gradient(135deg,rgba(90,115,100,0.3),rgba(50,70,60,0.25));}
		/* ç©ºé—²çŠ¶æ€æ–‡å­—å¢å¼º */
		.room-card.empty .room-name{
			color:#f2f7f5; 
			text-shadow:0 1px 3px rgba(0,0,0,0.55);
			font-weight:650;
			letter-spacing:.6px;
		}
		.room-card.empty .remark{
			color:#b7c9c0; 
			opacity:.85;
		} 
		.room-card.empty .occupant-line{display:none;}
		/* ä¸å ç”¨äº®èµ·å¯¹åº”ï¼šå ç”¨æˆ¿ä¿æŒé²œè‰³ï¼›ç©ºé—²æå‡äº®åº¦ */
		.room-card[data-status='occupied']{filter:saturate(1.05) brightness(1.03);} 
		.room-card[data-status='empty']{filter:saturate(1.1) brightness(1.1);} 
		.room-card[data-status='empty']:hover{filter:saturate(1.15) brightness(1.15);} 
		.room-card .status-row .chip{filter:brightness(1.05);} 
		.room-card[data-status='overtime'] .chip.danger{background:rgba(255,77,77,0.18); box-shadow:0 0 0 1px rgba(255,77,77,0.35);} 
		.room-card[data-status='preparing'] .chip.preparing{background:rgba(243,156,18,0.15); color:#ffb347;} 
		.room-card .actions button{filter:brightness(1.1);} 
		.room-card:hover .actions button.primary{box-shadow:0 0 0 1px rgba(0,140,255,0.4);} 
		/* æ›´äº®çš„æ–‡æœ¬ä¸è¾…åŠ©è¯´æ˜ */
		body{--text:#d9e2ec; --text-dim:#90a4b8;}
		/* ç§»é™¤ç©ºé—²å¡ç‰‡çš„é€æ˜åº¦è®¾ç½®ï¼Œè®©å…¶ä¿æŒæ­£å¸¸å¯è§åº¦ */
		.meta-bar {display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
		.meta-stat {font-size:12px; color:var(--text-dim); display:flex; gap:4px; align-items:center;}
		.searchbox {position:relative;}
		.searchbox input {min-width:260px; padding-left:34px;}
		.searchbox svg {position:absolute; top:50%; left:10px; width:16px; height:16px; transform:translateY(-50%); stroke:var(--text-dim);} 
		.inline-search-results{position:absolute; top:100%; left:0; margin-top:6px; width:480px; max-width:70vw; background:var(--surface); border:1px solid var(--outline); border-radius:14px; box-shadow:0 8px 28px -10px rgba(0,0,0,.4); padding:10px 0; display:flex; flex-direction:column; max-height:420px; overflow:auto; z-index:60; backdrop-filter:blur(6px);} 
		.inline-search-results .group-title{font-size:11px; font-weight:600; color:var(--text-dim); padding:4px 14px 6px; letter-spacing:.5px;}
		.inline-search-results .result-item{padding:8px 14px; display:flex; justify-content:space-between; gap:12px; line-height:1.2; cursor:pointer; font-size:13px; border-left:3px solid transparent; transition:var(--transition);} 
		.inline-search-results .result-item:hover{background:var(--surface-alt); border-left-color:var(--accent);}
		.inline-search-results .result-item .meta{font-size:11px; color:var(--text-dim);} 
		.inline-search-results .result-item .occ-info{margin-left:6px; font-size:11px; padding:2px 6px; border-radius:10px; background:var(--surface-alt); display:inline-flex; align-items:center; gap:4px; font-weight:500;}
		.inline-search-results .result-item .occ-info .icon{font-size:12px;}
		.inline-search-results .result-item .occ-info.preparing{background:#ffe9c8;color:#a45b00;}
		.inline-search-results .result-item .occ-info.occupied{background:#d8eefc;color:#0a5b85;}
		.inline-search-results .result-item .occ-info.overtime{background:#ffe0e0;color:#b40000;}
		.inline-search-results .result-item .occ-info .dur{opacity:.8;}
		.inline-search-results .empty{padding:20px 16px; text-align:center; font-size:12px; color:var(--text-dim);} 
		.inline-search-results .result-item.room{--icon:"ğŸ¹";} 
		.inline-search-results .highlight{color:var(--accent); font-weight:600;}
		/* ==== ç±»å‹åˆ†éš”çº¿ ==== */
		.room-type-separator{grid-column:1/-1;display:flex;align-items:center;gap:14px;margin:14px 2px 6px;position:relative;}
		.room-type-separator .line{flex:1;height:1px;background:linear-gradient(90deg,transparent,var(--outline),transparent);}
		.room-type-separator .label{font-size:11px;letter-spacing:1px;font-weight:600;color:var(--text-dim);text-transform:uppercase;padding:4px 10px;border:1px solid var(--outline);border-radius:30px;background:var(--surface-alt);backdrop-filter:blur(4px);}
		.room-type-separator.grand .label{color:#60a5ff;border-color:#3d5e82;background:linear-gradient(120deg,rgba(30,50,70,.35),rgba(20,30,40,.4));}
		.room-type-separator.upright .label{color:#34d399;border-color:#245f45;background:linear-gradient(120deg,rgba(24,60,48,.35),rgba(18,32,26,.4));}
		.room-type-separator.other .label{color:#c084fc;border-color:#553a7a;background:linear-gradient(120deg,rgba(55,35,80,.35),rgba(35,25,50,.4));}
		/* ===== æ ‡é¢˜ä½“ç³» ===== */
		.app-title{display:flex;flex-direction:column;gap:6px;margin-bottom:8px;}
		.title-line{display:flex;align-items:baseline;flex-wrap:wrap;gap:10px;}
		.title-line.main{font-size:22px;font-weight:600;letter-spacing:.5px;}
		.title-line.main .brand{background:linear-gradient(120deg,#cfd9e5,#ffffff);background-clip:text;-webkit-background-clip:text;color:transparent;font-weight:700;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));}
		.title-line.main .divider{color:var(--text-dim);font-weight:400;opacity:.6;}
		.title-line.main .module{color:var(--accent);font-weight:600;position:relative;}
		.title-line.main .module:after{content:"";position:absolute;left:0;bottom:-4px;width:100%;height:2px;background:linear-gradient(90deg,var(--accent),transparent);opacity:.5;border-radius:2px;}
		.title-line.sub{font-size:11px;font-weight:500;letter-spacing:.8px;color:var(--text-dim);text-transform:uppercase;gap:6px;}
		.tag{padding:2px 8px;border-radius:20px;display:inline-flex;align-items:center;gap:4px;font-size:10px;line-height:1.2;letter-spacing:.5px;font-weight:600;position:relative;}
		.tag.beta{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;box-shadow:0 2px 8px -2px rgba(99,102,241,.5);}
		.tag.env{background:linear-gradient(135deg,#0ea5e9,#3b82f6);color:#fff;}
		@media (max-width:720px){
			.title-line.main{font-size:18px;}
			.title-line.sub{font-size:10px;}
		}
		header h1, header h2.subtitle{display:none !important;}
		.side {width:340px; display:flex; flex-direction:column; gap:24px;}
		.section-title {font-size:13px;font-weight:600;color:var(--text-dim);letter-spacing:.5px;margin:0 0 8px;}
		.import-box {background:var(--surface);border:1px dashed var(--outline); border-radius:var(--radius); padding:14px; display:flex; flex-direction:column; gap:10px;}
		.import-box input {width:100%;}
		.list-small {max-height:220px; overflow:auto; font-size:12px; line-height:1.4; background:var(--surface-alt); padding:8px 10px; border:1px solid var(--outline); border-radius:var(--radius-sm);} .list-small code{font-size:11px;}
		.toast {position:fixed; bottom:24px; right:24px; background:#222c36; color:#fff; padding:10px 16px; border-radius:10px; font-size:13px; box-shadow:0 6px 18px -8px #000; display:flex; gap:10px; align-items:center; animation:fadeIn .3s;} @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
		.modal-backdrop {position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:100; opacity:1; transition:opacity .15s ease-out;}
		.modal {background:var(--surface); border:1px solid var(--outline); width:480px; max-width:92%; border-radius:18px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 12px 40px -16px rgba(0,0,0,.7);} .modal-header{padding:16px 20px; display:flex; align-items:center; justify-content:space-between; background:var(--surface-alt);} .modal-header h3{margin:0;font-size:15px;font-weight:600;} .modal-body{padding:16px 20px; display:flex; flex-direction:column; gap:14px; max-height:60vh; overflow:auto;} .modal-footer{padding:14px 20px; display:flex; gap:10px; justify-content:flex-end; background:var(--surface-alt);} 
		/* æ”¾å¤§å­¦ç”Ÿé€‰æ‹©å¼¹çª—ï¼šåœ¨ç‰¹å®š backdrop ä¸‹ä½œç”¨ï¼Œé¿å…å½±å“æ–°å¢æˆ¿é—´å¼¹çª— */
		#studentModalBackdrop .modal { width:760px; max-width:94%; border-radius:22px; }
		#studentModalBackdrop .modal-header{ padding:22px 28px 18px; }
		#studentModalBackdrop .modal-header h3{ font-size:19px; letter-spacing:.6px; font-weight:650; }
		#studentModalBackdrop .modal-body{ padding:10px 28px 24px; gap:18px; max-height:68vh; }
		#studentModalBackdrop .modal-footer{ padding:18px 28px 22px; }
		#studentModalBackdrop input#studentSearch{ font-size:16px; padding:14px 16px; border-radius:14px; }
		#studentModalBackdrop .student-list{ --item-gap:10px; display:flex; flex-direction:column; gap:var(--item-gap); font-size:15px; line-height:1.5; }
		#studentModalBackdrop .student-list .stu-item{ padding:10px 14px 11px; font-size:15px; border-radius:12px; }
		#studentModalBackdrop .student-list .stu-item strong{ font-size:15px; font-weight:600; }
		#studentModalBackdrop .student-list .stu-item small{ font-size:12px; opacity:.85; }
		#studentModalBackdrop button{ font-size:14px; }
		#studentModalBackdrop .ghost{ font-size:14px; }
		/* ==== å­¦ç”Ÿå ç”¨æ˜¾ç¤ºå¢å¼º ==== */
		#studentModalBackdrop .student-list .student-item{display:flex; align-items:center; flex-wrap:wrap; gap:14px; background:linear-gradient(145deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.05);} 
		#studentModalBackdrop .student-list .student-item{justify-content:space-between;}
		#studentModalBackdrop .student-list .student-item .stu-name{flex:0 0 auto; min-width:100px; font-weight:600; letter-spacing:.4px;}
		#studentModalBackdrop .student-list .student-item .col-left{display:flex; align-items:center; gap:12px; flex:1 1 auto; min-width:320px;}
		#studentModalBackdrop .student-list .student-item .col-right{display:flex; align-items:center; gap:14px; justify-content:flex-end; flex:0 0 auto; min-width:240px;}
		#studentModalBackdrop .student-list .student-item .col-right .state-tag{margin-left:2px;}
		/* ç¦ç”¨æ—§ info-col å¸ƒå±€ï¼ˆè‹¥æ®‹ç•™ï¼‰ */
		#studentModalBackdrop .student-list .student-item .info-col{display:none !important;}
		/* ç´§å‡‘æ¨¡å¼ï¼šåœ¨è¾ƒçª„å±å¹•è‡ªåŠ¨å›é€€ä¸ºæ¨ªå‘å•è¡Œ */
		@media (max-width:900px){
			#studentModalBackdrop .student-list .student-item{flex-direction:column; align-items:flex-start; gap:10px;}
			#studentModalBackdrop .student-list .student-item .col-left{flex-wrap:wrap; min-width:auto;}
			#studentModalBackdrop .student-list .student-item .col-right{width:100%; justify-content:flex-start; flex-wrap:wrap;}
		}
		#studentModalBackdrop .student-list .student-item:hover{background:linear-gradient(145deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03)); border-color:rgba(255,255,255,0.15);} 
		#studentModalBackdrop .student-list .student-item.kb-selected{border-color:var(--accent); box-shadow:0 0 0 1px var(--accent), 0 4px 14px -4px rgba(0,123,255,0.35);} 
		/* å·²ç§»é™¤çºµå‘ç»“æ„ï¼Œä¿æŒå…¼å®¹ */
		#studentModalBackdrop .student-list .student-item .stu-line-main{display:contents;}
		#studentModalBackdrop .student-list .student-item .stu-name{font-weight:600; letter-spacing:.4px;}
		#studentModalBackdrop .student-list .student-item .stu-line-sub{display:contents;}
		#studentModalBackdrop .student-list .student-item .tag.major{background:rgba(59,130,246,0.12); color:#7fb3ff;}
		#studentModalBackdrop .student-list .student-item .tag.grade{background:rgba(120,160,255,0.12); color:#b0c8ff;}
		#studentModalBackdrop .student-list .student-item .room-tag{padding:2px 8px; font-size:11px; border-radius:20px; background:linear-gradient(135deg,#2d3e52,#1e2a38); color:#aad4ff; letter-spacing:.4px; position:relative; top:-1px; box-shadow:0 1px 3px rgba(0,0,0,.4), inset 0 0 0 1px rgba(255,255,255,0.05);} 
		#studentModalBackdrop .student-list .student-item .room-tag::before{content:'æˆ¿'; font-size:10px; margin-right:4px; opacity:.8;}
		#studentModalBackdrop .student-list .student-item .state-tag{padding:2px 8px; font-size:11px; border-radius:16px; background:rgba(255,255,255,0.07); color:#d2dee8; letter-spacing:.4px; font-weight:500; box-shadow:0 1px 2px rgba(0,0,0,.4);}
		#studentModalBackdrop .student-list .student-item .state-tag.st-preparing{background:linear-gradient(135deg,#f39c12,#e67e22); color:#fff; font-weight:600;}
		#studentModalBackdrop .student-list .student-item .state-tag.st-occupied{background:linear-gradient(135deg,#0052d4,#4364f7); color:#fff; font-weight:600;}
		#studentModalBackdrop .student-list .student-item .state-tag.st-overtime{background:linear-gradient(135deg,#ff4d4d,#c62828); color:#fff; font-weight:600;}
		#studentModalBackdrop .student-list .student-item .state-tag.st-empty{background:rgba(255,255,255,0.12); color:#bcd;}
		/* é”®ç›˜é«˜äº®/hover æå‡å±‚æ¬¡ */
		#studentModalBackdrop .student-list .stu-item.hover, 
		#studentModalBackdrop .student-list .stu-item:focus-visible{ outline:2px solid var(--accent); outline-offset:1px; }
		/* å“åº”å¼ä¿æŠ¤ */
		@media (max-width:900px){
			#studentModalBackdrop .modal{ width:94%; }
			#studentModalBackdrop .modal-body{ max-height:70vh; }
		}
		.student-list {display:flex; flex-direction:column; gap:6px;} .student-item{background:var(--surface-alt); padding:6px 10px; border:1px solid var(--outline); border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-size:13px; transition:var(--transition);} .student-item:hover{border-color:var(--accent); color:var(--text);} .student-item .tag{font-size:11px; color:var(--text-dim);} .student-item.disabled{opacity:.45;pointer-events:none;} .student-item.kb-selected{border-color:var(--accent); background:var(--accent-fade,#2d6cdf22);} .student-item.kb-selected span:first-child{font-weight:600;}
		/* å¤šé€‰æ¨¡å¼æ ·å¼ */
		.student-item.multi-selected{border-color:var(--ok); background:rgba(63, 191, 107, 0.15); box-shadow: 0 0 0 1px var(--ok);}
		.student-item.multi-selected .stu-name{font-weight:600; color:var(--ok);}
		.selected-student-chip{display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:var(--surface); border:1px solid var(--outline); border-radius:6px; font-size:12px; color:var(--text);}
		.selected-student-chip .remove-btn{cursor:pointer; color:var(--danger); font-weight:bold; margin-left:2px; transition:var(--transition);}
		.selected-student-chip .remove-btn:hover{color:#ff3333;}
		.muted{color:var(--text-dim);} .danger{color:var(--danger);} .warn{color:var(--warn);} .accent{color:var(--accent);} 
		footer {padding:18px 26px 34px; font-size:11px; text-align:center; color:var(--text-dim);} a{color:var(--accent); text-decoration:none;} a:hover{text-decoration:underline;}
	</style>
</head>
<body>
	<header>
		<div class="app-title">
			<div class="title-line main" aria-label="é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ ç´æˆ¿ç®¡ç†ç³»ç»Ÿ">
				<span class="brand">é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡</span>
				<span class="divider">Â·</span>
				<span class="module">ç´æˆ¿ç®¡ç†ç³»ç»Ÿ</span>
			</div>
			<div class="title-line sub">
				<span class="tag beta">v2</span>
				<span class="tag env">å®æ—¶åŒæ­¥å¯ç”¨</span>
			</div>
		</div>
		<div class="searchbox">
			<svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>
			<input id="globalSearch" type="search" placeholder="æœç´¢å­¦ç”Ÿ / ç´æˆ¿ (æ”¯æŒæ‹¼éŸ³é¦–å­—æ¯)" />
			<div id="inlineSearchResults" class="inline-search-results" style="display:none;"></div>
		</div>
		<div class="toolbar">
			<div class="sync-status" id="syncStatus">
				<div class="sync-dot" id="syncDot"></div>
				<span id="syncText">ç¦»çº¿</span>
			</div>
			<!-- å·²ç§»é™¤å¯¼å…¥å­¦ç”Ÿ (æ”¹ç”±å­¦ç”Ÿåº“ CSV) -->
			<button id="btnSyncToCloud" class="ghost">åŒæ­¥åˆ°äº‘ç«¯</button>
			<button id="btnReconnect" class="ghost" style="display: none;">é‡æ–°è¿æ¥</button>
			<button id="btnToggleSlotCheck" class="ghost" title="åˆ‡æ¢ç™»è®°æ—¶æ®µæ£€æµ‹">æ—¶æ®µæ£€æµ‹: å¼€</button>
			<button id="btnPracticeLogSearch" class="ghost" title="æŸ¥è¯¢å­¦ç”Ÿç»ƒç´è®°å½•">æŸ¥ç»ƒç´è®°å½•</button>
			<!-- å·²ç§»é™¤åˆ·æ–°æŒ‰é’® -->
			<!-- å·²ç§»é™¤è€ƒå‹¤æ—¶é—´æ®µå…¥å£ (æ”¹ç”±å­¦ç”Ÿåº“å†…å¯¼å…¥å¯¼å‡º + éœ€è¦æ—¶å¯é‡æ–°æ·»åŠ ) -->
		</div>
	</header>
	<main>
		<div class="panel" id="panelRooms">
			<div class="panel-header">
				<h2>ç´æˆ¿åˆ—è¡¨</h2>
				<div class="badge" id="statUsage">åŠ è½½ä¸­...</div>
			</div>
			<div class="meta-bar">
				<div class="filters" id="floorFilters"></div>
				<div class="filters" id="typeFilters"></div>
				<div style="margin-left:auto;display:flex;align-items:center;gap:10px;">
					<button id="btnEditRooms" class="edit-mode-btn" title="ç¼–è¾‘ç´æˆ¿" style="padding:6px 14px;">ç¼–è¾‘</button>
				</div>
				<div class="meta-stat" id="metaCounts"></div>
			</div>
			<hr class="divider"/>
			<div class="grid" id="roomGrid"></div>
		</div>
		<div class="side">

			<div>
				<p class="section-title">è¿è¡ŒçŠ¶æ€</p>
				<div class="list-small" id="runtimeInfo"></div>
			</div>
			<div style="margin-top:22px;">
				<p class="section-title" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:nowrap;">
					<span style="white-space:nowrap;">é‡è¦æé†’</span>
					<span style="display:flex;gap:8px;flex-wrap:nowrap;align-items:center;white-space:nowrap;">
						<span class="alert-filters" style="display:flex;gap:4px;flex-wrap:nowrap;">
							<button class="alert-filter-btn act" data-filter="all">å…¨éƒ¨</button>
							<button class="alert-filter-btn" data-filter="absent">ç¼ºå‹¤</button>
							<button class="alert-filter-btn" data-filter="anomaly">å¼‚å¸¸</button>
						</span>
						<button id="ignoreAllBtn" class="alert-ignore-all-btn" title="å¿½ç•¥å½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„æ‰€æœ‰æé†’">ä¸€é”®å¿½ç•¥</button>
					</span>
				</p>
				<div id="alertList" class="list-small alert-empty" style="max-height:680px;overflow:auto;display:flex;flex-direction:column;gap:10px;"></div>
			</div>
		</div>
	</main>
	<footer>Â© 2025 é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ ç´æˆ¿ç®¡ç†ç³»ç»Ÿ Â· Demo ç‰ˆæœ¬ Â· <a href="https://supabase.com" target="_blank" rel="noopener">Supabase</a></footer>

	<!-- å­¦ç”Ÿåº“ç®¡ç†é¢æ¿ï¼ˆæŠ½å±‰ï¼‰ -->
	<div id="studentLibraryPanel" style="position:fixed;top:0;right:0;bottom:0;width:420px;max-width:100%;background:#ffffff;box-shadow:-4px 0 18px -4px rgba(0,0,0,.15);border-left:1px solid #e2e8f0;z-index:3100;display:none;flex-direction:column;font-size:13px;color:#1a1a1a;">
		<div style="padding:14px 16px;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:10px;position:relative;z-index:20;background:#ffffff;">
			<h3 style="margin:0;font-size:16px;font-weight:600;flex:1;display:flex;align-items:center;gap:6px;color:#1a1a1a;">å­¦ç”Ÿåº“ <span id="slTotal" style="font-size:11px;font-weight:500;color:#64748b;">--</span></h3>
			<button id="slCloseBtn" class="sl-btn sl-btn-secondary sl-btn-sm">å…³é—­</button>
		</div>
		<div style="padding:10px 14px;display:flex;flex-direction:column;gap:10px;flex:1;min-height:0;">
			<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
				<input id="slSearch" placeholder="æœç´¢å§“å / æ‹¼éŸ³" class="sl-input" style="flex:1;min-width:160px;" />
				<button id="slAddBtn" class="sl-btn sl-btn-primary">æ–°å¢å­¦ç”Ÿ</button>
				<button id="slOpenBTMBtn" class="sl-btn sl-btn-accent">æ‰¹é‡æ—¶é—´æ®µ</button>
			</div>
			<div id="slAddForm" style="display:none;gap:8px;flex-wrap:wrap;background:#f8fafc;border:1px solid #e2e8f0;padding:12px;border-radius:8px;">
				<input id="slName" placeholder="å§“å*" class="sl-input" style="flex:1;min-width:120px;" />
				<input id="slGrade" placeholder="å¹´çº§" class="sl-input" style="flex:1;min-width:100px;" />
				<input id="slMajor" placeholder="ä¸“ä¸š" class="sl-input" style="flex:1;min-width:100px;" />
				<div style="display:flex;gap:8px;width:100%;justify-content:flex-end;margin-top:6px;">
					<button id="slCancelAdd" class="sl-btn sl-btn-secondary">å–æ¶ˆ</button>
					<button id="slSubmitAdd" class="sl-btn sl-btn-success">ä¿å­˜</button>
				</div>
			</div>
			<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
				<div style="margin-left:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
					<button id="slExportCsvSlotsBtn" class="sl-btn sl-btn-outline sl-btn-sm">å¯¼å‡ºå­¦ç”Ÿåº“</button>
					<button id="slImportCsvSlotsBtn" class="sl-btn sl-btn-outline sl-btn-sm">å¯¼å…¥å­¦ç”Ÿåº“</button>
					<input type="file" id="slImportCsvSlotsFile" accept=".csv,text/csv" style="display:none;" />
				</div>
			</div>
			<div id="slList" style="flex:1;min-height:0;overflow:auto;display:flex;flex-direction:column;gap:6px;"></div>
		</div>
	</div>

	<!-- æ‰¹é‡æ—¶é—´æ®µç®¡ç† Modal -->
	<!-- æå‡ z-index åˆ°é«˜äºå­¦ç”Ÿåº“é¢æ¿(å­¦ç”Ÿåº“=3100)ï¼Œé˜²æ­¢è¢«é®æŒ¡ -->
	<div id="bulkTimeManagerModal" style="display:none;position:fixed;inset:0;z-index:3600;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);">
		<div class="btm-wrapper">
			<div class="btm-header">
				<div class="btm-title">æ‰¹é‡æ—¶é—´æ®µç®¡ç†</div>
				<div class="btm-actions">
					<button class="btm-btn btm-secondary" id="btmPrevBtn">ä¸Šä¸€ä½</button>
					<button class="btm-btn btm-secondary" id="btmNextBtn">ä¸‹ä¸€ä½</button>
					<button class="btm-btn btm-danger" id="btmClearAllBtn">æ¸…ç©ºå…¨éƒ¨</button>
					<div class="btm-save-options">
						<label class="btm-checkbox-label">
							<input type="checkbox" id="btmTodayOnlyCheck" class="btm-checkbox">
							<span class="btm-checkbox-text">ä»…é™æœ¬å‘¨ï¼ˆä¸‹å‘¨æ¢å¤ï¼‰</span>
						</label>
						<button class="btm-btn btm-primary" id="btmSaveBtn">ä¿å­˜</button>
					</div>

					<button class="btm-btn btm-secondary" id="btmCloseBtn">å…³é—­</button>
				</div>
			</div>
			<div class="btm-body">
				<div class="btm-left">
					<div class="btm-student-bar" style="display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
						<select id="btmStudentSelect" class="btm-select" style="min-width:220px;"></select>
						<input id="btmSearchInput" placeholder="æœç´¢å§“å / æ‹¼éŸ³" class="btm-select" style="flex:1;min-width:180px;" />
					</div>
					<div id="btmStudentInfo" class="btm-stu-info"></div>
					<div class="btm-legend">
						<span>å•å‡»é€‰æ‹©/å–æ¶ˆ</span>
						<span>ç°è‰² = ä¼‘æ¯/åˆé¤</span>
						<span>ä¿å­˜å†™å…¥ student_time_slots</span>
					</div>
					<div class="btm-table-wrap">
						<table class="btm-table">
							<thead>
								<tr><th class="btm-time-col">æ—¶é—´</th><th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th></tr>
							</thead>
							<tbody id="btmTbody"></tbody>
						</table>
					</div>
				</div>
				<div class="btm-right">
					<div class="btm-summary-title">å½“å‰å­¦ç”Ÿé€‰ä¸­èŠ‚æ¬¡</div>
					<div id="btmSelectedList" class="btm-selected-list"></div>
					<div class="btm-note">è¯´æ˜ï¼šä¿å­˜è¦†ç›–è¯¥å­¦ç”Ÿæœ¬å‘¨(å‘¨ä¸€-å‘¨äº”)æ—¢æœ‰æ—¶é—´æ®µã€‚é€‰æ‹©"ä»…é™ä»Šæ—¥"å°†åœ¨æ˜æ—¥å‡Œæ™¨è‡ªåŠ¨æ¢å¤åŸè®¾ç½®ã€‚</div>
				</div>
			</div>
		</div>
	</div>

	<!-- å­¦ç”Ÿé€‰æ‹© Modal -->
	<div class="modal-backdrop" id="studentModalBackdrop" style="display:none;">
		<div class="modal" role="dialog" aria-modal="true" aria-labelledby="studentModalTitle">
			<div class="modal-header">
				<h3 id="studentModalTitle">é€‰æ‹©å­¦ç”Ÿ</h3>
				<div style="display: flex; gap: 8px; align-items: center;">
					<button id="btnMultiSelectToggle" class="sl-btn sl-btn-secondary" style="font-size: 12px; padding: 6px 12px;">å¤šäººç™»è®°</button>
					<button id="btnCloseStudentModal" class="ghost" style="padding:4px 8px;">âœ•</button>
				</div>
			</div>
			<div class="modal-body">
				<input id="studentSearch" type="text" placeholder="æŒ‰å§“å / æ‹¼éŸ³é¦–å­—æ¯ / ä¸“ä¸šè¿‡æ»¤" />
				<!-- å·²é€‰å­¦ç”Ÿåˆ—è¡¨åŒºåŸŸ (ä»…åœ¨å¤šé€‰æ¨¡å¼ä¸‹æ˜¾ç¤º) -->
				<div id="selectedStudentsArea" style="display: none; margin-top: 12px; padding: 12px; background: var(--surface-alt); border-radius: 8px; border: 1px solid var(--outline);">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
						<span style="font-size: 13px; font-weight: 600; color: var(--text);">å·²é€‰å­¦ç”Ÿ (<span id="selectedStudentsCount">0</span>)</span>
						<button id="btnClearSelectedStudents" class="sl-btn sl-btn-secondary" style="font-size: 11px; padding: 4px 8px;">æ¸…ç©º</button>
					</div>
					<div id="selectedStudentsList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 30px;">
						<span style="color: var(--text-dim); font-size: 12px; font-style: italic;">æœªé€‰æ‹©å­¦ç”Ÿ</span>
					</div>
				</div>
				<div class="student-list" id="studentList"></div>
			</div>
			<div class="modal-footer">
				<button id="btnStudentModalCancel" class="ghost">å–æ¶ˆ</button>
				<button id="btnConfirmMultiSelect" class="sl-btn sl-btn-primary" style="display: none;">ç¡®è®¤ç™»è®° (<span id="confirmButtonCount">0</span>äºº)</button>
			</div>
		</div>
	</div>

	<!-- æ–°å¢æˆ¿é—´ Modal -->
	<div class="modal-backdrop" id="addRoomModalBackdrop" style="display:none;">
		<div class="modal add-room-modal" role="dialog" aria-modal="true" aria-labelledby="addRoomModalTitle">
			<div class="modal-header">
				<h3 id="addRoomModalTitle">æ–°å¢ç´æˆ¿</h3>
				<button id="btnCloseAddRoomModal" class="ghost" style="padding:4px 8px;">âœ•</button>
			</div>
			<div class="modal-body">
				<div class="form-grid">
					<div class="form-field">
						<label>
							<span class="icon">ğŸ·ï¸</span>
							æˆ¿é—´åç§°
							<span class="required">*</span>
						</label>
						<input id="addRoomName" type="text" placeholder="ä¾‹å¦‚ï¼š101ã€ç´æˆ¿A" />
					</div>
					<div class="form-field">
						<label>
							<span class="icon">ğŸ“</span>
							ä½ç½®
						</label>
						<input id="addRoomLocation" type="text" placeholder="ä¾‹å¦‚ï¼š1æ¥¼ã€éŸ³ä¹æ¥¼äºŒå±‚" />
					</div>
					<div class="form-field">
						<label>
							<span class="icon">ğŸ¼</span>
							é’¢ç´ç±»å‹
						</label>
						<div class="piano-type-display">
							<div class="piano-type-option" data-type="ç«‹å¼">ç«‹å¼é’¢ç´</div>
							<div class="piano-type-option selected" data-type="ä¸‰è§’">ä¸‰è§’é’¢ç´</div>
							<div class="piano-type-option" data-type="å…¶ä»–">å…¶ä»–</div>
						</div>
						<select id="addRoomPianoType" style="display:none;">
							<option value="ç«‹å¼">ç«‹å¼</option>
							<option value="ä¸‰è§’">ä¸‰è§’</option>
							<option value="å…¶ä»–">å…¶ä»–</option>
						</select>
					</div>
					<div class="form-field">
						<label>
							<span class="icon">ğŸ“</span>
							å¤‡æ³¨
						</label>
						<textarea id="addRoomRemark" placeholder="å¯é€‰ï¼šè®¾å¤‡è¯´æ˜ã€ä½¿ç”¨æ³¨æ„äº‹é¡¹ç­‰"></textarea>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button id="btnAddRoomCancel" class="ghost">å–æ¶ˆ</button>
				<button id="btnAddRoomConfirm" class="primary">åˆ›å»ºç´æˆ¿</button>
			</div>
		</div>
	</div>

	<!-- Toast å®¹å™¨ -->
	<div id="toastContainer" style="position:fixed;pointer-events:none;bottom:0;left:0;right:0;display:flex;flex-direction:column;align-items:flex-end;gap:10px;padding:0 24px 24px;z-index:500;"></div>

	<script>
	// å…¶å®ƒå·²æœ‰è„šæœ¬...
	</script>

<!-- ===== ç»ƒç´è®°å½•æŸ¥è¯¢æ¨¡å— (Practice Log Search) ===== -->
<style id="practice-log-search-style">
	.pls-backdrop{position:fixed;inset:0;z-index:4600;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;}
	.pls-modal{width:880px;max-width:96%;max-height:90vh;background:var(--surface);border:1px solid var(--outline);border-radius:18px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 14px 48px -12px rgba(0,0,0,.65);font-size:13px;}
	.pls-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--surface-alt);border-bottom:1px solid var(--outline);}
	.pls-header h3{margin:0;font-size:16px;font-weight:600;letter-spacing:.5px;}
	.pls-close{background:rgba(255,255,255,.06);border:1px solid var(--outline);border-radius:8px;color:var(--text-dim);cursor:pointer;font-weight:600;width:32px;height:32px;display:flex;align-items:center;justify-content:center;}
	.pls-close:hover{color:var(--text);background:rgba(255,255,255,.12);} 
	.pls-body{display:flex;flex-direction:column;padding:14px 18px;gap:14px;overflow:hidden;}
	.pls-form{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;background:var(--surface-alt);padding:12px 14px;border:1px solid var(--outline);border-radius:12px;flex-shrink:0;}
	.pls-form label{display:flex;flex-direction:column;font-size:12px;gap:4px;font-weight:600;color:var(--text-dim);} 
	.pls-form input[type=text]{background:#11161d;border:1px solid var(--outline);color:var(--text);padding:8px 10px;border-radius:8px;min-width:160px;}
	.pls-form input[type=text]:focus{outline:none;border-color:var(--accent);box-shadow:var(--focus);} 
	.pls-form select{background:#11161d;border:1px solid var(--outline);color:var(--text);padding:8px 10px;border-radius:8px;}
	.pls-form button{background:var(--accent);border:1px solid var(--accent);color:#fff;font-weight:600;padding:8px 16px;border-radius:8px;cursor:pointer;letter-spacing:.5px;}
	.pls-form button:hover{background:var(--accent-hover);} 
	.pls-meta{font-size:11px;color:var(--text-dim);display:flex;flex-wrap:wrap;gap:12px;flex-shrink:0;}
	.pls-table-wrap{border:1px solid var(--outline);border-radius:14px;overflow:auto;background:#131920;flex:1;min-height:0;}
	.pls-table{width:100%;border-collapse:collapse;font-size:12px;}
	.pls-table thead th{position:sticky;top:0;background:#1d2530;font-weight:600;padding:8px 8px;text-align:left;border-bottom:1px solid #2b3642;color:#d0d9e2;letter-spacing:.3px;font-size:12px;z-index:1;}
	.pls-table tbody td{padding:6px 8px;border-bottom:1px solid #202a34;line-height:1.4;white-space:nowrap;}
	.pls-table tbody tr:last-child td{border-bottom:none;}
	.pls-empty{padding:40px 0;text-align:center;color:var(--text-dim);font-size:13px;}
	.pls-badge{display:inline-block;padding:2px 6px;border-radius:6px;font-size:11px;font-weight:600;line-height:1;letter-spacing:.5px;}
	.pls-act-start{background:#1d4ed8;color:#fff;}
	.pls-act-end{background:#dc2626;color:#fff;}
	.pls-duration{color:#3fbf6b;font-weight:600;}
	.pls-actions{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:10px 2px;flex-shrink:0;}
	.pls-actions .left{display:flex;gap:10px;align-items:center;font-size:12px;color:var(--text-dim);} 
	.pls-load-more{background:#223043;border:1px solid #314051;color:var(--text);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;}
	.pls-load-more:hover{background:#2e3d4f;border-color:#3d4e61;}
	.pls-export{background:#2f4f78;border:1px solid #3d5f8f;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;}
	.pls-export:hover{background:#376192;}
	@media (max-width:760px){.pls-modal{width:100%;height:100%;border-radius:0;}.pls-table tbody td,.pls-table thead th{white-space:normal;}}
	</style>
	<script>
	// ç»ƒç´è®°å½•æŸ¥è¯¢æ¨¡å—
	(function(){
		const BTN_ID = 'btnPracticeLogSearch';
		document.addEventListener('DOMContentLoaded', ()=>{
			const btn = document.getElementById(BTN_ID);
			if(btn) btn.addEventListener('click', openPracticeLogSearch);
		});

		async function queryPracticeLogs({ name, days=30, limit=100, nextFrom, descending=true }){
			if(!supabaseClient){ toast('Supabase å°šæœªå°±ç»ª'); throw new Error('supabase not ready'); }
			const now = new Date();
			const from = new Date(now.getTime() - days*24*60*60*1000);
			let q = supabaseClient.from('practice_logs').select('*').eq('student_name', name).gte('timestamp', from.toISOString());
			if(descending){ q = q.order('timestamp', { ascending:false }); }
			if(nextFrom){ // åˆ†é¡µï¼šæ—¶é—´æˆ³å°äºä¸Šä¸€æ¬¡æœ€å°å€¼
				q = q.lt('timestamp', nextFrom);
			}
			q = q.limit(limit);
			const { data, error } = await q;
			if(error){ console.warn('[PracticeLogSearch] query error', error); throw error; }
			return data || [];
		}

		function fmtDate(ts){ if(!ts) return '-'; const d=new Date(ts); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0')+" "+String(d.getHours()).padStart(2,'0')+":"+String(d.getMinutes()).padStart(2,'0')+":"+String(d.getSeconds()).padStart(2,'0'); }
		function fmtDur(sec){ if(!sec && sec!==0) return '-'; const m=Math.floor(sec/60), s=sec%60; if(m>=60){ const h=Math.floor(m/60), mm=m%60; return `${h}h${mm}m`; } return m?`${m}m${s? s+'s':''}`:`${s}s`; }

		function buildModal(){
			const backdrop=document.createElement('div'); backdrop.className='pls-backdrop'; backdrop.id='practiceLogSearchBackdrop';
			backdrop.innerHTML=`<div class="pls-modal" role="dialog" aria-modal="true">
				<div class="pls-header">
					<h3>ç»ƒç´è®°å½•æŸ¥è¯¢</h3>
					<button class="pls-close" data-role="close" aria-label="å…³é—­">Ã—</button>
				</div>
				<div class="pls-body">
					<form class="pls-form" id="plsForm">
						<label>å­¦ç”Ÿå§“å<input required name="student" type="text" placeholder="å¦‚: å¼ ä¸‰" autocomplete="off" /></label>
						<label>æ—¶é—´èŒƒå›´
							<select name="days">
								<option value="7">è¿‘ 7 å¤©</option>
								<option value="30" selected>è¿‘ 30 å¤©</option>
								<option value="90">è¿‘ 90 å¤©</option>
								<option value="180">è¿‘ 180 å¤©</option>
								<option value="365">è¿‘ 365 å¤©</option>
							</select>
						</label>
						<label>æ¯é¡µæ¡æ•°
							<select name="limit">
								<option value="50">50</option>
								<option value="100" selected>100</option>
								<option value="200">200</option>
							</select>
						</label>
						<button type="submit">æŸ¥è¯¢</button>
					</form>
					<div class="pls-meta" id="plsMeta" style="display:none;"></div>
					<div class="pls-table-wrap" id="plsTableWrap" style="display:none;">
						<table class="pls-table"><thead><tr>
							<th style="width:150px;">æ—¶é—´</th>
							<th style="width:70px;">åŠ¨ä½œ</th>
							<th style="width:100px;">æˆ¿é—´</th>
							<th style="width:100px;">æ—¶æ®µ</th>
							<th style="width:80px;">å•æ¬¡æ—¶é•¿</th>
							<th style="width:110px;">ä¼šè¯èµ·</th>
							<th style="width:110px;">ä¼šè¯æ­¢</th>
						</tr></thead><tbody id="plsTbody"><tr><td colspan="7" class="pls-empty">è¯·è¾“å…¥æ¡ä»¶æŸ¥è¯¢</td></tr></tbody></table>
						<div class="pls-actions" id="plsActions" style="display:none;">
							<div class="left"><span id="plsCount"></span><span id="plsMoreHint"></span></div>
							<div class="right" style="display:flex;gap:8px;">
								<button class="pls-export" id="plsExport" type="button">å¯¼å‡º CSV</button>
								<button class="pls-load-more" id="plsLoadMore" type="button">åŠ è½½æ›´å¤š</button>
							</div>
						</div>
					</div>
				</div>
			</div>`;
			document.body.appendChild(backdrop);
			return backdrop;
		}

		function openPracticeLogSearch(){
			if(document.getElementById('practiceLogSearchBackdrop')) return; // å·²æ‰“å¼€
			const backdrop = buildModal();
			const form = backdrop.querySelector('#plsForm');
			const tbody = backdrop.querySelector('#plsTbody');
			const meta = backdrop.querySelector('#plsMeta');
			const wrap = backdrop.querySelector('#plsTableWrap');
			const btnClose = backdrop.querySelector('[data-role=close]');
			const btnMore = backdrop.querySelector('#plsLoadMore');
			const btnExport = backdrop.querySelector('#plsExport');
			const actions = backdrop.querySelector('#plsActions');
			const countEl = backdrop.querySelector('#plsCount');
			const moreHintEl = backdrop.querySelector('#plsMoreHint');
			let allData = []; let latestMinTs=null; let paging=false; let currentQuery=null;

			function renderRows(rows, append=false){
				if(!append) tbody.innerHTML='';
				if(!rows.length && !append){ tbody.innerHTML='<tr><td colspan="7" class="pls-empty">æ²¡æœ‰æ‰¾åˆ°è®°å½•</td></tr>'; return; }
				const frag=document.createDocumentFragment();
				for(const r of rows){
					const tr=document.createElement('tr');
					let actionLabel = r.action || '-';
					if(actionLabel==='assign') actionLabel='ç™»è®°ç´æˆ¿';
					else if(actionLabel==='clear') actionLabel='é€€è¿˜ç´æˆ¿';
					else if(actionLabel==='start') actionLabel='å¼€å§‹';
					else if(actionLabel==='end') actionLabel='ç»“æŸ';
					const actionBadge = `<span class="pls-badge ${r.action==='assign' || r.action==='start' ? 'pls-act-start':'pls-act-end'}">${actionLabel}</span>`;
					const duration = r.practice_duration!=null ? `<span class="pls-duration">${fmtDur(r.practice_duration)}</span>` : '-';
					const sessionSegment = (r.session_start && r.session_end) ? `${new Date(r.session_start).getHours().toString().padStart(2,'0')}:${new Date(r.session_start).getMinutes().toString().padStart(2,'0')}~${new Date(r.session_end).getHours().toString().padStart(2,'0')}:${new Date(r.session_end).getMinutes().toString().padStart(2,'0')}` : '-';
					tr.innerHTML=`<td>${fmtDate(r.timestamp||r.created_at)}</td><td>${actionBadge}</td><td>${r.room_name||'-'}</td><td>${sessionSegment}</td><td>${duration}</td><td>${r.session_start?fmtDate(r.session_start):'-'}</td><td>${r.session_end?fmtDate(r.session_end):'-'}</td>`;
					frag.appendChild(tr);
				}
				tbody.appendChild(frag);
			}

			function updateMeta(){
				if(!currentQuery){ meta.style.display='none'; return; }
				meta.style.display='flex';
				meta.innerHTML=`å­¦ç”Ÿï¼š<b>${currentQuery.name}</b> Â· æ—¶é—´èŒƒå›´ï¼šè¿‘ ${currentQuery.days} å¤© Â· å·²åŠ è½½ <b>${allData.length}</b> æ¡`;
				countEl.textContent=`å…± ${allData.length} æ¡`;
			}

			async function doQuery(evt){ evt&&evt.preventDefault(); const fd=new FormData(form); const name=(fd.get('student')||'').trim(); if(!name){ toast('è¯·è¾“å…¥å­¦ç”Ÿå§“å'); return; }
				currentQuery={ name, days: Number(fd.get('days')||30), limit: Number(fd.get('limit')||100) };
				tbody.innerHTML='<tr><td colspan="7" class="pls-empty">æŸ¥è¯¢ä¸­...</td></tr>';
				actions.style.display='none'; btnMore.disabled=true; btnExport.disabled=true; allData=[]; latestMinTs=null; paging=false;
				try{
					const rows = await queryPracticeLogs({ name: currentQuery.name, days: currentQuery.days, limit: currentQuery.limit });
					allData.push(...rows);
					if(rows.length){ latestMinTs = rows[rows.length-1].timestamp || rows[rows.length-1].created_at; }
					renderRows(rows);
					wrap.style.display='block';
					actions.style.display='flex';
					btnMore.style.display = rows.length < currentQuery.limit ? 'none':'inline-block';
					moreHintEl.textContent = btnMore.style.display==='none'? 'å·²åˆ°åº•':'å¯åŠ è½½æ›´å¤š';
					updateMeta(); btnMore.disabled=false; btnExport.disabled=false;
				}catch(e){ tbody.innerHTML='<tr><td colspan="7" class="pls-empty">æŸ¥è¯¢å¤±è´¥ï¼š'+(e.message||e)+"</td></tr>"; }
			}

			async function loadMore(){ if(!currentQuery || paging || !latestMinTs) return; paging=true; btnMore.disabled=true; btnMore.textContent='åŠ è½½ä¸­...';
				try{ const rows=await queryPracticeLogs({ name: currentQuery.name, days: currentQuery.days, limit: currentQuery.limit, nextFrom: latestMinTs });
					if(rows.length){ latestMinTs = rows[rows.length-1].timestamp || rows[rows.length-1].created_at; renderRows(rows, true); allData.push(...rows); }
					btnMore.style.display = rows.length < currentQuery.limit ? 'none':'inline-block';
					moreHintEl.textContent = btnMore.style.display==='none'? 'å·²åˆ°åº•':'å¯åŠ è½½æ›´å¤š';
					updateMeta();
				}catch(e){ toast('åŠ è½½æ›´å¤šå¤±è´¥: '+e.message); }
				finally{ paging=false; btnMore.disabled=false; btnMore.textContent='åŠ è½½æ›´å¤š'; }
			}

			function exportCsv(){
				if(!allData.length){ toast('æ²¡æœ‰æ•°æ®'); return; }
				// è¡¨å¤´
				const header = ['æ—¶é—´','åŠ¨ä½œ','æˆ¿é—´','æ—¶æ®µ','å•æ¬¡æ—¶é•¿(åˆ†é’Ÿ)','ä¼šè¯èµ·','ä¼šè¯æ­¢'];
				function esc(v){ if(v==null) return ''; v=String(v).replace(/"/g,'""'); return '"'+v+'"'; }
				function formatTs(ts){ if(!ts) return ''; const d=new Date(ts); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }
				function actionLabel(a){ if(a==='assign') return 'ç™»è®°ç´æˆ¿'; if(a==='clear') return 'é€€è¿˜ç´æˆ¿'; if(a==='start') return 'å¼€å§‹'; if(a==='end') return 'ç»“æŸ'; return a||''; }
				const lines=[header.map(esc).join(',')];
				for(const r of allData){
					const time = formatTs(r.timestamp||r.created_at);
					const act = actionLabel(r.action);
					const room = r.room_name||'';
					const sessionSeg = (r.session_start && r.session_end)? `${new Date(r.session_start).getHours().toString().padStart(2,'0')}:${new Date(r.session_start).getMinutes().toString().padStart(2,'0')}~${new Date(r.session_end).getHours().toString().padStart(2,'0')}:${new Date(r.session_end).getMinutes().toString().padStart(2,'0')}` : '';
					let durMin = '';
					if(r.practice_duration!=null){ const m = r.practice_duration / 60; durMin = (Math.round(m*10)/10).toString(); if(durMin.endsWith('.0')) durMin = durMin.slice(0,-2); }
					const start = r.session_start? formatTs(r.session_start):'';
					const end = r.session_end? formatTs(r.session_end):'';
					lines.push([time,act,room,sessionSeg,durMin,start,end].map(esc).join(','));
				}
				const blob=new Blob(['\uFEFF'+lines.join('\n')],{type:'text/csv;charset=utf-8;'});
				const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`practice_logs_${currentQuery.name}.csv`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
			}

			form.addEventListener('submit', doQuery);
			btnMore.addEventListener('click', loadMore);
			btnExport.addEventListener('click', exportCsv);
			btnClose.addEventListener('click', ()=> close(false));
			backdrop.addEventListener('click', e=>{ if(e.target===backdrop) close(false); });
			document.addEventListener('keydown', escHandler, true);
			setTimeout(()=>{ form.querySelector('input[name=student]').focus(); }, 50);
			function escHandler(e){ if(e.key==='Escape'){ e.preventDefault(); close(false); } }
			function close(){ document.removeEventListener('keydown', escHandler, true); backdrop.remove(); }
		}
	})();
	</script>

	<script>
	/*************************************************
	 * æ•°æ®å±‚ & çŠ¶æ€æ¨¡å‹
	 *************************************************/
	const SUPABASE_URL = 'https://waesizzoqodntrlvrwhw.supabase.co';
	const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhZXNpenpvcW9kbnRybHZyd2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjIyOTYsImV4cCI6MjA3MzM5ODI5Nn0.kE5gSV68q1nLo4z2IqgwqfTBVqNOJw5qs08f6r0SQH0';
	let supabaseClient = null;
	let supabaseReady = false; // å†…éƒ¨æ ‡å¿—
	// ç»Ÿä¸€å¯¹å¤–æš´éœ²ï¼Œä¾› StudentLibrary / å…¶å®ƒæ¨¡å—æ£€æµ‹
	Object.defineProperty(window,'supabaseReady',{ get(){ return supabaseReady; }, set(v){ supabaseReady=!!v; if(v){ try{ if(window.__retryStudentLibraryPending) window.__retryStudentLibraryPending(); }catch(_){ } } }});
	let realtimeChannel = null;

	// è¯·æ±‚é¢‘ç‡é™åˆ¶å™¨
	class RequestThrottler {
		constructor() {
			this.requests = new Map(); // å­˜å‚¨æ¯ç§è¯·æ±‚ç±»å‹çš„æœ€åæ‰§è¡Œæ—¶é—´
			this.minimumIntervals = {
				heartbeat: 60000,        // å¿ƒè·³æœ€çŸ­1åˆ†é’Ÿé—´éš”
				reconcile: 30000,        // çŠ¶æ€åŒæ­¥æœ€çŸ­30ç§’é—´éš”
				roomUpdate: 1000,        // æˆ¿é—´æ›´æ–°æœ€çŸ­1ç§’é—´éš”
				studentUpdate: 2000,     // å­¦ç”Ÿæ›´æ–°æœ€çŸ­2ç§’é—´éš”
				syncToCloud: 10000       // äº‘ç«¯åŒæ­¥æœ€çŸ­10ç§’é—´éš”
			};
		}
		
		canExecute(requestType, identifier = '') {
			const key = `${requestType}_${identifier}`;
			const now = Date.now();
			const lastTime = this.requests.get(key) || 0;
			const minInterval = this.minimumIntervals[requestType] || 5000;
			
			if (now - lastTime >= minInterval) {
				this.requests.set(key, now);
				return true;
			}
			
			logInfo(`è¯·æ±‚è¢«é™æµ: ${requestType} ${identifier}, è¿˜éœ€ç­‰å¾… ${Math.round((minInterval - (now - lastTime))/1000)}ç§’`);
			return false;
		}
		
		reset(requestType, identifier = '') {
			const key = `${requestType}_${identifier}`;
			this.requests.delete(key);
		}
	}
	
	// å…¨å±€è¯·æ±‚é™æµå™¨
	const requestThrottler = new RequestThrottler();

	// å…¨å±€å®šæ—¶å™¨ç®¡ç†å™¨
	class TimerManager {
		constructor() {
			this.timers = new Map();
		}
		
		setInterval(name, callback, interval) {
			this.clearTimer(name);
			const id = setInterval(callback, interval);
			this.timers.set(name, { id, type: 'interval' });
			return id;
		}
		
		setTimeout(name, callback, delay) {
			this.clearTimer(name);
			const id = setTimeout(() => {
				this.timers.delete(name);
				callback();
			}, delay);
			this.timers.set(name, { id, type: 'timeout' });
			return id;
		}
		
		clearTimer(name) {
			const timer = this.timers.get(name);
			if (timer) {
				if (timer.type === 'interval') {
					clearInterval(timer.id);
				} else {
					clearTimeout(timer.id);
				}
				this.timers.delete(name);
			}
		}
		
		clearAllTimers() {
			for (const [name, timer] of this.timers) {
				if (timer.type === 'interval') {
					clearInterval(timer.id);
				} else {
					clearTimeout(timer.id);
				}
			}
			this.timers.clear();
			logInfo('å·²æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨');
		}
	}
	
	// å…¨å±€å®šæ—¶å™¨ç®¡ç†å™¨å®ä¾‹
	const timerManager = new TimerManager();
	
	// ğŸ• æœåŠ¡å™¨æ—¶é—´åŒæ­¥ç³»ç»Ÿ
	class ServerTimeSync {
		constructor() {
			this.serverTimeOffset = 0; // æœåŠ¡å™¨æ—¶é—´ - æœ¬åœ°æ—¶é—´çš„åç§»é‡(ms)
			this.lastSyncTime = 0;
			this.syncInterval = 5 * 60 * 1000; // æ¯5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
			this.isInitialized = false;
			this.syncInProgress = false;
		}
		
		// åˆå§‹åŒ–æ—¶é—´åŒæ­¥
		async init() {
			if (this.isInitialized) return;
			
			// å…ˆè®¾ç½®é»˜è®¤å€¼ï¼Œç¡®ä¿ç³»ç»Ÿå¯ä»¥å·¥ä½œ
			this.serverTimeOffset = 0;
			this.isInitialized = true;
			
			try {
				// å¼‚æ­¥è¿›è¡Œé¦–æ¬¡åŒæ­¥
				await this.syncWithServer();
				this.startPeriodicSync();
			} catch (error) {
				logWarn('æœåŠ¡å™¨æ—¶é—´åŒæ­¥åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ—¶é—´:', error.message);
				// å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿå¯åŠ¨å®šæœŸåŒæ­¥å°è¯•
				this.startPeriodicSync();
			}
		}
		
		// ä¸æœåŠ¡å™¨åŒæ­¥æ—¶é—´
		async syncWithServer() {
			if (this.syncInProgress || !supabaseClient) return;
			this.syncInProgress = true;
			try {
				// ç®€åŒ–ç­–ç•¥ï¼šç”±äºæ— æ³•è·å–çœŸå®æœåŠ¡å™¨æ—¶é—´æˆ³ï¼Œä»…åšè¿é€šæ€§æ£€æµ‹
				// å®é™…æ—¶é—´åç§»ä¿æŒä¸º0ï¼Œé¿å…å¼‚å¸¸çš„å·¨å¤§åç§»å€¼
				const t0 = performance.now();
				const { data, error } = await supabaseClient
					.from('rooms')
					.select('name')
					.limit(1);
				const t1 = performance.now();
				
				if (error) {
					this.failCount = (this.failCount||0) + 1;
					logWarn('[TimeSync] è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä¿ç•™æ—§åç§» (failCount=' + this.failCount + ')');
					return;
				}
				
				// æˆåŠŸè¿æ¥ï¼Œä½†ä¸è®¡ç®—æ—¶é—´åç§»ï¼ˆé¿å…ä¸å‡†ç¡®çš„ä¼°ç®—ï¼‰
				this.rtt = t1 - t0;
				this.lastSyncTime = Date.now();
				this.failCount = 0;
				
				// æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¼‚å¸¸çš„å·¨å¤§åç§»å€¼ï¼Œå¦‚æœæœ‰åˆ™é‡ç½®ä¸º0
				const oldOffset = this.serverTimeOffset || 0;
				if (Math.abs(oldOffset) > 24 * 60 * 60 * 1000) { // è¶…è¿‡24å°æ—¶
					logWarn('[TimeSync] æ£€æµ‹åˆ°å¼‚å¸¸åç§»å€¼ï¼Œé‡ç½®ä¸º0');
					this.serverTimeOffset = 0;
				}
				
			} catch (e) {
				logWarn('[TimeSync] åŒæ­¥å¼‚å¸¸: ' + e.message);
			} finally {
				this.syncInProgress = false;
			}
		}
		
		// å¯åŠ¨å®šæœŸåŒæ­¥
		startPeriodicSync() {
			timerManager.setInterval('serverTimeSync', () => {
				this.syncWithServer();
			}, this.syncInterval);
		}
		
		// è·å–æœåŠ¡å™¨åŒæ­¥çš„å½“å‰æ—¶é—´
		now() {
			return Date.now() + this.serverTimeOffset;
		}

		// è¯Šæ–­çŠ¶æ€
		getStatus(){
			return {
				offset: Math.round(this.serverTimeOffset||0),
				lastSync: this.lastSyncTime ? (Date.now()-this.lastSyncTime)+'ms ago' : 'never',
				inProgress: !!this.syncInProgress,
				rtt: Math.round(this.rtt||0),
				failCount: this.failCount||0
			};
		}
		
		// æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åŒæ­¥
		shouldResync() {
			return (Date.now() - this.lastSyncTime) > this.syncInterval * 2; // è¶…è¿‡2ä¸ªåŒæ­¥å‘¨æœŸ
		}
		
		// æ‰‹åŠ¨è§¦å‘åŒæ­¥
		async manualSync() {
			logInfo('æ‰‹åŠ¨è§¦å‘æ—¶é—´åŒæ­¥...');
			await this.syncWithServer();
		}
	}
	
	// å…¨å±€æ—¶é—´åŒæ­¥å™¨
	const serverTimeSync = new ServerTimeSync();
	
	// ğŸ—„ï¸ è®¡æ—¶å™¨çŠ¶æ€æŒä¹…åŒ–ç³»ç»Ÿ
	class TimerPersistence {
		constructor() {
			this.storageKey = 'yms_timer_states';
			this.maxAge = 30 * 60 * 1000; // ğŸ”§ é™ä½ä¸º30åˆ†é’Ÿï¼Œå‡å°‘è¿‡æœŸç¼“å­˜é—®é¢˜
			this.maxStateAge = 12 * 60 * 60 * 1000; // 12å°æ—¶çŠ¶æ€æœ‰æ•ˆæœŸ
			this.cleanupInterval = 5 * 60 * 1000; // 5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
			
			// å¯åŠ¨å®šæœŸæ¸…ç†
			this.startPeriodicCleanup();
		}
		
		// å¯åŠ¨å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
		startPeriodicCleanup() {
			// é˜²æ­¢é‡å¤å¯åŠ¨
			if (this.cleanupTimer) {
				clearInterval(this.cleanupTimer);
			}
			
			this.cleanupTimer = setInterval(() => {
				this.autoCleanupExpiredStates();
			}, this.cleanupInterval);
		}
		
		// è‡ªåŠ¨æ¸…ç†è¿‡æœŸçŠ¶æ€
		autoCleanupExpiredStates() {
			try {
				const stored = localStorage.getItem(this.storageKey);
				if (!stored) return;
				
				const data = JSON.parse(stored);
				const now = getServerSyncedTime();
				
				// è¿‡æ»¤æ‰è¿‡æœŸçŠ¶æ€
				const validStates = (data.states || []).filter(state => {
					const cacheAge = now - (data.timestamp || 0);
					const stateAge = now - (state.registerTime || 0);
					
					return cacheAge <= this.maxAge && stateAge <= this.maxStateAge;
				});
				
				// å¦‚æœæœ‰çŠ¶æ€è¢«æ¸…ç†ï¼Œæ›´æ–°ç¼“å­˜
				if (validStates.length !== (data.states || []).length) {
					if (validStates.length === 0) {
						localStorage.removeItem(this.storageKey);
						logInfo(`[TimerPersistence] æ¸…ç†äº†æ‰€æœ‰è¿‡æœŸç¼“å­˜çŠ¶æ€`);
					} else {
						const updatedData = {
							states: validStates,
							timestamp: now
						};
						localStorage.setItem(this.storageKey, JSON.stringify(updatedData));
						logInfo(`[TimerPersistence] æ¸…ç†äº† ${(data.states || []).length - validStates.length} ä¸ªè¿‡æœŸç¼“å­˜çŠ¶æ€`);
					}
				}
			} catch (e) {
				logWarn('[TimerPersistence] è‡ªåŠ¨æ¸…ç†å¤±è´¥:', e.message);
			}
		}
		
		// ä¿å­˜è®¡æ—¶å™¨çŠ¶æ€
		saveTimerStates() {
			const occupiedRooms = Store.rooms.filter(r => r.occupant_student_name && r.registerTime);
			const timerStates = occupiedRooms.map(room => ({
				roomName: room.name,
				occupant_student_name: room.occupant_student_name,
				registerTime: room.registerTime,
				version: room.version,
				savedAt: getServerSyncedTime()
			}));
			
			const data = {
				states: timerStates,
				timestamp: getServerSyncedTime()
			};
			
			try {
				localStorage.setItem(this.storageKey, JSON.stringify(data));
			} catch (e) {
				logWarn('ä¿å­˜è®¡æ—¶å™¨çŠ¶æ€å¤±è´¥:', e.message);
			}
		}
		
		// æ¢å¤è®¡æ—¶å™¨çŠ¶æ€
		restoreTimerStates() {
			try {
				const stored = localStorage.getItem(this.storageKey);
				if (!stored) return [];
				
				const data = JSON.parse(stored);
				const now = getServerSyncedTime();
				
				// æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸ
				if (now - data.timestamp > this.maxAge) {
					localStorage.removeItem(this.storageKey);
					return [];
				}
				
				return data.states || [];
			} catch (e) {
				logWarn('æ¢å¤è®¡æ—¶å™¨çŠ¶æ€å¤±è´¥:', e.message);
				localStorage.removeItem(this.storageKey);
				return [];
			}
		}
		
		// æ¸…ç†è¿‡æœŸçŠ¶æ€
		cleanup() {
			localStorage.removeItem(this.storageKey);
		}
		
		// ğŸ”§ å¢å¼ºç‰ˆåŒæ­¥çŠ¶æ€åˆ°äº‘ç«¯ï¼ˆå¸¦æœåŠ¡å™¨éªŒè¯ï¼‰
		async syncStatesToCloud() {
			const occupiedRooms = Store.rooms.filter(r => {
				// æ›´ä¸¥æ ¼çš„è¿‡æ»¤æ¡ä»¶
				if (!r.occupant_student_name || !r.registerTime) return false;
				
				// æ£€æŸ¥çŠ¶æ€æ˜¯å¦è¿‡æœŸï¼ˆè¶…è¿‡12å°æ—¶çš„ä¸åŒæ­¥ï¼‰
				const ageHours = (getServerSyncedTime() - r.registerTime) / (1000 * 60 * 60);
				return ageHours <= 12;
			});
			
			if (occupiedRooms.length === 0) {
				logInfo('[TimerPersistence] æ— æœ‰æ•ˆå ç”¨çŠ¶æ€éœ€è¦åŒæ­¥');
				return;
			}
			
			try {
				logInfo(`[TimerPersistence] å¼€å§‹åŒæ­¥ ${occupiedRooms.length} ä¸ªæˆ¿é—´çŠ¶æ€åˆ°äº‘ç«¯...`);
				let syncedCount = 0;
				let skippedCount = 0;
				
				for (const room of occupiedRooms) {
					try {
						// ğŸ”§ å…³é”®æ”¹è¿›ï¼šåŒæ­¥å‰å…ˆéªŒè¯æœåŠ¡å™¨å½“å‰çŠ¶æ€
						const { data: serverState, error: queryError } = await supabaseClient
							.from('rooms')
							.select('occupant_student_name, register_time, version, updated_at')
							.eq('name', room.name)
							.single();
						
						if (queryError) {
							logWarn(`[TimerPersistence] æŸ¥è¯¢æˆ¿é—´ ${room.name} æœåŠ¡å™¨çŠ¶æ€å¤±è´¥:`, queryError.message);
							skippedCount++;
							continue;
						}
						
						// æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€æ˜¯å¦ä¸æœ¬åœ°ä¸€è‡´
						const serverOccupant = serverState?.occupant_student_name;
						const serverRegisterTime = serverState?.register_time ? new Date(serverState.register_time).getTime() : null;
						
						if (serverOccupant === room.occupant_student_name && 
							serverRegisterTime && 
							Math.abs(serverRegisterTime - room.registerTime) <= 5000) {
							// çŠ¶æ€åŒ¹é…ï¼Œå¯ä»¥å®‰å…¨æ›´æ–°éå…³é”®å­—æ®µ
							await supabaseClient
								.from('rooms')
								.update({
									heartbeat_at: new Date().toISOString(),
									version: Math.max(room.version || 0, serverState?.version || 0)
								})
								.eq('name', room.name);
							
							syncedCount++;
							logInfo(`[TimerPersistence] å·²åŒæ­¥æˆ¿é—´å¿ƒè·³: ${room.name}`);
						} else {
							// çŠ¶æ€ä¸åŒ¹é…ï¼Œä¸å¼ºåˆ¶è¦†ç›–æœåŠ¡å™¨æ•°æ®
							logWarn(`[TimerPersistence] è·³è¿‡æˆ¿é—´ ${room.name}ï¼Œæœ¬åœ°ä¸æœåŠ¡å™¨çŠ¶æ€ä¸åŒ¹é…`);
							logWarn(`  æœ¬åœ°: ${room.occupant_student_name} @ ${new Date(room.registerTime).toLocaleString()}`);
							logWarn(`  æœåŠ¡å™¨: ${serverOccupant} @ ${serverRegisterTime ? new Date(serverRegisterTime).toLocaleString() : 'null'}`);
							skippedCount++;
						}
					} catch (roomError) {
						logWarn(`[TimerPersistence] åŒæ­¥æˆ¿é—´ ${room.name} å¤±è´¥:`, roomError.message);
						skippedCount++;
					}
				}
				
				logInfo(`[TimerPersistence] åŒæ­¥å®Œæˆ: ${syncedCount} æˆåŠŸ, ${skippedCount} è·³è¿‡`);
			} catch (error) {
				logWarn('[TimerPersistence] åŒæ­¥è®¡æ—¶çŠ¶æ€åˆ°äº‘ç«¯å¤±è´¥:', error.message);
			}
		}
	}
	
	// å…¨å±€è®¡æ—¶å™¨æŒä¹…åŒ–ç®¡ç†å™¨
	const timerPersistence = new TimerPersistence();
	
	// ğŸ”§ æ·»åŠ ç¼“å­˜æ•°æ®éªŒè¯å’Œæ¸…ç†å·¥å…·å‡½æ•°
	window.debugCacheStatus = function() {
		console.log('=== ç¼“å­˜çŠ¶æ€è°ƒè¯•ä¿¡æ¯ ===');
		try {
			const stored = localStorage.getItem(timerPersistence.storageKey);
			if (!stored) {
				console.log('âŒ æ— ç¼“å­˜æ•°æ®');
				return { hasCache: false };
			}
			
			const data = JSON.parse(stored);
			const now = Date.now();
			const cacheAge = now - (data.timestamp || 0);
			const states = data.states || [];
			
			console.log(`ğŸ“¦ ç¼“å­˜æ—¶é—´: ${new Date(data.timestamp).toLocaleString()}`);
			console.log(`â° ç¼“å­˜å¹´é¾„: ${Math.round(cacheAge/60000)}åˆ†é’Ÿ`);
			console.log(`ğŸ“Š ç¼“å­˜çŠ¶æ€æ•°: ${states.length}`);
			
			const validStates = states.filter(state => {
				const stateAge = now - (state.registerTime || 0);
				return stateAge <= 12 * 60 * 60 * 1000; // 12å°æ—¶
			});
			
			console.log(`âœ… æœ‰æ•ˆçŠ¶æ€æ•°: ${validStates.length}`);
			console.log(`âŒ è¿‡æœŸçŠ¶æ€æ•°: ${states.length - validStates.length}`);
			
			if (states.length > 0) {
				console.log('\nè¯¦ç»†çŠ¶æ€:');
				states.forEach((state, i) => {
					const stateAge = Math.round((now - state.registerTime) / 60000);
					const status = stateAge <= 12 * 60 ? 'âœ…' : 'âŒ';
					console.log(`${status} ${i+1}. ${state.roomName} -> ${state.occupant_student_name} (${stateAge}åˆ†é’Ÿå‰)`);
				});
			}
			
			return {
				hasCache: true,
				cacheAge: Math.round(cacheAge/60000),
				totalStates: states.length,
				validStates: validStates.length,
				expiredStates: states.length - validStates.length
			};
		} catch (e) {
			console.error('âŒ ç¼“å­˜è§£æå¤±è´¥:', e.message);
			return { hasCache: false, error: e.message };
		}
	};
	
	// æ‰‹åŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
	window.cleanExpiredCache = function() {
		console.log('ğŸ§¹ å¼€å§‹æ¸…ç†è¿‡æœŸç¼“å­˜...');
		timerPersistence.autoCleanupExpiredStates();
		setTimeout(() => {
			window.debugCacheStatus();
		}, 100);
	};
	
	// å®Œå…¨æ¸…ç†æ‰€æœ‰ç¼“å­˜
	window.clearAllCache = function() {
		console.log('ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰ç¼“å­˜æ•°æ®...');
		timerPersistence.cleanup();
		console.log('âœ… ç¼“å­˜å·²æ¸…ç†');
	};
	
	// ğŸ”§ æ‰‹åŠ¨è§¦å‘æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å’Œä¿®å¤
	window.checkDataConsistency = async function() {
		console.log('ğŸ” å¼€å§‹æ‰‹åŠ¨æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥...');
		
		if (!window.DataConsistencyValidator) {
			console.error('âŒ DataConsistencyValidator ä¸å¯ç”¨');
			return;
		}
		
		try {
			const result = await window.DataConsistencyValidator.validateOnPageLoad();
			console.log('ğŸ“Š æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ç»“æœ:', result);
			
			if (result.issues > 0) {
				console.log(`âš ï¸ å‘ç° ${result.issues} ä¸ªé—®é¢˜ï¼Œå·²è‡ªåŠ¨ä¿®å¤`);
			} else {
				console.log('âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡');
			}
			
			return result;
		} catch (error) {
			console.error('âŒ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥:', error.message);
			return { error: error.message };
		}
	};
	
	// ğŸ”§ å¿«é€Ÿè¯Šæ–­Storeä¸æ•°æ®åº“çš„å·®å¼‚
	window.diagnoseDifferences = async function() {
		console.log('ğŸ” å¼€å§‹è¯Šæ–­Storeä¸æ•°æ®åº“å·®å¼‚...');
		
		try {
			const storeCount = Store.rooms ? Store.rooms.length : 0;
			const dbRooms = await fetchRooms();
			const dbCount = dbRooms ? dbRooms.length : 0;
			
			console.log(`ğŸ“Š æˆ¿é—´æ•°é‡å¯¹æ¯”:`);
			console.log(`  Store: ${storeCount} ä¸ªæˆ¿é—´`);
			console.log(`  Database: ${dbCount} ä¸ªæˆ¿é—´`);
			console.log(`  å·®å¼‚: ${Math.abs(storeCount - dbCount)} ä¸ªæˆ¿é—´`);
			
			if (storeCount > 0 && dbCount > 0) {
				const storeNames = new Set(Store.rooms.map(r => r.name));
				const dbNames = new Set(dbRooms.map(r => r.name));
				
				const storeOnly = Store.rooms.filter(r => !dbNames.has(r.name));
				const dbOnly = dbRooms.filter(r => !storeNames.has(r.name));
				
				console.log(`ğŸ” è¯¦ç»†åˆ†æ:`);
				console.log(`  Storeç‹¬æœ‰: ${storeOnly.length} ä¸ªæˆ¿é—´`, storeOnly.slice(0, 10).map(r => r.name));
				console.log(`  DBç‹¬æœ‰: ${dbOnly.length} ä¸ªæˆ¿é—´`, dbOnly.slice(0, 10).map(r => r.name));
			}
			
			return {
				storeCount,
				dbCount,
				difference: Math.abs(storeCount - dbCount)
			};
		} catch (error) {
			console.error('âŒ è¯Šæ–­å¤±è´¥:', error.message);
			return { error: error.message };
		}
	};
	
	// æ¢å¤æˆ¿é—´è®¡æ—¶å™¨çŠ¶æ€
	async function restoreRoomTimerStates() {
		const savedStates = timerPersistence.restoreTimerStates();
		if (savedStates.length === 0) {
			logInfo('æ— è®¡æ—¶å™¨çŠ¶æ€éœ€è¦æ¢å¤');
			return;
		}
		
		// ğŸ”§ æ¢å¤å‰è¿›è¡Œæ•°æ®ä¸€è‡´æ€§éªŒè¯ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼‰
		logInfo('è®¡æ—¶å™¨çŠ¶æ€æ¢å¤å‰è¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥...');
		let validStates = [];
		const currentTime = getServerSyncedTime();
		const maxCacheAge = 30 * 60 * 1000; // 30åˆ†é’Ÿç¼“å­˜æœ‰æ•ˆæœŸ
		const maxStateAge = 12 * 60 * 60 * 1000; // 12å°æ—¶çŠ¶æ€æœ‰æ•ˆæœŸ
		
		// é¦–å…ˆè¿‡æ»¤æ˜æ˜¾è¿‡æœŸçš„ç¼“å­˜
		const recentStates = savedStates.filter(state => {
			const cacheAge = currentTime - (state.savedAt || 0);
			const stateAge = currentTime - (state.registerTime || 0);
			
			if (cacheAge > maxCacheAge) {
				logWarn(`[TimerRestore] ç¼“å­˜è¿‡æœŸï¼Œè·³è¿‡æˆ¿é—´ ${state.roomName} (ç¼“å­˜æ—¶é—´: ${Math.round(cacheAge/60000)}åˆ†é’Ÿå‰)`);
				return false;
			}
			
			if (stateAge > maxStateAge) {
				logWarn(`[TimerRestore] çŠ¶æ€è¿‡æœŸï¼Œè·³è¿‡æˆ¿é—´ ${state.roomName} (çŠ¶æ€æ—¶é—´: ${Math.round(stateAge/3600000)}å°æ—¶å‰)`);
				return false;
			}
			
			return true;
		});
		
		logInfo(`[TimerRestore] ç¼“å­˜çŠ¶æ€è¿‡æ»¤: ${savedStates.length} -> ${recentStates.length}`);
		
		// å¯¹å‰©ä½™çŠ¶æ€è¿›è¡ŒæœåŠ¡å™¨éªŒè¯
		for (const state of recentStates) {
			try {
				const dbRoom = await supabaseClient
					.from('rooms')
					.select('name, occupant_student_name, register_time, version')
					.eq('name', state.roomName)
					.single();
				
				if (dbRoom.data && dbRoom.data.occupant_student_name) {
					// æ£€æŸ¥å ç”¨è€…æ˜¯å¦åŒ¹é…
					if (dbRoom.data.occupant_student_name === state.occupant_student_name) {
						// æ£€æŸ¥æ³¨å†Œæ—¶é—´æ˜¯å¦åŒ¹é…ï¼ˆå…è®¸5ç§’è¯¯å·®ï¼‰
						const dbRegisterTime = dbRoom.data.register_time ? new Date(dbRoom.data.register_time).getTime() : null;
						const timeDiff = dbRegisterTime && state.registerTime ? Math.abs(dbRegisterTime - state.registerTime) : 0;
						
						if (!dbRegisterTime || timeDiff <= 5000) {
							// æ•°æ®åº“ç¡®è®¤æˆ¿é—´è¢«å ç”¨ä¸”ä¿¡æ¯åŒ¹é…ï¼ŒçŠ¶æ€æœ‰æ•ˆ
							validStates.push({
								...state,
								serverVersion: dbRoom.data.version || 0
							});
							logInfo(`[TimerRestore] éªŒè¯é€šè¿‡: ${state.roomName} -> ${state.occupant_student_name}`);
						} else {
							logWarn(`[TimerRestore] æ—¶é—´ä¸åŒ¹é…ï¼Œè·³è¿‡æˆ¿é—´ ${state.roomName} (æ—¶å·®: ${Math.round(timeDiff/1000)}ç§’)`);
						}
					} else {
						logWarn(`[TimerRestore] å ç”¨è€…ä¸åŒ¹é…ï¼Œè·³è¿‡æˆ¿é—´ ${state.roomName} (ç¼“å­˜: ${state.occupant_student_name}, æ•°æ®åº“: ${dbRoom.data.occupant_student_name})`);
					}
				} else {
					// æ•°æ®åº“æ˜¾ç¤ºæˆ¿é—´ä¸ºç©ºï¼Œç¼“å­˜çŠ¶æ€æ— æ•ˆ
					logWarn(`[TimerRestore] æˆ¿é—´ ${state.roomName} ç¼“å­˜æ˜¾ç¤ºå ç”¨ä½†æ•°æ®åº“ä¸ºç©ºï¼Œè·³è¿‡æ¢å¤`);
				}
			} catch (error) {
				// æŸ¥è¯¢å¤±è´¥ï¼Œä¿å®ˆèµ·è§è·³è¿‡è¯¥çŠ¶æ€
				logWarn(`[TimerRestore] éªŒè¯æˆ¿é—´ ${state.roomName} çŠ¶æ€å¤±è´¥:`, error.message);
			}
		}
		
		if (validStates.length < savedStates.length) {
			const invalidCount = savedStates.length - validStates.length;
			logWarn(`[TimerRestore] å‘ç° ${invalidCount} ä¸ªæ— æ•ˆç¼“å­˜çŠ¶æ€ï¼Œå·²è¿‡æ»¤`);
			toast(`è¿‡æ»¤äº† ${invalidCount} ä¸ªè¿‡æœŸçš„æˆ¿é—´çŠ¶æ€`, 'warn');
		}
		
		let restoredCount = 0;
		
		validStates.forEach(state => {
			const room = Store.byName.get(state.roomName);
			if (!room) {
				logWarn(`æ¢å¤è®¡æ—¶å™¨çŠ¶æ€å¤±è´¥ï¼šæˆ¿é—´ ${state.roomName} ä¸å­˜åœ¨`);
				return;
			}
			
			// çŠ¶æ€å·²ç»é€šè¿‡éªŒè¯ï¼Œç›´æ¥æ¢å¤ï¼ˆä¹‹å‰å·²æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼‰
			
			// åªæœ‰å½“å‰æˆ¿é—´æ˜¯ç©ºé—²çŠ¶æ€æ—¶æ‰æ¢å¤
			if (!room.occupant_student_name) {
				room.occupant_student_name = state.occupant_student_name || state.occupant;
				room.registerTime = state.registerTime;
				room.register_time = state.registerTime ? new Date(state.registerTime).toISOString() : null;
				room.version = state.serverVersion || state.version || 0;
				restoredCount++;
				logInfo(`æ¢å¤è®¡æ—¶å™¨çŠ¶æ€ï¼š${state.roomName} -> ${state.occupant_student_name || state.occupant}`);
			}
		});
		
		if (restoredCount > 0) {
			logInfo(`æˆåŠŸæ¢å¤ ${restoredCount} ä¸ªæˆ¿é—´çš„è®¡æ—¶å™¨çŠ¶æ€`);
			
			// å¼‚æ­¥åŒæ­¥çŠ¶æ€åˆ°äº‘ç«¯
			setTimeout(() => {
				timerPersistence.syncStatesToCloud();
			}, 2000);
		}
	}
	
	// è·å–æœåŠ¡å™¨åŒæ­¥çš„æ—¶é—´ï¼ˆä¾›å…¨å±€ä½¿ç”¨ï¼‰
	function getServerSyncedTime() {
		try {
			// ç®€åŒ–é€»è¾‘ï¼šç›´æ¥è¿”å›æœ¬åœ°æ—¶é—´ï¼Œé¿å…æ—¶é—´åŒæ­¥é—®é¢˜
			return Date.now();
		} catch (error) {
			logWarn('è·å–åŒæ­¥æ—¶é—´å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ—¶é—´:', error.message);
			return Date.now();
		}
	}
	
	// ğŸ• å…¨å±€è®¡æ—¶å™¨æ›´æ–°ç³»ç»Ÿ
	function updateAllRoomTimers() {
		const now = getServerSyncedTime();
		let needsFullRerender = [];
		
		// æ‰¹é‡å¤„ç†æ‰€æœ‰å ç”¨çš„æˆ¿é—´
		Store.rooms.forEach(room => {
			if (!room.occupant_student_name || !room.registerTime) return;
			
			const roomCard = document.querySelector(`[data-room="${CSS.escape(room.name)}"]`);
			if (!roomCard) return;
			
			const chip = roomCard.querySelector('.chip');
			if (!chip) return;
			
			const currentStatus = roomCard.dataset.status;
			const newStatusInfo = statusInfo(room);
			
			// å¦‚æœçŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼ˆpreparing -> occupied -> overtimeï¼‰ï¼Œéœ€è¦å®Œæ•´é‡æ¸²æŸ“
			if (currentStatus !== newStatusInfo.state) {
				needsFullRerender.push(room.name);
				return;
			}
			
			// çŠ¶æ€ç›¸åŒï¼Œåªæ›´æ–°æ–‡æœ¬å†…å®¹
			if (chip.textContent !== newStatusInfo.chip) {
				chip.textContent = newStatusInfo.chip;
			}
		});
		
		// æ‰¹é‡é‡æ¸²æŸ“éœ€è¦çŠ¶æ€æ›´æ–°çš„æˆ¿é—´
		needsFullRerender.forEach(roomName => {
			renderRoomCard(roomName);
		});
		
		// æ€§èƒ½ç›‘æ§ï¼šå¦‚æœéœ€è¦é‡æ¸²æŸ“çš„æˆ¿é—´è¿‡å¤šï¼Œè®°å½•è­¦å‘Š
		if (needsFullRerender.length > 5) {
			logWarn(`è®¡æ—¶å™¨æ›´æ–°è§¦å‘äº†${needsFullRerender.length}ä¸ªæˆ¿é—´çš„å®Œæ•´é‡æ¸²æŸ“`);
		}
		
		// ğŸ” å®šæœŸéªŒè¯registerTimeå­—æ®µä¸€è‡´æ€§
		if (consistencyValidator) {
			consistencyValidator.validateRegisterTimeConsistency();
		}
	}
	
	// é¡µé¢å¸è½½æ—¶æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
	window.addEventListener('beforeunload', () => {
		timerManager.clearAllTimers();
		
		// æ¸…ç†å…¶ä»–å¯èƒ½çš„å®šæ—¶å™¨
		if (window.__heartbeatInterval) clearInterval(window.__heartbeatInterval);
		if (window.__periodicStateCheckInterval) clearInterval(window.__periodicStateCheckInterval);
		if (window.__operationTimeoutInterval) clearInterval(window.__operationTimeoutInterval);
		if (window.__roomsRealtimeReconnectTimer) clearTimeout(window.__roomsRealtimeReconnectTimer);
		if (window.__studentsRealtimeReconnectTimer) clearTimeout(window.__studentsRealtimeReconnectTimer);
		
		// æ¸…ç†realtimeè¿æ¥
		if (realtimeChannel) {
			try { supabaseClient?.removeChannel(realtimeChannel); } catch(e) {}
		}
		if (window.studentRealtimeChannel) {
			try { supabaseClient?.removeChannel(window.studentRealtimeChannel); } catch(e) {}
		}
	});

	// Realtimeè¿æ¥ç›‘æ§å’Œè‡ªåŠ¨ä¿®å¤
	class RealtimeMonitor {
		constructor() {
			this.lastActivity = Date.now();
			this.healthCheckInterval = null;
			this.connectionIssues = 0;
			this.maxConnectionIssues = 3;
			this.isReconnecting = false;
			this.lastReconnectAttempt = 0;
			this.reconnectCooldown = 10000; // 10ç§’å†·å´æ—¶é—´
			this.pageHidden = false;
			this.pageHiddenTime = null;
			this.backgroundTimeoutId = null;
			this.closedEvents = []; // è®°å½• CLOSED äº‹ä»¶çš„æ—¶é—´
			this.maxClosedEvents = 3; // 5åˆ†é’Ÿå†…æœ€å¤šå…è®¸3æ¬¡ CLOSED
			this.closedEventWindow = 300000; // 5åˆ†é’Ÿæ—¶é—´çª—å£
			this.silentMode = false; // é™é»˜æ¨¡å¼æ ‡è®°
			this.originalLogFunctions = null; // åŸå§‹æ—¥å¿—å‡½æ•°çš„å¤‡ä»½
			
			// ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
			this.initVisibilityHandling();
		}
		
		start() {
			if (this.healthCheckInterval) return;
			
			this.healthCheckInterval = timerManager.setInterval('realtimeHealth', () => {
				this.checkHealth();
			}, 300000); // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¿æ¥å¥åº·çŠ¶æ€
		}
		
		recordActivity() {
			this.lastActivity = Date.now();
			window.__lastRealtimeActivity = this.lastActivity; // æš´éœ²ç»™å…¨å±€ä½¿ç”¨
			this.connectionIssues = 0; // é‡ç½®è¿æ¥é—®é¢˜è®¡æ•°
		}
		
		checkHealth() {
			// é¡µé¢éšè—æ—¶æš‚åœå¥åº·æ£€æŸ¥
			if (this.pageHidden) {
				return;
			}
			
			const now = Date.now();
			const timeSinceActivity = now - this.lastActivity;
			const timeSinceVisibilityChange = window.__lastVisibilityChange ? now - window.__lastVisibilityChange : 0;
			
			// å¦‚æœåˆšä»åå°åˆ‡æ¢å›æ¥ä¸ä¹…ï¼Œç»™è¿æ¥ä¸€äº›æ¢å¤æ—¶é—´
			if (timeSinceVisibilityChange < 30000) { // 30ç§’å†…
				logInfo(`é¡µé¢åˆšåˆ‡æ¢å›å‰å° (${Math.round(timeSinceVisibilityChange/1000)}ç§’å‰)ï¼Œè·³è¿‡å¥åº·æ£€æŸ¥`);
				return;
			}
			
			// åœ¨å¢å¼ºæ¨¡å¼ä¸‹ä½¿ç”¨æ›´çŸ­çš„è¶…æ—¶æ—¶é—´ï¼Œæ™®é€šæ¨¡å¼ä¸‹ä½¿ç”¨æ›´é•¿çš„è¶…æ—¶æ—¶é—´
			const timeoutThreshold = syncEnhancer.isInEnhancedMode() ? 300000 : 600000; // 5åˆ†é’Ÿ vs 10åˆ†é’Ÿ
			
			if (timeSinceActivity > timeoutThreshold) {
				// æ£€æŸ¥æ˜¯å¦å·²åœ¨é‡è¿ä¸­
				if (this.isReconnecting) {
					logInfo(`Realtimeå¥åº·æ£€æŸ¥ï¼šé‡è¿è¿›è¡Œä¸­ (${Math.round(timeSinceActivity/60000)}åˆ†é’Ÿæ— æ´»åŠ¨)`);
					return;
				}
				
				// æ£€æŸ¥æ˜¯å¦å·²æœ‰é‡è¿åœ¨è¿›è¡Œä¸­ï¼Œé¿å…é‡å¤è§¦å‘
				if (window.__roomsRealtimeReconnectTimer || window.__studentsRealtimeReconnectTimer) {
					logInfo(`Realtimeå¥åº·æ£€æŸ¥ï¼šé‡è¿è®¡æ—¶å™¨å·²è¿è¡Œ (${Math.round(timeSinceActivity/60000)}åˆ†é’Ÿæ— æ´»åŠ¨)`);
					return;
				}
				
				// å…ˆè¿›è¡Œè¿æ¥çŠ¶æ€æ£€æŸ¥
				const connectionHealthy = this.performConnectionStateCheck();
				if (connectionHealthy) {
					logInfo('è¿æ¥çŠ¶æ€æ£€æŸ¥é€šè¿‡ï¼Œé‡ç½®å¥åº·æ£€æŸ¥');
					this.recordActivity();
					return;
				}
				
				this.connectionIssues++;
				const minutes = Math.round(timeSinceActivity/60000);
				logWarn(`Realtimeè¿æ¥å¥åº·æ£€æŸ¥å¤±è´¥ #${this.connectionIssues}: ${minutes}åˆ†é’Ÿæ— æ´»åŠ¨`);
				
				// åœ¨å¢å¼ºæ¨¡å¼ä¸‹æ›´å¿«è§¦å‘é‡è¿ï¼Œä½†å¢åŠ æ›´å¤šæ£€æŸ¥
				const maxIssues = syncEnhancer.isInEnhancedMode() ? 2 : this.maxConnectionIssues;
				if (this.connectionIssues >= maxIssues) {
					logWarn('Realtimeè¿æ¥ç–‘ä¼¼æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥');
					this.forceReconnectWithCooldown();
				}
			} else {
				// è¿æ¥æ­£å¸¸ï¼Œé‡ç½®é—®é¢˜è®¡æ•°
				if (this.connectionIssues > 0) {
					logInfo(`Realtimeè¿æ¥æ¢å¤æ­£å¸¸ï¼Œé‡ç½®é—®é¢˜è®¡æ•° (ä¹‹å‰${this.connectionIssues}æ¬¡)`);
					this.connectionIssues = 0;
				}
			}
		}
		
		async forceReconnectWithCooldown() {
			const now = Date.now();
			
			// æ£€æŸ¥å†·å´æ—¶é—´
			if (now - this.lastReconnectAttempt < this.reconnectCooldown) {
				logInfo(`Realtimeé‡è¿å†·å´ä¸­ï¼Œå‰©ä½™${Math.round((this.reconnectCooldown - (now - this.lastReconnectAttempt))/1000)}ç§’`);
				return;
			}
			
			// æ£€æŸ¥æ˜¯å¦å·²åœ¨é‡è¿ä¸­
			if (this.isReconnecting) {
				logInfo('Realtimeé‡è¿å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡');
				return;
			}
			
			this.lastReconnectAttempt = now;
			await this.forceReconnect();
		}

		async forceReconnect() {
			if (this.isReconnecting) {
				logInfo('Realtimeé‡è¿å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤æ“ä½œ');
				return;
			}
			
			this.isReconnecting = true;
			
			try {
				logInfo('å¼€å§‹Realtimeå¼ºåˆ¶é‡è¿...');
				
				// é‡ç½®è¿æ¥çŠ¶æ€
				window.__roomsRealtimeInit = false;
				window.__roomsRealtimeReconnecting = false;
				window.__roomsRealtimeAttempts = 0;
				window.__studentsRealtimeAttempts = 0;
				
				// æ¸…ç†ç°æœ‰è¿æ¥
				if (realtimeChannel) {
					try { 
						logInfo('æ¸…ç†ç°æœ‰æˆ¿é—´å®æ—¶è¿æ¥');
						supabaseClient?.removeChannel(realtimeChannel); 
						realtimeChannel = null;
					} catch(e) {
						logWarn('æ¸…ç†æˆ¿é—´è¿æ¥å¤±è´¥:', e.message);
					}
				}
				if (window.studentRealtimeChannel) {
					try { 
						logInfo('æ¸…ç†ç°æœ‰å­¦ç”Ÿå®æ—¶è¿æ¥');
						supabaseClient?.removeChannel(window.studentRealtimeChannel); 
						window.studentRealtimeChannel = null;
					} catch(e) {
						logWarn('æ¸…ç†å­¦ç”Ÿè¿æ¥å¤±è´¥:', e.message);
					}
				}
				
				// ç­‰å¾…ä¸€æ®µæ—¶é—´è®©è¿æ¥å®Œå…¨æ¸…ç†
				await new Promise(resolve => setTimeout(resolve, 2000));
				
				// é‡æ–°å»ºç«‹è¿æ¥
				await setupRealtime();
				
				this.connectionIssues = 0;
				this.recordActivity();
				
				logInfo('Realtimeè¿æ¥é‡æ–°å»ºç«‹æˆåŠŸ');
				toast('å®æ—¶è¿æ¥å·²æ¢å¤', 'success');
				
			} catch (error) {
				logErr('å¼ºåˆ¶é‡è¿å¤±è´¥:', error.message);
				toast('å®æ—¶è¿æ¥æ¢å¤å¤±è´¥', 'error');
				
				// é‡è¿å¤±è´¥åï¼Œå»¶è¿Ÿå†æ¬¡å°è¯•
				setTimeout(() => {
					if (!this.pageHidden) {
						this.forceReconnectWithCooldown();
					}
				}, 30000); // 30ç§’åå†æ¬¡å°è¯•
				
			} finally {
				this.isReconnecting = false;
			}
		}
		
		initVisibilityHandling() {
			// ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
			document.addEventListener('visibilitychange', () => {
				window.__lastVisibilityChange = Date.now();
				
				if (document.hidden) {
					this.pageHidden = true;
					this.pageHiddenTime = Date.now();
					
					// ğŸ”‡ è¿›å…¥é™é»˜æ¨¡å¼ï¼Œå‡å°‘åå°æ—¥å¿—
					this.enterSilentMode();
					
					logInfo('é¡µé¢åˆ‡æ¢åˆ°åå°ï¼Œè¿›å…¥é™é»˜æ¨¡å¼');
					
					// æ¸…ç†é‡è¿è®¡æ—¶å™¨ï¼Œé¿å…åå°é‡è¿
					this.clearReconnectTimers();
					
					// è®¾ç½®åå°è¶…æ—¶æ£€æŸ¥
					this.backgroundTimeoutId = setTimeout(() => {
						if (this.pageHidden) {
							console.debug('é¡µé¢åå°æ—¶é—´è¿‡é•¿ï¼Œä¸»åŠ¨æ–­å¼€è¿æ¥ä»¥èŠ‚çœèµ„æº');
							this.cleanupConnectionsForBackground();
						}
					}, 900000); // 15åˆ†é’Ÿåä¸»åŠ¨æ¸…ç†è¿æ¥ï¼ˆå»¶é•¿æ—¶é—´ï¼‰
					
				} else {
					// ğŸ”Š é€€å‡ºé™é»˜æ¨¡å¼ï¼Œæ¢å¤æ­£å¸¸æ—¥å¿—
					this.exitSilentMode();
					
					this.pageHidden = false;
					const hiddenDuration = Date.now() - (this.pageHiddenTime || Date.now());
					
					// åªæœ‰é•¿æ—¶é—´åå°æ‰è®°å½•æ—¥å¿—
					if (hiddenDuration > 300000) { // è¶…è¿‡5åˆ†é’Ÿæ‰è®°å½•
						logInfo(`é¡µé¢åˆ‡æ¢åˆ°å‰å°ï¼Œåå°æ—¶é•¿: ${Math.round(hiddenDuration/60000)}åˆ†é’Ÿ`);
					}
					
					// æ¸…ç†åå°è¶…æ—¶æ£€æŸ¥
					if (this.backgroundTimeoutId) {
						clearTimeout(this.backgroundTimeoutId);
						this.backgroundTimeoutId = null;
					}
					
					// é¡µé¢å›åˆ°å‰å°æ—¶ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€
					setTimeout(() => {
						this.handlePageVisible(hiddenDuration);
					}, 3000); // å»¶è¿Ÿ3ç§’ï¼Œç­‰å¾…è¿æ¥ç¨³å®š
				}
			});
		}
		
		handlePageVisible(hiddenDuration = 0) {
			const now = Date.now();
			const timeSinceActivity = now - this.lastActivity;
			
			// ğŸ”§ é¡µé¢åˆ‡æ¢å›å‰å°æˆ–åˆ·æ–°åï¼Œä¸»åŠ¨æ£€æŸ¥å¹¶æ¢å¤è¿æ¥
			setTimeout(() => {
				if (supabaseReady && (!supabaseClient || !realtimeChannel)) {
					logWarn('[PageVisible] æ£€æµ‹åˆ°è¿æ¥ä¸¢å¤±ï¼Œå°è¯•é‡æ–°å»ºç«‹...');
					
					// é‡æ–°åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
					if (!supabaseClient) {
						initSupabase().then(() => {
							if (supabaseReady) {
								// é‡æ–°å»ºç«‹ Realtime è¿æ¥
								window.__roomsRealtimeInit = false;
								setupRealtime();
							}
						}).catch(err => {
							logErr('[PageVisible] Supabase é‡æ–°åˆå§‹åŒ–å¤±è´¥:', err.message);
						});
					} 
					// å¦‚æœå®¢æˆ·ç«¯å­˜åœ¨ä½† Realtime è¿æ¥ä¸¢å¤±
					else if (!realtimeChannel) {
						window.__roomsRealtimeInit = false;
						setupRealtime();
					}
				}
				// æ£€æŸ¥ Realtime è¿æ¥çŠ¶æ€
				else if (realtimeChannel) {
					const channelState = realtimeChannel.state;
					if (channelState === 'closed' || channelState === 'errored') {
						logWarn(`[PageVisible] Realtime è¿æ¥çŠ¶æ€å¼‚å¸¸ (${channelState})ï¼Œé‡æ–°è¿æ¥...`);
						window.__roomsRealtimeInit = false;
						window.__roomsRealtimeReconnecting = true;
						setupRealtime();
					}
				}
			}, 2000); // å»¶è¿Ÿ2ç§’ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
			
			// ğŸ”§ é¡µé¢åˆ‡æ¢å›å‰å°æ—¶è¿›è¡Œæ•°æ®ä¸€è‡´æ€§éªŒè¯ï¼ˆä»…åœ¨é•¿æ—¶é—´åå°ä¸”æœ‰å¿…è¦æ—¶ï¼‰
			if (hiddenDuration > 300000 && DataConsistencyValidator) { // åå°è¶…è¿‡5åˆ†é’Ÿæ‰éªŒè¯
				// æ£€æŸ¥æ˜¯å¦éœ€è¦éªŒè¯ï¼ˆé¿å…é¢‘ç¹éªŒè¯ï¼‰
				const lastValidation = window.__lastConsistencyCheck || 0;
				const timeSinceLastCheck = Date.now() - lastValidation;
				
				if (timeSinceLastCheck > 300000) { // è·ç¦»ä¸Šæ¬¡éªŒè¯è¶…è¿‡5åˆ†é’Ÿ
					setTimeout(async () => {
						try {
							logInfo(`[PageVisible] é¡µé¢åå° ${Math.round(hiddenDuration/60000)} åˆ†é’Ÿï¼Œè¿›è¡Œæ•°æ®ä¸€è‡´æ€§éªŒè¯`);
							const validation = await DataConsistencyValidator.validateOnPageLoad();
							if (validation.issues > 0) {
								logWarn(`[PageVisible] å‘ç° ${validation.issues} ä¸ªæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå·²è‡ªåŠ¨ä¿®å¤`);
								toast(`é¡µé¢æ¢å¤æ—¶ä¿®å¤äº† ${validation.issues} ä¸ªæ•°æ®é—®é¢˜`, 'warn');
							}
							// è®°å½•éªŒè¯æ—¶é—´
							window.__lastConsistencyCheck = Date.now();
						} catch (error) {
							logErr('[PageVisible] æ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥:', error.message);
						}
					}, 8000); // å»¶è¿Ÿ8ç§’æ‰§è¡Œï¼Œé¿å…ä¸è¿æ¥é‡å»ºå†²çª
				}
			}
			
			// æ ¹æ®åå°æ—¶é•¿å†³å®šé‡è¿ç­–ç•¥
			if (hiddenDuration > 600000) { // è¶…è¿‡10åˆ†é’Ÿ
				logInfo(`é¡µé¢åå°è¶…è¿‡10åˆ†é’Ÿ (${Math.round(hiddenDuration/60000)}åˆ†é’Ÿ)ï¼Œå¼ºåˆ¶é‡å»ºè¿æ¥`);
				this.forceFullReconnect();
			} else if (hiddenDuration > 300000 || timeSinceActivity > 300000) { // è¶…è¿‡5åˆ†é’Ÿ
				logInfo(`é¡µé¢åˆ‡æ¢å›å‰å°ï¼Œæ£€æµ‹åˆ°${Math.round(Math.max(hiddenDuration, timeSinceActivity)/60000)}åˆ†é’Ÿæ— æ´»åŠ¨ï¼Œä¸»åŠ¨é‡è¿`);
				this.forceReconnectWithCooldown();
			} else {
				// æ£€æŸ¥è¿æ¥å¥åº·çŠ¶æ€
				this.checkConnectionHealth();
				// é‡ç½®æ´»åŠ¨æ—¶é—´ï¼Œé¿å…è¯¯æŠ¥
				this.recordActivity();
			}
			
			// åŒæ­¥æœ€æ–°æ•°æ®çŠ¶æ€ï¼ˆåœ¨è¿æ¥é‡å»ºåè¿›è¡Œï¼‰
			setTimeout(() => {
				this.syncDataAfterReturn(hiddenDuration);
			}, 3000); // ç­‰å¾…è¿æ¥ç¨³å®šåå†åŒæ­¥æ•°æ®
		}
		
		clearReconnectTimers() {
			// æ¸…ç†æˆ¿é—´é‡è¿è®¡æ—¶å™¨
			if (window.__roomsRealtimeReconnectTimer) {
				clearTimeout(window.__roomsRealtimeReconnectTimer);
				window.__roomsRealtimeReconnectTimer = null;
				logInfo('å·²æ¸…ç†æˆ¿é—´é‡è¿è®¡æ—¶å™¨');
			}
			
			// æ¸…ç†å­¦ç”Ÿé‡è¿è®¡æ—¶å™¨
			if (window.__studentsRealtimeReconnectTimer) {
				clearTimeout(window.__studentsRealtimeReconnectTimer);
				window.__studentsRealtimeReconnectTimer = null;
				logInfo('å·²æ¸…ç†å­¦ç”Ÿé‡è¿è®¡æ—¶å™¨');
			}
		}
		
		cleanupConnectionsForBackground() {
			logInfo('æ‰§è¡Œåå°è¿æ¥æ¸…ç†...');
			
			try {
				// ä¼˜é›…åœ°å…³é—­ç°æœ‰è¿æ¥
				if (window.supabase && window.supabase.realtime) {
					window.supabase.realtime.disconnect();
					logInfo('å·²æ–­å¼€Supabase Realtimeè¿æ¥');
				}
				
				// é‡ç½®è¿æ¥çŠ¶æ€æ ‡å¿—
				window.__roomsRealtimeInit = false;
				window.__studentsRealtimeInit = false;
				window.__roomsRealtimeReconnecting = false;
				window.__studentsRealtimeReconnecting = false;
				
				// æ¸…ç†æ‰€æœ‰é‡è¿è®¡æ—¶å™¨
				this.clearReconnectTimers();
				
			} catch (error) {
				logErr('åå°è¿æ¥æ¸…ç†å¤±è´¥:', error.message);
			}
		}
		
		async forceFullReconnect() {
			logInfo('æ‰§è¡Œå®Œæ•´è¿æ¥é‡å»º...');
			
			try {
				// å…ˆæ¸…ç†ç°æœ‰è¿æ¥
				this.cleanupConnectionsForBackground();
				
				// ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æ¸…ç†å®Œæˆ
				await new Promise(resolve => setTimeout(resolve, 3000));
				
				// é‡æ–°åˆå§‹åŒ–è¿æ¥
				await this.initializeConnections();
				
				logInfo('å®Œæ•´è¿æ¥é‡å»ºå®Œæˆ');
				toast('å®æ—¶è¿æ¥å·²é‡æ–°å»ºç«‹', 'success');
				
			} catch (error) {
				logErr('å®Œæ•´è¿æ¥é‡å»ºå¤±è´¥:', error.message);
				toast('è¿æ¥é‡å»ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
			}
		}
		
		async initializeConnections() {
			try {
				// é‡ç½®è¿æ¥ç®¡ç†å™¨çŠ¶æ€
				if (window.ConnectionManager && window.ConnectionManager.resetAllConnections) {
					window.ConnectionManager.resetAllConnections(true);
				}
				
				// ç­‰å¾…çŠ¶æ€é‡ç½®å®Œæˆ
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// é‡æ–°åˆå§‹åŒ–æˆ¿é—´è¿æ¥
				if (window.initRoomsRealtimeUpdates && typeof window.initRoomsRealtimeUpdates === 'function') {
					logInfo('é‡æ–°åˆå§‹åŒ–æˆ¿é—´è¿æ¥...');
					await window.initRoomsRealtimeUpdates();
				}
				
				// é‡æ–°åˆå§‹åŒ–å­¦ç”Ÿè¿æ¥
				if (window.initStudentsRealtimeUpdates && typeof window.initStudentsRealtimeUpdates === 'function') {
					logInfo('é‡æ–°åˆå§‹åŒ–å­¦ç”Ÿè¿æ¥...');
					await window.initStudentsRealtimeUpdates();
				}
				
				// é‡æ–°åˆå§‹åŒ–ç»ƒä¹ æé†’è¿æ¥
				if (window.PracticeAlerts && window.PracticeAlerts.init) {
					logInfo('é‡æ–°åˆå§‹åŒ–ç»ƒä¹ æé†’è¿æ¥...');
					window.PracticeAlerts.init();
				}
				
				// é‡ç½®æ´»åŠ¨æ—¶é—´
				this.recordActivity();
				
				logInfo('æ‰€æœ‰è¿æ¥é‡æ–°åˆå§‹åŒ–å®Œæˆ');
				
			} catch (error) {
				logErr('è¿æ¥åˆå§‹åŒ–å¤±è´¥:', error.message);
				throw error;
			}
		}
		
		checkConnectionHealth() {
			// æ£€æŸ¥Supabaseè¿æ¥çŠ¶æ€
			if (window.supabase && window.supabase.realtime) {
				const state = window.supabase.realtime.connection?.readyState;
				logInfo(`è¿æ¥å¥åº·æ£€æŸ¥ - çŠ¶æ€: ${this.getConnectionState(state)}`);
				
				// å¦‚æœè¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡è¿
				if (state === 3) { // CLOSED
					logWarn('æ£€æµ‹åˆ°è¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡è¿');
					this.forceReconnectWithCooldown();
				}
			}
		}
		
		getConnectionState(state) {
			const states = {
				0: 'CONNECTING',
				1: 'OPEN', 
				2: 'CLOSING',
				3: 'CLOSED'
			};
			return states[state] || 'UNKNOWN';
		}
		
		performConnectionStateCheck() {
			try {
				// æ£€æŸ¥ Supabase å®¢æˆ·ç«¯çŠ¶æ€
				if (window.supabase && window.supabase.realtime) {
					const connection = window.supabase.realtime.connection;
					if (connection) {
						const state = connection.readyState;
						const stateStr = this.getConnectionState(state);
						logInfo(`Supabaseè¿æ¥çŠ¶æ€: ${stateStr} (${state})`);
						
						// å¦‚æœè¿æ¥å·²æ–­å¼€ï¼Œè¿”å›ä¸å¥åº·
						if (state === 3) { // CLOSED
							return false;
						}
						
						// å¦‚æœè¿æ¥æ­£å¸¸ï¼Œæ£€æŸ¥é€šé“çŠ¶æ€
						if (state === 1) { // OPEN
							let channelsHealthy = true;
							
							// æ£€æŸ¥æˆ¿é—´é€šé“
							if (window.supabase.realtime.channels) {
								const channels = window.supabase.realtime.channels;
								logInfo(`æ£€æŸ¥åˆ° ${channels.length} ä¸ªæ´»è·ƒé€šé“`);
								
								channels.forEach((channel, index) => {
									const channelState = channel.state;
									logInfo(`é€šé“ ${index + 1} çŠ¶æ€: ${channelState}`);
									
									if (channelState === 'errored' || channelState === 'closed') {
										channelsHealthy = false;
									}
								});
							}
							
							return channelsHealthy;
						}
					}
				}
				
				// é¢å¤–æ£€æŸ¥ï¼šéªŒè¯æ•°æ®æ›´æ–°æ˜¯å¦æ­£å¸¸
				const lastDataUpdate = window.__lastRealtimeDataUpdate || 0;
				const timeSinceUpdate = Date.now() - lastDataUpdate;
				
				if (lastDataUpdate > 0 && timeSinceUpdate < 600000) { // 10åˆ†é’Ÿå†…æœ‰æ•°æ®æ›´æ–°
					logInfo(`æœ€è¿‘æ•°æ®æ›´æ–°: ${Math.round(timeSinceUpdate/60000)}åˆ†é’Ÿå‰ï¼Œè¿æ¥å¥åº·`);
					return true;
				}
				
				logWarn('è¿æ¥çŠ¶æ€æ£€æŸ¥ï¼šæ— æ³•ç¡®è®¤è¿æ¥å¥åº·çŠ¶æ€');
				return false;
				
			} catch (error) {
				logErr('è¿æ¥çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error.message);
				return false;
			}
		}
		
		async syncDataAfterReturn(hiddenDuration) {
			try {
				logInfo(`é¡µé¢è¿”å›åå¼€å§‹æ•°æ®åŒæ­¥ï¼Œåå°æ—¶é•¿: ${Math.round(hiddenDuration/60000)}åˆ†é’Ÿ`);
				
				// è®°å½•åŒæ­¥å¼€å§‹æ—¶é—´
				const syncStartTime = Date.now();
				
				// ğŸ”§ ä¿®å¤åŒæ­¥é¡ºåºï¼šå…ˆè·å–æƒå¨æ•°æ®æºï¼Œå†å¤„ç†æœ¬åœ°ç¼“å­˜
				logInfo('ç¬¬ä¸€æ­¥ï¼šè·å–æœåŠ¡å™¨æƒå¨æ•°æ®...');
				
				// æ ¹æ®åå°æ—¶é•¿é€‰æ‹©åŒæ­¥ç­–ç•¥
				if (hiddenDuration > 300000) { // è¶…è¿‡5åˆ†é’Ÿï¼Œè¿›è¡Œå…¨é‡åŒæ­¥
					await this.performFullDataSync();
				} else { // å°‘äº5åˆ†é’Ÿï¼Œè¿›è¡Œå¢é‡åŒæ­¥
					await this.performIncrementalSync(this.pageHiddenTime);
				}
				
				logInfo('ç¬¬äºŒæ­¥ï¼šåŸºäºæœ€æ–°æ•°æ®éªŒè¯å¹¶æ¢å¤è®¡æ—¶å™¨çŠ¶æ€...');
				// ğŸ”§ å…³é”®ä¿®å¤ï¼šåœ¨è·å–æœ€æ–°æœåŠ¡å™¨æ•°æ®åå†å¤„ç†ç¼“å­˜æ¢å¤
				await this.validateAndRestoreTimerStates();
				
				// ğŸ”§ ç§»é™¤æ—§çš„åŒæ­¥é€»è¾‘ï¼Œé¿å…å°†æœªéªŒè¯çš„ç¼“å­˜æ¨é€åˆ°æœåŠ¡å™¨
				// await this.syncTimerStates(); // å·²ç§»é™¤
				
				// åˆ·æ–°UIæ˜¾ç¤º
				this.refreshUIAfterSync();
				
				const syncDuration = Date.now() - syncStartTime;
				logInfo(`æ•°æ®åŒæ­¥å®Œæˆï¼Œè€—æ—¶: ${syncDuration}ms`);
				
				// æ˜¾ç¤ºåŒæ­¥å®Œæˆçš„é€šçŸ¥ï¼ˆä»…åœ¨åå°æ—¶é—´è¾ƒé•¿æ—¶æ˜¾ç¤ºï¼‰
				if (hiddenDuration > 60000) { // è¶…è¿‡1åˆ†é’Ÿæ‰æ˜¾ç¤ºé€šçŸ¥
					const minutes = Math.round(hiddenDuration / 60000);
					toast(`æ•°æ®å·²åŒæ­¥å®Œæˆ (åå°${minutes}åˆ†é’Ÿ)`, 'success');
				}
				
				// æ‰§è¡ŒçŠ¶æ€éªŒè¯æ£€æŸ¥
				setTimeout(() => {
					this.validateSyncedRoomStates();
				}, 1000); // ç­‰å¾…UIæ›´æ–°å®Œæˆåæ£€æŸ¥
				
			} catch (error) {
				logErr('é¡µé¢è¿”å›åæ•°æ®åŒæ­¥å¤±è´¥:', error.message);
			}
		}
		

		
		async performFullDataSync() {
			logInfo('æ‰§è¡Œå…¨é‡æ•°æ®åŒæ­¥...');
			
			try {
				// ğŸ”„ æ•°æ®ä¸€è‡´æ€§å¢å¼ºï¼šç¡®ä¿è·å–æœ€æ–°æ•°æ®
				logInfo('æ­£åœ¨ä»æ•°æ®åº“è·å–æœ€æ–°æˆ¿é—´çŠ¶æ€...');
				
				// åŒæ­¥æˆ¿é—´æ•°æ®
				if (window.fetchRooms && typeof window.fetchRooms === 'function') {
					const rooms = await window.fetchRooms();
					if (rooms && rooms.length > 0) {
						// è®°å½•åŒæ­¥å‰çš„æˆ¿é—´çŠ¶æ€
						const beforeSync = {};
						if (window.Store && window.Store.rooms) {
							window.Store.rooms.forEach(room => {
								if (room.occupant_student_name) {
									beforeSync[room.name] = {
										student: room.occupant_student_name,
										registerTime: room.registerTime,
										timeStr: room.registerTime ? new Date(room.registerTime).toLocaleString() : 'null'
									};
								}
							});
						}
						
						// ğŸ” æ£€æŸ¥æ˜¯å¦å­˜åœ¨"å¹½çµå ç”¨"ï¼ˆæ•°æ®åº“å·²æ¸…ç©ºä½†ä»æ˜¾ç¤ºå ç”¨çš„æˆ¿é—´ï¼‰
						const dbOccupiedRooms = rooms.filter(r => r.occupant_student_name && r.occupant_student_name.trim() !== '');
						logInfo(`æ•°æ®åº“ä¸­å®é™…å ç”¨æˆ¿é—´æ•°: ${dbOccupiedRooms.length}`);
						
						if (dbOccupiedRooms.length > 0) {
							logInfo('æ•°æ®åº“ä¸­å ç”¨çš„æˆ¿é—´:', dbOccupiedRooms.map(r => `${r.name}:${r.occupant_student_name}`));
						}
						
						// æ›´æ–°æˆ¿é—´æ•°æ®åˆ°Store
						if (window.Store && window.Store.rooms) {
							window.Store.rooms = rooms;
							
							// é‡å»ºç´¢å¼•ä»¥ç¡®ä¿ byName æ˜ å°„æ­£ç¡®
							if (window.rebuildIndexes && typeof window.rebuildIndexes === 'function') {
								window.rebuildIndexes();
								logInfo('å·²é‡å»ºæˆ¿é—´ç´¢å¼•');
							}
							
							// è®°å½•åŒæ­¥åçš„æˆ¿é—´çŠ¶æ€å¹¶å¯¹æ¯”
							const afterSync = {};
							rooms.forEach(room => {
								if (room.occupant_student_name) {
									afterSync[room.name] = {
										student: room.occupant_student_name,
										registerTime: room.registerTime,
										timeStr: room.registerTime ? new Date(room.registerTime).toLocaleString() : 'null'
									};
								}
							});
							
							// è¯¦ç»†å¯¹æ¯”æ—¥å¿—
							logInfo(`æˆ¿é—´æ•°æ®åŒæ­¥å¯¹æ¯”:`);
							Object.keys(afterSync).forEach(roomName => {
								const before = beforeSync[roomName];
								const after = afterSync[roomName];
								
								if (!before) {
									logInfo(`  æ–°å ç”¨: ${roomName} -> ${after.student} @ ${after.timeStr}`);
								} else if (before.registerTime !== after.registerTime) {
									logInfo(`  æ—¶é—´å˜æ›´: ${roomName} -> ${after.student}`);
									logInfo(`    åŸæ—¶é—´: ${before.timeStr}`);
									logInfo(`    æ–°æ—¶é—´: ${after.timeStr}`);
								}
							});
							
							logInfo(`å·²åŒæ­¥ ${rooms.length} ä¸ªæˆ¿é—´æ•°æ®ï¼Œå…¶ä¸­å ç”¨ ${Object.keys(afterSync).length} ä¸ª`);
						}
					}
				}
				
				// åŒæ­¥å­¦ç”Ÿæ•°æ®  
				if (window.fetchStudents && typeof window.fetchStudents === 'function') {
					await window.fetchStudents({ forceFullSync: true });
					logInfo('å·²æ‰§è¡Œå­¦ç”Ÿæ•°æ®å…¨é‡åŒæ­¥');
				}
				
				// åŒæ­¥ç»ƒä¹ æé†’æ•°æ®
				if (window.PracticeAlerts && window.PracticeAlerts.refreshFromCloud) {
					await window.PracticeAlerts.refreshFromCloud();
					logInfo('å·²åŒæ­¥ç»ƒä¹ æé†’æ•°æ®');
				}
				
			} catch (error) {
				logErr('å…¨é‡æ•°æ®åŒæ­¥å¤±è´¥:', error.message);
				throw error;
			}
		}
		
		async performIncrementalSync(since) {
			logInfo('æ‰§è¡Œå¢é‡æ•°æ®åŒæ­¥...');
			
			try {
				// å¢é‡åŒæ­¥å­¦ç”Ÿæ•°æ®
				if (window.fetchStudents && typeof window.fetchStudents === 'function' && since) {
					const sinceTime = new Date(since).toISOString();
					await window.fetchStudents({ 
						incremental: true, 
						since: sinceTime 
					});
					logInfo(`å·²æ‰§è¡Œå­¦ç”Ÿæ•°æ®å¢é‡åŒæ­¥ï¼Œä» ${sinceTime} å¼€å§‹`);
				}
				
				// æˆ¿é—´æ•°æ®ç›¸å¯¹è¾ƒå°‘ï¼Œç›´æ¥å…¨é‡åŒæ­¥
				if (window.fetchRooms && typeof window.fetchRooms === 'function') {
					const rooms = await window.fetchRooms();
					if (rooms && rooms.length > 0) {
						if (window.Store && window.Store.rooms) {
							// è®°å½•å ç”¨æˆ¿é—´çš„æ—¶é—´ä¿¡æ¯
							const occupiedRooms = rooms.filter(r => r.occupant_student_name);
							occupiedRooms.forEach(room => {
								logInfo(`å¢é‡åŒæ­¥æˆ¿é—´: ${room.name} -> ${room.occupant_student_name}`);
								if (room.registerTime) {
									const timeStr = new Date(room.registerTime).toLocaleString();
									logInfo(`  registerTime: ${room.registerTime} (${timeStr})`);
								} else {
									logInfo(`  registerTime: null`);
								}
							});
							
							window.Store.rooms = rooms;
							
							// é‡å»ºç´¢å¼•ä»¥ç¡®ä¿ byName æ˜ å°„æ­£ç¡®
							if (window.rebuildIndexes && typeof window.rebuildIndexes === 'function') {
								window.rebuildIndexes();
								logInfo('å·²é‡å»ºæˆ¿é—´ç´¢å¼•');
							}
							
							logInfo(`å·²åŒæ­¥ ${rooms.length} ä¸ªæˆ¿é—´æ•°æ®ï¼Œå…¶ä¸­å ç”¨ ${occupiedRooms.length} ä¸ª`);
						}
					}
				}
				
			} catch (error) {
				logErr('å¢é‡æ•°æ®åŒæ­¥å¤±è´¥:', error.message);
				// å¢é‡åŒæ­¥å¤±è´¥æ—¶ï¼Œå°è¯•å…¨é‡åŒæ­¥
				logInfo('å¢é‡åŒæ­¥å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡åŒæ­¥');
				await this.performFullDataSync();
			}
		}
		
		async syncTimerStates() {
			logInfo('åŒæ­¥è®¡æ—¶å™¨å’Œå‡†å¤‡çŠ¶æ€...');
			
			try {
				// è®¡æ—¶å™¨çŠ¶æ€ç”± renderRooms() ä¸­çš„ statusInfo() å‡½æ•°è‡ªåŠ¨è®¡ç®—
				// è¿™é‡ŒéªŒè¯å¹¶è®°å½•æ‰€æœ‰æˆ¿é—´çš„æ—¶é—´çŠ¶æ€
				
				let occupiedRooms = 0;
				let preparingRooms = 0;
				const roomTimerDetails = [];
				
				if (window.Store && window.Store.rooms) {
					window.Store.rooms.forEach(room => {
						if (room.occupant_student_name) {
							occupiedRooms++;
							
							if (room.registerTime) {
								const now = Date.now();
								const elapsed = Math.floor((now - room.registerTime) / 1000);
								const prepEnd = room.registerTime + 60000; // 60ç§’å‡†å¤‡æœŸ
								const isPrep = now < prepEnd;
								
								if (isPrep) {
									preparingRooms++;
									const remaining = Math.ceil((prepEnd - now) / 1000);
									roomTimerDetails.push(`${room.name}: å‡†å¤‡ä¸­ ${remaining}s (${room.occupant_student_name})`);
								} else {
									const practiceElapsed = Math.floor((now - prepEnd) / 1000);
									roomTimerDetails.push(`${room.name}: ç»ƒä¹ ä¸­ ${Math.floor(practiceElapsed/60)}:${(practiceElapsed%60).toString().padStart(2,'0')} (${room.occupant_student_name})`);
								}
							} else {
								roomTimerDetails.push(`${room.name}: æ— æ—¶é—´è®°å½• (${room.occupant_student_name})`);
							}
						}
					});
				}
				
				logInfo(`è®¡æ—¶å™¨çŠ¶æ€åŒæ­¥å®Œæˆ - å ç”¨æˆ¿é—´: ${occupiedRooms}, å‡†å¤‡ä¸­: ${preparingRooms}`);
				
				// è¯¦ç»†è®°å½•æ¯ä¸ªæˆ¿é—´çš„è®¡æ—¶å™¨çŠ¶æ€
				if (roomTimerDetails.length > 0) {
					logInfo('æˆ¿é—´è®¡æ—¶å™¨è¯¦æƒ…:');
					roomTimerDetails.forEach(detail => logInfo(`  ${detail}`));
				}
				
			} catch (error) {
				logErr('åŒæ­¥è®¡æ—¶å™¨çŠ¶æ€å¤±è´¥:', error.message);
			}
		}
		
		refreshUIAfterSync() {
			try {
				// è®°å½•åŒæ­¥å‰çš„çŠ¶æ€ä»¥ä¾¿æ¯”è¾ƒ
				const beforeSync = {
					totalRooms: window.Store ? window.Store.rooms.length : 0,
					occupiedRooms: window.Store ? window.Store.rooms.filter(r => r.occupant_student_name).length : 0,
					totalStudents: window.Store ? window.Store.students.length : 0
				};
				
				// åˆ·æ–°æˆ¿é—´æ˜¾ç¤º
				if (window.renderRooms && typeof window.renderRooms === 'function') {
					window.renderRooms();
					logInfo('æˆ¿é—´ç•Œé¢å·²åˆ·æ–°');
				}
				
				// åˆ·æ–°å­¦ç”Ÿåº“
				if (window.StudentLibrary && window.StudentLibrary.refresh) {
					window.StudentLibrary.refresh();
					logInfo('å­¦ç”Ÿåº“å·²åˆ·æ–°');
				}
				
				// åˆ·æ–°ç»ƒä¹ æé†’UI
				if (window.PracticeAlerts && window.PracticeAlerts.renderAlerts) {
					window.PracticeAlerts.renderAlerts();
					logInfo('ç»ƒä¹ æé†’ç•Œé¢å·²åˆ·æ–°');
				}
				
				// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
				if (window.updateUsageStats && typeof window.updateUsageStats === 'function') {
					window.updateUsageStats();
					logInfo('ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–°');
				}
				
				// å¼ºåˆ¶é‡å¯å¹¶æ›´æ–°å…¨å±€è®¡æ—¶å™¨
				this.restartGlobalTimer();
				
				// è®°å½•åŒæ­¥åçš„çŠ¶æ€
				const afterSync = {
					totalRooms: window.Store ? window.Store.rooms.length : 0,
					occupiedRooms: window.Store ? window.Store.rooms.filter(r => r.occupant_student_name).length : 0,
					totalStudents: window.Store ? window.Store.students.length : 0
				};
				
				// è¾“å‡ºçŠ¶æ€å¯¹æ¯”
				logInfo(`UIåˆ·æ–°å®Œæˆ - æˆ¿é—´: ${afterSync.totalRooms} (å ç”¨: ${afterSync.occupiedRooms}), å­¦ç”Ÿ: ${afterSync.totalStudents}`);
				
				// å¦‚æœæœ‰æ–°çš„å ç”¨æˆ¿é—´ï¼Œç‰¹åˆ«æ ‡è®°
				if (afterSync.occupiedRooms > beforeSync.occupiedRooms) {
					const newOccupations = afterSync.occupiedRooms - beforeSync.occupiedRooms;
					logInfo(`ğŸ†• æ£€æµ‹åˆ° ${newOccupations} ä¸ªæ–°å ç”¨æˆ¿é—´`);
				}
				
			} catch (error) {
				logErr('UIåˆ·æ–°å¤±è´¥:', error.message);
			}
		}
		
		restartGlobalTimer() {
			try {
				// å¼ºåˆ¶åœæ­¢ç°æœ‰è®¡æ—¶å™¨
				if (window.__globalTimerInterval) {
					clearInterval(window.__globalTimerInterval);
					window.__globalTimerInterval = null;
					logInfo('å·²åœæ­¢æ—§çš„å…¨å±€è®¡æ—¶å™¨');
				}
				
				// ç«‹å³æ‰§è¡Œä¸€æ¬¡è®¡æ—¶å™¨æ›´æ–°ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
				if (window.updateAllRoomTimers && typeof window.updateAllRoomTimers === 'function') {
					window.updateAllRoomTimers();
					logInfo('å·²æ‰§è¡Œå³æ—¶è®¡æ—¶å™¨æ›´æ–°');
				}
				
				// é‡æ–°å¯åŠ¨è®¡æ—¶å™¨
				if (!document.hidden) {
					window.__globalTimerInterval = setInterval(() => {
						if (window.updateAllRoomTimers && typeof window.updateAllRoomTimers === 'function') {
							window.updateAllRoomTimers();
						}
					}, 1000);
					logInfo('ğŸ”„ å…¨å±€è®¡æ—¶å™¨å·²é‡æ–°å¯åŠ¨');
				}
				
		} catch (error) {
			logErr('é‡å¯å…¨å±€è®¡æ—¶å™¨å¤±è´¥:', error.message);
		}
	}
	
	// è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥ç‰¹å®šæˆ¿é—´çš„çŠ¶æ€
	debugRoomStatus(roomName) {
		try {
			const room = window.Store ? window.Store.byName.get(roomName) : null;
			if (!room) {
				logErr(`æˆ¿é—´ ${roomName} ä¸å­˜åœ¨äºStoreä¸­`);
				return;
			}
			
			logInfo(`=== æˆ¿é—´ ${roomName} çŠ¶æ€è°ƒè¯• ===`);
			logInfo(`å ç”¨è€…: ${room.occupant_student_name || 'æ— '}`);
			logInfo(`registerTime: ${room.registerTime || 'æ— '}`);
			
			if (room.registerTime) {
				const timeStr = new Date(room.registerTime).toLocaleString(); 
				logInfo(`æ³¨å†Œæ—¶é—´: ${timeStr}`);
				
				const now = Date.now();
				const elapsed = Math.floor((now - room.registerTime) / 1000);
				const prepEnd = room.registerTime + 60000;
				const inPrep = now < prepEnd;
				
				logInfo(`å½“å‰æ—¶é—´: ${new Date(now).toLocaleString()}`);
				logInfo(`ç»è¿‡æ—¶é—´: ${elapsed}ç§’`);
				logInfo(`æ˜¯å¦åœ¨å‡†å¤‡æœŸ: ${inPrep}`);
				
				if (inPrep) {
					const remaining = Math.ceil((prepEnd - now) / 1000);
					logInfo(`å‰©ä½™å‡†å¤‡æ—¶é—´: ${remaining}ç§’`);
				}
			}
			
			const status = statusInfo(room);
			logInfo(`è®¡ç®—çŠ¶æ€: ${status.state}`);
			logInfo(`æ˜¾ç¤ºæ–‡æœ¬: ${status.chip}`);
			
			// æ£€æŸ¥DOMä¸­çš„æ˜¾ç¤º
			const roomCard = document.querySelector(`[data-room="${CSS.escape(roomName)}"]`);
			if (roomCard) {
				const chip = roomCard.querySelector('.chip');
				const currentStatus = roomCard.dataset.status;
				logInfo(`DOMçŠ¶æ€: ${currentStatus}`);
				logInfo(`DOMæ˜¾ç¤º: ${chip ? chip.textContent : 'æ— chipå…ƒç´ '}`);
			} else {
				logInfo(`DOM: æœªæ‰¾åˆ°æˆ¿é—´å¡ç‰‡`);
			}
			
		} catch (error) {
			logErr(`è°ƒè¯•æˆ¿é—´çŠ¶æ€å¤±è´¥:`, error.message);
		}
	}
	
	// éªŒè¯åŒæ­¥åçš„æˆ¿é—´çŠ¶æ€
	validateSyncedRoomStates() {
		try {
			if (!window.Store || !window.Store.rooms) return;
			
			const occupiedRooms = window.Store.rooms.filter(r => r.occupant_student_name);
			logInfo(`=== åŒæ­¥åçŠ¶æ€éªŒè¯ (${occupiedRooms.length}ä¸ªå ç”¨æˆ¿é—´) ===`);
			
			occupiedRooms.forEach(room => {
				const status = statusInfo(room);
				const roomCard = document.querySelector(`[data-room="${CSS.escape(room.name)}"]`);
				const domStatus = roomCard ? roomCard.dataset.status : 'NOT_FOUND';
				const domChip = roomCard ? roomCard.querySelector('.chip')?.textContent : 'NO_CHIP';
				
				logInfo(`${room.name}: ${room.occupant_student_name}`);
				logInfo(`  è®¡ç®—çŠ¶æ€: ${status.state} -> ${status.chip}`);
				logInfo(`  DOMçŠ¶æ€: ${domStatus} -> ${domChip}`);
				
				if (status.state !== domStatus || status.chip !== domChip) {
					logWarn(`  âš ï¸ çŠ¶æ€ä¸åŒ¹é…ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“`);
					renderRoomCard(room.name);
				}
			});
			
		} catch (error) {
			logErr('çŠ¶æ€éªŒè¯å¤±è´¥:', error.message);
		}
	}		// æ£€æŸ¥æ˜¯å¦é¢‘ç¹å‡ºç° CLOSED äº‹ä»¶
		checkClosedEventFrequency() {
			const now = Date.now();
			
			// æ¸…ç†è¿‡æœŸçš„äº‹ä»¶è®°å½•
			this.closedEvents = this.closedEvents.filter(time => now - time < this.closedEventWindow);
			
			// è®°å½•æ–°çš„ CLOSED äº‹ä»¶
			this.closedEvents.push(now);
			
			// æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
			if (this.closedEvents.length > this.maxClosedEvents) {
				logWarn(`æ£€æµ‹åˆ°é¢‘ç¹çš„ CLOSED äº‹ä»¶ (${this.closedEvents.length}æ¬¡åœ¨${Math.round(this.closedEventWindow/60000)}åˆ†é’Ÿå†…)ï¼Œæš‚åœè‡ªåŠ¨é‡è¿`);
				return true; // éœ€è¦æš‚åœé‡è¿
			}
			
			return false; // å¯ä»¥ç»§ç»­é‡è¿
		}

		stop() {
			if (this.healthCheckInterval) {
				timerManager.clearTimer('realtimeHealth');
				this.healthCheckInterval = null;
			}
			
			// æ¸…ç†åå°è¶…æ—¶æ£€æŸ¥
			if (this.backgroundTimeoutId) {
				clearTimeout(this.backgroundTimeoutId);
				this.backgroundTimeoutId = null;
			}
			
			// æ¸…ç†æ‰€æœ‰é‡è¿è®¡æ—¶å™¨
			this.clearReconnectTimers();
			
			// é€€å‡ºé™é»˜æ¨¡å¼
			this.exitSilentMode();
		}
		
		isActive() {
			return !!this.healthCheckInterval;
		}
		
		// ğŸ”‡ è¿›å…¥é™é»˜æ¨¡å¼ï¼šé¡µé¢åœ¨åå°æ—¶å‡å°‘æ—¥å¿—è¾“å‡º
		enterSilentMode() {
			if (this.silentMode) return;
			
			this.silentMode = true;
			
			// å¤‡ä»½åŸå§‹æ—¥å¿—å‡½æ•°
			if (!this.originalLogFunctions) {
				this.originalLogFunctions = {
					logInfo: window.logInfo,
					logWarn: window.logWarn,
					logErr: window.logErr
				};
			}
			
			// åˆ›å»ºé™é»˜ç‰ˆæœ¬çš„æ—¥å¿—å‡½æ•°
			const createSilentLogger = (level, originalFn) => {
				return (...args) => {
					const message = args.join(' ');
					// åªæœ‰ä¸¥é‡é”™è¯¯æ‰åœ¨åå°è®°å½•
					if (level === 'ERR' || 
					    (level === 'WARN' && (message.includes('é¢‘ç¹') || message.includes('å¤±è´¥'))) ||
					    (level === 'INFO' && message.includes('é‡å»ºè¿æ¥'))) {
						originalFn(...args);
					} else {
						// å…¶ä»–æ—¥å¿—é™çº§åˆ° console.debug
						console.debug(`[${level}]`, ...args);
					}
				};
			};
			
			// æ›¿æ¢å…¨å±€æ—¥å¿—å‡½æ•°
			window.logInfo = createSilentLogger('INFO', this.originalLogFunctions.logInfo);
			window.logWarn = createSilentLogger('WARN', this.originalLogFunctions.logWarn);
			window.logErr = createSilentLogger('ERR', this.originalLogFunctions.logErr);
		}
		
		// ğŸ”Š é€€å‡ºé™é»˜æ¨¡å¼ï¼šæ¢å¤æ­£å¸¸æ—¥å¿—
		exitSilentMode() {
			if (!this.silentMode || !this.originalLogFunctions) return;
			
			this.silentMode = false;
			
			// æ¢å¤åŸå§‹æ—¥å¿—å‡½æ•°
			window.logInfo = this.originalLogFunctions.logInfo;
			window.logWarn = this.originalLogFunctions.logWarn;
			window.logErr = this.originalLogFunctions.logErr;
		}
		
		// ğŸ“¶ æ™ºèƒ½é‡è¿ç­–ç•¥ï¼šæ ¹æ®é¡µé¢çŠ¶æ€å’Œç½‘ç»œçŠ¶å†µå†³å®šæ˜¯å¦é‡è¿
		shouldAttemptReconnect(errorType = 'UNKNOWN') {
			// é¡µé¢éšè—æ—¶ä¸é‡è¿
			if (this.pageHidden) {
				return false;
			}
			
			// åˆšä»åå°åˆ‡æ¢å›æ¥ï¼Œç»™ä¸€äº›ç¼“å†²æ—¶é—´
			const timeSinceVisible = Date.now() - (window.__lastVisibilityChange || 0);
			if (timeSinceVisible < 10000) { // 10ç§’å†…
				return false;
			}
			
			// æ­£åœ¨é‡è¿ä¸­ï¼Œé¿å…é‡å¤
			if (this.isReconnecting) {
				return false;
			}
			
			// é¢‘ç¹çš„CLOSEDäº‹ä»¶ï¼Œæš‚åœé‡è¿
			if (errorType === 'CLOSED' && this.checkClosedEventFrequency()) {
				return false;
			}
			
			// æ£€æŸ¥ç½‘ç»œçŠ¶æ€
			if (navigator.onLine === false) {
				console.debug('ç½‘ç»œç¦»çº¿ï¼Œè·³è¿‡é‡è¿');
				return false;
			}
			
			return true;
		}
		
		// â±ï¸ ç»Ÿä¸€çš„é‡è¿å»¶è¿Ÿè®¡ç®—
		calculateReconnectDelay(attempts, status) {
			let baseDelay = 2000; // åŸºç¡€å»¶è¿Ÿ2ç§’
			
			// é¡µé¢éšè—æ—¶ä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿ
			if (this.pageHidden || this.silentMode) {
				baseDelay = 10000; // 10ç§’
			}
			
			if (status === 'CLOSED') {
				baseDelay = Math.max(baseDelay, 4000);
				const now = Date.now();
				const lastClosedTime = window.__lastClosedTime || 0;
				if (now - lastClosedTime < 15000) { // 15ç§’å†…å¤šæ¬¡CLOSED
					baseDelay = Math.min(45000, baseDelay * attempts);
				}
				window.__lastClosedTime = now;
			}
			
			const maxDelay = this.pageHidden || this.silentMode ? 360000 : // éšè—æ—¶æœ€é•¿6åˆ†é’Ÿ
							status === 'CLOSED' ? 240000 : 150000; // CLOSEDçŠ¶æ€å…è®¸æ›´é•¿å»¶è¿Ÿ
			
			return Math.min(maxDelay, Math.round(baseDelay * Math.pow(1.4, attempts-1) + Math.random()*1000));
		}
	}
	
	// å…¨å±€realtimeç›‘æ§å™¨
	const realtimeMonitor = new RealtimeMonitor();
	
	// ğŸ”§ æ·»åŠ éªŒè¯å’Œæ¢å¤è®¡æ—¶å™¨çŠ¶æ€çš„è¾…åŠ©æ–¹æ³•
	realtimeMonitor.validateAndRestoreTimerStates = async function() {
		logInfo('å¼€å§‹éªŒè¯å¹¶æ¢å¤è®¡æ—¶å™¨çŠ¶æ€...');
		try {
			// è°ƒç”¨å¢å¼ºç‰ˆçš„è®¡æ—¶å™¨çŠ¶æ€æ¢å¤å‡½æ•°
			await restoreRoomTimerStates();
			
			// ä»…åŒæ­¥ç»è¿‡éªŒè¯çš„æœ‰æ•ˆçŠ¶æ€åˆ°äº‘ç«¯
			await this.syncValidatedTimerStates();
			
			logInfo('è®¡æ—¶å™¨çŠ¶æ€éªŒè¯å’Œæ¢å¤å®Œæˆ');
		} catch (error) {
			logErr('è®¡æ—¶å™¨çŠ¶æ€éªŒè¯æ¢å¤å¤±è´¥:', error.message);
		}
	};
	
	realtimeMonitor.syncValidatedTimerStates = async function() {
		// åªåŒæ­¥å½“å‰Storeä¸­ç¡®å®æœ‰æ•ˆçš„å ç”¨çŠ¶æ€
		const validOccupiedRooms = Store.rooms.filter(r => {
			// åªæœ‰åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰è®¤ä¸ºæ˜¯æœ‰æ•ˆçŠ¶æ€ï¼š
			// 1. æœ‰å ç”¨è€… 2. æœ‰æ³¨å†Œæ—¶é—´ 3. æ³¨å†Œæ—¶é—´ä¸è¶…è¿‡12å°æ—¶
			if (!r.occupant_student_name || !r.registerTime) return false;
			const ageHours = (Date.now() - r.registerTime) / (1000 * 60 * 60);
			return ageHours <= 12;
		});
		
		if (validOccupiedRooms.length === 0) {
			logInfo('æ— æœ‰æ•ˆå ç”¨çŠ¶æ€éœ€è¦åŒæ­¥åˆ°äº‘ç«¯');
			return;
		}
		
		try {
			logInfo(`åŒæ­¥ ${validOccupiedRooms.length} ä¸ªéªŒè¯è¿‡çš„æˆ¿é—´çŠ¶æ€åˆ°äº‘ç«¯...`);
			
			for (const room of validOccupiedRooms) {
				// åœ¨æ¨é€å‰å†æ¬¡éªŒè¯æœåŠ¡å™¨çŠ¶æ€ï¼Œé˜²æ­¢è¦†ç›–æ›´æ–°çš„æ•°æ®
				const { data: currentServerState } = await supabaseClient
					.from('rooms')
					.select('occupant_student_name, register_time, version')
					.eq('name', room.name)
					.single();
				
				if (currentServerState && 
					currentServerState.occupant_student_name === room.occupant_student_name) {
					// æœåŠ¡å™¨çŠ¶æ€åŒ¹é…ï¼Œå¯ä»¥å®‰å…¨åŒæ­¥å¿ƒè·³ç­‰éå…³é”®æ•°æ®
					await supabaseClient
						.from('rooms')
						.update({ 
							heartbeat_at: new Date().toISOString(),
							version: room.version
						})
						.eq('name', room.name);
					
					logInfo(`å·²åŒæ­¥æˆ¿é—´å¿ƒè·³: ${room.name}`);
				} else {
					logWarn(`è·³è¿‡æˆ¿é—´ ${room.name}ï¼ŒæœåŠ¡å™¨çŠ¶æ€å·²å˜æ›´`);
				}
			}
		} catch (error) {
			logWarn('åŒæ­¥éªŒè¯è¿‡çš„è®¡æ—¶çŠ¶æ€å¤±è´¥:', error.message);
		}
	};

	// å¤šè®¾å¤‡åŒæ­¥å¢å¼ºå™¨
	class MultiDeviceSyncEnhancer {
		constructor() {
			this.lastOperationTime = 0;
			this.operationWindow = 30000; // 30ç§’å†…çš„æ“ä½œè®¤ä¸ºæ˜¯"æ´»è·ƒæœŸ"
			this.enhancedMode = false;
		}
		
		// è®°å½•ç”¨æˆ·æ“ä½œï¼Œè¿›å…¥å¢å¼ºåŒæ­¥æ¨¡å¼
		recordUserOperation() {
			this.lastOperationTime = Date.now();
			if (!this.enhancedMode) {
				this.enterEnhancedMode();
			}
		}
		
		// è¿›å…¥å¢å¼ºåŒæ­¥æ¨¡å¼ï¼šä¸»è¦ç”¨äºè¿æ¥ç›‘æ§ï¼Œä¸å†æé«˜å¿ƒè·³é¢‘ç‡
		enterEnhancedMode() {
			this.enhancedMode = true;
			logInfo('è¿›å…¥å¢å¼ºåŒæ­¥æ¨¡å¼ï¼šå¢å¼ºè¿æ¥ç›‘æ§');
			
			// ğŸš« å–æ¶ˆå¢å¼ºæ¨¡å¼çš„é«˜é¢‘å¿ƒè·³ - realtimeå·²ç»è¶³å¤Ÿå®æ—¶
			// å¢å¼ºæ¨¡å¼ç°åœ¨åªå½±å“è¿æ¥å¥åº·æ£€æŸ¥çš„é¢‘ç‡ï¼Œä¸é¢å¤–å‘é€å¿ƒè·³è¯·æ±‚
			
			// è®¾ç½®é€€å‡ºå¢å¼ºæ¨¡å¼çš„å®šæ—¶å™¨
			setTimeout(() => {
				this.exitEnhancedMode();
			}, this.operationWindow);
		}
		
		// é€€å‡ºå¢å¼ºæ¨¡å¼ï¼Œæ¢å¤æ­£å¸¸é¢‘ç‡
		exitEnhancedMode() {
			if (!this.enhancedMode) return;
			
			const timeSinceLastOp = Date.now() - this.lastOperationTime;
			if (timeSinceLastOp < this.operationWindow) {
				// å¦‚æœè¿˜åœ¨æ“ä½œçª—å£å†…ï¼Œå»¶è¿Ÿé€€å‡º
				setTimeout(() => this.exitEnhancedMode(), this.operationWindow - timeSinceLastOp);
				return;
			}
			
			this.enhancedMode = false;
			logInfo('é€€å‡ºå¢å¼ºåŒæ­¥æ¨¡å¼ï¼šæ¢å¤æ­£å¸¸ç›‘æ§é¢‘ç‡');
			
			// ğŸš« ä¸å†éœ€è¦æ¢å¤å¿ƒè·³é¢‘ç‡ï¼Œå› ä¸ºå¢å¼ºæ¨¡å¼ä¸å†æ”¹å˜å¿ƒè·³
		}
		

		
		isInEnhancedMode() {
			return this.enhancedMode;
		}
	}
	
	// å…¨å±€å¤šè®¾å¤‡åŒæ­¥å¢å¼ºå™¨
	const syncEnhancer = new MultiDeviceSyncEnhancer();
	
	// ğŸ” å¤šè®¾å¤‡åŒæ­¥ä¸€è‡´æ€§éªŒè¯å™¨
	class SyncConsistencyValidator {
		constructor() {
			this.lastValidationTime = 0;
			this.validationInterval = 30000; // 30ç§’éªŒè¯ä¸€æ¬¡ï¼Œå‡å°‘é¢‘ç‡
			this.initializationGracePeriod = 10000; // é¡µé¢åˆå§‹åŒ–å10ç§’å†…ä¸è¿›è¡ŒéªŒè¯
			this.startTime = Date.now(); // è®°å½•åˆ›å»ºæ—¶é—´
		}
		
		// éªŒè¯registerTimeå­—æ®µçš„ä¸€è‡´æ€§
		validateRegisterTimeConsistency() {
			const now = Date.now();
			
			// é¡µé¢åˆå§‹åŒ–æœŸé—´è·³è¿‡éªŒè¯ï¼Œé¿å…åˆå§‹åŒ–æ•°æ®ä¸ä¸€è‡´çš„è¯¯æŠ¥
			if (now - this.startTime < this.initializationGracePeriod) {
				return;
			}
			
			if (now - this.lastValidationTime < this.validationInterval) return;
			
			this.lastValidationTime = now;
			let inconsistencies = 0;
			let fixedInconsistencies = 0;
			
			Store.rooms.forEach(room => {
				// åªæ£€æŸ¥æœ‰å ç”¨è€…çš„æˆ¿é—´
				if (!room.occupant_student_name) {
					// ç©ºé—²æˆ¿é—´åº”è¯¥ä¸¤ä¸ªå­—æ®µéƒ½ä¸ºç©ºï¼Œå¦‚æœä¸æ˜¯åˆ™é™é»˜ä¿®å¤
					if (room.registerTime !== null || room.register_time !== null) {
						room.registerTime = null;
						room.register_time = null;
						fixedInconsistencies++;
					}
					return;
				}
				
				// æ£€æŸ¥å ç”¨æˆ¿é—´çš„æ—¶é—´å­—æ®µä¸€è‡´æ€§
				const hasValidRegisterTime = room.registerTime !== null && room.registerTime !== undefined && !isNaN(room.registerTime);
				const hasValidRegisterTimeRaw = room.register_time !== null && room.register_time !== undefined && room.register_time !== '';
				
				// å¦‚æœä¸¤ä¸ªå­—æ®µéƒ½æœ‰å€¼ï¼Œæ£€æŸ¥æ˜¯å¦å¯¹åº”
				if (hasValidRegisterTime && hasValidRegisterTimeRaw) {
					const registerTimeFromRaw = toMs(room.register_time);
					const timeDiff = Math.abs(room.registerTime - registerTimeFromRaw);
					
					// å…è®¸æœ€å¤š1ç§’çš„è¯¯å·®ï¼ˆæ•°æ®åº“ç²¾åº¦é—®é¢˜ï¼‰
					if (timeDiff > 1000) {
						inconsistencies++;
						logWarn(`æˆ¿é—´ ${room.name} æ—¶é—´å­—æ®µæ•°å€¼ä¸åŒ¹é…: registerTime=${room.registerTime} (${new Date(room.registerTime).toLocaleString()}), register_time=${room.register_time}`);
						
						// ä¼˜å…ˆä½¿ç”¨registerTimeï¼ˆæœ¬åœ°æ—¶é—´æˆ³ï¼‰
						room.register_time = new Date(room.registerTime).toISOString();
						fixedInconsistencies++;
					}
				}
				// å¦‚æœåªæœ‰ä¸€ä¸ªå­—æ®µæœ‰å€¼ï¼Œè¡¥å……å¦ä¸€ä¸ªå­—æ®µ
				else if (hasValidRegisterTime && !hasValidRegisterTimeRaw) {
					room.register_time = new Date(room.registerTime).toISOString();
					fixedInconsistencies++;
				}
				else if (!hasValidRegisterTime && hasValidRegisterTimeRaw) {
					room.registerTime = toMs(room.register_time);
					fixedInconsistencies++;
				}
				// å¦‚æœä¸¤ä¸ªå­—æ®µéƒ½æ²¡æœ‰æœ‰æ•ˆå€¼ï¼Œè¿™æ˜¯å¼‚å¸¸æƒ…å†µ
				else if (!hasValidRegisterTime && !hasValidRegisterTimeRaw) {
					inconsistencies++;
					logWarn(`æˆ¿é—´ ${room.name} æœ‰å ç”¨è€…ä½†ç¼ºå°‘æ—¶é—´ä¿¡æ¯: ${room.occupant_student_name}`);
				}
			});
			
			// åªåœ¨æœ‰çœŸæ­£çš„ä¸ä¸€è‡´é—®é¢˜æ—¶æ‰è¾“å‡ºæ—¥å¿—
			if (inconsistencies > 0) {
				logWarn(`ğŸ”§ æ£€æµ‹åˆ° ${inconsistencies} ä¸ªä¸¥é‡æ—¶é—´å­—æ®µé—®é¢˜ï¼Œå·²è‡ªåŠ¨ä¿®å¤ ${fixedInconsistencies} ä¸ª`);
			} else if (fixedInconsistencies > 0 && fixedInconsistencies <= 3) {
				// å°‘é‡ä¿®å¤æ—¶é™é»˜å¤„ç†ï¼Œé¿å…åˆ·å±
				console.debug(`ğŸ”§ é™é»˜ä¿®å¤äº† ${fixedInconsistencies} ä¸ªæ—¶é—´å­—æ®µæ ¼å¼é—®é¢˜`);
			} else if (fixedInconsistencies > 3) {
				// å¤§é‡ä¿®å¤æ—¶æ‰è¾“å‡ºè­¦å‘Š
				logInfo(`ğŸ”§ æ‰¹é‡ä¿®å¤äº† ${fixedInconsistencies} ä¸ªæ—¶é—´å­—æ®µæ ¼å¼é—®é¢˜`);
			}
			
			// å¦‚æœæœ‰ä¿®å¤ï¼Œè§¦å‘ä¸€æ¬¡è®¡æ—¶å™¨æ›´æ–°
			if (fixedInconsistencies > 0 && window.updateAllRoomTimers) {
				window.updateAllRoomTimers();
			}
		}
	}
	
	// å…¨å±€ä¸€è‡´æ€§éªŒè¯å™¨
	const consistencyValidator = new SyncConsistencyValidator();
	
	// åˆå§‹åŒ–æ•°æ®è§„èŒƒåŒ–å‡½æ•°
	function normalizeInitialData() {
		let normalizedCount = 0;
		
		Store.rooms.forEach(room => {
			// ç¡®ä¿ç©ºé—²æˆ¿é—´çš„æ—¶é—´å­—æ®µä¸ºç©º
			if (!room.occupant_student_name) {
				if (room.registerTime !== null || room.register_time !== null) {
					room.registerTime = null;
					room.register_time = null;
					normalizedCount++;
				}
			}
			// ç¡®ä¿å ç”¨æˆ¿é—´çš„æ—¶é—´å­—æ®µåŒæ­¥
			else {
				const hasValidRegisterTime = room.registerTime !== null && room.registerTime !== undefined && !isNaN(room.registerTime);
				const hasValidRegisterTimeRaw = room.register_time !== null && room.register_time !== undefined && room.register_time !== '';
				
				if (hasValidRegisterTime && !hasValidRegisterTimeRaw) {
					room.register_time = new Date(room.registerTime).toISOString();
					normalizedCount++;
				} else if (!hasValidRegisterTime && hasValidRegisterTimeRaw) {
					room.registerTime = toMs(room.register_time);
					normalizedCount++;
				}
			}
		});
		
		if (normalizedCount > 0) {
			console.debug(`ğŸ“‹ åˆå§‹åŒ–æ—¶è§„èŒƒåŒ–äº† ${normalizedCount} ä¸ªæˆ¿é—´çš„æ—¶é—´å­—æ®µæ ¼å¼`);
		}
	}

	// è¯·æ±‚ç»Ÿè®¡å™¨
	class RequestStats {
		constructor() {
			this.stats = {
				heartbeat: { count: 0, lastTime: 0 },
				reconcile: { count: 0, lastTime: 0 },
				roomUpdate: { count: 0, lastTime: 0 },
				studentUpdate: { count: 0, lastTime: 0 },
				syncToCloud: { count: 0, lastTime: 0 },
				realtimeEvents: { count: 0, lastTime: 0 }
			};
			this.startTime = Date.now();
		}
		
		record(type) {
			if (this.stats[type]) {
				this.stats[type].count++;
				this.stats[type].lastTime = Date.now();
			}
		}
		
		getReport() {
			const now = Date.now();
			const uptime = Math.round((now - this.startTime) / 1000 / 60); // åˆ†é’Ÿ
			let report = `\n=== è¯·æ±‚ç»Ÿè®¡æŠ¥å‘Š (è¿è¡Œæ—¶é—´: ${uptime}åˆ†é’Ÿ) ===\n`;
			
			for (const [type, stat] of Object.entries(this.stats)) {
				const rate = uptime > 0 ? (stat.count / uptime).toFixed(2) : '0.00';
				const lastTime = stat.lastTime > 0 ? `${Math.round((now - stat.lastTime)/1000)}ç§’å‰` : 'ä»æœª';
				report += `${type}: ${stat.count}æ¬¡ (${rate}/åˆ†é’Ÿ) æœ€å: ${lastTime}\n`;
			}
			
			return report;
		}
		
		reset() {
			for (const stat of Object.values(this.stats)) {
				stat.count = 0;
				stat.lastTime = 0;
			}
			this.startTime = Date.now();
		}
	}
	
	// å…¨å±€è¯·æ±‚ç»Ÿè®¡å™¨
	const requestStats = new RequestStats();
	
	// ç´§æ€¥åˆ¹è½¦ç³»ç»Ÿ
	class EmergencyBrake {
		constructor() {
			this.engaged = false;
			this.reason = '';
		}
		
		engage(reason) {
			if (!this.engaged) {
				this.engaged = true;
				this.reason = reason;
				logWarn(`ç´§æ€¥åˆ¹è½¦æ¿€æ´»: ${reason}`);
				updateSyncStatus('error', 'ç´§æ€¥æ¨¡å¼');
				toast(`âš ï¸ ç³»ç»Ÿè¿›å…¥ç´§æ€¥æ¨¡å¼: ${reason}`, 'warn');
				
				// åœæ­¢æ‰€æœ‰å®šæ—¶å™¨
				timerManager.clearAllTimers();
				
				// æ–­å¼€realtimeè¿æ¥ä»¥å‡å°‘æœåŠ¡å™¨å‹åŠ›
				if (realtimeChannel) {
					try { supabaseClient?.removeChannel(realtimeChannel); } catch(e) {}
				}
				if (window.studentRealtimeChannel) {
					try { supabaseClient?.removeChannel(window.studentRealtimeChannel); } catch(e) {}
				}
			}
		}
		
		disengage() {
			if (this.engaged) {
				this.engaged = false;
				this.reason = '';
				logInfo('ç´§æ€¥åˆ¹è½¦è§£é™¤ï¼Œç³»ç»Ÿæ¢å¤æ­£å¸¸');
				updateSyncStatus('disconnected', 'æ­£åœ¨æ¢å¤...');
				toast('ç³»ç»Ÿæ­£åœ¨æ¢å¤æ­£å¸¸æ¨¡å¼...', 'info');
				
				// å»¶è¿Ÿé‡æ–°å»ºç«‹è¿æ¥ï¼Œé¿å…ç«‹å³é‡æ–°è§¦å‘é—®é¢˜
				setTimeout(async () => {
					try {
						if (supabaseReady) {
							await setupRealtime();
							realtimeMonitor.start();
							updateSyncStatus('connected', 'å·²æ¢å¤');
							toast('ç³»ç»Ÿå·²æ¢å¤æ­£å¸¸', 'success');
						}
					} catch (error) {
						logErr('ç³»ç»Ÿæ¢å¤å¤±è´¥:', error.message);
					}
				}, 30000); // 30ç§’åæ¢å¤
			}
		}
		
		isEngaged() {
			return this.engaged;
		}
	}
	
	// å…¨å±€ç´§æ€¥åˆ¹è½¦ç³»ç»Ÿ
	const emergencyBrake = new EmergencyBrake();
	
	// æš´éœ²åˆ°å…¨å±€ä¾›è°ƒè¯•ä½¿ç”¨
	window.debugStats = {
		getReport: () => console.log(requestStats.getReport()),
		reset: () => requestStats.reset(),
		throttler: requestThrottler,
		monitor: realtimeMonitor,
		emergencyBrake: emergencyBrake,
		syncEnhancer: syncEnhancer,
		// æ—¶é—´åŒæ­¥
		timeSyncStatus: () => serverTimeSync.getStatus(),
		syncTime: () => serverTimeSync.syncWithServer(),
		
		// ç´§æ€¥åœæ­¢æ‰€æœ‰realtimeåŠŸèƒ½
		emergencyStop: (reason = 'æ‰‹åŠ¨åœæ­¢') => emergencyBrake.engage(reason),
		
		// æ¢å¤realtimeåŠŸèƒ½
		resume: () => emergencyBrake.disengage(),
		
		// æ‰‹åŠ¨è§¦å‘å¢å¼ºåŒæ­¥æ¨¡å¼
		enhanceSync: () => {
			syncEnhancer.recordUserOperation();
			console.log('å·²æ‰‹åŠ¨è§¦å‘å¢å¼ºåŒæ­¥æ¨¡å¼');
		},
		
		// æ£€æŸ¥å½“å‰åŒæ­¥çŠ¶æ€
		getSyncStatus: () => {
			return {
				enhancedMode: syncEnhancer.isInEnhancedMode(),
				emergencyBrake: emergencyBrake.isEngaged(),
				realtimeActivity: Date.now() - realtimeMonitor.lastActivity
			};
		},
		
		// æ‰‹åŠ¨æµ‹è¯•è½¬ç§»åŠŸèƒ½
		testTransfer: (fromRoom, toRoom, studentName) => {
			transferStudentUnified(fromRoom, toRoom, studentName);
			console.log(`æ­£åœ¨æµ‹è¯•è½¬ç§»: ${studentName} ä» ${fromRoom} åˆ° ${toRoom}`);
		},
		
		// è·å–è¯¦ç»†çš„Realtimeè¿æ¥çŠ¶æ€
		getRealtimeStatus: () => ({
			lastActivity: realtimeMonitor.lastActivity,
			connectionIssues: realtimeMonitor.connectionIssues,
			healthCheckActive: !!realtimeMonitor.healthCheckInterval,
			roomChannelState: realtimeChannel?.state || 'unknown',
			studentChannelState: window.studentRealtimeChannel?.state || 'unknown',
			roomReconnectTimer: !!window.__roomsRealtimeReconnectTimer,
			studentReconnectTimer: !!window.__studentsRealtimeReconnectTimer,
			roomAttempts: window.__roomsRealtimeAttempts || 0,
			studentAttempts: window.__studentsRealtimeAttempts || 0
		}),
		
		// ä¸€é”®è¯Šæ–­å‡½æ•°
		diagnoseIssues: () => {
			const now = Date.now();
			const diagnostics = {
				timestamp: new Date().toISOString(),
				supabaseReady: !!supabaseClient,
				realtimeChannels: {
					rooms: realtimeChannel ? {
						state: realtimeChannel.state,
						topic: realtimeChannel.topic,
						joinedAt: realtimeChannel.joinedAt
					} : null,
					students: window.studentRealtimeChannel ? {
						state: window.studentRealtimeChannel.state,
						topic: window.studentRealtimeChannel.topic,
						joinedAt: window.studentRealtimeChannel.joinedAt
					} : null
				},
				studentLibrary: {
					count: window.StudentLibrary ? (function() {
						try { return window.StudentLibrary.list().length; } catch(e) { return 'error'; }
					})() : 'not-loaded'
				},
				storeStatus: {
					roomCount: Store.rooms.length,
					studentCount: Store.students.length
				},
				reconnectState: {
					roomReconnecting: window.__roomsRealtimeReconnecting || false,
					lastClosedTime: window.__lastClosedTime || 0,
					lastStudentClosedTime: window.__lastStudentClosedTime || 0
				}
			};
			
			const issues = [];
			const suggestions = [];
			
			if (!diagnostics.supabaseReady) issues.push('Supabaseå®¢æˆ·ç«¯æœªå°±ç»ª');
			if (diagnostics.realtimeChannels.rooms?.state !== 'joined') issues.push(`æˆ¿é—´é€šé“çŠ¶æ€å¼‚å¸¸: ${diagnostics.realtimeChannels.rooms?.state || 'null'}`);
			if (diagnostics.realtimeChannels.students?.state !== 'joined') issues.push(`å­¦ç”Ÿé€šé“çŠ¶æ€å¼‚å¸¸: ${diagnostics.realtimeChannels.students?.state || 'null'}`);
			if (realtimeMonitor.connectionIssues > 0) issues.push(`è¿æ¥é—®é¢˜è®¡æ•°: ${realtimeMonitor.connectionIssues}`);
			if (window.__roomsRealtimeAttempts > 5) issues.push(`æˆ¿é—´é‡è¿æ¬¡æ•°è¿‡å¤š: ${window.__roomsRealtimeAttempts}`);
			if (window.__studentsRealtimeAttempts > 5) issues.push(`å­¦ç”Ÿé‡è¿æ¬¡æ•°è¿‡å¤š: ${window.__studentsRealtimeAttempts}`);
			
			const report = {
				timestamp: diagnostics.timestamp,
				issues: issues.length > 0 ? issues : ['æ— æ˜æ˜¾é—®é¢˜'],
				suggestions: suggestions,
				fullDiagnostics: diagnostics
			};
			
			if (issues.length > 0) {
				suggestions.push('å°è¯•åˆ·æ–°é¡µé¢é‡æ–°å»ºç«‹è¿æ¥');
				if (diagnostics.reconnectState.roomReconnecting) {
					suggestions.push('æˆ¿é—´æ•°æ®åŒæ­¥æ­£åœ¨é‡è¿ï¼Œè¯·ç­‰å¾…');
				}
				if (window.__roomsRealtimeAttempts > 10 || window.__studentsRealtimeAttempts > 10) {
					suggestions.push('é‡è¿æ¬¡æ•°è¿‡å¤šï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥');
				}
			}
			
			console.log('ğŸ” Realtimeè¿æ¥è¯Šæ–­æŠ¥å‘Š:', report);
			return report;
		},
		
		// å¿«é€Ÿä¿®å¤å¸¸è§é—®é¢˜
		quickFix: () => {
			console.log('ğŸ”§ æ‰§è¡Œå¿«é€Ÿä¿®å¤...');
			
			// é‡ç½®é‡è¿è®¡æ•°
			window.__roomsRealtimeAttempts = 0;
			window.__studentsRealtimeAttempts = 0;
			
			// æ¸…é™¤é‡è¿è®¡æ—¶å™¨
			if (window.__roomsRealtimeReconnectTimer) {
				clearTimeout(window.__roomsRealtimeReconnectTimer);
				window.__roomsRealtimeReconnectTimer = null;
			}
			if (window.__studentsRealtimeReconnectTimer) {
				clearTimeout(window.__studentsRealtimeReconnectTimer);
				window.__studentsRealtimeReconnectTimer = null;
			}
			
			// é‡ç½®è¿æ¥é—®é¢˜è®¡æ•°
			realtimeMonitor.connectionIssues = 0;
			realtimeMonitor.recordActivity();
			
			// é‡æ–°åŒæ­¥æœåŠ¡å™¨æ—¶é—´
			if (serverTimeSync.isInitialized) {
				serverTimeSync.manualSync();
			}
			
			// é‡æ–°å»ºç«‹è¿æ¥
			if (supabaseClient) {
				setTimeout(() => {
					try {
						setupRealtime();
						console.log('âœ… Realtimeè¿æ¥é‡æ–°åˆå§‹åŒ–å®Œæˆ');
					} catch(e) {
						console.error('âŒ é‡æ–°åˆå§‹åŒ–å¤±è´¥:', e);
					}
				}, 1000);
			}
			
			console.log('ğŸ”§ å¿«é€Ÿä¿®å¤æ‰§è¡Œå®Œæˆï¼Œè¯·ç­‰å¾…è¿æ¥é‡å»º...');
		},
		
		// è·å–æ—¶é—´åŒæ­¥çŠ¶æ€
		getTimeSyncStatus: () => {
			const now = Date.now();
			const serverTime = getServerSyncedTime();
			return {
				initialized: serverTimeSync.isInitialized,
				serverOffset: serverTimeSync.serverTimeOffset,
				lastSyncTime: serverTimeSync.lastSyncTime > 0 ? new Date(serverTimeSync.lastSyncTime).toLocaleString() : 'Never',
				syncInProgress: serverTimeSync.syncInProgress,
				shouldResync: serverTimeSync.shouldResync(),
				timeSinceLastSync: serverTimeSync.lastSyncTime > 0 ? Math.round((now - serverTimeSync.lastSyncTime) / 1000) + 's' : 'N/A',
				currentServerTime: new Date(serverTime).toLocaleString(),
				currentLocalTime: new Date(now).toLocaleString(),
				timeDifference: Math.round((serverTime - now) / 1000) + 's',
				syncHealth: serverTimeSync.lastSyncTime > 0 && (now - serverTimeSync.lastSyncTime) < 10 * 60 * 1000 ? 'Good' : 'Needs Sync'
			};
		},
		
		// æ‰‹åŠ¨åŒæ­¥æ—¶é—´
		syncTime: async () => {
			console.log('â° å¼€å§‹æ‰‹åŠ¨æ—¶é—´åŒæ­¥...');
			try {
				await serverTimeSync.manualSync();
				const status = window.debugStats.getTimeSyncStatus();
				console.log('âœ… æ—¶é—´åŒæ­¥å®Œæˆ:', status);
			} catch (error) {
				console.error('âŒ æ—¶é—´åŒæ­¥å¤±è´¥:', error);
			}
		},
		
		// æµ‹è¯•æ—¶é—´åŒæ­¥å‡†ç¡®æ€§
		testTimeSync: () => {
			const local = Date.now();
			const server = getServerSyncedTime();
			const diff = server - local;
			
			console.log('ğŸ• æ—¶é—´åŒæ­¥æµ‹è¯•ç»“æœ:');
			console.log('æœ¬åœ°æ—¶é—´:', new Date(local).toLocaleString());
			console.log('æœåŠ¡å™¨æ—¶é—´:', new Date(server).toLocaleString());
			console.log('æ—¶é—´å·®:', diff + 'ms (' + Math.round(diff/1000) + 's)');
			
			if (Math.abs(diff) < 5000) {
				console.log('âœ… æ—¶é—´åŒæ­¥æ­£å¸¸ (å·®å€¼ < 5ç§’)');
			} else if (Math.abs(diff) < 60000) {
				console.log('âš ï¸ æ—¶é—´åŒæ­¥æœ‰è½»å¾®åå·® (å·®å€¼ < 1åˆ†é’Ÿ)');
			} else {
				console.log('âŒ æ—¶é—´åŒæ­¥åå·®è¾ƒå¤§ï¼Œå»ºè®®æ£€æŸ¥');
			}
			
			return { local, server, difference: diff };
		},
		
		// è®¡æ—¶å™¨çŠ¶æ€ç®¡ç†
		getTimerStates: () => {
			const occupiedRooms = Store.rooms.filter(r => r.occupant_student_name && r.registerTime);
			return occupiedRooms.map(r => ({
				room: r.name,
				occupant_student_name: r.occupant_student_name,
				registerTime: new Date(r.registerTime).toLocaleString(),
				elapsed: Math.floor((getServerSyncedTime() - r.registerTime) / 1000),
				status: statusInfo(r).state
			}));
		},
		
		// ä¿å­˜è®¡æ—¶å™¨çŠ¶æ€
		saveTimerStates: () => {
			timerPersistence.saveTimerStates();
			console.log('ğŸ’¾ è®¡æ—¶å™¨çŠ¶æ€å·²ä¿å­˜');
		},
		
		// æ¢å¤è®¡æ—¶å™¨çŠ¶æ€
		restoreTimerStates: async () => {
			await restoreRoomTimerStates();
			console.log('ğŸ”„ è®¡æ—¶å™¨çŠ¶æ€æ¢å¤å°è¯•å®Œæˆ');
		},
		
		// æ¸…ç†è®¡æ—¶å™¨çŠ¶æ€
		clearTimerStates: () => {
			timerPersistence.cleanup();
			console.log('ğŸ—‘ï¸ è®¡æ—¶å™¨çŠ¶æ€å·²æ¸…ç†');
		}
	};

	// ç»Ÿä¸€æˆ¿é—´æ¨¡å‹(å·²ç®€åŒ–): { name, pianoType, location, remark, occupant_student_name, register_time, version, heartbeat_at }
	// 2025-09 å­—æ®µç»Ÿä¸€: ä»…ä½¿ç”¨ occupant_student_nameï¼›æ‰€æœ‰æ—§å­—æ®µ occupant / student å·²åºŸå¼ƒï¼Œç¦æ­¢å†å¼•ç”¨
	const Store = {
		rooms: [], // æ´»åŠ¨çŠ¶æ€ (rooms è¡¨)
		roomMeta: {}, // é™æ€ï¼ˆroom_databaseï¼‰ name->meta
		students: [], // {id,name,major,grade}
		byName: new Map(),
		studentIndex: new Map(),
		floorSet: new Set(),
		filters: { floor:'ALL', type:'ALL' },
		settings: { basePracticeDuration:120, practiceSlotCheckEnabled:true }, // æ–°å¢: ç»ƒç´æ—¶æ®µæ£€æµ‹å¼€å…³
		timer: null,
		lastStats:{},
		pendingAssign:new Map(), // roomName -> {occupant,version,ts}
		localPracticeLogs: [], // æœ¬åœ°ç»ƒä¹ è®°å½•ç¼“å­˜
		pendingChanges: new Map(), // è·Ÿè¸ªå¾…ä¿å­˜çš„æˆ¿é—´ä¿®æ”¹ { roomName: { remark, location, pianoType } }
		editMode: false // ç¼–è¾‘æ¨¡å¼çŠ¶æ€
	};

	// ========== Guard: æ•è·é—ç•™å¯¹ rooms?select=created_at çš„è¯·æ±‚ (é˜²æ—§ç¼“å­˜è„šæœ¬) ==========
	(function installCreatedAtGuard(){
		try {
			if(window.__createdAtGuardInstalled) return; window.__createdAtGuardInstalled=true;
			const origFetch = window.fetch;
			window.fetch = function(resource, init){
				try {
					const url = typeof resource==='string'?resource:(resource&&resource.url)||'';
					if(url.includes('/rest/v1/rooms') && /select=([^&]*,)?created_at/.test(url)){
						console.warn('[Guard] æ‹¦æˆªé—ç•™ rooms?select=created_at è¯·æ±‚:', url);
						console.warn('[Guard] è¯´æ˜ä»æœ‰æ—§ç‰ˆæœ¬é¡µé¢æˆ–ç¼“å­˜é€»è¾‘åœ¨è¿è¡Œï¼Œè¯·å…³é—­å…¶å®ƒæ ‡ç­¾å¹¶å¼ºåˆ¶åˆ·æ–° (Ctrl+Shift+R)ã€‚');
						try{ console.warn('[Guard] è°ƒç”¨å †æ ˆâ†’\n'+(new Error().stack)); }catch(_){ }
					}
				}catch(_){ }
				return origFetch.apply(this, arguments);
			};
		} catch(e){ console.warn('[Guard] å®‰è£… fetch ç›‘æ§å¤±è´¥', e); }
	})();

	/* æ‹¼éŸ³æ˜ å°„ */
	const pinyinMap={'é³':'jin','è“':'lan','ç†™':'xi','é‚“':'deng','æ¶µ':'han','å‘¨':'zhou','é™':'jing','è¿œ':'yuan','å†¯':'feng','ç‘':'rui','å¤•':'xi','å•':'lv','é‡‘':'jin','æ˜‚':'ang','å¾':'xu','æ¶¬':'shuang','å®¸':'chen','çª¦':'dou','ç’Ÿ':'jing','å':'hua','æ—':'lin','æ™':'yan','ç†¹':'xi','æ®µ':'duan','é‰´':'jian','å¶':'ye','è”š':'wei','åˆ˜':'liu','æ³½':'ze','æ–‡':'wen','æ½˜':'pan','ç‘¾':'jin','ç† ':'yi','æ':'li','åš':'bo','æ©':'en','ç‹':'wang','å¥•':'yi','ç„¶':'ran','éŸ©':'han','æ˜€':'yun','æ¡¦':'hua','å­”':'kong','ç’‡':'xuan','è‡§':'zang','æ˜±':'yu','æ£‹':'qi','è”º':'lin','è½©':'xuan','å®‹':'song','æ¢“':'zi','æš„':'xuan','ç”°':'tian','å­':'zi','è±':'xuan','å¼ ':'zhang','ä¾':'yi','é™ˆ':'chen','æ€':'si','å½¤':'tong','æ¨':'yang','é›¨':'yu','æ¡':'tong','èµµ':'zhao','æ¬£':'xin','æ€¡':'yi','é©¬':'ma','æ™¨':'chen','æ›¦':'xi','é«˜':'gao','æ¢¦':'meng','çª':'qi','éƒ‘':'zheng','è¯—':'shi','å´':'wu','ä½³':'jia','ä½•':'he','æœ±':'zhu','å¿ƒ':'xin','è¯­':'yu','èƒ¡':'hu','è‹¥':'ruo','æ±':'xi','è®¸':'xu','ç‘¶':'yao','ç½—':'luo','é›…':'ya','é’Ÿ':'zhong','å«£':'yan','è°¢':'xie','è‹':'su','ç³':'lin','æ±Ÿ':'jiang','å­™':'sun','è¢':'yuan','æ±ª':'wang','æ›¹':'cao','å§š':'yao','æ²ˆ':'shen','å¢':'lu','éŸ¦':'wei','è‘£':'dong','å‚…':'fu','ç¨‹':'cheng','ä¸':'ding','çŸ³':'shi','ä»»':'ren','é‚¹':'zou','é¾™':'long','å²':'shi','æ–¹':'fang','å¤':'xia','ä¾¯':'hou','é‚±':'qiu','å°¹':'yin','é»':'li','æ±¤':'tang','æ˜“':'yi','å¸¸':'chang','æ­¦':'wu','ä¹”':'qiao','è´º':'he','èµ–':'lai','é¾š':'gong','åº':'pang','æ¨Š':'fan','å…°':'lan','æ®·':'yin','æ–½':'shi','é™¶':'tao','ç¿':'weng','å®‰':'an','å€ª':'ni','ä¸¥':'yan','ç‰›':'niu','æ¸©':'wen','èŠ¦':'lu','å­£':'ji','ä¿':'yu','ç« ':'zhang','é²':'lu','è‘›':'ge','ä¼':'wu','ç”³':'shen','å°¤':'you','æ¯•':'bi','è‚':'nie','ä¸›':'cong','ç„¦':'jiao','å‘':'xiang','æŸ¯':'ke','å²³':'yue','æ¹˜':'xiang','æ‚¦':'yue','ç®':'wei','ç®¡':'guan','å“²':'zhe','å©·':'ting','é‡Š':'shi','è¨€':'yan','ç¥':'zhu','å®':'bao','å½­':'peng','ç¾':'mei','æ·‡':'qi','åº·':'kang','ç¾¤':'qun','è€¿':'geng','å¹„':'wo','åƒ':'qian','ç‘œ':'yu','åˆ':'you','é›¯':'wen','ä¿Š':'jun','æ°':'jie','åŠ²':'jin','è±ª':'hao','ç¬™':'sheng','æƒ':'quan','è–›':'xue','å®œ':'yi','é™†':'lu','æ›œ':'yao','å¶™':'lin','é¦¨':'xin','è£•':'yu','æ˜•':'xin','æ²':'mu','å”':'tang','å›':'jun','ç››':'sheng','ç¡•':'shuo','æ™—':'han','å¦‚':'ru','ç‰§':'mu','é£':'feng','æ™':'xi','ä¼Š':'yi','æ¸…':'qing','å¦ƒ':'fei','æœˆ':'yue','ç¥º':'qi','è’²':'pu','æŸ':'bai','ç¾½':'yu','å† ':'guan','æˆ':'cheng','é¢œ':'yan','äº¦':'yi','æ²…':'yuan','æ‰¿':'cheng','ç§¦':'qin','é“‚':'bo','ç­µ':'yan','æ…§':'hui','ä½œ':'zuo','ç¿°':'han','ä¸Š':'shang','ä¹‹':'zhi','è·¯':'lu','ç“’':'zan','è‘—':'zhu','ç¿':'rui','ç±½':'zi','ä¸':'cheng','å¦':'yan','æ ©':'xu','ä¹':'le','é€¸':'yi','è¯š':'cheng','é’°':'yu','æ´':'jie','åª›':'yuan','é‹†':'yun','è°¨':'jin','ç•…':'chang','èŒ¹':'ru','æ²‚':'yi','å©‰':'wan','è·':'he','æ´‹':'yang','æ˜':'ming','å¤š':'duo','éƒ—':'xi','ä¼ ':'chuan','å¹³':'ping','ä¸–':'shi','å…ƒ':'yuan','æ±‡':'hui','æ²™':'sha','çš“':'hao','å®¶':'jia','æ¥ ':'nan','å®˜':'guan','æŸ˜':'zhe','å¸Œ':'xi','æº¥':'pu','å°š':'shang','å‡Œ':'ling','ç¿¾':'xuan','å§œ':'jiang','ç…Š':'xuan','ç¬':'wan','è¿ª':'di','æ˜':'xuan','æ²':'qin','ç¥':'yi','çˆ':'jia','æ”¿':'zheng','é˜³':'yang','ä»¥':'yi','éª':'qian','ä¹™':'yi','é“®':'zheng','å•†':'shang','å¤©':'tian','èµ':'ci','æ™Ÿ':'sheng','å³°':'feng','é‚µ':'shao','é¢¢':'hao','æµ©':'hao','ä½™':'yu','æµ¡':'bo','ç€š':'han','å³»':'jun','äº':'yu','é’²':'zheng','åŸ¼':'qi','è‹':'su','å½¦':'yan','ç‚³':'bing','å²':'qi','ç’ ':'fan','ç™½':'bai','å’':'yong','ç':'ding','åº„':'zhuang','ç¬›':'di','è–ª':'xin','ç±³':'mi','çª':'qi','å­˜':'cun','å’Œ':'he','ç¬‘':'xiao','æ¬§':'ou','ç¿°':'han','å–†':'zhe','åº­':'ting','å½°':'zhang','é‚°':'tai','è”¡':'cai','å±¹':'yi','æ½†':'ying','æ½':'lu','ä¿®':'xiu','å†‰':'ran','å…‰':'guang','ç¿¼':'yi','çº':'jun','é—»':'wen','æ²»':'zhi','ç¥':'yue','å©§':'jing','å©':'qi','æ¤':'zhi','å¯…':'yin','äº•':'jing','æºª':'xi','ç´«':'zi','èˆª':'hang','æ˜¾':'xian','ç¿”':'xiang','æ™¯':'jing','å›­':'yuan','ç¾¿':'yi','è¾¾':'da','æ­£':'zheng','æ½¼':'tong','å˜‰':'jia','å´š':'ling','æ±‰':'han','å†¼':'xian','æ˜Š':'hao','æ•¬':'jing','å°”':'er','å“':'zhuo','å¸…':'shuai','å¿—':'zhi','å¯':'ke','é’§':'jun','é‰´':'jian','ç¬™':'sheng','æƒ':'quan','æ˜¾':'xian','ç¿”':'xiang','æ™':'yan','ç†¹':'xi','é‡Š':'shi','è¨€':'yan','æ£®':'sen','è´¤':'xian','æŸ³':'liu','æ©':'en','å¥•':'yi','æ½¼':'tong','å˜‰':'jia','æ€¡':'yi','é‡‘':'jin','æ˜‚':'ang','ç‘¾':'jin','ç† ':'yi','ç¾':'mei','æ·‡':'qi','åƒ':'qian','ç‘œ':'yu','å­':'zi','è½©':'xuan','å¿—':'zhi','æ˜Š':'hao','è±':'xuan','ç”³':'shen','å´š':'ling','æ¢“':'zi','åº·':'kang','å²³':'yue','æ±‰':'han','æ˜Š':'hao','ç†¹':'xi','åˆ':'you','å®‰':'an','æ¶¬':'shuang','å®¸':'chen','å®œ':'yi','è‰º':'yi','å“':'zhuo','ç„¶':'ran','è”š':'wei','è“':'lan','æ•¬':'jing','è½©':'xuan','æ˜±':'yu','æ£‹':'qi','å°”':'er','æ¶µ':'han','é›¯':'wen','å©·':'ting','å“':'zhuo','ç¾¤':'qun','å­':'zi','å¸…':'shuai','å­':'zi','ä¾':'yi','åš':'bo','ç®':'wei','æ¬£':'xin','æ€¡':'yi','é™':'jing','è¿œ':'yuan','å®':'bao','æ€¡':'yi','å¸¸':'chang','æ¬£':'xin','æ´‹':'yang','å©‰':'wan','èŒ¹':'ru','æ˜':'ming','å¤š':'duo','æ°':'jie','æ¬£':'xin','è·':'he','åƒ':'qian','çš“':'hao','æ±‡':'hui','æ³½':'ze','ä¼ ':'chuan','å¹³':'ping','ä¸–':'shi','å…ƒ':'yuan','å† ':'guan','æº':'yuan','ç±³':'mi','çª':'qi','å•':'dan','è‹¥':'ruo','æºª':'xi','æ©':'en','å’Œ':'he','é‡‘':'jin','é»„':'huang','å¯':'ke','æ¬£':'xin','å­”':'kong','æ¢“':'zi','è¯­':'yu','å­˜':'cun','æµ©':'hao','å˜‰':'jia','è·':'he','é›¨':'yu','ç¬›':'di','å­':'zi','è½©':'xuan','è–ª':'xin','ç‘œ':'yu','æ¢“':'zi','å®¸':'chen','æ‰¿':'cheng','ç†¹':'xi','å­':'zi','å¢¨':'mo','å¡˜':'tang','æ¬£':'xin','å¦':'yan','ç¬‘':'xiao','æ¬§':'ou','ç¥':'yi','ç¥':'yue','å©§':'jing','å©':'qi','æ¤':'zhi','å…ƒ':'yuan','æµ©':'hao','å…ƒ':'yuan','æ¢“':'zi','å¯…':'yin','ä¾':'yi','è¯º':'nuo','é’§':'jun','å±¹':'yi','åš':'bo','é—»':'wen','åº­':'ting','å½°':'zhang','æ½†':'ying','æ½':'lu','ç† ':'yi','å®¸':'chen','å¤©':'tian','ç¿¼':'yi','æ²»':'zhi','é’§':'jun','æ—':'lin','ç† ':'yi','æ¢“':'zi','å³°':'feng','ä¿®':'xiu','å†‰':'ran','çº':'jun','ç¿°':'han','å–†':'zhe','ç±³':'mi','é˜³':'yang','å…‰':'guang','æ ©':'xu','ä¹':'le','å®‰':'an','æ…§':'hui','å† ':'guan','å':'hua','è‹¥':'ruo','æ˜•':'xin','é›¨':'yu','ç†™':'xi','é‡‘':'jin','æ²‚':'yi','ä»¥':'yi','è¯º':'nuo','é’°':'yu','æ²':'mu','æ›¦':'xi','ç‰§':'mu','é£':'feng','æ¬£':'xin','å¦':'yan','æ²…':'yuan','æ‰¿':'cheng','ç±½':'zi','ä¸':'cheng','è°¨':'jin','ç•…':'chang','ä½œ':'zuo','ç¿°':'han','æ–‡':'wen','ç››':'sheng','è·¯':'lu','é›¨':'yu','ç“’':'zan','äº¦':'yi','å®¸':'chen','é€¸':'yi','è¯š':'cheng','å­':'zi','æ¸…':'qing','æŸ':'bai','ç¾½':'yu','é“‚':'bo','ç­µ':'yan','æ›œ':'yao','å¶™':'lin','è½©':'xuan','å­':'zi','èŒ¹':'ru','å˜‰':'jia','å›':'jun','æ´':'jie','åª›':'yuan','æœˆ':'yue','ç¥º':'qi','æ·‡':'qi','æ™—':'han','å¦‚':'ru','ä¸Š':'shang','æ©':'en','é›…':'ya','æ™':'xi','ä¸€':'yi','å¦ƒ':'fei','æ€¡':'yi','æ–‡':'wen','é­':'wei','ä¼Š':'yi','è±':'xuan','æ˜“':'yi','æˆ':'cheng','æ™Ÿ':'sheng','å˜‰':'jia','å®¶':'jia','ç¡•':'shuo','ä½³':'jia','é¦¨':'xin','è¯­':'yu','è‘—':'zhu','ç¿':'rui','è¯—':'shi','æ‚¦':'yue','ä¾':'yi','å®¸':'chen','å­':'zi','é‹†':'yun','æ¶µ':'han','ä¹‹':'zhi','è£•':'yu','è¾¾':'da'};

	function matchPinyin(name, searchTerm) {
		if (!searchTerm) return true;
		const searchLower = searchTerm.toLowerCase().trim();
		const nameLower = name.toLowerCase();
		
		// ç›´æ¥åŒ¹é…ä¸­æ–‡
		if (nameLower.includes(searchLower)) return true;
		
		// å¤„ç†ç©ºæ ¼åˆ†éš”çš„å¤šå…³é”®è¯æœç´¢
		const keywords = searchLower.split(/\s+/).filter(k => k.length > 0);
		if (keywords.length > 1) {
			return matchMultipleKeywords(name, keywords);
		}
		
		// å•å…³é”®è¯çš„æ‹¼éŸ³åŒ¹é…é€»è¾‘
		const nameChars = name.split('');
		const firstLetters = nameChars.map(char => {
			const py = pinyinMap[char];
			return py ? py.charAt(0) : char.toLowerCase();
		});

		// ğŸ’¡ å¯åŠ¨å­¦ç”Ÿåº“æ™ºèƒ½è½®è¯¢ï¼ˆå¢é‡åŒæ­¥ + å…œåº•æœºåˆ¶ï¼‰
		if(!window.__studentPollingInterval){
			window.__studentPollingInterval = setInterval(async ()=>{
				try{
					if(!window.supabaseReady) return;
					// è‹¥æœ€è¿‘5ç§’å·²æœ‰å®æ—¶äº‹ä»¶ï¼Œåˆ™è·³è¿‡æœ¬æ¬¡è½®è¯¢ï¼Œé¿å…é¢‘ç¹åˆå¹¶
					if(window.__studentUpdateTimestamp && (Date.now()-window.__studentUpdateTimestamp)<5000) return;
					
					if(typeof fetchStudents==='function'){
						const beforeCount = (Store.students||[]).length;
						
						// ä½¿ç”¨å¢é‡åŒæ­¥ï¼ˆåŸºäºä¸Šæ¬¡åŒæ­¥æ—¶é—´ï¼‰
						const lastSyncTime = window.__studentLastSyncTime;
						const isFirstSync = !lastSyncTime;
						
						if (isFirstSync) {
							// é¦–æ¬¡åŒæ­¥ä½¿ç”¨å…¨é‡
							await fetchStudents({ forceFullSync: true });
							logInfo('[RT][students][poll] é¦–æ¬¡å…¨é‡åŒæ­¥å®Œæˆ');
						} else {
							// åç»­ä½¿ç”¨å¢é‡åŒæ­¥
							await fetchStudents({ 
								incremental: true, 
								since: lastSyncTime 
							});
						}
						
						const afterCount = (Store.students||[]).length;
						if(afterCount!==beforeCount){ 
							logInfo(`[RT][students][poll] åˆå¹¶åæ•°é‡å˜åŒ–: ${beforeCount} â†’ ${afterCount}`); 
						}
					}
				}catch(e){ console.warn('[RT][students][poll] å¼‚å¸¸', e.message); }
			}, 120000); // ğŸ’¡ å¢é‡åŒæ­¥å¯ä»¥è¿›ä¸€æ­¥å»¶é•¿åˆ°2åˆ†é’Ÿ
		}
		
		// å¦‚æœæœç´¢è¯åªæœ‰ä¸€ä¸ªå­—æ¯ï¼ŒåªåŒ¹é…ç¬¬ä¸€ä¸ªå­—çš„é¦–å­—æ¯
		if (searchLower.length === 1) {
			return firstLetters[0] === searchLower;
		}
		
		// å¤šå­—æ¯æœç´¢æ—¶çš„è¿ç»­é¦–å­—æ¯åŒ¹é…
		const firstLettersStr = firstLetters.join('');
		
		// å®Œæ•´çš„é¦–å­—æ¯åŒ¹é…ï¼ˆå¦‚ "å½­ç¾å²" -> "pmq"ï¼‰
		if (firstLettersStr === searchLower) return true;
		
		// ä»å¼€å¤´å¼€å§‹çš„éƒ¨åˆ†åŒ¹é…ï¼ˆå¦‚ "å½­ç¾å²" -> "pm"ï¼‰
		if (firstLettersStr.startsWith(searchLower)) return true;
		
		// è¿ç»­å­ä¸²åŒ¹é…ï¼ˆå¦‚ "å½­ç¾å²" -> "mq" åŒ¹é… "ç¾å²"ï¼‰
		if (searchLower.length >= 2 && firstLettersStr.includes(searchLower)) return true;
		
		return false;
	}

	// å¤šå…³é”®è¯åŒ¹é…å‡½æ•°
	function matchMultipleKeywords(name, keywords) {
		const nameLower = name.toLowerCase();
		const nameChars = name.split('');
		const firstLetters = nameChars.map(char => {
			const py = pinyinMap[char];
			return py ? py.charAt(0) : char.toLowerCase();
		});
		const firstLettersStr = firstLetters.join('');
		
		// æ¯ä¸ªå…³é”®è¯éƒ½å¿…é¡»å•ç‹¬åŒ¹é…ï¼ˆAND é€»è¾‘ï¼‰
		const allMatch = keywords.every(keyword => {
			// ç›´æ¥ä¸­æ–‡åŒ¹é…
			if (nameLower.includes(keyword)) return true;
			
			// å•å­—æ¯é¦–å­—æ¯åŒ¹é…
			if (keyword.length === 1) {
				return firstLetters.includes(keyword);
			}
			
			// å¤šå­—æ¯è¿ç»­åŒ¹é…
			if (keyword.length >= 2) {
				return firstLettersStr.includes(keyword);
			}
			
			return false;
		});
		
		if (allMatch) return true;
		
		// æ™ºèƒ½é¦–å­—æ¯ç»„åˆåŒ¹é…
		const isAllSingleLetters = keywords.every(k => k.length === 1);
		if (isAllSingleLetters) {
			return matchSmartKeywords(name, keywords);
		}
		
		// ç»„åˆå…³é”®è¯åŒ¹é…
		return matchCombinedKeywords(name, keywords, firstLetters, nameLower);
	}

	// ç»„åˆå…³é”®è¯åŒ¹é…
	function matchCombinedKeywords(name, keywords, firstLetters, nameLower) {
		for (let i = 0; i < keywords.length; i++) {
			const keyword = keywords[i];
			let matched = false;
			
			if (keyword.length === 1) {
				// å•å­—æ¯ï¼šæ£€æŸ¥é¦–å­—æ¯
				matched = firstLetters.includes(keyword);
			} else {
				// å¤šå­—æ¯ï¼šæ£€æŸ¥ä¸­æ–‡æˆ–æ‹¼éŸ³
				matched = nameLower.includes(keyword) || 
						  firstLetters.join('').includes(keyword);
			}
			
			if (!matched) return false;
		}
		
		return true;
	}

	// æ™ºèƒ½å…³é”®è¯åŒ¹é…ï¼ˆæ”¯æŒé¦–å­—æ¯ç»„åˆï¼‰
	function matchSmartKeywords(name, keywords) {
		const nameChars = name.split('');
		const firstLetters = nameChars.map(char => {
			const py = pinyinMap[char];
			return py ? py.charAt(0) : char.toLowerCase();
		});
		
		// æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¿ç»­çš„é¦–å­—æ¯åŒ¹é…
		if (keywords.length <= nameChars.length) {
			for (let i = 0; i <= firstLetters.length - keywords.length; i++) {
				let match = true;
				for (let j = 0; j < keywords.length; j++) {
					if (firstLetters[i + j] !== keywords[j]) {
						match = false;
						break;
					}
				}
				if (match) return true;
			}
			
			// æ”¯æŒéè¿ç»­ä½†æŒ‰é¡ºåºçš„é¦–å­—æ¯åŒ¹é…
			let keywordIndex = 0;
			for (let i = 0; i < firstLetters.length && keywordIndex < keywords.length; i++) {
				if (firstLetters[i] === keywords[keywordIndex]) {
					keywordIndex++;
				}
			}
			if (keywordIndex === keywords.length) return true;
		}
		
		return false;
	}

	function canonicalizeRoom(r, preserveExisting = false){
		if(!r) return null;
		
		// ğŸ”§ å¦‚æœ preserveExisting=trueï¼Œå…ˆä»æœ¬åœ° Store è·å–ç°æœ‰æˆ¿é—´ä¿¡æ¯
		let existingRoom = null;
		if (preserveExisting && r.name) {
			existingRoom = Store.byName.get(r.name);
		}
		
		// ç»Ÿä¸€ï¼šä»… occupant_student_nameï¼›å…¶ä½™å­—æ®µæ²¿ç”¨æ—§å‰ç«¯å±æ€§å‘½åï¼ˆregisterTime / heartbeatAtï¼‰
		const out = {
			name: r.name,
			// ğŸ”§ ä¿®å¤ï¼šå¦‚æœpreserveExistingä¸”æœ¬åœ°å·²æœ‰å…ƒæ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨æœ¬åœ°å€¼ï¼Œé¿å…è¢«é»˜è®¤å€¼è¦†ç›–
			pianoType: r.piano_type || r.pianoType || r.pianoKind || (existingRoom?.pianoType) || 'æ— é’¢ç´',
			location: ((r.location !== undefined ? r.location : (existingRoom?.location || '')) || '').trim(),
			remark: (r.remark !== undefined ? r.remark : (existingRoom?.remark || '')) || ''
		};
		if ('occupant_student_name' in r) {
			out.occupant_student_name = r.occupant_student_name || null;
		}
		if ('register_time' in r || 'registerTime' in r) {
			// ğŸ”§ ç»Ÿä¸€æ—¶é—´å­—æ®µå¤„ç†é€»è¾‘ï¼Œé¿å…ä¸ä¸€è‡´é—®é¢˜
			const dbTime = r.register_time;
			const localTime = r.registerTime;
			
			// ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“æ—¶é—´ï¼Œä½†è¦è¿›è¡Œæœ‰æ•ˆæ€§éªŒè¯
			if (dbTime !== null && dbTime !== undefined && dbTime !== '') {
				try {
					const parsedTime = new Date(dbTime);
					if (!isNaN(parsedTime.getTime())) {
						// æ•°æ®åº“æ—¶é—´æœ‰æ•ˆï¼Œä½¿ç”¨æ•°æ®åº“æ—¶é—´
						out.registerTime = parsedTime.getTime();
						out.register_time = dbTime;
					} else {
						// æ•°æ®åº“æ—¶é—´æ— æ•ˆï¼Œä½¿ç”¨æœ¬åœ°æ—¶é—´ï¼ˆå¦‚æœæœ‰æ•ˆï¼‰
						if (localTime && !isNaN(localTime)) {
							out.registerTime = localTime;
							out.register_time = new Date(localTime).toISOString();
						} else {
							// ä¸¤ä¸ªæ—¶é—´éƒ½æ— æ•ˆï¼Œè®¾ä¸ºnull
							out.registerTime = null;
							out.register_time = null;
						}
					}
				} catch (e) {
					// æ•°æ®åº“æ—¶é—´è§£æå¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°æ—¶é—´
					if (localTime && !isNaN(localTime)) {
						out.registerTime = localTime;
						out.register_time = new Date(localTime).toISOString();
					} else {
						out.registerTime = null;
						out.register_time = null;
					}
				}
			} else if (localTime !== null && localTime !== undefined && !isNaN(localTime)) {
				// åªæœ‰æœ¬åœ°æ—¶é—´æœ‰æ•ˆ
				out.registerTime = localTime;
				out.register_time = new Date(localTime).toISOString();
			} else {
				// ä¸¤ä¸ªæ—¶é—´éƒ½æ— æ•ˆæˆ–ä¸ºç©º
				out.registerTime = null;
				out.register_time = null;
			}
		}
		if ('version' in r) out.version = r.version || 0;
		if ('heartbeat_at' in r || 'heartbeatAt' in r) {
			out.heartbeatAt = r.heartbeat_at ? toMs(r.heartbeat_at) : (r.heartbeatAt||null);
		}
		return out;
	}
	function toMs(v){ if(!v) return null; if(typeof v==='number') return v* (v<2e12?1000:1); return new Date(v).getTime(); }

	/*************************************************
	 * Supabase é€‚é…å™¨
	 *************************************************/
	async function initSupabase(){
		updateSyncStatus('connecting', 'è¿æ¥ä¸­...');
		let retryCount = 0;
		const maxRetries = 3;
		
		while (retryCount < maxRetries) {
			try {
				logInfo(`å°è¯•è¿æ¥ Supabase (ç¬¬ ${retryCount + 1} æ¬¡)`);
				
				// ğŸ”§ å…³é”®ä¿®å¤ï¼šé…ç½® Supabase å®¢æˆ·ç«¯é€‰é¡¹ï¼Œæé«˜è¿æ¥ç¨³å®šæ€§
				const clientOptions = {
					auth: {
						persistSession: true,  // æŒä¹…åŒ–ä¼šè¯åˆ° localStorage
						autoRefreshToken: true, // è‡ªåŠ¨åˆ·æ–°ä»¤ç‰Œ
						detectSessionInUrl: false, // ä¸ä» URL æ£€æµ‹ä¼šè¯ï¼ˆå•é¡µåº”ç”¨ï¼‰
						storage: window.localStorage, // ä½¿ç”¨ localStorage å­˜å‚¨ä¼šè¯
						storageKey: 'yms_supabase_session' // è‡ªå®šä¹‰å­˜å‚¨é”®
					},
					realtime: {
						params: {
							eventsPerSecond: 10 // é™åˆ¶äº‹ä»¶é¢‘ç‡ï¼Œé¿å…è¿‡è½½
						}
					},
					global: {
						headers: {
							'x-client-info': 'yms-piano-room-system' // æ ‡è¯†å®¢æˆ·ç«¯
						}
					},
					db: {
						schema: 'public'
					}
				};
				
				// æ£€æŸ¥ Supabase å®¢æˆ·ç«¯æ˜¯å¦å·²åŠ è½½
				if(typeof window.supabase !== 'undefined' && window.supabase.createClient){ 
					logInfo('ä½¿ç”¨å…¨å±€ supabase å¯¹è±¡ï¼ˆé…ç½®å·²ä¼˜åŒ–ï¼‰');
					supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, clientOptions); 
				} else if(typeof window.createClient==='function'){ 
					logInfo('ä½¿ç”¨å…¨å±€ createClient å‡½æ•°ï¼ˆé…ç½®å·²ä¼˜åŒ–ï¼‰');
					supabaseClient = window.createClient(SUPABASE_URL, SUPABASE_KEY, clientOptions); 
				} else { 
					logInfo('åŠ¨æ€åŠ è½½ Supabase è„šæœ¬');
					await loadSupabaseScript(); 
					if (!window.supabase || !window.supabase.createClient) {
						throw new Error('Supabase è„šæœ¬åŠ è½½å¤±è´¥ï¼Œå…¨å±€å¯¹è±¡ä¸å¯ç”¨');
					}
					supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, clientOptions); 
				}
				// æŒ‚è½½åˆ°å…¨å±€ï¼Œä¾› BTM ç­‰æ¨¡å—ä½¿ç”¨
				window.supabaseClient = supabaseClient;
				
				// éªŒè¯å®¢æˆ·ç«¯å¯¹è±¡
				if (!supabaseClient) {
					throw new Error('Supabase å®¢æˆ·ç«¯åˆ›å»ºå¤±è´¥');
				}
				
				// ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨æ›´è½»é‡çš„è¿æ¥æµ‹è¯•ï¼Œå¢åŠ è¶…æ—¶æ§åˆ¶
				logInfo('æµ‹è¯• Supabase è¿æ¥...');
				updateSyncStatus('connecting', 'æµ‹è¯•è¿æ¥...');
				
				// åˆ›å»ºä¸€ä¸ªå¸¦è¶…æ—¶çš„è¿æ¥æµ‹è¯•ï¼ˆ5ç§’è¶…æ—¶ï¼‰
				const testConnection = async () => {
					const { data, error } = await supabaseClient.from('rooms').select('name').limit(1).single();
					if (error && error.code !== 'PGRST116') { // PGRST116 æ˜¯ "æ²¡æœ‰è¡Œ" é”™è¯¯ï¼Œå¯ä»¥æ¥å—
						throw error;
					}
					return true;
				};
				
				const timeoutPromise = new Promise((_, reject) => 
					setTimeout(() => reject(new Error('è¿æ¥æµ‹è¯•è¶…æ—¶')), 5000)
				);
				
				await Promise.race([testConnection(), timeoutPromise]);
				logInfo('Supabase è¿æ¥æµ‹è¯•æˆåŠŸ');
				
				supabaseReady = true; 
				logInfo('âœ… Supabase åˆå§‹åŒ–å®Œæˆï¼ˆä¼šè¯å·²æŒä¹…åŒ–ï¼‰');
				updateSyncStatus('connected', 'Supabase å°±ç»ª');
				return; // æˆåŠŸï¼Œé€€å‡ºé‡è¯•å¾ªç¯
				
			} catch (error) {
				retryCount++;
				logErr(`Supabase åˆå§‹åŒ–å¤±è´¥ (ç¬¬ ${retryCount} æ¬¡):`, error.message);
				
				if (retryCount >= maxRetries) {
					updateSyncStatus('error', `åˆå§‹åŒ–å¤±è´¥`);
					// ğŸ”§ æä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤º
					toast(`åç«¯è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•`, 'error');
					logWarn('ä½¿ç”¨ç¦»çº¿æ¨¡å¼');
					return;
				}
				
				// æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
				const backoffDelay = Math.min(1000 * Math.pow(2, retryCount), 8000);
				logInfo(`ç­‰å¾… ${backoffDelay}ms åé‡è¯•...`);
				await new Promise(resolve => setTimeout(resolve, backoffDelay));
			}
		}
	}
	function loadSupabaseScript(){
		return new Promise((res,rej)=>{
			// æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
			if(window.supabase && window.supabase.createClient){
				logInfo('Supabase è„šæœ¬å·²å­˜åœ¨');
				return res();
			}
			
			const s=document.createElement('script'); 
			s.src='https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js';
			s.crossOrigin = 'anonymous'; 
			s.onload=()=>{
				logInfo('Supabase è„šæœ¬åŠ è½½æˆåŠŸ');
				// ç­‰å¾…å‡ æ¯«ç§’ç¡®ä¿å…¨å±€å¯¹è±¡å¯ç”¨
				setTimeout(res, 100);
			}; 
			s.onerror=(e)=>{
				logErr('åŠ è½½ supabase è„šæœ¬å¤±è´¥:', e);
				rej(new Error('åŠ è½½ supabase å¤±è´¥'));
			}; 
			document.head.appendChild(s);
		});
	}
	async function fetchRooms(){
		if(!supabaseReady) return [];
		const { data, error } = await supabaseClient.from('rooms').select('name,piano_type,location,remark,occupant_student_name,register_time,version,heartbeat_at,updated_at');
		if(error){ logWarn('åŠ è½½ rooms å¤±è´¥', error.message); return []; }
		return data.map(canonicalizeRoom);
	}
	async function fetchRoomMeta(){
		if(!supabaseReady) return {};
		const { data, error } = await supabaseClient.from('room_database').select('*');
		if(error){ logWarn('åŠ è½½ room_database å¤±è´¥', error.message); return {}; }
		
		const map={}; 
		const cloudRooms = [];
		
		(data||[]).forEach(r=>{ 
			map[r.name]=r; 
			// è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼å¹¶åŠ å…¥ç´æˆ¿åˆ—è¡¨
			cloudRooms.push({
				name: r.name,
				pianoType: r.piano_type || '',
				location: r.location || '',
				remark: r.remark || ''
			});
		}); 
		
		// è‡ªåŠ¨åˆå¹¶äº‘ç«¯ç´æˆ¿æ•°æ®åˆ°æœ¬åœ°ï¼ˆè·³è¿‡äº‘ç«¯åŒæ­¥é¿å…é€’å½’ï¼‰
		if (cloudRooms.length > 0) {
			logInfo(`ä»äº‘ç«¯è·å–åˆ° ${cloudRooms.length} ä¸ªç´æˆ¿ï¼Œè‡ªåŠ¨åˆå¹¶åˆ°æœ¬åœ°`);
			await mergeRooms(cloudRooms, { skipCloudSync: true, metaOnly: true });
		}
		
		return map;
	}

	// æŒ‰æˆ¿é—´åæ‹‰å–å•ä¸ªé™æ€å…ƒæ•°æ®å¹¶åˆå¹¶ï¼ˆä»…å…ƒæ•°æ®ï¼Œä¸è§¦åŠ¨å ç”¨çŠ¶æ€ï¼‰
	async function fetchRoomMetaByName(name){
		if(!supabaseReady || !name) return;
		try{
			const { data, error } = await supabaseClient.from('room_database').select('*').eq('name', name).limit(1);
			if(error){ logWarn(`åŠ è½½ room_meta(${name}) å¤±è´¥`, error.message); return; }
			const r = Array.isArray(data) ? data[0] : data;
			if(!r) return;
			await mergeRooms([{ name: r.name, pianoType: r.piano_type || '', location: r.location || '', remark: r.remark || '' }], { skipCloudSync: true, metaOnly: true });
			logInfo(`å·²è¡¥å……æˆ¿é—´å…ƒæ•°æ®: ${name}`);
		}catch(e){ logWarn(`åŠ è½½æˆ¿é—´å…ƒæ•°æ®å¼‚å¸¸(${name})`, e.message); }
	}

	// ğŸ”§ å¼ºåˆ¶åŒæ­¥ rooms è¡¨å’Œ room_database è¡¨çš„å…ƒæ•°æ®
	// ç¡®ä¿ä¸¤ä¸ªè¡¨çš„ name, piano_type, location, remark å®Œå…¨ä¸€è‡´
	async function forceSyncRoomTables(){
		if(!supabaseReady) {
			logWarn('Supabaseæœªå°±ç»ªï¼Œè·³è¿‡åŒè¡¨åŒæ­¥');
			return { success: false, error: 'Supabase not ready' };
		}
		
		try {
			logInfo('ğŸ”„ å¼€å§‹å¼ºåˆ¶åŒæ­¥ rooms å’Œ room_database è¡¨...');
			
			// 1. è·å–ä¸¤ä¸ªè¡¨çš„æ‰€æœ‰æ•°æ®
			const [roomsResult, metaResult] = await Promise.all([
				supabaseClient.from('rooms').select('name,piano_type,location,remark,occupant_student_name,register_time,version,heartbeat_at'),
				supabaseClient.from('room_database').select('name,piano_type,location,remark')
			]);
			
			if (roomsResult.error) throw new Error(`è·å– rooms è¡¨å¤±è´¥: ${roomsResult.error.message}`);
			if (metaResult.error) throw new Error(`è·å– room_database è¡¨å¤±è´¥: ${metaResult.error.message}`);
			
			const roomsData = roomsResult.data || [];
			const metaData = metaResult.data || [];
			
			// 2. å»ºç«‹ç´¢å¼•
			const roomsMap = new Map(roomsData.map(r => [r.name, r]));
			const metaMap = new Map(metaData.map(r => [r.name, r]));
			
			// 3. ä»¥ room_database ä¸ºå‡†ï¼ŒåŒæ­¥åˆ° rooms è¡¨
			const roomsUpdates = [];
			const metaInserts = [];
			let fixedCount = 0;
			
			// æ£€æŸ¥ room_database ä¸­çš„æ¯ä¸ªæˆ¿é—´
			for (const [name, meta] of metaMap) {
				const room = roomsMap.get(name);
				
				if (!room) {
					// rooms è¡¨ä¸­ä¸å­˜åœ¨ï¼Œæ’å…¥
					roomsUpdates.push({
						name: name,
						piano_type: meta.piano_type,
						location: meta.location,
						remark: meta.remark,
						occupant_student_name: null,
						register_time: null,
						version: 1,
						heartbeat_at: new Date().toISOString(),
						updated_at: new Date().toISOString()
					});
					fixedCount++;
					logInfo(`  â• rooms è¡¨ç¼ºå¤±æˆ¿é—´: ${name}`);
				} else {
					// æ£€æŸ¥å…ƒæ•°æ®æ˜¯å¦ä¸€è‡´
					const needsUpdate = 
						room.piano_type !== meta.piano_type ||
						room.location !== meta.location ||
						room.remark !== meta.remark;
					
					if (needsUpdate) {
						roomsUpdates.push({
							name: name,
							piano_type: meta.piano_type,
							location: meta.location,
							remark: meta.remark,
							// ä¿ç•™åŸæœ‰çš„å ç”¨çŠ¶æ€
							occupant_student_name: room.occupant_student_name,
							register_time: room.register_time,
							version: room.version || 1,
							heartbeat_at: room.heartbeat_at,
							updated_at: new Date().toISOString()
						});
						fixedCount++;
						logInfo(`  ğŸ”§ ä¿®å¤ rooms è¡¨å…ƒæ•°æ®: ${name} (${meta.piano_type})`);
					}
				}
			}
			
			// æ£€æŸ¥ rooms è¡¨ä¸­æ˜¯å¦æœ‰ room_database æ²¡æœ‰çš„æˆ¿é—´
			for (const [name, room] of roomsMap) {
				if (!metaMap.has(name)) {
					metaInserts.push({
						name: name,
						piano_type: room.piano_type || 'å…¶ä»–',
						location: room.location || '',
						remark: room.remark || '',
						updated_at: new Date().toISOString()
					});
					fixedCount++;
					logInfo(`  â• room_database è¡¨ç¼ºå¤±æˆ¿é—´: ${name}`);
				}
			}
			
			// 4. æ‰¹é‡æ›´æ–°
			if (roomsUpdates.length > 0) {
				const { error: upsertError } = await supabaseClient
					.from('rooms')
					.upsert(roomsUpdates, { onConflict: 'name' });
				
				if (upsertError) {
					logErr('rooms è¡¨æ›´æ–°å¤±è´¥:', upsertError.message);
				} else {
					logInfo(`âœ… å·²æ›´æ–° rooms è¡¨ ${roomsUpdates.length} æ¡è®°å½•`);
				}
			}
			
			if (metaInserts.length > 0) {
				const { error: insertError } = await supabaseClient
					.from('room_database')
					.upsert(metaInserts, { onConflict: 'name' });
				
				if (insertError) {
					logErr('room_database è¡¨æ’å…¥å¤±è´¥:', insertError.message);
				} else {
					logInfo(`âœ… å·²æ’å…¥ room_database è¡¨ ${metaInserts.length} æ¡è®°å½•`);
				}
			}
			
			if (fixedCount === 0) {
				logInfo('âœ… åŒè¡¨æ•°æ®å·²åŒæ­¥ï¼Œæ— éœ€ä¿®å¤');
			} else {
				logInfo(`âœ… åŒè¡¨åŒæ­¥å®Œæˆï¼Œå…±ä¿®å¤ ${fixedCount} å¤„ä¸ä¸€è‡´`);
			}
			
			// 5. é‡æ–°åŠ è½½æ•°æ®
			const [newRooms, newMeta] = await Promise.all([
				fetchRooms(),
				fetchRoomMeta()
			]);
			
			Store.rooms = newRooms;
			Store.roomMeta = newMeta;
			rebuildIndexes();
			renderRooms();
			
			return { 
				success: true, 
				fixed: fixedCount,
				roomsUpdated: roomsUpdates.length,
				metaInserted: metaInserts.length
			};
			
		} catch (error) {
			logErr('âŒ åŒè¡¨åŒæ­¥å¤±è´¥:', error.message);
			return { success: false, error: error.message };
		}
	}
	
	// æš´éœ²åˆ°å…¨å±€ä¾›è°ƒè¯•ä½¿ç”¨
	window.forceSyncRoomTables = forceSyncRoomTables;
	
	// ğŸ’¡ å¢é‡å­¦ç”Ÿåº“åŒæ­¥ - æ”¯æŒå…¨é‡å’Œå¢é‡ä¸¤ç§æ¨¡å¼
	async function fetchStudents(options = {}){
		if(!supabaseReady) return [];
		
		const { 
			incremental = false,  // æ˜¯å¦å¢é‡åŒæ­¥
			since = null,         // å¢é‡åŒæ­¥çš„èµ·å§‹æ—¶é—´
			forceFullSync = false // å¼ºåˆ¶å…¨é‡åŒæ­¥
		} = options;
		
		// ğŸ’¡ å…ˆå°è¯•åŒ…å«updated_atå­—æ®µï¼Œå¦‚æœå¤±è´¥åˆ™é™çº§åˆ°åŸºç¡€å­—æ®µ
		let query = supabaseClient.from('student_database').select('id,name,major,grade,updated_at');
		let hasUpdatedAtField = true;
		
		// å¢é‡æŸ¥è¯¢ï¼šåªè·å–æŒ‡å®šæ—¶é—´ä¹‹åæ›´æ–°çš„å­¦ç”Ÿ
		if (incremental && since && !forceFullSync && hasUpdatedAtField) {
			query = query.gt('updated_at', since);
			logInfo(`å¢é‡è·å–å­¦ç”Ÿæ•°æ®ï¼Œsince: ${since}`);
		} else {
			if (incremental && since && !hasUpdatedAtField) {
				logWarn('æ•°æ®åº“æ— updated_atå­—æ®µï¼Œé™çº§ä¸ºå…¨é‡åŒæ­¥');
			}
			logInfo('å…¨é‡è·å–å­¦ç”Ÿæ•°æ®');
		}
		
		const { data, error } = await query;
		
		// å¦‚æœåŒ…å«updated_atçš„æŸ¥è¯¢å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­—æ®µä¸å­˜åœ¨ï¼Œé™çº§åˆ°åŸºç¡€æŸ¥è¯¢
		if (error && error.message && error.message.includes('updated_at')) {
			logWarn('updated_atå­—æ®µä¸å­˜åœ¨ï¼Œé™çº§åˆ°åŸºç¡€å­—æ®µæŸ¥è¯¢');
			hasUpdatedAtField = false;
			// é‡æ–°æ„å»ºæŸ¥è¯¢ï¼ŒåªåŒ…å«åŸºç¡€å­—æ®µ
			const fallbackQuery = supabaseClient.from('student_database').select('id,name,major,grade');
			const { data: fallbackData, error: fallbackError } = await fallbackQuery;
			
			if (fallbackError) {
				logWarn('åŠ è½½å­¦ç”Ÿå¤±è´¥ï¼ˆé™çº§æŸ¥è¯¢ï¼‰', fallbackError.message);
				return [];
			}
			
			// æ²¡æœ‰updated_atå­—æ®µæ—¶ï¼Œæ— æ³•ç²¾ç¡®è®°å½•åŒæ­¥æ—¶é—´ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
			window.__studentLastSyncTime = new Date().toISOString();
			const students = fallbackData || [];
			logInfo(`é™çº§æŸ¥è¯¢æˆåŠŸï¼Œè·å–åˆ° ${students.length} ä¸ªå­¦ç”Ÿï¼ˆæ— æ—¶é—´æˆ³ï¼‰`);
			
			if (students.length > 0) {
				await mergeStudents(students, true);
				try{ if(window.ensureStudentLibraryHydrated){ window.ensureStudentLibraryHydrated({ source:'after-fetchStudents' }); } }catch(_){ }
			}
			
			return students;
		}
		
		if(error){ logWarn('åŠ è½½å­¦ç”Ÿå¤±è´¥', error.message); return []; }
		
		const students = data || [];
		
		// è®°å½•æœ€æ–°çš„æ›´æ–°æ—¶é—´ï¼Œç”¨äºä¸‹æ¬¡å¢é‡åŒæ­¥
		if (students.length > 0) {
			// è®¡ç®—æœ€æ–°æ›´æ–°æ—¶é—´ï¼ˆå¦‚æœæœ‰updated_atå­—æ®µï¼‰
			let latestUpdateTime;
			if (hasUpdatedAtField && students.some(s => s.updated_at)) {
				latestUpdateTime = Math.max(...students.map(s => new Date(s.updated_at || 0).getTime()));
				window.__studentLastSyncTime = new Date(latestUpdateTime).toISOString();
			} else {
				// æ²¡æœ‰updated_atå­—æ®µæ—¶ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
				window.__studentLastSyncTime = new Date().toISOString();
			}
			
			const syncType = incremental && since && !forceFullSync && hasUpdatedAtField ? 'å¢é‡' : 'å…¨é‡';
			logInfo(`${syncType}è·å–åˆ° ${students.length} ä¸ªå­¦ç”Ÿï¼Œæœ€æ–°åŒæ­¥æ—¶é—´: ${window.__studentLastSyncTime}`);
			
			// ç»Ÿè®¡ä¿¡æ¯
			if (!window.__studentSyncStats) {
				window.__studentSyncStats = { totalSyncs: 0, incrementalSyncs: 0, totalRecords: 0 };
			}
			window.__studentSyncStats.totalSyncs++;
			if (syncType === 'å¢é‡') {
				window.__studentSyncStats.incrementalSyncs++;
			}
			window.__studentSyncStats.totalRecords += students.length;
			
			await mergeStudents(students, true); // skipCloudSync = true
			try{ if(window.ensureStudentLibraryHydrated){ window.ensureStudentLibraryHydrated({ source:'after-fetchStudents' }); } }catch(_){ }
		} else if (incremental) {
			logInfo('å¢é‡åŒæ­¥ï¼šæ— æ–°å˜åŒ–');
			// æ›´æ–°åŒæ­¥æ—¶é—´å³ä½¿æ²¡æœ‰å˜åŒ–
			window.__studentLastSyncTime = new Date().toISOString();
		}
		
		return students;
	}

	// ğŸ’¡ æˆ¿é—´å¤‡æ³¨æ•°æ®åº“åŒæ­¥å‡½æ•°
	async function syncRoomRemarkToDatabase(roomName, remark) {
		if (!supabaseReady || !supabaseClient) {
			throw new Error('Supabaseæœªå°±ç»ª');
		}
		
		try {
			logInfo(`ğŸ”„ å¼€å§‹åŒæ­¥æˆ¿é—´å¤‡æ³¨åˆ°æ•°æ®åº“: ${roomName} -> "${remark}"`);
			
			// æ›´æ–°room_databaseè¡¨ä¸­çš„å¤‡æ³¨å­—æ®µ
			// è¿™ä¼šè‡ªåŠ¨è§¦å‘realtimeäº‹ä»¶ï¼Œå…¶ä»–è®¾å¤‡ä¼šæ”¶åˆ°æ›´æ–°
			const { data, error } = await supabaseClient
				.from('room_database')
				.update({ 
					remark: remark || null,
					updated_at: new Date().toISOString() // ç¡®ä¿æœ‰æ›´æ–°æ—¶é—´æˆ³
				})
				.eq('name', roomName)
				.select(); // æ·»åŠ select()ä»¥è·å–æ›´æ–°åçš„æ•°æ®
				
			if (error) {
				throw error;
			}
			
			// ğŸ”§ åŒæ­¥æ›´æ–°æœ¬åœ°Store.roomsï¼Œé˜²æ­¢æ—§æ•°æ®æ±¡æŸ“äº‘ç«¯
			if (Store.rooms[roomName]) {
				Store.rooms[roomName].remark = remark || '';
				logInfo(`ğŸ”„ å·²åŒæ­¥æ›´æ–°æœ¬åœ° Store.rooms['${roomName}'].remark`);
			}
			
			logInfo(`âœ… æˆ¿é—´å¤‡æ³¨å·²æˆåŠŸåŒæ­¥åˆ°æ•°æ®åº“ï¼š${roomName} -> "${remark}"`);
			logInfo(`ğŸ“Š æ•°æ®åº“è¿”å›:`, data);
			
		} catch (error) {
			logErr(`âŒ æˆ¿é—´å¤‡æ³¨æ•°æ®åº“åŒæ­¥å¤±è´¥ ${roomName}:`, error.message);
			throw error;
		}
	}

	async function syncRoomLocationToDatabase(roomName, location) {
		if (!supabaseReady || !supabaseClient) {
			throw new Error('Supabaseæœªå°±ç»ª');
		}
		
		try {
			logInfo(`ğŸ”„ å¼€å§‹åŒæ­¥æˆ¿é—´æ¥¼å±‚åˆ°æ•°æ®åº“: ${roomName} -> "${location}"`);
			
			// æ›´æ–°room_databaseè¡¨ä¸­çš„æ¥¼å±‚å­—æ®µ
			// è¿™ä¼šè‡ªåŠ¨è§¦å‘realtimeäº‹ä»¶ï¼Œå…¶ä»–è®¾å¤‡ä¼šæ”¶åˆ°æ›´æ–°
			const { data, error } = await supabaseClient
				.from('room_database')
				.update({ 
					location: location || null,
					updated_at: new Date().toISOString() // ç¡®ä¿æœ‰æ›´æ–°æ—¶é—´æˆ³
				})
				.eq('name', roomName)
				.select(); // æ·»åŠ select()ä»¥è·å–æ›´æ–°åçš„æ•°æ®
				
			if (error) {
				throw error;
			}
			
			// ğŸ”§ åŒæ­¥æ›´æ–°æœ¬åœ°Store.roomsï¼Œé˜²æ­¢æ—§æ•°æ®æ±¡æŸ“äº‘ç«¯
			if (Store.rooms[roomName]) {
				Store.rooms[roomName].location = location || '';
				logInfo(`ğŸ”„ å·²åŒæ­¥æ›´æ–°æœ¬åœ° Store.rooms['${roomName}'].location`);
			}
			
			logInfo(`âœ… æˆ¿é—´æ¥¼å±‚å·²æˆåŠŸåŒæ­¥åˆ°æ•°æ®åº“ï¼š${roomName} -> "${location}"`);
			logInfo(`ğŸ“Š æ•°æ®åº“è¿”å›:`, data);
			
		} catch (error) {
			logErr(`âŒ æˆ¿é—´æ¥¼å±‚æ•°æ®åº“åŒæ­¥å¤±è´¥ ${roomName}:`, error.message);
			throw error;
		}
	}

	// ğŸ’¡ æˆ¿é—´é‡å‘½åæ•°æ®åº“åŒæ­¥å‡½æ•°
	async function syncRoomNameToDatabase(oldName, newName, opts={}) {
		if (!supabaseReady || !supabaseClient) throw new Error('Supabaseæœªå°±ç»ª');
		const { silent } = opts;
		const ts = ()=>new Date().toISOString();
		// å¹¶å‘é”
		if(!window.__renameLocks) window.__renameLocks = new Set();
		const lockKey = `rename::${oldName}`;
		if(window.__renameLocks.has(lockKey)){
			throw new Error('é‡å‘½åè¿›è¡Œä¸­, è¯·ç¨å€™');
		}
		window.__renameLocks.add(lockKey);
		try {
			logInfo(`ğŸ”„ æˆ¿é—´é‡å‘½åå¼€å§‹(å¸¦æ£€æŸ¥): ${oldName} -> ${newName}`);
			if(oldName===newName) return { skipped:true };
			// 0. è¿œç¨‹å¯ç”¨æ€§æ£€æŸ¥ï¼ˆé¿å…ç›´æ¥ update è§¦å‘ 409ï¼‰
			const { data: existCheck, error: existErr } = await supabaseClient
				.from('room_database')
				.select('name')
				.eq('name', newName)
				.limit(1);
			if(existErr){ throw new Error(`åç§°æ£€æµ‹å¤±è´¥: ${existErr.message}`); }
			if(existCheck && existCheck.length){
				throw new Error('NAME_CONFLICT');
			}
			// 1. æ›´æ–° room_database
			const now = ts();
			const { data: metaData, error: metaError } = await supabaseClient
				.from('room_database')
				.update({ name:newName, updated_at: now })
				.eq('name', oldName)
				.select();
			if(metaError){
				// duplicate key å†æ¬¡å…œåº•è¯†åˆ«
				if(/duplicate key/i.test(metaError.message)) throw new Error('NAME_CONFLICT');
				throw new Error(`æ›´æ–°å…ƒæ•°æ®å¤±è´¥:${metaError.message}`);
			}
			// 2. æ›´æ–° rooms è¡¨
			const { data: roomsData, error: roomsError } = await supabaseClient
				.from('rooms')
				.update({ name:newName, updated_at: now })
				.eq('name', oldName)
				.select();
			if(roomsError){
				if(/duplicate key/i.test(roomsError.message)){
					// å›æ»š room_database æ”¹å (å°è¯•æ”¹å›æ—§å)
					try {
						await supabaseClient.from('room_database').update({ name:oldName, updated_at: ts() }).eq('name', newName);
						logWarn('å·²å°è¯•å›æ»šå…ƒæ•°æ®è¡¨åç§°');
					}catch(e){ logErr('å›æ»šå¤±è´¥:', e.message); }
					throw new Error('NAME_CONFLICT');
				}
				throw new Error(`æ›´æ–°çŠ¶æ€å¤±è´¥:${roomsError.message}`);
			}
			logInfo(`ğŸ‰ æˆ¿é—´é‡å‘½åå®Œæˆ(åŒè¡¨) ${oldName} -> ${newName}`);
			return { success:true, meta:metaData, rooms:roomsData };
		} catch (e){
			if(e.message==='NAME_CONFLICT'){
				if(!silent) logWarn(`âš ï¸ åç§°å†²çª: ${newName}`);
			} else {
				logErr(`âŒ æˆ¿é—´é‡å‘½åå¤±è´¥ ${oldName} -> ${newName}:`, e.message);
			}
			throw e;
		} finally {
			window.__renameLocks.delete(lockKey);
		}
	}

	// ğŸ§ª æµ‹è¯•è¾…åŠ©ï¼šå¿«é€Ÿåœ¨æ§åˆ¶å°è§¦å‘é‡å‘½åå¹¶è¾“å‡ºé˜¶æ®µæ€§æ—¥å¿—
	if(!window.testRoomRename){
		window.testRoomRename = async function(oldName, newName){
			console.log('[TEST] rename start', oldName, '->', newName);
			try{
				const r = Store.byName.get(oldName);
				if(!r){ console.warn('æˆ¿é—´ä¸å­˜åœ¨:', oldName); return; }
				await syncRoomNameToDatabase(oldName, newName);
				console.log('[TEST] rename success');
			}catch(e){ console.error('[TEST] rename fail', e.message); }
		};
	}

	// ğŸ§ª æµ‹è¯•è¾…åŠ©ï¼šå¿«é€Ÿåœ¨æ§åˆ¶å°è§¦å‘åˆ é™¤å¹¶è§‚æµ‹åŒæ­¥
	if(!window.testRoomDeletion){
		window.testRoomDeletion = async function(roomName){
			console.log('[TEST] deletion start', roomName);
			try{
				const r = Store.byName.get(roomName);
				if(!r){ console.warn('æˆ¿é—´ä¸å­˜åœ¨:', roomName); return; }
				await deleteRoom(roomName);
				console.log('[TEST] deletion success - local removed');
				// è§‚æµ‹å…¶ä»–è®¾å¤‡åŒæ­¥ï¼ˆå¦‚æœåœ¨å¤šçª—å£ç¯å¢ƒï¼‰
				setTimeout(()=>{
					const stillExists = Store.byName.has(roomName);
					console.log('[TEST] deletion check after 2s - still exists:', stillExists);
				}, 2000);
			}catch(e){ console.error('[TEST] deletion fail', e.message); }
		};
	}

	// ğŸ§ª è·¨çª—å£åˆ é™¤åŒæ­¥æµ‹è¯•
	if(!window.testCrossWindowDeletion){
		window.testCrossWindowDeletion = function(roomName){
			console.log('[CROSS-WINDOW-TEST] å‡†å¤‡è·¨çª—å£åˆ é™¤æµ‹è¯•:', roomName);
			console.log('ğŸ“‹ æµ‹è¯•æ­¥éª¤:');
			console.log('1. åœ¨çª—å£Aæ‰§è¡Œ: testRoomDeletion("' + roomName + '")');
			console.log('2. åœ¨çª—å£Bæ‰§è¡Œ: watchRoomDeletionSync("' + roomName + '")');
			console.log('3. åœ¨çª—å£Bæ‰§è¡Œ: diagnoseDeletionBlocking("' + roomName + '") (å¦‚æœåˆ é™¤é˜»å¡)');
			
			// æ£€æŸ¥å½“å‰æˆ¿é—´æ˜¯å¦å­˜åœ¨
			const exists = Store.byName.has(roomName);
			if(!exists){
				console.warn('âš ï¸ æˆ¿é—´ä¸å­˜åœ¨ï¼Œæ— æ³•æµ‹è¯•åˆ é™¤');
				return;
			}
			
			console.log('âœ… æˆ¿é—´å­˜åœ¨ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
			console.log('ğŸ’¡ å»ºè®®å…ˆåœ¨å¦ä¸€ä¸ªçª—å£æ‰§è¡Œç›‘æ§ï¼Œç„¶åå›åˆ°è¿™ä¸ªçª—å£åˆ é™¤');
		};
	}

	// ğŸ§ª å¢å¼ºåˆ é™¤åŒæ­¥ç›‘æ§å·¥å…·
	if(!window.watchRoomDeletionSync){
		window.watchRoomDeletionSync = function(roomName, seconds=8){
			console.log('[WATCH] å¼€å§‹ç›‘æ§æˆ¿é—´åˆ é™¤åŒæ­¥:', roomName);
			let i=0; const timer=setInterval(()=>{
				i++;
				const inStore = Store.byName.has(roomName);
				const inRooms = Store.rooms.some(r=>r.name===roomName);
				const inMeta = Store.roomMeta && Store.roomMeta[roomName];
				const inDOM = !!document.querySelector(`[data-room="${CSS.escape(roomName)}"]`);
				const deletionMarker = Store.deletionMarkers && Store.deletionMarkers.get(roomName);
				const markerAge = deletionMarker ? Math.round((Date.now() - deletionMarker)/1000) : 0;
				console.log(`[WATCH][${i}s] ${roomName} - Store.byName:${inStore} Store.rooms:${inRooms} meta:${!!inMeta} DOM:${inDOM} delMarker:${markerAge}s`);
				if(i>=seconds) {
					clearInterval(timer);
					const isFullyRemoved = !inStore && !inRooms && !inMeta && !inDOM;
					console.log(`[WATCH] ç›‘æ§ç»“æŸ - å®Œå…¨åˆ é™¤: ${isFullyRemoved}`);
				}
			},1000);
		};
	}

	// ğŸ—ï¸ ç®€å•æˆ¿é—´åˆ›å»ºå‡½æ•° (ç”¨äºæµ‹è¯•)
	if(!window.createTestRoom){
		window.createTestRoom = async function(roomName) {
			console.log(`ğŸ“ åˆ›å»ºæµ‹è¯•æˆ¿é—´: ${roomName}`);
			
			const newRoom = {
				name: roomName,
				location: 'æµ‹è¯•æ¥¼å±‚',
				pianoType: 'å…¶ä»–',
				remark: 'è‡ªåŠ¨æµ‹è¯•åˆ›å»º',
				occupant_student_name: null,
				registerTime: null,
				version: 1,
				heartbeatAt: null
			};
			
			// æ·»åŠ åˆ°æœ¬åœ°æ•°æ®
			Store.rooms.push(newRoom);
			Store.byName.set(roomName, newRoom);
			Store.floorSet.add('æµ‹è¯•æ¥¼å±‚');
			
			// åŒæ­¥åˆ°äº‘ç«¯
			if (!Store.settings.offlineMode) {
				await supabaseClient.from('room_database').upsert({
					name: roomName,
					location: 'æµ‹è¯•æ¥¼å±‚',
					piano_type: 'å…¶ä»–',
					remark: 'è‡ªåŠ¨æµ‹è¯•åˆ›å»º'
				});
				
				await supabaseClient.from('rooms').upsert({
					name: roomName,
					occupant_student_name: null,
					register_time: null,
					heartbeat_at: new Date().toISOString(),
					version: 1,
					updated_at: new Date().toISOString(),
				piano_type: 'å…¶ä»–',
				location: 'æµ‹è¯•æ¥¼å±‚',
				remark: 'è‡ªåŠ¨æµ‹è¯•åˆ›å»º'
				});
			}
			
			// åˆ·æ–°é¡µé¢æ˜¾ç¤º
			rebuildIndexes();
			rebuildDisplay();
			
			console.log(`âœ… æµ‹è¯•æˆ¿é—´åˆ›å»ºå®Œæˆ: ${roomName}`);
			return roomName;
		};
	}

	// ğŸ§ª å¿«é€Ÿæµ‹è¯•åˆ é™¤åŒæ­¥
	if(!window.quickDeletionTest){
		window.quickDeletionTest = async function() {
			// åˆ›å»ºæµ‹è¯•æˆ¿é—´
			console.log('ğŸ§ª å¼€å§‹å¿«é€Ÿåˆ é™¤æµ‹è¯•...');
			const testName = `æµ‹è¯•æˆ¿é—´_${Date.now()}`;
			
			try {
				await window.createTestRoom(testName);
				
				// ç­‰å¾…2ç§’è®©æˆ¿é—´åˆ›å»ºå®Œæˆå¹¶åŒæ­¥
				await new Promise(resolve => setTimeout(resolve, 2000));
				
				// éªŒè¯æˆ¿é—´æ˜¯å¦åˆ›å»ºæˆåŠŸ
				const roomInStore = Store.byName.has(testName);
				console.log(`ğŸ“Š æˆ¿é—´åˆ›å»ºéªŒè¯ - Storeä¸­å­˜åœ¨: ${roomInStore}`);
				
				if (!roomInStore) {
					console.error('âŒ æµ‹è¯•æˆ¿é—´åˆ›å»ºå¤±è´¥ - Storeä¸­æœªæ‰¾åˆ°');
					return;
				}
				
				// å¼€å§‹ç›‘å¬åˆ é™¤åŒæ­¥
				window.watchRoomDeletionSync(testName, 15);
				
				// ç­‰å¾…3ç§’ååˆ é™¤
				setTimeout(async () => {
					console.log(`ğŸ—‘ï¸ åˆ é™¤æµ‹è¯•æˆ¿é—´: ${testName}`);
					
					// æ‰¾åˆ°æˆ¿é—´è¿›è¡Œåˆ é™¤
					const room = Store.byName.get(testName);
					if (room) {
						// æ¨¡æ‹Ÿç‚¹å‡»åˆ é™¤æŒ‰é’®çš„é€»è¾‘
						const roomElement = Array.from(document.querySelectorAll('.room-item'))
							.find(item => item.textContent.includes(testName));
						
						if (roomElement) {
							const roomId = roomElement.getAttribute('data-room-id') || testName;
							await window.deleteRoom(roomId);
						} else {
							console.warn('âš ï¸ æœªæ‰¾åˆ°æˆ¿é—´DOMå…ƒç´ ï¼Œç›´æ¥è°ƒç”¨åˆ é™¤å‡½æ•°');
							await window.deleteRoom(testName);
						}
					}
				}, 3000);
				
			} catch (error) {
				console.error('âŒ å¿«é€Ÿåˆ é™¤æµ‹è¯•å¤±è´¥:', error);
			}
		};
	}

	// ğŸ”Œ æ£€æŸ¥å®æ—¶è¿æ¥çŠ¶æ€
	if(!window.checkRealtimeStatus){
		window.checkRealtimeStatus = function() {
			console.log('ğŸ”Œ å®æ—¶è¿æ¥çŠ¶æ€æ£€æŸ¥:');
			
			// æ£€æŸ¥ Supabase å®æ—¶è¿æ¥
			const supabaseRealtime = window.supabase?.realtime;
			console.log('- Supabase å®æ—¶å¯¹è±¡:', !!supabaseRealtime);
			
			if(supabaseRealtime) {
				console.log('- è¿æ¥çŠ¶æ€:', supabaseRealtime.connection?.connectionState);
				console.log('- é€šé“æ•°é‡:', supabaseRealtime.channels?.length || 0);
				
				// æ£€æŸ¥æ¯ä¸ªé€šé“
				supabaseRealtime.channels?.forEach((channel, index) => {
					console.log(`- é€šé“ ${index}:`, {
						topic: channel.topic,
						state: channel.state,
						joinedAt: channel.joinedAt
					});
				});
			}
			
			// æ£€æŸ¥æˆ‘ä»¬çš„å®æ—¶ç›‘æ§å™¨
			const monitor = window.realtimeMonitor;
			if(monitor) {
				console.log('- å®æ—¶ç›‘æ§å™¨æ´»è·ƒ:', monitor.isActive());
				console.log('- æœ€åæ´»åŠ¨æ—¶é—´:', monitor.lastActivity ? new Date(monitor.lastActivity).toLocaleTimeString() : 'æ— ');
			}
			
			// æ£€æŸ¥æˆ¿é—´è®¢é˜…çŠ¶æ€
			console.log('- æˆ¿é—´è¡¨è®¢é˜…åˆå§‹åŒ–:', !!window.__roomsRealtimeInit);
			console.log('- æˆ¿é—´å…ƒæ•°æ®è®¢é˜…è¿æ¥:', !!window.__roomMetaRealtimeConnected);
			
			return {
				supabaseConnected: supabaseRealtime?.connection?.connectionState === 'open',
				channelCount: supabaseRealtime?.channels?.length || 0,
				monitorActive: monitor?.isActive() || false,
				subscriptionsReady: !!window.__roomsRealtimeInit && !!window.__roomMetaRealtimeConnected
			};
		};
	}

	// ğŸ§ª è¯Šæ–­åˆ é™¤é˜»å¡çš„å·¥å…·
	if(!window.diagnoseDeletionBlocking){
		window.diagnoseDeletionBlocking = function(roomName){
			console.log('[DIAG] è¯Šæ–­åˆ é™¤é˜»å¡:', roomName);
			
			// æ£€æŸ¥å„ç§å¯èƒ½çš„é˜»å¡æ¡ä»¶
			const inStore = Store.byName.has(roomName);
			const inRooms = Store.rooms.some(r=>r.name===roomName);
			const inMeta = Store.roomMeta && Store.roomMeta[roomName];
			const inDOM = !!document.querySelector(`[data-room="${CSS.escape(roomName)}"]`);
			
			const deletionMarker = Store.deletionMarkers && Store.deletionMarkers.get(roomName);
			const markerAge = deletionMarker ? (Date.now() - deletionMarker) : 0;
			
			const operationLocks = Store.operationLocks ? Array.from(Store.operationLocks).filter(k=>k.includes(roomName)) : [];
			
			const realtimeConnected = window.__roomMetaRealtimeConnected;
			const roomsRealtimeInit = window.__roomsRealtimeInit;
			
			console.log('ğŸ” è¯Šæ–­ç»“æœ:');
			console.log('  æ•°æ®å­˜åœ¨:', {inStore, inRooms, inMeta, inDOM});
			console.log('  åˆ é™¤æ ‡è®°:', deletionMarker ? `å­˜åœ¨(${Math.round(markerAge/1000)}ç§’å‰)` : 'æ— ');
			console.log('  æ“ä½œé”:', operationLocks.length ? operationLocks : 'æ— ');
			console.log('  å®æ—¶è¿æ¥:', {roomsMeta: realtimeConnected, roomsTable: roomsRealtimeInit});
			
			if(deletionMarker && markerAge < 5000){
				console.warn('âš ï¸ åˆ é™¤æ ‡è®°é˜»å¡ - ç­‰å¾…æ ‡è®°è¿‡æœŸ');
			}
			if(operationLocks.length){
				console.warn('âš ï¸ æ“ä½œé”é˜»å¡:', operationLocks);
			}
			if(!realtimeConnected || !roomsRealtimeInit){
				console.warn('âš ï¸ å®æ—¶è¿æ¥é—®é¢˜');
			}
		};
	}

	// ğŸ’¡ æˆ¿é—´ç±»å‹æ•°æ®åº“åŒæ­¥å‡½æ•°
	async function syncRoomTypeToDatabase(roomName, pianoType) {
		if (!supabaseReady || !supabaseClient) {
			throw new Error('Supabaseæœªå°±ç»ª');
		}
		
		try {
			logInfo(`ğŸ”„ å¼€å§‹åŒæ­¥æˆ¿é—´ç±»å‹åˆ°æ•°æ®åº“: ${roomName} -> ${pianoType}`);
			
			// æ›´æ–°room_databaseè¡¨ä¸­çš„é’¢ç´ç±»å‹å­—æ®µ
			const { data, error } = await supabaseClient
				.from('room_database')
				.update({ 
					piano_type: pianoType,
					updated_at: new Date().toISOString()
				})
				.eq('name', roomName)
				.select(); // æ·»åŠ select()ä»¥è·å–æ›´æ–°åçš„æ•°æ®
				
			if (error) {
				throw error;
			}
			
			// ğŸ”§ åŒæ­¥æ›´æ–°æœ¬åœ°Store.roomsï¼Œé˜²æ­¢æ—§æ•°æ®æ±¡æŸ“äº‘ç«¯
			if (Store.rooms[roomName]) {
				Store.rooms[roomName].pianoType = pianoType;
				Store.rooms[roomName].piano_type = pianoType; // å…¼å®¹æ—§å­—æ®µå
				logInfo(`ğŸ”„ å·²åŒæ­¥æ›´æ–°æœ¬åœ° Store.rooms['${roomName}'].pianoType`);
			}
			
			logInfo(`âœ… æˆ¿é—´ç±»å‹å·²æˆåŠŸåŒæ­¥åˆ°æ•°æ®åº“ï¼š${roomName} -> ${pianoType}`);
			logInfo(`ğŸ“Š æ•°æ®åº“è¿”å›:`, data);
			
		} catch (error) {
			logErr(`âŒ æˆ¿é—´ç±»å‹æ•°æ®åº“åŒæ­¥å¤±è´¥ ${roomName}:`, error.message);
			throw error;
		}
	}

	// ğŸ’¡ æ‰‹åŠ¨è§¦å‘å­¦ç”Ÿåº“å¢é‡åŒæ­¥çš„ä¾¿æ·å‡½æ•°
	window.syncStudentsIncremental = async function(forceFullSync = false) {
		if (!window.supabaseReady) {
			logWarn('Supabaseæœªå°±ç»ªï¼Œæ— æ³•åŒæ­¥å­¦ç”Ÿåº“');
			return { success: false, error: 'Supabase not ready' };
		}
		
		try {
			const beforeCount = (Store.students || []).length;
			const startTime = Date.now();
			
			if (forceFullSync) {
				logInfo('æ‰‹åŠ¨è§¦å‘å­¦ç”Ÿåº“å…¨é‡åŒæ­¥');
				await fetchStudents({ forceFullSync: true });
			} else {
				const lastSyncTime = window.__studentLastSyncTime;
				if (lastSyncTime) {
					logInfo(`æ‰‹åŠ¨è§¦å‘å­¦ç”Ÿåº“å¢é‡åŒæ­¥ï¼Œsince: ${lastSyncTime}`);
					await fetchStudents({ incremental: true, since: lastSyncTime });
				} else {
					logInfo('æ— ä¸Šæ¬¡åŒæ­¥æ—¶é—´è®°å½•ï¼Œæ‰§è¡Œå…¨é‡åŒæ­¥');
					await fetchStudents({ forceFullSync: true });
				}
			}
			
			const afterCount = (Store.students || []).length;
			const duration = Date.now() - startTime;
			const result = {
				success: true,
				beforeCount,
				afterCount,
				changed: afterCount !== beforeCount,
				duration,
				syncType: forceFullSync ? 'å…¨é‡' : 'å¢é‡',
				lastSyncTime: window.__studentLastSyncTime
			};
			
			logInfo(`å­¦ç”Ÿåº“åŒæ­¥å®Œæˆ: ${result.syncType}, ${beforeCount}â†’${afterCount}, è€—æ—¶${duration}ms`);
			return result;
		} catch (error) {
			logErr('å­¦ç”Ÿåº“åŒæ­¥å¤±è´¥:', error.message);
			return { success: false, error: error.message };
		}
	};

	// ğŸ’¡ æŸ¥çœ‹å­¦ç”Ÿåº“åŒæ­¥ç»Ÿè®¡ä¿¡æ¯
	window.getStudentSyncStats = function() {
		const stats = window.__studentSyncStats || { totalSyncs: 0, incrementalSyncs: 0, totalRecords: 0 };
		const lastSyncTime = window.__studentLastSyncTime;
		const currentCount = (Store.students || []).length;
		
		const result = {
			...stats,
			fullSyncs: stats.totalSyncs - stats.incrementalSyncs,
			incrementalRatio: stats.totalSyncs > 0 ? (stats.incrementalSyncs / stats.totalSyncs * 100).toFixed(1) + '%' : '0%',
			avgRecordsPerSync: stats.totalSyncs > 0 ? Math.round(stats.totalRecords / stats.totalSyncs) : 0,
			lastSyncTime,
			currentStudentCount: currentCount,
			timeSinceLastSync: lastSyncTime ? Math.round((Date.now() - new Date(lastSyncTime).getTime()) / 1000) + 'ç§’å‰' : 'æœªåŒæ­¥'
		};
		
		console.table(result);
		return result;
	};

	// ğŸ’¡ æµ‹è¯•æˆ¿é—´å…ƒæ•°æ®åŒæ­¥çš„ä¾¿æ·å‡½æ•°
	window.testRoomMetaSync = async function(roomName, newRemark) {
		if (!roomName) {
			console.log('ç”¨æ³•: testRoomMetaSync("æˆ¿é—´å", "æ–°å¤‡æ³¨")');
			console.log('ç¤ºä¾‹: testRoomMetaSync("101", "æµ‹è¯•å¤‡æ³¨åŒæ­¥")');
			return;
		}
		
		const room = Store.byName.get(roomName);
		if (!room) {
			console.log(`æˆ¿é—´ ${roomName} ä¸å­˜åœ¨`);
			return { success: false, error: 'Room not found' };
		}
		
		const oldRemark = room.remark || '';
		const testRemark = newRemark || `æµ‹è¯•åŒæ­¥ ${new Date().toLocaleTimeString()}`;
		
		try {
			logInfo(`å¼€å§‹æµ‹è¯•æˆ¿é—´å…ƒæ•°æ®åŒæ­¥: ${roomName}`);
			logInfo(`åŸå¤‡æ³¨: "${oldRemark}" -> æ–°å¤‡æ³¨: "${testRemark}"`);
			
			// æ›´æ–°æœ¬åœ°
			room.remark = testRemark;
			
			// åŒæ­¥åˆ°æ•°æ®åº“
			await syncRoomRemarkToDatabase(roomName, testRemark);
			
			// åˆ·æ–°æ˜¾ç¤º
			setTimeout(() => {
				renderRoomCard(roomName);
			}, 100);
			
			const result = {
				success: true,
				roomName,
				oldRemark,
				newRemark: testRemark,
				message: 'æˆ¿é—´å¤‡æ³¨å·²æ›´æ–°ï¼Œå…¶ä»–è®¾å¤‡åº”è¯¥èƒ½çœ‹åˆ°å˜åŒ–'
			};
			
			console.log('âœ… æˆ¿é—´å…ƒæ•°æ®åŒæ­¥æµ‹è¯•å®Œæˆ:', result);
			return result;
			
		} catch (error) {
			logErr('æˆ¿é—´å…ƒæ•°æ®åŒæ­¥æµ‹è¯•å¤±è´¥:', error.message);
			// æ¢å¤åŸå¤‡æ³¨
			room.remark = oldRemark;
			renderRoomCard(roomName);
			
			return { success: false, error: error.message };
		}
	};

	// ğŸ’¡ æµ‹è¯•æˆ¿é—´ç±»å‹åŒæ­¥çš„ä¾¿æ·å‡½æ•°
	window.testRoomTypeSync = async function(roomName, newType) {
		if (!roomName) {
			console.log('ç”¨æ³•: testRoomTypeSync("æˆ¿é—´å", "æ–°ç±»å‹")');
			console.log('ç¤ºä¾‹: testRoomTypeSync("101", "ä¸‰è§’é’¢ç´")');
			console.log('æ”¯æŒçš„ç±»å‹: "ä¸‰è§’é’¢ç´", "ç«‹å¼é’¢ç´", "å…¶ä»–"');
			return;
		}
		
		const room = Store.byName.get(roomName);
		if (!room) {
			console.log(`æˆ¿é—´ ${roomName} ä¸å­˜åœ¨`);
			return { success: false, error: 'Room not found' };
		}
		
		const oldType = room.pianoType || '';
		let pianoType = newType;
		
		// æ™ºèƒ½ç±»å‹åŒ¹é…
		if (!pianoType) {
			// å¾ªç¯åˆ‡æ¢ç±»å‹ç”¨äºæµ‹è¯•
			if (/ä¸‰è§’/.test(oldType)) {
				pianoType = 'ç«‹å¼é’¢ç´';
			} else if (/ç«‹å¼/.test(oldType)) {
				pianoType = 'å…¶ä»–';
			} else {
				pianoType = 'ä¸‰è§’é’¢ç´';
			}
		}
		
		try {
			logInfo(`å¼€å§‹æµ‹è¯•æˆ¿é—´ç±»å‹åŒæ­¥: ${roomName}`);
			logInfo(`åŸç±»å‹: "${oldType}" -> æ–°ç±»å‹: "${pianoType}"`);
			
			// æ›´æ–°æœ¬åœ°
			room.pianoType = pianoType;
			
			// åŒæ­¥åˆ°æ•°æ®åº“
			await syncRoomTypeToDatabase(roomName, pianoType);
			
			// åˆ·æ–°æ˜¾ç¤º
			setTimeout(() => {
				renderRoomCard(roomName);
			}, 100);
			
			const result = {
				success: true,
				roomName,
				oldType,
				newType: pianoType,
				message: 'æˆ¿é—´ç±»å‹å·²æ›´æ–°ï¼Œå…¶ä»–è®¾å¤‡åº”è¯¥èƒ½çœ‹åˆ°å˜åŒ–'
			};
			
			console.log('âœ… æˆ¿é—´ç±»å‹åŒæ­¥æµ‹è¯•å®Œæˆ:', result);
			return result;
			
		} catch (error) {
			logErr('æˆ¿é—´ç±»å‹åŒæ­¥æµ‹è¯•å¤±è´¥:', error.message);
			// æ¢å¤åŸçŠ¶æ€
			room.pianoType = oldType;
			renderRoomCard(roomName);
			
			return { success: false, error: error.message };
		}
	};

	// ğŸ’¡ æµ‹è¯•æˆ¿é—´é‡å‘½ååŒæ­¥çš„ä¾¿æ·å‡½æ•°
	window.testRoomRenameSync = async function(oldName, newName) {
		if (!oldName || !newName) {
			console.log('ç”¨æ³•: testRoomRenameSync("æ—§åç§°", "æ–°åç§°")');
			console.log('ç¤ºä¾‹: testRoomRenameSync("101", "101A")');
			return;
		}
		
		const room = Store.byName.get(oldName);
		if (!room) {
			console.log(`æˆ¿é—´ ${oldName} ä¸å­˜åœ¨`);
			return { success: false, error: 'Room not found' };
		}
		
		if (Store.byName.has(newName)) {
			console.log(`æˆ¿é—´åç§° ${newName} å·²å­˜åœ¨`);
			return { success: false, error: 'Name already exists' };
		}
		
		try {
			logInfo(`ğŸ§ª å¼€å§‹æµ‹è¯•æˆ¿é—´é‡å‘½ååŒæ­¥: ${oldName} -> ${newName}`);
			
			// 1. æ›´æ–°æœ¬åœ°Storeå’Œç´¢å¼•
			Store.byName.delete(oldName);
			room.name = newName;
			Store.byName.set(newName, room);
			
			// 2. åŒæ­¥åˆ°æ•°æ®åº“
			await syncRoomNameToDatabase(oldName, newName);
			
			// 3. å¼ºåˆ¶åˆ·æ–°UI
			setTimeout(() => {
				const grid = document.getElementById('roomGrid');
				const oldEl = grid.querySelector(`[data-room='${CSS.escape(oldName)}']`);
				if (oldEl) {
					oldEl.remove();
				}
				renderRoomCardForced(newName);
				renderRooms();
			}, 100);
			
			const result = {
				success: true,
				oldName,
				newName,
				message: 'æˆ¿é—´é‡å‘½åå·²å®Œæˆï¼Œå…¶ä»–è®¾å¤‡åº”è¯¥èƒ½çœ‹åˆ°å˜åŒ–'
			};
			
			console.log('âœ… æˆ¿é—´é‡å‘½ååŒæ­¥æµ‹è¯•å®Œæˆ:', result);
			return result;
			
		} catch (error) {
			logErr('æˆ¿é—´é‡å‘½ååŒæ­¥æµ‹è¯•å¤±è´¥:', error.message);
			// æ¢å¤åŸçŠ¶æ€
			Store.byName.delete(newName);
			room.name = oldName;
			Store.byName.set(oldName, room);
			renderRoomCardForced(oldName);
			
			return { success: false, error: error.message };
		}
	};

	// ğŸ’¡ æ£€æŸ¥æˆ¿é—´å…ƒæ•°æ®å®æ—¶åŒæ­¥çŠ¶æ€çš„è°ƒè¯•å‡½æ•°
	window.checkRoomMetaSync = function() {
		const status = {
			supabaseReady: !!window.supabaseReady,
			supabaseClient: !!window.supabaseClient,
			roomMetaRealtimeInit: !!window.__roomMetaRealtimeInit,
			roomMetaRealtimeConnected: !!window.__roomMetaRealtimeConnected,
			roomsRealtimeInit: !!window.__roomsRealtimeInit,
			roomsRealtimeConnected: !window.__roomsRealtimeReconnecting
		};
		
		console.log('ğŸ” æˆ¿é—´ä¿¡æ¯åŒæ­¥çŠ¶æ€æ£€æŸ¥:');
		console.table(status);
		
		if (!status.supabaseReady) {
			console.warn('âš ï¸ Supabaseæœªå°±ç»ªï¼Œè¯·ç­‰å¾…è¿æ¥');
		} else if (!status.roomMetaRealtimeInit) {
			console.warn('âš ï¸ æˆ¿é—´å…ƒæ•°æ®å®æ—¶è®¢é˜…æœªåˆå§‹åŒ–');
		} else if (!status.roomMetaRealtimeConnected) {
			console.warn('âš ï¸ æˆ¿é—´å…ƒæ•°æ®å®æ—¶è®¢é˜…æœªè¿æ¥');
		} else if (!status.roomsRealtimeInit) {
			console.warn('âš ï¸ æˆ¿é—´çŠ¶æ€å®æ—¶è®¢é˜…æœªåˆå§‹åŒ–');
		} else if (!status.roomsRealtimeConnected) {
			console.warn('âš ï¸ æˆ¿é—´çŠ¶æ€å®æ—¶è®¢é˜…è¿æ¥å¼‚å¸¸');
		} else {
			console.log('âœ… æˆ¿é—´ä¿¡æ¯å®æ—¶åŒæ­¥å·¥ä½œæ­£å¸¸');
			console.log('ğŸ“ æ”¯æŒçš„åŠŸèƒ½: å¤‡æ³¨ä¿®æ”¹ã€ç±»å‹åˆ‡æ¢ã€æˆ¿é—´é‡å‘½å');
		}
		
		return status;
	};

	// å…¨å±€æ“ä½œæ—¶é—´è¿½è¸ªï¼Œç”¨äºä¼˜åŒ–CASç‰ˆæœ¬æ£€æŸ¥
	window.__lastRoomOperationTime = 0;

	/*************************************************
	 * âš™ï¸ æ–°ç‰ˆç»Ÿä¸€ç‰ˆæœ¬åŒæ­¥ä¸CASç®¡ç†æ¡†æ¶ (Phase 1 Skeleton)
	 * Feature Flag: window.__NEW_CAS_ENABLED = true/false
	 * ä»…æ³¨å…¥ï¼Œä¸ç«‹å³å¼ºåˆ¶æ›¿æ¢åŸ assign/clear/transferï¼Œåç»­é€æ­¥æ¥å…¥ã€‚
	 *************************************************/
	if (window.__NEW_CAS_ENABLED === undefined) {
		window.__NEW_CAS_ENABLED = true; // é»˜è®¤å¼€å¯ï¼Œå¯è¿è¡Œæ—¶å…³é—­å›é€€æ—§é€»è¾‘
	}

	(function initVersionSyncManager(){
		if (window.VersionSyncManager) return; // é¿å…é‡å¤æ³¨å…¥

		const LOG_PREFIX = '[VSM]';
		const OP_STATE = { PENDING:'pending', APPLYING:'applying', CONFIRMING:'confirming', DONE:'done', FAILED:'failed', CANCELLED:'cancelled'};

		function now(){ return Date.now(); }
		function jitter(base, span){ return base + Math.floor(Math.random()*span - span/2); }

		class VersionSyncManager {
			constructor(){
				this.remoteVersionCache = new Map(); // name -> {version, occupant, ts}
				this.activeOps = new Map(); // opKey -> opContext
				this.recentTransfers = []; // ring buffer for ping-pong detection
				this.metrics = { attempts:0, conflicts:0, tolerableAbsorb:0, softRetry:0, fatal:0 };
				this.maxRecentTransfers = 20;
				this.versionToleranceBase = 0; // é»˜è®¤ä¸¥æ ¼
				this.versionToleranceFast = 2; // ping-pong æ”¾å®½
			}

			registerRealtimeRoom(room){
				if(!room || !room.name) return;
				this.remoteVersionCache.set(room.name, { version: room.version||0, occupant: room.occupant_student_name||null, ts: now() });
			}

			updateFromSnapshot(list){
				if(!Array.isArray(list)) return;
				for(const r of list){ this.registerRealtimeRoom(r); }
			}

			makeOpKey(scenario, meta){
				// meta å¯åŒ…å« student / from / to / room
				return [scenario, meta.student||'', meta.from||'', meta.to||meta.room||''].join('#');
			}

			beginOperation(opts){
				const { scenario, meta } = opts;
				const key = this.makeOpKey(scenario, meta);
				let ctx = this.activeOps.get(key);
				if(ctx){
					console.debug(LOG_PREFIX,'å¤ç”¨è¿›è¡Œä¸­æ“ä½œ',key);
					return ctx;
				}
				ctx = { key, id: key+'@'+now(), scenario, meta, state: OP_STATE.PENDING, attempt:0, createdAt: now(), fastMode:false, retries:0, logs:[], cancelled:false };
				this.activeOps.set(key, ctx);
				return ctx;
			}

			finishOperation(ctx, finalState){
				ctx.state = finalState;
				setTimeout(()=>{ this.activeOps.delete(ctx.key); }, 1500); // å»¶è¿Ÿç§»é™¤ä¾¿äºæŸ¥çœ‹æ—¥å¿—
			}

			recordTransfer(meta){
				this.recentTransfers.push({ ts: now(), student: meta.student, from: meta.from, to: meta.to });
				if(this.recentTransfers.length>this.maxRecentTransfers) this.recentTransfers.shift();
			}

			isPingPong(meta, windowMs=5000){
				if(!meta.student || !meta.from || !meta.to) return false;
				const cutoff = now()-windowMs;
				// åœ¨æœ€è¿‘è®°å½•ä¸­æŸ¥æ‰¾ A->B åˆšå‘ç”Ÿï¼Œåˆè¦ B->A
				for(let i=this.recentTransfers.length-1;i>=0;i--){
					const r=this.recentTransfers[i];
					if(r.ts<cutoff) break;
					if(r.student===meta.student && r.from===meta.to && r.to===meta.from) return true;
				}
				return false;
			}

			classifyVersion(localV, remoteV, tolerance){
				if(remoteV===undefined || remoteV===null) return { severity:'fatal', diff:Infinity };
				if(localV===remoteV) return { severity:'match', diff:0 };
				const diff = Math.abs(remoteV-localV);
				if(diff<=tolerance) return { severity:'tolerable', diff };
				return { severity:'conflict', diff };
			}

			async awaitFresh(rooms, opts={ timeout:600, requireVersions:{} }){
				// è½®è¯¢ remoteVersionCache æ˜¯å¦å·² >= requireVersions
				const start=now();
				while(now()-start < opts.timeout){
					let allOk=true;
					for(const name of rooms){
						const need = opts.requireVersions[name];
						if(need===undefined) continue;
						const cached = this.remoteVersionCache.get(name);
						if(!cached || cached.version < need){ allOk=false; break; }
					}
					if(allOk) return true;
					await new Promise(r=>setTimeout(r,50));
				}
				return false;
			}

			scheduleRetry(ctx, fn, baseDelay){
				ctx.retries++;
				if(ctx.retries>4){
					console.warn(LOG_PREFIX,'æ”¾å¼ƒé‡è¯•',ctx.key);
					this.finishOperation(ctx, OP_STATE.FAILED);
					toast('æ“ä½œå¤šæ¬¡å†²çªï¼Œè¯·ç¨åå†è¯•','warn');
					return;
				}
				const delay = jitter(baseDelay * Math.pow(2, ctx.retries-1), 120);
				console.log(LOG_PREFIX,'è®¡åˆ’é‡è¯•',ctx.key,'in',delay,'ms (#'+ctx.retries+')');
				setTimeout(()=>{ if(!ctx.cancelled) fn(); }, delay);
			}
		}

		window.VersionSyncManager = new VersionSyncManager();
		console.log(LOG_PREFIX,'initialized');
	})();

	/**
	 * performCasOperation(options)
	 * åˆæ­¥éª¨æ¶ï¼šä»…åšåˆ†ç±»ä¸ç¤ºæ„ï¼Œåç»­é€æ­¥è¿ç§» assign/clear/transfer å†…éƒ¨é€»è¾‘ä½¿ç”¨ã€‚
	 */
	async function performCasOperation(options){
		if(!window.__NEW_CAS_ENABLED){
			return { skipped:true, reason:'feature-flag-off' };
		}
		const mgr = window.VersionSyncManager;
		const { scenario, meta={}, rooms=[], action, toleranceProfile } = options;
		const ctx = mgr.beginOperation({ scenario, meta });
		ctx.state = 'precheck';

		// Ping-Pong æ£€æµ‹
		if(scenario==='transfer'){
			mgr.recordTransfer(meta);
			if(mgr.isPingPong(meta)){ ctx.fastMode=true; }
		}

		const tolerance = ctx.fastMode ? (toleranceProfile?.fast ?? mgr.versionToleranceFast) : (toleranceProfile?.base ?? mgr.versionToleranceBase);

		// æ”¶é›†æœ¬åœ°&ç¼“å­˜ç‰ˆæœ¬
		const versionComparisons = [];
		for(const r of rooms){
			const local = Store.byName?.get(r.name) || Store.rooms.find(x=>x.name===r.name);
			const cached = mgr.remoteVersionCache.get(r.name);
			const localV = local? (local.version||0):0;
			const remoteV = cached? cached.version: localV; // è‹¥æ— ç¼“å­˜å…ˆå‡å®šä¸€è‡´
			const cls = mgr.classifyVersion(localV, remoteV, tolerance);
			versionComparisons.push({ name:r.name, localV, remoteV, cls });
		}

		// åˆ¤æ–­æ˜¯å¦æœ‰ fatal / conflict éœ€è¦åˆ·æ–°
		let hasConflict=false, hasFatal=false;
		for(const vc of versionComparisons){
			if(vc.cls.severity==='fatal'){ hasFatal=true; break; }
			if(vc.cls.severity==='conflict') hasConflict=true;
			if(vc.cls.severity==='tolerable'){
				// å¸æ”¶ï¼šåŒæ­¥æœ¬åœ°ç‰ˆæœ¬ï¼ˆä»…æ—¥å¿—ï¼ŒçœŸæ­£ patch åç»­å¯ä»¥æ‹‰æœ€æ–°ï¼‰
				console.log('[VSM] å¸æ”¶è½»å¾®ç‰ˆæœ¬å·®',vc.name,'local',vc.localV,'remote',vc.remoteV,'diff',vc.cls.diff);
			}
		}
		if(hasFatal){
			mgr.finishOperation(ctx, 'failed');
			return { ok:false, reason:'fatal-precheck' };
		}
		if(hasConflict){
			// Phase1 ç®€åŒ–ï¼šç«‹å³ä¸€æ¬¡æ€§åˆ·æ–°è¿™äº›æˆ¿é—´å†é‡æ–°æ‰§è¡Œä¸€æ¬¡ï¼ˆä¸é€’å½’ï¼‰
			console.log('[VSM] å‘ç°å†²çª: åˆ·æ–°å¹¶é‡è¯•(ä¸€æ¬¡)', versionComparisons.filter(v=>v.cls.severity==='conflict').map(v=>v.name));
			if(!ctx._conflictRefreshed){
				ctx._conflictRefreshed=true;
				const names = versionComparisons.filter(v=>v.cls.severity==='conflict').map(v=>v.name);
				try {
					const { data, error } = await supabaseClient.from('rooms').select('name,occupant_student_name,version,register_time').in('name', names);
					if(!error && data){
						for(const r of data){
							mgr.registerRealtimeRoom(r);
							const idx = Store.rooms.findIndex(x=>x.name===r.name);
							if(idx>=0){ Store.rooms[idx] = { ...Store.rooms[idx], version:r.version, occupant_student_name:r.occupant_student_name, register_time:r.register_time }; }
							renderRoomCardForced?.(r.name);
						}
					}
				}catch(e){ console.warn('[VSM] å†²çªåˆ·æ–°å¤±è´¥', e); }
				return performCasOperation(options); // å•æ¬¡é€’å½’
			}
		}

		ctx.state='applying';
		let actionResult;
		try {
			actionResult = await action(ctx);
		}catch(e){
			console.warn('[VSM] action æ‰§è¡Œå¼‚å¸¸',e);
			mgr.finishOperation(ctx,'failed');
			return { ok:false, error:e };
		}

		ctx.state='confirming';
		// Confirm Phase (Phase2): æ‹‰å–æœ€æ–°çŠ¶æ€æ ¡éªŒ occupant/version ä¸€è‡´æ€§
		// å¢åŠ æ™ºèƒ½å®¹é”™ï¼šç‰ˆæœ¬å·®=1ä¸”æ“ä½œåˆšå®Œæˆæ—¶å»¶è¿ŸäºŒæ¬¡ç¡®è®¤ï¼Œé¿å…ä¼ æ’­å»¶è¿Ÿè¯¯æŠ¥
		try {
			const needCheckNames = rooms.map(r=>r.name);
			let freshMap = new Map();
			if(supabaseReady && needCheckNames.length){
				const { data:freshList, error:freshErr } = await supabaseClient
					.from('rooms')
					.select('name,occupant_student_name,version,register_time,updated_at')
					.in('name', needCheckNames);
				if(!freshErr && freshList){
					for(const r of freshList){
						freshMap.set(r.name, r);
						mgr.registerRealtimeRoom(r);
					}
				}
			}
			let mismatches=[];
			for(const rc of rooms){
				const local = Store.byName?.get(rc.name) || Store.rooms.find(x=>x.name===rc.name);
				const fresh = freshMap.get(rc.name);
				if(!fresh || !local) continue;
				const localV = local.version||0, remoteV = fresh.version||0;
				const vDiff = Math.abs(localV - remoteV);
				
				// æ™ºèƒ½ç‰ˆæœ¬å·®å¼‚å®¹é”™ï¼šç‰ˆæœ¬å·®=1æ—¶éƒ½å¯èƒ½æ˜¯ä¼ æ’­å»¶è¿Ÿï¼Œå»¶è¿Ÿé‡æ£€
				if(localV !== remoteV){
					const firstAttemptTime = ctx._firstConfirmAttemptAt || (ctx._firstConfirmAttemptAt = Date.now());
					const timeSinceFirst = Date.now() - firstAttemptTime;
					
					// å¦‚æœç‰ˆæœ¬å·®=1ï¼Œä¸”åœ¨400mså†…ï¼Œå»¶è¿Ÿåé‡æ£€ä¸€æ¬¡ï¼ˆä¸è®ºè°é¢†å…ˆï¼‰
					if(vDiff === 1 && timeSinceFirst < 400 && !ctx._retryConfirm){
						console.log(`[VSM] ç‰ˆæœ¬ä¼ æ’­å»¶è¿Ÿé‡æ£€: ${rc.name} local=${localV} remote=${remoteV}, å»¶è¿Ÿ180msåé‡è¯•`);
						ctx._retryConfirm = true;
						await new Promise(r => setTimeout(r, 180));
						// é‡æ–°è·å–ä¸€æ¬¡
						const { data: retryList } = await supabaseClient
							.from('rooms')
							.select('name,occupant_student_name,version,register_time,updated_at')
							.in('name', [rc.name]);
						if(retryList?.[0]){
							const retryFresh = retryList[0];
							freshMap.set(rc.name, retryFresh);
							mgr.registerRealtimeRoom(retryFresh);
							// ç”¨é‡æ£€åçš„ç‰ˆæœ¬ç»§ç»­æ¯”è¾ƒ
							const retryRemoteV = retryFresh.version||0;
							if(localV !== retryRemoteV){
								mismatches.push({ name:rc.name, type:'version', localV, remoteV:retryRemoteV, occupant_local: local.occupant_student_name, occupant_remote: retryFresh.occupant_student_name });
							}
						} else {
							mismatches.push({ name:rc.name, type:'version', localV, remoteV, occupant_local: local.occupant_student_name, occupant_remote: fresh.occupant_student_name });
						}
					} else {
						mismatches.push({ name:rc.name, type:'version', localV, remoteV, occupant_local: local.occupant_student_name, occupant_remote: fresh.occupant_student_name });
					}
				}
				
				// occupant mismatch after action: æ ¹æ®åœºæ™¯åšæœ€å°ä¿®æ­£
				const currentFresh = freshMap.get(rc.name); // å¯èƒ½æ˜¯é‡æ£€åçš„
				if(scenario==='assign' && rc.role==='single'){
					// æœŸæœ›å ç”¨ meta.student
					if(currentFresh.occupant_student_name !== meta.student){
						mismatches.push({ name:rc.name, type:'occupant', expected: meta.student, got: currentFresh.occupant_student_name });
					}
				} else if(scenario==='clear' && rc.role==='single'){
					if(currentFresh.occupant_student_name){
						mismatches.push({ name:rc.name, type:'occupant', expected: null, got: currentFresh.occupant_student_name });
					}
				} else if(scenario==='transfer'){
					if(rc.role==='from' && currentFresh.occupant_student_name){
						mismatches.push({ name:rc.name, type:'occupant', expected:null, got:currentFresh.occupant_student_name });
					}
					if(rc.role==='to' && currentFresh.occupant_student_name!==meta.student){
						mismatches.push({ name:rc.name, type:'occupant', expected:meta.student, got:currentFresh.occupant_student_name });
					}
				}
			}
			if(mismatches.length){
				// åŒºåˆ†ç‰ˆæœ¬å·®å¼‚çš„ä¸¥é‡ç¨‹åº¦ï¼šâ‰¤2 è§†ä¸ºåŒæ­¥å»¶è¿Ÿï¼Œ>2 æˆ–å ç”¨è€…å†²çªæ‰è­¦å‘Š
				const criticalMismatches = mismatches.filter(m => 
					m.type==='occupant' || (m.type==='version' && Math.abs(m.localV - m.remoteV) > 2)
				);
				const minorVersionDiffs = mismatches.filter(m => 
					m.type==='version' && Math.abs(m.localV - m.remoteV) <= 2
				);
				
				// åªå¯¹å…³é”®ä¸ä¸€è‡´è¾“å‡ºè­¦å‘Š
				if(criticalMismatches.length > 0){
					const details = criticalMismatches.map(m => 
						m.type==='version' ? `${m.name}:ä¸¥é‡ç‰ˆæœ¬å·®å¼‚ local=${m.localV} remote=${m.remoteV}` :
						`${m.name}:å ç”¨è€…å†²çª æœŸæœ›=${m.expected||'ç©º'} å®é™…=${m.got||'ç©º'}`
					).join(' | ');
					console.warn(`[VSM] ç¡®è®¤é˜¶æ®µå‘ç°å…³é”®ä¸ä¸€è‡´: ${details}`);
				}
				
				// è½»å¾®ç‰ˆæœ¬å·®å¼‚åªåœ¨ debug æ¨¡å¼è¾“å‡º
				if(minorVersionDiffs.length > 0 && window.__VSM_DEBUG){
					const details = minorVersionDiffs.map(m => 
						`${m.name}:è½»å¾®ç‰ˆæœ¬å·®å¼‚ local=${m.localV} remote=${m.remoteV}`
					).join(' | ');
					console.debug(`[VSM] è½»å¾®ç‰ˆæœ¬å·®å¼‚å·²è‡ªåŠ¨ä¿®å¤: ${details}`);
				}
				
				// å±€éƒ¨ reconcileï¼šç›´æ¥é‡‡ç”¨è¿œç«¯ä¸ºå‡†åˆ·æ–°æœ¬åœ°
				for(const m of mismatches){
					const fresh = freshMap.get(m.name); if(!fresh) continue;
					const idx = Store.rooms.findIndex(r=>r.name===m.name);
					if(idx>=0){
						Store.rooms[idx] = { ...Store.rooms[idx], version:fresh.version, occupant_student_name:fresh.occupant_student_name, register_time:fresh.register_time };
						if(typeof rebuildIndexes==='function') rebuildIndexes();
						renderRoomCardForced?.(m.name);
					}
				}
				updateUsageStats?.();
				// åªæœ‰å…³é”®ä¸šåŠ¡å†²çªæ‰ toast
				if(criticalMismatches.length > 0){
					toast('å·²è‡ªåŠ¨åŒæ­¥æœ€æ–°æˆ¿é—´çŠ¶æ€','info');
				}
				mgr.finishOperation(ctx,'done');
				return { ok:true, result:actionResult, reconciled:true, mismatches };
			}
		}catch(confirmErr){
			console.warn('[VSM] confirm é˜¶æ®µå¼‚å¸¸', confirmErr);
		}
		mgr.finishOperation(ctx,'done');
		return { ok:true, result:actionResult };
	}
	
	// CASæ“ä½œé—´éš”æ£€æµ‹å’Œè‡ªåŠ¨é‡è¯•è¾…åŠ©å‡½æ•°
	async function waitForRealtimeSync(opts = {}) {
		const timeSinceLastOp = Date.now() - (window.__lastRoomOperationTime || 0);
		
		// æ”¯æŒè‡ªå®šä¹‰timeoutï¼Œä¼˜å…ˆçº§æœ€é«˜
		if (opts.timeout !== undefined) {
			if (timeSinceLastOp < opts.timeout) {
				const waitTime = opts.timeout - timeSinceLastOp;
				console.log(`[Sync] ç­‰å¾… Realtime åŒæ­¥: ${waitTime}ms (è‡ªå®šä¹‰)`);
				await new Promise(resolve => setTimeout(resolve, waitTime));
			}
			return;
		}
		
		// å¦‚æœå‘ç”Ÿäº†ç‰ˆæœ¬å†²çªï¼Œéœ€è¦æ›´é•¿çš„åŒæ­¥æ—¶é—´
		const minWaitTime = opts.afterVersionConflict ? 1500 : 1000;
		
		if (timeSinceLastOp < minWaitTime) {
			const waitTime = Math.min(opts.afterVersionConflict ? 800 : 500, minWaitTime - timeSinceLastOp);
			console.log(`[Sync] ç­‰å¾… Realtime åŒæ­¥: ${waitTime}ms ${opts.afterVersionConflict ? '(ç‰ˆæœ¬å†²çªå)' : ''}`);
			await new Promise(resolve => setTimeout(resolve, waitTime));
		}
	}
	
	function createOptimizedToast(roomName, operation) {
		const messages = {
			'assign': `${roomName} æ•°æ®æ­£åœ¨åŒæ­¥ä¸­ï¼Œè¯·ç¨åé‡è¯•`,
			'clear': `${roomName} çŠ¶æ€æ­£åœ¨æ›´æ–°ï¼Œè¯·ç¨åé‡è¯•`, 
			'transfer': `æˆ¿é—´è½¬ç§»æ•°æ®åŒæ­¥ä¸­ï¼Œè¯·ç¨åé‡è¯•`,
			'renew': `${roomName} ç»­çº¦æ•°æ®åŒæ­¥ä¸­ï¼Œè¯·ç¨åé‡è¯•`
		};
		toast(messages[operation] || `${roomName} æ•°æ®åŒæ­¥ä¸­ï¼Œè¯·ç¨åé‡è¯•`, 'info');
	}

	/*************************************************
	 * å‘¨æœŸæ€§ Reconcile ä»»åŠ¡ (åŸºç¡€ç‰ˆ)
	 * - å®šæœŸæ‰«æå½“å‰å¯è§æˆ¿é—´ï¼ŒéšæœºæŠ½æ ·å°‘é‡ï¼ˆé™ä½å‹åŠ›ï¼‰éªŒè¯ç‰ˆæœ¬å¹¶åˆ·æ–° VSM ç¼“å­˜
	 * - åç»­å¯æ ¹æ®æ´»è·ƒåº¦/æœ€è¿‘æ“ä½œä¼˜å…ˆçº§æ’åº
	 *************************************************/
	if(!window.__ROOM_RECONCILE_LOOP){
		window.__ROOM_RECONCILE_LOOP = true;
		const LOOP_INTERVAL = 8000; // 8s ä¸€æ¬¡è½»é‡æ£€æŸ¥
		async function reconcileLoop(){
			try {
				if(!supabaseReady || !Store?.rooms?.length){ return; }
				// æŠ½æ ·ï¼šæŒ‰æœ€è¿‘æ“ä½œä¼˜å…ˆï¼Œå°† occupied åœ¨å‰ï¼Œå–å‰ 6 ä¸ª
				const sample = [...Store.rooms]
					.sort((a,b)=>{
						const ao = a.occupant_student_name?1:0; const bo = b.occupant_student_name?1:0;
						return bo-ao; // occupied first
					})
					.slice(0,6)
					.map(r=>r.name);
				if(!sample.length) return;
				const { data, error } = await supabaseClient
					.from('rooms')
					.select('name,occupant_student_name,version,register_time,updated_at')
					.in('name', sample);
				if(!error && data){
					for(const r of data){
						window.VersionSyncManager?.registerRealtimeRoom(r);
						const local = Store.rooms.find(x=>x.name===r.name);
						if(local && (local.version||0) !== (r.version||0)){
							// é™é»˜åŒæ­¥ç‰ˆæœ¬å·®å¼‚ï¼ˆä¸ toastï¼‰
							local.version = r.version||0;
							local.occupant_student_name = r.occupant_student_name||null;
							local.register_time = r.register_time||null;
							renderRoomCardForced?.(r.name);
						}
					}
				}
			}catch(e){ console.debug('[ReconcileLoop] error', e.message); }
			finally { setTimeout(reconcileLoop, LOOP_INTERVAL); }
		}
		setTimeout(reconcileLoop, 4000); // å¯åŠ¨å‰å»¶è¿Ÿ
	}

	/*************************************************
	 * æ—¥å¿—é™å™ªå¼€å…³ï¼ˆåŸºç¡€ï¼‰
	 *************************************************/
	if(window.__LOG_NOISE_REDUCE===undefined){ window.__LOG_NOISE_REDUCE = true; }
	if(window.__LOG_NOISE_REDUCE){
		const rawWarn = console.warn;
		console.warn = function(...args){
			if(typeof args[0]==='string' && /ç‰ˆæœ¬ä¸åŒ¹é…|version mismatch/i.test(args[0])){
				// è¿‡æ»¤é¢‘ç¹ version mismatch è­¦å‘Š: é‡‡æ ·æ‰“å°
				if(Math.random()<0.35){ rawWarn.apply(console,args); }
				return;
			}
			rawWarn.apply(console,args);
		};
	}
	
	async function retryRoomOperation(operationFn, operationName, ...args) {
		const result = await operationFn(...args);
		if (result && result.stale && !args[args.length - 1]?.isRetry) {
			console.log(`[CAS] ${operationName} ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œ1ç§’åè‡ªåŠ¨é‡è¯•`);
			setTimeout(async () => {
				const retryArgs = [...args];
				if (typeof retryArgs[retryArgs.length - 1] === 'object') {
					retryArgs[retryArgs.length - 1].isRetry = true;
				} else {
					retryArgs.push({ isRetry: true });
				}
				await operationFn(...retryArgs);
			}, 1000);
		}
		return result;
	}
	
	// æŠ¥å‘Šæ‰€æœ‰å·²ä¼˜åŒ–çš„æˆ¿é—´æ“ä½œ
	console.log('ğŸ¯ æˆ¿é—´æ“ä½œCASç‰ˆæœ¬å†²çªä¼˜åŒ–å·²å®Œæˆ');
	console.log('');
	console.log('âœ… å·²ä¼˜åŒ–çš„æ“ä½œå‡½æ•°:');
	console.log('  - assignRoom: ç™»è®°æˆ¿é—´');
	console.log('  - clearRoom: æ¸…ç©ºæˆ¿é—´');
	console.log('  - transferStudent: è½¬ç§»å­¦ç”Ÿ');
	console.log('  - renewRoom: ç»­çº¦æˆ¿é—´');
	console.log('');
	console.log('ğŸ›¡ï¸ ä¸‰é‡ä¿æŠ¤æœºåˆ¶:');
	console.log('  1. æ“ä½œé—´éš”æ£€æµ‹: è¿ç»­æ“ä½œæ—¶ç­‰å¾…RealtimeåŒæ­¥');
	console.log('  2. ä¼˜åŒ–é”™è¯¯æç¤º: ç”¨æˆ·å‹å¥½çš„æç¤ºä¿¡æ¯');
	console.log('  3. è‡ªåŠ¨é‡è¯•æœºåˆ¶: ç‰ˆæœ¬å†²çªæ—¶è‡ªåŠ¨é‡è¯•');
	console.log('');
	console.log('ğŸ”§ ä½¿ç”¨ testCASOptimizations() æŸ¥çœ‹æµ‹è¯•å·¥å…·');

	// æµ‹è¯•CASä¼˜åŒ–åŠŸèƒ½çš„ä¾¿æ·å‡½æ•°
	window.testCASOptimizations = function() {
		console.log('ğŸ§ª CASç‰ˆæœ¬å†²çªä¼˜åŒ–æµ‹è¯•å·¥å…·');
		console.log('');
		console.log('å·²å®ç°çš„ä¼˜åŒ–åŠŸèƒ½:');
		console.log('âœ… æ–¹æ¡ˆ1: æ“ä½œé—´éš”æ£€æµ‹ - è·ç¦»ä¸Šæ¬¡æ“ä½œä¸è¶³1ç§’æ—¶ç­‰å¾…500ms');
		console.log('âœ… æ–¹æ¡ˆ2: ä¼˜åŒ–é”™è¯¯æç¤º - å‹å¥½çš„ç”¨æˆ·æç¤ºè€ŒéæŠ€æœ¯é”™è¯¯');
		console.log('âœ… æ–¹æ¡ˆ3: è‡ªåŠ¨é‡è¯•æœºåˆ¶ - ç‰ˆæœ¬ä¸åŒ¹é…æ—¶1ç§’åè‡ªåŠ¨é‡è¯•');
		console.log('');
		console.log('æ”¯æŒçš„æ“ä½œ:');
		console.log('- assignRoom (ç™»è®°)');
		console.log('- clearRoom (æ¸…ç©º)');
		console.log('- transferStudent (è½¬ç§»)');  
		console.log('- renewRoom (ç»­çº¦)');
		console.log('');
		console.log('æµ‹è¯•å‘½ä»¤:');
		console.log('testCASOptimizations.simulateConflict("æˆ¿é—´å") - æ¨¡æ‹Ÿç‰ˆæœ¬å†²çª');
		console.log('testCASOptimizations.checkStatus() - æŸ¥çœ‹ä¼˜åŒ–çŠ¶æ€');
		
		return {
			simulateConflict: function(roomName) {
				if (!roomName) {
					console.log('ç”¨æ³•: testCASOptimizations.simulateConflict("101")');
					return;
				}
				
				const room = Store.byName.get(roomName);
				if (!room) {
					console.log(`æˆ¿é—´ ${roomName} ä¸å­˜åœ¨`);
					return;
				}
				
				console.log(`ğŸ¯ æ¨¡æ‹Ÿæˆ¿é—´ ${roomName} çš„ç‰ˆæœ¬å†²çª`);
				console.log(`å½“å‰ç‰ˆæœ¬: ${room.version || 0}`);
				
				// äººä¸ºä¿®æ”¹æœ¬åœ°ç‰ˆæœ¬æ¥æ¨¡æ‹Ÿå†²çª
				const originalVersion = room.version || 0;
				room.version = originalVersion - 1;
				
				console.log(`å·²ä¿®æ”¹æœ¬åœ°ç‰ˆæœ¬ä¸º ${room.version}ï¼Œä¸‹æ¬¡æ“ä½œå°†è§¦å‘ç‰ˆæœ¬ä¸åŒ¹é…`);
				console.log(`æ‰§è¡Œä»»ä½•æ“ä½œåï¼Œæœ¬åœ°ç‰ˆæœ¬ ${room.version} ä¸è¿œç¨‹ç‰ˆæœ¬ ${originalVersion + 1} ä¸åŒ¹é…`);
				console.log('');
				console.log('ä½ ç°åœ¨å¯ä»¥å°è¯•:');
				console.log('1. æ¸…ç©ºæˆ¿é—´ - è§‚å¯Ÿä¼˜åŒ–æç¤ºå’Œè‡ªåŠ¨é‡è¯•');
				console.log('2. ç™»è®°æˆ¿é—´ - è§‚å¯Ÿä¼˜åŒ–æç¤ºå’Œè‡ªåŠ¨é‡è¯•');
				console.log('3. ç»­çº¦æˆ¿é—´ - è§‚å¯Ÿä¼˜åŒ–æç¤ºå’Œè‡ªåŠ¨é‡è¯•');
				
				return { roomName, simulatedVersion: room.version, expectedRemoteVersion: originalVersion };
			},
			
			checkStatus: function() {
				const lastOpTime = window.__lastRoomOperationTime;
				const timeSinceLastOp = lastOpTime ? Date.now() - lastOpTime : -1;
				
				console.log('ğŸ“Š CASä¼˜åŒ–çŠ¶æ€:');
				console.log(`ä¸Šæ¬¡æ“ä½œæ—¶é—´: ${lastOpTime ? new Date(lastOpTime).toLocaleTimeString() : 'æ— '}`);
				console.log(`è·ç¦»ä¸Šæ¬¡æ“ä½œ: ${timeSinceLastOp >= 0 ? Math.round(timeSinceLastOp/1000) + 'ç§’' : 'æ— è®°å½•'}`);
				console.log(`æ˜¯å¦è§¦å‘ç­‰å¾…: ${timeSinceLastOp >= 0 && timeSinceLastOp < 1000 ? 'æ˜¯(å°†ç­‰å¾…' + Math.min(500, 1000 - timeSinceLastOp) + 'ms)' : 'å¦'}`);
				
				return {
					lastOperationTime: lastOpTime,
					timeSinceLastOperation: timeSinceLastOp,
					willTriggerWait: timeSinceLastOp >= 0 && timeSinceLastOp < 1000
				};
			},
			
			testToast: function(roomName, operation) {
				if (!roomName || !operation) {
					console.log('ç”¨æ³•: testCASOptimizations.testToast("101", "assign")');
					console.log('æ”¯æŒçš„æ“ä½œ: assign, clear, transfer, renew');
					return;
				}
				
				console.log(`æµ‹è¯•ä¼˜åŒ–æç¤º: ${roomName} - ${operation}`);
				createOptimizedToast(roomName, operation);
			}
		};
	};

	async function assignRoom(roomName, student, expectedVersion, opts = {}){
		/*
		 * ç»Ÿä¸€çš„æˆ¿é—´ç™»è®°å‡½æ•°ï¼Œå†…ç½®æ—¶é—´æ®µæ£€æµ‹é€»è¾‘
		 * opts.forced = true æ—¶è·³è¿‡æ—¶é—´æ£€æµ‹ï¼ˆç”¨äºå¼ºåˆ¶ç™»è®°æˆ–ç³»ç»Ÿæ“ä½œï¼‰
		 * opts.forced = false/undefined æ—¶è¿›è¡Œæ—¶é—´æ£€æµ‹ï¼Œä¸åœ¨æ—¶æ®µæ—¶å¼¹çª—ç¡®è®¤
		 */
		// è§¦å‘å¤šè®¾å¤‡åŒæ­¥å¢å¼º
		syncEnhancer.recordUserOperation();
		
		// æ–¹æ¡ˆ1: æ“ä½œé—´éš”æ£€æµ‹ï¼Œç¡®ä¿Realtimeæ›´æ–°åˆ°è¾¾
		await waitForRealtimeSync(opts.afterVersionConflict ? { afterVersionConflict: true } : {});
		
		// ğŸ”„ æ–°ç­–ç•¥ï¼šå…è®¸ç«‹å³å°è¯•ç™»è®°ï¼›è‹¥æ£€æµ‹åˆ°åˆšæ¸…ç©º(å†·å´æ ‡è®°)åˆ™æ‰§è¡ŒçŸ­æš‚ä¹è§‚é‡è¯•ï¼Œä¸ç›´æ¥æ‹’ç»
		if (Store.roomCooldown?.has(roomName)) {
			const cooldownEnd = Store.roomCooldown.get(roomName);
			const remainingTime = cooldownEnd - Date.now();
			if (remainingTime > 0) {
				logInfo(`[å¿«é€Ÿå†ç™»è®°] ${roomName} è·ç¦»æ¸…ç©ºä»… ${remainingTime}msï¼Œæ‰§è¡Œè‡ªé€‚åº”é‡è¯•`);
				// é‡‡ç”¨ 2 æ¬¡å¿«é€Ÿé‡è¯•ï¼š50ms / 120ms åå†æ£€æŸ¥ç‰ˆæœ¬ï¼ˆé¿å…äººä¸ºç­‰å¾…ï¼‰
				for (const delay of [50,120]) {
					if (Date.now() >= cooldownEnd) break;
					await new Promise(r=>setTimeout(r, delay));
				}
				// åˆ°è¿™é‡Œï¼Œä¸å†é˜»å¡ï¼›å¦‚æœç‰ˆæœ¬ä»æœªæ›´æ–°ï¼Œåç»­ CAS ä¼šè¿”å›å†²çªå¹¶è§¦å‘æ ‡å‡†æç¤º
			}
			// ç«‹å³å…è®¸ç»§ç»­ï¼Œç¨åè‹¥æˆåŠŸåˆ™ç§»é™¤å†·å´
		}
		
		// å¦‚æœä¸æ˜¯å¼ºåˆ¶æ“ä½œï¼Œéœ€è¦å…ˆè¿›è¡Œæ—¶é—´æ®µæ£€æµ‹
		if (!opts.forced) {
			logInfo(`æ£€æŸ¥å­¦ç”Ÿ ${student} çš„ç»ƒç´æ—¶é—´æ®µ`);
			// è‹¥å…³é—­æ£€æµ‹ç›´æ¥ç™»è®°
			if(Store.settings && Store.settings.practiceSlotCheckEnabled===false){
				logInfo('æ—¶é—´æ®µæ£€æµ‹å·²å…³é—­ï¼Œç›´æ¥ç™»è®°');
				// ç»§ç»­æ‰§è¡Œç™»è®°
			} else {
				const info = await checkPracticeSlot(student);
				if (!info.inSlot) {
					logInfo(`å­¦ç”Ÿ ${student} ä¸åœ¨å…è®¸æ—¶é—´æ®µå†…ï¼Œéœ€è¦ç”¨æˆ·ç¡®è®¤`);
					// ä¸åœ¨æ—¶æ®µ -> å¼¹çª—ç¡®è®¤
					const ok = await showPracticeTimeConfirm(student, info);
					if (!ok) { 
						logInfo(`ç”¨æˆ·å–æ¶ˆäº†å­¦ç”Ÿ ${student} çš„ç™»è®°æ“ä½œ`);
						toast('å·²å–æ¶ˆç™»è®°'); 
						return { ok: false, cancelled: true }; 
					}
					// ç”¨æˆ·ç¡®è®¤åï¼Œå°†æ­¤æ¬¡æ“ä½œæ ‡è®°ä¸ºforced
					logInfo(`ç”¨æˆ·ç¡®è®¤äº†å­¦ç”Ÿ ${student} çš„æ—¶é—´æ®µå¤–ç™»è®°`);
					opts.forced = true;
				} else {
					logInfo(`å­¦ç”Ÿ ${student} åœ¨å…è®¸æ—¶é—´æ®µå†…ï¼Œç›´æ¥ç™»è®°`);
				}
			}
		} else {
			logInfo(`å¼ºåˆ¶ç™»è®°æ¨¡å¼ï¼Œè·³è¿‡å­¦ç”Ÿ ${student} çš„æ—¶é—´æ®µæ£€æµ‹`);
		}
		
		// æ£€æŸ¥æ“ä½œé”ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
		const lockKey = `assign_${roomName}`;
		if (Store.operationLocks?.has(lockKey)) {
			logWarn(`æˆ¿é—´ ${roomName} æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™`);
			toast(`æˆ¿é—´ ${roomName} æ­£åœ¨å¤„ç†ä¸­...`, 'warn');
			return { ok: false, error: 'æ“ä½œè¿›è¡Œä¸­' };
		}
		
		// è®¾ç½®æ“ä½œé”
		if (!Store.operationLocks) Store.operationLocks = new Set();
		Store.operationLocks.add(lockKey);
		
		try {
			// === CAS ç‰ˆæœ¬æ ¡éªŒï¼ˆå†™å‰ï¼‰===
			if (supabaseReady) {
				try {
					const localRow = Store.rooms.find(r=>r.name===roomName);
					const localVersion = (localRow && localRow.version) ? localRow.version : 0;
					const { data: remoteRow, error: verErr } = await supabaseClient
						.from('rooms')
						.select('name,occupant_student_name,register_time,version,heartbeat_at,updated_at')
						.eq('name', roomName)
						.maybeSingle();
					if(!verErr && remoteRow){
						const remoteVersion = remoteRow.version || 0;
						if(remoteVersion !== localVersion){
							logWarn(`[CAS] assign æœ¬åœ°ç‰ˆæœ¬è½å ${roomName}: local v${localVersion} / remote v${remoteVersion}`);
							// è½»é‡åˆ·æ–°å¹¶è¿”å› staleï¼Œè®©ä¸Šå±‚ç»Ÿä¸€æ¡†æ¶å†³å®šåç»­
							try {
								const canonical = canonicalizeRoom(remoteRow);
								const idx = Store.rooms.findIndex(r=>r.name===roomName);
								if(idx>=0) { Store.rooms[idx] = canonical; } else { Store.rooms.push(canonical); }
								renderRoomCardForced?.(roomName);
							}catch(_e){}
							return { ok:false, stale:true, reason:'version-mismatch', remoteVersion, localVersion };
						}
					}
					} catch(e){ logWarn('[CAS] assign ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥(å¿½ç•¥): '+ e.message); }
			}
			// ä¹è§‚æ›´æ–°ï¼ˆç«‹å³æ˜¾ç¤ºæ•ˆæœï¼‰
			const optimisticResult = optimisticAssign(roomName, student);
			if (!optimisticResult) {
				return { ok: false, error: 'ä¹è§‚æ›´æ–°å¤±è´¥' };
			}

			// âœ… ä¹è§‚æ›´æ–°æˆåŠŸåï¼šç«‹å³å…³é—­â€œé€‰æ‹©å­¦ç”Ÿâ€å¼¹çª—ï¼Œå‡å°‘ç­‰å¾…åç«¯å†™å…¥çš„å¯è§å»¶è¿Ÿ
			try{
				const modal=document.getElementById('studentModalBackdrop');
				if(modal && modal.style.display==='flex'){
					// ä»…åœ¨éå¤šäººç™»è®°çš„æƒ…å†µä¸‹è‡ªåŠ¨å…³é—­
					if(!window.studentModalState || window.studentModalState.multiSelectMode!==true){
						closeStudentModal();
					}
				}
			}catch(_){ }
			
			// åç«¯åŒæ­¥
			if(!supabaseReady){ 
				logWarn('ç¦»çº¿æ¨¡å¼ - ä»…æœ¬åœ°æ›´æ–°');
				return {ok:true, offline:true}; 
			}
			
			const nowIso = new Date().toISOString();
			const row = Store.rooms.find(r=>r.name===roomName);
			const nextVersion = (row? row.version:0)+1;
			
			// æ ‡è®°ä¸ºå¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.set(roomName, { 
				student, 
				version: nextVersion, 
				timestamp: Date.now() 
			});
			
			const { data, error } = await supabaseClient.from('rooms').upsert({
				name: roomName,
				occupant_student_name: student,
				register_time: nowIso,
				heartbeat_at: nowIso,
				version: nextVersion,
				updated_at: nowIso,
			piano_type: row ? (row.pianoType || row.piano_type || 'å…¶ä»–') : 'å…¶ä»–',
			location: row ? (row.location || '') : '',
			remark: row ? (row.remark || '') : ''
			});
			
			if(error){ 
				logErr('ç™»è®°å¤±è´¥', error.message);
				// å›æ»šä¹è§‚æ›´æ–°
				rollbackOptimisticAssign(roomName);
				return {ok:false,error}; 
			}
			
			// å†™å…¥ç»ƒä¹ è®°å½•
			await writePracticeLog(roomName, student, 'assign');
			
			logInfo(`æˆåŠŸç™»è®° ${student} -> ${roomName} (v${nextVersion})`);

		// ğŸ”§ ä¿®å¤ï¼šæˆåŠŸåç«‹å³æ›´æ–°æœ¬åœ°ç‰ˆæœ¬å·ï¼Œé¿å…åç»­æ“ä½œå‡ºç°ç‰ˆæœ¬å†²çª
		const assignedRoom = Store.rooms.find(r => r.name === roomName);
		if(assignedRoom) {
			assignedRoom.version = nextVersion;
		}
			
			// è®°å½•æ“ä½œæ—¶é—´
			window.__lastRoomOperationTime = Date.now();
			
			return {ok:true, data};
			
		} finally {
			// æ¸…é™¤æ“ä½œé”
			Store.operationLocks.delete(lockKey);
			// æ¸…é™¤å¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.delete(roomName);
			// æ¸…é™¤è§†è§‰æŒ‡ç¤º
			clearOperationIndicator(roomName);
		}
	}

	/*************************************************
	 * æ–°ç»Ÿä¸€å…¥å£ï¼šassignRoomUnified
	 * - ä¿ç•™åŸ assignRoom é€»è¾‘ï¼ˆä¿å­˜ä¸º window._legacyAssignRoom ï¼‰
	 * - å½“ feature flag å¼€å¯æ—¶ï¼Œèµ° performCasOperation
	 * - å…³é—­æ—¶å›é€€æ—§é€»è¾‘
	 *************************************************/
	if(!window._legacyAssignRoom){ window._legacyAssignRoom = assignRoom; }
	async function assignRoomUnified(roomName, student, expectedVersion, opts = {}){
		if(!window.__NEW_CAS_ENABLED){ return window._legacyAssignRoom(roomName, student, expectedVersion, opts); }
		return performCasOperation({
			scenario:'assign',
			meta:{ room:roomName, student },
			rooms:[{ name:roomName, role:'single' }],
			toleranceProfile:{ base:0, fast:1 },
			action: async ()=>{
				// ç›´æ¥è°ƒç”¨æ—§å®ç°ï¼Œåˆ©ç”¨å…¶å†…éƒ¨ä¹è§‚ä¸æ—¥å¿—ï¼›æ ‡è®° viaUnified ä¾¿äºåç»­åŒºåˆ†
				return await window._legacyAssignRoom(roomName, student, expectedVersion, { ...opts, __viaUnified:true });
			}
		});
	}
	window.assignRoomUnified = assignRoomUnified;

	/*************************************************
	 * ç»ƒç´æ—¶é—´æ®µæ£€æµ‹å°è£…
	 *************************************************/
	// ç¼“å­˜: studentName+weekday -> {inSlot, slots, checkedAt}
	const PracticeSlotCache = new Map();
	// å·¥å…·ï¼šå°† HH:MM / HH:MM:SS è½¬ä¸ºåˆ†é’Ÿæ•°
	function timeStrToMinutes(t){
		if(!t) return null; const m=t.trim().split(':');
		if(m.length<2) return null; return parseInt(m[0],10)*60+parseInt(m[1],10);
	}
	// è·å–å½“å‰ weekday (1-7 ä½†æˆ‘ä»¬åªç”¨ 1-5) æ˜ å°„ï¼šå‘¨ä¸€=1 ... å‘¨æ—¥=7
	function currentWeekday(){
		let d=new Date(); let w=d.getDay(); // 0=å‘¨æ—¥
		return w===0?7:w; 
	}
	// æŸ¥è¯¢å­¦ç”Ÿå½“å‰æ—¶é—´æ˜¯å¦åœ¨å…è®¸æ—¶æ®µ
	async function checkPracticeSlot(studentName, opts={ force:false }){
		if(!studentName) return { inSlot:true, reason:'æ— å­¦ç”Ÿå', slots:[] };
		if(!supabaseReady){
			return { inSlot:true, offline:true, reason:'ç¦»çº¿æ¨¡å¼ç›´æ¥æ”¾è¡Œ', slots:[] };
		}
		const wd=currentWeekday();
		// åªç¼“å­˜ 60 ç§’
		const cacheKey=studentName+'_'+wd; const cached=PracticeSlotCache.get(cacheKey);
		if(cached && !opts.force && (Date.now()-cached.checkedAt<60000)) return cached;
		const now=new Date(); const minutes=now.getHours()*60+now.getMinutes();
		try{
			const { data, error } = await supabaseClient.from('student_time_slots')
				.select('start_time,end_time,weekday')
				.eq('student_name', studentName)
				.eq('weekday', wd);
			if(error){
				logWarn('æ£€æµ‹ç»ƒç´æ—¶æ®µæŸ¥è¯¢å¤±è´¥', error.message);
				return { inSlot:true, reason:'æŸ¥è¯¢å¤±è´¥é»˜è®¤æ”¾è¡Œ', error };
			}
			const slots=(data||[]).map(r=>({
				start:timeStrToMinutes(r.start_time),
				end:timeStrToMinutes(r.end_time)
			})).filter(s=>s.start!=null && s.end!=null && s.end>s.start);
			let inSlot=false; let hit=null;
			for(const s of slots){ if(minutes>=s.start && minutes<s.end){ inSlot=true; hit=s; break; } }
			// é¢„æ—¶æ®µå®½é™ï¼šè·ç¦»ä»»ä¸€æœªæ¥æ—¶æ®µå¼€å§‹ <= GRACE_MINUTES (é»˜è®¤10) äº¦è§†ä¸ºåœ¨æ—¶æ®µå†…ï¼Œä¸å¼¹çª—
			if(!inSlot){
				const GRACE_MINUTES=10;
				for(const s of slots){
					if(minutes < s.start){
						const gap=s.start - minutes;
						if(gap<=GRACE_MINUTES){ inSlot=true; hit=s; var preSlotGrace=true; break; }
					}
				}
			}
			const result={ inSlot, slots, currentMinutes:minutes, hit, checkedAt:Date.now(), cacheKey, preSlotGrace: typeof preSlotGrace!=='undefined' };
			PracticeSlotCache.set(cacheKey,result);
			return result;
		}catch(e){
			logWarn('æ£€æµ‹ç»ƒç´æ—¶æ®µå¼‚å¸¸', e.message);
			return { inSlot:true, reason:'å¼‚å¸¸é»˜è®¤æ”¾è¡Œ', error:e };
		}
	}

	// å¼¹çª—ï¼šä¸åœ¨æ—¶æ®µæç¤ºï¼Œç”¨æˆ·ç¡®è®¤åç»§ç»­
	function showPracticeTimeConfirm(studentName, slotInfo){
		// è‹¥å·²å­˜åœ¨å¼¹çª—ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªæ‹’ç»ç»§ç»­çš„ Promiseï¼Œé¿å…å¤šå®ä¾‹å’Œé”®ç›˜å†²çª
		if(window.__practiceTimeDialogOpen){ return Promise.resolve(false); }
		window.__practiceTimeDialogOpen = true;
		return new Promise(resolve=>{
			let id='practiceSlotConfirmModal'; let backdrop=document.getElementById(id);
			if(backdrop){ backdrop.remove(); }
			backdrop=document.createElement('div');
			backdrop.id=id;
			backdrop.className='modal-backdrop';
			backdrop.style.display='flex';
			backdrop.setAttribute('role','dialog');
			backdrop.setAttribute('aria-modal','true');
			backdrop.tabIndex=-1; // ä½¿å…¶å¯èšç„¦ä»¥æ¥æ”¶é”®ç›˜äº‹ä»¶
			backdrop.innerHTML=`<div class="modal" style="max-width:520px;outline:none;">
				<div class="modal-header"><h3 style="font-size:16px;">ç»ƒç´æ—¶æ®µç¡®è®¤</h3><button class="ghost" data-role="close" style="padding:4px 8px;">âœ•</button></div>
				<div class="modal-body" style="gap:16px;">
					<p style="margin:0;font-size:14px;line-height:1.6;">å½“å‰æ—¶é—´ä¸åœ¨ <strong>${studentName}</strong> è®¾å®šçš„ç»ƒç´æ—¶é—´æ®µå†…ã€‚<br/>æ˜¯å¦ä»ç„¶è¦ç™»è®°ï¼Ÿ</p>
					${renderSlotTable(slotInfo.slots)}
					<p style="margin:0;font-size:12px;color:#ffb347;">æç¤ºï¼šç»§ç»­ç™»è®°å°†è¢«è®°å½•ï¼Œå¯ç”¨äºåç»­ç»Ÿè®¡ä¸å¼‚å¸¸æé†’ã€‚</p>
				</div>
				<div class="modal-footer">
					<button class="ghost" data-role="cancel">å–æ¶ˆ(Esc)</button>
					<button class="primary" data-role="confirm">ç»§ç»­ç™»è®°(Enter)</button>
				</div>
			</div>`;
			document.body.appendChild(backdrop);
			const modal = backdrop.querySelector('.modal');
			const btnConfirm = backdrop.querySelector('[data-role=confirm]');
			const btnCancel = backdrop.querySelector('[data-role=cancel]');
			const btnClose = backdrop.querySelector('[data-role=close]');
			const prevActive = document.activeElement;
			let resolved=false;
			function finish(v){ if(resolved) return; resolved=true; cleanup(); resolve(v); }
			function cleanup(){
				backdrop.removeEventListener('keydown', onKey, true);
				backdrop.remove();
				window.__practiceTimeDialogOpen=false;
				if(prevActive && typeof prevActive.focus==='function') setTimeout(()=>prevActive.focus(),0);
			}
			function onKey(e){
				if(e.key==='Enter'){ e.preventDefault(); e.stopImmediatePropagation(); finish(true); }
				else if(e.key==='Escape'){ e.preventDefault(); e.stopImmediatePropagation(); finish(false); }
			}
			// ç‚¹å‡»é®ç½©å…³é—­ï¼ˆå³é”®ç­‰ä¸è§¦å‘ï¼‰
			backdrop.addEventListener('click', e=>{ if(e.target===backdrop) finish(false); }, { capture:true });
			btnClose.addEventListener('click', ()=>finish(false));
			btnCancel.addEventListener('click', ()=>finish(false));
			btnConfirm.addEventListener('click', ()=>finish(true));
			// å…³é”®ï¼šå±€éƒ¨æ•è·é”®ç›˜ï¼Œé˜»æ–­å‘ä¸‹å±‚å†’æ³¡ï¼Œé¿å…ä¸å­¦ç”Ÿåˆ—è¡¨çš„ Enter å†²çª
			backdrop.addEventListener('keydown', onKey, true);
			// åˆå§‹èšç„¦ï¼šå…ˆèšç„¦ç¡®è®¤æŒ‰é’®ï¼Œå†èšç„¦ backdrop ä»¥ä¾¿ç»§ç»­æ•è·
			setTimeout(()=>{ try{ btnConfirm.focus(); backdrop.focus({ preventScroll:true }); }catch(_){} },0);
		});
	}
	function renderSlotTable(slots){
		if(!slots || slots.length===0) return `<div style="font-size:12px;color:#999;">è¯¥å­¦ç”Ÿä»Šå¤©æ²¡æœ‰é…ç½®ä»»ä½•æ—¶é—´æ®µã€‚</div>`;
		return `<table style="width:100%;border-collapse:collapse;font-size:12px;">
			<thead><tr><th style="text-align:left;padding:4px 6px;border-bottom:1px solid #2f3844;font-weight:600;color:#90a4b8;">å…è®¸æ—¶é—´æ®µ</th></tr></thead>
			<tbody>${slots.map(s=>`<tr><td style=\"padding:4px 6px;border-bottom:1px solid #2f3844;\">${fmtMinutes(s.start)} - ${fmtMinutes(s.end)}</td></tr>`).join('')}</tbody>
		</table>`;
	}
	function fmtMinutes(m){ const h=Math.floor(m/60), mm=String(m%60).padStart(2,'0'); return `${h}:${mm}`; }

	// å¯¹å¤–ï¼šå°è¯•ç™»è®°ï¼ˆå¸¦æ—¶æ®µæ£€æµ‹ä¸ç¡®è®¤ï¼‰
	async function attemptAssignRoom(roomName, studentName){
		// ç›´æ¥è°ƒç”¨assignRoomï¼Œæ—¶é—´æ£€æµ‹é€»è¾‘å·²å†…ç½®
		return assignRoomUnified(roomName, studentName);
	}
	
	// å†…éƒ¨ï¼šå¼ºåˆ¶ç™»è®°ï¼ˆè·³è¿‡æ—¶é—´æ£€æµ‹ï¼Œç”¨äºç³»ç»Ÿæ“ä½œæˆ–ç®¡ç†å‘˜æ“ä½œï¼‰
	async function forceAssignRoom(roomName, studentName, expectedVersion){
		return assignRoomUnified(roomName, studentName, expectedVersion, { forced: true });
	}
	
	// å¤šäººç™»è®°åˆ°åŒä¸€ä¸ªç´æˆ¿
	async function assignMultipleStudentsToRoom(roomName, students, opts = {}) {
		/*
		 * å°†å¤šä¸ªå­¦ç”Ÿç™»è®°åˆ°åŒä¸€ä¸ªç´æˆ¿
		 * students: å­¦ç”Ÿåå­—æ•°ç»„ ['å­¦ç”ŸA', 'å­¦ç”ŸB', 'å­¦ç”ŸC']
		 * åœ¨occupant_student_nameä¸­ç”¨é€—å·åˆ†éš”å­˜å‚¨
		 * ä¸ºæ¯ä¸ªå­¦ç”Ÿåˆ›å»ºç‹¬ç«‹çš„practice_logè®°å½•
		 */
		if (!students || students.length === 0) {
			return { ok: false, error: 'æ²¡æœ‰å­¦ç”Ÿ' };
		}
		
		// è§¦å‘å¤šè®¾å¤‡åŒæ­¥å¢å¼º
		syncEnhancer.recordUserOperation();
		
		// æ“ä½œé—´éš”æ£€æµ‹ï¼Œç¡®ä¿Realtimeæ›´æ–°åˆ°è¾¾
		await waitForRealtimeSync(opts.afterVersionConflict ? { afterVersionConflict: true } : {});
		
		// æ£€æŸ¥æ“ä½œé”
		const lockKey = `assign_${roomName}`;
		if (Store.operationLocks?.has(lockKey)) {
			logWarn(`æˆ¿é—´ ${roomName} æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™`);
			toast(`æˆ¿é—´ ${roomName} æ­£åœ¨å¤„ç†ä¸­...`, 'warn');
			return { ok: false, error: 'æ“ä½œè¿›è¡Œä¸­' };
		}
		
		// è®¾ç½®æ“ä½œé”
		if (!Store.operationLocks) Store.operationLocks = new Set();
		Store.operationLocks.add(lockKey);
		
		try {
			// ğŸ”§ ä¼˜å…ˆæ£€æŸ¥æ—¶é—´æ®µï¼Œç”¨æˆ·ç¡®è®¤åå†æ‰§è¡Œåç»­æ“ä½œ
			// å¦‚æœä¸æ˜¯å¼ºåˆ¶æ“ä½œï¼Œæ£€æŸ¥æ‰€æœ‰å­¦ç”Ÿçš„æ—¶é—´æ®µ
			if (!opts.forced) {
				for(const student of students){
					logInfo(`æ£€æŸ¥å­¦ç”Ÿ ${student} çš„ç»ƒç´æ—¶é—´æ®µ`);
					if(Store.settings && Store.settings.practiceSlotCheckEnabled===false){
						logInfo('æ—¶é—´æ®µæ£€æµ‹å·²å…³é—­ï¼Œç›´æ¥ç™»è®°');
						continue;
					}
					const info = await checkPracticeSlot(student);
					if (!info.inSlot) {
						logInfo(`å­¦ç”Ÿ ${student} ä¸åœ¨å…è®¸æ—¶é—´æ®µå†…ï¼Œéœ€è¦ç”¨æˆ·ç¡®è®¤`);
						const ok = await showPracticeTimeConfirm(student, info);
						if (!ok) { 
							logInfo(`ç”¨æˆ·å–æ¶ˆäº†å­¦ç”Ÿ ${student} çš„ç™»è®°æ“ä½œ`);
							toast('å·²å–æ¶ˆç™»è®°'); 
							return { ok: false, cancelled: true }; 
						}
						logInfo(`ç”¨æˆ·ç¡®è®¤äº†å­¦ç”Ÿ ${student} çš„æ—¶é—´æ®µå¤–ç™»è®°`);
					} else {
						logInfo(`å­¦ç”Ÿ ${student} åœ¨å…è®¸æ—¶é—´æ®µå†…`);
					}
				}
			}
			
			// ğŸ”§ æ—¶é—´æ®µæ£€æµ‹é€šè¿‡åï¼Œå†è¿›è¡Œå†²çªæ£€æµ‹å’Œæ¸…ç©ºæ—§æˆ¿é—´
			// å¤šäººç™»è®°å†²çªæ£€æµ‹ï¼šæ£€æŸ¥æ¯ä¸ªå­¦ç”Ÿæ˜¯å¦å·²åœ¨å…¶ä»–ç´æˆ¿
			const conflictingStudents = new Map(); // student -> currentRoomName
			for (const student of students) {
				for (const room of Store.rooms) {
					if (!room.occupant_student_name) continue;
					// æ”¯æŒå¤šäººæˆ¿é—´ï¼šåˆ†å‰²å­¦ç”Ÿåå­—
					const occupants = room.occupant_student_name.split(',').map(s => s.trim());
					if (occupants.includes(student) && room.name !== roomName) {
						conflictingStudents.set(student, room.name);
						break;
					}
				}
			}
			
			// å¦‚æœæœ‰å†²çªï¼Œå…ˆæ¸…ç©ºæ—§æˆ¿é—´ä¸­çš„è¿™äº›å­¦ç”Ÿï¼ˆä¸ä½¿ç”¨ transferStudentï¼Œé¿å…é‡å¤ç™»è®°ï¼‰
			if (conflictingStudents.size > 0 && !opts.internal) {
				logInfo(`ğŸ” æ£€æµ‹åˆ° ${conflictingStudents.size} ä¸ªå­¦ç”Ÿåœ¨å…¶ä»–ç´æˆ¿ï¼Œå…ˆæ¸…ç©ºæ—§æˆ¿é—´...`);
				
				// æŒ‰æˆ¿é—´åˆ†ç»„ï¼Œæ‰¹é‡å¤„ç†
				const roomGroups = new Map(); // oldRoomName -> [students to remove]
				for (const [student, oldRoomName] of conflictingStudents) {
					if (!roomGroups.has(oldRoomName)) {
						roomGroups.set(oldRoomName, []);
					}
					roomGroups.get(oldRoomName).push(student);
				}
				
				const clearTasks = [];
				for (const [oldRoomName, studentsToRemove] of roomGroups) {
					const oldRoom = Store.rooms.find(r => r.name === oldRoomName);
					if (!oldRoom || !oldRoom.occupant_student_name) continue;
					
					const currentOccupants = oldRoom.occupant_student_name.split(',').map(s => s.trim());
					const remainingStudents = currentOccupants.filter(s => !studentsToRemove.includes(s));
					
					logInfo(`  æ¸…ç©º ${oldRoomName}: ç§»é™¤ ${studentsToRemove.join(', ')}`);
					
					if (remainingStudents.length > 0) {
						// æ—§æˆ¿é—´è¿˜æœ‰å…¶ä»–å­¦ç”Ÿï¼Œæ›´æ–°ä¸ºå‰©ä½™å­¦ç”Ÿ
						toast(`ä» ${oldRoomName} ç§»é™¤ ${studentsToRemove.join('ã€')}`, 'info');
						clearTasks.push(
							assignMultipleStudentsToRoom(oldRoomName, remainingStudents, { forced: true, internal: true })
								.then(() => {
									// ä¸ºæ¯ä¸ªè¢«ç§»é™¤çš„å­¦ç”Ÿå†™å…¥æ¸…ç©ºæ—¥å¿—
									return Promise.all(studentsToRemove.map(s => writePracticeLog(oldRoomName, s, 'clear')));
								})
								.catch(err => {
									logErr(`æ›´æ–° ${oldRoomName} å¤±è´¥:`, err.message);
									return { success: false, room: oldRoomName, error: err.message };
								})
						);
					} else {
						// æ—§æˆ¿é—´åªæœ‰è¿™äº›å­¦ç”Ÿï¼Œç›´æ¥æ¸…ç©º
						toast(`æ¸…ç©º ${oldRoomName}`, 'info');
						clearTasks.push(
							clearRoomUnified(oldRoomName)
								.catch(err => {
									logErr(`æ¸…ç©º ${oldRoomName} å¤±è´¥:`, err.message);
									return { success: false, room: oldRoomName, error: err.message };
								})
						);
					}
				}
				
				// ç­‰å¾…æ‰€æœ‰æ¸…ç©ºæ“ä½œå®Œæˆ
				const clearResults = await Promise.all(clearTasks);
				const failedClears = clearResults.filter(r => r && r.success === false);
				
				if (failedClears.length > 0) {
					logWarn(`éƒ¨åˆ†æˆ¿é—´æ¸…ç©ºå¤±è´¥: ${failedClears.map(r => r.room).join(', ')}`);
					toast(`éƒ¨åˆ†æ—§æˆ¿é—´æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•`, 'error');
					return { ok: false, error: 'æ¸…ç©ºå¤±è´¥', failedClears };
				}
				
				logInfo(`âœ… å·²æ¸…ç©ºæ—§æˆ¿é—´ä¸­çš„å†²çªå­¦ç”Ÿ`);
				// ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿æ¸…ç©ºçš„ Realtime äº‹ä»¶åˆ°è¾¾
				await new Promise(resolve => setTimeout(resolve, 500));
			}
			
			// CASç‰ˆæœ¬æ ¡éªŒ
			if (supabaseReady) {
				try {
					const localRow = Store.rooms.find(r=>r.name===roomName);
					const localVersion = (localRow && localRow.version) ? localRow.version : 0;
					const { data: remoteRow, error: verErr } = await supabaseClient
						.from('rooms')
						.select('name,occupant_student_name,register_time,version,heartbeat_at,updated_at')
						.eq('name', roomName)
						.maybeSingle();
					if(!verErr && remoteRow){
						const remoteVersion = remoteRow.version || 0;
						if(remoteVersion !== localVersion){
							logWarn(`[CAS] å¤šäººç™»è®° ç‰ˆæœ¬è½å ${roomName}: local v${localVersion} / remote v${remoteVersion}`);
							try {
								const canonical = canonicalizeRoom(remoteRow);
								const idx = Store.rooms.findIndex(r=>r.name===roomName);
								if(idx>=0) { Store.rooms[idx] = canonical; } else { Store.rooms.push(canonical); }
								renderRoomCardForced?.(roomName);
							}catch(_e){}
							return { ok:false, stale:true, reason:'version-mismatch', remoteVersion, localVersion };
						}
					}
				} catch(e){ logWarn('[CAS] å¤šäººç™»è®° ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥(å¿½ç•¥): '+ e.message); }
			}
			
			// åˆå¹¶å­¦ç”Ÿåå­—ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰
			const combinedStudentName = students.join(',');
			
			// ä¹è§‚æ›´æ–°
			const row = Store.rooms.find(r => r.name === roomName);
			if(row) {
				// ä¿å­˜å›æ»šçŠ¶æ€
				if(!Store.rollbackStates) Store.rollbackStates = new Map();
				Store.rollbackStates.set(roomName, {
					occupant_student_name: row.occupant_student_name,
					registerTime: row.registerTime,
					version: row.version
				});
				
				row.occupant_student_name = combinedStudentName;
				row.registerTime = Date.now();
				renderRoomCard(roomName);
				updateUsageStats();
			}
			
			// åç«¯åŒæ­¥
			if(!supabaseReady){ 
				logWarn('ç¦»çº¿æ¨¡å¼ - ä»…æœ¬åœ°æ›´æ–°');
				return {ok:true, offline:true}; 
			}
			
			const nowIso = new Date().toISOString();
			const nextVersion = (row ? row.version : 0) + 1;
			
			// æ ‡è®°ä¸ºå¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.set(roomName, { 
				student: combinedStudentName, 
				version: nextVersion, 
				timestamp: Date.now() 
			});
			
			// æ›´æ–°roomsè¡¨
			const { data, error } = await supabaseClient.from('rooms').upsert({
				name: roomName,
				occupant_student_name: combinedStudentName,
				register_time: nowIso,
				heartbeat_at: nowIso,
				version: nextVersion,
				updated_at: nowIso,
			piano_type: row ? (row.pianoType || row.piano_type || 'å…¶ä»–') : 'å…¶ä»–',
			location: row ? (row.location || '') : '',
			remark: row ? (row.remark || '') : ''
			});
			
			if(error){ 
				logErr('å¤šäººç™»è®°å¤±è´¥', error.message);
				// å›æ»šä¹è§‚æ›´æ–°
				const rollbackState = Store.rollbackStates?.get(roomName);
				if (rollbackState && row) {
					row.occupant_student_name = rollbackState.occupant_student_name;
					row.registerTime = rollbackState.registerTime;
					row.version = rollbackState.version;
					renderRoomCard(roomName);
					updateUsageStats();
				}
				return {ok:false,error}; 
			}
			
			// ä¸ºæ¯ä¸ªå­¦ç”Ÿåˆ›å»ºç‹¬ç«‹çš„ç»ƒä¹ è®°å½•ï¼ˆæ‰¹é‡å†™å…¥ï¼‰
			try{
				// å…ˆåœ¨æœ¬åœ°æ„å»ºæ‰€æœ‰æ¡ç›®å¹¶æ¨å…¥æœ¬åœ°ç¼“å­˜
				const entries = students.map(s => createPracticeLogEntry(roomName, s, 'assign'));
				Store.localPracticeLogs.push(...entries);

				if (supabaseReady) {
					// æ„é€ æ•°æ®åº“æ’å…¥æ•°æ®ï¼ˆå»æ‰æœ¬åœ°å­—æ®µï¼‰
					let payload = entries.map(e => { const { synced, ...rest } = e; return rest; });
					let removedCols = [];
					let summarized = false;
					let attempt = 0;
					while (attempt < 5) {
						const { error } = await supabaseClient.from('practice_logs').insert(payload);
						if (!error) {
							// æ ‡è®°ä¸ºå·²åŒæ­¥
							entries.forEach(en => en.synced = true);
							break;
						}
						// ç¼ºåˆ—å®¹é”™ï¼šä¸å•æ¡å†™å…¥ä¸€è‡´
						const msg = (error.message||'').toLowerCase();
						if (error.code==='42703' || msg.includes("could not find the '") ){
							let missing='';
							const m = error.message.match(/'([^']+)' column/);
							if(m) missing=m[1];
							if(missing){
								removedCols.push(missing);
								payload = payload.map(obj=>{ const cp={...obj}; delete cp[missing]; return cp; });
								if(!summarized && removedCols.length>=2){
									// é™çº§æœ€å°å­—æ®µé›†
									payload = entries.map(en=>({ action:'assign', student_name: en.student_name, timestamp: en.timestamp }));
									summarized = true;
								}
								attempt++; continue;
							}
						}
						// å…¶å®ƒé”™è¯¯ï¼Œé™çº§é€æ¡å†™å…¥ä»¥æœ€å¤§åŒ–æˆåŠŸç‡
						for(const s of students){
							try{ await writePracticeLog(roomName, s, 'assign'); }catch(_e){}
						}
						break;
					}
				}
			}catch(batchErr){
				logWarn('æ‰¹é‡å†™ç»ƒä¹ è®°å½•å¤±è´¥ï¼Œé™çº§é€æ¡:', batchErr.message);
				for(const s of students){ try{ await writePracticeLog(roomName, s, 'assign'); }catch(_e){} }
			}
			
			logInfo(`æˆåŠŸä¸º ${students.length} ä½å­¦ç”Ÿç™»è®°åˆ° ${roomName} (v${nextVersion})`);

		// ğŸ”§ ä¿®å¤ï¼šæˆåŠŸåç«‹å³æ›´æ–°æœ¬åœ°ç‰ˆæœ¬å·ï¼Œé¿å…åç»­æ“ä½œå‡ºç°ç‰ˆæœ¬å†²çª
		if(row) {
			row.version = nextVersion;
		}
			
			// è®°å½•æ“ä½œæ—¶é—´
			window.__lastRoomOperationTime = Date.now();
			
			return {ok:true, data};
			
		} finally {
			// æ¸…é™¤æ“ä½œé”
			Store.operationLocks.delete(lockKey);
			// æ¸…é™¤å¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.delete(roomName);
			// æ¸…é™¤è§†è§‰æŒ‡ç¤º
			clearOperationIndicator(roomName);
		}
	}
	
	// è½¬ç§»å­¦ç”Ÿä»ä¸€ä¸ªæˆ¿é—´åˆ°å¦ä¸€ä¸ªæˆ¿é—´ï¼ˆå¸¦æ—¶é—´æ£€æµ‹ï¼‰
	async function transferStudent(fromRoom, toRoom, studentName, opts = {}) {
		try {
		// æ–¹æ¡ˆ1: æ“ä½œé—´éš”æ£€æµ‹ï¼Œç¡®ä¿Realtimeæ›´æ–°åˆ°è¾¾
		await waitForRealtimeSync(opts.afterVersionConflict ? { afterVersionConflict: true } : {});
		
		// è®°å½•è½¬ç§»æ“ä½œå†å²ï¼Œç”¨äºæ£€æµ‹å¿«é€Ÿè¿ç»­è½¬ç§»
		if (!Store.recentTransfers) Store.recentTransfers = [];
		const now = Date.now();
		
		// æ¸…ç†5ç§’å‰çš„è½¬ç§»è®°å½•
		Store.recentTransfers = Store.recentTransfers.filter(t => now - t.timestamp < 5000);
		
		// æ£€æŸ¥æ˜¯å¦æ¶‰åŠç›¸åŒæˆ¿é—´çš„å¿«é€Ÿè½¬ç§»
		const relatedTransfers = Store.recentTransfers.filter(t => 
			t.fromRoom === fromRoom || t.toRoom === fromRoom || 
			t.fromRoom === toRoom || t.toRoom === toRoom
		);
		
		if (relatedTransfers.length > 0) {
			const lastRelatedTransfer = Math.max(...relatedTransfers.map(t => t.timestamp));
			const timeSinceRelated = now - lastRelatedTransfer;
			if (timeSinceRelated < 3000) {
				logInfo(`ğŸš¨ æ£€æµ‹åˆ°å¿«é€Ÿè¿ç»­è½¬ç§» (${timeSinceRelated}mså‰æ¶‰åŠç›¸åŒæˆ¿é—´)ï¼Œå»¶é•¿åŒæ­¥ç­‰å¾…`);
				await new Promise(resolve => setTimeout(resolve, 1000));
			}
		}
		
		logInfo(`ğŸ”„ å¼€å§‹è½¬ç§»å­¦ç”Ÿ ${studentName} ä» ${fromRoom} åˆ° ${toRoom}`);			// éªŒè¯è½¬ç§»çš„æœ‰æ•ˆæ€§
			const fromRoomObj = Store.rooms.find(r => r.name === fromRoom);
			const toRoomObj = Store.rooms.find(r => r.name === toRoom);
			
			if (!fromRoomObj || fromRoomObj.occupant_student_name !== studentName) {
				logWarn(`åŸæˆ¿é—´ ${fromRoom} ä¸å­˜åœ¨æˆ–å­¦ç”Ÿä¸åŒ¹é…`);
				return { ok: false, error: 'åŸæˆ¿é—´çŠ¶æ€ä¸åŒ¹é…' };
			}
			
			if (!toRoomObj) {
				logWarn(`ç›®æ ‡æˆ¿é—´ ${toRoom} ä¸å­˜åœ¨`);
				return { ok: false, error: 'ç›®æ ‡æˆ¿é—´ä¸å­˜åœ¨' };
			}
			
			if (toRoomObj.occupant_student_name && toRoomObj.occupant_student_name !== studentName) {
				logWarn(`ç›®æ ‡æˆ¿é—´ ${toRoom} å·²è¢«å…¶ä»–å­¦ç”Ÿå ç”¨`);
				return { ok: false, error: 'ç›®æ ‡æˆ¿é—´å·²è¢«å ç”¨' };
			}
			
			// æ£€æŸ¥ç›®æ ‡æˆ¿é—´æ˜¯å¦åœ¨å†·å´æœŸå†…
			if (Store.roomCooldown?.has(toRoom)) {
				const cooldownEnd = Store.roomCooldown.get(toRoom);
				const remainingTime = cooldownEnd - Date.now();
				if (remainingTime > 0) {
					console.log(`[è½¬ç§»å†·å´] ${toRoom} è¿˜åœ¨å†·å´æœŸå†…ï¼Œå‰©ä½™ ${remainingTime}ms`);
					toast(`${toRoom} åˆšè¢«æ¸…ç©ºï¼Œè¯·ç¨ç­‰ ${Math.ceil(remainingTime/1000)} ç§’åå†è½¬ç§»`, 'info');
					return { ok: false, error: 'ç›®æ ‡æˆ¿é—´å†·å´æœŸ' };
				} else {
					// å†·å´æœŸç»“æŸï¼Œæ¸…é™¤è®°å½•
					Store.roomCooldown.delete(toRoom);
				}
			}
			
			// å…ˆè¿›è¡Œæ—¶é—´æ£€æµ‹ï¼Œä½†ä¸å®é™…ç™»è®°æ–°æˆ¿é—´
			if (Store.settings && Store.settings.practiceSlotCheckEnabled !== false) {
				logInfo(`â° æ£€æŸ¥å­¦ç”Ÿ ${studentName} çš„ç»ƒç´æ—¶é—´æ®µ`);
				const info = await checkPracticeSlot(studentName);
				if (!info.inSlot) {
					logInfo(`âš ï¸ å­¦ç”Ÿ ${studentName} ä¸åœ¨å…è®¸æ—¶é—´æ®µå†…ï¼Œéœ€è¦ç”¨æˆ·ç¡®è®¤`);
					// ä¸åœ¨æ—¶æ®µ -> å¼¹çª—ç¡®è®¤
					const ok = await showPracticeTimeConfirm(studentName, info);
					if (!ok) { 
						logInfo(`âŒ ç”¨æˆ·å–æ¶ˆäº†å­¦ç”Ÿ ${studentName} çš„è½¬ç§»æ“ä½œ`);
						return { ok: false, cancelled: true }; 
					}
					logInfo(`âœ… ç”¨æˆ·ç¡®è®¤äº†å­¦ç”Ÿ ${studentName} çš„æ—¶é—´æ®µå¤–è½¬ç§»`);
				} else {
					logInfo(`âœ… å­¦ç”Ÿ ${studentName} åœ¨å…è®¸æ—¶é—´æ®µå†…ï¼Œå¯ä»¥è½¬ç§»`);
				}
			} else {
				logInfo('âš™ï¸ æ—¶é—´æ®µæ£€æµ‹å·²å…³é—­ï¼Œç›´æ¥è½¬ç§»');
			}

			// âœ… åœ¨å®Œæˆæ—¶æ®µç¡®è®¤åã€æ‰§è¡Œå®é™…æ¸…ç©º/ç™»è®°å‰ï¼šè‹¥å­¦ç”Ÿé€‰æ‹©å¼¹çª—ä»æ‰“å¼€ï¼Œåˆ™å…ˆè¡Œå…³é—­ï¼Œé¿å…åç»­ä¸¤æ¬¡ç½‘ç»œå†™å…¥é€ æˆçš„å¯è§å»¶è¿Ÿ
			try{
				const modal=document.getElementById('studentModalBackdrop');
				if(modal && modal.style.display==='flex'){
					closeStudentModal();
				}
			}catch(_){ }
			
		// === è½¬ç§»å‰ CAS é¢„æ ¡éªŒä¸¤ä¸ªæˆ¿é—´çŠ¶æ€ ===
		if (supabaseReady) {
			try {
				logInfo(`ğŸ” è½¬ç§»å‰é¢„æ ¡éªŒ ${fromRoom} å’Œ ${toRoom} çŠ¶æ€`);
				
				// å¦‚æœæ˜¯å¿«é€Ÿè¿ç»­è½¬ç§»ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´ç¡®ä¿RealtimeåŒæ­¥
				const timeSinceLastOp = Date.now() - (window.__lastRoomOperationTime || 0);
				if (timeSinceLastOp < 2000) { // 2ç§’å†…æœ‰æ“ä½œï¼Œå¯èƒ½æ˜¯å¿«é€Ÿè¿ç»­è½¬ç§»
					logInfo(`æ£€æµ‹åˆ°å¿«é€Ÿè¿ç»­æ“ä½œ(${timeSinceLastOp}mså‰)ï¼Œå»¶é•¿åŒæ­¥ç­‰å¾…æ—¶é—´`);
					await new Promise(resolve => setTimeout(resolve, 800));
				}
				
				const { data: bothRooms, error: fetchErr } = await supabaseClient
					.from('rooms')
					.select('name,occupant_student_name,register_time,version,heartbeat_at,updated_at')
					.in('name', [fromRoom, toRoom]);
				
				if (!fetchErr && bothRooms) {
					const fromRemote = bothRooms.find(r => r.name === fromRoom);
					const toRemote = bothRooms.find(r => r.name === toRoom);
					
					// æ ¡éªŒåŸæˆ¿é—´ï¼šå¿…é¡»æ˜¯ç›®æ ‡å­¦ç”Ÿå ç”¨ä¸”ç‰ˆæœ¬ä¸€è‡´
					const fromLocal = Store.rooms.find(r => r.name === fromRoom);
					if (fromRemote && fromLocal) {
						const remoteVersion = fromRemote.version || 0;
						const localVersion = fromLocal.version || 0;
						if (remoteVersion !== localVersion) {
							logWarn(`[TransferCAS] åŸæˆ¿é—´ ${fromRoom} ç‰ˆæœ¬è½å local v${localVersion} / remote v${remoteVersion}`);
							try {
								const canonical = canonicalizeRoom(fromRemote);
								const idx = Store.rooms.findIndex(r => r.name === fromRoom);
								if (idx >= 0) { Store.rooms[idx] = canonical; } else { Store.rooms.push(canonical); }
								renderRoomCardForced?.(fromRoom);
							}catch(_e){}
							return { ok: false, stale: true, reason: 'from-room-version-mismatch' };
						}
						if (fromRemote.occupant_student_name !== studentName) {
							logWarn(`[TransferCAS] åŸæˆ¿é—´ ${fromRoom} å ç”¨è€…ä¸åŒ¹é…: æœŸæœ› ${studentName}, å®é™… ${fromRemote.occupant_student_name || 'null'}`);
							// åˆ·æ–°åŸæˆ¿é—´çŠ¶æ€
							const canonical = canonicalizeRoom(fromRemote);
							const idx = Store.rooms.findIndex(r => r.name === fromRoom);
							if (idx >= 0) { Store.rooms[idx] = canonical; } else { Store.rooms.push(canonical); }
							renderRoomCard(fromRoom);
							updateUsageStats();
							toast(`${fromRoom} å ç”¨è€…å·²å˜åŒ–ï¼Œè½¬ç§»å–æ¶ˆ`, 'warn');
							return { ok: false, stale: true, reason: 'from-room-occupant-mismatch' };
						}
					}
					
					// æ ¡éªŒç›®æ ‡æˆ¿é—´ï¼šå¿…é¡»ä¸ºç©ºæˆ–è¢«åŒä¸€å­¦ç”Ÿå ç”¨ï¼Œä¸”ç‰ˆæœ¬ä¸€è‡´
					const toLocal = Store.rooms.find(r => r.name === toRoom);
					if (toRemote && toLocal) {
						const remoteVersion = toRemote.version || 0;
						const localVersion = toLocal.version || 0;
						if (remoteVersion !== localVersion) {
							logWarn(`[TransferCAS] ç›®æ ‡æˆ¿é—´ ${toRoom} ç‰ˆæœ¬è½å local v${localVersion} / remote v${remoteVersion}`);
							try {
								const canonical = canonicalizeRoom(toRemote);
								const idx = Store.rooms.findIndex(r => r.name === toRoom);
								if (idx >= 0) { Store.rooms[idx] = canonical; } else { Store.rooms.push(canonical); }
								renderRoomCardForced?.(toRoom);
							}catch(_e){}
							return { ok: false, stale: true, reason: 'to-room-version-mismatch' };
						}
						if (toRemote.occupant_student_name && toRemote.occupant_student_name !== studentName) {
							logWarn(`[TransferCAS] ç›®æ ‡æˆ¿é—´ ${toRoom} å·²è¢«å…¶ä»–å­¦ç”Ÿå ç”¨: ${toRemote.occupant_student_name}`);
							// åˆ·æ–°ç›®æ ‡æˆ¿é—´çŠ¶æ€
							const canonical = canonicalizeRoom(toRemote);
							const idx = Store.rooms.findIndex(r => r.name === toRoom);
							if (idx >= 0) { Store.rooms[idx] = canonical; } else { Store.rooms.push(canonical); }
							renderRoomCard(toRoom);
							updateUsageStats();
							toast(`${toRoom} å·²è¢«å…¶ä»–å­¦ç”Ÿå ç”¨ï¼Œè½¬ç§»å–æ¶ˆ`, 'warn');
							return { ok: false, stale: true, reason: 'to-room-occupied-by-other' };
						}
					}
				}
				logInfo(`âœ… è½¬ç§»å‰é¢„æ ¡éªŒé€šè¿‡ï¼Œä¸¤æˆ¿é—´çŠ¶æ€ç¬¦åˆé¢„æœŸ`);
			} catch (e) {
				logWarn('[TransferCAS] é¢„æ ¡éªŒå¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œè½¬ç§»: ' + e.message);
			}
		}
		
		// ä¿å­˜åŸæˆ¿é—´çŠ¶æ€ï¼Œç”¨äºå¤±è´¥æ—¶å›æ»š
		const originalFromRoomState = {
			occupant_student_name: fromRoomObj.occupant_student_name,
			register_time: fromRoomObj.register_time,
			version: fromRoomObj.version
		};
		
		// æ—¶é—´æ£€æµ‹é€šè¿‡åï¼Œè¿›è¡Œå®é™…çš„è½¬ç§»æ“ä½œï¼ˆè¯­ä¹‰é¡ºåºï¼šå…ˆé‡Šæ”¾æ—§æˆ¿å†å ç”¨æ–°æˆ¿ï¼‰
		logInfo(`ğŸš€ å¼€å§‹æ‰§è¡Œè½¬ç§»æ“ä½œï¼š${studentName} ${fromRoom} â†’ ${toRoom}`);
		
		// å…ˆæ¸…ç©ºåŸæˆ¿é—´ï¼ˆé¿å…åµŒå¥—ç»Ÿä¸€æ¡†æ¶è°ƒç”¨ï¼‰
		logInfo(`ğŸ§¹ å¼€å§‹æ¸…ç©ºåŸæˆ¿é—´ ${fromRoom}`);
		const clearResult = opts.__suppressNestedUnified ? 
			await window._legacyClearRoom(fromRoom, { skipCooldown: true, __viaUnified:true }) :
			await clearRoomUnified(fromRoom, { skipCooldown: true }); // ç»Ÿä¸€CASæ¡†æ¶
		if (!clearResult || !clearResult.ok) {
			if (clearResult && clearResult.stale) {
				logWarn(`âŒ åŸæˆ¿é—´ ${fromRoom} æ¸…ç©ºæ—¶å‘ç°çŠ¶æ€è¿‡æœŸï¼Œè½¬ç§»ä¸­æ–­`);
				return { ok: false, stale: true, error: 'åŸæˆ¿é—´çŠ¶æ€è¿‡æœŸï¼Œè½¬ç§»ä¸­æ–­' };
			}
			logWarn(`âŒ åŸæˆ¿é—´ ${fromRoom} æ¸…ç©ºå¤±è´¥ï¼Œè½¬ç§»ä¸­æ–­`);
			return { ok: false, error: 'åŸæˆ¿é—´æ¸…ç©ºå¤±è´¥' };
		}
		logInfo(`âœ… åŸæˆ¿é—´ ${fromRoom} æ¸…ç©ºæˆåŠŸ`);
		
		// å¼ºåˆ¶æ›´æ–°åŸæˆ¿é—´å¡ç‰‡æ ·å¼ï¼Œç¡®ä¿æ˜¾ç¤ºä¸ºç©ºæˆ¿é—´çŠ¶æ€
		setTimeout(() => {
			// ç¡®ä¿ç´¢å¼•æ˜¯æœ€æ–°çš„
			if (typeof rebuildIndexes === 'function') {
				rebuildIndexes();
			}
			
			const fromRoomCard = document.querySelector(`[data-room="${CSS.escape(fromRoom)}"]`);
			if (fromRoomCard) {
				fromRoomCard.classList.add('empty');
				fromRoomCard.classList.remove('occupied', 'pending-operation');
				fromRoomCard.dataset.status = 'empty';
				
				// æ›´æ–°å¡ç‰‡å†…å®¹ï¼Œç¡®ä¿æ˜¾ç¤ºä¸ºç©ºæˆ¿é—´
				const occupantElement = fromRoomCard.querySelector('.occupant');
				if (occupantElement) {
					occupantElement.textContent = '';
				}
				
				// æ›´æ–°æ—¶é—´æ˜¾ç¤º
				const timeElement = fromRoomCard.querySelector('.time');
				if (timeElement) {
					timeElement.textContent = '';
				}
			}
			
			// ä½¿ç”¨å¼ºåˆ¶é‡æ–°æ¸²æŸ“ï¼Œä½†å…ˆç¡®ä¿æ•°æ®å·²æ›´æ–°
			const roomData = Store.byName.get(fromRoom);
			if (roomData) {
				renderRoomCardForced(fromRoom);
			} else {
				logWarn(`æ¸…ç©ºåæœªæ‰¾åˆ°æˆ¿é—´æ•°æ®: ${fromRoom}ï¼Œè·³è¿‡å¼ºåˆ¶æ¸²æŸ“`);
			}
		}, 100); // ç¨å¾®å»¶é•¿ç­‰å¾…æ—¶é—´ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
		
		// ç­‰å¾…çŸ­æš‚æ—¶é—´ç¡®ä¿æ•°æ®åº“æ›´æ–°ä¼ æ’­
		await new Promise(resolve => setTimeout(resolve, 200));
		
		// åŸæˆ¿é—´æ¸…ç©ºæˆåŠŸåï¼Œç™»è®°æ–°æˆ¿é—´ï¼ˆforceAssignRoom å†…éƒ¨å·²æœ‰ CAS æ ¡éªŒï¼‰
		const assignResult = await forceAssignRoom(toRoom, studentName); // forceAssignRoom å†…éƒ¨å·²æ”¹ç”¨ assignRoomUnified
		if (!assignResult || !assignResult.ok) {
			logWarn(`âŒ æ–°æˆ¿é—´ ${toRoom} ç™»è®°å¤±è´¥ï¼Œå°è¯•å›æ»šåŸæˆ¿é—´`);
			
			// å°è¯•å›æ»šï¼šé‡æ–°æ¢å¤åŸæˆ¿é—´çŠ¶æ€
			try {
				await new Promise(resolve => setTimeout(resolve, 100)); // çŸ­æš‚ç­‰å¾…
				const rollbackResult = await forceAssignRoom(fromRoom, studentName); // rollback ä»ç”¨ç»Ÿä¸€å°è£…
				if (rollbackResult && rollbackResult.ok) {
					logInfo(`âœ… å·²å›æ»šï¼š${studentName} é‡æ–°ç™»è®°åˆ°åŸæˆ¿é—´ ${fromRoom}`);
					toast(`è½¬ç§»å¤±è´¥ï¼Œå·²å›æ»šåˆ°åŸæˆ¿é—´ ${fromRoom}`, 'warn');
					return { ok: false, error: 'æ–°æˆ¿é—´ç™»è®°å¤±è´¥ï¼Œå·²å›æ»š', rollback: true };
				} else {
					logWarn(`âŒ å›æ»šå¤±è´¥ï¼Œæ— æ³•æ¢å¤åŸæˆ¿é—´ ${fromRoom}`);
					toast(`è½¬ç§»å¤±è´¥ä¸”å›æ»šå¤±è´¥ï¼šè¯·æ‰‹åŠ¨å°† ${studentName} é‡æ–°ç™»è®°åˆ° ${fromRoom}`, 'error');
					return { ok: false, error: 'æ–°æˆ¿é—´ç™»è®°å¤±è´¥ï¼Œå›æ»šä¹Ÿå¤±è´¥', rollback: false };
				}
			} catch (rollbackError) {
				logErr(`å›æ»šæ“ä½œå¼‚å¸¸:`, rollbackError.message);
				toast(`è½¬ç§»å¤±è´¥ä¸”å›æ»šå¼‚å¸¸ï¼šè¯·æ‰‹åŠ¨å°† ${studentName} é‡æ–°ç™»è®°`, 'error');
				return { ok: false, error: 'è½¬ç§»å¤±è´¥ï¼Œå›æ»šå¼‚å¸¸', rollback: false };
			}
		}
		logInfo(`âœ… æ–°æˆ¿é—´ ${toRoom} ç™»è®°æˆåŠŸ`);
		
		// è®°å½•æ“ä½œæ—¶é—´
		window.__lastRoomOperationTime = Date.now();
		
		// è®°å½•è¿™æ¬¡è½¬ç§»æ“ä½œï¼Œç”¨äºåç»­å¿«é€Ÿè½¬ç§»æ£€æµ‹
		Store.recentTransfers.push({
			fromRoom,
			toRoom,
			studentName,
			timestamp: Date.now()
		});
		
		// è½¬ç§»æˆåŠŸåï¼Œç¡®ä¿æˆ¿é—´å¡ç‰‡æ­£ç¡®æ˜¾ç¤º
		// ä½¿ç”¨é“¾å¼å¼‚æ­¥å¤„ç†é¿å…ç«æ€æ¡ä»¶
		(async () => {
			// ç­‰å¾…æ“ä½œå®Œæˆ
			await new Promise(resolve => setTimeout(resolve, 200));
			
			// ç¡®ä¿ç´¢å¼•æ˜¯æœ€æ–°çš„
			if (typeof rebuildIndexes === 'function') {
				rebuildIndexes();
			}
			
			// æ£€æŸ¥å¹¶ä¿®å¤æˆ¿é—´çŠ¶æ€
			const fromRoomData = Store.byName.get(fromRoom);
			const toRoomData = Store.byName.get(toRoom);
			
			if (fromRoomData) {
				// ç¡®ä¿åŸæˆ¿é—´æ˜¯ç©ºçš„
				if (fromRoomData.occupant_student_name) {
					logWarn(`è½¬ç§»ååŸæˆ¿é—´ ${fromRoom} ä»æœ‰å ç”¨è€…ï¼Œä¿®å¤ä¸­`);
					fromRoomData.occupant_student_name = null;
					fromRoomData.register_time = null;
					fromRoomData.registerTime = null;
				}
				
				// å¼ºåˆ¶é‡æ–°æ¸²æŸ“åŸæˆ¿é—´
				renderRoomCardForced(fromRoom);
				clearOperationIndicator(fromRoom);
				
				// ç¡®ä¿DOMå…ƒç´ æœ‰æ­£ç¡®çš„CSSç±»
				setTimeout(() => {
					const fromCard = document.querySelector(`[data-room="${CSS.escape(fromRoom)}"]`);
					if (fromCard) {
						fromCard.classList.remove('occupied');
						fromCard.classList.add('empty');
						fromCard.dataset.status = 'empty';
						logInfo(`ğŸ”§ ä¿®å¤åŸæˆ¿é—´ ${fromRoom} CSSç±»: empty`);
					} else {
						logWarn(`âš ï¸ åŸæˆ¿é—´ ${fromRoom} DOMå…ƒç´ ä¸å­˜åœ¨`);
					}
				}, 50);
				
				logInfo(`âœ… è½¬ç§»åä¿®å¤åŸæˆ¿é—´: ${fromRoom}, å ç”¨è€…: ${fromRoomData.occupant_student_name || 'null'}`);
			}
			
			if (toRoomData) {
				// ç¡®ä¿æ–°æˆ¿é—´æœ‰æ­£ç¡®çš„å ç”¨è€…
				if (toRoomData.occupant_student_name !== studentName) {
					logWarn(`è½¬ç§»åæ–°æˆ¿é—´ ${toRoom} å ç”¨è€…ä¸åŒ¹é…ï¼Œä¿®å¤ä¸­`);
					toRoomData.occupant_student_name = studentName;
					toRoomData.register_time = new Date().toISOString();
					toRoomData.registerTime = Date.now();
				}
				
				// å¼ºåˆ¶é‡æ–°æ¸²æŸ“æ–°æˆ¿é—´
				renderRoomCardForced(toRoom);
				clearOperationIndicator(toRoom);
				
				// ç¡®ä¿DOMå…ƒç´ æœ‰æ­£ç¡®çš„CSSç±»
				setTimeout(() => {
					const toCard = document.querySelector(`[data-room="${CSS.escape(toRoom)}"]`);
					if (toCard) {
						toCard.classList.remove('empty');
						toCard.classList.add('occupied');
						toCard.dataset.status = 'occupied';
						logInfo(`ğŸ”§ ä¿®å¤æ–°æˆ¿é—´ ${toRoom} CSSç±»: occupied`);
					} else {
						logWarn(`âš ï¸ æ–°æˆ¿é—´ ${toRoom} DOMå…ƒç´ ä¸å­˜åœ¨`);
					}
				}, 50);
				
				logInfo(`âœ… è½¬ç§»åä¿®å¤æ–°æˆ¿é—´: ${toRoom}, å ç”¨è€…: ${toRoomData.occupant_student_name || 'null'}`);
			}
			
			updateUsageStats();
			
			// å†æ¬¡ç­‰å¾…ï¼Œç„¶åæ£€æŸ¥æˆ¿é—´å¡ç‰‡æ˜¯å¦å­˜åœ¨
			await new Promise(resolve => setTimeout(resolve, 300));
			
			const fromCard = document.querySelector(`[data-room="${CSS.escape(fromRoom)}"]`);
			const toCard = document.querySelector(`[data-room="${CSS.escape(toRoom)}"]`);
			
			if (!fromCard || !toCard) {
				logWarn(`è½¬ç§»åå‘ç°å¡ç‰‡ç¼ºå¤± - ${fromRoom}: ${!!fromCard}, ${toRoom}: ${!!toCard}`);
				logInfo('è§¦å‘å…¨é‡é‡æ¸²æŸ“ä»¥æ¢å¤ç¼ºå¤±çš„æˆ¿é—´å¡ç‰‡');
				
				if (window.renderRooms && typeof window.renderRooms === 'function') {
					renderRooms();
				}
			} else {
				logInfo('âœ… è½¬ç§»åæˆ¿é—´å¡ç‰‡æ£€æŸ¥é€šè¿‡');
			}
		})();
		
		// ğŸ—„ï¸ è½¬ç§»æˆåŠŸåä¿å­˜è®¡æ—¶å™¨çŠ¶æ€
		timerPersistence.saveTimerStates();
		
		logInfo(`ğŸ‰ è½¬ç§»å®Œæˆï¼š${studentName} å·²ä» ${fromRoom} ç§»è‡³ ${toRoom}`);
		toast(`è½¬ç§»æˆåŠŸï¼š${studentName} å·²ä» ${fromRoom} ç§»è‡³ ${toRoom}`, 'success');
		return { ok: true };
			
		} catch (error) {
			logErr(`è½¬ç§»å­¦ç”Ÿ ${studentName} æ—¶å‘ç”Ÿé”™è¯¯:`, error.message);
			return { ok: false, error: error.message };
		}
	}

	/*************************************************
	 * æ–°ç»Ÿä¸€å…¥å£ï¼štransferStudentUnified
	 * - ä¿ç•™åŸ transferStudent é€»è¾‘ï¼ˆä¿å­˜ä¸º window._legacyTransferStudentï¼‰
	 * - Feature flag å¼€å¯æ—¶èµ° performCasOperationï¼ˆåœºæ™¯ transferï¼‰
	 * - åˆ©ç”¨ ping-pong æ£€æµ‹è‡ªåŠ¨ fastMode
	 *************************************************/
	if(!window._legacyTransferStudent){ window._legacyTransferStudent = transferStudent; }
	async function transferStudentUnified(fromRoom, toRoom, studentName, opts = {}){
		// ğŸš€ ä¼˜å…ˆä½¿ç”¨åŸå­åŒ–è½¬ç§»ï¼ˆæ–°æ¶æ„ï¼‰
		if (window.__ATOMIC_TRANSFER_ENABLED !== false && supabaseReady) {
			// æ”¹ä¸ºè°ƒç”¨æ–°çš„æ— æ¸…ç©ºå…ˆå ç›®æ ‡æµç¨‹
			if (typeof window.transferStudent === 'function') {
				logInfo(`ğŸš€ ä½¿ç”¨å‰ç«¯å¢å¼ºè½¬ç§»è·¯å¾„(å…ˆå ç›®æ ‡): ${studentName} ${fromRoom} â†’ ${toRoom}`);
				return await window.transferStudent(fromRoom, toRoom, studentName, opts);
			}
			logWarn('transferStudent æœªå®šä¹‰ï¼Œé™çº§åˆ°æ—§é€»è¾‘');
		}
		
		// é™çº§åˆ°ç°æœ‰æ¶æ„
		if(!window.__NEW_CAS_ENABLED){ 
			logInfo(`ğŸ“¦ ä½¿ç”¨ä¼ ç»Ÿè½¬ç§»è·¯å¾„: ${studentName} ${fromRoom} â†’ ${toRoom}`);
			return window._legacyTransferStudent(fromRoom, toRoom, studentName, opts); 
		}
		
		logInfo(`ğŸ”„ ä½¿ç”¨CASè½¬ç§»è·¯å¾„: ${studentName} ${fromRoom} â†’ ${toRoom}`);
		return performCasOperation({
			scenario:'transfer',
			meta:{ from:fromRoom, to:toRoom, student:studentName },
			rooms:[{ name:fromRoom, role:'from' }, { name:toRoom, role:'to' }],
			toleranceProfile:{ base:0, fast:2 },
			action: async ()=>{
				// é¿å…åµŒå¥— performCasOperationï¼šç›´æ¥è°ƒç”¨ legacy å‡½æ•°
				// ä½†åœ¨ legacy transfer å†…éƒ¨æ”¹ç”¨ legacy clear/assign é¿å…å¤šå±‚ç¡®è®¤
				return await window._legacyTransferStudent(fromRoom, toRoom, studentName, { ...opts, __viaUnified:true, __suppressNestedUnified:true });
			}
		});
	}
	window.transferStudentUnified = transferStudentUnified;
	async function clearRoom(roomName, opts = {}){
		// è§¦å‘å¤šè®¾å¤‡åŒæ­¥å¢å¼º
		syncEnhancer.recordUserOperation();
		
		// æ–¹æ¡ˆ1: æ“ä½œé—´éš”æ£€æµ‹ï¼Œç¡®ä¿Realtimeæ›´æ–°åˆ°è¾¾
		await waitForRealtimeSync(opts.afterVersionConflict ? { afterVersionConflict: true } : {});
		
		// æ£€æŸ¥æ“ä½œé”ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
		const lockKey = `clear_${roomName}`;
		if (Store.operationLocks?.has(lockKey)) {
			logWarn(`æˆ¿é—´ ${roomName} æ­£åœ¨æ¸…ç©ºä¸­ï¼Œè¯·ç¨å€™`);
			toast(`æˆ¿é—´ ${roomName} æ­£åœ¨æ¸…ç©ºä¸­...`, 'warn');
			return { ok: false, error: 'æ“ä½œè¿›è¡Œä¸­' };
		}
		
		const row = Store.rooms.find(r=>r.name===roomName);
		if(!row || !row.occupant_student_name) {
			toast('æˆ¿é—´å·²ä¸ºç©º');
			return {ok:true};
		}
		
		// è®¾ç½®æ“ä½œé”
		if (!Store.operationLocks) Store.operationLocks = new Set();
		Store.operationLocks.add(lockKey);
		
		try {
			// === CAS ç‰ˆæœ¬æ ¡éªŒï¼ˆå†™å‰ï¼‰===
			if (supabaseReady) {
				try {
					const localRow = Store.rooms.find(r=>r.name===roomName);
					const localVersion = (localRow && localRow.version) ? localRow.version : 0;
					const { data: remoteRow, error: verErr } = await supabaseClient
						.from('rooms')
						.select('name,occupant_student_name,register_time,version,heartbeat_at,updated_at')
						.eq('name', roomName)
						.maybeSingle();
					if(!verErr && remoteRow){
						const remoteVersion = remoteRow.version || 0;
						if(remoteVersion !== localVersion){
							logWarn(`[CAS] clear ç‰ˆæœ¬è½å ${roomName}: local v${localVersion} / remote v${remoteVersion}`);
							try {
								const canonical = canonicalizeRoom(remoteRow);
								const idx = Store.rooms.findIndex(r=>r.name===roomName);
								if(idx>=0) { Store.rooms[idx] = canonical; } else { Store.rooms.push(canonical); }
								renderRoomCardForced?.(roomName);
							}catch(_e){}
							return { ok:false, stale:true, reason:'version-mismatch', remoteVersion, localVersion };
						}
					}
					} catch(e){ logWarn('[CAS] clear ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥(å¿½ç•¥): '+ e.message); }
			}
			// ä¿å­˜å­¦ç”Ÿåç§°ç”¨äºåç»­æ—¥å¿—å†™å…¥ï¼ˆæ”¯æŒå¤šäººï¼‰
			const studentToLog = row.occupant_student_name;
			const students = studentToLog ? studentToLog.split(',').map(s => s.trim()) : [];
			
			// ä¹è§‚æ›´æ–°ï¼ˆç«‹å³æ˜¾ç¤ºæ•ˆæœï¼‰
			optimisticClear(roomName);
			
			if(!supabaseReady){ 
				logWarn('ç¦»çº¿æ¨¡å¼ - ä»…æœ¬åœ°æ¸…ç©º');
				// ç¦»çº¿æ¨¡å¼ï¼šä¸ºæ¯ä¸ªå­¦ç”Ÿå†™å…¥æœ¬åœ°ç»ƒä¹ ç»“æŸè®°å½•
				for(const student of students){
					await writePracticeLog(roomName, student, 'clear');
				}
				return {ok:true, offline:true}; 
			}
			
			const nextVersion = (row.version || 0) + 1;
			
			// æ ‡è®°ä¸ºå¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.set(roomName, { 
				student: null, 
				version: nextVersion, 
				timestamp: Date.now() 
			});
			
			const { data, error } = await supabaseClient.from('rooms').upsert({
				name: roomName,
				occupant_student_name: null, 
				register_time: null,
				heartbeat_at: new Date().toISOString(),
				version: nextVersion,
				updated_at: new Date().toISOString(),
			piano_type: row.pianoType || row.piano_type || 'å…¶ä»–',
			location: row.location || '',
			remark: row.remark || ''
			});			if(error){ 
				logErr('æ¸…ç©ºå¤±è´¥', error.message);
				// æ¸…ç©ºå¤±è´¥æ—¶å›æ»šæœ¬åœ°çŠ¶æ€
				const rollbackState = Store.rollbackStates?.get(roomName);
				if (rollbackState && row) {
					row.occupant_student_name = rollbackState.occupant_student_name;
					row.registerTime = rollbackState.registerTime;
					row.version = rollbackState.version;
					renderRoomCard(roomName);
					updateUsageStats();
					toast(`âŒ æ¸…ç©ºå¤±è´¥ï¼Œå·²å›æ»š ${roomName}`, 'error');
					
					// ğŸ—„ï¸ å›æ»šåä¿å­˜è®¡æ—¶å™¨çŠ¶æ€
					timerPersistence.saveTimerStates();
				}
				return {ok:false,error}; 
			}
			
			// æˆ¿é—´æ¸…ç©ºæˆåŠŸåä¸ºæ¯ä¸ªå­¦ç”Ÿå†™å…¥ç»ƒä¹ ç»“æŸè®°å½•
			for(const student of students){
				await writePracticeLog(roomName, student, 'clear');
			}
			
			logInfo(`æˆåŠŸæ¸…ç©º ${roomName} (v${nextVersion})`);

		// ğŸ”§ ä¿®å¤ï¼šæˆåŠŸåç«‹å³æ›´æ–°æœ¬åœ°ç‰ˆæœ¬å·ï¼Œé¿å…åç»­æ“ä½œå‡ºç°ç‰ˆæœ¬å†²çª
		const clearedRoom = Store.rooms.find(r => r.name === roomName);
		if(clearedRoom) {
			clearedRoom.version = nextVersion;
		}
			
			// è®°å½•æ“ä½œæ—¶é—´
			window.__lastRoomOperationTime = Date.now();
			
			// æ—§ç­–ç•¥ï¼š1.5s å†·å´ã€‚æ–°ç­–ç•¥ï¼šæçŸ­(200ms)æŠ€æœ¯ç¼“å†² + è‡ªåŠ¨å¿«é€Ÿé‡è¯•æ”¯æŒ
			if (!opts.skipCooldown) {
				if (!Store.roomCooldown) Store.roomCooldown = new Map();
				const buffer = 200; // ms
				Store.roomCooldown.set(roomName, Date.now() + buffer);
				setTimeout(() => {
					// ç¼“å†²ç»“æŸè‡ªåŠ¨ç§»é™¤ï¼Œé¿å…äººå·¥ç­‰å¾…
					if (Store.roomCooldown?.get(roomName) && Store.roomCooldown.get(roomName) <= Date.now()) {
						Store.roomCooldown.delete(roomName);
					}
					toast(`${roomName} å·²æ¸…ç©ºï¼Œå¯ç«‹å³ç™»è®°`, 'success');
				}, buffer);
			}
			
			// ğŸ”„ å•ä¸ªæˆ¿é—´æ¸…ç©ºæˆåŠŸåç«‹å³è§¦å‘è®¡æ—¶å™¨æ›´æ–°ï¼Œç¡®ä¿å…¶ä»–è®¾å¤‡åŒæ­¥
			setTimeout(() => {
				if (window.updateAllRoomTimers && typeof window.updateAllRoomTimers === 'function') {
					logInfo(`ğŸ”„ æˆ¿é—´ ${roomName} æ¸…ç©ºæˆåŠŸï¼Œè§¦å‘å…¨å±€è®¡æ—¶å™¨æ›´æ–°`);
					window.updateAllRoomTimers();
				}
			}, 100);
			
			return {ok:true, data};
			
		} finally {
			// æ¸…é™¤æ“ä½œé”
			Store.operationLocks.delete(lockKey);
			// æ¸…é™¤å¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.delete(roomName);
			// æ¸…é™¤è§†è§‰æŒ‡ç¤º
			clearOperationIndicator(roomName);
		}
	}

	/*************************************************
	 * æ–°ç»Ÿä¸€å…¥å£ï¼šclearRoomUnified
	 * - ä¿ç•™åŸ clearRoom é€»è¾‘ï¼ˆä¿å­˜ä¸º window._legacyClearRoomï¼‰
	 * - Feature flag å¼€å¯æ—¶èµ° performCasOperation
	 * - å…³é—­æ—¶å›é€€æ—§é€»è¾‘
	 *************************************************/
	if(!window._legacyClearRoom){ window._legacyClearRoom = clearRoom; }
	async function clearRoomUnified(roomName, opts = {}){
		if(!window.__NEW_CAS_ENABLED){ return window._legacyClearRoom(roomName, opts); }
		return performCasOperation({
			scenario:'clear',
			meta:{ room:roomName },
			rooms:[{ name:roomName, role:'single' }],
			toleranceProfile:{ base:0, fast:1 },
			action: async ()=>{
				return await window._legacyClearRoom(roomName, { ...opts, __viaUnified:true });
			}
		});
	}
	window.clearRoomUnified = clearRoomUnified;

	// çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥å’Œä¿®å¤
	async function reconcileRoomState(roomName) {
		if (!supabaseReady) return;
		
		// ä½¿ç”¨è¯·æ±‚é™æµå™¨é¿å…é¢‘ç¹çŠ¶æ€åŒæ­¥
		if (!requestThrottler.canExecute('reconcile', roomName)) return;
		
		try {
			const { data: cloudRoom, error } = await supabaseClient
				.from('rooms')
				.select('*')
				.eq('name', roomName)
				.single();
				
			requestStats.record('reconcile');
				
			if (error) {
				logWarn(`è·å–æˆ¿é—´ ${roomName} äº‘ç«¯çŠ¶æ€å¤±è´¥:`, error.message);
				return;
			}
			
			const localRoom = Store.rooms.find(r => r.name === roomName);
			if (!localRoom) return;
			
			const cloudVersion = cloudRoom?.version || 0;
			const localVersion = localRoom.version || 0;
			
			// å¦‚æœäº‘ç«¯ç‰ˆæœ¬æ›´æ–°ï¼ŒåŒæ­¥åˆ°æœ¬åœ°
			if (cloudVersion > localVersion) {
				logInfo(`åŒæ­¥æˆ¿é—´ ${roomName} çŠ¶æ€: v${localVersion} -> v${cloudVersion}`);
				localRoom.occupant_student_name = cloudRoom.occupant_student_name;
				localRoom.registerTime = cloudRoom.register_time ? new Date(cloudRoom.register_time).getTime() : null;
				localRoom.version = cloudVersion;
				localRoom.heartbeatAt = cloudRoom.heartbeat_at;
				
				renderRoomCard(roomName);
				updateUsageStats();
				
				const action = cloudRoom.occupant_student_name ? 'å ç”¨' : 'é‡Šæ”¾';
				toast(`ğŸ”„ ${roomName} çŠ¶æ€å·²åŒæ­¥: ${action}`, 'info');
			}
		} catch (e) {
			logWarn(`æˆ¿é—´çŠ¶æ€åŒæ­¥å¼‚å¸¸ ${roomName}:`, e.message);
		}
	}
	
	// å®šæœŸçŠ¶æ€æ£€æŸ¥
	let stateCheckInterval;
	function startPeriodicStateCheck() {
		// é˜²æ­¢é‡å¤åˆ›å»ºå®šæ—¶å™¨
		if (window.__periodicStateCheckInterval) {
			clearInterval(window.__periodicStateCheckInterval);
		}
		
		// ğŸ’¡ çŠ¶æ€æ£€æŸ¥é¢‘ç‡ä¼˜åŒ– - å¤§å¹…é™ä½æˆ–ç¦ç”¨
		const STATE_CHECK_ENABLED = false; // ğŸ”§ é»˜è®¤ç¦ç”¨å‘¨æœŸæ€§çŠ¶æ€æ£€æŸ¥
		const STATE_CHECK_INTERVAL = 600000; // 10åˆ†é’Ÿï¼ˆå¦‚æœå¯ç”¨çš„è¯ï¼‰
		
		if (STATE_CHECK_ENABLED) {
			logInfo(`å¯ç”¨å‘¨æœŸæ€§çŠ¶æ€æ£€æŸ¥ï¼Œé—´éš”${STATE_CHECK_INTERVAL/60000}åˆ†é’Ÿ`);
			window.__periodicStateCheckInterval = setInterval(async () => {
				try {
					// æ£€æŸ¥ç´§æ€¥åˆ¹è½¦
					if (emergencyBrake.isEngaged()) return;
					
					// åªåœ¨å¿…è¦æ—¶è¿›è¡ŒçŠ¶æ€æ£€æŸ¥
					if (!supabaseReady || !supabaseClient) return;
					
					// æ£€æŸ¥realtimeè¿æ¥çŠ¶æ€ï¼Œå¦‚æœæ­£å¸¸å°±è·³è¿‡çŠ¶æ€æ£€æŸ¥
					const timeSinceActivity = Date.now() - realtimeMonitor.lastActivity;
					if (timeSinceActivity < 300000) { // 5åˆ†é’Ÿå†…æœ‰realtimeæ´»åŠ¨
						logInfo('Realtimeè¿æ¥æ­£å¸¸ï¼Œè·³è¿‡å‘¨æœŸæ€§çŠ¶æ€æ£€æŸ¥');
						return;
					}
					
					// æ£€æŸ¥æœ‰å ç”¨è€…çš„æˆ¿é—´çŠ¶æ€
					const occupiedRooms = Store.rooms.filter(r => r.occupant_student_name && r.registerTime);
					if (occupiedRooms.length === 0) return; // æ²¡æœ‰å ç”¨æˆ¿é—´æ—¶è·³è¿‡æ£€æŸ¥
					
					logInfo(`å¤‡ç”¨çŠ¶æ€æ£€æŸ¥: ${occupiedRooms.length} ä¸ªå ç”¨æˆ¿é—´ï¼ˆrealtimeå¼‚å¸¸æ—¶ï¼‰`);
					
					for (let i = 0; i < occupiedRooms.length; i++) {
						const room = occupiedRooms[i];
						await reconcileRoomState(room.name);
						// å¢åŠ é—´éš”æ—¶é—´ï¼Œå‡å°‘å¹¶å‘å‹åŠ›
						if (i < occupiedRooms.length - 1) {
							await new Promise(resolve => setTimeout(resolve, 1000));
						}
					}
				} catch (error) {
					logWarn('å‘¨æœŸæ€§çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error.message);
				}
			}, STATE_CHECK_INTERVAL);
		} else {
			logInfo('å‘¨æœŸæ€§çŠ¶æ€æ£€æŸ¥å·²ç¦ç”¨ï¼Œå®Œå…¨ä¾èµ–realtimeå’Œäº‹ä»¶è§¦å‘');
		}
	}
	
	// æ“ä½œè¶…æ—¶æ£€æµ‹å’Œæ¢å¤
	function setupOperationTimeoutDetection() {
		// é˜²æ­¢é‡å¤åˆ›å»ºå®šæ—¶å™¨
		if (window.__operationTimeoutInterval) {
			clearInterval(window.__operationTimeoutInterval);
		}
		
		window.__operationTimeoutInterval = setInterval(() => {
			try {
				if (!Store.pendingAssign || Store.pendingAssign.size === 0) return;
				
				const now = Date.now();
				const timeoutThreshold = 15000; // å»¶é•¿åˆ°15ç§’è¶…æ—¶ï¼Œå‡å°‘è¯¯åˆ¤
				
				for (const [roomName, pending] of Store.pendingAssign.entries()) {
					if (now - pending.timestamp > timeoutThreshold) {
						logWarn(`æˆ¿é—´ ${roomName} æ“ä½œè¶…æ—¶ï¼Œè§¦å‘çŠ¶æ€æ£€æŸ¥`);
						
						// æ¸…é™¤å¾…å¤„ç†çŠ¶æ€
						Store.pendingAssign.delete(roomName);
						
						// æ¸…é™¤æ“ä½œé”
						if (Store.operationLocks) {
							Store.operationLocks.delete(`assign_${roomName}`);
							Store.operationLocks.delete(`clear_${roomName}`);
						}
						
						// è§¦å‘çŠ¶æ€åŒæ­¥
						reconcileRoomState(roomName);
						
						toast(`âš ï¸ ${roomName} æ“ä½œè¶…æ—¶ï¼Œå·²é‡æ–°åŒæ­¥çŠ¶æ€`, 'warn');
					}
				}
			} catch (error) {
				logWarn('è¶…æ—¶æ£€æµ‹å¤±è´¥:', error.message);
			}
		}, 60000); // ğŸ’¡ å»¶é•¿åˆ°60ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œå‡å°‘è½®è¯¢é¢‘ç‡
	}
	function optimisticAssign(roomName, student, version){
		let r=Store.rooms.find(r=>r.name===roomName); 
		if(!r){ 
			r=canonicalizeRoom({name:roomName}); 
			Store.rooms.push(r); 
		}
		
		// ä¿å­˜åŸå§‹çŠ¶æ€ç”¨äºå¯èƒ½çš„å›æ»š
		if (!Store.rollbackStates) Store.rollbackStates = new Map();
		Store.rollbackStates.set(roomName, {
			occupant_student_name: r.occupant_student_name,
			registerTime: r.registerTime,
			version: r.version
		});
		
		// === ä¸´æ—¶ç™»è®°æ ¸å¿ƒæ”¹åŠ¨ (Strategy A Enhanced) ===
		r.occupant_student_name = student; 
		
		// ğŸ”¥ å…³é”®ä¿®å¤ï¼šç¡®ä¿æœ¬åœ°ä¹è§‚æ›´æ–°ä½¿ç”¨"åˆšåˆš"çš„æ—¶é—´ï¼Œé¿å…é—ªçƒ
		// ä½¿ç”¨å½“å‰æ—¶é—´è€Œéå¯èƒ½æœ‰åå·®çš„ serverSync æ—¶é—´
		const nowTs = Date.now();
		r.registerTime = nowTs; 
		try { r.register_time = new Date(nowTs).toISOString(); } catch(_) { r.register_time = new Date().toISOString(); }
		
		// æ ‡è®°è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶(ä¹è§‚)æ—¶é—´æˆ³ï¼ŒRealtime åˆ°è¾¾åä¼šè¢«è¦†ç›–å¹¶æ¸…é™¤æ ‡è®°
		r.__tempRegister = true;
		
		// ğŸ’¡ é¢å¤–ä¿éšœï¼šè®°å½•ä¹è§‚æ›´æ–°çš„ç²¾ç¡®æ—¶é—´ï¼Œä¾› statusInfo ä½¿ç”¨
		r.__optimisticAssignTime = nowTs;
		r.version = version || r.version + 1; 
		Store.pendingAssign.set(roomName,{occupant_student_name:student,version:r.version,ts:Date.now()});
		
		// ğŸ”„ ç™»è®°æ“ä½œæ—¶ç«‹å³è§¦å‘å¢å¼ºåŒæ­¥æ¨¡å¼
		syncEnhancer.recordUserOperation();
		
		// æ·»åŠ è§†è§‰æŒ‡ç¤º
		const card = document.querySelector(`[data-room="${roomName}"]`);
		if (card) {
			card.classList.add('pending-operation');
			card.dataset.status = 'syncing';
		}
		
		renderRoomCard(roomName); 
		updateUsageStats(); 
		toast(`âœ… å·²ç™»è®° ${student} -> ${roomName}`, 'success');
		
		// ğŸ—„ï¸ ä¿å­˜è®¡æ—¶å™¨çŠ¶æ€
		timerPersistence.saveTimerStates();
		
		return true;
	}
	
	function rollbackOptimisticAssign(roomName) {
		if (!Store.rollbackStates) return;
		
		const originalState = Store.rollbackStates.get(roomName);
		if (!originalState) return;
		
		const r = Store.rooms.find(r => r.name === roomName);
			if (r) {
				r.occupant_student_name = originalState.occupant_student_name;
				// å›æ»š registerTime / register_time
				r.registerTime = originalState.registerTime;
				if (originalState.registerTime) {
					try { r.register_time = new Date(originalState.registerTime).toISOString(); } catch(_) { r.register_time = null; }
				} else {
					r.register_time = null;
				}
				if (r.__tempRegister) {
					delete r.__tempRegister;
					delete r.__optimisticAssignTime; // å›æ»šæ—¶ä¹Ÿæ¸…é™¤ä¹è§‚æ—¶é—´
				}
				r.version = originalState.version;
			
			// ç§»é™¤è§†è§‰æŒ‡ç¤º
			const card = document.querySelector(`[data-room="${roomName}"]`);
			if (card) {
				card.classList.remove('pending-operation');
			}
			
			renderRoomCard(roomName);
			updateUsageStats();
			toast(`âŒ ç™»è®°å¤±è´¥ï¼Œå·²å›æ»š ${roomName}`, 'error');
			
			// ğŸ—„ï¸ å›æ»šåä¿å­˜è®¡æ—¶å™¨çŠ¶æ€
			timerPersistence.saveTimerStates();
		}
		
		Store.rollbackStates.delete(roomName);
		Store.pendingAssign.delete(roomName);
	}
	
	function optimisticClear(roomName, version){
		const r=Store.rooms.find(r=>r.name===roomName); 
		if(!r) return;
		
		// ä¿å­˜åŸå§‹çŠ¶æ€ç”¨äºå¯èƒ½çš„å›æ»š
		if (!Store.rollbackStates) Store.rollbackStates = new Map();
		Store.rollbackStates.set(roomName, {
			occupant_student_name: r.occupant_student_name,
			registerTime: r.registerTime,
			version: r.version
		});
		
		if(r.occupant_student_name){ 
			writePracticeLogLocal(r); 
		}
		
		r.occupant_student_name=null; 
		r.registerTime=null; 
		r.version=version||r.version+1;
		
		// ğŸ”„ é‡Šæ”¾æ“ä½œæ—¶ç«‹å³è§¦å‘å¢å¼ºåŒæ­¥æ¨¡å¼
		syncEnhancer.recordUserOperation(); 
		
		// æ·»åŠ è§†è§‰æŒ‡ç¤º
		const card = document.querySelector(`[data-room="${roomName}"]`);
		if (card) {
			card.classList.add('pending-operation');
			card.dataset.status = 'syncing';
		}
		
		renderRoomCard(roomName); 
		updateUsageStats(); 
		toast(`âœ… å·²æ¸…ç©º ${roomName}`, 'success');
		
		// ğŸ—„ï¸ ä¿å­˜è®¡æ—¶å™¨çŠ¶æ€
		timerPersistence.saveTimerStates();
		
		return true;
	}
	
	// ç§»é™¤æ“ä½œè¿›è¡Œä¸­çš„è§†è§‰æŒ‡ç¤º
	function clearOperationIndicator(roomName) {
		const card = document.querySelector(`[data-room="${roomName}"]`);
		if (card) {
			card.classList.remove('pending-operation');
		}
	}
	
	// å½»åº•æ¸…ç†æˆ¿é—´çš„æ‰€æœ‰çŠ¶æ€
	function cleanupRoomState(roomName) {
		// æ¸…ç†å¾…å¤„ç†æ“ä½œ
		Store.pendingAssign.delete(roomName);
		
		// æ¸…ç†å›æ»šçŠ¶æ€
		if (Store.rollbackStates) {
			Store.rollbackStates.delete(roomName);
		}
		
		// æ¸…ç†æ“ä½œé”
		if (Store.operationLocks) {
			Store.operationLocks.delete(`assign_${roomName}`);
			Store.operationLocks.delete(`clear_${roomName}`);
			Store.operationLocks.delete(`renew_${roomName}`);
			Store.operationLocks.delete(`delete_${roomName}`);
		}
		
		// ğŸ’¡ æ›´å½»åº•çš„DOMæ¸…ç†ï¼šå°è¯•å¤šç§é€‰æ‹©å™¨
		const selectors = [
			`[data-room="${CSS.escape(roomName)}"]`,
			`[data-room='${CSS.escape(roomName)}']`,
			`.room-card[data-room="${CSS.escape(roomName)}"]`
		];
		
		let domCleaned = false;
		for (const selector of selectors) {
			const cards = document.querySelectorAll(selector);
			if (cards.length > 0) {
				cards.forEach(card => {
					card.remove();
					domCleaned = true;
				});
			}
		}
		
		if (domCleaned) {
			logInfo(`ğŸ§¹ DOMæ¸…ç†å®Œæˆ: ${roomName}`);
		}
		
		logInfo(`å·²æ¸…ç†æˆ¿é—´ ${roomName} çš„æ‰€æœ‰çŠ¶æ€`);
	}
	async function setupRealtime(){
		// æ£€æŸ¥é¡µé¢å¯è§æ€§
		if (document.hidden) {
			logInfo('é¡µé¢éšè—ä¸­ï¼Œè·³è¿‡realtimeåˆå§‹åŒ–');
			return;
		}
		
		// æ£€æŸ¥ç´§æ€¥åˆ¹è½¦çŠ¶æ€
		if (emergencyBrake.isEngaged()) {
			logWarn('ç´§æ€¥åˆ¹è½¦æ¿€æ´»ä¸­ï¼Œè·³è¿‡realtimeåˆå§‹åŒ–');
			return;
		}
		
		if(!supabaseReady) {
			logWarn('Supabase æœªå°±ç»ªï¼Œè·³è¿‡å®æ—¶è®¢é˜…');
			updateSyncStatus('error', 'æœªè¿æ¥');
			return;
		}
		
		// ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ supabaseClient æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
		if (!supabaseClient || !supabaseClient.channel) {
			logErr('âŒ Supabase å®¢æˆ·ç«¯æ— æ•ˆï¼Œæ— æ³•å»ºç«‹ Realtime è¿æ¥');
			updateSyncStatus('error', 'å®¢æˆ·ç«¯æ— æ•ˆ');
			// å°è¯•é‡æ–°åˆå§‹åŒ– Supabase
			setTimeout(() => {
				logInfo('å°è¯•é‡æ–°åˆå§‹åŒ– Supabase...');
				supabaseReady = false;
				window.__roomsRealtimeInit = false;
				initSupabase().then(() => {
					if (supabaseReady) {
						setupRealtime();
					}
				});
			}, 3000);
			return;
		}
		
		// é¿å…é‡å¤åˆå§‹åŒ–ï¼ˆæ ‡ç­¾é¡µå¤šæ¬¡è§¦å‘ï¼‰
		if(window.__roomsRealtimeInit && !window.__roomsRealtimeReconnecting){
			logInfo('setupRealtime å·²åˆå§‹åŒ–ï¼Œè·³è¿‡');
			return;
		}
		window.__roomsRealtimeInit = true;
		
		updateSyncStatus('connecting', 'è®¢é˜…ä¸­...');
		
		// æ¸…ç†æ—§è¿æ¥ï¼ˆå¢åŠ é”™è¯¯å¤„ç†å’Œç­‰å¾…æ—¶é—´ï¼‰
		const cleanupPromises = [];
		
		if(realtimeChannel){ 
			try{ 
				const removePromise = supabaseClient.removeChannel(realtimeChannel);
				cleanupPromises.push(
					Promise.race([
						removePromise,
						new Promise(resolve => setTimeout(resolve, 2000)) // 2ç§’è¶…æ—¶
					])
				);
				logInfo('æ­£åœ¨ç§»é™¤æ—§çš„å®æ—¶é¢‘é“...');
			}catch(e){
				logWarn('ç§»é™¤æ—§é¢‘é“å¤±è´¥', e.message);
			} 
		}
		
		// æ¸…ç†å­¦ç”Ÿæ•°æ®åº“æ—§è¿æ¥
		if(window.studentRealtimeChannel){ 
			try{ 
				const removePromise = supabaseClient.removeChannel(window.studentRealtimeChannel);
				cleanupPromises.push(
					Promise.race([
						removePromise,
						new Promise(resolve => setTimeout(resolve, 2000)) // 2ç§’è¶…æ—¶
					])
				);
				logInfo('æ­£åœ¨ç§»é™¤æ—§çš„å­¦ç”Ÿå®æ—¶é¢‘é“...');
			}catch(e){
				logWarn('ç§»é™¤æ—§å­¦ç”Ÿé¢‘é“å¤±è´¥', e.message);
			} 
		}
		
		// ğŸ”§ ç­‰å¾…æ—§è¿æ¥æ¸…ç†å®Œæˆï¼Œé¿å…è¿æ¥å†²çª
		if (cleanupPromises.length > 0) {
			try {
				await Promise.all(cleanupPromises);
				logInfo('æ—§è¿æ¥æ¸…ç†å®Œæˆ');
				// çŸ­æš‚å»¶è¿Ÿï¼Œç¡®ä¿æœåŠ¡å™¨ç«¯ä¹Ÿæ¸…ç†å®Œæˆ
				await new Promise(resolve => setTimeout(resolve, 500));
			} catch (e) {
				logWarn('æ—§è¿æ¥æ¸…ç†å¼‚å¸¸ï¼ˆç»§ç»­ï¼‰:', e.message);
			}
		}
		
		// åˆ›å»ºæ–°çš„å®æ—¶é¢‘é“ï¼ˆæˆ¿é—´ï¼‰
		window.__roomsRealtimeReconnecting = true;
		realtimeChannel = supabaseClient.channel('realtime-rooms')
			.on('postgres_changes', {
				event: '*',
				schema: 'public',
				table: 'rooms'
			}, (payload) => {
				const roomName = payload.new?.name || payload.old?.name;
				logInfo(`ğŸ”” [ROOMSè¡¨] æ”¶åˆ°å®æ—¶äº‹ä»¶: ${payload.eventType} - ${roomName}`);
				
				// ğŸ’¡ ç‰¹åˆ«æ ‡è®°åˆ é™¤äº‹ä»¶
				if(payload.eventType === 'DELETE'){
					logInfo(`ğŸ—‘ï¸ [ROOMSè¡¨] DELETEäº‹ä»¶è¯¦æƒ…:`, payload);
				}
				
				// è®°å½•æ•°æ®æ›´æ–°æ—¶é—´å’Œæ´»åŠ¨
				window.__lastRealtimeDataUpdate = Date.now();
				realtimeMonitor.recordActivity(); // è®°å½•realtimeæ´»åŠ¨
				requestStats.record('realtimeEvents'); // è®°å½•realtimeäº‹ä»¶ç»Ÿè®¡
				handleRealtimeRoom(payload);
			})
			.subscribe((status) => {
				if (status === 'SUBSCRIBED') {
					// åªåœ¨é¦–æ¬¡è¿æ¥æˆ–é‡è¿æˆåŠŸæ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
					const hadReconnectAttempts = window.__roomsRealtimeAttempts > 0;
					if (hadReconnectAttempts) {
						logInfo('âœ… æˆ¿é—´å®æ—¶åŒæ­¥é‡è¿æˆåŠŸ');
						toast('å®æ—¶åŒæ­¥å·²æ¢å¤');
					} else if (!window.__roomsInitialConnected) {
						logInfo('âœ… æˆ¿é—´å®æ—¶åŒæ­¥å·²è¿æ¥');
						toast('å®æ—¶åŒæ­¥å·²å¯ç”¨');
						window.__roomsInitialConnected = true;
					}
					updateSyncStatus('connected', 'å®æ—¶åŒæ­¥');
					window.__roomsRealtimeReconnecting = false;
					window.__roomsRealtimeAttempts = 0;
				} else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT' || status==='CLOSED') {
					// ğŸ“± é¡µé¢éšè—æ—¶çš„æ™ºèƒ½å¤„ç†
					if (realtimeMonitor.pageHidden) {
						// é¡µé¢éšè—æ—¶é™é»˜å¤„ç†ï¼Œä¸è®°å½•æ—¥å¿—
						console.debug(`[RT][rooms] é¡µé¢éšè—ä¸­ï¼Œé™é»˜å¤„ç†è¿æ¥çŠ¶æ€ (${status})`);
						return;
					}
					
					// åˆšä»éšè—çŠ¶æ€æ¢å¤ï¼Œç»™è¿æ¥ä¸€äº›æ¢å¤æ—¶é—´
					if ((Date.now() - (window.__lastVisibilityChange || 0)) < 5000) {
						console.debug(`[RT][rooms] é¡µé¢åˆšæ¢å¤å¯è§ï¼Œå»¶è¿Ÿå¤„ç† (status=${status})`);
						return;
					}
					
					// ğŸ¤– ä½¿ç”¨æ™ºèƒ½é‡è¿ç­–ç•¥
					if (!realtimeMonitor.shouldAttemptReconnect(status)) {
						console.debug(`[RT][rooms] æ™ºèƒ½é‡è¿ç­–ç•¥å†³å®šè·³è¿‡é‡è¿ (${status})`);
						return;
					}
					
					// é˜²æ­¢é‡å¤è§¦å‘é‡è¿
					if (window.__roomsRealtimeReconnectTimer) {
						logInfo(`[RT][rooms] çŠ¶æ€=${status} å·²æœ‰é‡è¿è®¡æ—¶å™¨è¿è¡Œï¼Œè·³è¿‡`);
						return;
					}
					
					const attempts = (window.__roomsRealtimeAttempts||0) + 1;
					window.__roomsRealtimeAttempts = attempts;
					
					// åŒºåˆ†ä¸åŒé”™è¯¯ç±»å‹çš„å¤„ç†ç­–ç•¥
					let shouldReconnect = true;
					let baseDelay = 1000;
					
					if (status === 'CLOSED') {
						// CLOSEDçŠ¶æ€å¯èƒ½æ˜¯æ­£å¸¸å…³é—­ï¼Œå‡å°‘é‡è¿é¢‘ç‡
						baseDelay = 3000;
						// å¦‚æœçŸ­æ—¶é—´å†…å¤šæ¬¡CLOSEDï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œå»¶é•¿ç­‰å¾…
						const now = Date.now();
						const lastClosedTime = window.__lastClosedTime || 0;
						if (now - lastClosedTime < 10000) { // 10ç§’å†…å¤šæ¬¡CLOSED
							baseDelay = Math.min(30000, baseDelay * attempts); // æœ€é•¿30ç§’
						}
						window.__lastClosedTime = now;
					}
					
					// æ™ºèƒ½é‡è¿å»¶è¿Ÿç®—æ³•
					const maxDelay = status === 'CLOSED' ? 180000 : 120000; // CLOSEDçŠ¶æ€å…è®¸æ›´é•¿å»¶è¿Ÿ
					const delay = Math.min(maxDelay, Math.round(baseDelay * Math.pow(1.4, attempts-1) + Math.random()*1000));
					
					// è¶…è¿‡5æ¬¡é‡è¿å¤±è´¥åï¼Œå¤§å¹…å»¶é•¿é‡è¿é—´éš”
					if (attempts > 5) {
						const longDelay = Math.min(300000, delay * 2); // æœ€é•¿5åˆ†é’Ÿ
						// åªåœ¨ç¬¬6æ¬¡å’Œæ¯10æ¬¡æ—¶è¾“å‡ºæ—¥å¿—
						if(attempts === 6 || attempts % 10 === 0) {
							logWarn(`[RT][rooms] çŠ¶æ€=${status} é‡è¿#${attempts} å»¶é•¿ç­‰å¾… ${Math.round(longDelay/1000)}ç§’ (é¢‘ç¹å¤±è´¥)`);
						}
						updateSyncStatus('error', `è¿æ¥å¼‚å¸¸ï¼Œ${Math.round(longDelay/1000)}ç§’åé‡è¯•`);
						
						window.__roomsRealtimeReconnectTimer = setTimeout(()=>{
							window.__roomsRealtimeReconnectTimer = null;
							window.__roomsRealtimeReconnecting = true;
							setupRealtime();
						}, longDelay);
					} else if (attempts > 3) {
						const mediumDelay = Math.min(180000, delay * 1.5); // æœ€é•¿3åˆ†é’Ÿ
						// åªåœ¨ç¬¬4æ¬¡å’Œç¬¬8æ¬¡æ—¶è¾“å‡ºæ—¥å¿—
						if(attempts === 4 || attempts % 4 === 0) {
							logWarn(`[RT][rooms] çŠ¶æ€=${status} é‡è¿#${attempts} å»¶é•¿ç­‰å¾… ${Math.round(mediumDelay/1000)}ç§’`);
						}
						updateSyncStatus('error', `é‡è¿å¤±è´¥ï¼Œ${Math.round(mediumDelay/1000)}ç§’åé‡è¯•`);
						
						window.__roomsRealtimeReconnectTimer = setTimeout(()=>{
							window.__roomsRealtimeReconnectTimer = null;
							window.__roomsRealtimeReconnecting = true;
							setupRealtime();
						}, mediumDelay);
					} else {
						// å‡å°‘æ—¥å¿—é¢‘ç‡ï¼šåªåœ¨å‰2æ¬¡æˆ–æ¯5æ¬¡è¾“å‡ºè­¦å‘Š
						if(attempts <= 2 || attempts % 5 === 0) {
							logWarn(`[RT][rooms] çŠ¶æ€=${status} é‡è¿#${attempts} é¢„è®¡ ${Math.round(delay/1000)}ç§’`);
						}
						updateSyncStatus('error', 'é‡è¿ä¸­');
						
						window.__roomsRealtimeReconnectTimer = setTimeout(()=>{
							window.__roomsRealtimeReconnectTimer = null;
							window.__roomsRealtimeReconnecting = true;
							setupRealtime();
						}, delay);
					}
				} else {
					logInfo('[RT][rooms] çŠ¶æ€=', status);
				}
			});
		
		// åˆ›å»ºå­¦ç”Ÿæ•°æ®åº“å®æ—¶é¢‘é“
		window.studentRealtimeChannel = supabaseClient.channel('realtime-students')
			.on('postgres_changes', {
				event: '*',
				schema: 'public',
				table: 'student_database'
			}, (payload) => {
				if(!window.__studentRealtimeSeq) window.__studentRealtimeSeq=0;
				window.__studentRealtimeSeq++;
				const seq=window.__studentRealtimeSeq;
				const name = payload.new?.name || payload.old?.name;
				const src = (payload.subscription && payload.subscription.socket) ? 'ws' : 'unknown';
				console.log(`[RT][students][${seq}] event=${payload.eventType} name=${name} origin=${src}`, payload);
				
				// è®°å½•æ•°æ®æ›´æ–°æ—¶é—´å’Œæ´»åŠ¨
				window.__lastRealtimeDataUpdate = Date.now();
				realtimeMonitor.recordActivity(); // è®°å½•realtimeæ´»åŠ¨
				requestStats.record('realtimeEvents'); // è®°å½•realtimeäº‹ä»¶ç»Ÿè®¡
				try{ handleRealtimeStudent(payload); }catch(e){ console.warn('[RT] å¤„ç†å­¦ç”Ÿäº‹ä»¶å¼‚å¸¸', e); }
			})
			.subscribe((status) => {
				const nowTs=new Date().toISOString();
				if (status === 'SUBSCRIBED') {
					// åªåœ¨é¦–æ¬¡è¿æ¥æˆ–é‡è¿æˆåŠŸæ—¶è¾“å‡ºæ—¥å¿—
					const hadReconnectAttempts = window.__studentsRealtimeAttempts > 0;
					if (hadReconnectAttempts) {
						console.log(`[RT][students] âœ… é‡è¿æˆåŠŸ @${nowTs}`);
					} else if (!window.__studentsInitialConnected) {
						console.log(`[RT][students] âœ… åˆæ¬¡è¿æ¥æˆåŠŸ @${nowTs}`);
						window.__studentsInitialConnected = true;
					}
					window.__studentsRealtimeAttempts = 0;
					if(window.loadFromCloud){ setTimeout(()=>{ try{ loadFromCloud(); }catch(_){ } }, 800); }
				} else if (status === 'CHANNEL_ERROR' || status==='TIMED_OUT' || status==='CLOSED') {
					// ğŸ“± é¡µé¢éšè—æ—¶çš„æ™ºèƒ½å¤„ç†
					if (realtimeMonitor.pageHidden) {
						// é¡µé¢éšè—æ—¶é™é»˜å¤„ç†ï¼Œä¸è®°å½•æ—¥å¿—
						console.debug(`[RT][students] é¡µé¢éšè—ä¸­ï¼Œé™é»˜å¤„ç†è¿æ¥çŠ¶æ€ (${status})`);
						return;
					}
					
					// åˆšä»éšè—çŠ¶æ€æ¢å¤ï¼Œç»™è¿æ¥ä¸€äº›æ¢å¤æ—¶é—´
					if ((Date.now() - (window.__lastVisibilityChange || 0)) < 5000) {
						console.debug(`[RT][students] é¡µé¢åˆšæ¢å¤å¯è§ï¼Œå»¶è¿Ÿå¤„ç† (status=${status})`);
						return;
					}
					
					// å¯¹äº CLOSED çŠ¶æ€ï¼Œæ›´åŠ ä¿å®ˆçš„å¤„ç†
					if (status === 'CLOSED') {
						// æ£€æŸ¥æ˜¯å¦é¢‘ç¹å‡ºç° CLOSED äº‹ä»¶
						if (realtimeMonitor.checkClosedEventFrequency()) {
							console.warn(`[RT][students] é¢‘ç¹çš„ CLOSED äº‹ä»¶ï¼Œæš‚åœé‡è¿ 10 åˆ†é’Ÿ`);
							// 10åˆ†é’Ÿåé‡ç½®è®¡æ•°å™¨
							setTimeout(() => {
								realtimeMonitor.closedEvents = [];
								console.log(`[RT][students] CLOSED äº‹ä»¶è®¡æ•°å™¨å·²é‡ç½®`);
							}, 600000);
							return;
						}
						
						const timeSinceActivity = Date.now() - realtimeMonitor.lastActivity;
						// å¦‚æœæœ€è¿‘æœ‰æ´»åŠ¨ï¼ˆ5åˆ†é’Ÿå†…ï¼‰ï¼Œè¯´æ˜è¿æ¥æ˜¯æ­£å¸¸çš„ï¼Œå¯èƒ½æ˜¯ä¸´æ—¶æ–­å¼€
						if (timeSinceActivity < 300000) {
							console.log(`[RT][students] CLOSEDçŠ¶æ€ä½†æœ€è¿‘æœ‰æ´»åŠ¨(${Math.round(timeSinceActivity/60000)}åˆ†é’Ÿå‰)ï¼Œå»¶è¿Ÿé‡è¿`);
							// å»¶è¿Ÿ15ç§’åå†æ£€æŸ¥æ˜¯å¦éœ€è¦é‡è¿
							setTimeout(() => {
								if (!document.hidden && !realtimeMonitor.isReconnecting && !window.studentRealtimeChannel) {
									console.log(`[RT][students] å»¶è¿Ÿæ£€æŸ¥åç¡®è®¤éœ€è¦é‡è¿`);
									setupRealtime();
								}
							}, 15000);
							return;
						}
					}
					
					// æ£€æŸ¥ç½‘ç»œçŠ¶æ€
					if (window.RealtimeConnectionManager && !window.RealtimeConnectionManager.checkNetworkStatus()) {
						console.log(`[RT][students] ç½‘ç»œç¦»çº¿ï¼Œè·³è¿‡é‡è¿`);
						return;
					}
					
					// æ£€æŸ¥æ˜¯å¦æ­£åœ¨å¼ºåˆ¶é‡è¿ä¸­
					if (realtimeMonitor.isReconnecting) {
						console.log(`[RT][students] å¼ºåˆ¶é‡è¿è¿›è¡Œä¸­ï¼Œè·³è¿‡è‡ªåŠ¨é‡è¿ (status=${status})`);
						return;
					}
					
					// é˜²æ­¢é‡å¤è§¦å‘é‡è¿
					if (window.__studentsRealtimeReconnectTimer) {
						console.log(`[RT][students] çŠ¶æ€=${status} å·²æœ‰é‡è¿è®¡æ—¶å™¨è¿è¡Œï¼Œè·³è¿‡`);
						return;
					}
					
					// ğŸ¤– ä½¿ç”¨æ™ºèƒ½é‡è¿ç­–ç•¥
					if (!realtimeMonitor.shouldAttemptReconnect(status)) {
						console.debug(`[RT][students] æ™ºèƒ½é‡è¿ç­–ç•¥å†³å®šè·³è¿‡é‡è¿ (${status})`);
						return;
					}
					
					const attempts = (window.__studentsRealtimeAttempts||0)+1;
					window.__studentsRealtimeAttempts = attempts;
					
					// ä½¿ç”¨ç»Ÿä¸€çš„é‡è¿å»¶è¿Ÿè®¡ç®—
					const delay = realtimeMonitor.calculateReconnectDelay(attempts, status);
					
					// æ ¹æ®é¡µé¢çŠ¶æ€é€‰æ‹©æ—¥å¿—çº§åˆ«
					const logLevel = document.hidden || realtimeMonitor.silentMode ? 'debug' : 'warn';
					const logFunc = logLevel === 'debug' ? console.debug : console.warn;
					
					// å‡å°‘æ—¥å¿—é¢‘ç‡
					if (attempts <= 2 || attempts % 5 === 0) {
						logFunc(`[RT][students] çŠ¶æ€=${status} é‡è¿#${attempts} in ${Math.round(delay/1000)}s`);
					}
					
					window.__studentsRealtimeReconnectTimer=setTimeout(()=>{
						window.__studentsRealtimeReconnectTimer=null;
						setupRealtime();
					}, delay);
				} else {
					const logFunc = document.hidden || realtimeMonitor.silentMode ? console.debug : console.log;
					logFunc(`[RT][students] çŠ¶æ€=${status} @${nowTs}`);
				}
			});
		
		// ğŸ’¡ æ·»åŠ æˆ¿é—´å…ƒæ•°æ®å®æ—¶è®¢é˜…ï¼Œç¡®ä¿å¤‡æ³¨ç­‰ä¿¡æ¯çš„å¤šè®¾å¤‡åŒæ­¥
		if (!window.__roomMetaRealtimeInit) {
			window.__roomMetaRealtimeInit = true;
			logInfo('åˆå§‹åŒ–æˆ¿é—´å…ƒæ•°æ®å®æ—¶è®¢é˜…...');
			
			supabaseClient
				.channel('room_metadata_sync')
				.on('postgres_changes', {
					event: '*',
					schema: 'public',
					table: 'room_database'
				}, (payload) => {
					const roomName = payload.new?.name || payload.old?.name;
					logInfo(`ğŸ”” [ROOM_DATABASEè¡¨] æ”¶åˆ°å®æ—¶äº‹ä»¶: ${payload.eventType} - ${roomName}`);
					
					// ğŸ’¡ ç‰¹åˆ«æ ‡è®°åˆ é™¤äº‹ä»¶
					if(payload.eventType === 'DELETE'){
						logInfo(`ï¿½ï¸ [ROOM_DATABASEè¡¨] DELETEäº‹ä»¶è¯¦æƒ…:`, payload);
					}
					
					realtimeMonitor.recordActivity();
					requestStats.record('realtimeEvents');
					handleRealtimeRoomMeta(payload);
				})
				.subscribe((status) => {
					if (status === 'SUBSCRIBED') {
						logInfo('âœ… æˆ¿é—´å…ƒæ•°æ®å®æ—¶åŒæ­¥å·²è¿æ¥');
						// è®¾ç½®å…¨å±€æ ‡å¿—ï¼Œä¾¿äºè°ƒè¯•
						window.__roomMetaRealtimeConnected = true;
					} else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT' || status === 'CLOSED') {
						// ğŸ¤– ä½¿ç”¨æ™ºèƒ½æ—¥å¿—è®°å½•
						const logFunc = document.hidden || realtimeMonitor.silentMode ? console.debug : console.warn;
						logFunc(`[RT][room-meta] è®¢é˜…çŠ¶æ€: ${status}`);
						
						window.__roomMetaRealtimeConnected = false;
						
						// ğŸ¤– ä½¿ç”¨æ™ºèƒ½é‡è¿ç­–ç•¥
						if (!realtimeMonitor.shouldAttemptReconnect(status)) {
							console.debug(`[RT][room-meta] æ™ºèƒ½é‡è¿ç­–ç•¥å†³å®šè·³è¿‡é‡è¿ (${status})`);
							return;
						}
						
						// ä½¿ç”¨ç»Ÿä¸€çš„é‡è¿å»¶è¿Ÿè®¡ç®—
						const delay = realtimeMonitor.calculateReconnectDelay(1, status);
						
						setTimeout(() => {
							if (!document.hidden) {
								const logFunc2 = document.hidden || realtimeMonitor.silentMode ? console.debug : console.info;
								logFunc2('ğŸ”„ é‡æ–°åˆå§‹åŒ–æˆ¿é—´å…ƒæ•°æ®è®¢é˜…...');
								window.__roomMetaRealtimeInit = false;
								setupRealtime();
							}
						}, delay);
					} else {
						logInfo(`ğŸ“¡ æˆ¿é—´å…ƒæ•°æ®è®¢é˜…çŠ¶æ€: ${status}`);
					}
				});
		}

		// ğŸ’¡ é‡æ–°è¯„ä¼°å¿ƒè·³æ£€æµ‹çš„å¿…è¦æ€§
		// åœ¨æœ‰realtimeçš„æƒ…å†µä¸‹ï¼Œå¿ƒè·³ä¸»è¦æ˜¯å†—ä½™æœºåˆ¶
		const HEARTBEAT_ENABLED = false; // ğŸ”§ å¯é…ç½®å¼€å…³ï¼Œé»˜è®¤å…³é—­
		const HEARTBEAT_INTERVAL = 600000; // 10åˆ†é’Ÿï¼ˆå¦‚æœå¯ç”¨çš„è¯ï¼‰
		
		if (HEARTBEAT_ENABLED && !window.__heartbeatInterval) {
			logInfo(`å¯ç”¨å¿ƒè·³æ£€æµ‹ï¼Œé—´éš”${HEARTBEAT_INTERVAL/60000}åˆ†é’Ÿ`);
			window.__heartbeatInterval = setInterval(async () => {
				try {
					// æ£€æŸ¥ç´§æ€¥åˆ¹è½¦å’Œè¿æ¥çŠ¶æ€
					if (emergencyBrake.isEngaged() || !supabaseReady || !supabaseClient) return;
					
					// åªåœ¨realtimeè¿æ¥å¼‚å¸¸æ—¶æ‰å‘é€å¿ƒè·³
					const timeSinceActivity = Date.now() - realtimeMonitor.lastActivity;
					if (timeSinceActivity < 300000) { // 5åˆ†é’Ÿå†…æœ‰realtimeæ´»åŠ¨å°±è·³è¿‡å¿ƒè·³
						logInfo('Realtimeè¿æ¥æ­£å¸¸ï¼Œè·³è¿‡å¿ƒè·³');
						return;
					}
					
					// ä½¿ç”¨è¯·æ±‚é™æµå™¨æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œå¿ƒè·³
					if (!requestThrottler.canExecute('heartbeat')) return;
					
					const occupiedRooms = Store.rooms.filter(r => r.occupant_student_name && r.registerTime);
					if (occupiedRooms.length === 0) return; // æ²¡æœ‰å ç”¨æˆ¿é—´æ—¶ä¸å‘é€å¿ƒè·³
					
					// æ‰¹é‡æ›´æ–°å¿ƒè·³ï¼Œå‡å°‘è¯·æ±‚æ•°é‡
					const nowIso = new Date().toISOString();
					const roomNames = occupiedRooms.map(r => r.name);
					
					await supabaseClient.from('rooms')
						.update({ heartbeat_at: nowIso })
						.in('name', roomNames);
					
					requestStats.record('heartbeat');
					logInfo(`å¤‡ç”¨å¿ƒè·³æ›´æ–°: ${roomNames.length} ä¸ªæˆ¿é—´ï¼ˆrealtimeå¼‚å¸¸æ—¶ï¼‰`);
				} catch (error) {
					logWarn('å¿ƒè·³æ›´æ–°å¤±è´¥:', error.message);
				}
			}, HEARTBEAT_INTERVAL);
		} else {
			logInfo('å¿ƒè·³æ£€æµ‹å·²ç¦ç”¨ï¼Œå®Œå…¨ä¾èµ–realtimeæœºåˆ¶');
		}
	}

	// ğŸ’¡ å¤„ç†æˆ¿é—´å…ƒæ•°æ®çš„å®æ—¶æ›´æ–°
	function handleRealtimeRoomMeta(payload) {
		const row = payload.new || payload.old;
		if (!row) return;
	}

	// ==================== ğŸ§© æˆ¿é—´å…ƒæ•°æ® Realtime æ›´æ–°ï¼ˆå«åˆ é™¤/è½¯åˆ é™¤ï¼‰å¢å¼ºç‰ˆ ====================
	// é‡å†™ä¸Šæ–¹å‡½æ•°ï¼šæ”¯æŒ DELETEã€è½¯åˆ é™¤å­—æ®µæ£€æµ‹ã€å¹‚ç­‰ä¿æŠ¤ã€UI å¼ºåˆ¶ç§»é™¤
	(function(){
		const ORIGINAL_handleRealtimeRoomMeta = handleRealtimeRoomMeta; // å¤‡ä»½å¼•ç”¨ï¼ˆå¦‚éœ€è°ƒè¯•ï¼‰

		// ğŸ§¹ ç»Ÿä¸€å¼ºåˆ¶ç§»é™¤å‡½æ•°ï¼šç¡®ä¿ Store / ç´¢å¼• / DOM / ç»Ÿè®¡ å…¨éƒ¨åŒæ­¥æ¸…ç†
		if(!window.removeRoomEverywhere){
			// ğŸ•µï¸ è°ƒè¯•è¾…åŠ©ï¼šæ£€æŸ¥æŸä¸ªæˆ¿é—´åœ¨å„å±‚æ•°æ®/DOM çš„å­˜åœ¨æƒ…å†µ
			window.debugRoomPresence = function(roomName){
				const inByName = Store.byName.has(roomName);
				const inRooms = Store.rooms.some(r=>r.name===roomName);
				const inMeta = !!(Store.roomMeta && Store.roomMeta[roomName]);
				const domNodes = [...document.querySelectorAll('[data-room]')].filter(n=>n.getAttribute('data-room')===roomName);
				const locks = [...(Store.operationLocks||[])].filter(k=>k.includes(roomName));
				logInfo(`ğŸ” debugRoomPresence(${roomName}) byName:${inByName} rooms:${inRooms} meta:${inMeta} dom:${domNodes.length} locks:${locks.length}`);
				return {inByName,inRooms,inMeta,domCount:domNodes.length,locks};
			};
			window.removeRoomEverywhere = function(roomName, ctx){
				if(!roomName) return;
				const tag = ctx||'generic';
				logInfo(`ğŸ§¹ [removeRoomEverywhere] å¼€å§‹ (${tag}) -> ${roomName}`);
				try {
					// 1. åˆ é™¤ä¸»æ•°æ®
					if(Store.byName.has(roomName)) Store.byName.delete(roomName);
					const idx = Store.rooms.findIndex(r=>r.name===roomName);
					if(idx>-1){ Store.rooms.splice(idx,1); }
					// 2. åˆ é™¤ meta
					if(Store.roomMeta && Store.roomMeta[roomName]) delete Store.roomMeta[roomName];
					// 3. åˆ é™¤å ç”¨/é”/ç¼“å­˜
					cleanupRoomState(roomName);
					// 4. é‡å»ºç´¢å¼• & ç»Ÿè®¡
					try{ rebuildIndexes(); }catch(e){}
					try{ updateUsageStats && updateUsageStats(); }catch(e){}
					// 5. DOM å¼ºåˆ¶ç§»é™¤
					const sel = `[data-room="${CSS.escape(roomName)}"]`;
					const el = document.querySelector(sel);
					if(el){ el.remove(); logInfo(`ğŸ§¼ DOMèŠ‚ç‚¹å·²ç§»é™¤: ${roomName}`); } else { logInfo(`(DOMä¸å­˜åœ¨æˆ–å·²ç§»é™¤) ${roomName}`); }
					// 5.1 å³æ—¶æ•´ä½“é‡æ¸²æŸ“
					if(window.renderRooms){ try{ renderRooms(); logInfo('ğŸ–¼ï¸ é¦–æ¬¡å³æ—¶é‡æ¸²æŸ“å®Œæˆ'); }catch(e){} }
					// 6. äºŒæ¬¡å»¶è¿Ÿå…œåº•
					setTimeout(()=>{
						const el2=document.querySelector(sel);
						if(el2){ el2.remove(); logInfo(`ğŸ› ï¸ äºŒæ¬¡å…œåº•ç§»é™¤DOM: ${roomName}`); }
						else { logInfo(`ğŸ›¡ï¸ äºŒæ¬¡å…œåº•æ—¶å·²æ— DOM: ${roomName}`); }
					},120);
					// 6.5 ç¬¬ä¸‰æ¬¡å…œåº•ï¼ˆé˜²æ®‹ç•™å¹½çµèŠ‚ç‚¹ï¼‰
					setTimeout(()=>{
						const ghost=[...document.querySelectorAll('[data-room]')].filter(n=>n.getAttribute('data-room')===roomName);
						if(ghost.length){ ghost.forEach(g=>g.remove()); logWarn(`ğŸ§Ÿ ç§»é™¤å¹½çµDOM(${ghost.length}) ${roomName}`); }
					},400);
					// 7. å†æ¬¡é‡æ¸²æŸ“ç¡®è®¤
					setTimeout(()=>{ if(window.renderRooms){ renderRooms(); logInfo(`ğŸ”„ é‡æ¸²æŸ“å®Œæˆ removeRoomEverywhere(${roomName})`);} },60);
					// 8. è¾“å‡ºæœ€ç»ˆçŠ¶æ€
					setTimeout(()=>{
						const stillInStore = Store.byName.has(roomName) || Store.rooms.some(r=>r.name===roomName);
						const stillDOM = !!document.querySelector(sel);
						logInfo(`âœ… æ¸…ç†ç»“æœ (${roomName}) Storeå­˜åœ¨:${stillInStore} DOMå­˜åœ¨:${stillDOM}`);
					},500);
				} catch(err){
					logErr('removeRoomEverywhere å¤±è´¥:', err.message);
				}
			};
		}

		function isSoftDeleteTransition(payload){
			if(payload.eventType !== 'UPDATE') return false;
			const before = payload.old||{}; const after = payload.new||{};
			// å¸¸è§è½¯åˆ é™¤å­—æ®µå…¼å®¹ï¼šdeleted / deleted_at / is_deleted
			return (
				((after.deleted===true) && before.deleted!==true) ||
				((after.is_deleted===true) && before.is_deleted!==true) ||
				((after.deleted_at && !before.deleted_at))
			);
		}

		function removeRoomImmediately(roomName, reason){
			if(!roomName) return;

			// ğŸ’¡ æ ‡è®°æ£€æŸ¥
			const recentDeletion = Store.deletionMarkers && Store.deletionMarkers.get(roomName);
			if(recentDeletion && (Date.now() - recentDeletion) < 5000){
				logInfo(`â­ï¸ è·³è¿‡åˆ é™¤åŒæ­¥ï¼ˆæœ¬åœ°æœ€è¿‘åˆ é™¤ï¼‰: ${roomName}`);
				return;
			}
			logInfo(`ğŸ§¨ [MetaDELETE] è°ƒç”¨ removeRoomEverywhere(${roomName}) reason=${reason}`);
			removeRoomEverywhere(roomName, `meta-${reason}`);
			toast(`ğŸ—‘ï¸ æˆ¿é—´å·²è¢«åˆ é™¤: ${roomName}`, 'info');
			logInfo(`ğŸ—‘ï¸ å®æ—¶åˆ é™¤åŒæ­¥ -> ${roomName} (${reason})`);
		}

		// å¹‚ç­‰å»é‡ï¼šé˜²æ­¢ UPDATE(è½¯åˆ é™¤) + DELETE åŒäº‹ä»¶å¯¼è‡´é‡å¤æ—¥å¿—/æ“ä½œ
		if(!window.__roomDeletionProcessed){ window.__roomDeletionProcessed = new Set(); }

		window.handleRealtimeRoomMeta = function(payload){
			const row = payload.new || payload.old; if(!row) return;
			const roomName = row.name; if(!roomName) return;

			// ğŸ” æ£€æµ‹å…ƒæ•°æ®å±‚é¢çš„é‡å‘½å (UPDATE ä¸” old.name != new.name)
			if(payload.eventType==='UPDATE' && payload.old && payload.new && payload.old.name!==payload.new.name){
				const oldName = payload.old.name; const newName = payload.new.name;
				logInfo(`[META][RENAME] æ£€æµ‹åˆ°å…ƒæ•°æ®é‡å‘½å ${oldName} -> ${newName}`);
				try { handleRoomNameChange(oldName, newName, payload); } catch(e){ logErr('å…ƒæ•°æ®é‡å‘½åå¤„ç†å¤±è´¥:', e.message); }
				// ç»§ç»­æ‰§è¡Œåç»­ä»¥ç¡®ä¿ meta åˆ·æ–°ï¼ˆhandleRoomNameChange å·²è¿ç§»ç´¢å¼•ï¼‰
			}

			try {
				// æ£€æµ‹è½¯åˆ é™¤æˆ–ç¡¬åˆ é™¤
				if(payload.eventType === 'DELETE' || isSoftDeleteTransition(payload)){
					const key = `${roomName}::${payload.eventType}`;
					if(window.__roomDeletionProcessed.has(key)){
						logInfo(`(skip dup) åˆ é™¤äº‹ä»¶å·²å¤„ç†: ${key}`);
						return;
					}
					window.__roomDeletionProcessed.add(key);
					removeRoomImmediately(roomName, payload.eventType==='DELETE'?'DELETE':'SOFT-DELETE');
					return;
				}

				// æ­£å¸¸ INSERT / UPDATE èµ°åŸé€»è¾‘ï¼ˆä¿ç•™ï¼‰
				if(payload.eventType === 'INSERT' || payload.eventType === 'UPDATE'){
					if (!Store.roomMeta) Store.roomMeta = {};
					Store.roomMeta[roomName] = {
						name: row.name,
						location: row.location || '',
						piano_type: row.piano_type || '',
						remark: row.remark || ''
					};
					const room = Store.byName.get(roomName);
					if(room){
						room.remark = row.remark || '';
						room.pianoType = row.piano_type || '';
						room.location = row.location || '';
						setTimeout(()=>{ renderRoomCardForced(roomName); },0);
					}
					const changes=[]; if(row.remark!==undefined) changes.push(`å¤‡æ³¨:"${row.remark}"`); if(row.piano_type!==undefined) changes.push(`ç±»å‹:${row.piano_type}`); if(row.location!==undefined) changes.push(`ä½ç½®:${row.location}`);
					logInfo(`âœ… æˆ¿é—´å…ƒæ•°æ®å·²æ›´æ–° ${roomName}: ${changes.join(', ')}`);
					if(window.renderRooms){ setTimeout(()=>{ renderRooms(); },50); }
					// ç¡®ä¿ç»Ÿè®¡åŠæ—¶æ›´æ–°
					setTimeout(()=>{ if(typeof updateUsageStats === 'function') updateUsageStats(); }, 60);
				}
			}catch(err){ logErr('å¤„ç†æˆ¿é—´å…ƒæ•°æ®å®æ—¶æ›´æ–°å¤±è´¥(å¢å¼ºç‰ˆ):', err.message); }
		};
	})();

	// =============== ğŸ§ª æµ‹è¯•è¾…åŠ©ï¼šæˆ¿é—´åˆ é™¤åŒæ­¥ ===============
	if(!window.testRoomDeletionSync){
		window.testRoomDeletionSync = function(roomName){
			console.log('[TEST] testRoomDeletionSync start', roomName);
			let i=0; const max=6;
			const timer = setInterval(()=>{
				i++;
				const existsInStore = !!Store.byName.get(roomName);
				const domExists = !!document.querySelector(`[data-room="${CSS.escape(roomName)}"]`);
				console.log(`[TEST] #${i} store=${existsInStore} dom=${domExists}`);
				if(i>=max) clearInterval(timer);
			},1000);
		};
	}

	// ğŸ§ª é‡å‘½åäº‹ä»¶è§‚å¯Ÿå·¥å…·ï¼šæŒç»­æ‰“å° oldName / newName æ˜¯å¦å®Œæˆæ›¿æ¢
	if(!window.testRoomRenameWatch){
		window.testRoomRenameWatch = function(oldName, newName, seconds=6){
			console.log('[TEST] watch rename', oldName,'->',newName,'for',seconds,'s');
			let i=0; const timer=setInterval(()=>{
				i++;
				const hasOld = Store.byName.has(oldName);
				const hasNew = Store.byName.has(newName);
				const domOld = !!document.querySelector(`[data-room='${CSS.escape(oldName)}']`);
				const domNew = !!document.querySelector(`[data-room='${CSS.escape(newName)}']`);
				console.log(`[TEST][rename] t=${i}s store(old:${hasOld} new:${hasNew}) dom(old:${domOld} new:${domNew})`);
				if(i>=seconds) clearInterval(timer);
			},1000);
		};
	}

	// æ‰©å±• checkRoomMetaSync (è‹¥å­˜åœ¨) ç»Ÿè®¡å·²åˆ é™¤æ®‹ç•™
	if(window.checkRoomMetaSync){
		const originalCheck = window.checkRoomMetaSync;
		window.checkRoomMetaSync = function(){
			originalCheck();
			try{
				const domIds=[...document.querySelectorAll('[data-room]')].map(e=>e.getAttribute('data-room'));
				const orphans=domIds.filter(id=>!Store.byName.get(id));
				if(orphans.length){ console.warn('[META-SYNC] DOM å­¤å„¿å¡ç‰‡:', orphans); }
			}catch(e){ /* ignore */ }
		};
	}

	// ğŸ’¡ ä¸“é—¨å¤„ç†æˆ¿é—´é‡å‘½åçš„realtimeäº‹ä»¶
	function handleRoomNameChange(oldName, newName, payload) {
		try {
			logInfo(`ğŸ”„ å¤„ç†æˆ¿é—´é‡å‘½åäº‹ä»¶: ${oldName} -> ${newName}`);
			
			// 1. æŸ¥æ‰¾æ—§åç§°çš„æˆ¿é—´
			let oldRoomIndex = Store.rooms.findIndex(r => r.name === oldName);
			if (oldRoomIndex < 0) {
				// å¯èƒ½æœ¬åœ°å·²ç»æå‰ç”¨æ–°åå­—ï¼ˆä¾‹å¦‚æœ¬é¡µé¢å°±æ˜¯å‘èµ·æ–¹ï¼‰
				const newRoomIndex = Store.rooms.findIndex(r => r.name === newName);
				if(newRoomIndex>-1){
					oldRoomIndex = newRoomIndex; // ç›´æ¥ç”¨æ–°è®°å½•ç»§ç»­åç»­åŒæ­¥å­—æ®µ
					logWarn(`æ—§åæœªæ‰¾åˆ°ï¼Œä½¿ç”¨å·²å­˜åœ¨çš„æ–°åè®°å½•ç»§ç»­: ${newName}`);
				} else {
					// åˆ›å»ºå ä½ä»¥é¿å…åç»­æ¸²æŸ“ç¼ºå¤±ï¼ˆç­‰å¾…ä¸‹ä¸€æ¬¡å…¨é‡åŒæ­¥ä¼šè¡¥é½å…¶å®ƒå­—æ®µï¼‰
					const placeholder = { name:newName, pianoType:payload.new?.piano_type||'', location:payload.new?.location||'', remark:payload.new?.remark||'', occupant:null, registerTime:null, version:payload.new?.version||1 };
					Store.rooms.push(placeholder);
					Store.byName.set(newName, placeholder);
					logWarn(`æ—§å/æ–°åå‡æœªæ‰¾åˆ°ï¼Œå·²åˆ›å»ºå ä½æˆ¿é—´: ${newName}`);
					// ç›´æ¥æ¸²æŸ“å¹¶é€€å‡ºï¼ˆå ä½ä¸å†åšè¿ç§»ï¼‰
					setTimeout(()=>{ renderRoomCardForced(newName); },0);
					return;
				}
			}
			const room = Store.rooms[oldRoomIndex];
			logInfo(`ğŸ“ æ‰¾åˆ°æˆ¿é—´è®°å½•: ${room.name}, occupant: ${room.occupant_student_name || 'null'}`);
			
			// 2. æ›´æ–°æˆ¿é—´åç§°å’Œå…¶ä»–å¯èƒ½å˜æ›´çš„å­—æ®µ
			const newData = canonicalizeRoom(payload.new);
			room.name = newName;
			room.version = newData.version || room.version;
			room.heartbeatAt = newData.heartbeatAt || room.heartbeatAt;
			// ä¿æŒç°æœ‰çš„å ç”¨çŠ¶æ€ä¸å˜ï¼Œå› ä¸ºé‡å‘½åä¸åº”è¯¥å½±å“å ç”¨
			
			// 3. æ›´æ–°Store.byNameç´¢å¼•
			Store.byName.delete(oldName);
			Store.byName.set(newName, room);
			
			// 4. æ›´æ–°æˆ¿é—´å…ƒæ•°æ®
			if (Store.roomMeta && Store.roomMeta[oldName]) {
				Store.roomMeta[newName] = {
					...Store.roomMeta[oldName],
					name: newName
				};
				delete Store.roomMeta[oldName];
			}
			
			// 5. å¼ºåˆ¶åˆ·æ–°UIæ˜¾ç¤º
			setTimeout(() => {
				// ç§»é™¤æ—§åç§°çš„DOMå…ƒç´ 
				const grid = document.getElementById('roomGrid');
				const oldEl = grid.querySelector(`[data-room='${CSS.escape(oldName)}']`);
				if (oldEl) {
					oldEl.remove();
					logInfo(`ğŸ—‘ï¸ ç§»é™¤æ—§æˆ¿é—´å¡ç‰‡: ${oldName}`);
				}
				
				// é‡æ–°æ¸²æŸ“æ–°åç§°çš„æˆ¿é—´å¡ç‰‡
				renderRoomCardForced(newName);
				logInfo(`ğŸ†• æ¸²æŸ“æ–°æˆ¿é—´å¡ç‰‡: ${newName}`);
				
				// å…¨å±€åˆ·æ–°ç¡®ä¿ç´¢å¼•å’Œè¿‡æ»¤å™¨æ­£ç¡®
				renderRooms();
			}, 0);
			
			// 6. æ˜¾ç¤ºç”¨æˆ·æç¤º
			toast(`ğŸ·ï¸ æˆ¿é—´é‡å‘½å: ${oldName} â†’ ${newName}`, 'info');
			logInfo(`âœ… æˆ¿é—´é‡å‘½åå¤„ç†å®Œæˆ: ${oldName} -> ${newName}`);
			
		} catch (error) {
			logErr(`âŒ å¤„ç†æˆ¿é—´é‡å‘½åå¤±è´¥ ${oldName} -> ${newName}:`, error.message);
		}
	}

	function handleRealtimeStudent(payload) {
		const row = payload.new || payload.old; 
		if (!row) return;
		
		// æ›´æ–°å®æ—¶åŒæ­¥æ—¶é—´æˆ³
		window.__studentUpdateTimestamp = Date.now();
		if(!window.__studentRealtimeHandled) window.__studentRealtimeHandled=0; window.__studentRealtimeHandled++;
		const dbgPrefix = `[RT][students][handle #${window.__studentRealtimeHandled}]`;
		try{ console.log(`${dbgPrefix} recv event=${payload.eventType} name=${row.name}`); }catch(_){ }
		
		try {
			// æ›´æ–° Store.studentsï¼ˆå…¼å®¹æ—§ç³»ç»Ÿï¼‰
			if (window.Store && Array.isArray(window.Store.students)) {
				if (payload.eventType === 'INSERT') {
					// æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
					const existing = window.Store.students.find(s => s.name === row.name);
					if (!existing) {
						window.Store.students.push({
							name: row.name,
							grade: row.grade || '',
							major: row.major || ''
						});
						logInfo(`å­¦ç”Ÿæ•°æ®æ–°å¢: ${row.name}`);
					}
				} else if (payload.eventType === 'UPDATE') {
					const student = window.Store.students.find(s => s.name === row.name);
					if (student) {
						student.grade = row.grade || '';
						student.major = row.major || '';
						logInfo(`å­¦ç”Ÿæ•°æ®æ›´æ–°: ${row.name}`);
					}
				} else if (payload.eventType === 'DELETE' && payload.old) {
					const index = window.Store.students.findIndex(s => s.name === payload.old.name);
					if (index >= 0) {
						window.Store.students.splice(index, 1);
						logInfo(`å­¦ç”Ÿæ•°æ®åˆ é™¤: ${payload.old.name}`);
					}
				}
			}
			
			// æ›´æ–° StudentLibraryï¼ˆæ–°ç³»ç»Ÿï¼‰
			if (window.StudentLibrary && window.StudentLibrary.refresh) {
				if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
					// æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°æ“ä½œäº§ç”Ÿçš„æ›´æ–°ï¼ˆé¿å…å¾ªç¯ï¼‰
					const isLocalUpdate = window.__studentUpdateIgnore && 
						window.__studentUpdateIgnore.has(row.name) && 
						(Date.now() - (window.__studentUpdateTimestamp || 0)) < 5000;
					if(isLocalUpdate){ console.log(`${dbgPrefix} skip local echo name=${row.name}`); }
					
					if (!isLocalUpdate) {
						// ä¸æ˜¯æœ¬åœ°æ“ä½œï¼Œéœ€è¦åŒæ­¥åˆ°æœ¬åœ°
						if (window.StudentLibrary._handleRemoteUpdate) {
							window.StudentLibrary._handleRemoteUpdate(payload);
						} else {
							// å…œåº•ï¼šåˆ·æ–°æ•´ä¸ªå­¦ç”Ÿåº“
							window.StudentLibrary.refresh();
						}
						logInfo(`å­¦ç”Ÿåº“åŒæ­¥: ${row.name} (${payload.eventType})`);
					}
				} else if (payload.eventType === 'DELETE' && payload.old) {
					// åˆ é™¤äº‹ä»¶ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°æ“ä½œäº§ç”Ÿçš„åˆ é™¤ï¼ˆé¿å…å¾ªç¯ï¼‰
					const isLocalUpdate = window.__studentUpdateIgnore && 
						window.__studentUpdateIgnore.has(payload.old.name) && 
						(Date.now() - (window.__studentUpdateTimestamp || 0)) < 5000;
					if(isLocalUpdate){ console.log(`${dbgPrefix} skip local echo delete name=${payload.old.name}`); }
					
					if (!isLocalUpdate) {
						// ä¸æ˜¯æœ¬åœ°æ“ä½œï¼Œéœ€è¦åŒæ­¥åˆ°æœ¬åœ°
						if (window.StudentLibrary._handleRemoteUpdate) {
							window.StudentLibrary._handleRemoteUpdate(payload);
						} else {
							// å…œåº•ï¼šåˆ·æ–°æ•´ä¸ªå­¦ç”Ÿåº“
							window.StudentLibrary.refresh();
						}
						logInfo(`å­¦ç”Ÿåº“åŒæ­¥: ${payload.old.name} (DELETE)`);
						// DELETE ååŠ ä¸€å±‚å»¶è¿Ÿå¯¹è´¦ï¼Œç¡®ä¿æœ€ç»ˆä¸€è‡´
						if(window.reconcileStudentsWithCloud){ setTimeout(()=>{ try{ window.reconcileStudentsWithCloud(); }catch(_){ } }, 1200); }
					}
				}
			}
			
			// åˆ·æ–°ç›¸å…³UI
			if (window.rebuildStudentIndex) {
				window.rebuildStudentIndex();
			}
			
			// åˆ·æ–°BTMï¼ˆå¦‚æœå­˜åœ¨ï¼‰
			if (window.BTM && window.BTM.buildStudents) {
				window.BTM.buildStudents();
			}
			
		} catch (error) {
			logErr('å¤„ç†å­¦ç”Ÿå®æ—¶æ›´æ–°å¤±è´¥:', error.message);
		}
	}
	
	function handleRealtimeRoom(payload){
		const row = payload.new || payload.old; 
		if(!row) return;
		
		// ğŸ’¡ æ£€æµ‹æˆ¿é—´åç§°å˜æ›´çš„ç‰¹æ®Šå¤„ç†
		if (payload.eventType === 'UPDATE' && payload.old && payload.new) {
			const oldName = payload.old.name;
			const newName = payload.new.name;
			
			if (oldName !== newName) {
				logInfo(`ğŸ·ï¸ æ£€æµ‹åˆ°æˆ¿é—´é‡å‘½å: ${oldName} -> ${newName}`);
				handleRoomNameChange(oldName, newName, payload);
				return; // æˆ¿é—´é‡å‘½åæœ‰ä¸“é—¨çš„å¤„ç†æµç¨‹ï¼Œç›´æ¥è¿”å›
			}
		}

		// æ£€æµ‹å…³é”®çŠ¶æ€å˜æ›´ï¼Œè§¦å‘å¢å¼ºåŒæ­¥
		const isImportantChange = payload.eventType === 'INSERT' || 
			(payload.eventType === 'UPDATE' && (
				payload.old?.occupant_student_name !== payload.new?.occupant_student_name ||
				payload.old?.register_time !== payload.new?.register_time
			));
		
		if (isImportantChange) {
			syncEnhancer.recordUserOperation();
		}
		
		// ğŸ”§ ä¿®å¤ï¼šåœ¨ Realtime æ›´æ–°æ—¶ä¿ç•™ç°æœ‰å…ƒæ•°æ®ï¼Œé¿å…è¢« rooms è¡¨çš„ç©ºå€¼è¦†ç›–
		const data = canonicalizeRoom(row, true); 
		const idx = Store.rooms.findIndex(r => r.name === data.name);
		
		// é˜²é‡å¤å¤„ç†ï¼šç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
		const updateKey = `${data.name}_${payload.eventType}_${data.version}_${Date.now()}`;
		const recentUpdatesKey = 'recentUpdates';
		if (!Store[recentUpdatesKey]) Store[recentUpdatesKey] = new Map();
		
		// æ£€æŸ¥æ˜¯å¦åœ¨çŸ­æ—¶é—´å†…å¤„ç†è¿‡ç›¸åŒçš„æ›´æ–°
		const recentUpdateTime = Store[recentUpdatesKey].get(`${data.name}_${payload.eventType}_${data.version}`);
		if (recentUpdateTime && Date.now() - recentUpdateTime < 1000) { // 1ç§’å†…çš„é‡å¤æ›´æ–°
			logInfo(`å¿½ç•¥é‡å¤çš„å®æ—¶æ›´æ–° ${data.name} v${data.version} (${payload.eventType})`);
			return;
		}
		
		// è®°å½•æ­¤æ¬¡æ›´æ–°
		Store[recentUpdatesKey].set(`${data.name}_${payload.eventType}_${data.version}`, Date.now());
		
		// æ¸…ç†è¿‡æœŸçš„æ›´æ–°è®°å½•ï¼ˆä¿ç•™æœ€è¿‘5ç§’çš„è®°å½•ï¼‰
		setTimeout(() => {
			const expireTime = Date.now() - 5000;
			for (const [key, time] of Store[recentUpdatesKey].entries()) {
				if (time < expireTime) {
					Store[recentUpdatesKey].delete(key);
				}
			}
		}, 5000);
		
		// æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬åœ°å¾…å¤„ç†çš„æ›´æ–°ï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰
		const pending = Store.pendingAssign.get(data.name);
		if(pending && pending.version >= data.version){ 
			logInfo(`å¿½ç•¥æœ¬åœ°å¾…å¤„ç†æ›´æ–° ${data.name} v${data.version}`);
			return; 
		}
		
		// å†²çªæ£€æµ‹ï¼šå¦‚æœæœ¬åœ°æ­£åœ¨æ“ä½œè¿™ä¸ªæˆ¿é—´
		const lockKey = `assign_${data.name}`;
		const clearLockKey = `clear_${data.name}`;
		const deleteLockKey = `delete_${data.name}`;
		const isLocked = Store.operationLocks?.has(lockKey) || Store.operationLocks?.has(clearLockKey) || Store.operationLocks?.has(deleteLockKey);
		
		if (isLocked) {
			if (Store.operationLocks?.has(deleteLockKey)) {
				logInfo(`æˆ¿é—´ ${data.name} æ­£åœ¨åˆ é™¤ä¸­ï¼Œå¿½ç•¥å®æ—¶æ›´æ–°`);
				return; // åˆ é™¤æ—¶å®Œå…¨å¿½ç•¥æ‰€æœ‰å®æ—¶æ›´æ–°
			}
			logWarn(`æˆ¿é—´ ${data.name} æœ¬åœ°æ“ä½œä¸­ï¼Œå»¶è¿Ÿå¤„ç†è¿œç¨‹æ›´æ–°`);
			// å»¶è¿Ÿ3ç§’é‡è¯•
			setTimeout(() => handleRealtimeRoom(payload), 3000);
			return;
		}
		
		// ç«‹å³æ›´æ–°UIä»¥å‡å°‘å»¶è¿Ÿæ„ŸçŸ¥
		let shouldRerender = false;
		let conflictDetected = false;
		
		// å¤„ç†ä¸åŒç±»å‹çš„æ›´æ–°
		if (payload.eventType === 'DELETE') {
			const recentDeletion = Store.deletionMarkers && Store.deletionMarkers.get(data.name);
			// ğŸ” å…œåº•ï¼šå¦‚æœ canonicalize å data.name ä¸¢å¤±ï¼Œå°è¯•ä» payload.old.name / payload.new.name å–åŸå§‹åç§°
			if(!data.name){
				const rawName = (payload.old && payload.old.name) || (payload.new && payload.new.name);
				logWarn(`âš ï¸ DELETEäº‹ä»¶ data.name ç¼ºå¤±ï¼Œä½¿ç”¨åŸå§‹åç§°å…œåº•: ${rawName}`);
				if(rawName){ data.name = rawName; }
			}
			if(!data.name){
				logErr('âŒ DELETEäº‹ä»¶æ— æ³•ç¡®å®šæˆ¿é—´åç§°ï¼Œæ”¾å¼ƒå¤„ç†');
				return;
			}
			if(recentDeletion && (Date.now() - recentDeletion) < 5000){
				logInfo(`â­ï¸ è·³è¿‡åˆ é™¤äº‹ä»¶ï¼ˆæœ¬åœ°æœ€è¿‘åˆ é™¤ï¼‰: ${data.name}`);
				return;
			}
			logInfo(`ğŸ§¨ [RoomsDELETE] (no idx check) è°ƒç”¨ removeRoomEverywhere(${data.name})`);
			removeRoomEverywhere(data.name, 'rooms-DELETE');
			shouldRerender = false;
			toast(`ğŸ—‘ï¸ æˆ¿é—´ ${data.name} å·²è¢«åˆ é™¤`, 'info');
		} else if (payload.eventType === 'INSERT') {
			if (idx < 0) {
				// ğŸ”§ ä¿®å¤ï¼šå…ˆä» room_database è¡¨åŒæ­¥è·å–æ­£ç¡®å…ƒæ•°æ®ï¼Œå†æ’å…¥æˆ¿é—´
				const metaRoom = Store.roomMeta?.[data.name];
				if (metaRoom) {
					// ä½¿ç”¨ room_database ä¸­çš„å…ƒæ•°æ®è¦†ç›– rooms è¡¨çš„é»˜è®¤å€¼
					data.pianoType = metaRoom.piano_type || data.pianoType;
					data.location = metaRoom.location || data.location;
					data.remark = metaRoom.remark || data.remark;
					logInfo(`âœ… ä» room_database è¡¥å……å…ƒæ•°æ®: ${data.name} (${data.pianoType})`);
				} else {
					logWarn(`âš ï¸ room_database ä¸­æœªæ‰¾åˆ° ${data.name} çš„å…ƒæ•°æ®ï¼Œå°†å¼‚æ­¥è¡¥å……`);
					// å¼‚æ­¥è¡¥å……å…ƒæ•°æ®
					fetchRoomMetaByName(data.name);
				}
				
				Store.rooms.push(data);
				logInfo(`è¿œç¨‹æ–°å¢æˆ¿é—´: ${data.name}`);
				shouldRerender = true;
			}
		} else if (payload.eventType === 'UPDATE') {
			// ========= å®Œæ•´é‡æ¸²æŸ“å¢å¼ºé€»è¾‘ =========
			let prevOcc = null;
			if (idx >= 0) {
				const oldRoom = Store.rooms[idx];
				prevOcc = oldRoom.occupant_student_name;
				if (oldRoom.occupant_student_name && data.occupant_student_name===null) {
					const incomingVer = data.version || 0;
					const localVer = oldRoom.version || 0;
					if (incomingVer <= localVer) {
						logWarn(`å¿½ç•¥å¯ç–‘æ¸…ç©º: ${data.name} incoming v${incomingVer} <= local v${localVer}`);
						return; // ä¸¢å¼ƒè¯¥ UPDATE
					}
				}
				
				// æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„æ“ä½œï¼Œå¦‚æœæœ‰åˆ™å»¶è¿Ÿå¤„ç†è¿œç¨‹æ›´æ–°
				const lockKey = `assign_${data.name}`;
				const clearLockKey = `clear_${data.name}`;
				const hasOperationLock = Store.operationLocks?.has(lockKey) || Store.operationLocks?.has(clearLockKey);
				
				if (hasOperationLock) {
					logWarn(`æˆ¿é—´ ${data.name} æœ‰æ“ä½œè¿›è¡Œä¸­ï¼Œå»¶è¿Ÿå¤„ç†è¿œç¨‹æ›´æ–°`);
					setTimeout(() => {
						// é‡æ–°å°è¯•å¤„ç†æ›´æ–°
						handleRealtimeRoom(payload);
					}, 1000);
					return;
				}
				
				// å†²çªæ£€æµ‹ï¼ˆåŒæ–¹éƒ½æœ‰ä¸åŒå ç”¨è€…ï¼‰
				if (oldRoom.occupant_student_name && data.occupant_student_name && oldRoom.occupant_student_name !== data.occupant_student_name) {
					conflictDetected = true;
					logWarn(`æ£€æµ‹åˆ°æˆ¿é—´ ${data.name} å†²çª: æœ¬åœ°(${oldRoom.occupant_student_name}) vs è¿œç¨‹(${data.occupant_student_name})`);
					
					// å†²çªè§£å†³ç­–ç•¥ï¼šä½¿ç”¨ç‰ˆæœ¬å·è¾ƒé«˜çš„ï¼Œå¦‚æœç‰ˆæœ¬å·ç›¸åŒåˆ™ä½¿ç”¨è¿œç¨‹æ•°æ®
					if ((data.version || 0) >= (oldRoom.version || 0)) {
						logInfo(`ç‰ˆæœ¬å†²çªè§£å†³: é‡‡ç”¨è¿œç¨‹æ•°æ® v${data.version} (æœ¬åœ° v${oldRoom.version})`);
						toast(`âš ï¸ æˆ¿é—´ ${data.name} å†²çªå·²è§£å†³ï¼Œé‡‡ç”¨æœ€æ–°æ•°æ®`, 'warn');
					} else {
						logInfo(`ç‰ˆæœ¬å†²çªè§£å†³: ä¿æŒæœ¬åœ°æ•°æ® v${oldRoom.version} (è¿œç¨‹ v${data.version})`);
						toast(`âš ï¸ æˆ¿é—´ ${data.name} ç‰ˆæœ¬å†²çªï¼Œä¿æŒæœ¬åœ°æ•°æ®`, 'warn');
						return; // ä¸æ›´æ–°æœ¬åœ°æ•°æ®
					}
				}
				// æ˜¾å¼å­—æ®µè¦†ç›–ï¼Œä¿è¯ null ä¸ä¸¢ï¼ŒåŒæ—¶ç»Ÿä¸€æ—¶é—´å­—æ®µæ ¼å¼
				const prevRegisterTime = oldRoom.registerTime;
				const prevRegisterTimeRaw = oldRoom.register_time;
				
				oldRoom.occupant_student_name = (data.occupant_student_name === null ? null : data.occupant_student_name);
				// å¦‚æœæ˜¯ä¸´æ—¶ç™»è®°ä¸”è¿œç¨‹æä¾›äº†æ­£å¼ register_timeï¼Œåˆ™è¦†ç›–å¹¶æ¸…é™¤æ ‡è®°
				if (data.register_time) {
					oldRoom.register_time = data.register_time;
					oldRoom.registerTime = data.registerTime || toMs(data.register_time);
					if (oldRoom.__tempRegister) { 
						delete oldRoom.__tempRegister; 
						delete oldRoom.__optimisticAssignTime; // æ¸…é™¤ä¹è§‚æ—¶é—´æ ‡è®°
					}
				} else {
					// è¿œç¨‹æ²¡æœ‰æä¾› register_timeï¼ˆä¾‹å¦‚æ¸…ç©ºï¼‰ï¼Œæ­£å¸¸èµ‹å€¼
					oldRoom.register_time = data.register_time || null;
					oldRoom.registerTime = data.registerTime || (data.register_time ? toMs(data.register_time) : null);
					if (!oldRoom.register_time && oldRoom.__tempRegister) {
						// è¿œç¨‹ç¼ºå¤±ä¸”ä»æœ‰ä¸´æ—¶æ ‡è®°ï¼šä¿æŒä¸´æ—¶å€¼ä¸€æ®µæ—¶é—´ï¼Œç¨å reconcile å¯ä¿®å¤
						setTimeout(()=>{ if(oldRoom && oldRoom.__tempRegister && !oldRoom.register_time){ delete oldRoom.__tempRegister; }}, 5000);
					}
				}
				oldRoom.version = data.version;
				oldRoom.heartbeat_at = data.heartbeat_at;
				

				// ğŸ”§ ä¿®å¤ï¼šåªåœ¨ payload ä¸­æ˜ç¡®åŒ…å«å…ƒæ•°æ®å­—æ®µæ—¶æ‰æ›´æ–°ï¼Œå¦åˆ™ä¿ç•™æœ¬åœ°å€¼
				// è¿™æ ·å¯ä»¥é˜²æ­¢ Realtime åªè¿”å›éƒ¨åˆ†å­—æ®µæ—¶ï¼Œç”¨é»˜è®¤å€¼è¦†ç›–æ­£ç¡®çš„å…ƒæ•°æ®
				const rawNew = payload.new || {};
				if ('piano_type' in rawNew) {
					oldRoom.pianoType = data.pianoType;
					oldRoom.piano_type = rawNew.piano_type;
				}
				if ('location' in rawNew) {
					oldRoom.location = data.location;
				}
				if ('remark' in rawNew) {
					oldRoom.remark = data.remark;
				}
				// è¯¦ç»†æ—¥å¿—è®°å½•
				logInfo(`è¿œç¨‹æ›´æ–°æˆ¿é—´: ${data.name} v${data.version}`);
				logInfo(`  å ç”¨è€…: ${prevOcc || 'null'} -> ${oldRoom.occupant_student_name || 'null'}`);
				if (oldRoom.registerTime) {
					const timeStr = new Date(oldRoom.registerTime).toLocaleString();
					logInfo(`  æ³¨å†Œæ—¶é—´: ${timeStr} (${oldRoom.registerTime})`);
				} else {
					logInfo(`  æ³¨å†Œæ—¶é—´: null`);
				}
				
				// æ£€æŸ¥æ˜¯å¦æœ‰å®è´¨æ€§å˜åŒ–ï¼ˆå½±å“UIæ˜¾ç¤ºçš„å­—æ®µï¼‰
				const hasOccupantChange = prevOcc !== oldRoom.occupant_student_name;
				const hasRegisterTimeChange = prevRegisterTime !== oldRoom.registerTime;
				const hasSignificantChange = hasOccupantChange || (oldRoom.occupant_student_name && hasRegisterTimeChange);
				
				// å˜åŒ–æç¤º
				if (hasOccupantChange && !conflictDetected) {
					if (oldRoom.occupant_student_name) toast(`ğŸµ ${oldRoom.occupant_student_name} å¼€å§‹ä½¿ç”¨ ${data.name}`, 'success'); else toast(`âœ… ${data.name} å·²é‡Šæ”¾`, 'success');
				}
				
				// ğŸ”§ ä¿®å¤ï¼šç¡®ä¿å…ƒæ•°æ®ä¸ room_database è¡¨ä¸€è‡´
				// å¦‚æœ payload ä¸­æ²¡æœ‰åŒ…å«å…ƒæ•°æ®å­—æ®µï¼Œä» Store.roomMeta åŒæ­¥
				const metaRoom = Store.roomMeta?.[data.name];
				if (metaRoom) {
					// åªåœ¨æœ¬åœ°å…ƒæ•°æ®ä¸ room_database ä¸ä¸€è‡´æ—¶æ›´æ–°
					let metaUpdated = false;
					if (oldRoom.pianoType !== metaRoom.piano_type && !('piano_type' in rawNew)) {
						oldRoom.pianoType = metaRoom.piano_type;
						oldRoom.piano_type = metaRoom.piano_type;
						metaUpdated = true;
						logInfo(`ğŸ”„ åŒæ­¥å…ƒæ•°æ® piano_type: ${metaRoom.piano_type}`);
					}
					if (oldRoom.location !== metaRoom.location && !('location' in rawNew)) {
						oldRoom.location = metaRoom.location || '';
						metaUpdated = true;
						logInfo(`ğŸ”„ åŒæ­¥å…ƒæ•°æ® location: ${metaRoom.location}`);
					}
					if (oldRoom.remark !== metaRoom.remark && !('remark' in rawNew)) {
						oldRoom.remark = metaRoom.remark || '';
						metaUpdated = true;
						logInfo(`ğŸ”„ åŒæ­¥å…ƒæ•°æ® remark: ${metaRoom.remark}`);
					}
					if (metaUpdated) {
						shouldRerender = true; // å…ƒæ•°æ®æ›´æ–°éœ€è¦é‡æ–°æ¸²æŸ“
					}
				}
				
				// å ç”¨ -> ç©ºï¼šå®Œæ•´é‡æ¸²æŸ“
				if (prevOcc && !oldRoom.occupant_student_name) {
					logInfo(`[FULL-RERENDER] ${data.name} cleared v${data.version} (${prevOcc} -> null)`);
					fullReRenderRoom(oldRoom);
					shouldRerender = false; // å·²åœ¨ fullReRenderRoom å†…å¤„ç†
				} else if (hasSignificantChange) {
					logInfo(`[NORMAL-RERENDER] ${data.name} v${data.version} (${prevOcc || 'null'} -> ${oldRoom.occupant_student_name || 'null'})`);
					shouldRerender = true;
				} else {
					logInfo(`[SKIP-RERENDER] ${data.name} v${data.version} (æ— UIå˜åŒ–ï¼Œä»…ç‰ˆæœ¬/å¿ƒè·³æ›´æ–°)`);
					shouldRerender = false;
				}
			} else {
				Store.rooms.push(data);
				logInfo(`è¿œç¨‹æ’å…¥æˆ¿é—´(è¡¥å½•): ${data.name}`);
				// åŒæ­¥è¡¥å……å…ƒæ•°æ®
				fetchRoomMetaByName(data.name);
				shouldRerender = true;
			}
		}
		
		// æ¸…ç†å¾…å¤„ç†çŠ¶æ€
		Store.pendingAssign.delete(data.name);
		
		// æ¸…ç†å›æ»šçŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
		if (Store.rollbackStates) {
			Store.rollbackStates.delete(data.name);
		}
		
		// æ¸…é™¤æ“ä½œè§†è§‰æŒ‡ç¤º
		clearOperationIndicator(data.name);
		
		// ğŸ—„ï¸ å…³é”®ä¿®å¤ï¼šè¿œç¨‹æ›´æ–°åç«‹å³ä¿å­˜è®¡æ—¶å™¨çŠ¶æ€ï¼Œé˜²æ­¢æ•°æ®æ±¡æŸ“ï¼
		timerPersistence.saveTimerStates();
		
		// ç«‹å³é‡æ–°æ¸²æŸ“ä»¥å‡å°‘å»¶è¿Ÿ
		if (shouldRerender) {
			// å…³é”®ä¿®å¤ï¼šå…ˆé‡å»ºç´¢å¼•ï¼Œå†æ¸²æŸ“
			rebuildIndexes();
			renderRoomCard(data.name); 
			updateUsageStats();
			
			// å¼ºåˆ¶è§¦å‘è®¡æ—¶å™¨æ›´æ–°ä»¥ç¡®ä¿çŠ¶æ€åŒæ­¥
			if (window.updateAllRoomTimers && typeof window.updateAllRoomTimers === 'function') {
				setTimeout(() => {
					window.updateAllRoomTimers();
				}, 100);
			}
		}
		
		// å¦‚æœæ£€æµ‹åˆ°å†²çªï¼Œè§¦å‘å…¨é‡åŒæ­¥
		if (conflictDetected) {
			setTimeout(() => {
				logInfo('å†²çªåè§¦å‘å…¨é‡æ•°æ®åŒæ­¥');
				fetchRoomMeta();
			}, 2000);
		}
	}

	/*************************************************
	 * äº‘ç«¯æ•°æ®åº“åŒæ­¥
	 *************************************************/
	async function syncRoomDatabaseToCloud(rooms) {
		if (!supabaseReady) {
			logWarn('Supabase æœªè¿æ¥ï¼Œè·³è¿‡ç´æˆ¿æ•°æ®åº“åŒæ­¥');
			return;
		}
		
		try {
			const roomData = rooms.map(room => ({
				name: room.name,
				piano_type: room.pianoType || '',
				location: room.location || '',
				remark: room.remark || '',
				updated_at: new Date().toISOString()
			}));
			
			// ä½¿ç”¨ upsert æ‰¹é‡æ’å…¥/æ›´æ–°ç´æˆ¿åŸºç¡€æ•°æ®
			const { data, error } = await supabaseClient
				.from('room_database')
				.upsert(roomData);
			
			if (error) {
				logErr('åŒæ­¥ç´æˆ¿æ•°æ®åº“å¤±è´¥:', error.message);
				toast('ç´æˆ¿æ•°æ®åº“åŒæ­¥å¤±è´¥', 'error');
			} else {
				logInfo(`âœ… æˆåŠŸåŒæ­¥ ${roomData.length} ä¸ªç´æˆ¿åˆ°äº‘ç«¯æ•°æ®åº“`);
				toast(`å·²åŒæ­¥ ${roomData.length} ä¸ªç´æˆ¿åˆ°äº‘ç«¯`);
			}
		} catch (err) {
			logErr('ç´æˆ¿æ•°æ®åº“åŒæ­¥å¼‚å¸¸:', err.message);
		}
	}
	
	async function syncStudentDatabaseToCloud(students) {
		if (!supabaseReady) {
			logWarn('Supabase æœªè¿æ¥ï¼Œè·³è¿‡å­¦ç”Ÿæ•°æ®åº“åŒæ­¥');
			return;
		}
		
		try {
			// è¿‡æ»¤å¹¶è§„èŒƒåŒ–ï¼šä¸ä¸Šä¼ å‰ç«¯ç”Ÿæˆçš„ UUID idï¼Œäº¤ç”±æ•°æ®åº“ bigint identity ç”Ÿæˆ
			// åŒæ—¶ç¡®ä¿ major éç©ºï¼ˆåç«¯ NOT NULLï¼‰ï¼Œè‹¥ä¸ºç©ºåˆ™ä½¿ç”¨å ä½ 'æœªå¡«å†™'
			const cleaned = [];
			for(const s of students){
				if(!s || !s.name) continue; // è·³è¿‡æ— æ•ˆè®°å½•
				const rec = {
					name: String(s.name).trim(),
					major: (s.major && String(s.major).trim()) || 'æœªå¡«å†™',
					grade: (s.grade && String(s.grade).trim()) || ''
				};
				cleaned.push(rec);
			}
			if(!cleaned.length){
				logInfo('æ— å­¦ç”Ÿéœ€è¦åŒæ­¥');
				return;
			}
			// å°†æ•°æ®æŒ‰ name åˆ†æ‰¹ï¼ˆé˜²æ­¢å•æ‰¹è¿‡å¤§ï¼‰
			const BATCH=200; let synced=0; let failed=0; const errors=[];
			for(let i=0;i<cleaned.length;i+=BATCH){
				const slice=cleaned.slice(i,i+BATCH);
				// å›  name æœªå¿…æœ‰å”¯ä¸€ç´¢å¼•ï¼Œé¿å… onConflict ç›´æ¥å¤±è´¥ï¼šå…ˆæŸ¥è¯¢å·²å­˜åœ¨ namesï¼Œå†åˆ† insert / update
				let existingNames=[];
				try{
					const { data:existData, error:existErr } = await supabaseClient
						.from('student_database')
						.select('name')
						.in('name', slice.map(r=>r.name));
					if(!existErr && Array.isArray(existData)) existingNames = existData.map(r=>r.name);
				}catch(e){ /* å¿½ç•¥æŸ¥è¯¢é”™è¯¯ï¼Œç»§ç»­å°è¯•å…¨éƒ¨æ’å…¥ */ }
				const toUpdate = slice.filter(r=> existingNames.includes(r.name));
				const toInsert = slice.filter(r=> !existingNames.includes(r.name));
				// æ‰§è¡Œæ›´æ–°ï¼šPostgREST æ²¡æœ‰ç›´æ¥æ‰¹é‡ update by nameï¼Œåªèƒ½ upsertï¼›ä½†ä¸ºé¿å…å†²çªé—®é¢˜ä»åˆ†å¼€
				if(toInsert.length){
					const { error:insErr } = await supabaseClient.from('student_database').insert(toInsert);
					if(insErr){ failed+=toInsert.length; errors.push('insert:'+insErr.message); }
					else synced+=toInsert.length;
				}
				if(toUpdate.length){
					// upsert ä»…å¯¹å·²æœ‰ name è¡Œæ›´æ–°ï¼ˆå› ä¸º name å·²å­˜åœ¨ï¼‰ï¼Œä¸æŒ‡å®š onConflict è®©åç«¯è‡ªè¡Œæ¨æ–­ä¸»é”® id ä¸ä¼šåŒ¹é…ï¼Œæ‰€ä»¥éœ€è¦é€æ¡ update
					for(const row of toUpdate){
						try{
							const { error:updErr } = await supabaseClient.from('student_database').update({ major:row.major, grade:row.grade }).eq('name', row.name);
							if(updErr){ failed++; errors.push('update:'+updErr.message); } else synced++;
						}catch(e){ failed++; errors.push('update-ex:'+e.message); }
					}
				}
			}
			if(failed){
				logErr(`å­¦ç”ŸåŒæ­¥å®Œæˆï¼šæˆåŠŸ ${synced} å¤±è´¥ ${failed}`);
				toast(`å­¦ç”ŸåŒæ­¥éƒ¨åˆ†å¤±è´¥: æˆåŠŸ${synced} å¤±è´¥${failed}`,'warn');
				if(errors.length) console.warn('[student sync errors]', errors.slice(0,5));
			}else{
				logInfo(`âœ… æˆåŠŸåŒæ­¥ ${synced} ä¸ªå­¦ç”Ÿåˆ°äº‘ç«¯æ•°æ®åº“`);
				toast(`å·²åŒæ­¥ ${synced} ä¸ªå­¦ç”Ÿåˆ°äº‘ç«¯`);
			}
		} catch (err) {
			logErr('å­¦ç”Ÿæ•°æ®åº“åŒæ­¥å¼‚å¸¸:', err.message);
			toast('å­¦ç”Ÿæ•°æ®åº“åŒæ­¥å¼‚å¸¸: '+err.message,'error');
		}
	}
	
	async function manualSyncToCloud() {
		if (!supabaseReady) {
			toast('Supabase æœªè¿æ¥ï¼Œæ— æ³•åŒæ­¥', 'error');
			return;
		}
		
		try {
			toast('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...', 'info');
			
			// åŒæ­¥ç´æˆ¿æ•°æ®åº“
			if (Store.rooms.length > 0) {
				await syncRoomDatabaseToCloud(Store.rooms);
			}
			
			// åŒæ­¥å­¦ç”Ÿæ•°æ®åº“  
			if (Store.students.length > 0) {
				await syncStudentDatabaseToCloud(Store.students);
			}
			
			// åŒæ­¥æˆ¿é—´å®æ—¶çŠ¶æ€
			if (Store.rooms.length > 0) {
				await syncRoomStatusToCloud(Store.rooms);
			}
			
			// åŒæ­¥ç»ƒä¹ è®°å½•ï¼ˆå¦‚æœæœ‰æœ¬åœ°è®°å½•ï¼‰
			await syncPracticeLogsToCloud();

			// æé†’æ•°æ®ï¼špractice_alerts å·²ç›´æ¥å†™äº‘ï¼Œæ— éœ€ä¸Šè¡Œï¼›æ­¤å¤„åˆ·æ–°ä¸€æ¬¡ä»¥ç¡®ä¿ UI æœ€æ–°
			if(window.PracticeAlerts){ await PracticeAlerts.initAlerts?.(); }

			// è‹¥éœ€è¦å°†ä»Šæ—¥ slots ç¼“å­˜åˆ·æ–°ï¼ˆå¯é€‰ï¼‰
			if(window.PracticeAlerts && window.PracticeAlerts.detectionTick){ await PracticeAlerts.detectionTick(); }
			
			// æ›´æ–°äº‘ç«¯æ•°é‡æ˜¾ç¤º
			const cloudRoomCountEl = document.getElementById('cloudRoomCount');
			const cloudStudentCountEl = document.getElementById('cloudStudentCount');
			if (cloudRoomCountEl) cloudRoomCountEl.textContent = Store.rooms.length;
			if (cloudStudentCountEl) cloudStudentCountEl.textContent = Store.students.length;
			
			// æ›´æ–°åŒæ­¥æ—¶é—´
			updateCloudSyncInfo();
			
			toast('âœ… æ‰€æœ‰æ•°æ®å·²åŒæ­¥ï¼ˆå«æé†’åˆ·æ–°ï¼‰');
			logInfo('æ‰‹åŠ¨åŒæ­¥å®Œæˆï¼šåŸºç¡€æ•°æ® + å®æ—¶çŠ¶æ€ + ç»ƒä¹ è®°å½• + æé†’åˆ·æ–°');
		} catch (error) {
			toast('åŒæ­¥å¤±è´¥', 'error');
			logErr('æ‰‹åŠ¨åŒæ­¥å¤±è´¥:', error.message);
		}
	}

	// åŒæ­¥æˆ¿é—´å®æ—¶çŠ¶æ€åˆ° rooms è¡¨
	async function syncRoomStatusToCloud(rooms) {
		if (!supabaseReady) {
			logWarn('Supabase æœªè¿æ¥ï¼Œè·³è¿‡æˆ¿é—´çŠ¶æ€åŒæ­¥');
			return;
		}
		
		try {
			const statusData = rooms.map(room => ({
				name: room.name,
				occupant_student_name: room.occupant_student_name || null,
				register_time: room.registerTime ? new Date(room.registerTime).toISOString() : null,
				heartbeat_at: new Date().toISOString(),
				version: room.version || 1,
				updated_at: new Date().toISOString()
			}));
			
			// ä½¿ç”¨ upsert æ‰¹é‡æ›´æ–°æˆ¿é—´å®æ—¶çŠ¶æ€
			const { data, error } = await supabaseClient
				.from('rooms')
				.upsert(statusData);
			
			if (error) {
				logErr('åŒæ­¥æˆ¿é—´çŠ¶æ€å¤±è´¥:', error.message);
				toast('æˆ¿é—´çŠ¶æ€åŒæ­¥å¤±è´¥', 'error');
			} else {
				logInfo(`âœ… æˆåŠŸåŒæ­¥ ${statusData.length} ä¸ªæˆ¿é—´çŠ¶æ€åˆ°äº‘ç«¯`);
			}
		} catch (err) {
			logErr('æˆ¿é—´çŠ¶æ€åŒæ­¥å¼‚å¸¸:', err.message);
		}
	}

	// åŒæ­¥ç»ƒä¹ è®°å½•åˆ° practice_logs è¡¨
	async function syncPracticeLogsToCloud() {
		if (!supabaseReady) {
			logWarn('Supabase æœªè¿æ¥ï¼Œè·³è¿‡ç»ƒä¹ è®°å½•åŒæ­¥');
			return;
		}
		
		// æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°ç»ƒä¹ è®°å½•å­˜å‚¨
		if (!Store.localPracticeLogs || Store.localPracticeLogs.length === 0) {
			logInfo('æ— æœ¬åœ°ç»ƒä¹ è®°å½•éœ€è¦åŒæ­¥');
			return;
		}
		
		try {
			// è¿‡æ»¤å‡ºå°šæœªåŒæ­¥çš„è®°å½•
			const unsyncedLogs = Store.localPracticeLogs.filter(log => !log.synced);
			
			if (unsyncedLogs.length === 0) {
				logInfo('æ‰€æœ‰ç»ƒä¹ è®°å½•å·²åŒæ­¥');
				return;
			}
			
			// æ‰¹é‡æ’å…¥ç»ƒä¹ è®°å½•
			const { data, error } = await supabaseClient
				.from('practice_logs')
				.insert(unsyncedLogs);
			
			if (error) {
				logErr('åŒæ­¥ç»ƒä¹ è®°å½•å¤±è´¥:', error.message);
				toast('ç»ƒä¹ è®°å½•åŒæ­¥å¤±è´¥', 'error');
			} else {
				// æ ‡è®°ä¸ºå·²åŒæ­¥
				unsyncedLogs.forEach(log => log.synced = true);
				logInfo(`âœ… æˆåŠŸåŒæ­¥ ${unsyncedLogs.length} æ¡ç»ƒä¹ è®°å½•åˆ°äº‘ç«¯`);
			}
		} catch (err) {
			logErr('ç»ƒä¹ è®°å½•åŒæ­¥å¼‚å¸¸:', err.message);
		}
	}
	async function importJson(obj){
		if(Array.isArray(obj)){
			// çŒœæµ‹æ˜¯æˆ¿é—´æ•°ç»„æˆ–å­¦ç”Ÿæ•°ç»„
			if(obj.length && obj[0].pianoType || obj[0].piano_type || obj[0].location){
				await mergeRooms(obj.map(canonicalizeRoom), { metaOnly: true });
				toast('å¯¼å…¥æˆ¿é—´ '+obj.length+' æ¡');
			}else if(obj.length && (obj[0].major || obj[0].grade || obj[0].name)){
				await mergeStudents(obj);
				toast('å¯¼å…¥å­¦ç”Ÿ '+obj.length+' æ¡');
			}else{
				toast('æœªçŸ¥æ•°ç»„ç»“æ„ï¼Œå·²å¿½ç•¥');
			}
		} else if(obj && obj.rooms && obj.students){
			if(Array.isArray(obj.rooms)) await mergeRooms(obj.rooms.map(canonicalizeRoom), { metaOnly: true });
			if(Array.isArray(obj.students)) await mergeStudents(obj.students);
			toast('å¯¼å…¥é›†åˆå®Œæˆ');
		} else {
			toast('ä¸æ”¯æŒçš„ JSON ç»“æ„');
		}
		renderRooms(); updateUsageStats(); refreshStudentModalCache();
	}
	// mergeRooms(list, options)
	// options:
	//  - skipCloudSync: è·³è¿‡äº‘ç«¯åŒæ­¥ï¼ˆç”¨äºä»äº‘ç«¯æ‹‰å–å›å†™æœ¬åœ°æ—¶ï¼Œé˜²é€’å½’ï¼‰
	//  - metaOnly: ä»…æ›´æ–°é™æ€å…ƒæ•°æ®ï¼ˆname/pianoType/location/remarkï¼‰ï¼Œä¸è§¦ç¢° occupant/registerTime/version/heartbeatAt
	async function mergeRooms(list, options = { skipCloudSync: false, metaOnly: false }){
		let added=0, updated=0;
		const newRooms = [];
		
		list.forEach(r=>{ 
			if(!r||!r.name) return; 
			const norm = canonicalizeRoom(r);
			let existing=Store.rooms.find(x=>x.name===norm.name); 
			if(existing){ 
				if(options.metaOnly){
					// ä»…æ›´æ–°é™æ€å­—æ®µ
					existing.name = norm.name;
					existing.pianoType = norm.pianoType;
					existing.location = norm.location;
					existing.remark = norm.remark;
				} else {
					// å…¨é‡åˆå¹¶ï¼ˆå«å¯èƒ½çš„åŠ¨æ€å­—æ®µï¼‰
					Object.assign(existing,norm);
					// ç»Ÿä¸€è§„èŒƒå¹¶ç¡®ä¿ version æ•°å­—ï¼ˆä»…å½“æ­¤æ¬¡åˆå¹¶åŒ…å« version å­—æ®µæ—¶ï¼‰
					if('version' in norm && (existing.version==null || isNaN(existing.version))) existing.version=0;
				}
				updated++; 
			} else { 
				// æ–°å¢ï¼šè‹¥ metaOnlyï¼Œè¡¥é½åŠ¨æ€å­—æ®µé»˜è®¤å€¼ï¼Œé¿å…åç»­ä½¿ç”¨æ—¶æŠ¥ undefined
				if(options.metaOnly){
					norm.occupant = norm.occupant ?? null;
					norm.registerTime = norm.registerTime ?? null;
					norm.version = norm.version ?? 0;
					norm.heartbeatAt = norm.heartbeatAt ?? null;
				}
				Store.rooms.push(norm); 
				newRooms.push(norm);
				added++; 
			}
		});
		
		rebuildIndexes();
		// å¦‚æœå½“å‰æ¥¼å±‚è¿‡æ»¤å·²ä¸åœ¨é›†åˆä¸­åˆ™é‡ç½®
		if(Store.filters.floor!=='ALL' && !Store.floorSet.has(Store.filters.floor)) { Store.filters.floor='ALL'; }
		// è‹¥å½“å‰è¿‡æ»¤å¯¼è‡´æ— ç»“æœåˆ™å°è¯•è‡ªåŠ¨å›é€€
		const visible=Store.rooms.filter(roomFilter).length;
		if(!visible){ Store.filters.floor='ALL'; Store.filters.type='ALL'; }
		logInfo(`åˆå¹¶æˆ¿é—´: æ–°å¢ ${added} æ›´æ–° ${updated} æ€»æ•° ${Store.rooms.length}`);
		
		// è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯æ•°æ®åº“ï¼ˆé™¤éè·³è¿‡ï¼‰
		if (!options.skipCloudSync && list.length > 0) {
			await syncRoomDatabaseToCloud(list);
		}
	}
	
	async function mergeStudents(list, skipCloudSync = false){
		const newStudents = [];
		
		list.forEach(s=>{ 
			if(!s||!s.name) return; 
			let ex=Store.students.find(x=>x.name===s.name); 
			if(ex){ 
				Object.assign(ex,s); 
			} else { 
				Store.students.push(s);
				newStudents.push(s);
			} 
		});
		
		rebuildStudentIndex();
		
		// è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯æ•°æ®åº“ï¼ˆé™¤éè·³è¿‡ï¼‰
		if (!skipCloudSync && list.length > 0) {
			await syncStudentDatabaseToCloud(list);
		}
	}
	function exportRooms(){
		downloadJson(Store.rooms,'rooms_export.json');
	}
	function exportStudents(){ downloadJson(Store.students,'students_export.json'); }
	function downloadJson(data, file){ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=file; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }

	// æ–°å¢: é€šç”¨ CSV è§£æï¼ˆæ”¯æŒå¼•å·ã€è½¬ä¹‰åŒå¼•å·ã€BOMã€CRLFï¼‰
	function parseCSV(raw){
		if(!raw) return {header:[], rows:[]};
		// å»é™¤ BOM
		if(raw.charCodeAt(0)===0xFEFF) raw=raw.slice(1);
		raw = raw.replace(/\r\n?/g,'\n');
		const rows=[]; let cur=[]; let field=''; let inQuotes=false; let i=0;
		function pushField(){ cur.push(field); field=''; }
		function pushRow(){ rows.push(cur); cur=[]; }
		while(i<raw.length){ const ch=raw[i];
			if(inQuotes){
				if(ch==='"'){
					if(raw[i+1]==='"'){ field+='"'; i++; }
					else { inQuotes=false; }
				}else{ field+=ch; }
			}else{
				if(ch==='"'){ inQuotes=true; }
				else if(ch===','){ pushField(); }
				else if(ch==='\n'){ pushField(); pushRow(); }
				else { field+=ch; }
			}
			i++;
		}
		if(field.length>0 || cur.length>0){ pushField(); pushRow(); }
		if(!rows.length) return {header:[], rows:[]};
		const header = rows.shift().map(h=>h.trim());
		return { header, rows: rows.filter(r=> r.some(c=>c.trim()!=='')) };
	}
	function normalizeHeaderKey(k){ return k.replace(/\s+/g,'').replace(/[ _-]/g,'').toLowerCase(); }
	function detectCSVType(header){
		const keys = header.map(normalizeHeaderKey);
		const roomHits = ['åç§°','ä½ç½®','ç±»å‹','å¤‡æ³¨'].map(normalizeHeaderKey).every(h=>keys.includes(h));
		const studentHits = (keys.includes('å§“å')||keys.includes('name')) && keys.includes('ä¸“ä¸š');
		if(roomHits) return 'rooms'; if(studentHits) return 'students'; return 'unknown';
	}
	async function importCsvRooms(header, rows){
		const idx = Object.create(null); header.forEach((h,i)=>{ idx[normalizeHeaderKey(h)]=i; });
		const out=[]; rows.forEach(r=>{
			const name=r[idx['åç§°']??idx['mingcheng']??idx['name']]; if(!name) return;
			const location=r[idx['ä½ç½®']]; const pianoType=r[idx['ç±»å‹']]||'æ— é’¢ç´'; const remark=r[idx['å¤‡æ³¨']]||'';
			out.push({ name: name.trim(), location: (location||'').trim(), pianoType: pianoType.trim(), remark: remark.trim() });
		});
		await mergeRooms(out.map(o=>({name:o.name, location:o.location, pianoType:o.pianoType, remark:o.remark})), { metaOnly: true });
		toast('CSV å¯¼å…¥ç´æˆ¿ '+out.length+' æ¡');
		renderRooms(); updateUsageStats();
	}
	async function importCsvStudents(header, rows){
		const idx = Object.create(null); header.forEach((h,i)=>{ idx[normalizeHeaderKey(h)]=i; });
		const out=[]; rows.forEach(r=>{
			const name=r[idx['å§“å']??idx['name']]; if(!name) return;
			const major=r[idx['ä¸“ä¸š']??idx['major']]||''; const grade=r[idx['å¹´çº§']??idx['grade']]||''; const idRaw=r[idx['id']]||r[idx['ç¼–å·']]||'';
			out.push({ id: idRaw||undefined, name: name.trim(), major: major.trim(), grade: grade.trim() });
		});
		await mergeStudents(out);
		toast('CSV å¯¼å…¥å­¦ç”Ÿ '+out.length+' æ¡');
	}

	// æŒ‰é’®ç»‘å®šå·²ç§»è‡³ DOMContentLoaded äº‹ä»¶ç›‘å¬å™¨ä¸­
	
	// ğŸ”§ é¡µé¢æ•°æ®ä¸€è‡´æ€§éªŒè¯å™¨ - é˜²æ­¢ç¼“å­˜æ•°æ®æ±¡æŸ“
	const DataConsistencyValidator = {
		async validateOnPageLoad() {
			const validationId = Date.now();
			logInfo(`[DataValidator] å¯åŠ¨é¡µé¢åŠ è½½æ•°æ®ä¸€è‡´æ€§éªŒè¯ #${validationId}`);
			
			try {
				// æ£€æŸ¥éªŒè¯æ¡ä»¶ï¼šé¿å…åœ¨æ•°æ®æœªå®Œå…¨åŠ è½½æ—¶è¿›è¡ŒéªŒè¯
				if (!Store.rooms || Store.rooms.length === 0) {
					logInfo(`[DataValidator] Storeæ•°æ®å°šæœªåŠ è½½ï¼Œè·³è¿‡éªŒè¯ #${validationId}`);
					return { issues: 0, timerIssues: [], storeIssues: [], skipped: 'store_not_ready' };
				}
				
				// 1. æ¸…ç†æ‰€æœ‰å¯èƒ½çš„æ—§ç¼“å­˜æ•°æ®
				await this.cleanupStaleCache();
				
				// 2. éªŒè¯localStorageä¸­çš„è®¡æ—¶å™¨çŠ¶æ€
				const timerIssues = await this.validateTimerStates();
				if (timerIssues.length > 0) {
					logWarn(`[DataValidator] å‘ç° ${timerIssues.length} ä¸ªè®¡æ—¶å™¨çŠ¶æ€é—®é¢˜`, timerIssues);
				}
				
				// 3. éªŒè¯Storeæ•°æ®ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§
				const storeIssues = await this.validateStoreConsistency();
				if (storeIssues.length > 0) {
					logWarn(`[DataValidator] å‘ç° ${storeIssues.length} ä¸ªStoreæ•°æ®ä¸ä¸€è‡´`, storeIssues);
				}
				
				// 4. å¦‚æœå‘ç°é—®é¢˜ï¼Œå¼ºåˆ¶é‡æ–°åŒæ­¥
				const totalIssues = timerIssues.length + storeIssues.length;
				if (totalIssues > 0) {
					logWarn(`[DataValidator] æ£€æµ‹åˆ° ${totalIssues} ä¸ªæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œæ‰§è¡Œå¼ºåˆ¶åŒæ­¥`);
					await this.forceDataSync();
				} else {
					logInfo(`[DataValidator] éªŒè¯å®Œæˆ #${validationId} - æ•°æ®ä¸€è‡´æ€§æ­£å¸¸`);
				}
				
				return { issues: totalIssues, timerIssues, storeIssues };
				
			} catch (error) {
				logErr(`[DataValidator] éªŒè¯è¿‡ç¨‹å¼‚å¸¸:`, error.message);
				// å¦‚æœéªŒè¯å¤±è´¥ï¼Œå®‰å…¨èµ·è§å¼ºåˆ¶é‡æ–°åŒæ­¥
				await this.forceDataSync();
				return { issues: -1, error: error.message };
			}
		},
		
		async cleanupStaleCache() {
			// æ¸…ç†å¯èƒ½çš„æ—§è®¡æ—¶å™¨çŠ¶æ€ç¼“å­˜
			const cacheKeys = [
				'yms_timer_states',
				'yms_room_cache',
				'yms_temp_states',
				'yms_operation_cache'
			];
			
			let cleanedCount = 0;
			cacheKeys.forEach(key => {
				if (localStorage.getItem(key)) {
					localStorage.removeItem(key);
					cleanedCount++;
				}
			});
			
			if (cleanedCount > 0) {
				logInfo(`[DataValidator] æ¸…ç†äº† ${cleanedCount} ä¸ªç¼“å­˜é¡¹`);
			}
		},
		
		async validateTimerStates() {
			const issues = [];
			try {
				const stored = localStorage.getItem(timerPersistence.storageKey);
				if (stored) {
					const data = JSON.parse(stored);
					const states = data.states || [];
					
					// æ£€æŸ¥æ¯ä¸ªç¼“å­˜çš„è®¡æ—¶å™¨çŠ¶æ€
					for (const state of states) {
						// éªŒè¯è¯¥æˆ¿é—´åœ¨æ•°æ®åº“ä¸­æ˜¯å¦çœŸçš„è¢«å ç”¨
						const dbRoom = await this.getRoomFromDB(state.roomName);
						if (!dbRoom || !dbRoom.occupant_student_name) {
							issues.push({
								type: 'timer_ghost',
								roomName: state.roomName,
								cachedStudent: state.occupant_student_name,
								reason: 'ç¼“å­˜æ˜¾ç¤ºå ç”¨ä½†æ•°æ®åº“ä¸ºç©º'
							});
						}
					}
				}
			} catch (error) {
				issues.push({
					type: 'timer_cache_error',
					error: error.message
				});
			}
			return issues;
		},
		
		async validateStoreConsistency() {
			const issues = [];
			try {
				// æ£€æŸ¥Storeæ•°æ®æ˜¯å¦å·²å®Œå…¨åŠ è½½
				if (!Store.rooms || Store.rooms.length === 0) {
					// Storeæ•°æ®å°šæœªåŠ è½½å®Œæˆï¼Œè·³è¿‡éªŒè¯é¿å…è¯¯æŠ¥
					return issues;
				}
				
				// è·å–æ•°æ®åº“çš„çœŸå®æ•°æ®
				const dbRooms = await fetchRooms();
				if (!dbRooms || dbRooms.length === 0) return issues;
				
				// ğŸ”§ ä¿®å¤ï¼šæ•°æ®å·®å¼‚å¤§æ—¶æ›´éœ€è¦éªŒè¯å’Œä¿®å¤ï¼Œè€Œä¸æ˜¯è·³è¿‡
				const roomCountDiff = Math.abs(Store.rooms.length - dbRooms.length);
				const diffPercentage = Math.round((roomCountDiff / Math.max(Store.rooms.length, dbRooms.length)) * 100);
				
				if (roomCountDiff > 10) {
					logWarn(`[DataValidator] æ£€æµ‹åˆ°ä¸¥é‡æ•°æ®ä¸ä¸€è‡´: Store(${Store.rooms.length}) vs DB(${dbRooms.length}), å·®å¼‚${diffPercentage}%`);
					logWarn(`[DataValidator] è¿™å¯èƒ½è¡¨æ˜æ•°æ®åŒæ­¥å­˜åœ¨é—®é¢˜ï¼Œå°†è¿›è¡Œå¼ºåˆ¶ä¿®å¤`);
					
					// è®°å½•è¯¦ç»†çš„æˆ¿é—´åç§°å¯¹æ¯”
					const storeNames = new Set(Store.rooms.map(r => r.name));
					const dbNames = new Set(dbRooms.map(r => r.name));
					
					// æ‰¾å‡ºStoreä¸­æœ‰ä½†DBä¸­æ²¡æœ‰çš„æˆ¿é—´ï¼ˆå¯èƒ½æ˜¯æœªåŒæ­¥çš„æ–°å¢ï¼‰
					const storeOnly = Store.rooms.filter(r => !dbNames.has(r.name));
					if (storeOnly.length > 0) {
						logWarn(`[DataValidator] Storeç‹¬æœ‰æˆ¿é—´ (${storeOnly.length}ä¸ª):`, storeOnly.slice(0, 10).map(r => r.name));
						
						// æ ‡è®°è¿™äº›æˆ¿é—´éœ€è¦åŒæ­¥åˆ°æ•°æ®åº“
						issues.push({
							type: 'store_orphan_rooms',
							roomNames: storeOnly.map(r => r.name),
							count: storeOnly.length,
							reason: 'Storeä¸­å­˜åœ¨ä½†æ•°æ®åº“ä¸­ç¼ºå¤±çš„æˆ¿é—´'
						});
					}
					
					// æ‰¾å‡ºDBä¸­æœ‰ä½†Storeä¸­æ²¡æœ‰çš„æˆ¿é—´ï¼ˆå¯èƒ½æ˜¯æœ¬åœ°æ•°æ®ä¸¢å¤±ï¼‰
					const dbOnly = dbRooms.filter(r => !storeNames.has(r.name));
					if (dbOnly.length > 0) {
						logWarn(`[DataValidator] DBç‹¬æœ‰æˆ¿é—´ (${dbOnly.length}ä¸ª):`, dbOnly.slice(0, 10).map(r => r.name));
						
						// æ ‡è®°è¿™äº›æˆ¿é—´éœ€è¦åŒæ­¥åˆ°Store
						issues.push({
							type: 'db_orphan_rooms',
							roomNames: dbOnly.map(r => r.name),
							count: dbOnly.length,
							reason: 'æ•°æ®åº“ä¸­å­˜åœ¨ä½†Storeä¸­ç¼ºå¤±çš„æˆ¿é—´'
						});
					}
					
					// ğŸ”§ å…³é”®ä¿®å¤ï¼šç«‹å³è¿›è¡Œæ•°æ®ä¿®å¤è€Œä¸æ˜¯è·³è¿‡
					await this.repairDataInconsistency(storeOnly, dbOnly);
				}
				
				// æ¯”è¾ƒStoreä¸­çš„æ•°æ®ä¸æ•°æ®åº“æ•°æ®
				const storeOccupied = Store.rooms.filter(r => r.occupant_student_name && r.occupant_student_name.trim() !== '');
				const dbOccupied = dbRooms.filter(r => r.occupant_student_name && r.occupant_student_name.trim() !== '');
				
				// å¦‚æœåŒæ–¹éƒ½æ²¡æœ‰å ç”¨æˆ¿é—´ï¼Œè¯´æ˜æ•°æ®æ˜¯ä¸€è‡´çš„
				if (storeOccupied.length === 0 && dbOccupied.length === 0) {
					return issues; // æ²¡æœ‰å ç”¨æˆ¿é—´ï¼Œæ•°æ®ä¸€è‡´
				}
				
				// æ£€æŸ¥Storeä¸­æœ‰ä½†æ•°æ®åº“ä¸­æ²¡æœ‰çš„æˆ¿é—´ï¼ˆå¹½çµå ç”¨ï¼‰
				storeOccupied.forEach(storeRoom => {
					const dbRoom = dbRooms.find(r => r.name === storeRoom.name);
					if (!dbRoom || !dbRoom.occupant_student_name || dbRoom.occupant_student_name.trim() === '') {
						// è¿›ä¸€æ­¥éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯æ­£åœ¨è¿›è¡Œçš„æ“ä½œ
						const isRecentOperation = Store.pendingAssign.has(storeRoom.name) || 
												 (storeRoom.registerTime && (Date.now() - storeRoom.registerTime) < 30000);
						
						if (!isRecentOperation) {
							issues.push({
								type: 'store_ghost',
								roomName: storeRoom.name,
								storeStudent: storeRoom.occupant_student_name,
								reason: 'Storeæ˜¾ç¤ºå ç”¨ä½†æ•°æ®åº“ä¸ºç©º'
							});
						}
					}
				});
				
				// æ£€æŸ¥æ•°æ®åº“ä¸­æœ‰ä½†Storeä¸­æ²¡æœ‰çš„æˆ¿é—´ï¼ˆæ•°æ®ä¸¢å¤±ï¼‰
				dbOccupied.forEach(dbRoom => {
					const storeRoom = Store.rooms.find(r => r.name === dbRoom.name);
					if (!storeRoom || !storeRoom.occupant_student_name || storeRoom.occupant_student_name.trim() === '') {
						issues.push({
							type: 'store_missing',
							roomName: dbRoom.name,
							dbStudent: dbRoom.occupant_student_name,
							reason: 'æ•°æ®åº“æ˜¾ç¤ºå ç”¨ä½†Storeä¸ºç©º'
						});
					}
				});
				
			} catch (error) {
				issues.push({
					type: 'store_validation_error',
					error: error.message
				});
			}
			return issues;
		},
		
		async getRoomFromDB(roomName) {
			try {
				const { data, error } = await supabaseClient
					.from('rooms')
					.select('name, occupant_student_name, register_time, version')
					.eq('name', roomName)
					.single();
				
				if (error) return null;
				return data;
			} catch (error) {
				return null;
			}
		},
		
		// ğŸ”§ æ–°å¢ï¼šä¿®å¤æ•°æ®ä¸ä¸€è‡´çš„æ–¹æ³•
		async repairDataInconsistency(storeOnlyRooms, dbOnlyRooms) {
			logInfo('[DataValidator] å¼€å§‹ä¿®å¤æ•°æ®ä¸ä¸€è‡´é—®é¢˜...');
			
			try {
				let repairedCount = 0;
				
				// 1. å¤„ç†Storeç‹¬æœ‰çš„æˆ¿é—´ï¼ˆåŒæ­¥åˆ°æ•°æ®åº“ï¼‰
				if (storeOnlyRooms && storeOnlyRooms.length > 0) {
					logInfo(`[DataValidator] åŒæ­¥ ${storeOnlyRooms.length} ä¸ªStoreç‹¬æœ‰æˆ¿é—´åˆ°æ•°æ®åº“...`);
					
					for (const room of storeOnlyRooms) {
						try {
							// æ£€æŸ¥room_databaseä¸­æ˜¯å¦æœ‰å¯¹åº”çš„å…ƒæ•°æ®
							const { data: metaData } = await supabaseClient
								.from('room_database')
								.select('*')
								.eq('name', room.name)
								.single();
							
							if (metaData) {
								// å¦‚æœæœ‰å…ƒæ•°æ®ï¼ŒåŒæ­¥æˆ¿é—´çŠ¶æ€åˆ°roomsè¡¨
								await supabaseClient
									.from('rooms')
									.upsert({
										name: room.name,
										piano_type: room.pianoType || metaData.piano_type,
										location: room.location || metaData.location,
										remark: room.remark || metaData.remark,
										occupant_student_name: room.occupant_student_name || null,
										register_time: room.registerTime ? new Date(room.registerTime).toISOString() : null,
										version: room.version || 0
									});
								
								repairedCount++;
								logInfo(`[DataValidator] å·²åŒæ­¥æˆ¿é—´åˆ°æ•°æ®åº“: ${room.name}`);
							} else {
								// å¦‚æœæ²¡æœ‰å…ƒæ•°æ®ï¼Œå¯èƒ½æ˜¯åƒåœ¾æ•°æ®ï¼Œä»Storeä¸­ç§»é™¤
								const roomIndex = Store.rooms.findIndex(r => r.name === room.name);
								if (roomIndex >= 0) {
									Store.rooms.splice(roomIndex, 1);
									logInfo(`[DataValidator] ç§»é™¤æ— æ•ˆæˆ¿é—´: ${room.name}`);
									repairedCount++;
								}
							}
						} catch (error) {
							logWarn(`[DataValidator] ä¿®å¤æˆ¿é—´ ${room.name} å¤±è´¥:`, error.message);
						}
					}
				}
				
				// 2. å¤„ç†æ•°æ®åº“ç‹¬æœ‰çš„æˆ¿é—´ï¼ˆåŒæ­¥åˆ°Storeï¼‰
				if (dbOnlyRooms && dbOnlyRooms.length > 0) {
					logInfo(`[DataValidator] åŒæ­¥ ${dbOnlyRooms.length} ä¸ªæ•°æ®åº“ç‹¬æœ‰æˆ¿é—´åˆ°Store...`);
					
					for (const dbRoom of dbOnlyRooms) {
						const canonicalRoom = canonicalizeRoom(dbRoom);
						if (canonicalRoom) {
							Store.rooms.push(canonicalRoom);
							repairedCount++;
							logInfo(`[DataValidator] å·²åŒæ­¥æˆ¿é—´åˆ°Store: ${dbRoom.name}`);
						}
					}
				}
				
				// 3. é‡å»ºç´¢å¼•å’Œåˆ·æ–°UI
				if (repairedCount > 0) {
					if (typeof rebuildIndexes === 'function') {
						rebuildIndexes();
					}
					if (typeof renderRooms === 'function') {
						renderRooms();
					}
					if (typeof updateUsageStats === 'function') {
						updateUsageStats();
					}
					
					logInfo(`[DataValidator] æ•°æ®ä¿®å¤å®Œæˆï¼Œå·²å¤„ç† ${repairedCount} ä¸ªæˆ¿é—´`);
					toast(`âœ… å·²ä¿®å¤ ${repairedCount} ä¸ªæ•°æ®ä¸ä¸€è‡´é—®é¢˜`, 'success');
				}
				
			} catch (error) {
				logErr('[DataValidator] æ•°æ®ä¿®å¤è¿‡ç¨‹å¤±è´¥:', error.message);
				toast('âŒ æ•°æ®ä¿®å¤å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
			}
		},
		
		async forceDataSync() {
			logInfo('[DataValidator] æ‰§è¡Œå¼ºåˆ¶æ•°æ®åŒæ­¥');
			
			try {
				// 1. æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
				if (typeof timerPersistence !== 'undefined' && timerPersistence.cleanup) {
					timerPersistence.cleanup();
				}
				
				// 2. ä»æ•°æ®åº“é‡æ–°æ‹‰å–æˆ¿é—´æ•°æ®
				if (typeof fetchRooms === 'function') {
					const freshRooms = await fetchRooms();
					if (freshRooms) {
						Store.rooms = freshRooms;
						if (typeof rebuildIndexes === 'function') {
							rebuildIndexes();
						}
						logInfo(`[DataValidator] å·²é‡æ–°åŠ è½½ ${freshRooms.length} ä¸ªæˆ¿é—´æ•°æ®`);
					}
				}
				
				// 3. å¼ºåˆ¶åˆ·æ–°UI
				if (typeof renderRooms === 'function') {
					renderRooms();
				}
				if (typeof updateUsageStats === 'function') {
					updateUsageStats();
				}
				
				// 4. é‡æ–°åˆå§‹åŒ–è®¡æ—¶å™¨ç³»ç»Ÿ
				if (window.updateAllRoomTimers && typeof window.updateAllRoomTimers === 'function') {
					window.updateAllRoomTimers();
				}
				
				logInfo('[DataValidator] å¼ºåˆ¶æ•°æ®åŒæ­¥å®Œæˆ');
				
			} catch (error) {
				logErr('[DataValidator] å¼ºåˆ¶åŒæ­¥å¤±è´¥:', error.message);
			}
		}
	};
	
	// ç¼–è¾‘æ¨¡å¼åˆ‡æ¢
	function toggleEditMode() {
		Store.editMode = !Store.editMode;
		const btn = document.getElementById('btnEditRooms');
		if (Store.editMode) {
			btn.textContent = 'ä¿å­˜';
			btn.classList.add('active');
			// æ¸…ç©ºä¹‹å‰çš„å¾…ä¿å­˜ä¿®æ”¹ï¼ˆè¿›å…¥ç¼–è¾‘æ¨¡å¼æ—¶é‡ç½®ï¼‰
			Store.pendingChanges.clear();
		} else {
			btn.textContent = 'ç¼–è¾‘';
			btn.classList.remove('active');
			// ä¿å­˜æ¨¡å¼ï¼šåŒæ­¥æ‰€æœ‰ä¿®æ”¹åˆ°äº‘ç«¯
			saveAllRoomChanges();
		}
		renderRooms();
		ensureFilters();
	}
	
	// ä¿å­˜æ‰€æœ‰æˆ¿é—´ä¿®æ”¹
	async function saveAllRoomChanges() {
		try {
			// æ£€æŸ¥æ˜¯å¦æœ‰å¾…ä¿å­˜çš„ä¿®æ”¹
			if (Store.pendingChanges.size === 0) {
				logInfo('æ²¡æœ‰å¾…ä¿å­˜çš„ä¿®æ”¹');
				return;
			}
			
			toast('æ­£åœ¨ä¿å­˜ä¿®æ”¹...', 'info');
			
			// ç»Ÿä¸€åŒæ­¥æ‰€æœ‰å¾…ä¿å­˜çš„ä¿®æ”¹åˆ°æ•°æ®åº“
			if (!Store.settings.offlineMode && supabaseReady) {
				const promises = [];
				
				for (const [roomName, changes] of Store.pendingChanges.entries()) {
					// åŒæ­¥å¤‡æ³¨
					if (changes.remark !== undefined) {
						promises.push(
							syncRoomRemarkToDatabase(roomName, changes.remark)
								.catch(error => logWarn(`æˆ¿é—´å¤‡æ³¨åŒæ­¥å¤±è´¥ ${roomName}:`, error.message))
						);
					}
					
					// åŒæ­¥æ¥¼å±‚
					if (changes.location !== undefined) {
						promises.push(
							syncRoomLocationToDatabase(roomName, changes.location)
								.catch(error => logWarn(`æˆ¿é—´æ¥¼å±‚åŒæ­¥å¤±è´¥ ${roomName}:`, error.message))
						);
					}
					
					// åŒæ­¥ç´æˆ¿ç±»å‹
					if (changes.pianoType !== undefined) {
						promises.push(
							syncRoomTypeToDatabase(roomName, changes.pianoType)
								.catch(error => logWarn(`æˆ¿é—´ç±»å‹åŒæ­¥å¤±è´¥ ${roomName}:`, error.message))
						);
					}
				}
				
				// ç­‰å¾…æ‰€æœ‰åŒæ­¥å®Œæˆ
				await Promise.all(promises);
				
				logInfo(`âœ… å·²åŒæ­¥ ${Store.pendingChanges.size} ä¸ªæˆ¿é—´çš„ä¿®æ”¹åˆ°æ•°æ®åº“`);
			}
			
			// æ¸…ç©ºå¾…ä¿å­˜åˆ—è¡¨
			Store.pendingChanges.clear();
			
			toast('âœ… æ‰€æœ‰ä¿®æ”¹å·²ä¿å­˜åˆ°äº‘ç«¯');
		} catch (error) {
			toast('ä¿å­˜å¤±è´¥', 'error');
			logErr('ä¿å­˜æˆ¿é—´ä¿®æ”¹å¤±è´¥:', error.message);
		}
	}
	
	// åˆ é™¤ç´æˆ¿
	async function deleteRoom(roomName) {
		try {
			const room = Store.byName.get(roomName);
			if (!room) {
				toast('æˆ¿é—´ä¸å­˜åœ¨', 'warn');
				return;
			}
			
			// è®¾ç½®åˆ é™¤æ“ä½œé”ï¼Œé˜²æ­¢æœ¬åœ°é‡å¤å¤„ç†
			// ğŸ’¡ ä½¿ç”¨æ›´ç²¾ç¡®çš„é”æ ‡è¯†ï¼ŒåŒ…å«éšæœºæ•°é¿å…è·¨è®¾å¤‡å†²çª
			const deleteLockKey = `delete_${roomName}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;
			if (!Store.operationLocks) Store.operationLocks = new Set();
			Store.operationLocks.add(deleteLockKey);
			
			// ğŸ’¡ åŒæ—¶è®¾ç½®ä¸€ä¸ªç®€å•çš„åˆ é™¤æ ‡è®°ä¾›å¿«é€Ÿæ£€æŸ¥
			if (!Store.deletionMarkers) Store.deletionMarkers = new Map();
			Store.deletionMarkers.set(roomName, Date.now());
			
			try {
				// å¦‚æœæˆ¿é—´æœ‰å ç”¨è€…ï¼Œå…ˆæ¸…ç©º
					if (room.occupant_student_name) {
					toast('æˆ¿é—´æœ‰å ç”¨è€…ï¼Œå°†å…ˆæ¸…ç©º...', 'info');
					await clearRoomUnified(roomName);
				}
				
				// ğŸ’¡ ç«‹å³ä»æœ¬åœ°ç§»é™¤ï¼Œè§¦å‘å³æ—¶ UI æ›´æ–°ï¼ˆä¹è§‚åˆ é™¤ï¼‰
				const index = Store.rooms.findIndex(r => r.name === roomName);
				if (index !== -1) {
					Store.rooms.splice(index, 1);
					Store.byName.delete(roomName);
				}
				cleanupRoomState(roomName); // æ¸…ç†çŠ¶æ€å’ŒDOM
				rebuildIndexes(); // é‡å»ºç´¢å¼•ï¼Œæ›´æ–°æ¥¼å±‚é›†åˆ
				renderRooms(); // ç«‹å³é‡æ–°æ¸²æŸ“ï¼Œæˆ¿é—´æ¶ˆå¤±
				ensureFilters();
				
				logInfo(`ğŸ—‘ï¸ æœ¬åœ°åˆ é™¤å®Œæˆï¼Œå¼€å§‹äº‘ç«¯åŒæ­¥: ${roomName}`);
				
				// ğŸ’¡ äº‘ç«¯åˆ é™¤ï¼šåŒè¡¨åŒæ—¶åˆ é™¤ç¡®ä¿å…¶ä»–è®¾å¤‡æ”¶åˆ° DELETE äº‹ä»¶
				if (!Store.settings.offlineMode && supabaseReady) {
					// å¹¶è¡Œåˆ é™¤ä¸¤ä¸ªè¡¨ï¼Œç¡®ä¿ realtime äº‹ä»¶å¿«é€Ÿä¼ æ’­
					const deletePromises = [
						supabaseClient.from('room_database').delete().eq('name', roomName),
						supabaseClient.from('rooms').delete().eq('name', roomName)
					];
					
					try {
						await Promise.all(deletePromises);
						logInfo(`âœ… äº‘ç«¯åˆ é™¤æˆåŠŸ: ${roomName}`);
					} catch (cloudError) {
						logErr(`âŒ äº‘ç«¯åˆ é™¤å¤±è´¥: ${roomName}`, cloudError.message);
						// äº‘ç«¯åˆ é™¤å¤±è´¥ï¼šè€ƒè™‘å›æ»šæœ¬åœ°åˆ é™¤ï¼ˆå¯é€‰ï¼‰
						if (cloudError.message.includes('network') || cloudError.message.includes('timeout')) {
							toast('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
							// å¯ä»¥åœ¨è¿™é‡Œå®ç°å›æ»šé€»è¾‘
						} else {
							toast('äº‘ç«¯åˆ é™¤å¤±è´¥', 'error');
						}
						throw cloudError;
					}
				}
				
				toast(`âœ… å·²åˆ é™¤ç´æˆ¿ï¼š${roomName}`);
				logInfo(`ğŸ‰ æˆ¿é—´åˆ é™¤å®Œæˆ(æœ¬åœ°+äº‘ç«¯): ${roomName}`);
				
			} finally {
				// ğŸ’¡ æ¸…é™¤åˆ é™¤é”å’Œæ ‡è®°
				setTimeout(() => {
					Store.operationLocks.delete(deleteLockKey);
					logInfo(`ğŸ”“ åˆ é™¤é”å·²æ¸…é™¤: ${roomName}`);
				}, 200);
				
				// ğŸ’¡ å»¶è¿Ÿæ¸…é™¤åˆ é™¤æ ‡è®°ï¼Œç»™å…¶ä»–è®¾å¤‡è¶³å¤Ÿæ—¶é—´æ¥æ”¶äº‹ä»¶
				setTimeout(() => {
					if (Store.deletionMarkers) {
						Store.deletionMarkers.delete(roomName);
						logInfo(`ğŸ·ï¸ åˆ é™¤æ ‡è®°å·²æ¸…é™¤: ${roomName}`);
					}
				}, 8000); // 8ç§’åæ¸…é™¤æ ‡è®°
			}
		} catch (error) {
			toast('åˆ é™¤å¤±è´¥', 'error');
			logErr('åˆ é™¤ç´æˆ¿å¤±è´¥:', error.message);
		}
	}

	// ğŸ”— å°†åˆ é™¤å‡½æ•°ç»‘å®šåˆ° window å¯¹è±¡ä¾›æµ‹è¯•ä½¿ç”¨
	window.deleteRoom = deleteRoom;
	
	// ç»‘å®šå†…è”ç¼–è¾‘äº‹ä»¶
	function bindInlineEditEvents() {
		const grid = document.getElementById('roomGrid');
		
		// ç›‘å¬å¯ç¼–è¾‘å…ƒç´ çš„è¾“å…¥äº‹ä»¶
		grid.addEventListener('blur', e => {
			if (!e.target.hasAttribute('contenteditable')) return;
			saveInlineEdit(e.target);
		}, true);
		
		// ç›‘å¬å›è½¦é”®ä¿å­˜
		grid.addEventListener('keydown', e => {
			if (!e.target.hasAttribute('contenteditable')) return;
			if (e.key === 'Enter') {
				e.preventDefault();
				e.target.blur(); // è§¦å‘bluräº‹ä»¶ä¿å­˜
			}
		});
		
		// ç›‘å¬ç´æˆ¿ç±»å‹é€‰æ‹©å™¨å˜åŒ–
		grid.addEventListener('change', e => {
			if (!e.target.classList.contains('piano-type-selector')) return;
			savePianoTypeChange(e.target);
		});
		
		// ä¸ºç©ºçš„å¤‡æ³¨å’Œæ¥¼å±‚æä¾›å ä½æç¤ºï¼Œæˆ¿é—´åç§°è·å¾—ç„¦ç‚¹æ—¶ä¿æŒçº¯æ–‡æœ¬
		grid.addEventListener('focus', e => {
			if (!e.target.hasAttribute('contenteditable')) return;
			
			if (e.target.dataset.field === 'remark' && e.target.textContent === 'ç‚¹å‡»æ·»åŠ å¤‡æ³¨...') {
				e.target.textContent = '';
			} else if (e.target.dataset.field === 'location' && e.target.textContent === 'ç‚¹å‡»æ·»åŠ æ¥¼å±‚...') {
				e.target.textContent = '';
			} else if (e.target.dataset.field === 'name') {
				// æˆ¿é—´åç§°è·å¾—ç„¦ç‚¹æ—¶ï¼Œç§»é™¤å¯èƒ½çš„HTMLæ ‡ç­¾ï¼Œåªä¿ç•™çº¯æ–‡æœ¬åç§°
				const card = e.target.closest('.room-card');
				if (card) {
					const roomName = card.dataset.room;
					e.target.textContent = roomName;
				}
			}
		}, true);
	}
	
	// ä¿å­˜ç´æˆ¿ç±»å‹å˜åŒ–
	function savePianoTypeChange(selectElement) {
		const roomName = selectElement.dataset.room;
		const newType = selectElement.value;
		
		const room = Store.byName.get(roomName);
		if (!room) return;
		
		// æ˜ å°„é€‰æ‹©å™¨å€¼åˆ°æ•°æ®åº“æ ¼å¼
		let pianoType = '';
		switch(newType) {
			case 'ä¸‰è§’':
				pianoType = 'ä¸‰è§’é’¢ç´';
				break;
			case 'ç«‹å¼':
				pianoType = 'ç«‹å¼é’¢ç´';
				break;
			case 'å…¶ä»–':
			default:
				pianoType = 'å…¶ä»–';
				break;
		}
		
		// æ›´æ–°æœ¬åœ°æ•°æ®
		room.pianoType = pianoType;
		
		// æ›´æ–°å¡ç‰‡çš„ data-grand å±æ€§
		const card = selectElement.closest('.room-card');
		if (card) {
			const isGrand = /ä¸‰è§’/.test(pianoType);
			card.dataset.grand = isGrand ? '1' : '0';
		}
		
		logInfo(`æ›´æ–°æˆ¿é—´ç±»å‹ï¼š${roomName} -> ${pianoType}`);
		
		// è®°å½•å¾…ä¿å­˜çš„ä¿®æ”¹ï¼Œç‚¹å‡»ä¿å­˜æŒ‰é’®åç»Ÿä¸€åŒæ­¥
		if (!Store.pendingChanges.has(roomName)) {
			Store.pendingChanges.set(roomName, {});
		}
		Store.pendingChanges.get(roomName).pianoType = pianoType;
		
		// å¼ºåˆ¶é‡æ–°æ¸²æŸ“å¡ç‰‡ä»¥æ›´æ–°è¿‡æ»¤çŠ¶æ€å’Œç±»å‹æ˜¾ç¤º
		setTimeout(() => {
			renderRoomCardForced(roomName);
		}, 0);
	}
	
	// ä¿å­˜å†…è”ç¼–è¾‘
	function saveInlineEdit(element) {
		const card = element.closest('.room-card');
		if (!card) return;
		
		const roomName = card.dataset.room;
		const field = element.dataset.field;
		const value = element.textContent.trim();
		
		const room = Store.byName.get(roomName);
		if (!room) return;
		
		// æ›´æ–°æœ¬åœ°æ•°æ®
		if (field === 'name') {
			// æˆ¿é—´åç§°ä¿®æ”¹éœ€è¦ç‰¹æ®Šå¤„ç†ï¼ˆå»¶è¿Ÿä¹è§‚æ–¹æ¡ˆï¼‰
			if (value && value !== room.name) {
				const oldName = room.name;
				// æœ¬åœ°å¿«é€Ÿå†²çªï¼šå·²æœ‰åŒå
				if (Store.byName.has(value)) {
					toast('æˆ¿é—´åç§°å·²å­˜åœ¨', 'warn');
					element.textContent = oldName;
					return;
				}
				// å¹¶å‘é”åˆ¤å®š
				if(window.__renameLocks && window.__renameLocks.size){
					toast('æ­£åœ¨å¤„ç†å…¶å®ƒé‡å‘½å, ç¨å€™', 'warn');
					element.textContent = oldName; return;
				}
				// å…ˆæ˜¾ç¤º "ä¿å­˜ä¸­..." å ä½é¿å…ç”¨æˆ·è¯¯ä»¥ä¸ºæˆåŠŸ
				const placeholder = `${value}`;
				// å‘èµ·è¿œç¨‹æ£€æŸ¥ + æ›´æ–°ï¼ˆä¸ç«‹å³æ”¹ Store.byName ç´¢å¼•, ç­‰æˆåŠŸåå†æ”¹ï¼‰
				if (!Store.settings.offlineMode && supabaseReady) {
					syncRoomNameToDatabase(oldName, value, { silent:false })
						.then(res=>{
							// æˆåŠŸï¼šç°åœ¨æ‰çœŸæ­£æ›´æ–°æœ¬åœ°ç´¢å¼•ï¼ˆè‹¥ä¸­é€”ç”¨æˆ·åˆæ”¹äº†åå­—éœ€è¦äºŒæ¬¡æ ¡éªŒï¼‰
							if(room.name!==oldName){
								// å·²è¢«åˆ«çš„æµç¨‹æ”¹åŠ¨ï¼Œæ”¾å¼ƒï¼ˆrealtime ä¼šåŒæ­¥ï¼‰
								logWarn('æœ¬åœ°æˆ¿é—´åç§°å·²å˜åŒ–ï¼Œæ”¾å¼ƒæœ¬æ¬¡ç´¢å¼•æ›´æ–°');
								return;
							}
							Store.byName.delete(oldName);
							room.name = value;
							Store.byName.set(value, room);
							card.dataset.room = value;
							toast('âœ… é‡å‘½åæˆåŠŸ');
							renderRoomCardForced(value);
						})
						.catch(err=>{
							if(err.message==='NAME_CONFLICT'){
								toast('åç§°å·²è¢«å ç”¨', 'error');
							} else {
								toast('é‡å‘½åå¤±è´¥', 'error');
							}
							element.textContent = oldName; // å›æ»šæ–‡æœ¬
						})
				} else {
					// ç¦»çº¿æ¨¡å¼ï¼šä»…æœ¬åœ°ä¿®æ”¹
					Store.byName.delete(oldName);
					room.name = value;
					Store.byName.set(value, room);
					card.dataset.room = value;
					renderRoomCardForced(value);
				}
			}
		} else if (field === 'remark') {
			room.remark = value || '';
			logInfo(`æ›´æ–°æˆ¿é—´å¤‡æ³¨ï¼š${roomName} -> ${value}`);
			
			// è®°å½•å¾…ä¿å­˜çš„ä¿®æ”¹ï¼Œç‚¹å‡»ä¿å­˜æŒ‰é’®åç»Ÿä¸€åŒæ­¥
			if (!Store.pendingChanges.has(roomName)) {
				Store.pendingChanges.set(roomName, {});
			}
			Store.pendingChanges.get(roomName).remark = value || '';
			
			// æ¢å¤å ä½æ–‡å­—
			if (!value) {
				element.textContent = 'ç‚¹å‡»æ·»åŠ å¤‡æ³¨...';
			}
		} else if (field === 'location') {
			room.location = value || '';
			logInfo(`æ›´æ–°æˆ¿é—´æ¥¼å±‚ï¼š${roomName} -> ${value}`);
			
			// è®°å½•å¾…ä¿å­˜çš„ä¿®æ”¹ï¼Œç‚¹å‡»ä¿å­˜æŒ‰é’®åç»Ÿä¸€åŒæ­¥
			if (!Store.pendingChanges.has(roomName)) {
				Store.pendingChanges.set(roomName, {});
			}
			Store.pendingChanges.get(roomName).location = value || '';
			
			// æ¢å¤å ä½æ–‡å­—
			if (!value) {
				element.textContent = 'ç‚¹å‡»æ·»åŠ æ¥¼å±‚...';
			}
		}
	}
	
	// å·²ç§»é™¤çš„æŒ‰é’®ï¼ˆä¸»é¢˜ / é‡ç½®è¿‡æ»¤ / ç»Ÿè®¡ï¼‰ä¸å†ç¡¬ç»‘å®šï¼Œé¿å…å› ä¸å­˜åœ¨å¯¼è‡´è„šæœ¬åœæ­¢
	// å¦‚æœä»éœ€é‡ç½®è¿‡æ»¤ï¼Œå¯åœ¨å…¶å®ƒå…¥å£è°ƒç”¨è¯¥å‡½æ•°
	function resetFilters(){ Store.filters.floor='ALL'; Store.filters.type='ALL'; renderRooms(); }
	// å·²ç§»é™¤ä¾§æ å¿«é€Ÿå¯¼å…¥/å¯¼å‡ºåŒºå—ï¼Œä»¥ä¸‹é€»è¾‘ç®€åŒ–ï¼šæä¾›ä¸€ä¸ªéšè— input å¤ç”¨
	let hiddenInput=document.getElementById('hiddenFileImport');
	if(!hiddenInput){ hiddenInput=document.createElement('input'); hiddenInput.type='file'; hiddenInput.id='hiddenFileImport'; hiddenInput.accept='.json,.csv'; hiddenInput.style.display='none'; document.body.appendChild(hiddenInput); }
	hiddenInput.addEventListener('change', e=>{ 
		const f=e.target.files[0]; if(!f) return; const name=f.name.toLowerCase(); const reader=new FileReader(); 
		reader.onload = async () => {
			try{
				const text=reader.result;
				if(name.endsWith('.csv')){
					const {header, rows}=parseCSV(text);
					if(!header.length){ toast('ç©º CSV'); return; }
					const type=detectCSVType(header);
					
					if(type==='rooms') {
						toast('æ­£åœ¨å¯¼å…¥ç´æˆ¿æ•°æ®...', 'info');
						await importCsvRooms(header, rows);
					} else if(type==='students') {
						toast('æ­£åœ¨å¯¼å…¥å­¦ç”Ÿæ•°æ®...', 'info');
						await importCsvStudents(header, rows);
					} else {
						toast('æ— æ³•è¯†åˆ«çš„ CSV è¡¨å¤´');
					}
				} else { 
					await importJson(JSON.parse(text)); 
				}
			}catch(err){ 
				toast('æ–‡ä»¶è§£æå¤±è´¥'); 
				logErr('è§£æå¤±è´¥', err.message); 
			}
		}; 
		reader.readAsText(f,'utf-8'); 
		e.target.value=''; 
	});

	window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeStudentModal(); }});

	/*************************************************
	 * æ¸²æŸ“ & è¿‡æ»¤
	 *************************************************/
	function rebuildIndexes(){
		Store.byName.clear(); Store.floorSet.clear();
		Store.rooms.forEach(r=>{ Store.byName.set(r.name,r); const floor=deriveFloor(r.location); if(floor) Store.floorSet.add(floor); });
	}
	function rebuildStudentIndex(){ Store.studentIndex.clear(); Store.students.forEach(s=>Store.studentIndex.set(s.name,s)); }
	function deriveFloor(location){ if(!location) return 'æœªçŸ¥'; const m=location.match(/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹0-9]+/); if(!m) return location; const map={ä¸€:1,äºŒ:2,ä¸‰:3,å››:4,äº”:5,å…­:6,ä¸ƒ:7,å…«:8,ä¹:9}; const raw=m[0]; return String(map[raw]||raw); }
	function ensureFilters(){
		const floorWrap=document.getElementById('floorFilters');
		const typeWrap=document.getElementById('typeFilters');
		
		// è·å–å½“å‰è¿‡æ»¤æ¡ä»¶ä¸‹æœ‰æˆ¿é—´çš„æ¥¼å±‚
		const currentTypeFilter = Store.filters.type;
		const availableRooms = Store.rooms.filter(r => {
			// åº”ç”¨ç±»å‹è¿‡æ»¤å™¨ï¼Œæ£€æŸ¥å“ªäº›æˆ¿é—´åœ¨å½“å‰ç±»å‹è¿‡æ»¤ä¸‹å¯è§
			if (currentTypeFilter === 'ALL') return true;
			const isGrand = /ä¸‰è§’/.test(r.pianoType);
			if (currentTypeFilter === 'GRAND') return isGrand;
			if (currentTypeFilter === 'UPRIGHT') return !isGrand && !/æ— |ç”µå­/i.test(r.pianoType);
			if (currentTypeFilter === 'NONE') return !isGrand && !/ç«‹|upright|ä¸‰è§’/.test(r.pianoType);
			return true;
		});
		
		// æ„å»ºå½“å‰å¯è§æˆ¿é—´çš„æ¥¼å±‚é›†åˆ
		const activeFloorSet = new Set();
		availableRooms.forEach(r => {
			const floor = deriveFloor(r.location);
			if (floor) activeFloorSet.add(floor);
		});
		
		const floors=['ALL',...Array.from(activeFloorSet).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN',{numeric:true}))];
		logInfo(`æ¥¼å±‚è¿‡æ»¤å™¨æ›´æ–°: æ˜¾ç¤º ${floors.length-1} ä¸ªæœ‰æˆ¿é—´çš„æ¥¼å±‚`);
		
		// å¦‚æœå½“å‰é€‰ä¸­çš„æ¥¼å±‚åœ¨æ–°çš„æ¥¼å±‚åˆ—è¡¨ä¸­ä¸å­˜åœ¨ï¼Œé‡ç½®ä¸ºALL
		if (Store.filters.floor !== 'ALL' && !activeFloorSet.has(Store.filters.floor)) {
			logInfo(`å½“å‰æ¥¼å±‚ ${Store.filters.floor} æ— æˆ¿é—´ï¼Œé‡ç½®ä¸ºå…¨éƒ¨`);
			Store.filters.floor = 'ALL';
		}
		let floorHTML = floors.map(f=>`<button data-floor="${f}" data-active="${Store.filters.floor===f?1:0}">${f==='ALL'?'å…¨éƒ¨æ¥¼å±‚':f+'æ¥¼'}</button>`).join('');
		
		// ç¼–è¾‘æ¨¡å¼ä¸‹æ·»åŠ æ–°å¢æˆ¿é—´æŒ‰é’®
		if (Store.editMode) {
			floorHTML += `<button id="btnAddRoom" class="add-room-btn" title="æ–°å¢ç´æˆ¿">ğŸ¹ æ–°å¢ç´æˆ¿</button>`;
		}
		
		floorWrap.innerHTML = floorHTML;
		typeWrap.innerHTML = ['ALL','GRAND','UPRIGHT','NONE'].map(t=>`<button data-type="${t}" data-active="${Store.filters.type===t?1:0}">${labelType(t)}</button>`).join('');
		
		floorWrap.querySelectorAll('button').forEach(b=>{
			if(b.dataset.floor) {
				b.onclick=()=>{Store.filters.floor=b.dataset.floor; renderRooms();};
			}
		});
		typeWrap.querySelectorAll('button').forEach(b=>b.onclick=()=>{Store.filters.type=b.dataset.type; renderRooms();});
		
		// ç»‘å®šæ–°å¢æˆ¿é—´æŒ‰é’®
		if (Store.editMode) {
			bind('btnAddRoom', showAddRoomModal);
		}
	}
	function labelType(t){ if(t==='ALL') return 'å…¨éƒ¨ç±»å‹'; if(t==='GRAND') return 'ä¸‰è§’'; if(t==='UPRIGHT') return 'ç«‹å¼'; return 'å…¶å®ƒ'; }
	function roomFilter(r){
		const floor=deriveFloor(r.location);
		if(Store.filters.floor!=='ALL' && floor!==Store.filters.floor) return false;
		const isGrand = /ä¸‰è§’/.test(r.pianoType);
		if(Store.filters.type==='GRAND' && !isGrand) return false;
		if(Store.filters.type==='UPRIGHT' && (isGrand || /æ— |ç”µå­/i.test(r.pianoType))) return false;
		if(Store.filters.type==='NONE' && (isGrand || /ç«‹|upright|ä¸‰è§’/.test(r.pianoType))) return false;
		return true;
	}
	function renderRooms(){
		ensureFilters();
		const grid=document.getElementById('roomGrid');
		// è‡ªå®šä¹‰æ’åºï¼šå…ˆæŒ‰ç´æˆ¿ç±»å‹(ä¸‰è§’ > ç«‹å¼ > å…¶å®ƒ)ï¼Œå†æŒ‰åç§°â€œå­—æ¯ä¼˜å…ˆã€æ•°å­—å…¶æ¬¡â€
		const typeRank = r => {
			if(/ä¸‰è§’/.test(r.pianoType)) return 0; // GRAND
			if(/ç«‹å¼|upright/i.test(r.pianoType)) return 1; // UPRIGHT
			return 2; // OTHER
		};
		// è§£æåç§°ï¼šæå–å¼€å¤´çš„å­—æ¯å‰ç¼€ä¸å…¶åçš„æ•°å­—ï¼Œä¾‹å¦‚ A12 -> {alpha:'A', num:12}
		const parseAlphaNum = (name) => {
			const s = String(name||'').trim();
			// æ¨¡å¼1ï¼šå­—æ¯ + å¯é€‰åˆ†éš”ç¬¦ + æ•°å­—
			let m = s.match(/^\s*([A-Za-z]+)\s*[-_ ]*\s*(\d+)/);
			if(m) return { alpha: m[1].toUpperCase(), num: parseInt(m[2],10), hasAlpha: true, hasNum: true };
			// æ¨¡å¼2ï¼šä»…å­—æ¯å‰ç¼€
			m = s.match(/^\s*([A-Za-z]+)/);
			if(m) return { alpha: m[1].toUpperCase(), num: null, hasAlpha: true, hasNum: false };
			return { alpha: '', num: null, hasAlpha: false, hasNum: false };
		};
		const list=Store.rooms
			.filter(roomFilter)
			.slice() // é˜²æ­¢åŸæ•°ç»„è¢«æ„å¤–æ’åº
			.sort((a,b)=>{
				const ta=typeRank(a), tb=typeRank(b);
				if(ta!==tb) return ta-tb;
				// åŒç±»å‹ï¼šå…ˆæ¯”è¾ƒå­—æ¯å‰ç¼€ï¼Œå†æ¯”è¾ƒæ•°å­—ï¼›éƒ½æ— è§„åˆ™æ—¶å›é€€è‡ªç„¶æ¯”è¾ƒ
				const pa = parseAlphaNum(a.name);
				const pb = parseAlphaNum(b.name);
				if(pa.alpha !== pb.alpha){
					// å­—æ¯å‰ç¼€ä¸åŒï¼šæŒ‰å­—æ¯åºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
					return pa.alpha.localeCompare(pb.alpha, 'en', { sensitivity: 'base' });
				}
				// å­—æ¯å‰ç¼€ç›¸åŒï¼šè‹¥éƒ½æœ‰æ•°å­—åˆ™æ¯”è¾ƒæ•°å­—
				if(pa.hasNum && pb.hasNum && pa.num !== pb.num) return pa.num - pb.num;
				// ä»…ä¸€æ–¹æœ‰æ•°å­—ï¼šæ— æ•°å­—çš„åœ¨å‰
				if(pa.hasNum !== pb.hasNum) return pa.hasNum ? 1 : -1;
				// å›é€€ï¼šä¸­æ–‡/å…¶å®ƒæƒ…å†µä½¿ç”¨è‡ªç„¶æ¯”è¾ƒï¼ˆå«æ•°å­—è¯†åˆ«ï¼‰
				return a.name.localeCompare(b.name,'zh-Hans-CN',{numeric:true});
			});
		logInfo(`å·²æŒ‰ç±»å‹ä¸å­—æ¯+æ•°å­—æ’åº: total ${list.length}`);
		// æ„å»ºå¸¦åˆ†éš”çº¿çš„HTML
		let htmlParts=[];
		let lastType=-1;
		const typeLabelMap={0:'ä¸‰è§’é’¢ç´',1:'ç«‹å¼é’¢ç´',2:'å…¶ä»–ç±»å‹'};
		const typeClassMap={0:'grand',1:'upright',2:'other'};
		for(const r of list){
			const t=typeRank(r);
			if(t!==lastType){
				if(lastType!==-1) htmlParts.push(''); // åˆ†ç»„è‡ªç„¶æ¢è¡Œ
				// å¦‚æœè¿‡æ»¤ååªæœ‰ä¸€ç§ç±»å‹åˆ™ä¸æ˜¾ç¤ºåˆ†éš”çº¿ï¼šå»¶ååˆ¤æ–­
				htmlParts.push(`<div class="room-type-separator ${typeClassMap[t]}" data-type-sep="${t}"><div class="line"></div><div class="label">${typeLabelMap[t]}</div><div class="line"></div></div>`);
				lastType=t;
			}
			htmlParts.push(roomCardHTML(r));
		}
		// å¦‚æœæœ€ç»ˆåªæœ‰ä¸€ä¸ªåˆ†éš”çº¿ä¸”å…¶ååªæœ‰æˆ¿é—´ï¼Œä¸”æ²¡æœ‰å‡ºç°ç¬¬äºŒç§ç±»å‹ï¼Œåˆ™ç§»é™¤è¯¥åˆ†éš”çº¿ï¼ˆå•ä¸€ç±»å‹ä¸éœ€è¦ï¼‰
		const sepCount=htmlParts.filter(h=>/room-type-separator/.test(h)).length;
		if(sepCount===1){
			htmlParts=htmlParts.filter(h=>!/room-type-separator/.test(h));
		}
		grid.innerHTML=htmlParts.join('');
		
		// æ·»åŠ å†…è”ç¼–è¾‘äº‹ä»¶ç›‘å¬
		if (Store.editMode) {
			bindInlineEditEvents();
		}
		
		// ç¡®ä¿å ç”¨ç»Ÿè®¡æ•°æ®åŒæ­¥æ›´æ–°
		updateUsageStats();
	}
	// ğŸš€ ä¼˜åŒ–åçš„æˆ¿é—´å¡ç‰‡æ¸²æŸ“ - ä½¿ç”¨æ‰¹é‡æ¸²æŸ“é˜Ÿåˆ—
	function renderRoomCard(name, priority = 'normal'){ 
		if (!name) return;
		
		// æ·»åŠ åˆ°æ‰¹é‡æ¸²æŸ“é˜Ÿåˆ—
		renderQueue.enqueue(name, priority);
		
		// æ—¥å¿—è®°å½•
		logInfo(`æˆ¿é—´ ${name} å·²åŠ å…¥æ¸²æŸ“é˜Ÿåˆ— (ä¼˜å…ˆçº§: ${priority})`);
	}

	// ğŸ’¡ å¼ºåˆ¶æ¸²æŸ“æˆ¿é—´å¡ç‰‡ï¼Œè·³è¿‡é˜²é‡å¤æ£€æŸ¥ï¼ˆç”¨äºrealtimeå…ƒæ•°æ®æ›´æ–°ï¼‰
	function renderRoomCardForced(name) {
		// ğŸš€ ä½¿ç”¨é«˜ä¼˜å…ˆçº§æ‰¹é‡æ¸²æŸ“
		renderQueue.enqueue(name, 'high');
		logInfo(`æˆ¿é—´ ${name} å·²åŠ å…¥å¼ºåˆ¶æ¸²æŸ“é˜Ÿåˆ—`);
	}

	// å…¼å®¹æ€§ï¼šä¿ç•™åŸå§‹å¼ºåˆ¶æ¸²æŸ“é€»è¾‘ï¼ˆå·²åºŸå¼ƒï¼Œä½†ä¿ç•™ä»¥é˜²ä¸‡ä¸€ï¼‰
	function _legacyRenderRoomCardForced(name) {
		const r = Store.byName.get(name);
		const grid = document.getElementById('roomGrid');
		const el = grid.querySelector(`[data-room='${CSS.escape(name)}']`);
		
		if (!r) {
			// æˆ¿é—´æ•°æ®ä¸å­˜åœ¨ï¼Œç§»é™¤DOMå…ƒç´ 
			if (el) {
				logInfo(`ç§»é™¤å·²åˆ é™¤æˆ¿é—´çš„å¡ç‰‡: ${name}`);
				el.remove();
			}
			return;
		}
		
		if (!roomFilter(r)) {
			// æˆ¿é—´è¢«è¿‡æ»¤ï¼Œç§»é™¤DOMå…ƒç´ 
			if (el) {
				logInfo(`ç§»é™¤è¢«è¿‡æ»¤æˆ¿é—´çš„å¡ç‰‡: ${name}`);
				el.remove();
			}
			return;
		}
		
		// å¼ºåˆ¶é‡æ–°æ¸²æŸ“ï¼Œä¸è¿›è¡ŒHTMLå†…å®¹æ¯”è¾ƒ
		logInfo(`å¼ºåˆ¶é‡æ–°æ¸²æŸ“æˆ¿é—´å¡ç‰‡: ${name} (å…ƒæ•°æ®æ›´æ–°)`);
		
		const newHTML = roomCardHTML(r);
		if (el) {
			el.outerHTML = newHTML;
		} else {
			// DOMå…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å…ƒç´ å¹¶æ’å…¥åˆ°åˆé€‚ä½ç½®
			logInfo(`DOMå…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æˆ¿é—´å¡ç‰‡: ${name}`);
			const tempDiv = document.createElement('div');
			tempDiv.innerHTML = newHTML;
			const newEl = tempDiv.firstElementChild;
			
			// æ‰¾åˆ°åˆé€‚çš„æ’å…¥ä½ç½®ï¼ˆæŒ‰æˆ¿é—´åç§°æ’åºï¼‰
			const allCards = Array.from(grid.querySelectorAll('.room-card'));
			let insertBefore = null;
			for (const card of allCards) {
				const cardName = card.dataset.room;
				if (cardName && cardName.localeCompare(name, 'zh-Hans-CN', {numeric: true}) > 0) {
					insertBefore = card;
					break;
				}
			}
			
			if (insertBefore) {
				grid.insertBefore(newEl, insertBefore);
			} else {
				grid.appendChild(newEl);
			}
		}
		
		// å¼ºåˆ¶é‡æ–°åº”ç”¨çŠ¶æ€ + å¹‚ç­‰æ ¡éªŒ
		setTimeout(() => {
			const newEl = grid.querySelector(`[data-room='${CSS.escape(name)}']`);
			if (newEl && r) {
				const st = statusInfo(r);
				newEl.dataset.status = st.state;
				const chip = newEl.querySelector('.chip');
				if (chip) {
					chip.textContent = st.chip;
					chip.className = `chip ${st.class}`;
				}
				// å¹‚ç­‰æ ¡éªŒï¼šoccupant ä¸ºç©ºæ—¶æ¸…ç†æ®‹ç•™
				if(!r.occupant_student_name){
					const occLine = newEl.querySelector('.occupant-line');
					if(occLine) occLine.remove();
					const actions = newEl.querySelector('.actions');
					if(actions){
						const strayClear = actions.querySelector('[data-act="clear"]');
						if(strayClear){
							actions.innerHTML = '';
							logInfo(`[RECONCILE] æ¸…ç†æ®‹ç•™æ“ä½œæŒ‰é’® ${name}`);
						}
					}
					newEl.classList.remove('pending-operation');
				}
			}
		}, 10);
	}

	// === å®Œæ•´é‡æ¸²æŸ“è¾…åŠ©å‡½æ•° ===
	function fullReRenderRoom(room){
		if (!room || !room.name) return;
		
		// ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨é«˜ä¼˜å…ˆçº§æ¸²æŸ“ï¼Œä½†ä¸åˆ é™¤DOMï¼Œè€Œæ˜¯åŸåœ°æ›¿æ¢
		// è¿™æ ·å¯ä»¥é¿å…åˆ é™¤+æ’å…¥å¯¼è‡´çš„ä½ç½®è·³åŠ¨
		renderRoomCard(room.name, 'high');
		
		// ğŸ”„ å®Œæ•´é‡æ¸²æŸ“åç«‹å³è§¦å‘è®¡æ—¶å™¨æ›´æ–°ï¼Œç¡®ä¿å…¶ä»–è®¾å¤‡çœ‹åˆ°æ­£ç¡®çŠ¶æ€
		if (window.updateAllRoomTimers && typeof window.updateAllRoomTimers === 'function') {
			setTimeout(() => {
				window.updateAllRoomTimers();
			}, 100);
		}
	}

	// ğŸ—ï¸ ç»Ÿä¸€æˆ¿é—´çŠ¶æ€è®¡ç®—å™¨ - é›†ä¸­å¤„ç†æ‰€æœ‰çŠ¶æ€é€»è¾‘
	class RoomStateCalculator {
		constructor() {
			this.cache = new Map(); // çŠ¶æ€ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
			this.cacheTimeout = 1000; // ç¼“å­˜1ç§’
		}

		/**
		 * ç»Ÿä¸€è®¡ç®—æˆ¿é—´çŠ¶æ€
		 * @param {Object} room - æˆ¿é—´å¯¹è±¡
		 * @param {Object} options - è®¡ç®—é€‰é¡¹
		 * @returns {Object} çŠ¶æ€ä¿¡æ¯ {state, chip, class, remainingPrepMs?, totalPrepMs?}
		 */
		computeStatus(room, options = {}) {
			if (!room) return { state: 'empty', chip: 'ç©ºé—²', class: 'good' };

			// æ£€æŸ¥ç¼“å­˜
			const cacheKey = `${room.name}_${room.version || 0}_${room.occupant_student_name || 'null'}_${room.registerTime || 0}`;
			const cached = this.cache.get(cacheKey);
			if (cached && !options.forceRefresh && (Date.now() - cached.timestamp < this.cacheTimeout)) {
				return cached.result;
			}

			const result = this._calculateStatus(room, options);
			
			// ç¼“å­˜ç»“æœ
			this.cache.set(cacheKey, {
				result,
				timestamp: Date.now()
			});

			// æ¸…ç†è¿‡æœŸç¼“å­˜
			this._cleanupCache();
			
			return result;
		}

		_calculateStatus(room, options) {
			const r = room;
			
			// ç©ºæˆ¿é—´
			if (!r.occupant_student_name) {
				return { state: 'empty', chip: 'ç©ºé—²', class: 'good' };
			}

			// æ²¡æœ‰æ³¨å†Œæ—¶é—´çš„å ç”¨æˆ¿é—´ - è§†ä¸ºåˆšç™»è®°
			if (!r.registerTime) {
				return {
					state: 'preparing',
					chip: 'å‡†å¤‡ä¸­ 60s',
					class: 'preparing',
					remainingPrepMs: 60000,
					totalPrepMs: 60000
				};
			}

			const now = options.currentTime || Date.now();
			const totalPrepMs = options.prepareDuration || 60000; // é»˜è®¤60ç§’å‡†å¤‡æœŸ
			
			// ğŸ”¥ æ™ºèƒ½æ—¶é—´é€‰æ‹©ï¼šä¼˜å…ˆä½¿ç”¨ä¹è§‚æ›´æ–°çš„ç²¾ç¡®æ—¶é—´
			let effectiveStartTime = r.registerTime;
			if (r.__tempRegister && r.__optimisticAssignTime) {
				effectiveStartTime = r.__optimisticAssignTime;
			}
			
			const prepEnd = effectiveStartTime + totalPrepMs;

			// å‡†å¤‡æœŸ
			if (now < prepEnd) {
				const remaining = prepEnd - now;
				const secs = Math.ceil(remaining / 1000);
				return {
					state: 'preparing',
					chip: `å‡†å¤‡ä¸­ ${secs}s`,
					class: 'preparing',
					remainingPrepMs: remaining,
					totalPrepMs
				};
			}

			// æ­£å¸¸ä½¿ç”¨æœŸ
			const used = Math.floor((now - prepEnd) / 1000);
			const limit = (Store.settings?.basePracticeDuration || 120) * 60; // ç§’
			
			if (used <= limit) {
				return {
					state: 'occupied',
					chip: formatHMS(used),
					class: 'accent',
					usedSeconds: used,
					limitSeconds: limit
				};
			}

			// è¶…æ—¶
			const overtime = used - limit;
			return {
				state: 'overtime',
				chip: 'è¶…æ—¶ ' + formatDuration(overtime),
				class: 'danger',
				overtimeSeconds: overtime
			};
		}

		_cleanupCache() {
			const now = Date.now();
			for (const [key, value] of this.cache.entries()) {
				if (now - value.timestamp > this.cacheTimeout * 2) {
					this.cache.delete(key);
				}
			}
		}

		// æ‰¹é‡è®¡ç®—å¤šä¸ªæˆ¿é—´çŠ¶æ€
		computeMultipleStatus(rooms, options = {}) {
			const currentTime = Date.now(); // ä½¿ç”¨ç»Ÿä¸€æ—¶é—´æˆ³
			return rooms.map(room => ({
				name: room.name,
				status: this.computeStatus(room, { ...options, currentTime })
			}));
		}

		// æ¸…é™¤ç‰¹å®šæˆ¿é—´çš„ç¼“å­˜
		invalidateCache(roomName) {
			for (const key of this.cache.keys()) {
				if (key.startsWith(`${roomName}_`)) {
					this.cache.delete(key);
				}
			}
		}

		// æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
		clearCache() {
			this.cache.clear();
		}
	}

	// å…¨å±€çŠ¶æ€è®¡ç®—å™¨å®ä¾‹
	const roomStateCalculator = new RoomStateCalculator();

	// ğŸš€ æ‰¹é‡æ¸²æŸ“é˜Ÿåˆ—ç®¡ç†å™¨ - å‡å°‘é‡å¤DOMæ“ä½œ
	class RenderQueue {
		constructor() {
			this.queue = new Set(); // å¾…æ¸²æŸ“çš„æˆ¿é—´åç§°
			this.isScheduled = false; // æ˜¯å¦å·²è°ƒåº¦æ¸²æŸ“
			this.batchTimeout = 16; // æ‰¹é‡å»¶è¿Ÿï¼ˆçº¦1å¸§ï¼‰
		}

		// æ·»åŠ æˆ¿é—´åˆ°æ¸²æŸ“é˜Ÿåˆ—
		enqueue(roomName, priority = 'normal') {
			if (!roomName) return;
			
			this.queue.add(roomName);
			
			// ğŸ”§ é«˜ä¼˜å…ˆçº§ç«‹å³æ¸²æŸ“ï¼Œå¹¶ä¼ é€’ä¼˜å…ˆçº§å‚æ•°
			if (priority === 'high') {
				this.flush('high');
				return;
			}
			
			// æ‰¹é‡æ¸²æŸ“è°ƒåº¦
			if (!this.isScheduled) {
				this.isScheduled = true;
				requestAnimationFrame(() => {
					setTimeout(() => this.flush('normal'), 0);
				});
			}
		}

		// æ‰§è¡Œæ‰¹é‡æ¸²æŸ“
		flush(priority = 'normal') {
			if (this.queue.size === 0) {
				this.isScheduled = false;
				return;
			}

			const startTime = performance.now();
			const roomsToRender = Array.from(this.queue);
			this.queue.clear();
			this.isScheduled = false;

			logInfo(`ğŸš€ æ‰¹é‡æ¸²æŸ“ ${roomsToRender.length} ä¸ªæˆ¿é—´: ${roomsToRender.join(', ')}`);

			// æ‰¹é‡çŠ¶æ€è®¡ç®—
			const statusMap = new Map();
			roomsToRender.forEach(roomName => {
				const room = Store.byName.get(roomName);
				if (room) {
					statusMap.set(roomName, roomStateCalculator.computeStatus(room));
				}
			});

			// æ‰¹é‡DOMæ›´æ–°
			const grid = document.getElementById('roomGrid');
			if (!grid) return;

			let renderedCount = 0;
			roomsToRender.forEach(roomName => {
				const room = Store.byName.get(roomName);
				const status = statusMap.get(roomName);
				
				if (room && status) {
					// ğŸ”§ ä¼ é€’ä¼˜å…ˆçº§å‚æ•°ï¼Œé«˜ä¼˜å…ˆçº§å¼ºåˆ¶é‡æ¸²æŸ“
					this._renderSingleRoom(grid, room, status, { forceUpdate: priority === 'high' });
					renderedCount++;
				}
			});

			const duration = performance.now() - startTime;
			logInfo(`âœ… æ‰¹é‡æ¸²æŸ“å®Œæˆ: ${renderedCount}/${roomsToRender.length} æˆ¿é—´ï¼Œç”¨æ—¶ ${duration.toFixed(2)}ms`);

			// è§¦å‘ç»Ÿè®¡æ›´æ–°
			if (renderedCount > 0) {
				updateUsageStats();
			}
		}

		_renderSingleRoom(grid, room, status, options = {}) {
			const existingEl = grid.querySelector(`[data-room='${CSS.escape(room.name)}']`);
			
			if (!room || !roomFilter(room)) {
				// æˆ¿é—´ä¸å­˜åœ¨æˆ–è¢«è¿‡æ»¤ï¼Œç§»é™¤DOM
				if (existingEl) {
					existingEl.remove();
				}
				return;
			}

			// ç”Ÿæˆæ–°HTML
			const newHTML = this._generateRoomHTML(room, status);
			
			if (existingEl) {
				// ğŸ”§ é«˜ä¼˜å…ˆçº§æ¸²æŸ“æ—¶å¼ºåˆ¶æ›´æ–°ï¼Œè·³è¿‡HTMLæ¯”è¾ƒ
				if (!options.forceUpdate) {
					// é˜²é‡å¤æ¸²æŸ“æ£€æŸ¥
					if (existingEl.outerHTML === newHTML) {
						return; // è·³è¿‡é‡å¤æ¸²æŸ“
					}
				}
				// ğŸ”§ ä¿®å¤ï¼šåŸåœ°æ›´æ–°ï¼Œä¸æ”¹å˜DOMä½ç½®ï¼Œé¿å…æ’åºé—ªçƒ
				const tempDiv = document.createElement('div');
				tempDiv.innerHTML = newHTML;
				const newEl = tempDiv.firstElementChild;
				existingEl.replaceWith(newEl);
			} else {
				// ğŸ”§ ä¿®å¤ï¼šæ–°æˆ¿é—´ç›´æ¥æ’å…¥åˆ°æ­£ç¡®ä½ç½®ï¼Œè€Œä¸æ˜¯é‡å»ºæ•´ä¸ªç½‘æ ¼
				// æ‰¾åˆ°åº”è¯¥æ’å…¥çš„ä½ç½®ï¼ˆæŒ‰æ’åºè§„åˆ™ï¼‰
				this._insertRoomAtCorrectPosition(grid, room, newHTML);
			}
		}
		
		// ğŸ”§ æ–°å¢ï¼šå°†æˆ¿é—´å¡ç‰‡æ’å…¥åˆ°æ­£ç¡®çš„æ’åºä½ç½®
		_insertRoomAtCorrectPosition(grid, room, html) {
			// è·å–æ’åºè§„åˆ™ï¼ˆä¸renderRoomsä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
			const typeRank = r => {
				if(/ä¸‰è§’/.test(r.pianoType)) return 0;
				if(/ç«‹å¼|upright/i.test(r.pianoType)) return 1;
				return 2;
			};
			const parseAlphaNum = (name) => {
				const s = String(name||'').trim();
				let m = s.match(/^\s*([A-Za-z]+)\s*[-_ ]*\s*(\d+)/);
				if(m) return { alpha: m[1].toUpperCase(), num: parseInt(m[2],10), hasAlpha: true, hasNum: true };
				m = s.match(/^\s*([A-Za-z]+)/);
				if(m) return { alpha: m[1].toUpperCase(), num: null, hasAlpha: true, hasNum: false };
				return { alpha: '', num: null, hasAlpha: false, hasNum: false };
			};
			
			const compareRooms = (a, b) => {
				const ta = typeRank(a), tb = typeRank(b);
				if(ta !== tb) return ta - tb;
				const pa = parseAlphaNum(a.name);
				const pb = parseAlphaNum(b.name);
				if(pa.alpha !== pb.alpha) return pa.alpha.localeCompare(pb.alpha, 'en', { sensitivity: 'base' });
				if(pa.hasNum && pb.hasNum && pa.num !== pb.num) return pa.num - pb.num;
				if(pa.hasNum !== pb.hasNum) return pa.hasNum ? 1 : -1;
				return a.name.localeCompare(b.name,'zh-Hans-CN',{numeric:true});
			};
			
			// æ‰¾åˆ°æ’å…¥ä½ç½®ï¼šéå†ç°æœ‰å¡ç‰‡ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªåº”è¯¥æ’åœ¨æ–°æˆ¿é—´åé¢çš„
			const allCards = Array.from(grid.querySelectorAll('.room-card')).filter(el => {
				// æ’é™¤åˆ†éš”ç¬¦
				return !el.classList.contains('room-type-separator');
			});
			
			let insertBefore = null;
			for (const card of allCards) {
				const cardRoomName = card.getAttribute('data-room');
				const cardRoom = Store.byName.get(cardRoomName);
				if (cardRoom && compareRooms(room, cardRoom) < 0) {
					insertBefore = card;
					break;
				}
			}
			
			const tempDiv = document.createElement('div');
			tempDiv.innerHTML = html;
			const newEl = tempDiv.firstElementChild;
			
			if (insertBefore) {
				insertBefore.before(newEl);
			} else {
				// æ’å…¥åˆ°æœ«å°¾
				grid.appendChild(newEl);
			}
			
			logInfo(`âœ… å·²æ’å…¥æˆ¿é—´ ${room.name} åˆ°æ­£ç¡®ä½ç½®`);
		}

		_generateRoomHTML(room, status) {
			const st = status;
			const isGrand = /ä¸‰è§’/.test(room.pianoType);
			const isUpright = /ç«‹å¼/.test(room.pianoType);
			const typeStr = isGrand ? 'grand' : (isUpright ? 'upright' : 'other');
			const editModeClass = Store.editMode ? 'edit-mode' : '';
			const deleteBtn = Store.editMode ? `<div class="delete-btn" data-room="${room.name}" title="åˆ é™¤ç´æˆ¿">âœ•</div>` : '';
			
			// ç±»å‹æ ‡ç­¾
			let typePill = '';
			if (!Store.editMode) {
				if (isGrand) {
					typePill = '<span class="pill pill-grand">ä¸‰è§’</span>';
				} else if (isUpright) {
					typePill = '<span class="pill pill-upright">ç«‹å¼</span>';
				} else {
					typePill = '<span class="pill pill-other">å…¶ä»–</span>';
				}
			}
			
			const roomNameContent = Store.editMode ? room.name : `${room.name} ${typePill}`;
			const remarkContent = Store.editMode ? 
				(room.remark ? escapeHtml(room.remark) : 'ç‚¹å‡»æ·»åŠ å¤‡æ³¨...') : 
				''; // éç¼–è¾‘æ¨¡å¼ä¸‹æ— å¤‡æ³¨æ—¶ä¸æ˜¾ç¤ºä»»ä½•å†…å®¹

			// æ”¯æŒå¤šäººæ˜¾ç¤º
			let occupantDisplay = '';
			if(room.occupant_student_name && !Store.editMode){
				const students = room.occupant_student_name.split(',').map(s => s.trim());
				if(students.length > 1){
					// å¤šäººæ¨¡å¼ï¼šæ˜¾ç¤ºäººæ•°å’Œæ‰€æœ‰åå­—
					const studentsList = students.map(s => escapeHtml(s)).join('ã€');
					occupantDisplay = `<div class="occupant-line"><span class="dot"></span><span title="${studentsList}">${students.length}äºº: ${studentsList}</span></div>`;
				} else {
					// å•äººæ¨¡å¼ï¼šä¿æŒåŸæ ·
					occupantDisplay = `<div class="occupant-line"><span class="dot"></span><span>${escapeHtml(room.occupant_student_name)}</span></div>`;
				}
			}
			
			return `<div class="room-card ${!room.occupant_student_name?'empty':''} ${editModeClass}" data-room="${room.name}" data-grand="${isGrand?1:0}" data-type="${typeStr}" data-status="${st.state}" tabindex="0" title="${room.name}\n${room.location||''}\n${room.pianoType}">
				${deleteBtn}
				<div class="room-name">${roomNameContent}</div>
				<div class="remark">${remarkContent}</div>
				${occupantDisplay}
				${!Store.editMode ? `<div class="status-row">
					${room.occupant_student_name ? `<span class="chip ${st.class}" ${st.state==='preparing'?`data-preparing-chip="1" data-room-prep="${room.name}"`:''}>${st.chip}</span>` : `<span class="chip chip-dim" data-empty="1">ç©ºé—²</span>`}
					<div class="actions">${room.occupant_student_name?`<button class="danger" data-act="clear" title="æ¸…ç©º">âœ•</button><button class="renew-btn" data-act="renew" title="ç»­æœŸ">âŸ³</button>`:``}</div>
				</div>` : ''}
			</div>`;
		}

		// æ¸…ç©ºé˜Ÿåˆ—
		clear() {
			this.queue.clear();
			this.isScheduled = false;
		}

		// è·å–é˜Ÿåˆ—çŠ¶æ€
		getStatus() {
			return {
				queueSize: this.queue.size,
				isScheduled: this.isScheduled,
				pending: Array.from(this.queue)
			};
		}
	}

	// å…¨å±€æ¸²æŸ“é˜Ÿåˆ—å®ä¾‹
	const renderQueue = new RenderQueue();

/* åŸå­åŒ–æ—§è½¬ç§»é€»è¾‘å·²ç§»é™¤ï¼Œæ”¹ç”¨æ–°å‰ç«¯å¢å¼º transferStudentã€‚
 * è‹¥éœ€å›æ»šï¼Œå¯ä»ç‰ˆæœ¬ç®¡ç†æ¢å¤è¯¥ç±»ã€‚ */

// æŒ‚æ¥æ–°å‡½æ•°å…¥å£ï¼ˆç¡®ä¿å¢å¼ºè„šæœ¬å·²æ³¨å…¥ï¼‰
window.invokeRoomTransfer = async function(fromRoom,toRoom,student){
	if(typeof transferStudent!=='function'){console.error('transferStudent æœªåŠ è½½');return;}
	return transferStudent(fromRoom,toRoom,student);
};

	// ğŸ›ï¸ å…¨å±€ä¼˜åŒ–é…ç½®
	window.__OPTIMIZATION_CONFIG = {
		// å¯ç”¨åŸå­åŒ–è½¬ç§»ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
		ATOMIC_TRANSFER_ENABLED: true,
		// å¯ç”¨æ‰¹é‡æ¸²æŸ“ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
		BATCH_RENDERING_ENABLED: true,
		// å¯ç”¨çŠ¶æ€ç¼“å­˜ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
		STATE_CACHE_ENABLED: true,
		// æ¸²æŸ“é˜Ÿåˆ—æ‰¹é‡å»¶è¿Ÿ
		RENDER_BATCH_DELAY: 16, // ms
		// çŠ¶æ€ç¼“å­˜æ—¶é—´
		STATE_CACHE_TIMEOUT: 1000, // ms
		// ğŸ”§ æ•°æ®åº“åŸå­åŒ–æ“ä½œï¼ˆå·²ç¦ç”¨ï¼Œä½¿ç”¨åºåˆ—æ“ä½œï¼‰
		// æ³¨æ„ï¼šç”±äºæ•°æ®åº“ä¸­æ²¡æœ‰ atomic_room_transfer å­˜å‚¨è¿‡ç¨‹ï¼Œ
		// åŸå­åŒ–è½¬ç§»ç®¡ç†å™¨ä¼šç›´æ¥ä½¿ç”¨åºåˆ—åŒ–æ“ä½œï¼Œé¿å…é”™è¯¯
		DATABASE_ATOMIC_ENABLED: false,
	};

	// åº”ç”¨é…ç½®
	window.__ATOMIC_TRANSFER_ENABLED = window.__OPTIMIZATION_CONFIG.ATOMIC_TRANSFER_ENABLED;

	// ğŸ› ï¸ ä¼˜åŒ–è°ƒè¯•å·¥å…·
	window.OptimizationDebug = {
		// æ£€æŸ¥æ¸²æŸ“é˜Ÿåˆ—çŠ¶æ€
		getRenderQueueStatus() {
			return renderQueue.getStatus();
		},

		// æ£€æŸ¥çŠ¶æ€ç¼“å­˜ç»Ÿè®¡
		getStateCacheStats() {
			return {
				size: roomStateCalculator.cache.size,
				entries: Array.from(roomStateCalculator.cache.keys()).slice(0, 10) // æ˜¾ç¤ºå‰10ä¸ª
			};
		},

		// æ£€æŸ¥æ´»è·ƒè½¬ç§»
		getActiveTransfers() {
			return []; // æ—§åŸå­è½¬ç§»ç®¡ç†å™¨å·²ç§»é™¤
		},

		// å¼ºåˆ¶åˆ·æ–°æ¸²æŸ“é˜Ÿåˆ—
		flushRenderQueue() {
			const beforeSize = renderQueue.queue.size;
			renderQueue.flush();
			console.log(`âœ… æ¸²æŸ“é˜Ÿåˆ—å·²åˆ·æ–°ï¼Œå¤„ç†äº† ${beforeSize} ä¸ªæˆ¿é—´`);
		},

		// æ¸…é™¤çŠ¶æ€ç¼“å­˜
		clearStateCache() {
			const beforeSize = roomStateCalculator.cache.size;
			roomStateCalculator.clearCache();
			console.log(`âœ… çŠ¶æ€ç¼“å­˜å·²æ¸…é™¤ï¼Œæ¸…é™¤äº† ${beforeSize} ä¸ªæ¡ç›®`);
		},

		// æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡çŠ¶æ€è®¡ç®—
		perfTestBatchStatus() {
			const rooms = Store.rooms.slice(0, 20);
			const start = performance.now();
			
			// å•ç‹¬è®¡ç®—
			for (let i = 0; i < 100; i++) {
				rooms.forEach(room => roomStateCalculator.computeStatus(room));
			}
			const singleTime = performance.now() - start;

			// æ‰¹é‡è®¡ç®—
			const batchStart = performance.now();
			for (let i = 0; i < 100; i++) {
				roomStateCalculator.computeMultipleStatus(rooms);
			}
			const batchTime = performance.now() - batchStart;

			console.log(`æ€§èƒ½æµ‹è¯•ç»“æœ (${rooms.length} æˆ¿é—´ Ã— 100æ¬¡):`);
			console.log(`å•ç‹¬è®¡ç®—: ${singleTime.toFixed(2)}ms`);
			console.log(`æ‰¹é‡è®¡ç®—: ${batchTime.toFixed(2)}ms`);
			console.log(`æ€§èƒ½æå‡: ${((singleTime - batchTime) / singleTime * 100).toFixed(1)}%`);
		},

		// æ¨¡æ‹Ÿæ‰¹é‡è½¬ç§»æµ‹è¯•
		async simulateBatchTransfer() {
			const occupiedRooms = Store.rooms.filter(r => r.occupant_student_name);
			const emptyRooms = Store.rooms.filter(r => !r.occupant_student_name);
			
			if (occupiedRooms.length === 0 || emptyRooms.length === 0) {
				console.log('âŒ éœ€è¦è‡³å°‘ä¸€ä¸ªå ç”¨æˆ¿é—´å’Œä¸€ä¸ªç©ºæˆ¿é—´è¿›è¡Œæµ‹è¯•');
				return;
			}

			const fromRoom = occupiedRooms[0];
			const toRoom = emptyRooms[0];
			
			console.log(`ğŸ§ª æ¨¡æ‹Ÿè½¬ç§»æµ‹è¯•: ${fromRoom.occupant_student_name} ${fromRoom.name} â†’ ${toRoom.name}`);
			console.log(`ğŸ“‹ ä½¿ç”¨åºåˆ—åŒ–æ•°æ®åº“æ“ä½œï¼ˆå·²è·³è¿‡åŸå­åŒ–å­˜å‚¨è¿‡ç¨‹æ£€æŸ¥ï¼‰`);
			
			const start = performance.now();
			let result;
			if (typeof window.transferStudent === 'function') {
				result = await window.transferStudent(fromRoom.name, toRoom.name, fromRoom.occupant_student_name);
			} else {
				console.warn('transferStudent æœªå®šä¹‰ï¼Œæ¨¡æ‹Ÿæµ‹è¯•è·³è¿‡');
				result = { ok:false, error:'transferStudent missing' };
			}
			const duration = performance.now() - start;
			
			console.log(`âœ… è½¬ç§»æµ‹è¯•å®Œæˆ (${duration.toFixed(2)}ms):`, result);
			console.log(`ğŸ”§ æ“ä½œæ¨¡å¼: ${result.atomic === false ? 'åºåˆ—åŒ–' : 'åŸå­åŒ–'}`);
		},

		// æ£€æŸ¥æ•°æ®åº“æ“ä½œé…ç½®
		getDatabaseConfig() {
			return {
				atomicTransferEnabled: window.__OPTIMIZATION_CONFIG.ATOMIC_TRANSFER_ENABLED,
				databaseAtomicEnabled: window.__OPTIMIZATION_CONFIG.DATABASE_ATOMIC_ENABLED,
				operationMode: window.__OPTIMIZATION_CONFIG.DATABASE_ATOMIC_ENABLED ? 'åŸå­åŒ–å­˜å‚¨è¿‡ç¨‹' : 'åºåˆ—åŒ–æ“ä½œ + CASç‰ˆæœ¬æ£€æŸ¥',
				note: 'å½“å‰é…ç½®è·³è¿‡åŸå­åŒ–å­˜å‚¨è¿‡ç¨‹æ£€æŸ¥ï¼Œç›´æ¥ä½¿ç”¨åºåˆ—åŒ–æ“ä½œé¿å… PGRST202 é”™è¯¯'
			};
		},

		// æŸ¥çœ‹æœ€è¿‘è½¬ç§»å†å²ï¼ˆé»˜è®¤æœ€è¿‘50æ¡ï¼‰
		getTransferHistory(limit = 50) {
			return [];// æ—§å†å²å·²å¼ƒç”¨
		}
	};

	// æš´éœ²åˆ°å…¨å±€ä¾›è°ƒè¯•
	window.roomStateCalculator = roomStateCalculator;
	window.renderQueue = renderQueue;
	// atomicTransferManager å·²ç§»é™¤ï¼Œä¸å†æš´éœ²

	// ğŸ—ï¸ å‘åå…¼å®¹çš„ statusInfo å‡½æ•°ï¼ˆä½¿ç”¨æ–°çš„ç»Ÿä¸€çŠ¶æ€è®¡ç®—å™¨ï¼‰
	function statusInfo(r){
		return roomStateCalculator.computeStatus(r);
	}

	// ğŸ“¦ åŸå§‹ statusInfo é€»è¾‘ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰
	function _legacyStatusInfo(r){
		if(!r.occupant_student_name) return {state:'empty',chip:'ç©ºé—²',class:'good'};
		if(!r.registerTime) {
			// æ–°ç­–ç•¥ï¼šæœ‰å ç”¨è€…ä½†ç¼ºå°‘ registerTimeï¼Œè§†ä½œåˆšç™»è®°è¿›å…¥å‡†å¤‡æœŸ
			// é¿å…å› ä¹è§‚æ›´æ–°ä¸Realtimeé—´éš™æ˜¾ç¤ºä¸ºâ€œå ç”¨â€é€ æˆé—ªçƒ
			return {state:'preparing',chip:'å‡†å¤‡ä¸­ 60s',class:'preparing',remainingPrepMs:60000,totalPrepMs:60000};
		}
		
		const now = Date.now();
		const totalPrepMs = 60000; // é¢„å¤‡æœŸ 60 ç§’
		
		// ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¯¹äºä¸´æ—¶ä¹è§‚æ›´æ–°ï¼Œä½¿ç”¨è®°å½•çš„ä¹è§‚æ—¶é—´è€Œéå¯èƒ½æœ‰åå·®çš„ registerTime
		let effectiveStartTime = r.registerTime;
		if (r.__tempRegister && r.__optimisticAssignTime) {
			// ä½¿ç”¨ä¹è§‚æ›´æ–°è®°å½•çš„ç²¾ç¡®æ—¶é—´ï¼Œç¡®ä¿å‡†å¤‡æœŸè®¡ç®—å‡†ç¡®
			effectiveStartTime = r.__optimisticAssignTime;
		}
		
		const prepEnd = effectiveStartTime + totalPrepMs;
		
		// è°ƒè¯•ä¿¡æ¯ï¼šè®°å½•æ—¶é—´è®¡ç®—è¯¦æƒ…
		const debugInfo = {
			roomName: r.name,
			student: r.occupant_student_name,
			registerTime: r.registerTime,
			registerTimeStr: new Date(r.registerTime).toLocaleString(),
			now: now,
			nowStr: new Date(now).toLocaleString(),
			prepEnd: prepEnd,
			timeDiff: now - r.registerTime,
			inPrep: now < prepEnd
		};
		
		// æ¯30ç§’è®°å½•ä¸€æ¬¡è¯¦ç»†ä¿¡æ¯ï¼Œé¿å…æ—¥å¿—è¿‡å¤š
		if (!window.__lastStatusDebugTime || now - window.__lastStatusDebugTime > 30000) {
			logInfo(`çŠ¶æ€è®¡ç®—è¯¦æƒ… - ${r.name}:`, debugInfo);
			window.__lastStatusDebugTime = now;
		}
		
		if(now<prepEnd){
			const remaining = prepEnd-now; // ms
			const secs = Math.ceil(remaining/1000);
			return {state:'preparing',chip:`å‡†å¤‡ä¸­ ${secs}s`,class:'preparing',remainingPrepMs:remaining,totalPrepMs};
		}
		const used=Math.floor((now-prepEnd)/1000);
		const limit = (Store.settings.basePracticeDuration||120)*60; // ç§’
		if(used<=limit) return {state:'occupied',chip:formatHMS(used),class:'accent'};
		return {state:'overtime',chip:'è¶…æ—¶ '+formatDuration(used-limit),class:'danger'};
	}
	function roomCardHTML(r){ 
		const st=statusInfo(r); 
		const isGrand=/ä¸‰è§’/.test(r.pianoType);
		const isUpright=/ç«‹å¼/.test(r.pianoType);
		const typeStr = isGrand ? 'grand' : (isUpright ? 'upright' : 'other');
		const editModeClass = Store.editMode ? 'edit-mode' : '';
		const deleteBtn = Store.editMode ? `<div class="delete-btn" data-room="${r.name}" title="åˆ é™¤ç´æˆ¿">âœ•</div>` : '';
		
		// ç¡®å®šç´æˆ¿ç±»å‹æ ‡ç­¾
		let typePill = '';
		if (!Store.editMode) {
			if (isGrand) {
				typePill = '<span class="pill pill-grand">ä¸‰è§’</span>';
			} else if (isUpright) {
				typePill = '<span class="pill pill-upright">ç«‹å¼</span>';
			} else {
				typePill = '<span class="pill pill-other">å…¶ä»–</span>';
			}
		}
		
	// å¤„ç†å¯ç¼–è¾‘åŒºåŸŸçš„æ˜¾ç¤ºå†…å®¹
	const roomNameContent = Store.editMode ? r.name : `${r.name} ${typePill}`;
	const remarkContent = Store.editMode ? 
		(r.remark ? escapeHtml(r.remark) : 'ç‚¹å‡»æ·»åŠ å¤‡æ³¨...') : 
		(r.remark ? escapeHtml(r.remark) : ''); // éç¼–è¾‘æ¨¡å¼ä¸‹æœ‰å¤‡æ³¨æ—¶æ˜¾ç¤ºå¤‡æ³¨å†…å®¹
	const locationContent = Store.editMode ?
		(r.location ? escapeHtml(r.location) : 'ç‚¹å‡»æ·»åŠ æ¥¼å±‚...') :
		(r.location ? escapeHtml(r.location) : ''); // éç¼–è¾‘æ¨¡å¼ä¸‹æœ‰æ¥¼å±‚æ—¶æ˜¾ç¤ºæ¥¼å±‚ä¿¡æ¯		// ç¼–è¾‘æ¨¡å¼ä¸‹çš„ç´æˆ¿ç±»å‹é€‰æ‹©å™¨
		let pianoTypeSelector = '';
		if (Store.editMode) {
			// æ˜ å°„é’¢ç´ç±»å‹åˆ°é€‰æ‹©å™¨é€‰é¡¹
			const currentType = r.pianoType || 'å…¶ä»–';
			let selectedType = 'å…¶ä»–'; // é»˜è®¤é€‰æ‹©
			if (/ä¸‰è§’/.test(currentType)) {
				selectedType = 'ä¸‰è§’';
			} else if (/ç«‹å¼/.test(currentType)) {
				selectedType = 'ç«‹å¼';
			}
			
			pianoTypeSelector = `<select class="piano-type-selector" data-room="${r.name}">
				<option value="ç«‹å¼" ${selectedType === 'ç«‹å¼' ? 'selected' : ''}>ç«‹å¼</option>
				<option value="ä¸‰è§’" ${selectedType === 'ä¸‰è§’' ? 'selected' : ''}>ä¸‰è§’</option>
				<option value="å…¶ä»–" ${selectedType === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
			</select>`;
		}
		
		return `<div class="room-card ${!r.occupant_student_name?'empty':''} ${editModeClass}" data-room="${r.name}" data-grand="${isGrand?1:0}" data-type="${typeStr}" data-status="${st.state}" tabindex="0" title="${r.name}\n${r.location||''}\n${r.pianoType}">
			${deleteBtn}
			<div class="sync-hint" aria-hidden="true"><span class="dot"></span><span>æäº¤ä¸­</span></div>
			${Store.editMode ? `<div class="edit-row">
				<div class="room-name compact" contenteditable="true" data-field="name">${roomNameContent}</div>
				${pianoTypeSelector}
			</div>` : `<div class="room-name" ${Store.editMode ? 'contenteditable="true" data-field="name"' : ''}>${roomNameContent}</div>`}
			${Store.editMode ? `<div class="location-field" contenteditable="true" data-field="location" style="font-size:11px;color:var(--text-dim);padding:4px 6px;border:1px dashed var(--outline);border-radius:4px;margin-top:4px;cursor:text;min-height:20px;">${locationContent}</div>` : ''}
			<div class="remark" ${Store.editMode ? 'contenteditable="true" data-field="remark"' : ''}>${remarkContent}</div>
			${r.occupant_student_name && !Store.editMode ?`<div class="occupant-line"><span class="dot"></span><span>${escapeHtml(r.occupant_student_name)}</span></div>`:''}
			${!Store.editMode ? `<div class="status-row">
				${r.occupant_student_name ? `<span class="chip ${st.class}" ${st.state==='preparing'?`data-preparing-chip="1" data-room-prep="${r.name}"`:''}>${st.chip}</span>` : `<span class="chip chip-dim" data-empty="1">ç©ºé—²</span>`}
				<div class="actions">${r.occupant_student_name?`<button class="danger" data-act="clear" title="æ¸…ç©º">âœ•</button><button class="renew-btn" data-act="renew" title="ç»­æœŸ">âŸ³</button>`:``}</div>
			</div>` : ''}
		</div>`; 
	}

	/*************************************************
	 * äº¤äº’é€»è¾‘
	 *************************************************/
	function bindRoomEvents(){
		// ğŸ• å¯åŠ¨æ™ºèƒ½å…¨å±€è®¡æ—¶å™¨ç³»ç»Ÿï¼ˆæœåŠ¡å™¨æ—¶é—´åŒæ­¥ + é¡µé¢å¯è§æ€§æ£€æµ‹ï¼‰
		if(!window.__globalTimerInterval){
			// å¯åŠ¨è®¡æ—¶å™¨
			const startTimer = () => {
				if (window.__globalTimerInterval) return;
				window.__globalTimerInterval = setInterval(()=>{
					updateAllRoomTimers();
				}, 1000);
				logInfo('â±ï¸ å…¨å±€è®¡æ—¶å™¨å·²å¯åŠ¨');
			};
			
			// æš‚åœè®¡æ—¶å™¨
			const pauseTimer = () => {
				if (window.__globalTimerInterval) {
					clearInterval(window.__globalTimerInterval);
					window.__globalTimerInterval = null;
					logInfo('â¸ï¸ å…¨å±€è®¡æ—¶å™¨å·²æš‚åœï¼ˆé¡µé¢ä¸å¯è§ï¼‰');
				}
			};
			
			// é¡µé¢å¯è§æ€§å˜åŒ–æ£€æµ‹
			document.addEventListener('visibilitychange', () => {
				if (document.hidden) {
					pauseTimer();
					// é¡µé¢éšè—å‰ä¿å­˜çŠ¶æ€
					timerPersistence.saveTimerStates();
				} else {
					// é¡µé¢æ¢å¤å¯è§æ—¶é‡æ–°åŒæ­¥æ—¶é—´å¹¶å¯åŠ¨è®¡æ—¶å™¨
					if (serverTimeSync.isInitialized) {
						serverTimeSync.manualSync();
					}
					startTimer();
					logInfo('ğŸ‘ï¸ é¡µé¢æ¢å¤å¯è§ï¼Œé‡æ–°å¯åŠ¨è®¡æ—¶å™¨');
				}
			});
			
			// åˆå§‹å¯åŠ¨
			startTimer();
			logInfo('â±ï¸ æ™ºèƒ½å…¨å±€è®¡æ—¶å™¨ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼ˆæ”¯æŒé¡µé¢å¯è§æ€§æ£€æµ‹ï¼‰');
		}
		// é˜²æŠ–æœºåˆ¶çš„ç»­æœŸå¤„ç†
		let lastRenewClick = {};
		
		document.getElementById('roomGrid').addEventListener('click', e=>{
			const card=e.target.closest('.room-card'); if(!card) return; const name=card.dataset.room; const room=Store.byName.get(name); if(!room) return;
			
			// ç¼–è¾‘æ¨¡å¼ä¸‹ç¦ç”¨ç´æˆ¿ç‚¹å‡»åŠŸèƒ½ï¼Œé™¤äº†ç‰¹å®šæŒ‰é’®
			if (Store.editMode) {
				// åˆ é™¤æŒ‰é’®å¤„ç†
				if(e.target.closest('.delete-btn')){
					if(confirm(`ç¡®å®šè¦åˆ é™¤ç´æˆ¿ "${name}" å—ï¼Ÿ`)){
						deleteRoom(name);
					}
					return;
				}
				
				// ç´æˆ¿ç±»å‹é€‰æ‹©å™¨å¤„ç†
				if(e.target.closest('.piano-type-selector')){
					// ç±»å‹é€‰æ‹©å™¨ç”±changeäº‹ä»¶å¤„ç†ï¼Œè¿™é‡Œä¸åšé¢å¤–å¤„ç†
					return;
				}
				
				// å…¶ä»–ç‚¹å‡»äº‹ä»¶åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹è¢«å¿½ç•¥
				return;
			}
			
			// éç¼–è¾‘æ¨¡å¼ä¸‹çš„æ­£å¸¸ç‚¹å‡»é€»è¾‘
			if(e.target.closest('button[data-act=clear]')){ clearRoomUnified(name); return; }
			if(e.target.closest('button[data-act=renew]')){ 
				const now = Date.now();
				// é˜²æŠ–ï¼šåŒä¸€æˆ¿é—´500mså†…åªèƒ½è§¦å‘ä¸€æ¬¡ç»­æœŸ
				if (lastRenewClick[name] && (now - lastRenewClick[name]) < 500) {
					logInfo(`æˆ¿é—´ ${name} ç»­æœŸæ“ä½œè¢«é˜²æŠ–é™åˆ¶`);
					return;
				}
				lastRenewClick[name] = now;
				
				// æ£€æŸ¥æ“ä½œé”
				const lockKey = `renew_${name}`;
				if (Store.operationLocks?.has(lockKey)) {
					toast(`æˆ¿é—´ ${name} æ­£åœ¨å¤„ç†ä¸­...`, 'warn');
					return;
				}
				
				renewRoom(name); 
				return; 
			}
			if(!room.occupant_student_name) openStudentModal(name);
		});
		// é˜²æŠ–æœºåˆ¶çš„åŒå‡»æ¸…ç©ºå¤„ç†
		let lastClearClick = {};
		document.getElementById('roomGrid').addEventListener('dblclick', e=>{
			// ç¼–è¾‘æ¨¡å¼ä¸‹ç¦ç”¨åŒå‡»æ¸…ç©º
			if (Store.editMode) return;
			
			const card=e.target.closest('.room-card'); 
			if(!card) return; 
			
			const roomName = card.dataset.room;
			const now = Date.now();
			
			// é˜²æŠ–ï¼šåŒä¸€æˆ¿é—´500mså†…åªèƒ½è§¦å‘ä¸€æ¬¡æ¸…ç©º
			if (lastClearClick[roomName] && (now - lastClearClick[roomName]) < 500) {
				logInfo(`æˆ¿é—´ ${roomName} æ¸…ç©ºæ“ä½œè¢«é˜²æŠ–é™åˆ¶`);
				return;
			}
			lastClearClick[roomName] = now;
			
			const r=Store.byName.get(roomName); 
			if(r && r.occupant_student_name) {
				// æ£€æŸ¥æ˜¯å¦æœ‰æ“ä½œé”
				const lockKey = `clear_${roomName}`;
				if (Store.operationLocks?.has(lockKey)) {
					toast(`æˆ¿é—´ ${roomName} æ­£åœ¨å¤„ç†ä¸­...`, 'warn');
					return;
				}
				
				clearRoomUnified(r.name);
			} else if (r && !r.occupant_student_name) {
				toast(`æˆ¿é—´ ${roomName} å·²ä¸ºç©º`, 'info');
			}
		});
	}
	async function renewRoom(roomName, opts = {}){ 
		// æ–¹æ¡ˆ1: æ“ä½œé—´éš”æ£€æµ‹ï¼Œç¡®ä¿Realtimeæ›´æ–°åˆ°è¾¾
		await waitForRealtimeSync(opts.afterVersionConflict ? { afterVersionConflict: true } : {});
		
		// æ£€æŸ¥æ“ä½œé”ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
		const lockKey = `renew_${roomName}`;
		if (Store.operationLocks?.has(lockKey)) {
			logWarn(`æˆ¿é—´ ${roomName} æ­£åœ¨ç»­æœŸä¸­ï¼Œè¯·ç¨å€™`);
			toast(`æˆ¿é—´ ${roomName} æ­£åœ¨ç»­æœŸä¸­...`, 'warn');
			return { ok: false, error: 'æ“ä½œè¿›è¡Œä¸­' };
		}
		
		const r=Store.byName.get(roomName); 
		if(!r||!r.occupant_student_name){ 
			toast('æˆ¿é—´ä¸ºç©º'); 
			return {ok:false, error:'æˆ¿é—´ä¸ºç©º'}; 
		}
		
		// è®¾ç½®æ“ä½œé”
		if (!Store.operationLocks) Store.operationLocks = new Set();
		Store.operationLocks.add(lockKey);
		
		try {
			// === CAS ç‰ˆæœ¬æ ¡éªŒï¼ˆå†™å‰ï¼‰===
			if (supabaseReady) {
				try {
					const localRow = Store.rooms.find(r=>r.name===roomName);
					const localVersion = (localRow && localRow.version) ? localRow.version : 0;
					const { data: remoteRow, error: verErr } = await supabaseClient
						.from('rooms')
						.select('name,occupant_student_name,register_time,version,heartbeat_at,updated_at')
						.eq('name', roomName)
						.maybeSingle();
					if(!verErr && remoteRow){
						const remoteVersion = remoteRow.version || 0;
						if(remoteVersion !== localVersion){
							logWarn(`[CAS] renew ä¸­æ£€æµ‹åˆ°ç‰ˆæœ¬ä¸åŒ¹é… ${roomName}: local v${localVersion} / remote v${remoteVersion}ï¼Œç»ˆæ­¢ç»­æœŸå¹¶åˆ·æ–°`);
							// ç›´æ¥æ”¾å¼ƒç»­æœŸï¼Œåˆ·æ–°æ˜¾ç¤º
							const canonical = canonicalizeRoom(remoteRow);
							const idx = Store.rooms.findIndex(r=>r.name===roomName);
							if(idx>=0) { Store.rooms[idx] = canonical; } else { Store.rooms.push(canonical); }
							if(typeof rebuildIndexes==='function') rebuildIndexes();
							renderRoomCard(roomName);
							updateUsageStats();
							// æ–¹æ¡ˆ2: ä¼˜åŒ–é”™è¯¯æç¤º
							createOptimizedToast(roomName, 'renew');
							
							// æ–¹æ¡ˆ3: è‡ªåŠ¨é‡è¯•æœºåˆ¶
							if (!opts.isRetry) {
								console.log(`[CAS] renewç‰ˆæœ¬ä¸åŒ¹é…ï¼Œ1.5ç§’åè‡ªåŠ¨é‡è¯•`);
								setTimeout(async () => {
									const retryOpts = { ...opts, isRetry: true, afterVersionConflict: true };
									await waitForRealtimeSync({ afterVersionConflict: true });
									await renewRoom(roomName, retryOpts);
								}, 1500);
							}
							
							return { ok:false, stale:true, reason:'version-mismatch', remoteVersion, localVersion };
						}
					}
				} catch(e){
					logWarn('[CAS] renew ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ: '+ e.message);
				}
			}
				// ä¹è§‚æ›´æ–°ï¼ˆç«‹å³æ˜¾ç¤ºæ•ˆæœï¼‰
				const originalTime = r.registerTime;
				const nowMs = Date.now();
				r.registerTime = nowMs; // æ–°ä¼šè¯å¼€å§‹
			
			// æ·»åŠ è§†è§‰æŒ‡ç¤º
			const card = document.querySelector(`[data-room="${roomName}"]`);
			if (card) {
				card.classList.add('pending-operation');
				card.dataset.status = 'syncing';
			}
			
			renderRoomCard(roomName); 
			toast(`âœ… å·²ç»­æœŸ ${roomName}`, 'success');
			
			// ğŸ—„ï¸ ä¿å­˜è®¡æ—¶å™¨çŠ¶æ€
			timerPersistence.saveTimerStates();
			
			// åç«¯åŒæ­¥
			if(!supabaseReady){ 
				logWarn('ç¦»çº¿æ¨¡å¼ - ç»“æŸå½“å‰ä¼šè¯å¹¶é‡å¼€ï¼ˆæœ¬åœ°ï¼‰');
				// æœ¬åœ°è®°å½•ä¸¤æ¡ï¼šclear + assignï¼ˆæ”¯æŒå¤šäººï¼‰
				const students = r.occupant_student_name ? r.occupant_student_name.split(',').map(s => s.trim()) : [];
				for(const student of students){
					await writePracticeLog(roomName, student, 'clear', { startMs: originalTime });
					await writePracticeLog(roomName, student, 'assign');
				}
				return {ok:true, offline:true}; 
			}
			
			const nowIso = new Date(nowMs).toISOString();
			const nextVersion = (r.version || 0) + 1;
			
			// æ ‡è®°ä¸ºå¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.set(roomName, { 
				student: r.occupant_student_name, 
				version: nextVersion, 
				timestamp: nowMs,
				action: 'restart'
			});
			
			const { data, error } = await supabaseClient.from('rooms').upsert({
				name: roomName,
				occupant_student_name: r.occupant_student_name,
				register_time: nowIso,  // æ–°ä¼šè¯å¼€å§‹æ—¶é—´
				heartbeat_at: nowIso,
				version: nextVersion,
				updated_at: nowIso,
			piano_type: r.pianoType || r.piano_type || 'å…¶ä»–',
			location: r.location || '',
			remark: r.remark || ''
			});
			
			if(error){ 
				logErr('ç»­æœŸå¤±è´¥', error.message);
				// å›æ»šä¹è§‚æ›´æ–°
				r.registerTime = originalTime;
				renderRoomCard(roomName);
				toast(`âŒ ç»­æœŸå¤±è´¥ ${roomName}`, 'error');
				
				// ğŸ—„ï¸ å›æ»šåä¿å­˜è®¡æ—¶å™¨çŠ¶æ€
				timerPersistence.saveTimerStates();
				
				return {ok:false,error}; 
			}
			
			// å†™å…¥ç»ƒä¹ è®°å½•ï¼šå…ˆç»“æŸä¸Šä¸€æ®µï¼Œå†å¼€å§‹æ–°ä¸€æ®µï¼ˆæ”¯æŒå¤šäººï¼‰
			const students = r.occupant_student_name ? r.occupant_student_name.split(',').map(s => s.trim()) : [];
			for(const student of students){
				await writePracticeLog(roomName, student, 'clear', { startMs: originalTime });
				await writePracticeLog(roomName, student, 'assign');
			}
			
			logInfo(`æˆåŠŸç»“æŸå¹¶é‡å¼€æ–°ä¼šè¯ ${roomName} (v${nextVersion})`);

		// ğŸ”§ ä¿®å¤ï¼šæˆåŠŸåç«‹å³æ›´æ–°æœ¬åœ°ç‰ˆæœ¬å·ï¼Œé¿å…åç»­æ“ä½œå‡ºç°ç‰ˆæœ¬å†²çª
		if(r) {
			r.version = nextVersion;
		}
			
			// è®°å½•æ“ä½œæ—¶é—´
			window.__lastRoomOperationTime = Date.now();
			
			return {ok:true, data};
			
		} finally {
			// æ¸…é™¤æ“ä½œé”
			Store.operationLocks.delete(lockKey);
			// æ¸…é™¤å¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.delete(roomName);
			// æ¸…é™¤è§†è§‰æŒ‡ç¤º
			clearOperationIndicator(roomName);
		}
	}
	function openStudentModal(roomName){
		const modal=document.getElementById('studentModalBackdrop'); 
		modal.style.display='flex'; 
		modal.dataset.room=roomName; 
		const input=document.getElementById('studentSearch');
		input.value='';
		// åˆå§‹åŒ–é”®ç›˜é€‰æ‹©çŠ¶æ€ - ä¸é»˜è®¤é«˜äº®ä»»ä½•å­¦ç”Ÿ,é¿å…è¯¯å¯¼
		studentListKB.index=-1; studentListKB.active=false;
		// é‡ç½®å¤šé€‰çŠ¶æ€
		if(window.studentModalState){
			studentModalState.multiSelectMode = false;
			studentModalState.selectedStudents.clear();
			// æ›´æ–°UIçŠ¶æ€
			const btnToggle = document.getElementById('btnMultiSelectToggle');
			if(btnToggle){
				btnToggle.textContent = 'å¤šäººç™»è®°';
				btnToggle.classList.remove('sl-btn-primary');
				btnToggle.classList.add('sl-btn-secondary');
			}
			document.getElementById('selectedStudentsArea').style.display = 'none';
			document.getElementById('btnConfirmMultiSelect').style.display = 'none';
			document.getElementById('btnStudentModalCancel').style.display = 'inline-flex';
		}
		renderStudentList();
		// èšç„¦è¾“å…¥æ¡†æ–¹ä¾¿ç›´æ¥æ‰“å­—
		setTimeout(()=>input.focus(), 0);
	}
	function closeStudentModal(){
		const el=document.getElementById('studentModalBackdrop');
		if(!el) return; 
		try{
			// è‹¥å·²éšè—åˆ™ç›´æ¥è¿”å›
			if(el.style.display==='none') return;
			// å¯åŠ¨æ·¡å‡º
			el.style.opacity='1';
			// å¼ºåˆ¶å›æµç¡®ä¿è¿‡æ¸¡ç”Ÿæ•ˆ
			void el.offsetWidth;
			el.style.opacity='0';
			// åœ¨è¿‡æ¸¡ç»“æŸåéšè—
			const done=()=>{ el.style.display='none'; el.style.opacity='1'; el.removeEventListener('transitionend',done); };
			el.addEventListener('transitionend',done);
			// å…œåº•è¶…æ—¶ï¼ˆSafari æŸäº›æƒ…å†µä¸‹ä¸è§¦å‘ transitionendï¼‰
			setTimeout(done, 180);
		}catch(_){ el.style.display='none'; }
	}
	function renderStudentList(){
		const box=document.getElementById('studentList'); 
		const q=document.getElementById('studentSearch').value.trim().toLowerCase(); 
		const roomName=document.getElementById('studentModalBackdrop').dataset.room; 
		const isGrand=/ä¸‰è§’/.test((Store.byName.get(roomName)||{}).pianoType||'');

		// ä¼˜å…ˆä½¿ç”¨ StudentLibrary ä¸­çš„æ´»åŠ¨å­¦ç”Ÿåˆ—è¡¨ï¼ˆä¿æŒä¸å­¦ç”Ÿåº“ CRUD åŒæ­¥ï¼‰
		let arr = [];
		if(window.getAllActiveStudents){
			try{ arr = window.getAllActiveStudents().map(s=>({ name:s.name, grade:s.grade||'', major:s.major||'' })); }catch(_){ arr = []; }
		}
		if(!arr.length){ // å›é€€åˆ°åŸå§‹ Store.students
			arr = Store.students.slice();
		}
		if(q) arr=arr.filter(s=> matchPinyin(s.name, q) || (s.major||'').toLowerCase().includes(q));
		
		// å¯¹äºä¸‰è§’é’¢ç´ï¼Œå•äººç™»è®°æ—¶è¿‡æ»¤æ‰éé’¢ç´æ•™ç ”å®¤çš„å­¦ç”Ÿï¼›å¤šäººç™»è®°æ—¶æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿ
		const inMultiSelectMode = window.studentModalState && window.studentModalState.multiSelectMode;
		if(isGrand && !inMultiSelectMode) {
			arr = arr.filter(s => s.major === 'é’¢ç´æ•™ç ”å®¤');
		}
		
		arr.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN'));
		
		// å»ºç«‹å ç”¨ç´¢å¼•ï¼Œæé«˜æŸ¥æ‰¾é€Ÿåº¦
		const occupancyMap = new Map();
		for(const r of Store.rooms){ if(r.occupant_student_name){ occupancyMap.set(r.occupant_student_name, r); } }

		box.innerHTML = arr.map((s,i)=>{ 
			const occRoom = occupancyMap.get(s.name);
			const isOccupied = !!occRoom && occRoom.name !== roomName; // å·²åœ¨å…¶å®ƒæˆ¿é—´
			let titleText = `${s.major||''} ${s.grade||''}`.trim();
			if(isOccupied){ titleText += ` (å ç”¨ ${occRoom.name})`; }

			// è®¡ç®—å ç”¨çŠ¶æ€æ ‡ç­¾ï¼ˆå‡†å¤‡ä¸­/è®¡æ—¶/è¶…æ—¶ï¼‰
			let stateTag = '';
			if(isOccupied){
				const st = statusInfo(occRoom);
				let label = '';
				switch(st.state){
					case 'preparing': label='å‡†å¤‡ä¸­'; break;
					case 'occupied': label='å ç”¨ä¸­'; break;
					case 'overtime': label='è¶…æ—¶'; break;
					default: label='å ç”¨';
				}
				// åŠ¨æ€æ—¶é•¿ï¼ˆå ç”¨è®¡æ—¶ï¼‰
				if(st.state==='occupied' && /:\d{2}$/.test(st.chip)){
					label += ` ${st.chip}`; // å·²æœ‰ mm:ss æˆ– hh:mm:ss
				}
				stateTag = `<span class="state-tag st-${st.state}">${label}</span>`;
			}

			const kbCls = (i===studentListKB.index)?' kb-selected':'';
			// æ£€æŸ¥æ˜¯å¦åœ¨å¤šé€‰æ¨¡å¼çš„é€‰ä¸­åˆ—è¡¨ä¸­
			const isMultiSelected = window.studentModalState && window.studentModalState.selectedStudents.has(s.name);
			const multiSelectCls = isMultiSelected ? ' multi-selected' : '';
			return `<div class="student-item${kbCls}${multiSelectCls}" data-name="${s.name}" title="${titleText}">
				<div class="col-left">
					<span class="stu-name">${escapeHtml(s.name)}</span>
					<span class="tag major">${s.major||''}</span>
					${s.grade?`<span class=\"tag grade\">${s.grade}</span>`:''}
				</div>
				<div class="col-right">
					${isOccupied?`<span class=\"room-tag\" title=\"å½“å‰å ç”¨æˆ¿é—´\">${occRoom.name}</span>`:''}
					${stateTag}
				</div>
			</div>`; 
		}).join('');
		// è¶Šç•Œä¿æŠ¤ & é‡æ–°é«˜äº®
		const items = box.querySelectorAll('.student-item');
		if(items.length===0){ studentListKB.index=-1; return; }
		if(studentListKB.index>=items.length) studentListKB.index=items.length-1; 
		// å…è®¸ index=-1 è¡¨ç¤ºæ²¡æœ‰é€‰ä¸­ä»»ä½•é¡¹
		if(studentListKB.index<-1) studentListKB.index=-1;
		items.forEach((el,i)=> el.classList.toggle('kb-selected', i===studentListKB.index));
		// ç¡®ä¿é€‰ä¸­é¡¹å¯è§(ä»…å½“æœ‰é€‰ä¸­é¡¹æ—¶)
		if(studentListKB.index>=0){
			const active=items[studentListKB.index];
			if(active){ const rect=active.getBoundingClientRect(); const parent=box.getBoundingClientRect(); if(rect.top<parent.top||rect.bottom>parent.bottom){ active.scrollIntoView({block:'nearest'}); } }
		}
	}
	function bindStudentModal(){
		// é”®ç›˜å¯¼èˆªçŠ¶æ€
		if(!window.studentListKB){
			window.studentListKB={ index:0, active:false };
		}
		// å¤šé€‰æ¨¡å¼çŠ¶æ€
		if(!window.studentModalState){
			window.studentModalState = {
				multiSelectMode: false,
				selectedStudents: new Set()
			};
		}
		function moveSelection(delta){
			const box=document.getElementById('studentList');
			const items=box.querySelectorAll('.student-item');
			if(items.length===0) return; 
			// ä»-1å¼€å§‹æ—¶,å‘ä¸‹ç§»åŠ¨åˆ°0,å‘ä¸Šä¸ç§»åŠ¨
			let newIndex = studentListKB.index + delta;
			if(newIndex < 0) newIndex = 0; // ä¸å…è®¸å°äº0
			if(newIndex >= items.length) newIndex = items.length - 1; // ä¸å…è®¸è¶…å‡ºèŒƒå›´
			studentListKB.index = newIndex;
			items.forEach((el,i)=> el.classList.toggle('kb-selected', i===studentListKB.index));
			const active=items[studentListKB.index];
			if(active){ const rect=active.getBoundingClientRect(); const parent=box.getBoundingClientRect(); if(rect.top<parent.top||rect.bottom>parent.bottom){ active.scrollIntoView({block:'nearest'}); } }
		}
		function triggerSelect(){
			const box=document.getElementById('studentList');
			const items=box.querySelectorAll('.student-item');
			if(items.length===0) return;
			// å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•é¡¹(-1),æŒ‰å›è½¦ä¸æ‰§è¡Œæ“ä½œ
			if(studentListKB.index < 0) return;
			const target=items[studentListKB.index];
			if(target){ target.click(); }
		}
		// ç›‘å¬é”®ç›˜
		document.addEventListener('keydown', function studentModalKeyHandler(e){
			const modal=document.getElementById('studentModalBackdrop');
			if(modal.style.display!=='flex') return; // åªåœ¨æ¨¡æ€æ‰“å¼€æ—¶
			// å½“ç„¦ç‚¹åœ¨è¾“å…¥æ¡†æˆ– body å‡å¯å“åº”ï¼Œä¸Šä¸‹é”® & å›è½¦
			if(['ArrowDown','ArrowUp','Enter','Escape'].includes(e.key)){
				// é¿å…é¡µé¢æ•´ä½“æ»šåŠ¨
				e.preventDefault();
				studentListKB.active=true;
				if(e.key==='ArrowDown') moveSelection(1); else if(e.key==='ArrowUp') moveSelection(-1); else if(e.key==='Enter') triggerSelect(); else if(e.key==='Escape') closeStudentModal();
			}
		}, {passive:false});
		document.getElementById('studentSearch').addEventListener('input', renderStudentList);
		// é˜²æŠ–æœºåˆ¶çš„å­¦ç”Ÿé€‰æ‹©å¤„ç†
		let lastAssignClick = {};
		document.getElementById('studentList').addEventListener('click', async (e) => { 
			const item=e.target.closest('.student-item'); 
			if(!item) return; 
			
			const name=item.dataset.name;
			
			// å¤šé€‰æ¨¡å¼ï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€
			if(studentModalState.multiSelectMode){
				if(studentModalState.selectedStudents.has(name)){
					studentModalState.selectedStudents.delete(name);
					item.classList.remove('multi-selected');
				} else {
					studentModalState.selectedStudents.add(name);
					item.classList.add('multi-selected');
				}
				updateSelectedStudentsList();
				return; // å¤šé€‰æ¨¡å¼ä¸‹ä¸ç«‹å³æ‰§è¡Œç™»è®°
			}
			
			// å•é€‰æ¨¡å¼ï¼šåŸæœ‰é€»è¾‘
			const room=document.getElementById('studentModalBackdrop').dataset.room;
			const now = Date.now();
			const clickKey = `${room}_${name}`;
			
			// é˜²æŠ–ï¼šåŒä¸€æˆ¿é—´å’Œå­¦ç”Ÿç»„åˆ500mså†…åªèƒ½è§¦å‘ä¸€æ¬¡åˆ†é…
			if (lastAssignClick[clickKey] && (now - lastAssignClick[clickKey]) < 500) {
				logInfo(`æˆ¿é—´ ${room} åˆ†é…ç»™ ${name} çš„æ“ä½œè¢«é˜²æŠ–é™åˆ¶`);
				return;
			}
			lastAssignClick[clickKey] = now;
			
			// æ£€æŸ¥æ“ä½œé”
			const lockKey = `assign_${room}`;
			if (Store.operationLocks?.has(lockKey)) {
				toast(`æˆ¿é—´ ${room} æ­£åœ¨å¤„ç†ä¸­...`, 'warn');
				return;
			}
			
			let shouldCloseModal = true; // æ§åˆ¶æ˜¯å¦å…³é—­æ¨¡æ€æ¡†
			
			// æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å·²ç»å ç”¨å…¶ä»–ç´æˆ¿ï¼Œå¦‚æœæ˜¯åˆ™è¿›è¡Œè½¬ç§»æ“ä½œ
			// æ”¯æŒå¤šäººç™»è®°ï¼šæ£€æŸ¥occupant_student_nameä¸­æ˜¯å¦åŒ…å«è¯¥å­¦ç”Ÿï¼ˆé€—å·åˆ†éš”ï¼‰
			const occupiedRoom = Store.rooms.find(r => {
				if(!r.occupant_student_name) return false;
				const students = r.occupant_student_name.split(',').map(s => s.trim());
				return students.includes(name);
			});
			if (occupiedRoom && occupiedRoom.name !== room) {
				// è½¬ç§»åœºæ™¯ï¼šç®€åŒ–æç¤ºï¼Œç»Ÿä¸€äº¤ç”±æ–° transferStudent å†…éƒ¨å¤„ç†
				const transferResult = await transferStudentUnified(occupiedRoom.name, room, name);
				if (!(transferResult && transferResult.success===false)) {
					// æˆåŠŸæˆ–éƒ¨åˆ†æˆåŠŸï¼ˆæºç¨åè‡ªæ„ˆï¼‰ä¿æŒå…³é—­æ¨¡æ€
				} else {
					// å¤±è´¥ä½†æœªåœ¨å†…éƒ¨æˆåŠŸå ç›®æ ‡ï¼Œä¸å…³é—­è®©ç”¨æˆ·é‡é€‰
					shouldCloseModal = false;
				}
			} else {
				// éè½¬ç§»åœºæ™¯ï¼Œæ­£å¸¸ç™»è®°
				const assignResult = await attemptAssignRoom(room, name); // attemptAssignRoom å·²èµ° assignRoomUnified
				if (assignResult && assignResult.cancelled) {
					shouldCloseModal = false; // ç”¨æˆ·å–æ¶ˆäº†ç™»è®°ï¼Œä¸å…³é—­æ¨¡æ€æ¡†
				}
			}
			
			// åªæœ‰åœ¨æ“ä½œæˆåŠŸæˆ–ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©æ—¶æ‰å…³é—­æ¨¡æ€æ¡†
			if (shouldCloseModal) {
				closeStudentModal();
			}
		});
		document.getElementById('btnStudentModalCancel').onclick=closeStudentModal; 
		document.getElementById('btnCloseStudentModal').onclick=closeStudentModal;
		
		// å¤šé€‰æ¨¡å¼åˆ‡æ¢æŒ‰é’®
		document.getElementById('btnMultiSelectToggle').onclick = function(){
			studentModalState.multiSelectMode = !studentModalState.multiSelectMode;
			
			// æ— è®ºè¿›å…¥è¿˜æ˜¯é€€å‡ºå¤šé€‰æ¨¡å¼,éƒ½æ¸…ç©ºä¹‹å‰çš„é€‰æ‹©çŠ¶æ€
			studentModalState.selectedStudents.clear();
			updateSelectedStudentsList();
			
			updateMultiSelectUI();
		};
		
		// æ¸…ç©ºå·²é€‰å­¦ç”Ÿ
		document.getElementById('btnClearSelectedStudents').onclick = function(){
			studentModalState.selectedStudents.clear();
			updateSelectedStudentsList();
			renderStudentList(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
		};
		
		// ç¡®è®¤å¤šäººç™»è®°æŒ‰é’®
	document.getElementById('btnConfirmMultiSelect').onclick = async function(){
		if(studentModalState.selectedStudents.size === 0){
			toast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå­¦ç”Ÿ', 'warn');
			return;
		}
		// ğŸ”§ å¤šäººç™»è®°æ¨¡å¼ä¸‹å¿…é¡»é€‰æ‹©è‡³å°‘2äºº
		if(studentModalState.multiSelectMode && studentModalState.selectedStudents.size < 2){
			toast('å¤šäººç™»è®°æ¨¡å¼ä¸‹è‡³å°‘éœ€è¦é€‰æ‹©2ä½å­¦ç”Ÿ', 'warn');
			return;
		}
		await performMultiStudentAssign();
	};		// æ›´æ–°å¤šé€‰æ¨¡å¼UI
		function updateMultiSelectUI(){
			const btnToggle = document.getElementById('btnMultiSelectToggle');
			const selectedArea = document.getElementById('selectedStudentsArea');
			const confirmBtn = document.getElementById('btnConfirmMultiSelect');
			const cancelBtn = document.getElementById('btnStudentModalCancel');
			
			if(studentModalState.multiSelectMode){
				btnToggle.textContent = 'é€€å‡ºå¤šé€‰';
				btnToggle.classList.remove('sl-btn-secondary');
				btnToggle.classList.add('sl-btn-primary');
				selectedArea.style.display = 'block';
				confirmBtn.style.display = 'inline-flex';
				cancelBtn.style.display = 'none';
			} else {
				btnToggle.textContent = 'å¤šäººç™»è®°';
				btnToggle.classList.remove('sl-btn-primary');
				btnToggle.classList.add('sl-btn-secondary');
				selectedArea.style.display = 'none';
				confirmBtn.style.display = 'none';
				cancelBtn.style.display = 'inline-flex';
			}
			renderStudentList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°æ ·å¼
		}
		
		// æ›´æ–°å·²é€‰å­¦ç”Ÿåˆ—è¡¨æ˜¾ç¤º
		function updateSelectedStudentsList(){
			const countSpan = document.getElementById('selectedStudentsCount');
			const listDiv = document.getElementById('selectedStudentsList');
			const confirmCountSpan = document.getElementById('confirmButtonCount');
			
			const count = studentModalState.selectedStudents.size;
			countSpan.textContent = count;
			confirmCountSpan.textContent = count;
			
			if(count === 0){
				listDiv.innerHTML = '<span style="color: var(--text-dim); font-size: 12px; font-style: italic;">æœªé€‰æ‹©å­¦ç”Ÿ</span>';
			} else {
				const chips = Array.from(studentModalState.selectedStudents).map(name => {
					return `<span class="selected-student-chip">
						${escapeHtml(name)}
						<span class="remove-btn" data-name="${name}">âœ•</span>
					</span>`;
				}).join('');
				listDiv.innerHTML = chips;
				
				// ç»‘å®šç§»é™¤æŒ‰é’®äº‹ä»¶
				listDiv.querySelectorAll('.remove-btn').forEach(btn => {
					btn.onclick = function(){
						const name = this.dataset.name;
						studentModalState.selectedStudents.delete(name);
						updateSelectedStudentsList();
						renderStudentList(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
					};
				});
			}
		}
		
		// æ‰§è¡Œå¤šäººç™»è®°
		async function performMultiStudentAssign(){
			const room = document.getElementById('studentModalBackdrop').dataset.room;
			const students = Array.from(studentModalState.selectedStudents);
			
			if(students.length === 0) return;
			
			// æ˜¾ç¤ºè¿›åº¦æç¤º
			toast(`æ­£åœ¨ä¸º ${students.length} ä½å­¦ç”Ÿç™»è®°åˆ° ${room}...`, 'info');
			
			try {
				// è°ƒç”¨å¤šäººç™»è®°å‡½æ•°
				const result = await assignMultipleStudentsToRoom(room, students);
				
				if(result.ok){
					toast(`âœ… æˆåŠŸä¸º ${students.length} ä½å­¦ç”Ÿç™»è®°åˆ° ${room}`, 'success');
					// æ¸…ç©ºé€‰æ‹©å¹¶å…³é—­æ¨¡æ€æ¡†
					studentModalState.selectedStudents.clear();
					studentModalState.multiSelectMode = false;
					closeStudentModal();
				} else if(result.cancelled){
					toast('å·²å–æ¶ˆç™»è®°', 'info');
				} else {
					toast(`âŒ ç™»è®°å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
				}
			} catch(err) {
				logErr('å¤šäººç™»è®°å¤±è´¥:', err);
				toast(`âŒ ç™»è®°å¤±è´¥ï¼Œè¯·æ£€æŸ¥åé‡è¯•`, 'error');
			}
		}
	}

	/*************************************************
	 * æ–°å¢æˆ¿é—´æ¨¡æ€æ¡†
	 *************************************************/
	function showAddRoomModal(){
		const modal = document.getElementById('addRoomModalBackdrop');
		modal.style.display = 'flex';
		
		// æ¸…ç©ºè¡¨å•
		document.getElementById('addRoomName').value = '';
		document.getElementById('addRoomLocation').value = '';
		document.getElementById('addRoomPianoType').value = 'ç«‹å¼';
		document.getElementById('addRoomRemark').value = '';
		
		// é‡ç½®é’¢ç´ç±»å‹é€‰æ‹©å™¨
		document.querySelectorAll('.piano-type-option').forEach(option => {
			option.classList.remove('selected');
		});
		document.querySelector('.piano-type-option[data-type="ç«‹å¼"]').classList.add('selected');
		
		// èšç„¦æˆ¿é—´åç§°è¾“å…¥æ¡†
		setTimeout(() => document.getElementById('addRoomName').focus(), 0);
		
		// ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
		modal.addEventListener('click', function handleBackdropClick(e) {
			if (e.target === modal) {
				closeAddRoomModal();
				modal.removeEventListener('click', handleBackdropClick);
			}
		});
	}
	
	function closeAddRoomModal(){
		document.getElementById('addRoomModalBackdrop').style.display = 'none';
	}
	
	function bindAddRoomModal(){
		document.getElementById('btnCloseAddRoomModal').onclick = closeAddRoomModal;
		document.getElementById('btnAddRoomCancel').onclick = closeAddRoomModal;
		document.getElementById('btnAddRoomConfirm').onclick = createNewRoom;
		
		// é’¢ç´ç±»å‹é€‰æ‹©å™¨äº‹ä»¶
		document.querySelectorAll('.piano-type-option').forEach(option => {
			option.addEventListener('click', function() {
				// ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
				document.querySelectorAll('.piano-type-option').forEach(opt => opt.classList.remove('selected'));
				// æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
				this.classList.add('selected');
				// åŒæ­¥åˆ°éšè—çš„selectå…ƒç´ 
				document.getElementById('addRoomPianoType').value = this.dataset.type;
			});
		});
		
		// å›è½¦é”®æäº¤
		document.getElementById('addRoomName').addEventListener('keydown', e => {
			if (e.key === 'Enter') {
				e.preventDefault();
				createNewRoom();
			}
		});
		
		// ESCé”®å…³é—­
		document.addEventListener('keydown', function addRoomModalKeyHandler(e) {
			const modal = document.getElementById('addRoomModalBackdrop');
			if (modal.style.display === 'flex' && e.key === 'Escape') {
				closeAddRoomModal();
			}
		});
	}
	
	async function createNewRoom(){
		// æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
		document.querySelectorAll('.form-field').forEach(field => {
			field.classList.remove('error');
			const errorMsg = field.querySelector('.error-message');
			if (errorMsg) errorMsg.remove();
		});
		
		const name = document.getElementById('addRoomName').value.trim();
		const location = document.getElementById('addRoomLocation').value.trim();
		const pianoType = document.getElementById('addRoomPianoType').value;
		const remark = document.getElementById('addRoomRemark').value.trim();
		
		let hasError = false;
		
		// éªŒè¯æˆ¿é—´åç§°
		if (!name) {
			const nameField = document.getElementById('addRoomName').closest('.form-field');
			nameField.classList.add('error');
			const errorDiv = document.createElement('div');
			errorDiv.className = 'error-message';
			errorDiv.textContent = 'æˆ¿é—´åç§°ä¸èƒ½ä¸ºç©º';
			nameField.appendChild(errorDiv);
			hasError = true;
		}
		
		// æ£€æŸ¥æˆ¿é—´åç§°æ˜¯å¦å·²å­˜åœ¨
		if (name && Store.byName.has(name)) {
			const nameField = document.getElementById('addRoomName').closest('.form-field');
			nameField.classList.add('error');
			const errorDiv = document.createElement('div');
			errorDiv.className = 'error-message';
			errorDiv.textContent = 'æˆ¿é—´åç§°å·²å­˜åœ¨';
			nameField.appendChild(errorDiv);
			hasError = true;
		}
		
		if (hasError) {
			document.getElementById('addRoomName').focus();
			return;
		}
		
		try {
			// æ˜ å°„é€‰æ‹©å™¨å€¼åˆ°æ•°æ®åº“æ ¼å¼
			let mappedPianoType = '';
			switch(pianoType) {
				case 'ä¸‰è§’':
					mappedPianoType = 'ä¸‰è§’é’¢ç´';
					break;
				case 'ç«‹å¼':
					mappedPianoType = 'ç«‹å¼é’¢ç´';
					break;
				case 'å…¶ä»–':
				default:
					mappedPianoType = 'å…¶ä»–';
					break;
			}
			
		const newRoom = {
			name: name,
			location: location || '',
			pianoType: mappedPianoType,
			remark: remark || '',
			occupant_student_name: null, // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€å­—æ®µå occupant_student_name
			registerTime: null,
			version: 1,
			heartbeatAt: null
		};
		
		// æ·»åŠ åˆ°æœ¬åœ°æ•°æ®
		Store.rooms.push(newRoom);
		Store.byName.set(name, newRoom);			// æ›´æ–°æ¥¼å±‚é›†åˆ
			const floor = deriveFloor(location);
			if (floor) Store.floorSet.add(floor);
			
			// åŒæ­¥åˆ°äº‘ç«¯ï¼šå†™å…¥é™æ€è¡¨ï¼Œå¹¶æ’å…¥/æ›´æ–°åŠ¨æ€è¡¨ä»¥è§¦å‘ä»–ç«¯å®æ—¶è®¢é˜…
			if (!Store.settings.offlineMode) {
				await supabaseClient.from('room_database').upsert({
					name: name,
					location: location || null,
					piano_type: mappedPianoType,
					remark: remark || null
				});
				// è§¦å‘ rooms å®æ—¶é€šé“ï¼Œè®©ä»–ç«¯æ— éœ€åˆ·æ–°å³å¯çœ‹åˆ°æ–°æˆ¿é—´
				await supabaseClient.from('rooms').upsert({
					name: name,
					occupant_student_name: null,
					register_time: null,
					heartbeat_at: new Date().toISOString(),
					version: 1,
					updated_at: new Date().toISOString(),
				piano_type: mappedPianoType,
				location: location || null,
				remark: remark || null
				});
			}
			
			// é‡æ–°æ¸²æŸ“
			renderRooms();
			ensureFilters();
			
			toast(`âœ… å·²æ·»åŠ ç´æˆ¿ï¼š${name}`);
			logInfo(`æ–°å¢ç´æˆ¿ï¼š${name}, ä½ç½®ï¼š${location}, ç±»å‹ï¼š${pianoType}`);
			
			closeAddRoomModal();
		} catch (error) {
			toast('æ·»åŠ å¤±è´¥', 'error');
			logErr('æ–°å¢ç´æˆ¿å¤±è´¥:', error.message);
		}
	}

	/*************************************************
	 * æœç´¢
	 *************************************************/
	function initSearch(){ document.getElementById('globalSearch').addEventListener('input', ()=>{ runGlobalSearch(); }); }
	function runGlobalSearch(){ 
		const q=document.getElementById('globalSearch').value.trim().toLowerCase(); 
		const box=document.getElementById('inlineSearchResults'); 
		if(!q){ box.style.display='none'; box.innerHTML=''; return; }
		const students=Store.students.filter(s=> matchPinyin(s.name, q) || (s.major||'').toLowerCase().includes(q));
		const rooms=Store.rooms.filter(r=> r.name.toLowerCase().includes(q) || (r.location||'').toLowerCase().includes(q) || (r.pianoType||'').toLowerCase().includes(q));
		const highlight=(txt)=>{ if(!q) return escapeHtml(txt); const low=txt.toLowerCase(); const idx=low.indexOf(q); if(idx===-1) return escapeHtml(txt); return escapeHtml(txt.slice(0,idx))+`<span class="highlight">${escapeHtml(txt.slice(idx,idx+q.length))}</span>`+escapeHtml(txt.slice(idx+q.length)); };
		let html='';
		if(students.length){ 
			html+=`<div><div class="group-title">å­¦ç”Ÿ (${students.length})</div>`+students.slice(0,30).map(s=>{
				// æ”¯æŒå¤šäººç™»è®°ï¼šæ£€æŸ¥occupant_student_nameä¸­æ˜¯å¦åŒ…å«è¯¥å­¦ç”Ÿï¼ˆé€—å·åˆ†éš”ï¼‰
				const room = Store.rooms.find(r=>{
					if(!r.occupant_student_name) return false;
					const students = r.occupant_student_name.split(',').map(st => st.trim());
					return students.includes(s.name);
				});
				let occupyMeta='';
				if(room){
					const st=statusInfo(room);
					const icon = st.state==='preparing' ? 'â³' : (st.state==='overtime' ? 'âš ï¸' : 'ğŸ¹');
					occupyMeta = `<span class="occ-info ${st.state}"><span class="icon">${icon}</span><span>${room.name}</span></span>`;
				}
				return `<div class="result-item student" data-type="student" data-name="${s.name}"><span>${highlight(s.name)}</span><span class="meta">${s.major||''} ${s.grade||''} ${occupyMeta}</span></div>`; 
			}).join('')+`</div>`; 
		}
		if(rooms.length){ html+=`<div><div class="group-title">ç´æˆ¿ (${rooms.length})</div>`+rooms.slice(0,30).map(r=>{ const st=statusInfo(r); return `<div class="result-item room" data-type="room" data-room="${r.name}"><span>${highlight(r.name)}</span><span class="meta">${r.location||''} ${r.pianoType||''} ${st.chip}</span></div>`; }).join('')+`</div>`; }
		if(!html) html='<div class="empty">æ— åŒ¹é…ç»“æœ</div>';
		box.innerHTML=html; box.style.display='block';
		box.querySelectorAll('.result-item').forEach(el=>{
			el.onclick=()=>{ const type=el.dataset.type; if(type==='room'){ scrollToRoom(el.dataset.room); } else if(type==='student'){ focusStudent(el.dataset.name); } hideInlineSearch(); };
		});
	}
	function hideInlineSearch(){ const box=document.getElementById('inlineSearchResults'); if(box){ box.style.display='none'; } }
	// ç‚¹å‡»é¡µé¢ç©ºç™½æˆ–æŒ‰ ESC å…³é—­å†…è”æœç´¢
	document.addEventListener('click', e=>{
		const box=document.getElementById('inlineSearchResults'); const input=document.getElementById('globalSearch');
		if(!box||box.style.display==='none') return; 
		if(!box.contains(e.target) && e.target!==input){ hideInlineSearch(); }
	});
	document.addEventListener('keydown', e=>{ if(e.key==='Escape') hideInlineSearch(); });

	/*************************************************
	 * ç»Ÿè®¡ä¸å¿ƒè·³åˆ·æ–°
	 *************************************************/
	/*************************************************
	 * UI çŠ¶æ€æ›´æ–°
	 *************************************************/
	function updateSyncStatus(state, text) {
		const dot = document.getElementById('syncDot');
		const textEl = document.getElementById('syncText');
		const reconnectBtn = document.getElementById('btnReconnect');
		
		if (dot) {
			dot.className = `sync-dot ${state}`;
		}
		if (textEl) {
			textEl.textContent = text;
		}
		
		// æ ¹æ®çŠ¶æ€æ˜¾ç¤º/éšè—é‡è¿æŒ‰é’®
		if (reconnectBtn) {
			reconnectBtn.style.display = (state === 'error' || state === 'offline') ? 'inline-block' : 'none';
		}
	}
	
	function updateCloudSyncInfo() {
		const localRoomCountEl = document.getElementById('localRoomCount');
		const localStudentCountEl = document.getElementById('localStudentCount');
		const lastSyncTimeEl = document.getElementById('lastSyncTime');
		
		if (localRoomCountEl) {
			localRoomCountEl.textContent = Store.rooms.length;
		}
		if (localStudentCountEl) {
			localStudentCountEl.textContent = Store.students.length;
		}
		if (lastSyncTimeEl && supabaseReady) {
			lastSyncTimeEl.textContent = new Date().toLocaleTimeString();
		}
	}
	
	function updateUsageStats(){ 
		const total=Store.rooms.length; 
		const occ=Store.rooms.filter(r=>r.occupant_student_name).length; 
		const rate= total? ((occ/total)*100).toFixed(1):'0.0'; 
		const statEl = document.getElementById('statUsage');
		if (statEl) {
			statEl.textContent=`ä½¿ç”¨ç‡ ${rate}%`;
		}
		const metaEl = document.getElementById('metaCounts');
		if (metaEl) {
			metaEl.textContent = `å…± ${total} é—´ â€¢ å ç”¨ ${occ}`;
		}
		
		// åŒæ—¶æ›´æ–°äº‘ç«¯åŒæ­¥ä¿¡æ¯
		updateCloudSyncInfo();
	}
	function startStatusTicker(){ 
		// ğŸš« å®Œå…¨å–æ¶ˆå®šæ—¶UIæ›´æ–°ï¼Œæ”¹ä¸ºäº‹ä»¶é©±åŠ¨æ›´æ–°
		// åŸæ¥æ¯ç§’æ›´æ–°æ‰€æœ‰æˆ¿é—´å¡ç‰‡ï¼Œç°åœ¨åªåœ¨çŠ¶æ€å®é™…å˜åŒ–æ—¶æ›´æ–°
		logInfo('UIçŠ¶æ€æ›´æ–°å·²æ”¹ä¸ºäº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼Œå–æ¶ˆå®šæ—¶æ›´æ–°');
		
		// æ¸…ç†æ—§çš„å®šæ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
		if(Store.timer) {
			clearInterval(Store.timer);
			Store.timer = null;
		}
		
		// æä¾›æ‰‹åŠ¨æ›´æ–°æ‰€æœ‰çŠ¶æ€çš„å‡½æ•°ï¼Œä¾›è°ƒè¯•ä½¿ç”¨
		window.refreshAllRoomStatus = () => {
			const els=document.querySelectorAll('.room-card'); 
			els.forEach(el=>{ 
				const name=el.dataset.room; 
				const r=Store.byName.get(name); 
				if(!r) return; 
				const st=statusInfo(r); 
				const chip=el.querySelector('.chip'); 
				if(chip) { 
					chip.textContent=st.chip; 
					chip.className=`chip ${st.class}`; 
				} 
				el.dataset.status=st.state; 
			});
			logInfo('æ‰‹åŠ¨åˆ·æ–°äº†æ‰€æœ‰æˆ¿é—´çŠ¶æ€');
		};
	}
	/* ================= ç»ƒç´æ—¶æ®µæ£€æµ‹å¼€å…³åˆå§‹åŒ– ================= */
	(function initPracticeSlotToggle(){
		try{
			const saved=localStorage.getItem('practiceSlotCheckEnabled');
			if(saved!==null){ Store.settings.practiceSlotCheckEnabled = saved==='1'; }
			const btn=document.getElementById('btnToggleSlotCheck');
			if(btn){
				function refreshLabel(){ btn.textContent='æ—¶æ®µæ£€æµ‹: '+(Store.settings.practiceSlotCheckEnabled?'å¼€':'å…³'); }
				refreshLabel();
				btn.addEventListener('click',()=>{
					Store.settings.practiceSlotCheckEnabled=!Store.settings.practiceSlotCheckEnabled;
					localStorage.setItem('practiceSlotCheckEnabled', Store.settings.practiceSlotCheckEnabled?'1':'0');
					refreshLabel();
					toast('ç»ƒç´æ—¶æ®µæ£€æµ‹å·²'+(Store.settings.practiceSlotCheckEnabled?'å¼€å¯':'å…³é—­'));
				});
			}
		}catch(e){ console.warn('åˆå§‹åŒ–ç»ƒç´æ—¶æ®µæ£€æµ‹å¼€å…³å¤±è´¥', e); }
	})();

	/*************************************************
	 * ç»ƒä¹ è®°å½• (æœ¬åœ° / æœåŠ¡å™¨)
	 *************************************************/
	async function writePracticeLog(roomName, studentName, action, opts) {
		// å…ˆç¼“å­˜åˆ°æœ¬åœ°
			const logEntry = createPracticeLogEntry(roomName, studentName, action, opts);
		Store.localPracticeLogs.push(logEntry);
		
		if (!supabaseReady) {
			logInfo(`æœ¬åœ°è®°å½•: ${action} ${studentName} @ ${roomName}`);
			return;
		}
		
		try {
			let attempt = 0;
			let removed = [];
			let lastError = null;
			// åˆ›å»ºæ•°æ®åº“æ•°æ®å‰¯æœ¬ï¼Œç§»é™¤æœ¬åœ°å­—æ®µ
			let currentData = { ...logEntry };
			delete currentData.synced; // ç§»é™¤æœ¬åœ°æ ‡è®°å­—æ®µ
			let summarized = false; // æ˜¯å¦å·²è¾“å‡ºç¼ºåˆ—æ±‡æ€»

			while (attempt < 5) { // æœ€å¤š 5 æ¬¡é€åˆ—å‰”é™¤é‡è¯•
				const { error } = await supabaseClient
					.from('practice_logs')
					.insert(currentData);

				if (!error) {
					// æ ‡è®°ä¸ºå·²åŒæ­¥
					logEntry.synced = true;
					const removedInfo = removed.length ? ` (å·²å‰”é™¤åˆ—: ${removed.join(',')})` : '';
					logInfo(`âœ… ç»ƒä¹ è®°å½•å·²å†™å…¥: ${action} ${studentName} @ ${roomName}${removedInfo}`);
					return;
				}

				lastError = error;
				// ä»…å¤„ç†ç¼ºåˆ—é”™è¯¯ (Postgres 42703 æˆ– message åŒ…å« Could not find the 'xxx' column)
				const msg = (error.message||'').toLowerCase();
				if (error.code === '42703' || msg.includes("could not find the '") ) {
					// è§£æç¼ºå¤±åˆ—å
					let missing = '';
					const m = error.message.match(/'([^']+)' column/);
					if (m) missing = m[1];
					if (missing && currentData.hasOwnProperty(missing)) {
						delete currentData[missing];
						removed.push(missing);
						// å½“ç¼ºå¤±è¿‡å¤šå…³é”®åˆ—æ—¶ï¼Œç›´æ¥é™çº§ä¸ºæœ€å°å­—æ®µé›†åˆï¼šaction, student_name, timestamp
						if (!summarized && removed.length >= 2) {
							// è‹¥åŸºç¡€ room_name éƒ½ç¼ºäº†ï¼Œè¯´æ˜è¡¨ç»“æ„ä¸ä½ çš„é¢„æœŸå·®å¼‚å¾ˆå¤§ï¼Œè¾“å‡ºä¸€æ¬¡æ±‡æ€»ç„¶åé™çº§
							if (!currentData.room_name && !removed.includes('room_name')) {
								// do nothing; room_name åŸæœ¬ä¸åœ¨ currentData æ—¶ä¸å¤„ç†
							}
							logWarn(`practice_logs å¤šåˆ—ç¼ºå¤±: ${removed.join(',')}ã€‚å°†é™çº§ä»…å†™å…¥åŸºç¡€: action, student_name, timestamp`);
							// æ„é€ æœ€å°é›†
							// ä½¿ç”¨åŸå§‹æ¡ç›®çš„æ—¶é—´æˆ³ï¼Œé¿å…æœªå®šä¹‰å˜é‡
							currentData = {
								action: action,
								student_name: studentName,
								timestamp: logEntry.timestamp
							};
							summarized = true;
						}
						else {
							logWarn(`practice_logs ç¼ºå°‘åˆ— ${missing}ï¼Œå·²å‰”é™¤åé‡è¯• (ç¬¬ ${attempt+1} æ¬¡)`);
						}
						attempt++;
						continue;
					}
				}
				// å…¶å®ƒé”™è¯¯æˆ–æ— æ³•è§£æåˆ—åï¼Œç»“æŸå¾ªç¯
				break;
			}

			// å¦‚æœé€€å‡ºå¾ªç¯ä»å¤±è´¥
			if (lastError) {
				const extra = removed.length?` (å‰”é™¤åˆ—: ${removed.join(',')})`:'';
				logErr('å†™å…¥ç»ƒä¹ è®°å½•å¤±è´¥:', lastError.message + extra);
				const msgLow = (lastError.message||'').toLowerCase();
				if (msgLow.includes('row-level security') || msgLow.includes('rls')) {
					toast('Supabase RLS æ‹’ç»å†™å…¥ practice_logsï¼šè¯·ä¸ºå½“å‰è§’è‰²é…ç½®æ’å…¥ç­–ç•¥æˆ–æ”¹ç”¨è®¤è¯/æœåŠ¡ç«¯', 'error');
				}
			}
		} catch (err) {
			logErr('ç»ƒä¹ è®°å½•å¼‚å¸¸:', err.message);
		}
	}

	// åˆ›å»ºç»ƒä¹ è®°å½•æ¡ç›®
	function createPracticeLogEntry(roomName, studentName, action, opts) {
		const room = Store.rooms.find(r => r.name === roomName);
		const student = Store.studentIndex.get(studentName);
		const now = new Date().toISOString();

		let logEntry = {
			room_name: roomName,
			student_name: studentName,
			action: action,
			timestamp: now,
			piano_type: room?.pianoType || '',
			location: room?.location || '',
			student_major: student?.major || '',
			student_grade: student?.grade || '',
			synced: false // æœ¬åœ°æ ‡è®°
		};

		if (action === 'assign') {
			logEntry.session_start = now;
		} else if (action === 'clear') {
			const startMs = opts?.startMs ?? room?.registerTime ?? null;
			if (startMs) {
				logEntry.session_start = new Date(startMs).toISOString();
				logEntry.session_end = now;
				const durationMs = Date.now() - startMs - 60000; // å‡å»å‡†å¤‡æ—¶é—´
				logEntry.practice_duration = Math.max(0, Math.floor(durationMs / 1000));
			}
		}

		return logEntry;
	}
	
	function writePracticeLogLocal(r){ 
		if(!r||!r.occupant_student_name||!r.registerTime) return; 
		const prepEnd=r.registerTime+60000; 
		const now=Date.now(); 
		const used = Math.max(0, now - prepEnd); 
		logInfo(`æœ¬åœ°LOG ${r.occupant_student_name} @${r.name} ${formatDuration(Math.floor(used/1000))}`); 
	}

	/*************************************************
	 * å·¥å…· & UI è¾…åŠ©
	 *************************************************/
	function formatHMS(sec){ const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); const s=sec%60; return (h>0?h+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
	function formatDuration(sec){ if(sec<60) return sec+'s'; const m=Math.floor(sec/60); const s=sec%60; if(m<60) return m+'m'+(s? s+'s':''); const h=Math.floor(m/60); const mm=m%60; return h+'h'+(mm?mm+'m':''); }
	function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
	function toast(msg, type){ const box=document.getElementById('toastContainer'); const el=document.createElement('div'); el.className='toast'; el.innerHTML=`<span>${escapeHtml(msg)}</span>`; box.appendChild(el); setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),320); }, 2800); }
	function logInfo(...a){ console.log('[INFO]',...a); appendRuntime('INFO', a.join(' ')); }
	function logWarn(...a){ console.warn('[WARN]',...a); appendRuntime('WARN', a.join(' ')); }
	function logErr(...a){ console.error('[ERR]',...a); appendRuntime('ERR', a.join(' ')); }
	function appendRuntime(level,msg){ const box=document.getElementById('runtimeInfo'); const line=document.createElement('div'); line.style.whiteSpace='pre-wrap'; line.innerHTML=`<span class="muted">${new Date().toLocaleTimeString()}</span> <span class="${level==='ERR'?'danger':level==='WARN'?'warn':'accent'}">${level}</span> <span>${escapeHtml(msg)}</span>`; box.prepend(line); const max=120; while(box.children.length>max) box.removeChild(box.lastChild); }
	function refreshStudentModalCache(){ /* é¢„ç•™ï¼šå¯å»ºç«‹æ‹¼éŸ³ç´¢å¼• */ }

	/*************************************************
	 * åˆå§‹åŒ–æµç¨‹
	 *************************************************/
	async function bootstrap(){
		try{ 
			await initSupabase(); 
		}catch(e){ 
			logWarn('Supabase åˆå§‹åŒ–å¤±è´¥ (ç¦»çº¿æ¨¡å¼)', e.message); 
			updateSyncStatus('error', 'ç¦»çº¿æ¨¡å¼');
		}
		
		// ğŸ”§ é¡µé¢åŠ è½½æ—¶å…ˆæ¸…ç†å¯èƒ½çš„ç¼“å­˜æ±¡æŸ“
		logInfo('[Bootstrap] æ¸…ç†ç¼“å­˜ä»¥é˜²æ­¢æ•°æ®æ±¡æŸ“');
		try {
			// æ¸…ç†å¯èƒ½å¯¼è‡´æˆ¿é—´çŠ¶æ€æ¢å¤çš„ç¼“å­˜
			const cacheKeys = [
				'yms_timer_states',
				'yms_room_cache', 
				'yms_temp_states',
				'yms_operation_cache',
				'yms_room_timers'
			];
			
			let clearedCount = 0;
			cacheKeys.forEach(key => {
				if (localStorage.getItem(key)) {
					localStorage.removeItem(key);
					clearedCount++;
				}
			});
			
			if (clearedCount > 0) {
				logInfo(`[Bootstrap] æ¸…ç†äº† ${clearedCount} ä¸ªå¯èƒ½æ±¡æŸ“çš„ç¼“å­˜é¡¹`);
			}
		} catch (error) {
			logWarn('[Bootstrap] ç¼“å­˜æ¸…ç†å¤±è´¥:', error.message);
		}
		
		// ğŸ”§ é¡µé¢åŠ è½½æ—¶è¿›è¡Œæ•°æ®ä¸€è‡´æ€§éªŒè¯
		if (window.supabaseReady && DataConsistencyValidator) {
			logInfo('[Bootstrap] å¼€å§‹é¡µé¢åŠ è½½æ•°æ®ä¸€è‡´æ€§éªŒè¯');
			try {
				const validation = await DataConsistencyValidator.validateOnPageLoad();
				if (validation.issues > 0) {
					logWarn(`[Bootstrap] æ•°æ®ä¸€è‡´æ€§éªŒè¯å‘ç° ${validation.issues} ä¸ªé—®é¢˜ï¼Œå·²è‡ªåŠ¨ä¿®å¤`);
					toast(`æ£€æµ‹å¹¶ä¿®å¤äº† ${validation.issues} ä¸ªæ•°æ®ä¸€è‡´æ€§é—®é¢˜`, 'warn');
				} else {
					logInfo('[Bootstrap] æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡');
				}
			} catch (error) {
				logErr('[Bootstrap] æ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥:', error.message);
			}
		}
		
		const [rooms, roomMeta, students] = await Promise.all([
			fetchRooms(), 
			fetchRoomMeta(), 
			fetchStudents()
		]);
		
		Store.rooms = rooms; 
		Store.roomMeta = roomMeta; 
		Store.students = students; 

		// å…³é”®ä¿®å¤ï¼šç¡®ä¿äº‘ç«¯ room_database çš„é™æ€æˆ¿é—´èƒ½å¹¶å…¥ rooms åˆ—è¡¨
		// ä¹‹å‰ fetchRoomMeta å†…éƒ¨åˆå¹¶ä¼šè¢« Promise.all ç»“æŸåçš„èµ‹å€¼è¦†ç›–ï¼Œ
		// è¿™é‡Œåœ¨å®Œæˆèµ‹å€¼åå†æ¬¡åšä¸€æ¬¡ metaOnly åˆå¹¶ï¼Œä¿è¯â€œæ–°å¢ä½†å°šæ— çŠ¶æ€â€çš„æˆ¿é—´ä¹Ÿèƒ½æ˜¾ç¤º/åŒæ­¥åˆ°ä»–ç«¯ã€‚
		if (Store.roomMeta && Object.keys(Store.roomMeta).length > 0) {
			const metaList = Object.values(Store.roomMeta).map(r => ({
				name: r.name,
				pianoType: r.piano_type || '',
				location: r.location || '',
				remark: r.remark || ''
			}));
			await mergeRooms(metaList, { skipCloudSync: true, metaOnly: true });
		}
		
		// ğŸ”§ å¼ºåˆ¶åŒæ­¥ä¸¤ä¸ªè¡¨ï¼Œç¡®ä¿æ•°æ®å®Œå…¨ä¸€è‡´
		if (supabaseReady) {
			logInfo('[Bootstrap] å¼€å§‹å¼ºåˆ¶åŒæ­¥ rooms å’Œ room_database è¡¨');
			try {
				const syncResult = await forceSyncRoomTables();
				if (syncResult.success) {
					if (syncResult.fixed > 0) {
						logInfo(`[Bootstrap] åŒè¡¨åŒæ­¥å®Œæˆï¼Œä¿®å¤äº† ${syncResult.fixed} å¤„ä¸ä¸€è‡´`);
						toast(`å·²åŒæ­¥æˆ¿é—´æ•°æ®ï¼Œä¿®å¤ ${syncResult.fixed} å¤„ä¸ä¸€è‡´`, 'success');
					} else {
						logInfo('[Bootstrap] åŒè¡¨æ•°æ®ä¸€è‡´ï¼Œæ— éœ€ä¿®å¤');
					}
				} else {
					logWarn(`[Bootstrap] åŒè¡¨åŒæ­¥å¤±è´¥: ${syncResult.error}`);
				}
			} catch (error) {
				logErr('[Bootstrap] åŒè¡¨åŒæ­¥å¼‚å¸¸:', error.message);
			}
		}
		
		rebuildIndexes(); 
		rebuildStudentIndex(); 
		// ğŸ• æ¢å¤è®¡æ—¶å™¨çŠ¶æ€ï¼ˆåœ¨æ¸²æŸ“ä¹‹å‰ï¼‰
		await restoreRoomTimerStates();
		
		// ğŸ“‹ è§„èŒƒåŒ–åˆå§‹æ•°æ®æ ¼å¼ï¼Œé¿å…è¿è¡ŒæœŸé—´çš„æ ¼å¼è­¦å‘Š
		normalizeInitialData();
		
		renderRooms(); 
		updateUsageStats(); 
		bindRoomEvents(); 
		bindStudentModal(); 
		bindAddRoomModal();
		initSearch(); 
		startStatusTicker(); 
		
		// åªåœ¨Supabaseå°±ç»ªæ—¶è®¾ç½®å®æ—¶åŒæ­¥
		if (supabaseReady) {
			// ğŸ• åˆå§‹åŒ–æœåŠ¡å™¨æ—¶é—´åŒæ­¥
			await serverTimeSync.init();
			
			await setupRealtime();
			// å¯åŠ¨å®šæœŸçŠ¶æ€æ£€æŸ¥
			startPeriodicStateCheck();
			// å¯åŠ¨æ“ä½œè¶…æ—¶æ£€æµ‹
			setupOperationTimeoutDetection();
			// å¯åŠ¨realtimeè¿æ¥ç›‘æ§
			realtimeMonitor.start();
			
			// ğŸ• å¯åŠ¨å®šæœŸè®¡æ—¶å™¨çŠ¶æ€åŒæ­¥ï¼ˆæ¯5åˆ†é’Ÿï¼‰
			timerManager.setInterval('timerStateSync', () => {
				timerPersistence.syncStatesToCloud();
			}, 5 * 60 * 1000);
			
			// ğŸ”§ å¯åŠ¨å®šæœŸåŒè¡¨åŒæ­¥æ£€æŸ¥ï¼ˆæ¯10åˆ†é’Ÿï¼‰
			timerManager.setInterval('roomTableSync', async () => {
				logInfo('â° å®šæœŸåŒè¡¨åŒæ­¥æ£€æŸ¥...');
				try {
					const result = await forceSyncRoomTables();
					if (result.success && result.fixed > 0) {
						logWarn(`å®šæœŸåŒæ­¥å‘ç° ${result.fixed} å¤„ä¸ä¸€è‡´ï¼Œå·²ä¿®å¤`);
						toast(`è‡ªåŠ¨åŒæ­¥ä¿®å¤äº† ${result.fixed} å¤„æˆ¿é—´æ•°æ®`, 'info');
					}
				} catch (error) {
					logErr('å®šæœŸåŒè¡¨åŒæ­¥å¤±è´¥:', error.message);
				}
			}, 10 * 60 * 1000);
			
			// ğŸ”§ æ–°å¢ï¼šè¿æ¥å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨æ¢å¤æœºåˆ¶
			timerManager.setInterval('connectionHealthCheck', async () => {
				// æ£€æŸ¥ Supabase å®¢æˆ·ç«¯æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
				if (!supabaseClient || !supabaseReady) {
					logWarn('[HealthCheck] Supabase å®¢æˆ·ç«¯å¤±æ•ˆï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–...');
					try {
						await initSupabase();
						if (supabaseReady) {
							logInfo('[HealthCheck] Supabase é‡æ–°åˆå§‹åŒ–æˆåŠŸ');
							// é‡æ–°å»ºç«‹ Realtime è¿æ¥
							window.__roomsRealtimeInit = false;
							await setupRealtime();
						}
					} catch (error) {
						logErr('[HealthCheck] Supabase é‡æ–°åˆå§‹åŒ–å¤±è´¥:', error.message);
					}
					return;
				}
				
				// æ£€æŸ¥ Realtime è¿æ¥çŠ¶æ€
				if (realtimeChannel) {
					const channelState = realtimeChannel.state;
					if (channelState === 'closed' || channelState === 'errored') {
						logWarn(`[HealthCheck] Realtime è¿æ¥çŠ¶æ€å¼‚å¸¸ (${channelState})ï¼Œå°è¯•é‡è¿...`);
						window.__roomsRealtimeInit = false;
						window.__roomsRealtimeReconnecting = true;
						await setupRealtime();
					}
				} else {
					// Realtime é¢‘é“ä¸¢å¤±ï¼Œå°è¯•é‡å»º
					logWarn('[HealthCheck] Realtime é¢‘é“ä¸¢å¤±ï¼Œå°è¯•é‡å»º...');
					window.__roomsRealtimeInit = false;
					await setupRealtime();
				}
			}, 30 * 1000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡è¿æ¥å¥åº·çŠ¶æ€
		}
		
		logInfo('åˆå§‹åŒ–å®Œæˆ: rooms='+rooms.length+' students='+students.length);
		// å…œåº•ï¼šå¦‚æœå·²ç™»å½•ä½†æŒ‰é’®è¢«å…¶å®ƒé€»è¾‘è¦†ç›–éšè—ï¼Œå†æ¬¡æ˜¾ç¤ºï¼ˆå‡½æ•°å¯èƒ½è¢«ç§»é™¤ï¼Œåšå®‰å…¨åˆ¤å®šï¼‰
		if(typeof showBulkTimeButton === 'function'){
			try{ showBulkTimeButton(); }catch(e){ console.warn('showBulkTimeButton è°ƒç”¨å¤±è´¥', e); }
		}

		// ABæ–¹æ¡ˆ-A: bootstrap å®Œæˆåå°è¯•ä¸€æ¬¡å­¦ç”Ÿåº“ç§å­å¡«å……ï¼ˆä»…å½“å­¦ç”Ÿåº“å­˜åœ¨ä¸”å½“å‰ä¸ºç©ºï¼‰
		if(window.seedStudentLibraryFromRoomStore){ try{ window.seedStudentLibraryFromRoomStore({ reason:'bootstrap-end' }); }catch(e){ console.warn('[SeedStudentLibrary] bootstrap è°ƒç”¨å¤±è´¥', e); } }
	}

	window.RoomStore=Store; window.assignRoom=assignRoom; window.forceAssignRoom=forceAssignRoom; window.transferStudent=transferStudent; window.clearRoom=clearRoom; window.renewRoom=renewRoom; window.toggleEditMode=toggleEditMode; window.manualSyncToCloud=manualSyncToCloud; window.DataConsistencyValidator=DataConsistencyValidator; 
	
	// æš´éœ²è°ƒè¯•å‡½æ•°
	window.debugRoomStatus = (roomName) => realtimeMonitor.debugRoomStatus(roomName);
	
	// ğŸ§ª æµ‹è¯•æ—¶é—´æ®µæ£€æµ‹å¼¹çª—çš„å‡½æ•°
	window.testPracticeTimeConfirm = function() {
		const mockSlotInfo = {
			slots: [
				{ start: 480, end: 540 },  // 8:00-9:00
				{ start: 840, end: 900 },  // 14:00-15:00
				{ start: 1140, end: 1200 } // 19:00-20:00
			]
		};
		return showPracticeTimeConfirm('æµ‹è¯•å­¦ç”Ÿ', mockSlotInfo);
	}; 
	
	// å¿«é€Ÿæµ‹è¯•æ•°æ®åº“è¿æ¥çš„è°ƒè¯•å‡½æ•°
	window.testDbConnection = async function() {
		if (!supabaseReady) {
			console.log('âŒ Supabase æœªå°±ç»ª');
			return;
		}
		try {
			console.log('ğŸ”„ æµ‹è¯•æˆ¿é—´æ•°æ®æŸ¥è¯¢...');
			const { data, error } = await supabaseClient.from('rooms').select('name,occupant_student_name,version').limit(3);
			if (error) {
				console.error('âŒ æŸ¥è¯¢å¤±è´¥:', error);
				return false;
			}
			console.log('âœ… æŸ¥è¯¢æˆåŠŸ:', data);
			return true;
		} catch (err) {
			console.error('âŒ è¿æ¥å¼‚å¸¸:', err);
			return false;
		}
	};

	// ç›´æ¥è°ƒç”¨ bootstrap æ”¹ä¸ºå—ç™»å½•æ§åˆ¶
	// bootstrap();
	// ç™»å½•é—¨æ§é€»è¾‘ï¼ˆçº¯å‰ç«¯å›ºå®šå¯†ç ï¼‰æ”¹ä¸ºï¼šAPP_PASS_HASH = SHA256(æ˜æ–‡å¯†ç ) æ— ç›
	const PLAIN_PASS = 'ymsq2022';
	let APP_PASS_HASH = '';
	let appBooted = false;
	function sha256Hex(str){
		return crypto.subtle.digest('SHA-256', new TextEncoder().encode(str)).then(buf=>{
			return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
		});
	}
	function showLogin(){ document.getElementById('authOverlay').style.display='flex'; }
	function hideLogin(){ document.getElementById('authOverlay').style.display='none'; }
	// å·²ç§»é™¤ç™»å‡ºæŒ‰é’®é€»è¾‘
	async function tryAuto(){
		if(localStorage.getItem('yms_auth')==='1'){
			hideLogin(); if(!appBooted){ appBooted=true; bootstrap(); }
		}else{
			showLogin();
		}
	}
	async function handleLogin(e){
		e.preventDefault();
		const pwd=document.getElementById('loginPassword').value.trim();
		const btn=document.getElementById('loginBtn');
		const msg=document.getElementById('loginMsg');
		btn.disabled=true; msg.textContent='éªŒè¯ä¸­...';
		try{
			const ok = await verifyPassword(pwd);
			if(ok){
				localStorage.setItem('yms_auth','1');
				hideLogin(); if(!appBooted){ appBooted=true; bootstrap(); }
				msg.textContent='';
			}else{
				msg.textContent='å¯†ç é”™è¯¯';
			}
		}finally{
			btn.disabled=false;
		}
	}
	// logout å…¥å£ç§»é™¤ï¼Œä»ä¿ç•™å‡½æ•°ä»¥é˜²å¤–éƒ¨å¼•ç”¨
	function logout(){ localStorage.removeItem('yms_auth'); appBooted=false; showLogin(); }
	async function verifyPassword(pwd){
		if(!pwd) return false;
		// è‹¥ hash è¿˜æœªå‡†å¤‡ï¼Œç­‰å¾…
		let waitCount=0; while(!APP_PASS_HASH && waitCount<100){ await new Promise(r=>setTimeout(r,30)); waitCount++; }
		const h = await sha256Hex(pwd);
		return h===APP_PASS_HASH;
	}
	// é¢„è®¡ç®—æ— ç›å“ˆå¸Œ
	sha256Hex(PLAIN_PASS).then(h=>{ APP_PASS_HASH=h; console.log('APP_PASS_HASH(unsalted)=',h); });
	// å»¶è¿Ÿåˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œç¡®ä¿ DOM å·²æœ‰é®ç½©
	setTimeout(tryAuto,0);
	document.addEventListener('DOMContentLoaded', ()=>{
		try{ restoreSilenced(); }catch(_e){}
		const f=document.getElementById('loginForm');
		if(f && !f.dataset.bound){ f.dataset.bound='1'; f.addEventListener('submit', handleLogin); }
	});

	</script>

	<!-- ç™»å½•é®ç½© -->
	<div id="authOverlay" style="display:none;position:fixed;inset:0;z-index:9999;font-family:inherit;background:radial-gradient(circle at 30% 35%,#1d2530 0%,#0a0f14 70%);backdrop-filter:blur(14px);">
		<div class="login-shell">
			<div class="login-panel">
				<div class="brand-line">
					<div class="logo-mark">ğŸ¹</div>
					<div class="brand-text">
						<h1>ç´æˆ¿ç®¡ç†ç³»ç»Ÿ</h1>
						<span class="sub">Yehudi Menuhin School</span>
					</div>
				</div>
				<form id="loginForm" autocomplete="off" onsubmit="handleLogin(event)">
					<label class="field">
						<span class="label">å¯†ç </span>
						<input id="loginPassword" type="password" inputmode="text" autocomplete="new-password" placeholder="è¾“å…¥è®¿é—®å¯†ç " required />
					</label>
					<button id="loginBtn" type="submit" class="login-btn">è¿›å…¥ç³»ç»Ÿ</button>
					<div id="loginMsg" class="login-msg" aria-live="polite"></div>
					<div class="hint">å†…éƒ¨ä¸“ç”¨å¹³å° â€¢ æœªæˆæƒè¯·å‹¿ä¼ æ’­</div>
				</form>
			</div>
			<div class="login-footer">Â© <span id="yearNow"></span> YMS Practice Rooms</div>
		</div>
	</div>

	<style>
	/* ç™»å½•ç•Œé¢ä¸“ä¸šç®€çº¦é£æ ¼ */
	#authOverlay{color:#d8e1e9;}
	#authOverlay .login-shell{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;}
	#authOverlay .login-panel{width:360px;max-width:92vw;padding:42px 40px 38px;background:linear-gradient(145deg,rgba(34,44,56,0.85),rgba(20,26,34,0.9));border:1px solid rgba(255,255,255,0.06);border-radius:22px;box-shadow:0 8px 42px -12px rgba(0,0,0,0.55),0 18px 80px -30px rgba(0,0,0,0.6);backdrop-filter:blur(10px);}
	#authOverlay .brand-line{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;margin-bottom:28px;text-align:center;}
	#authOverlay .logo-mark{width:54px;height:54px;border-radius:16px;background:linear-gradient(135deg,#2d72c4,#38518a 60%,#1c2d44);display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 4px 18px -6px rgba(45,114,196,.55),0 2px 6px -2px rgba(0,0,0,.55);margin:0 auto;}
	#authOverlay .brand-text{text-align:center;}
	#authOverlay .brand-text h1{margin:0;font-size:22px;font-weight:600;letter-spacing:.5px;background:linear-gradient(90deg,#c5d9f2,#ffffff);background-clip:text;-webkit-background-clip:text;color:transparent;}
	#authOverlay .brand-text .sub{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:#7f8c98;display:inline-block;margin-top:4px;}
	#authOverlay form{display:flex;flex-direction:column;gap:20px;}
	#authOverlay .field{display:flex;flex-direction:column;gap:8px;}
	#authOverlay .field .label{font-size:13px;letter-spacing:.5px;color:#9fb1c0;font-weight:500;}
	#authOverlay .field, #authOverlay .field .label, #authOverlay .login-msg{ text-align:center; }
	#authOverlay input{background:#12181f;border:1px solid #2a3945;border-radius:14px;padding:14px 16px;font-size:15px;color:#e6edf3;outline:none;transition:.25s;font-family:inherit;}
	#authOverlay input:focus{border-color:#3d7bdc;box-shadow:0 0 0 1px #3d7bdc40,0 4px 18px -6px rgba(61,123,220,.35);}
	#authOverlay input::placeholder{color:#5b6a75;}
	#authOverlay .login-btn{background:linear-gradient(90deg,#2d72c4,#3f85e1);border:1px solid #3778d6;border-radius:14px;padding:14px 0;font-size:15px;font-weight:600;color:#fff;cursor:pointer;transition:.28s;box-shadow:0 6px 20px -8px rgba(47,118,195,.55);display:flex;align-items:center;justify-content:center;letter-spacing:.5px;}
	#authOverlay .login-btn:hover{filter:brightness(1.07);transform:translateY(-2px);box-shadow:0 10px 26px -10px rgba(47,118,195,.65);}
	#authOverlay .login-btn:active{transform:translateY(0);}
	#authOverlay .login-btn:disabled{opacity:.55;cursor:not-allowed;}
	#authOverlay .login-msg{min-height:18px;font-size:13px;color:#ff7a7a;font-weight:500;}
	#authOverlay .hint{margin-top:-6px;font-size:11px;letter-spacing:.5px;color:#667582;text-align:center;}
	#authOverlay .login-footer{margin-top:40px;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:#46515a;}
	@media (max-width:520px){#authOverlay .login-panel{padding:34px 30px 30px;width:330px;border-radius:20px;}#authOverlay .logo-mark{width:50px;height:50px;font-size:24px;}#authOverlay .brand-text h1{font-size:20px;}}
	</style>

	<script>
	// ç™»å½•ç•Œé¢å¹´ä»½è‡ªåŠ¨
	document.addEventListener('DOMContentLoaded',()=>{ const y=document.getElementById('yearNow'); if(y) y.textContent=new Date().getFullYear(); });
	// ç»‘å®šç™»å½• + å›è½¦
	document.addEventListener('DOMContentLoaded',()=>{
		const f=document.getElementById('loginForm');
		if(!f) return;
		f.addEventListener('submit', handleLogin);
		document.getElementById('loginPassword').addEventListener('keydown',e=>{ if(e.key==='Enter'){ f.requestSubmit(); }});
	});
	</script>

<!-- unified final contrast & empty-room enhancement (moved inside body) -->
<style id="room-card-contrast-final">
/* æå‡æ•´ä½“æ–‡æœ¬ä¸ç©ºé—²æˆ¿å¡å¯è§åº¦ï¼›é›†ä¸­å”¯ä¸€è¦†ç›–ï¼Œé¿å…å¤šå±‚å†²çª */
body{--text:#e2ebf3; --text-dim:#a5b6c6;}
.room-card{color:#eef5fa !important;}
.room-card .room-name{color:#ffffff !important; text-shadow:0 1px 3px rgba(0,0,0,.55) !important; font-weight:700 !important;}
.room-card .occupant-line span:last-child{color:#fff !important; font-weight:600 !important;}

/* ä½¿ç”¨ä¸­æˆ¿é—´ï¼šæŒ‰ç±»å‹ç€è‰²å¹¶å¢åŠ æ›´æ·±å±‚æ¬¡å…‰å½± */
.room-card[data-status="occupied"]{position:relative;transition:transform .28s ease, box-shadow .35s ease, border-color .35s ease;}
/* grand (è“) */
.room-card[data-status="occupied"][data-type="grand"]{
	background:linear-gradient(145deg,#1b2937 0%,#152534 42%,#0e1823 100%) !important;
	border:1px solid #4a90e2 !important;
	box-shadow:
		0 0 0 1px rgba(74,144,226,0.35),
		0 4px 14px -3px rgba(0,0,0,0.65),
		0 8px 32px -6px rgba(30,80,130,0.45),
		0 14px 54px -10px rgba(30,80,130,0.38),
		inset 0 1px 0 rgba(255,255,255,0.05),
		inset 0 0 0 1px rgba(74,144,226,0.18) !important;
}
.room-card[data-status="occupied"][data-type="grand"]:hover{
	border-color:#5fa3ff !important;
	box-shadow:
		0 0 0 1px rgba(95,163,255,0.5),
		0 6px 20px -4px rgba(0,0,0,0.7),
		0 10px 40px -8px rgba(60,120,190,0.55),
		0 18px 70px -12px rgba(60,120,190,0.45),
		inset 0 1px 0 rgba(255,255,255,0.07),
		inset 0 0 0 1px rgba(95,163,255,0.25) !important;
	transform:translateY(-5px) !important;
}
.room-card[data-status="occupied"][data-type="grand"] .chip{background:rgba(74,144,226,0.18) !important; color:#87bfff !important; border:1px solid rgba(74,144,226,0.45) !important; font-weight:600 !important;}
/* upright (ç»¿) */
.room-card[data-status="occupied"][data-type="upright"]{
	background:linear-gradient(145deg,#163b2d 0%,#123126 42%,#0c2219 100%) !important;
	border:1px solid #2aa876 !important;
	box-shadow:
		0 0 0 1px rgba(42,168,118,0.35),
		0 4px 14px -3px rgba(0,0,0,0.65),
		0 8px 30px -6px rgba(24,110,80,0.45),
		0 14px 52px -10px rgba(24,110,80,0.38),
		inset 0 1px 0 rgba(255,255,255,0.05),
		inset 0 0 0 1px rgba(42,168,118,0.18) !important;
}
.room-card[data-status="occupied"][data-type="upright"]:hover{
	border-color:#37c28e !important;
	box-shadow:
		0 0 0 1px rgba(55,194,142,0.5),
		0 6px 20px -4px rgba(0,0,0,0.7),
		0 10px 40px -8px rgba(40,150,110,0.55),
		0 18px 70px -12px rgba(40,150,110,0.45),
		inset 0 1px 0 rgba(255,255,255,0.07),
		inset 0 0 0 1px rgba(55,194,142,0.25) !important;
	transform:translateY(-5px) !important;
}
.room-card[data-status="occupied"][data-type="upright"] .chip{background:rgba(42,168,118,0.20) !important; color:#49d69b !important; border:1px solid rgba(42,168,118,0.45) !important; font-weight:600 !important;}
/* other (ç´«) */
.room-card[data-status="occupied"][data-type="other"]{
	background:linear-gradient(145deg,#3a244d 0%,#301d43 42%,#211430 100%) !important;
	border:1px solid #8a63d8 !important;
	box-shadow:
		0 0 0 1px rgba(138,99,216,0.36),
		0 4px 14px -3px rgba(0,0,0,0.65),
		0 8px 32px -6px rgba(90,50,160,0.48),
		0 14px 56px -10px rgba(90,50,160,0.40),
		inset 0 1px 0 rgba(255,255,255,0.05),
		inset 0 0 0 1px rgba(138,99,216,0.20) !important;
}
.room-card[data-status="occupied"][data-type="other"]:hover{
	border-color:#a37dff !important;
	box-shadow:
		0 0 0 1px rgba(163,125,255,0.55),
		0 6px 20px -4px rgba(0,0,0,0.7),
		0 10px 42px -8px rgba(125,80,220,0.55),
		0 18px 70px -12px rgba(125,80,220,0.45),
		inset 0 1px 0 rgba(255,255,255,0.07),
		inset 0 0 0 1px rgba(163,125,255,0.28) !important;
	transform:translateY(-5px) !important;
}
.room-card[data-status="occupied"][data-type="other"] .chip{background:rgba(138,99,216,0.20) !important; color:#c3a4ff !important; border:1px solid rgba(138,99,216,0.48) !important; font-weight:600 !important;}

/* è¶…æ—¶æˆ¿é—´ï¼šçº¢è‰²è­¦å‘Šè¾¹æ¡†ä¸å‘å…‰ */
.room-card[data-status="overtime"]{
	background:linear-gradient(135deg,#4a2728 0%,#3d1f20 40%,#2a1415 100%) !important;
	border:1px solid #ff4757 !important;
	box-shadow:
		0 0 0 1px rgba(255,71,87,0.4),
		0 2px 12px rgba(255,71,87,0.15),
		0 6px 25px rgba(255,71,87,0.08),
		inset 0 1px 0 rgba(255,255,255,0.05) !important;
}
.room-card[data-status="overtime"]:hover{
	border-color:#ff6b7a !important;
	box-shadow:
		0 0 0 1px rgba(255,107,122,0.5),
		0 3px 16px rgba(255,71,87,0.25),
		0 8px 35px rgba(255,71,87,0.12),
		inset 0 1px 0 rgba(255,255,255,0.08) !important;
	transform:translateY(-4px) !important;
}
.room-card[data-status="overtime"] .chip{
	background:rgba(255,71,87,0.15) !important;
	color:#ff7373 !important;
	border:1px solid rgba(255,71,87,0.3) !important;
	font-weight:600 !important;
}

/* ç©ºé—²æˆ¿ï¼šå»é™¤äº®è¾¹ç¼˜/å‘å…‰ï¼Œä¿æŒç±»å‹åŒºåˆ†ï¼Œæ•´ä½“æ›´æš—æ›´å¹³ */
.room-card[data-status="empty"], .room-card.empty{
	/* æ›´é€æ˜ã€é™ä½é¥±å’Œåº¦ï¼šç»Ÿä¸€ææµ…åº•ï¼Œå¸¦è½»å¾®è‰²è°ƒ */
	background:linear-gradient(135deg, rgba(255,255,255,0.015) 0%, rgba(255,255,255,0.03) 60%, rgba(255,255,255,0.02) 100%) !important;
	border:1px solid rgba(160,170,190,0.15) !important;
	box-shadow:none !important;
}
/* æŒ‰ç±»å‹æä¾›æè½»çš„è‰²å½©å€¾å‘ï¼ˆalpha å¾ˆä½ï¼‰ */
.room-card[data-status="empty"][data-type="grand"], .room-card.empty[data-type="grand"]{
	background:linear-gradient(135deg, rgba(60,110,170,0.10) 0%, rgba(40,70,110,0.08) 55%, rgba(25,45,70,0.10) 100%) !important;
	border-color:rgba(90,140,200,0.28) !important;
}
.room-card[data-status="empty"][data-type="upright"], .room-card.empty[data-type="upright"]{
	background:linear-gradient(135deg, rgba(40,140,100,0.10) 0%, rgba(30,90,70,0.08) 55%, rgba(20,60,45,0.10) 100%) !important;
	border-color:rgba(60,170,125,0.28) !important;
}
.room-card[data-status="empty"][data-type="other"], .room-card.empty[data-type="other"]{
	background:linear-gradient(135deg, rgba(120,70,180,0.11) 0%, rgba(90,50,140,0.08) 55%, rgba(65,40,110,0.10) 100%) !important;
	border-color:rgba(130,90,190,0.30) !important;
}
.room-card[data-status="empty"]:hover{transform:translateY(-2px) !important;}
.room-card[data-status="empty"] .chip{background:rgba(255,255,255,0.05) !important; border:1px solid rgba(255,255,255,0.12) !important; color:#d0d9e2 !important;}

/* çŠ¶æ€è‰²å¾®è°ƒ */
.chip{color:#cfd8e2 !important;}
.chip.accent{color:#7fbaff !important;}
.chip.danger{color:#ff7373 !important;}
.chip.good{color:#5edc7a !important;}
.chip.warn{color:#ffbc55 !important;}
</style>

<!-- æ‰¹é‡æ—¶é—´æ®µç®¡ç†æ ·å¼ -->
<style>
#bulkTimeManagerModal .btm-wrapper{width:90%;height:90%;margin:auto;background:#fff;border-radius:16px;display:flex;flex-direction:column;box-shadow:0 6px 30px rgba(0,0,0,.25);overflow:hidden;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;color:#1a1a1a;}
#bulkTimeManagerModal .btm-header{flex:0 0 auto;padding:14px 20px;background:linear-gradient(135deg,#007AFF,#5856D6);color:#fff;display:flex;justify-content:space-between;align-items:center;}
#bulkTimeManagerModal .btm-title{font-size:18px;font-weight:700;letter-spacing:.5px;color:#fff;}
#bulkTimeManagerModal .btm-actions{display:flex;gap:10px;flex-wrap:wrap;}
#bulkTimeManagerModal .btm-btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;letter-spacing:.5px;transition:.25s;color:#fff;}
#bulkTimeManagerModal .btm-primary{background:#007AFF;}
#bulkTimeManagerModal .btm-secondary{background:#4e5d78;}
#bulkTimeManagerModal .btm-danger{background:#e74c3c;}
#bulkTimeManagerModal .btm-btn:hover{opacity:.9;transform:translateY(-2px);}
#bulkTimeManagerModal .btm-body{flex:1;display:flex;overflow:hidden;background:#f2f5f9;color:#1a1a1a;}
#bulkTimeManagerModal .btm-left{flex:1;display:flex;flex-direction:column;padding:16px;overflow:hidden;}
#bulkTimeManagerModal .btm-right{width:320px;border-left:1px solid #eee;padding:16px;display:flex;flex-direction:column;gap:12px;background:#f8f9fb;}
#bulkTimeManagerModal .btm-stu-info{font-size:13px;color:#2c3e50;margin-bottom:10px;line-height:1.5;min-height:32px;font-weight:500;}
#bulkTimeManagerModal .btm-legend{display:flex;gap:18px;flex-wrap:wrap;font-size:12px;color:#1a1a1a;padding:8px 10px;background:#f2f5f9;border:1px solid #e0e4ea;border-radius:8px;margin-bottom:10px;font-weight:500;}
#bulkTimeManagerModal .btm-table-wrap{flex:1;overflow:auto;border:1px solid #e0e4ea;border-radius:10px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05) inset;}
#bulkTimeManagerModal .btm-table{width:100%;border-collapse:separate;border-spacing:0;min-width:900px;font-size:12px;user-select:none;}
#bulkTimeManagerModal .btm-table thead th{background:#f0f3f7;position:sticky;top:0;z-index:2;padding:10px 8px;font-weight:700;border-bottom:1px solid #d6dae2;color:#1a1a1a;}
#bulkTimeManagerModal .btm-time-col{width:120px;}
#bulkTimeManagerModal .btm-table tbody td{text-align:center;padding:8px 6px;border-bottom:1px solid #eef1f5;border-right:1px solid #eef1f5;position:relative;line-height:1.3;transition:all .25s ease;cursor:pointer;font-weight:500;color:#1a1a1a;}
#bulkTimeManagerModal .btm-table tbody td:last-child{border-right:none;}
#bulkTimeManagerModal .btm-table tbody tr:last-child td{border-bottom:none;}
#bulkTimeManagerModal .btm-cell:not(.btm-cell-selected):not(.btm-cell-rest){background:#fff;color:#1a1a1a;border-color:#eef1f5;}
#bulkTimeManagerModal .btm-cell:hover:not(.btm-cell-rest):not(.btm-cell-selected){background:#e6f1ff;border-color:#b1d3ff;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,122,255,.15);z-index:1;color:#1a1a1a;}
#bulkTimeManagerModal .btm-cell-selected{background:linear-gradient(135deg,#007AFF,#5856D6);color:#fff;font-weight:700;border-color:#3366cc;box-shadow:0 2px 6px rgba(0,0,0,.15) inset;}
#bulkTimeManagerModal .btm-cell-rest{background:linear-gradient(135deg,#6C757D,#495057);color:#fff;cursor:not-allowed;font-weight:600;border-color:#495057;}
#bulkTimeManagerModal .btm-cell-selected:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 3px 10px rgba(0,122,255,0.25);}
#bulkTimeManagerModal .btm-cell-rest:hover{transform:none;box-shadow:none;opacity:.8;}
#bulkTimeManagerModal .btm-wed-subwrap{display:flex;flex-direction:column;gap:2px;}
#bulkTimeManagerModal .btm-wed-sub{flex:1;padding:4px 2px;border:1px solid #eef1f5;border-radius:4px;transition:all .25s ease;cursor:pointer;font-weight:500;background:#fff;color:#1a1a1a;text-align:center;display:flex;align-items:center;justify-content:center;min-height:20px;}
#bulkTimeManagerModal .btm-wed-sub:hover:not(.rest):not(.selected){background:#e6f1ff;border-color:#b1d3ff;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,122,255,.15);color:#1a1a1a;}
#bulkTimeManagerModal .btm-wed-sub.selected{background:linear-gradient(135deg,#007AFF,#5856D6);color:#fff;font-weight:700;border-color:#3366cc;box-shadow:0 2px 6px rgba(0,0,0,.15) inset;}
#bulkTimeManagerModal .btm-wed-sub.rest{background:linear-gradient(135deg,#6C757D,#495057);color:#fff;cursor:not-allowed;font-weight:600;border-color:#495057;}
#bulkTimeManagerModal .btm-selected-list{flex:1;overflow:auto;background:#fff;border:1px solid #e0e4ea;border-radius:10px;padding:10px;font-size:12px;line-height:1.5;display:flex;flex-direction:column;gap:6px;color:#1a1a1a;}
#bulkTimeManagerModal .btm-chip{display:inline-block;background:#007aff22;border:1px solid #007aff88;color:#007AFF;padding:3px 8px;border-radius:14px;font-size:11px;margin:2px;font-weight:600;cursor:default;}
#bulkTimeManagerModal .btm-chip.wed{background:#5856d622;border-color:#5856d6aa;color:#4b49c8;}
#bulkTimeManagerModal .btm-note{font-size:11px;line-height:1.6;background:#fff9e6;border:1px solid #ffe3a3;padding:10px 12px;border-radius:8px;color:#8a6113;}
#bulkTimeManagerModal .btm-summary-title{font-size:14px;font-weight:600;color:#1a1a1a;margin-bottom:8px;}
#bulkTimeManagerModal .btm-select{background:#fff;border:1px solid #d1d5db;color:#1a1a1a;padding:8px 12px;border-radius:6px;font-size:13px;}
#bulkTimeManagerModal .btm-select:focus{outline:none;border-color:#007AFF;box-shadow:0 0 0 2px rgba(0,122,255,0.2);}
#bulkTimeManagerModal .btm-save-options{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.15);padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);}
#bulkTimeManagerModal .btm-checkbox-label{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;font-weight:500;color:#fff;user-select:none;}
#bulkTimeManagerModal .btm-checkbox{width:16px;height:16px;border:2px solid rgba(255,255,255,0.6);border-radius:3px;background:transparent;cursor:pointer;appearance:none;position:relative;transition:all 0.2s ease;}
#bulkTimeManagerModal .btm-checkbox:checked{background:#fff;border-color:#fff;}
#bulkTimeManagerModal .btm-checkbox:checked::after{content:'âœ“';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#007AFF;font-size:12px;font-weight:bold;}
#bulkTimeManagerModal .btm-checkbox-text{font-size:12px;letter-spacing:0.3px;}
@media (max-width:1200px){#bulkTimeManagerModal .btm-right{width:280px;}}
@media (max-width:960px){#bulkTimeManagerModal .btm-wrapper{width:96%;height:94%;}#bulkTimeManagerModal .btm-right{display:none;}#bulkTimeManagerModal .btm-left{padding:10px;}}
</style>
<style>
.alert-filter-btn{border:1px solid #d0d7e2;background:#f5f8fc;color:#2e3b48;font-size:12px;padding:5px 12px;border-radius:18px;cursor:pointer;letter-spacing:.5px;font-weight:600;transition:.18s;line-height:1;}
.alert-filter-btn:hover{background:#e1eaf3;color:#1d2730;border-color:#c2ccd8;}
.alert-filter-btn:active{transform:translateY(1px);}
.alert-filter-btn.act{background:#007aff;color:#fff;border-color:#007aff;box-shadow:0 0 0 1px #007aff55 inset;}
.alert-filter-btn.act:hover{background:#0062d1;color:#fff;border-color:#0057bb;}
.alert-filter-btn:focus-visible{outline:2px solid #4d90fe;outline-offset:1px;}

/* ä¼˜åŒ–æé†’æ ·å¼ */
.alert-item {
	border-radius: 6px;
	padding: 8px 10px;
	margin-bottom: 4px;
	position: relative;
	transition: all 0.2s ease;
	border-left: 3px solid transparent;
	background: #fff;
	box-shadow: 0 1px 2px rgba(0,0,0,0.04);
	display: flex;
	align-items: center;
	justify-content: space-between;
	min-height: auto;
}

/* ç¼ºå‹¤æé†’ - æ©™çº¢è‰² */
.alert-item.absent {
	background: #fff8f8;
	border-left-color: #f56565;
}

.alert-item.absent[data-severity="2"] {
	border-left-color: #e53e3e;
	background: #fef1f1;
}

/* å¼‚å¸¸æé†’ - é»„æ©™è‰² */
.alert-item.anomaly {
	background: #fffcf8;
	border-left-color: #ed8936;
}

.alert-item.anomaly[data-severity="1"] {
	border-left-color: #dd6b20;
	background: #fff9f3;
}

/* æ‚¬åœæ•ˆæœ */
.alert-item:hover {
	box-shadow: 0 2px 6px rgba(0,0,0,0.1);
	background-color: #f8f9fa;
}

.alert-item.absent:hover {
	background: #fff6f6;
}

.alert-item.anomaly:hover {
	background: #fffdf8;
}

/* å†…å®¹å¸ƒå±€ - ç´§å‡‘å•è¡Œ */
.alert-content {
	display: flex;
	align-items: center;
	gap: 10px;
	flex: 1;
	min-width: 0;
	overflow: visible;
}

.alert-student {
	font-weight: 600;
	font-size: 13px;
	color: #2d3748;
	white-space: nowrap;
	flex-shrink: 0;
}

.alert-description {
	display: none; /* éšè—æè¿°æ–‡å­— */
}

.alert-info {
	display: flex;
	align-items: center;
	gap: 4px;
	font-size: 12px;
	color: #718096;
	flex-wrap: nowrap;
}

.alert-time {
	font-size: 11px;
	color: #a0aec0;
}

/* æ ‡ç­¾æ ·å¼ - ç´§å‡‘ */
.alert-tag {
	padding: 2px 6px;
	border-radius: 6px;
	font-size: 10px;
	font-weight: 600;
	letter-spacing: 0.3px;
	white-space: nowrap;
}

.alert-tag.type-absent {
	background: #fed7d7;
	color: #c53030;
}

.alert-tag.type-anomaly {
	background: #feebc8;
	color: #c05621;
}

.alert-tag.slot-time {
	background: #e6fffa;
	color: #285e61;
	font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
}

.alert-tag.alert-room {
	background: #bee3f8;
	color: #2c5282;
	font-weight: 700;
	border: 1px solid #90cdf4;
	padding: 2px 8px;
}

/* æ“ä½œæŒ‰é’® - ç´§å‡‘ */
.alert-actions {
	display: flex;
	align-items: center;
	gap: 4px;
	flex-shrink: 0;
}

.alert-btn {
	padding: 3px 8px;
	border: none;
	border-radius: 4px;
	font-size: 10px;
	font-weight: 600;
	cursor: pointer;
	transition: all 0.15s ease;
	white-space: nowrap;
}

.alert-btn.ignore {
	background: #edf2f7;
	color: #4a5568;
	border: 1px solid #cbd5e0;
}

.alert-btn.ignore:hover {
	background: #e2e8f0;
	color: #2d3748;
}

/* å·²å¿½ç•¥çŠ¶æ€ */
.alert-item.ignored {
	opacity: 0.7;
	filter: grayscale(0.2);
}

.alert-ignored-flag {
	font-size: 10px;
	color: #a0aec0;
	margin-left: 8px;
}

/* ä¸€é”®å¿½ç•¥æŒ‰é’® */
.alert-ignore-all-btn {
	padding: 4px 8px;
	border: 1px solid #cbd5e0;
	border-radius: 4px;
	background: #f7fafc;
	color: #4a5568;
	font-size: 11px;
	font-weight: 500;
	cursor: pointer;
	transition: all 0.15s ease;
}

.alert-ignore-all-btn:hover {
	background: #edf2f7;
	border-color: #a0aec0;
	color: #2d3748;
}

.alert-ignore-all-btn:active {
	background: #e2e8f0;
	transform: translateY(1px);
}

.alert-ignore-all-btn:disabled {
	opacity: 0.5;
	cursor: not-allowed;
	pointer-events: none;
}

/* ç©ºçŠ¶æ€ */
.alert-empty {
	text-align: center;
	color: #a0aec0;
	font-style: italic;
	padding: 40px 20px;
	font-size: 14px;
}
</style>

<script>
// ================= æ‰¹é‡æ—¶é—´æ®µç®¡ç† (BTM) =================
(function(){
	if(window.BTM) return;
	function toastLite(m){ if(window.toast) toast(m); else console.log('[BTM]',m); }
	const WEEKDAY_NAMES=['monday','tuesday','wednesday','thursday','friday'];
	const CHINESE_DAY=['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”'];
	function pad2(n){return String(n).padStart(2,'0');}
	function normTime(t){const m=t.match(/^(\d{1,2}):(\d{2})$/); if(!m) return t; return pad2(+m[1])+':'+m[2];}
	function rangeNorm(r){const [a,b]=r.split('-'); return normTime(a)+'-'+normTime(b);}  
	function sameRange(a,b){return rangeNorm(a)===rangeNorm(b);}  
	function minutesDiff(s,e){const [sh,sm]=s.split(':').map(Number); const [eh,em]=e.split(':').map(Number); return (eh*60+em)-(sh*60+sm);}  
	const BTM={
		timeSlots:['8:00-8:50','9:00-9:50','9:40-10:00','10:00-10:50','11:00-11:50','11:50-13:00','13:00-13:50','14:00-14:50','14:50-15:10','15:10-16:00','16:10-17:00','17:10-18:00'],
		wednesdaySlots:['8:00-8:50','9:00-9:50','9:40-10:00','10:00-10:50','11:00-11:50',['11:50-12:50','åˆé—´éŸ³ä¹ä¼š'],['13:30-14:20'],['14:30-15:20'],'15:20-15:40',['15:40-16:30'],['16:40-17:30'],['17:40-18:30']],
		breakIdx:[2,8], lunchIdx:[5],
		students:[], filteredStudents:[], currentIndex:-1, selectionMap:{}, remoteSlots:{},
		dom:{},
		initDom(){this.dom.modal=document.getElementById('bulkTimeManagerModal'); this.dom.tbody=document.getElementById('btmTbody'); this.dom.studentSelect=document.getElementById('btmStudentSelect'); this.dom.selectedList=document.getElementById('btmSelectedList'); this.dom.info=document.getElementById('btmStudentInfo'); this.dom.search=document.getElementById('btmSearchInput');},
		async open(){ if(!window.supabaseClient || (typeof window.supabaseReady!=='undefined' && !window.supabaseReady)){ toastLite('Supabase æœªå°±ç»ª'); return; } this.initDom(); await this.loadRemote(); this.buildStudents(); this.buildSelections(); this.renderTable(); this.applyFilter(); if(this.filteredStudents.length){ this.currentIndex=0; this.dom.studentSelect.value='0'; this.updateInfo(); this.highlight(); this.refreshSelectedList(); } this.dom.modal.style.display='block'; },
		close(){ if(this.dom.modal) this.dom.modal.style.display='none'; },
		async loadRemote(){ this.remoteSlots={}; const {data,error}=await supabaseClient.from('student_time_slots').select('*'); if(error){ console.error(error); if(error.status===401){ toastLite('æœªæˆæƒè®¿é—® student_time_slots (401)ï¼Œè¯·æ£€æŸ¥ Supabase Key / RLS ç­–ç•¥'); } else if(error.code==='42P01'){ toastLite('è¡¨ student_time_slots ä¸å­˜åœ¨'); } else { toastLite('åŠ è½½æ—¶é—´æ®µå¤±è´¥: '+error.message); } return;} (data||[]).forEach(r=>{ const name=r.student_name; if(!this.remoteSlots[name]) this.remoteSlots[name]={monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]}; const day=WEEKDAY_NAMES[r.weekday-1]; if(!day) return; this.remoteSlots[name][day].push({start:normTime(r.start_time), end:normTime(r.end_time)}); }); Object.values(this.remoteSlots).forEach(week=>{ Object.values(week).forEach(arr=>arr.sort((a,b)=>a.start.localeCompare(b.start))); }); },
		buildStudents(){
			if(window.getAllActiveStudents){
				this.students = window.getAllActiveStudents().map(s=>({name:s.name,major:s.major||'',grade:s.grade||''})).sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN'));
			}else{
				this.students = (window.RoomStore?.students||[]).map(s=>({name:s.name,major:s.major||'',grade:s.grade||''})).sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN'));
			}
		},
		buildSelections(){
			this.selectionMap={}; this.originalSelectionMap={};
			this.students.forEach(st=>{ 
				const cur=new Set(); this.selectionMap[st.name]=cur; 
				const week=this.remoteSlots[st.name]; if(!week){ this.originalSelectionMap[st.name]=new Set(); return; }
				WEEKDAY_NAMES.forEach((day,di)=>{ (week[day]||[]).forEach(sl=>{ const key=this.matchSlot(di, sl.start+'-'+sl.end); if(key) cur.add(key); }); });
				// åŸå§‹å¿«ç…§
				this.originalSelectionMap[st.name]=new Set(cur);
			});
		},
		isStudentChanged(name){
			const a=this.selectionMap?.[name]; const b=this.originalSelectionMap?.[name];
			if(!a && !b) return false; if(!a||!b) return true; if(a.size!==b.size) return true; for(const k of a){ if(!b.has(k)) return true; } return false;
		},
		applyFilter(){ const kw=(this.dom.search?.value||'').trim().toLowerCase(); this.filteredStudents=this.students.filter(s=> !kw || (window.matchPinyin?matchPinyin(s.name,kw):s.name.includes(kw))); this.renderStudentSelect(); },
		renderStudentSelect(){ const sel=this.dom.studentSelect; if(!sel) return; sel.innerHTML=this.filteredStudents.map((s,i)=>`<option value="${i}">${s.name} - ${s.major||''}</option>`).join(''); },
		renderTable(){ const tb=this.dom.tbody; if(!tb) return; tb.innerHTML=''; for(let i=0;i<this.timeSlots.length;i++){ const tr=document.createElement('tr'); const timeTd=document.createElement('td'); timeTd.className='btm-cell btm-time-col'; timeTd.textContent=this.timeSlots[i]; tr.appendChild(timeTd); for(let d=0;d<5;d++){ const td=document.createElement('td'); if(d===2){ const w=this.wednesdaySlots[i]; if(typeof w==='string'){ if(this.isRest(i,d,true)){ td.className='btm-cell-rest'; td.textContent=this.breakIdx.includes(i)?'ä¼‘æ¯':'åˆé¤'; } else { td.className='btm-cell'; td.dataset.key=`wed-${i}-0-2`; td.textContent=w; td.onclick=()=>this.toggle(td.dataset.key); } } else { const wrap=document.createElement('div'); wrap.className='btm-wed-subwrap'; w.forEach((sub,si)=>{ const div=document.createElement('div'); const key=`wed-${i}-${si}-2`; div.dataset.key=key; if(this.isSubRest(i,si) || !/\d{1,2}:\d{2}-\d{1,2}:\d{2}/.test(sub)){ div.className='btm-wed-sub rest'; div.textContent=sub==='11:50-12:50'?'åˆé¤':sub; } else { div.className='btm-wed-sub'; div.textContent=sub; div.onclick=()=>this.toggle(key,true); } wrap.appendChild(div); }); td.appendChild(wrap); } } else { if(this.isRest(i,d,false)){ td.className='btm-cell-rest'; td.textContent=this.breakIdx.includes(i)?'ä¼‘æ¯':'åˆé¤'; } else { td.className='btm-cell'; td.dataset.key=`${i}-${d}`; td.textContent=this.timeSlots[i]; td.onclick=()=>this.toggle(td.dataset.key); } } tr.appendChild(td);} tb.appendChild(tr);} },
		isRest(i,day,isWed){ if(isWed){ if(i===2||i===8) return true; if(i===5) return true; } else { if(this.breakIdx.includes(i)) return true; if(this.lunchIdx.includes(i)) return true; } return false; },
		isSubRest(i){ return i===2||i===8||i===5; },
		selectStudent(){ const idx=parseInt(this.dom.studentSelect.value); if(isNaN(idx)) { this.currentIndex=-1; return;} this.currentIndex=idx; this.updateInfo(); this.highlight(); this.refreshSelectedList(); },
		updateInfo(){ if(this.currentIndex<0){ this.dom.info.innerHTML=''; return;} const st=this.filteredStudents[this.currentIndex]; this.dom.info.innerHTML=`<b>å­¦ç”Ÿï¼š</b>${st.name}ã€€<b>ä¸“ä¸šï¼š</b>${st.major||''}ã€€<b>å¹´çº§ï¼š</b>${st.grade||'æœªæŒ‡å®š'}`; },
		toggle(key){ if(this.currentIndex<0) return; const st=this.filteredStudents[this.currentIndex]; const set=this.selectionMap[st.name]; if(set.has(key)) set.delete(key); else set.add(key); this.highlight(); this.refreshSelectedList(); },
		highlight(){ if(this.currentIndex<0) return; const st=this.filteredStudents[this.currentIndex]; const set=this.selectionMap[st.name]; this.dom.tbody.querySelectorAll('.btm-cell').forEach(c=>{ const k=c.dataset.key; if(!k) return; c.classList.toggle('btm-cell-selected', set.has(k)); }); this.dom.tbody.querySelectorAll('.btm-wed-sub:not(.rest)').forEach(s=>{ const k=s.dataset.key; if(!k) return; s.classList.toggle('selected', set.has(k)); }); },
		refreshSelectedList(){ if(!this.dom.selectedList) return; if(this.currentIndex<0){ this.dom.selectedList.innerHTML=''; return;} const st=this.filteredStudents[this.currentIndex]; const set=this.selectionMap[st.name]; if(!set.size){ this.dom.selectedList.innerHTML='<div style="color:#999;font-style:italic;">æš‚æ— é€‰æ‹©</div>'; return;} const groups={0:[],1:[],2:[],3:[],4:[]}; set.forEach(k=>{ if(k.startsWith('wed-')){ const p=k.split('-'); groups[2].push(k); } else { const [ti,di]=k.split('-').map(Number); groups[di].push(k);} }); let html=''; Object.entries(groups).forEach(([d,arr])=>{ if(!arr.length) return; arr.sort(); html+=`<div style="margin-bottom:6px;"><b>${CHINESE_DAY[d]}:</b><br>`; arr.forEach(k=>{ if(k.startsWith('wed-')){ const p=k.split('-'); const ti=parseInt(p[1]); const si=parseInt(p[2]); const slot=this.wednesdaySlots[ti]; const txt=Array.isArray(slot)?slot[si]:slot; if(/\d{1,2}:\d{2}-\d{1,2}:\d{2}/.test(txt)) html+=`<span class="btm-chip wed">${txt}</span>`; } else { const [ti]=k.split('-'); html+=`<span class="btm-chip">${this.timeSlots[ti]}</span>`; } }); html+='</div>'; }); this.dom.selectedList.innerHTML=html; },
		matchSlot(dayIndex,range){ const norm=rangeNorm(range); if(dayIndex===2){ for(let t=0;t<this.wednesdaySlots.length;t++){ const w=this.wednesdaySlots[t]; if(Array.isArray(w)){ for(let s=0;s<w.length;s++){ const seg=w[s]; if(/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(seg) && sameRange(seg,norm)) return `wed-${t}-${s}-2`; } } else { if(/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(w) && sameRange(w,norm)) return `wed-${t}-0-2`; } } return null;} else { for(let i=0;i<this.timeSlots.length;i++){ if(sameRange(this.timeSlots[i],norm)) return `${i}-${dayIndex}`; } return null; } },
		clearAll(){ if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿå½“å‰é€‰æ‹©ï¼Ÿ')) return; Object.values(this.selectionMap).forEach(set=>set.clear()); this.highlight(); this.refreshSelectedList(); toastLite('å·²æ¸…ç©º'); },
		async save(){ 
			if(!supabaseClient){ toastLite('æœªè¿æ¥'); return;} 
			
			// æ£€æŸ¥æ˜¯å¦é€‰æ‹©"ä»…é™ä»Šæ—¥"é€‰é¡¹
			const todayOnlyCheck = document.getElementById('btmTodayOnlyCheck');
			const isTodayOnly = todayOnlyCheck && todayOnlyCheck.checked;
			
			const confirmMsg = isTodayOnly ? 
				'ä¿å­˜å°†è¦†ç›–æ‰€é€‰å­¦ç”Ÿçš„æ—¶é—´æ®µï¼Œä»…åœ¨æœ¬å‘¨ç”Ÿæ•ˆï¼Œä¸‹å‘¨è‡ªåŠ¨æ¢å¤åŸè®¾ç½®ã€‚ç¡®è®¤ç»§ç»­ï¼Ÿ' : 
				'ä¿å­˜å°†è¦†ç›–æ‰€é€‰å­¦ç”Ÿå‘¨ä¸€åˆ°å‘¨äº”çš„å…¨éƒ¨æ—¶é—´æ®µï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ';
			
			if(!confirm(confirmMsg)) return; 
			
			const btn=document.getElementById('btmSaveBtn'); 
			if(btn){ btn.disabled=true; btn.textContent='ä¿å­˜ä¸­...'; }
			
			// åªæ”¶é›†æœ‰å˜æ›´çš„å­¦ç”Ÿ
			const changedStudents = this.students.filter(st=> this.isStudentChanged(st.name));
			if(!changedStudents.length){ if(btn){ btn.disabled=false; btn.textContent='ä¿å­˜'; } toastLite('æ²¡æœ‰å˜æ›´ï¼Œæ— éœ€ä¿å­˜'); return; }
			let changed=0; const errors=[]; const startTs=Date.now(); const total=changedStudents.length;
			
			// æ£€æŸ¥ç°æœ‰æ¢å¤ä»»åŠ¡å¹¶å¤„ç†
			let studentsWithExistingTasks = [];
			let shouldClearAllTasks = false;
			
			// å…ˆæ£€æŸ¥æ‰€æœ‰å˜æ›´å­¦ç”Ÿæ˜¯å¦æœ‰ç°æœ‰æ¢å¤ä»»åŠ¡
			if(btn) btn.textContent='æ£€æŸ¥ç°æœ‰æ¢å¤ä»»åŠ¡...';
			for(const st of changedStudents) {
				try {
					const {data: existingTasks, error: checkError} = await supabaseClient
						.from('student_time_slots_backup')
						.select('*')
						.eq('student_name', st.name)
						.eq('backup_type', 'temp_change')
						.eq('is_restored', false)
						.limit(1);
					
					if(!checkError && existingTasks && existingTasks.length > 0) {
						studentsWithExistingTasks.push({
							student: st,
							task: existingTasks[0]
						});
					}
				} catch(checkErr) {
					console.warn(`æ£€æŸ¥ ${st.name} ç°æœ‰æ¢å¤ä»»åŠ¡å¤±è´¥:`, checkErr);
				}
			}
			
			// å¦‚æœæ˜¯æ°¸ä¹…ä¿å­˜ï¼ˆæœªé€‰æ‹©ä»…é™ä»Šæ—¥ï¼‰ä¸”æœ‰ç°æœ‰ä»»åŠ¡ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦æ¸…ç©º
			if(!isTodayOnly && studentsWithExistingTasks.length > 0) {
				const studentNames = studentsWithExistingTasks.map(item => item.student.name).join('ã€');
				const confirmMsg = `å‘ç° ${studentNames} å·²æœ‰æ¢å¤ä»»åŠ¡ã€‚\n\né€‰æ‹©"ç¡®å®š"å°†æ¸…ç©ºæ‰€æœ‰æ¢å¤ä»»åŠ¡å¹¶æ°¸ä¹…ä¿å­˜ä¿®æ”¹ã€‚\né€‰æ‹©"å–æ¶ˆ"å°†ä¸­æ­¢æœ¬æ¬¡ä¿å­˜æ“ä½œã€‚`;
				
				if(confirm(confirmMsg)) {
					shouldClearAllTasks = true;
					// æ¸…ç©ºæ‰€æœ‰ç›¸å…³çš„æ¢å¤ä»»åŠ¡
					if(btn) btn.textContent='æ¸…ç©ºç°æœ‰æ¢å¤ä»»åŠ¡...';
					for(const item of studentsWithExistingTasks) {
						try {
							await supabaseClient
								.from('student_time_slots_backup')
								.delete()
								.eq('student_name', item.student.name)
								.eq('backup_type', 'temp_change')
								.eq('is_restored', false);
							console.log(`[BTM] å·²æ¸…ç©º ${item.student.name} çš„æ¢å¤ä»»åŠ¡`);
						} catch(deleteErr) {
							console.warn(`æ¸…ç©º ${item.student.name} æ¢å¤ä»»åŠ¡å¤±è´¥:`, deleteErr);
						}
					}
					toastLite(`å·²æ¸…ç©º ${studentNames} çš„æ¢å¤ä»»åŠ¡ï¼Œå°†æ°¸ä¹…ä¿å­˜ä¿®æ”¹`);
				} else {
					// ç”¨æˆ·å–æ¶ˆæ“ä½œ
					if(btn) {
						btn.disabled = false;
						btn.textContent = 'ä¿å­˜';
					}
					return;
				}
			}
			
			// å¦‚æœæ˜¯ä¸´æ—¶ä¿å­˜ï¼ˆé€‰æ‹©ä»…é™ä»Šæ—¥ï¼‰
			let originalBackups = {};
			if(isTodayOnly) {
				if(btn) btn.textContent='å¤„ç†ä¸´æ—¶ä¿å­˜...';
				
				for(const st of changedStudents) {
					const existingTaskItem = studentsWithExistingTasks.find(item => item.student.name === st.name);
					
					if(existingTaskItem) {
						// å·²æœ‰æ¢å¤ä»»åŠ¡ï¼Œä¸åˆ›å»ºæ–°ä»»åŠ¡ï¼Œç›´æ¥ä½¿ç”¨ç°æœ‰çš„åŸå§‹æ•°æ®
						console.log(`[BTM] ${st.name} å·²æœ‰ä¸‹å‘¨æ¢å¤ä»»åŠ¡ï¼Œç›´æ¥æ›´æ–°æœ¬å‘¨ä¸´æ—¶æ•°æ®`);
						originalBackups[st.name] = existingTaskItem.task.original_data || [];
						
						// å¯é€‰ï¼šæ›´æ–°æ¢å¤æ—¶é—´åˆ°ä¸‹å‘¨ä¸€
						try {
							const now = new Date();
							const nextMonday = new Date(now);
							const daysUntilNextMonday = (7 - now.getDay() + 1) % 7 || 7;
							nextMonday.setDate(now.getDate() + daysUntilNextMonday);
							nextMonday.setHours(now.getHours(), now.getMinutes(), 0, 0);
							
							await supabaseClient
								.from('student_time_slots_backup')
								.update({
									restore_time: nextMonday.toISOString(),
									updated_at: new Date().toISOString()
								})
								.eq('id', existingTaskItem.task.id);
							console.log(`[BTM] å·²æ›´æ–° ${st.name} çš„æ¢å¤æ—¶é—´åˆ°ä¸‹å‘¨ä¸€`);
						} catch(updateErr) {
							console.warn('æ›´æ–°æ¢å¤æ—¶é—´å¤±è´¥:', updateErr);
						}
						
					} else {
						// æ²¡æœ‰ç°æœ‰ä»»åŠ¡ï¼Œåˆ›å»ºæ–°çš„æ¢å¤ä»»åŠ¡
						try {
							// æŸ¥è¯¢å½“å‰æ•°æ®ä½œä¸ºåŸå§‹å¤‡ä»½
							const {data: currentData, error} = await supabaseClient
								.from('student_time_slots')
								.select('*')
								.eq('student_name', st.name)
								.in('weekday',[1,2,3,4,5]);
							
							if(error) {
								console.error(`æŸ¥è¯¢ ${st.name} åŸå§‹æ•°æ®å¤±è´¥:`, error);
								continue;
							}
							
							originalBackups[st.name] = currentData || [];
							
							// åˆ›å»ºæ–°çš„æ¢å¤ä»»åŠ¡
							// è®¡ç®—ä¸‹å‘¨ä¸€çš„æ¢å¤æ—¶é—´
							const now = new Date();
							const nextMonday = new Date(now);
							const daysUntilNextMonday = (7 - now.getDay() + 1) % 7 || 7; // è·å–åˆ°ä¸‹å‘¨ä¸€çš„å¤©æ•°
							nextMonday.setDate(now.getDate() + daysUntilNextMonday);
							// è®¾ç½®ä¸ºå½“å‰æ—¶é—´ï¼Œç¡®ä¿åœ¨å·¥ä½œæ—¶é—´æ‰§è¡Œæ¢å¤
							nextMonday.setHours(now.getHours(), now.getMinutes(), 0, 0);
							
							try {
								await supabaseClient
									.from('student_time_slots_backup')
									.insert({
										student_name: st.name,
										weekday: 1, // å ä½å€¼
										start_time: '00:00',
										end_time: '23:59',
										duration_minutes: 0,
										backup_type: 'temp_change',
										restore_time: nextMonday.toISOString(),
										original_data: currentData || [],
										is_restored: false
									});
								console.log(`[BTM] å·²åˆ›å»º ${st.name} çš„ä¸‹å‘¨æ¢å¤ä»»åŠ¡`);
							} catch(serverBackupErr) {
								console.warn('åˆ›å»ºæ¢å¤ä»»åŠ¡å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', serverBackupErr);
								// ä½¿ç”¨localStorageä½œä¸ºå…œåº•æ–¹æ¡ˆ
								const localBackups = JSON.parse(localStorage.getItem('btm_daily_backups') || '{}');
								const backupKey = `temp_restore_${st.name}_${new Date().toISOString().split('T')[0]}`;
								// è®¡ç®—ä¸‹å‘¨ä¸€çš„æ¢å¤æ—¶é—´
								const now = new Date();
								const nextMonday = new Date(now);
								const daysUntilNextMonday = (7 - now.getDay() + 1) % 7 || 7;
								nextMonday.setDate(now.getDate() + daysUntilNextMonday);
								nextMonday.setHours(8, 0, 0, 0);
								
								localBackups[backupKey] = {
									student_name: st.name,
									original_data: currentData || [],
									backup_date: new Date().toISOString(),
									restore_date: nextMonday.toISOString()
								};
								localStorage.setItem('btm_daily_backups', JSON.stringify(localBackups));
							}
						} catch(backupError) {
							console.warn(`å¤‡ä»½ ${st.name} å¤±è´¥:`, backupError);
						}
					}
				}
			}
			
			try {
				let idx=0;
				for(const st of changedStudents){
					idx++;
					// è¿›åº¦æç¤ºï¼ˆé¿å…è¿‡äºé¢‘ç¹ DOM å†™ï¼Œå¯æ¯1äººæ›´æ–°ï¼‰
					if(btn) btn.textContent=`ä¿å­˜ä¸­... (${idx}/${total})`;
					try {
						const set=this.selectionMap[st.name]; if(!set) continue; // ç©ºé›†åˆä¹Ÿä»£è¡¨æ¸…ç©º
						const delRes=await supabaseClient.from('student_time_slots').delete().eq('student_name', st.name).in('weekday',[1,2,3,4,5]);
						if(delRes.error){
							if(delRes.error.status===401) errors.push(`${st.name} åˆ é™¤æœªæˆæƒ(401)`); else errors.push(`${st.name} åˆ é™¤å¤±è´¥:${delRes.error.message}`);
							continue;
						}
						const rows=[]; set.forEach(k=>{ if(k.startsWith('wed-')){ const p=k.split('-'); const ti=+p[1]; const si=+p[2]; const slot=this.wednesdaySlots[ti]; const txt=Array.isArray(slot)?slot[si]:slot; if(!/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(txt)) return; const [s,e]=txt.split('-'); rows.push({student_name:st.name, weekday:3, start_time:normTime(s), end_time:normTime(e), duration_minutes:minutesDiff(s,e)}); } else { const [ti,di]=k.split('-').map(Number); const txt=this.timeSlots[ti]; const [s,e]=txt.split('-'); rows.push({student_name:st.name, weekday:di+1, start_time:normTime(s), end_time:normTime(e), duration_minutes:minutesDiff(s,e)}); } });
						if(rows.length){ const insRes=await supabaseClient.from('student_time_slots').insert(rows); if(insRes.error){ if(insRes.error.status===401) errors.push(`${st.name} æ’å…¥æœªæˆæƒ(401)`); else errors.push(`${st.name} æ’å…¥å¤±è´¥:${insRes.error.message}`); } else { changed++; } }
						else { changed++; }
					} catch(loopErr){ errors.push(`${st.name} å¼‚å¸¸:${loopErr.message||loopErr}`); }
				}
				// éªŒè¯
				let verifyCount='?'; try{ const {data,error}=await supabaseClient.from('student_time_slots').select('id',{count:'exact'}); if(!error){ verifyCount=data.length; } else if(error.status===401){ verifyCount='æœªæˆæƒ'; } }catch(_e){}
				const dur=Date.now()-startTs;
				
				// å¦‚æœæ˜¯"ä»…é™ä»Šæ—¥"ä¸”ä¿å­˜æˆåŠŸï¼Œè®¾ç½®æ¢å¤ä»»åŠ¡
				if(isTodayOnly && changed > 0) {
					this.scheduleRestoreTask(changedStudents, originalBackups);
				}
				
				if(errors.length){ console.error('[BTM Save Errors]', errors); toastLite(`éƒ¨åˆ†å¤±è´¥: ${errors.length} æ¡ï¼›æˆåŠŸ ${changed} äººï¼Œç”¨æ—¶ ${dur}ms`); alert(errors.slice(0,6).join('\n') + (errors.length>6?'\n...':'') ); }
				else if(changed===0){ toastLite('æ²¡æœ‰å¯ä¿å­˜çš„æ›´æ”¹'); }
				else { 
					const successMsg = isTodayOnly ? 
						`ä¿å­˜æˆåŠŸï¼š${changed} äººï¼Œä¸‹å‘¨è‡ªåŠ¨æ¢å¤åŸè®¾ç½® (${dur}ms)` : 
						`ä¿å­˜æˆåŠŸï¼š${changed} äººï¼Œè®°å½•â‰ˆ${verifyCount} (${dur}ms)`;
					toastLite(successMsg); 
					if(btn) btn.textContent='ä¿å­˜æˆåŠŸ'; 
				}
				// åˆ·æ–°æœ¬åœ°æ˜ å°„
				await this.loadRemote(); this.buildSelections(); this.highlight(); this.refreshSelectedList();
				// æ›´æ–°åŸºçº¿ä»¥é¿å…ç«‹å³å†æ¬¡æç¤ºå˜æ›´
				// buildSelections å·²åˆ·æ–° originalSelectionMap
				if(window.PracticeAlerts && PracticeAlerts.refreshSlots){ PracticeAlerts.refreshSlots(true); }
			} catch(fatal){
				console.error('[BTM Save Fatal]', fatal); toastLite('ä¿å­˜è¿‡ç¨‹å‡ºç°å¼‚å¸¸:'+ (fatal.message||fatal));
			} finally {
				if(btn){
					btn.disabled=false;
					// è‹¥ä¸æ˜¯æ˜¾ç¤ºâ€œä¿å­˜æˆåŠŸâ€åˆ™å›é€€åˆ°â€œä¿å­˜â€
					if(btn.textContent!=='ä¿å­˜æˆåŠŸ') btn.textContent='ä¿å­˜'; else setTimeout(()=>{ if(btn.textContent==='ä¿å­˜æˆåŠŸ') btn.textContent='ä¿å­˜'; }, 1500);
				}
			}
		},
		// è°ƒåº¦æ¢å¤ä»»åŠ¡
		scheduleRestoreTask(changedStudents, originalBackups) {
			// è®¡ç®—ä¸‹å‘¨ä¸€çš„æ—¶é—´
			const now = new Date();
			const nextMonday = new Date(now);
			const daysUntilNextMonday = (7 - now.getDay() + 1) % 7 || 7; // è·å–åˆ°ä¸‹å‘¨ä¸€çš„å¤©æ•°
			nextMonday.setDate(now.getDate() + daysUntilNextMonday);
			nextMonday.setHours(8, 0, 0, 0); // ä¸‹å‘¨ä¸€æ—©ä¸Š8ç‚¹æ‰§è¡Œ
			
			const restoreTime = nextMonday.getTime();
			const delay = restoreTime - now.getTime();
			
			console.log(`[BTM] è°ƒåº¦æ¢å¤ä»»åŠ¡ï¼Œå°†åœ¨ ${nextMonday.toLocaleString()} æ‰§è¡Œ`);
			
			// ä¿å­˜æ¢å¤ä»»åŠ¡åˆ° localStorage
			const restoreTasks = JSON.parse(localStorage.getItem('btm_restore_tasks') || '[]');
			const newTask = {
				id: `restore_${Date.now()}`,
				scheduleTime: restoreTime,
				changedStudents: changedStudents.map(s => s.name),
				originalBackups: originalBackups,
				created: now
			};
			restoreTasks.push(newTask);
			localStorage.setItem('btm_restore_tasks', JSON.stringify(restoreTasks));
			
			// è®¾ç½®å®šæ—¶å™¨ï¼ˆå¦‚æœé¡µé¢ä¿æŒæ‰“å¼€ï¼‰
			if(delay > 0 && delay < 24 * 60 * 60 * 1000) { // 24å°æ—¶å†…
				setTimeout(() => {
					this.executeRestoreTask(newTask);
				}, delay);
			}
			
			// ç«‹å³æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ‰§è¡Œçš„æ¢å¤ä»»åŠ¡
			this.checkPendingRestoreTasks();
			this.checkServerRestoreTasks();
			
			// å¦‚æœæ˜¯å‘¨ä¸€æ—©æ™¨ï¼Œé¢å¤–æ‰§è¡Œä¸€æ¬¡å…¨é¢æ£€æŸ¥
			const currentTime = new Date();
			if (currentTime.getDay() === 1 && currentTime.getHours() < 10) {
				console.log('[BTM] æ£€æµ‹åˆ°å‘¨ä¸€æ—©æ™¨ï¼Œæ‰§è¡Œå…¨é¢æ¢å¤ä»»åŠ¡æ£€æŸ¥...');
				setTimeout(() => {
					this.checkPendingRestoreTasks();
					this.checkServerRestoreTasks();
				}, 3000);
			}
		},
		
		// æ£€æŸ¥å¾…æ‰§è¡Œçš„æ¢å¤ä»»åŠ¡ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
		checkPendingRestoreTasks() {
			const tasks = JSON.parse(localStorage.getItem('btm_restore_tasks') || '[]');
			const now = new Date();
			const pendingTasks = tasks.filter(task => {
				const taskTime = new Date(task.scheduleTime);
				return shouldExecuteRestore(taskTime);
			});
			
			if(pendingTasks.length > 0) {
				console.log(`[BTM] å‘ç° ${pendingTasks.length} ä¸ªæœ¬åœ°å¾…æ‰§è¡Œçš„æ¢å¤ä»»åŠ¡`);
				pendingTasks.forEach(task => {
					this.executeRestoreTask(task);
				});
				
				// æ¸…ç†å·²æ‰§è¡Œçš„ä»»åŠ¡
				const remainingTasks = tasks.filter(task => task.scheduleTime > now);
				localStorage.setItem('btm_restore_tasks', JSON.stringify(remainingTasks));
			}
		},
		
		// æ£€æŸ¥æœåŠ¡å™¨ç«¯çš„æ¢å¤ä»»åŠ¡
		async checkServerRestoreTasks() {
			if(!supabaseClient) return;
			
			try {
				const now = new Date();
				
				// è·å–æ‰€æœ‰æœªæ¢å¤çš„ä»»åŠ¡
				const {data: allTasks, error: queryError} = await supabaseClient
					.from('student_time_slots_backup')
					.select('*')
					.eq('backup_type', 'temp_change')
					.eq('is_restored', false);
				
				if(queryError) {
					console.warn('[BTM] æŸ¥è¯¢æ¢å¤ä»»åŠ¡å¤±è´¥:', queryError);
					return;
				}
				
				// ç­›é€‰åº”è¯¥æ‰§è¡Œçš„ä»»åŠ¡
				const backupTasks = allTasks ? allTasks.filter(task => {
					return shouldExecuteRestore(task.restore_time);
				}) : [];
				
				if(backupTasks && backupTasks.length > 0) {
					const currentDay = now.getDay() === 1 ? 'å‘¨ä¸€' : 'ä»Šæ—¥';
					console.log(`[BTM] ${currentDay}å‘ç° ${backupTasks.length} ä¸ªå¾…æ¢å¤ä»»åŠ¡`);
					
					for(const task of backupTasks) {
						try {
							const studentName = task.student_name;
							const originalData = task.original_data || [];
							const restoreTime = new Date(task.restore_time);
							
							console.log(`[BTM] æ‰§è¡Œ ${studentName} çš„æ¢å¤ä»»åŠ¡ (è®¡åˆ’æ—¶é—´: ${restoreTime.toLocaleString()})`);
							
							// æ‰§è¡Œæ¢å¤
							await this.restoreFromServerTask(studentName, originalData);
							
							// æ ‡è®°ä¸ºå·²æ¢å¤
							await supabaseClient
								.from('student_time_slots_backup')
								.update({ is_restored: true })
								.eq('id', task.id);
								
						} catch(taskError) {
							console.error(`[BTM] æ‰§è¡Œ ${task.student_name} æ¢å¤ä»»åŠ¡å¤±è´¥:`, taskError);
						}
					}
					
					// å¦‚æœæ˜¯å‘¨ä¸€ä¸”æœ‰ä»»åŠ¡è¢«æ‰§è¡Œï¼Œæ˜¾ç¤ºç‰¹åˆ«æç¤º
					if(now.getDay() === 1 && backupTasks.length > 0) {
						const studentNames = backupTasks.map(t => t.student_name).join('ã€');
						if(typeof toastLite === 'function') {
							toastLite(`ğŸ”„ æ–°å‘¨å¼€å§‹ï¼Œå·²è‡ªåŠ¨æ¢å¤ ${studentNames} çš„æ—¶é—´æ®µè®¾ç½®`, 'success');
						}
					}
				} else if(queryError && queryError.code !== '42P01') {
					// å¦‚æœä¸æ˜¯è¡¨ä¸å­˜åœ¨çš„é”™è¯¯ï¼Œåˆ™è®°å½•
					console.warn('[BTM] æ£€æŸ¥ä¸“ç”¨å¤‡ä»½è¡¨å¤±è´¥:', queryError);
				}
				
				// æ–¹æ¡ˆ2ï¼šä» student_time_slots è¡¨æŸ¥æ‰¾ç‰¹æ®Šæ ‡è®°çš„æ¢å¤ä»»åŠ¡
				const currentTime = new Date().toTimeString().substring(0,5);
				const {data: slotTasks, error: slotError} = await supabaseClient
					.from('student_time_slots')
					.select('*')
					.like('student_name', 'RESTORE_TASK_%')
					.eq('weekday', 9)
					.lte('end_time', currentTime);
				
				if(!slotError && slotTasks && slotTasks.length > 0) {
					console.log(`[BTM] å‘ç° ${slotTasks.length} ä¸ªæ—¶é—´æ®µè¡¨æ¢å¤ä»»åŠ¡`);
					
					for(const task of slotTasks) {
						try {
							const studentName = task.student_name.replace('RESTORE_TASK_', '');
							
							// è¿™ç§æ–¹æ¡ˆä¸‹éœ€è¦é‡æ–°æŸ¥è¯¢åŸå§‹æ•°æ®ï¼ˆå› ä¸ºç»“æ„é™åˆ¶ï¼‰
							// æˆ–è€…é‡‡ç”¨å…¶ä»–æ–¹å¼å­˜å‚¨åŸå§‹æ•°æ®
							console.log(`[BTM] å¤„ç† ${studentName} çš„æ¢å¤ä»»åŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼‰`);
							
							// åˆ é™¤æ¢å¤ä»»åŠ¡æ ‡è®°
							await supabaseClient
								.from('student_time_slots')
								.delete()
								.eq('id', task.id);
								
						} catch(taskError) {
							console.error(`[BTM] æ‰§è¡Œæ—¶é—´æ®µæ¢å¤ä»»åŠ¡å¤±è´¥:`, taskError);
						}
					}
				}
				
			} catch(error) {
				console.error('[BTM] æ£€æŸ¥æœåŠ¡å™¨æ¢å¤ä»»åŠ¡å¤±è´¥:', error);
			}
		},
		
		// ä»æœåŠ¡å™¨ä»»åŠ¡æ¢å¤æ•°æ®
		async restoreFromServerTask(studentName, originalData) {
			console.log(`[BTM] ä»æœåŠ¡å™¨ä»»åŠ¡æ¢å¤ ${studentName} çš„æ•°æ®`);
			
			try {
				// ä½¿ç”¨upsertç­–ç•¥é¿å…é‡å¤é”®å†²çª
				if(originalData && originalData.length > 0) {
					// æ–¹æ¡ˆ1: å…ˆå°è¯•upsertï¼Œå¦‚æœå¤±è´¥åˆ™æ¸…ç©ºåé‡æ–°æ’å…¥
					try {
						const upsertRes = await supabaseClient
							.from('student_time_slots')
							.upsert(originalData.map(item => ({
								student_name: item.student_name,
								weekday: item.weekday,
								start_time: item.start_time,
								end_time: item.end_time,
								duration_minutes: item.duration_minutes
							})), {
								onConflict: 'student_name,weekday',
								ignoreDuplicates: false
							});
						
						if(upsertRes.error) {
							// upsertå¤±è´¥ï¼Œå°è¯•æ¸…ç©ºåé‡æ–°æ’å…¥
							console.warn(`[BTM] ${studentName} upsertå¤±è´¥ï¼Œå°è¯•æ¸…ç©ºåé‡æ–°æ’å…¥:`, upsertRes.error.message);
							
							// åˆ é™¤å½“å‰æ•°æ®
							const delRes = await supabaseClient
								.from('student_time_slots')
								.delete()
								.eq('student_name', studentName)
								.in('weekday',[1,2,3,4,5]);
							
							if(delRes.error) {
								throw new Error(`åˆ é™¤å¤±è´¥: ${delRes.error.message}`);
							}
							
							// ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿åˆ é™¤æ“ä½œå®Œæˆ
							await new Promise(resolve => setTimeout(resolve, 100));
							
							// é‡æ–°æ’å…¥æ•°æ®
							const insRes = await supabaseClient
								.from('student_time_slots')
								.insert(originalData.map(item => ({
									student_name: item.student_name,
									weekday: item.weekday,
									start_time: item.start_time,
									end_time: item.end_time,
									duration_minutes: item.duration_minutes
								})));
							
							if(insRes.error) {
								throw new Error(`é‡æ–°æ’å…¥å¤±è´¥: ${insRes.error.message}`);
							}
							
							console.log(`[BTM] ${studentName} æ¸…ç©ºåé‡æ–°æ’å…¥æˆåŠŸ`);
						} else {
							console.log(`[BTM] ${studentName} upsertæˆåŠŸ`);
						}
					} catch(upsertError) {
						// å¦‚æœupsertè¿‡ç¨‹ä¸­æœ‰é”™è¯¯ï¼Œè®°å½•è¯¦ç»†ä¿¡æ¯
						console.error(`[BTM] ${studentName} æ¢å¤è¿‡ç¨‹å¼‚å¸¸:`, upsertError);
						throw upsertError;
					}
				} else {
					// æ²¡æœ‰åŸå§‹æ•°æ®ï¼Œåªæ¸…ç©ºå½“å‰æ•°æ®
					console.log(`[BTM] ${studentName} æ²¡æœ‰åŸå§‹æ•°æ®ï¼Œåªæ¸…ç©ºå½“å‰è®¾ç½®`);
					const delRes = await supabaseClient
						.from('student_time_slots')
						.delete()
						.eq('student_name', studentName)
						.in('weekday',[1,2,3,4,5]);
					
					if(delRes.error) {
						console.warn(`[BTM] ${studentName} æ¸…ç©ºæ—¶é—´æ®µå¤±è´¥:`, delRes.error.message);
						// æ¸…ç©ºå¤±è´¥ä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºå¯èƒ½æœ¬æ¥å°±æ²¡æœ‰æ•°æ®
					}
				}
				
				console.log(`[BTM] æˆåŠŸä»æœåŠ¡å™¨æ¢å¤ ${studentName} çš„æ—¶é—´æ®µè®¾ç½®`);
				
				// æ˜¾ç¤ºé€šçŸ¥
				if(typeof toastLite === 'function') {
					toastLite(`å·²è‡ªåŠ¨æ¢å¤ ${studentName} çš„æ—¶é—´æ®µè®¾ç½®`);
				}
				
			} catch(error) {
				console.error(`[BTM] æ¢å¤ ${studentName} å¤±è´¥:`, error);
				throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©ä¸Šå±‚å¤„ç†
			}
		},
		
		// æ‰§è¡Œæ¢å¤ä»»åŠ¡
		async executeRestoreTask(task) {
			console.log(`[BTM] æ‰§è¡Œæ¢å¤ä»»åŠ¡:`, task);
			
			if(!supabaseClient) {
				console.warn('[BTM] Supabase æœªè¿æ¥ï¼Œå»¶è¿Ÿæ¢å¤ä»»åŠ¡');
				return;
			}
			
			let restoredCount = 0;
			const errors = [];
			
			for(const studentName of task.changedStudents) {
				try {
					const originalData = task.originalBackups[studentName];
					if(!originalData) {
						console.warn(`[BTM] æ²¡æœ‰æ‰¾åˆ° ${studentName} çš„å¤‡ä»½æ•°æ®`);
						continue;
					}
					
					// ä½¿ç”¨ç»Ÿä¸€çš„æ¢å¤æ–¹æ³•ï¼Œé¿å…é‡å¤é”®å†²çª
					try {
						await this.restoreFromServerTask(studentName, originalData);
						restoredCount++;
					} catch(restoreError) {
						errors.push(`${studentName} æ¢å¤å¤±è´¥: ${restoreError.message}`);
					}
					
				} catch(error) {
					errors.push(`${studentName} æ¢å¤å¼‚å¸¸: ${error.message}`);
				}
			}
			
			console.log(`[BTM] æ¢å¤ä»»åŠ¡å®Œæˆ: æˆåŠŸ ${restoredCount} äºº, å¤±è´¥ ${errors.length} äºº`);
			if(errors.length > 0) {
				console.error('[BTM] æ¢å¤é”™è¯¯:', errors);
			}
			
			// å¦‚æœæœ‰ toast å‡½æ•°ï¼Œæ˜¾ç¤ºé€šçŸ¥
			if(typeof toastLite === 'function') {
				const msg = errors.length > 0 ? 
					`æ—¶é—´æ®µå·²æ¢å¤: ${restoredCount} äººæˆåŠŸ, ${errors.length} äººå¤±è´¥` :
					`æ—¶é—´æ®µå·²è‡ªåŠ¨æ¢å¤: ${restoredCount} äºº`;
				toastLite(msg);
			}
		},
		
		debugAuth: async function(){ if(!supabaseClient){ console.log('æ—  supabaseClient'); return;} const {data,error}=await supabaseClient.from('student_time_slots').select('*').limit(1); console.log('debugAuth select result:', data, error); if(error){ alert('è°ƒè¯•: '+ (error.status||'')+' '+error.message); } else { alert('è°ƒè¯•æˆåŠŸï¼Œè¿”å› '+data.length+' æ¡'); } },
		prevStudent(){ if(this.filteredStudents.length===0) return; this.currentIndex=(this.currentIndex<=0?this.filteredStudents.length-1:this.currentIndex-1); this.dom.studentSelect.value=String(this.currentIndex); this.updateInfo(); this.highlight(); this.refreshSelectedList(); },
		nextStudent(){ if(this.filteredStudents.length===0) return; this.currentIndex=(this.currentIndex>=this.filteredStudents.length-1?0:this.currentIndex+1); this.dom.studentSelect.value=String(this.currentIndex); this.updateInfo(); this.highlight(); this.refreshSelectedList(); }
	};
	// è®¡ç®—ä¸‹å‘¨ä¸€çš„æ¢å¤æ—¶é—´ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰
	function getNextMondayRestoreTime() {
		const now = new Date();
		const nextMonday = new Date(now);
		const daysUntilNextMonday = (7 - now.getDay() + 1) % 7 || 7;
		nextMonday.setDate(now.getDate() + daysUntilNextMonday);
		nextMonday.setHours(8, 0, 0, 0); // ä¸‹å‘¨ä¸€æ—©ä¸Š8ç‚¹
		return nextMonday;
	}
	
	// æ ¼å¼åŒ–æ¢å¤æ—¶é—´æ˜¾ç¤º
	function formatRestoreTime() {
		const nextMonday = getNextMondayRestoreTime();
		const now = new Date();
		const diffDays = Math.ceil((nextMonday - now) / (24 * 60 * 60 * 1000));
		
		if (diffDays === 1) {
			return `æ˜æ—¥(${nextMonday.toLocaleDateString()}) 8:00`;
		} else {
			return `${diffDays}å¤©å(${nextMonday.toLocaleDateString()}) 8:00`;
		}
	}
	
	// æ£€æŸ¥æ˜¯å¦åº”è¯¥æ‰§è¡Œæ¢å¤ä»»åŠ¡ï¼ˆè€ƒè™‘æå‰æ‰§è¡Œï¼‰
	function shouldExecuteRestore(restoreTime) {
		const now = new Date();
		const restore = new Date(restoreTime);
		
		// è·å–ä»Šå¤©çš„æ—¥æœŸï¼ˆä¸å«æ—¶é—´ï¼‰
		const todayStart = new Date(now);
		todayStart.setHours(0, 0, 0, 0);
		
		const restoreDate = new Date(restore);
		restoreDate.setHours(0, 0, 0, 0);
		
		// å¦‚æœæ˜¯å‘¨ä¸€
		if (now.getDay() === 1) {
			// å‘¨ä¸€çš„ä»»ä½•æ—¶é—´ï¼Œåªè¦æ¢å¤æ—¥æœŸæ˜¯ä»Šå¤©æˆ–ä¹‹å‰ï¼Œå°±æ‰§è¡Œ
			if (restoreDate <= todayStart) {
				console.log(`[BTM] å‘¨ä¸€æ£€æµ‹ï¼šæ¢å¤ä»»åŠ¡è®¡åˆ’ ${restore.toLocaleString()}ï¼Œç°åœ¨æ‰§è¡Œ`);
				return true;
			}
		}
		
		// å¦‚æœå·²ç»è¿‡äº†è®¡åˆ’çš„æ¢å¤æ—¶é—´ï¼Œä¹Ÿè¦æ‰§è¡Œ
		if (now >= restore) {
			console.log(`[BTM] æ—¶é—´æ£€æµ‹ï¼šæ¢å¤ä»»åŠ¡å·²åˆ°æœŸ ${restore.toLocaleString()}ï¼Œç°åœ¨æ‰§è¡Œ`);
			return true;
		}
		
		// å…¶ä»–æƒ…å†µä¸æ‰§è¡Œ
		return false;
	}
	
	window.BTM=BTM; window.openBulkTimeManager=()=>{ BTM.open(); };
	
	// ç‹¬ç«‹çš„æ¢å¤ä»»åŠ¡ç®¡ç†å™¨
	window.RestoreTaskManager = {
		// æŸ¥çœ‹æ‰€æœ‰æ¢å¤ä»»åŠ¡
		async viewAllTasks() {
			if(!supabaseClient) {
				toastLite('æ•°æ®åº“æœªè¿æ¥');
				return;
			}
			
			try {
				const {data: tasks, error} = await supabaseClient
					.from('student_time_slots_backup')
					.select('*')
					.eq('backup_type', 'temp_change')
					.eq('is_restored', false)
					.order('created_at', { ascending: false });
				
				if(error) {
					toastLite('æŸ¥è¯¢æ¢å¤ä»»åŠ¡å¤±è´¥: ' + error.message);
					return;
				}
				
				if(!tasks || tasks.length === 0) {
					toastLite('å½“å‰æ²¡æœ‰å¾…æ‰§è¡Œçš„æ¢å¤ä»»åŠ¡');
					return;
				}
				
				// åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
				console.group('ğŸ”„ æ¢å¤ä»»åŠ¡åˆ—è¡¨');
				tasks.forEach((task, index) => {
					const createDate = new Date(task.created_at).toLocaleString();
					const restoreDate = new Date(task.restore_time).toLocaleString();
					const originalDataCount = task.original_data ? task.original_data.length : 0;
					
					console.log(`${index + 1}. ${task.student_name}`);
					console.log(`   åˆ›å»ºæ—¶é—´: ${createDate}`);
					console.log(`   æ¢å¤æ—¶é—´: ${restoreDate}`);
					console.log(`   å¤‡ä»½æ¡æ•°: ${originalDataCount}`);
					console.log(`   ä»»åŠ¡ID: ${task.id}`);
					console.log('---');
				});
				console.groupEnd();
				
				toastLite(`å‘ç° ${tasks.length} ä¸ªæ¢å¤ä»»åŠ¡ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°`);
				
			} catch(error) {
				console.error('æŸ¥çœ‹æ¢å¤ä»»åŠ¡å¤±è´¥:', error);
				toastLite('æŸ¥çœ‹æ¢å¤ä»»åŠ¡å¤±è´¥: ' + error.message);
			}
		},
		
		// æ¸…ç©ºæ‰€æœ‰æ¢å¤ä»»åŠ¡
		async clearAllTasks() {
			if(!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¢å¤ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
			
			try {
				const {error} = await supabaseClient
					.from('student_time_slots_backup')
					.delete()
					.eq('backup_type', 'temp_change')
					.eq('is_restored', false);
				
				if(error) {
					toastLite('æ¸…ç©ºæ¢å¤ä»»åŠ¡å¤±è´¥: ' + error.message);
					return;
				}
				
				toastLite('å·²æ¸…ç©ºæ‰€æœ‰æ¢å¤ä»»åŠ¡');
				console.log('âœ… å·²æ¸…ç©ºæ‰€æœ‰æ¢å¤ä»»åŠ¡');
				
			} catch(error) {
				console.error('æ¸…ç©ºæ¢å¤ä»»åŠ¡å¤±è´¥:', error);
				toastLite('æ¸…ç©ºæ¢å¤ä»»åŠ¡å¤±è´¥: ' + error.message);
			}
		},
		
		// ç«‹å³æ‰§è¡ŒæŒ‡å®šå­¦ç”Ÿçš„æ¢å¤ä»»åŠ¡
		async executeTaskByStudent(studentName) {
			if(!studentName) {
				toastLite('è¯·æä¾›å­¦ç”Ÿå§“å');
				return;
			}
			
			try {
				const {data: tasks, error: queryError} = await supabaseClient
					.from('student_time_slots_backup')
					.select('*')
					.eq('student_name', studentName)
					.eq('backup_type', 'temp_change')
					.eq('is_restored', false)
					.limit(1);
				
				if(queryError || !tasks || tasks.length === 0) {
					toastLite(`${studentName} æ²¡æœ‰å¾…æ‰§è¡Œçš„æ¢å¤ä»»åŠ¡`);
					return;
				}
				
				const task = tasks[0];
				
				// æ‰§è¡Œæ¢å¤
				await BTM.restoreFromServerTask(task.student_name, task.original_data || []);
				
				// æ ‡è®°ä¸ºå·²æ¢å¤
				const {error: updateError} = await supabaseClient
					.from('student_time_slots_backup')
					.update({ is_restored: true })
					.eq('id', task.id);
				
				if(updateError) {
					console.warn('æ ‡è®°ä»»åŠ¡å·²æ¢å¤å¤±è´¥:', updateError);
				}
				
				toastLite(`å·²ç«‹å³æ¢å¤ ${studentName} çš„æ—¶é—´æ®µè®¾ç½®`);
				console.log(`âœ… å·²æ¢å¤ ${studentName} çš„æ—¶é—´æ®µè®¾ç½®`);
				
			} catch(error) {
				console.error(`æ‰§è¡Œ ${studentName} æ¢å¤ä»»åŠ¡å¤±è´¥:`, error);
				toastLite(`æ‰§è¡Œæ¢å¤å¤±è´¥: ${error.message}`);
			}
		}
	};
	
	// åœ¨æ§åˆ¶å°æä¾›ä¾¿æ·ä½¿ç”¨è¯´æ˜
	console.log(`
ğŸ”„ æ¢å¤ä»»åŠ¡ç®¡ç†å·¥å…·å·²åŠ è½½ï¼š

æŸ¥çœ‹æ‰€æœ‰æ¢å¤ä»»åŠ¡ï¼š
RestoreTaskManager.viewAllTasks()

æ¸…ç©ºæ‰€æœ‰æ¢å¤ä»»åŠ¡ï¼š
RestoreTaskManager.clearAllTasks()

ç«‹å³æ‰§è¡ŒæŒ‡å®šå­¦ç”Ÿçš„æ¢å¤ä»»åŠ¡ï¼š
RestoreTaskManager.executeTaskByStudent('å­¦ç”Ÿå§“å')

ä¾‹å¦‚ï¼š
RestoreTaskManager.executeTaskByStudent('å¼ ä¸‰')

æ³¨æ„ï¼šæ¢å¤ä»»åŠ¡è®¡åˆ’åœ¨ä¸‹å‘¨ä¸€æ‰§è¡Œï¼Œæ¢å¤åˆ°æœ¬å‘¨ä¿®æ”¹å‰çš„åŸå§‹è®¾ç½®ã€‚
	`);
	window.closeBulkTimeManager=()=>{ BTM.close(); };
	document.addEventListener('DOMContentLoaded',()=>{
		const bind=(id,fn)=>{ const el=document.getElementById(id); if(el) el.onclick=fn; };
		bind('btmCloseBtn', ()=>closeBulkTimeManager());
		bind('btmPrevBtn', ()=>{BTM.prevStudent&&BTM.prevStudent();});
		bind('btmNextBtn', ()=>{BTM.nextStudent&&BTM.nextStudent();});
		bind('btmClearAllBtn', ()=>BTM.clearAll());
		bind('btmSaveBtn', ()=>BTM.save());
		const sel=document.getElementById('btmStudentSelect'); if(sel) sel.onchange=()=>BTM.selectStudent();
		const search=document.getElementById('btmSearchInput'); if(search) search.oninput=()=>{BTM.applyFilter(); if(BTM.filteredStudents.length){BTM.currentIndex=0; BTM.dom.studentSelect.value='0'; BTM.updateInfo(); BTM.highlight(); BTM.refreshSelectedList();}};
		
		// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¾…æ‰§è¡Œçš„æ¢å¤ä»»åŠ¡
		setTimeout(() => {
			if(window.supabaseReady && BTM.checkPendingRestoreTasks) {
				BTM.checkPendingRestoreTasks();
				BTM.checkServerRestoreTasks(); // æ£€æŸ¥æœåŠ¡å™¨ç«¯ä»»åŠ¡
			}
		}, 2000);
		
		// åŠ¨æ€æ£€æŸ¥é¢‘ç‡ï¼šå‘¨ä¸€æ›´é¢‘ç¹ï¼Œå…¶ä»–æ—¶é—´æ­£å¸¸
		function scheduleRestoreCheck() {
			const now = new Date();
			let interval;
			
			if(now.getDay() === 1) { // å‘¨ä¸€
				interval = 10 * 60 * 1000; // 10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
				console.log('[BTM] å‘¨ä¸€æ£€æµ‹æ¨¡å¼ï¼šæ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ¢å¤ä»»åŠ¡');
			} else {
				interval = 60 * 60 * 1000; // 1å°æ—¶æ£€æŸ¥ä¸€æ¬¡
			}
			
			setTimeout(() => {
				if(window.supabaseReady && BTM.checkPendingRestoreTasks) {
					BTM.checkPendingRestoreTasks();
					BTM.checkServerRestoreTasks();
				}
				scheduleRestoreCheck(); // é€’å½’è°ƒåº¦ä¸‹æ¬¡æ£€æŸ¥
			}, interval);
		}
		
		// å¯åŠ¨åŠ¨æ€æ£€æŸ¥
		scheduleRestoreCheck();
		
		// é¡µé¢å¯è§æ€§æ£€æµ‹ï¼šç”¨æˆ·é‡æ–°æ‰“å¼€é¡µé¢æ—¶ç«‹å³æ£€æŸ¥
		document.addEventListener('visibilitychange', function() {
			if (!document.hidden && window.supabaseReady && BTM.checkPendingRestoreTasks) {
				console.log('[BTM] é¡µé¢é‡æ–°å¯è§ï¼Œæ£€æŸ¥æ¢å¤ä»»åŠ¡...');
				setTimeout(() => {
					BTM.checkPendingRestoreTasks();
					BTM.checkServerRestoreTasks();
				}, 1000);
			}
		});
		
		// çª—å£ç„¦ç‚¹æ£€æµ‹ï¼šç”¨æˆ·é‡æ–°æ¿€æ´»çª—å£æ—¶æ£€æŸ¥
		window.addEventListener('focus', function() {
			if (window.supabaseReady && BTM.checkPendingRestoreTasks) {
				console.log('[BTM] çª—å£é‡æ–°è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥æ¢å¤ä»»åŠ¡...');
				setTimeout(() => {
					BTM.checkPendingRestoreTasks();
					BTM.checkServerRestoreTasks();
				}, 500);
			}
		});
	});
})();
</script>

<script>
// ======= StudentLibrary Seed Function (AB æ–¹æ¡ˆæ ¸å¿ƒ) =======
// è¯´æ˜ï¼š
//  - è¯¥å‡½æ•°åœ¨ bootstrap() ç»“æŸåè°ƒç”¨ï¼ˆAï¼‰
//  - åŒæ—¶åœ¨ StudentLibrary åˆå§‹åŒ–åå»¶è¿Ÿå†æ¬¡è°ƒç”¨ï¼ˆBï¼‰
//  - ä»…åœ¨æœ¬åœ° StudentLibrary ä¸ºç©ºæ—¶è¿ç§» RoomStore.students
//  - å¹‚ç­‰ï¼šå·²æœ‰å­¦ç”Ÿæˆ–å·²è¿ç§»åˆ™ä¸é‡å¤ï¼›é¿å…åŒåé‡å¤
//  - è‹¥ RoomStore å°šæœªå°±ç»ªåˆ™é™é»˜é€€å‡ºï¼Œå¯ä¾›ç¨åé‡è¯•
window.seedStudentLibraryFromRoomStore = function(opts){
	const result = { ok:false, reason: opts?.reason||'', inserted:0, skipped:0, alreadyHad:false, roomStudents:0, error:null };
	try{
		if(!window.RoomStore || !Array.isArray(RoomStore.students)){ result.error='RoomStoreNotReady'; return result; }
		const rs = RoomStore.students; result.roomStudents = rs.length; if(!rs.length){ result.error='NoRoomStudents'; return result; }
		const LS_KEY = 'yms_students_store_v1';
		let store = { version:1, items:[] };
		try{ const raw=localStorage.getItem(LS_KEY); if(raw){ const obj=JSON.parse(raw); if(obj && obj.version===1 && Array.isArray(obj.items)) store = obj; } }catch(parseErr){ result.error='ParseError'; }
		if(store.items.length){ result.alreadyHad=true; result.ok=true; return result; }
		const now = Date.now();
		const dedup = new Set();
		rs.forEach(s=>{ const name = (s && s.name||'').trim(); if(!name){ result.skipped++; return; } if(dedup.has(name)){ result.skipped++; return; } dedup.add(name); store.items.push({ id: (crypto.randomUUID?crypto.randomUUID():('id_'+Math.random().toString(36).slice(2))), name, grade: s.grade||'', major: s.major||'', remark:'', archived:false, created_at: now, updated_at: now }); });
		if(!store.items.length){ result.error='NoValidStudents'; return result; }
		try{ localStorage.setItem(LS_KEY, JSON.stringify(store)); }catch(e){ result.error='SaveFailed'; return result; }
		result.inserted = store.items.length; result.ok=true;
		console.log('[SeedStudentLibrary] è¿ç§»å®Œæˆ inserted=', result.inserted, 'skipped=', result.skipped, 'reason=', result.reason);
		if(window.StudentLibrary && typeof StudentLibrary.refresh==='function'){ try{ StudentLibrary.refresh(); }catch(_){ } }
		if(window.BTM && typeof BTM.buildStudents==='function'){ try{ BTM.buildStudents(); BTM.buildSelections && BTM.buildSelections(); BTM.applyFilter && BTM.applyFilter(); }catch(_){ } }
	}catch(e){ console.warn('[SeedStudentLibrary] è¿è¡Œå¼‚å¸¸', e); result.error='Exception'; }
	return result;
};
// å¯æ‰‹åŠ¨åœ¨æ§åˆ¶å°æ‰§è¡Œ window.seedStudentLibraryFromRoomStore({reason:'manual'}) è¿›è¡Œé‡è¯•

// ================= å­¦ç”Ÿåº“ï¼ˆStudent Libraryï¼‰ =================
(function(){
	if(window.StudentLibrary) return;

	// ç¡®ä¿å­¦ç”Ÿåº“å·²è¢«äº‘ç«¯ / RoomStore æ•°æ®å›å¡«
	window.ensureStudentLibraryHydrated = async function(opts){
		try{
			const LS_KEY='yms_students_store_v1';
			let parsed=null; try{ const raw=localStorage.getItem(LS_KEY); if(raw){ parsed=JSON.parse(raw); } }catch(_){ }
			const empty = !parsed || !Array.isArray(parsed.items) || parsed.items.length===0;
			// è‹¥å·²å­˜åœ¨å­¦ç”Ÿåˆ™ä¸å¤„ç†ï¼ˆé¿å…è¦†ç›–å®æ—¶åŒæ­¥çš„æ•°æ®ï¼‰
			if(!empty){ return { skipped:true, reason:'already-have-local' }; }
			
			// æ£€æŸ¥æ˜¯å¦åœ¨å®æ—¶åŒæ­¥å†·å´æœŸå†…ï¼ˆé¿å…å†²çªï¼‰
			const recentRealtimeUpdate = window.__studentUpdateTimestamp && 
				(Date.now() - window.__studentUpdateTimestamp) < 10000; // 10ç§’å†…æœ‰å®æ—¶æ›´æ–°
			if (recentRealtimeUpdate) {
				console.log('[ensureStudentLibraryHydrated] æ£€æµ‹åˆ°è¿‘æœŸå®æ—¶æ›´æ–°ï¼Œè·³è¿‡æ•°æ®å¡«å……');
				return { skipped: true, reason: 'recent-realtime-update' };
			}
			
			// å…ˆå°è¯•ä» RoomStore è¿ç§»ï¼ˆåŒæ­¥å‡½æ•°ï¼‰
			if(window.seedStudentLibraryFromRoomStore){ const r=window.seedStudentLibraryFromRoomStore({ reason: opts?.source||'ensure-hydrate' }); if(r && r.ok){ return { ok:true, method:'roomStore', inserted:r.inserted }; } }
			// è‹¥ RoomStore ä»æ— ï¼Œåˆ™å°è¯•äº‘ç«¯ fetchStudentsï¼ˆè¯¥å‡½æ•°ä¼š merge åˆ° Storeï¼‰
			if(typeof fetchStudents==='function' && window.supabaseReady){ 
				// æ•°æ®å›å¡«æ—¶ä½¿ç”¨å…¨é‡åŒæ­¥ç¡®ä¿å®Œæ•´æ€§
				await fetchStudents({ forceFullSync: true }); 
			}
			// å†æ¬¡æ£€æŸ¥ï¼Œå¦‚æœ Store.students æœ‰è€Œæœ¬åœ°ä»ä¸ºç©ºï¼Œåˆ™ç”¨ Store.students å›å¡«
			try{ const raw2=localStorage.getItem(LS_KEY); if(raw2){ parsed=JSON.parse(raw2); } }catch(_){ }
			const stillEmpty = !parsed || !Array.isArray(parsed.items) || parsed.items.length===0;
			if(stillEmpty && Array.isArray(window.Store?.students) && Store.students.length){
				const now=Date.now(); const storeObj={ version:1, items: Store.students.map(s=>({ id:(crypto.randomUUID?crypto.randomUUID():('id_'+Math.random().toString(36).slice(2))), name:s.name, grade:s.grade||'', major:s.major||'', remark:'', archived:false, created_at:now, updated_at:now })) };
				try{ localStorage.setItem(LS_KEY, JSON.stringify(storeObj)); console.log('[ensureStudentLibraryHydrated] é€šè¿‡ Store.students å›å¡«', storeObj.items.length); if(window.StudentLibrary && StudentLibrary.refresh) StudentLibrary.refresh(); return { ok:true, method:'storeStudents', inserted:storeObj.items.length }; }catch(err){ return { ok:false, error:'save-failed', detail:err?.message }; }
			}
			// æœ€åå°è¯•åˆ·æ–° pending é˜Ÿåˆ—ï¼ˆå¦‚æœæ­¤æ—¶æ‰è¿ä¸Šäº‘ï¼‰
			try{ if(window.__retryStudentLibraryPending){ await window.__retryStudentLibraryPending(); } }catch(_){ }
			return { ok: !stillEmpty, method: stillEmpty? 'none':'maybe-cloud', inserted: stillEmpty?0:(parsed.items||[]).length };
		}catch(e){ return { ok:false, error:e.message||String(e) }; }
	};
	const LS_KEY = 'yms_students_store_v1';
	const store = { version:1, items:[] };
	// å¾…åŒæ­¥é˜Ÿåˆ—: {type:'upsert'|'delete', payload:{name,major,grade,archived?}} ç¦»çº¿æ—¶ç´¯ç§¯
	let pendingCloudOps = [];
	function now(){ return Date.now(); }
	function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(store)); }catch(e){ console.warn('[StudentLibrary] save failed', e); } }
	function load(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw){ const obj=JSON.parse(raw); if(obj.version===1 && Array.isArray(obj.items)){ store.items=obj.items; } } }catch(e){ console.warn('[StudentLibrary] load failed', e); } }
	
	// äº‘ç«¯åŠ è½½èŠ‚æµï¼šé¦–æ¬¡ä¸å†·å´ï¼Œåç»­30ç§’å†·å´
	let lastCloudLoadTime = 0;
	const CLOUD_LOAD_COOLDOWN = 30000; // 30ç§’
	let firstCloudLoadDone = false;
	
	// ä»äº‘ç«¯åŠ è½½å­¦ç”Ÿæ•°æ®ï¼ˆæ™ºèƒ½åˆå¹¶ï¼Œé¿å…å†²çªå®æ—¶åŒæ­¥ï¼‰
	async function loadFromCloud() {
		if (!window.supabaseClient || !window.supabaseReady) {
			console.log('[StudentLibrary] Supabase æœªå°±ç»ªï¼Œè·³è¿‡äº‘ç«¯åŠ è½½');
			return false;
		}
		
		// èŠ‚æµï¼šé¦–æ¬¡å¼ºåˆ¶åŠ è½½ï¼Œåç»­æ‰è¿›å…¥å†·å´åˆ¤æ–­
		const now = Date.now();
		if(firstCloudLoadDone){
			if (now - lastCloudLoadTime < CLOUD_LOAD_COOLDOWN) {
				console.log('[StudentLibrary] äº‘ç«¯åŠ è½½å†·å´ä¸­ï¼Œè·³è¿‡æœ¬æ¬¡åŠ è½½');
				return false;
			}
		}
		lastCloudLoadTime = now;
		
		try {
			console.log('[StudentLibrary] å¼€å§‹ä»äº‘ç«¯åŠ è½½å­¦ç”Ÿæ•°æ®...');
			
			const { data: cloudStudents, error } = await window.supabaseClient
				.from('student_database')
				.select('*')
				.order('name');
			
			if (error) {
				console.warn('[StudentLibrary] äº‘ç«¯åŠ è½½å¤±è´¥:', error.message);
				return false;
			}
			
			if (cloudStudents && cloudStudents.length > 0) {
				// æ™ºèƒ½åˆå¹¶ï¼šä¸æ¸…ç©ºæœ¬åœ°æ•°æ®ï¼Œè€Œæ˜¯åŸºäºåå­—åˆå¹¶
				let mergedCount = 0;
				let newCount = 0;
				
				cloudStudents.forEach(cloudStudent => {
					// æŸ¥æ‰¾æœ¬åœ°æ˜¯å¦å·²æœ‰åŒåå­¦ç”Ÿ
					let localStudent = store.items.find(s => s.name === cloudStudent.name);
					
					if (localStudent) {
						// å·²å­˜åœ¨ï¼Œæ›´æ–°ä¿¡æ¯ï¼ˆä»¥äº‘ç«¯ä¸ºå‡†ï¼Œä½†ä¿ç•™æœ¬åœ°IDå’Œå¤‡æ³¨ï¼‰
						localStudent.grade = cloudStudent.grade || '';
						localStudent.major = cloudStudent.major || '';
						localStudent.updated_at = cloudStudent.updated_at ? new Date(cloudStudent.updated_at).getTime() : now();
						mergedCount++;
					} else {
						// ä¸å­˜åœ¨ï¼Œæ–°å¢å­¦ç”Ÿ
						const newStudent = {
							id: crypto.randomUUID ? crypto.randomUUID() : ('id_' + Math.random().toString(36).slice(2)),
							name: cloudStudent.name,
							grade: cloudStudent.grade || '',
							major: cloudStudent.major || '',
							remark: '',
							archived: false,
							created_at: cloudStudent.created_at ? new Date(cloudStudent.created_at).getTime() : now(),
							updated_at: cloudStudent.updated_at ? new Date(cloudStudent.updated_at).getTime() : now()
						};
						store.items.push(newStudent);
						newCount++;
					}
				});
				
				// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
				save();
				
				firstCloudLoadDone = true;
				console.log(`[StudentLibrary] äº‘ç«¯åˆå¹¶å®Œæˆ: æ–°å¢${newCount}ä¸ª, æ›´æ–°${mergedCount}ä¸ªå­¦ç”Ÿ (source=cloud)`);
				return true;
			} else {
				firstCloudLoadDone = true;
				console.log('[StudentLibrary] äº‘ç«¯æ— å­¦ç”Ÿæ•°æ® (source=cloud-empty)');
				return false;
			}
		} catch (error) {
			console.error('[StudentLibrary] äº‘ç«¯åŠ è½½å¼‚å¸¸:', error);
			return false;
		}
	}

	// ç­‰å¾… supabaseReady å·¥å…·
	async function waitSupabaseReady(timeout=8000){
		const start=Date.now();
		while(!window.supabaseReady){
			if(Date.now()-start>timeout) return false;
			await new Promise(r=>setTimeout(r,120));
		}
		return true;
	}
	async function flushPending(){ if(!window.supabaseReady || !window.supabaseClient || !pendingCloudOps.length) return; const upserts=[]; const deletes=[]; pendingCloudOps.forEach(op=>{ if(op.type==='upsert') upserts.push(op.payload); else if(op.type==='delete') deletes.push(op.payload); }); pendingCloudOps=[]; try{ if(upserts.length){ console.log('[StudentLibrary] æ‰¹é‡ä¸Šè¡Œå­¦ç”Ÿ', upserts.length); try{ if(typeof syncStudentDatabaseToCloud==='function'){ await syncStudentDatabaseToCloud(upserts); } else { // fallback æ‰‹åŠ¨ diff
				const names=[...new Set(upserts.map(s=>s.name).filter(Boolean))]; let existing=[]; try{ const {data:ex, error:exErr}=await supabaseClient.from('student_database').select('name').in('name', names); if(!exErr && Array.isArray(ex)) existing=ex.map(r=>r.name); }catch(_){ }
				const toInsert=upserts.filter(s=>!existing.includes(s.name)).map(s=>({ name:s.name, major:s.major||'æœªå¡«å†™', grade:s.grade||'' }));
				const toUpdate=upserts.filter(s=>existing.includes(s.name));
				if(toInsert.length){ const {error:insErr}=await supabaseClient.from('student_database').insert(toInsert); if(insErr) console.warn('[StudentLibrary] insert batch error', insErr.message); }
				for(const row of toUpdate){ try{ const {error:updErr}=await supabaseClient.from('student_database').update({ major:row.major||'æœªå¡«å†™', grade:row.grade||'' }).eq('name', row.name); if(updErr) console.warn('[StudentLibrary] update error', row.name, updErr.message); }catch(e){ console.warn('[StudentLibrary] update exception', row.name, e.message); } }
			} }catch(e){ console.warn('[StudentLibrary] upsert æ‰§è¡Œå¼‚å¸¸', e); }
		}
		if(deletes.length){ for(const d of deletes){ try{ const {error}=await supabaseClient.from('student_database').delete().eq('name', d.name); if(error) console.warn('[StudentLibrary] delete cloud error', d.name, error.message); else console.log('[StudentLibrary] å·²åˆ é™¤äº‘ç«¯å­¦ç”Ÿ', d.name); }catch(e){ console.warn('[StudentLibrary] delete cloud exception', d.name, e); } } }
	}catch(e){ console.warn('[StudentLibrary] flushPending exception', e); }
	}
	function enqueue(op){ 
		pendingCloudOps.push(op); 
		if(pendingCloudOps.length>50) console.warn('[StudentLibrary] pendingCloudOps size', pendingCloudOps.length); 
		if(!window.supabaseReady){
			if(typeof toast==='function') toast('ç¦»çº¿ï¼šå˜æ›´å·²æ’é˜Ÿ', 'warn');
			return; 
		}
		flushPending(); 
	}
	// ä¾›å¤–éƒ¨åœ¨ Supabase è¿æ¥åå†æ¬¡å°è¯•
	window.__retryStudentLibraryPending = flushPending;
	function migrateFromRoomStore(){ if(store.items.length) return; const rs=window.RoomStore?.students||[]; if(!rs.length) return; rs.forEach(s=>{ store.items.push({ id:crypto.randomUUID?crypto.randomUUID():('id_'+Math.random().toString(36).slice(2)), name:s.name, grade:s.grade||'', major:s.major||'', remark:'', archived:false, created_at:now(), updated_at:now() }); }); save(); console.log('[StudentLibrary] migrated', store.items.length); }
	function getAll(){ return store.items.slice().sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN')); }
	function findByName(name){ return store.items.find(s=>s.name===name); }
	function syncStoreItemToCloud(it){ if(!it) return; enqueue({ type:'upsert', payload:{ name:it.name, major:it.major||'', grade:it.grade||'' } }); }
	function addStudent(meta){ 
		if(!meta?.name) throw new Error('name required'); 
		if(findByName(meta.name)) throw new Error('å·²å­˜åœ¨åŒåå­¦ç”Ÿ'); 
		
		// æ ‡è®°æœ¬åœ°æ›´æ–°ï¼Œé¿å…å®æ—¶åŒæ­¥å¾ªç¯
		if (!window.__studentUpdateIgnore) window.__studentUpdateIgnore = new Set();
		window.__studentUpdateIgnore.add(meta.name);
		window.__studentUpdateTimestamp = Date.now();
		
		// æ¸…ç†æ ‡è®°ï¼ˆ5ç§’åï¼‰
		setTimeout(() => {
			if (window.__studentUpdateIgnore) {
				window.__studentUpdateIgnore.delete(meta.name);
			}
		}, 5000);
		
		const item={ 
			id:crypto.randomUUID?crypto.randomUUID():('id_'+Math.random().toString(36).slice(2)), 
			name:meta.name.trim(), 
			grade:meta.grade||'', 
			major:meta.major||'', 
			remark:meta.remark||'', 
			archived:false, 
			created_at:now(), 
			updated_at:now() 
		}; 
		store.items.push(item); 
		save(); 
		syncStoreItemToCloud(item); 
		refreshUI(); 
		refreshBTM(); 
		return item; 
	}
	function updateStudent(name, patch){ 
		const it=findByName(name); 
		if(!it) throw new Error('å­¦ç”Ÿä¸å­˜åœ¨'); 
		
		// æ ‡è®°æœ¬åœ°æ›´æ–°ï¼Œé¿å…å®æ—¶åŒæ­¥å¾ªç¯
		if (!window.__studentUpdateIgnore) window.__studentUpdateIgnore = new Set();
		window.__studentUpdateIgnore.add(name);
		window.__studentUpdateTimestamp = Date.now();
		
		// æ¸…ç†æ ‡è®°ï¼ˆ5ç§’åï¼‰
		setTimeout(() => {
			if (window.__studentUpdateIgnore) {
				window.__studentUpdateIgnore.delete(name);
			}
		}, 5000);
		
		Object.assign(it, patch||{}, { updated_at:now() }); 
		save(); 
		syncStoreItemToCloud(it); 
		refreshUI(); 
		refreshBTM(); 
	}
	
	// å¤„ç†è¿œç¨‹æ›´æ–°ï¼ˆé¿å…å¾ªç¯åŒæ­¥ï¼‰
	function handleRemoteUpdate(payload) {
		try {
			const row = payload.new || payload.old;
			if (!row) return;
			
			if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
				let student = findByName(row.name);
				let changed = false;
				
				if (!student && payload.eventType === 'INSERT') {
					// æ–°å¢å­¦ç”Ÿ
					student = {
						id: crypto.randomUUID ? crypto.randomUUID() : ('id_' + Math.random().toString(36).slice(2)),
						name: row.name,
						grade: row.grade || '',
						major: row.major || '',
						remark: '',
						archived: false,
						created_at: now(),
						updated_at: now()
					};
					store.items.push(student);
					changed = true;
				} else if (student && payload.eventType === 'UPDATE') {
					// æ›´æ–°å­¦ç”Ÿ
					if (student.grade !== (row.grade || '')) {
						student.grade = row.grade || '';
						changed = true;
					}
					if (student.major !== (row.major || '')) {
						student.major = row.major || '';
						changed = true;
					}
					if (changed) {
						student.updated_at = now();
					}
				}
				
				if (changed) {
					save();
					refreshUI();
					refreshBTM();
					console.log('[StudentLibrary] è¿œç¨‹æ›´æ–°åŒæ­¥:', row.name);
				}
			} else if (payload.eventType === 'DELETE' && payload.old) {
				// åˆ é™¤å­¦ç”Ÿ - å¢å¼ºå¤„ç†é€»è¾‘
				const targetName = payload.old.name;
				console.log('[StudentLibrary] å¤„ç†åˆ é™¤äº‹ä»¶:', { targetName, localCount: store.items.length });
				
				// ç²¾ç¡®åŒ¹é…ï¼ˆè€ƒè™‘å­—ç¬¦ä¸²æ¯”è¾ƒçš„é—®é¢˜ï¼‰
				let index = store.items.findIndex(s => s.name === targetName);
				
				// å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•trimååŒ¹é…ï¼ˆé˜²æ­¢ç©ºæ ¼é—®é¢˜ï¼‰
				if (index < 0) {
					index = store.items.findIndex(s => s.name?.trim() === targetName?.trim());
					if (index >= 0) {
						console.warn('[StudentLibrary] ä½¿ç”¨trimåŒ¹é…æ‰¾åˆ°å­¦ç”Ÿ:', { original: store.items[index].name, target: targetName });
					}
				}
				
				if (index >= 0) {
					const removedStudent = store.items[index];
					store.items.splice(index, 1);
					save();
					refreshUI();
					refreshBTM();
					console.log('[StudentLibrary] è¿œç¨‹åˆ é™¤åŒæ­¥æˆåŠŸ:', { name: removedStudent.name, remainingCount: store.items.length });
				} else {
					// æä¾›æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
					const localNames = store.items.map(s => s.name);
					console.warn('[StudentLibrary] æœªåœ¨æœ¬åœ°æ‰¾åˆ°å¾…åˆ é™¤å­¦ç”Ÿ:', {
						targetName,
						targetType: typeof targetName,
						targetLength: targetName?.length,
						localNames,
						localCount: localNames.length,
						exactMatches: localNames.filter(n => n === targetName),
						trimMatches: localNames.filter(n => n?.trim() === targetName?.trim())
					});
					
					// è§¦å‘å¯¹è´¦
					if (window.reconcileStudentsWithCloud) {
						setTimeout(()=>{ try{ window.reconcileStudentsWithCloud(); }catch(_){ } }, 300);
					}
				}
			}
		} catch (error) {
			console.error('[StudentLibrary] å¤„ç†è¿œç¨‹æ›´æ–°å¤±è´¥:', error);
		}
	}
	// æ‰“å¼€ç¼–è¾‘å­¦ç”Ÿå¼¹çª—ï¼ˆæ”¯æŒæ”¹åã€å¹´çº§ã€ä¸“ä¸šï¼‰
	function openEditStudent(oldName){
		const stu=findByName(oldName); if(!stu){ alert('æœªæ‰¾åˆ°å­¦ç”Ÿ'); return; }
		let wrap=document.getElementById('editStudentModal');
		if(!wrap){
			wrap=document.createElement('div'); wrap.id='editStudentModal'; wrap.style.cssText='position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:6200;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);';
			wrap.innerHTML=`<div style="width:360px;max-width:92%;background:#fff;border-radius:14px;padding:20px 22px;box-shadow:0 8px 32px rgba(0,0,0,.25);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;">
				<div style="font-size:16px;font-weight:600;margin-bottom:14px;letter-spacing:.5px;color:#1f2937;">ç¼–è¾‘å­¦ç”Ÿ</div>
				<div style="display:flex;flex-direction:column;gap:12px;">
					<label style="display:flex;flex-direction:column;gap:6px;font-size:13px;color:#1f2937;font-weight:500;">å§“å<input id=\"esName\" type=\"text\" style=\"padding:12px 14px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;color:#1f2937;background:#fafafa;transition:all 0.2s ease;outline:none;\" onfocus=\"this.style.borderColor='#2563eb';this.style.background='#fff';\" onblur=\"this.style.borderColor='#e5e7eb';this.style.background='#fafafa';\" /></label>
					<label style="display:flex;flex-direction:column;gap:6px;font-size:13px;color:#1f2937;font-weight:500;">å¹´çº§<input id=\"esGrade\" type=\"text\" style=\"padding:12px 14px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;color:#1f2937;background:#fafafa;transition:all 0.2s ease;outline:none;\" onfocus=\"this.style.borderColor='#2563eb';this.style.background='#fff';\" onblur=\"this.style.borderColor='#e5e7eb';this.style.background='#fafafa';\" /></label>
					<label style="display:flex;flex-direction:column;gap:6px;font-size:13px;color:#1f2937;font-weight:500;">ä¸“ä¸š<input id=\"esMajor\" type=\"text\" style=\"padding:12px 14px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;color:#1f2937;background:#fafafa;transition:all 0.2s ease;outline:none;\" onfocus=\"this.style.borderColor='#2563eb';this.style.background='#fff';\" onblur=\"this.style.borderColor='#e5e7eb';this.style.background='#fafafa';\" /></label>
					<div id=\"esProgress\" style=\"display:none;font-size:12px;color:#0f172a;background:#f1f5f9;border:1px solid #cbd5e1;padding:6px 8px;border-radius:6px;line-height:1.5;\">\n<span id=\"esProgText\">åŒæ­¥ä¸­...</span>\n<div style=\"height:6px;background:#e2e8f0;border-radius:4px;margin-top:6px;overflow:hidden;\">\n<div id=\"esProgBar\" style=\"height:100%;width:0%;background:linear-gradient(90deg,#2563eb,#3b82f6);transition:width .3s;\"></div>\n</div>\n</div>
					<div style="display:flex;gap:12px;justify-content:flex-end;margin-top:8px;">
						<button id=\"esCancel\" style=\"padding:10px 18px;border:2px solid #e5e7eb;background:#fff;color:#6b7280;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s ease;\" onmouseover=\"this.style.borderColor='#d1d5db';this.style.color='#374151';\" onmouseout=\"this.style.borderColor='#e5e7eb';this.style.color='#6b7280';\">å–æ¶ˆ</button>
						<button id=\"esSave\" style=\"padding:10px 18px;border:2px solid #2563eb;background:#2563eb;color:#fff;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s ease;box-shadow:0 2px 4px rgba(37,99,235,0.2);\" onmouseover=\"this.style.background='#1d4ed8';this.style.borderColor='#1d4ed8';this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 8px rgba(37,99,235,0.3)';\" onmouseout=\"this.style.background='#2563eb';this.style.borderColor='#2563eb';this.style.transform='translateY(0)';this.style.boxShadow='0 2px 4px rgba(37,99,235,0.2)';\">ä¿å­˜</button>
					</div>
				</div>`;
			wrap.addEventListener('click',e=>{ if(e.target===wrap) close(); });
			document.body.appendChild(wrap);
		}
		const nameInput=wrap.querySelector('#esName'); const gradeInput=wrap.querySelector('#esGrade'); const majorInput=wrap.querySelector('#esMajor'); const progBox=wrap.querySelector('#esProgress'); const progText=wrap.querySelector('#esProgText'); const progBar=wrap.querySelector('#esProgBar');
		function close(){ wrap.style.display='none'; }
		// é‡ç½®è¿›åº¦æ¡çŠ¶æ€
		progBox.style.display='none'; progText.textContent='åŒæ­¥ä¸­...'; progBar.style.width='0%'; progBar.style.background='linear-gradient(90deg,#2563eb,#3b82f6)';
		wrap.style.display='flex'; nameInput.value=stu.name; gradeInput.value=stu.grade||''; majorInput.value=stu.major||''; nameInput.focus();
		wrap.querySelector('#esCancel').onclick=close;
		wrap.querySelector('#esSave').onclick=async ()=>{
			const newName=nameInput.value.trim(); const newGrade=gradeInput.value.trim(); const newMajor=majorInput.value.trim(); if(!newName){ alert('å§“åä¸èƒ½ä¸ºç©º'); nameInput.focus(); return; }
			if(newName!==oldName && findByName(newName)){ alert('å·²å­˜åœ¨åŒåå­¦ç”Ÿ'); return; }
			stu.name=newName; stu.grade=newGrade; stu.major=newMajor; stu.updated_at=now(); save(); refreshUI(); refreshBTM();
			if(!window.supabaseClient){ close(); if(window.toast) toast('ç¦»çº¿ï¼šä»…æœ¬åœ°ä¿å­˜','warn'); return; }
			progBox.style.display='block'; progText.textContent='åŒæ­¥å­¦ç”Ÿä¿¡æ¯...'; progBar.style.width='12%';
			try{
				function step(p,msg){ progBar.style.width=p+'%'; if(msg) progText.textContent=msg; }
				const basePayload={ name:newName, grade:newGrade||'', major:newMajor||'' };
				// æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨è¯¥ name
				let exists=false; try{ const { data:ex, error:exErr } = await supabaseClient.from('student_database').select('name').eq('name', newName).limit(1); if(!exErr && ex && ex.length) exists=true; }catch(_){ }
				if(!exists){
					// ç›´æ¥æ’å…¥ï¼Œè‹¥è¿å (name,major) ç»„åˆå”¯ä¸€åˆ™æç¤ºå¹¶ç»ˆæ­¢
					const ins=await supabaseClient.from('student_database').insert([basePayload]); if(ins.error){ throw new Error('å­¦ç”Ÿæ’å…¥å¤±è´¥: '+ins.error.message); }
				}else{
					// æ›´æ–° major/gradeï¼Œä¸è§¦ç¢° name
					const upd=await supabaseClient.from('student_database').update({ major:basePayload.major, grade:basePayload.grade }).eq('name', newName);
					if(upd.error){ throw new Error('å­¦ç”Ÿæ›´æ–°å¤±è´¥: '+upd.error.message); }
				}
				step(40,'å­¦ç”Ÿä¿¡æ¯å·²åŒæ­¥');
				if(newName!==oldName){
					// 1) æ›´æ–°æ‰€æœ‰æ—¶é—´æ®µå¼•ç”¨ (RPC ä¼˜å…ˆ)
					try{ const rpc=await supabaseClient.rpc('rename_student_slots',{ old_name:oldName, new_name:newName }); if(rpc.error) throw rpc.error; }
					catch(e){ const upd=await supabaseClient.from('student_time_slots').update({ student_name:newName }).eq('student_name', oldName); if(upd.error) throw new Error('æ—¶é—´æ®µé‡å‘½åå¤±è´¥: '+upd.error.message); }
					step(60,'æ—¶é—´æ®µå¼•ç”¨å·²æ›´æ–°');
					// 2) åˆ é™¤æ—§ student_database è®°å½•ï¼ˆè‹¥å­˜åœ¨ï¼‰
					const delOld=await supabaseClient.from('student_database').delete().eq('name', oldName); if(delOld.error){ console.warn('[StudentLibrary] åˆ é™¤æ—§å­¦ç”Ÿè®°å½•å¤±è´¥', delOld.error.message); }
					step(70,'æ—§åç§°æ¸…ç†å®Œæˆ');
				}
				setTimeout(()=>{ try{ if(typeof syncStudentDatabaseToCloud==='function'){ syncStudentDatabaseToCloud(store.items.map(s=>({ name:s.name, major:s.major||'', grade:s.grade||'' }))); } }catch(_){ } }, 20);
				step(92,'åˆ·æ–°ç•Œé¢...'); await new Promise(r=>requestAnimationFrame(r)); step(100,'å®Œæˆ'); setTimeout(()=>close(),500);
				if(window.toast) toast('å­¦ç”Ÿå·²åŒæ­¥','success');
			}catch(err){ progBar.style.width='100%'; progBar.style.background='#dc2626'; progText.textContent=err.message||err; if(newName!==oldName){ // å›æ»šæœ¬åœ°åç§°
				stu.name=oldName; save(); refreshUI(); }
			}
		};
	}
	// å½’æ¡£åŠŸèƒ½å·²ç§»é™¤
	function deleteStudent(name){ 
		const idx=store.items.findIndex(s=>s.name===name); 
		if(idx>=0){ 
			// æ ‡è®°æœ¬åœ°æ›´æ–°ï¼Œé¿å…å®æ—¶åŒæ­¥å¾ªç¯
			if (!window.__studentUpdateIgnore) window.__studentUpdateIgnore = new Set();
			window.__studentUpdateIgnore.add(name);
			window.__studentUpdateTimestamp = Date.now();
			
			// æ¸…ç†æ ‡è®°ï¼ˆ5ç§’åï¼‰
			setTimeout(() => {
				if (window.__studentUpdateIgnore) {
					window.__studentUpdateIgnore.delete(name);
				}
			}, 5000);
			
			const [removed]=store.items.splice(idx,1); 
			save(); 
			enqueue({ type:'delete', payload:{ name: removed.name } }); 
			refreshUI(); 
			refreshBTM(); 
		} 
	}

	// äº‘ç«¯å¯¹è´¦ï¼šç”¨äºå¤„ç†å¶å‘åˆ é™¤é—æ¼ï¼ˆç½‘ç»œæŠ–åŠ¨ / äº‹ä»¶ä¸¢å¤±ï¼‰
	window.reconcileStudentsWithCloud = async function(){
		if(!window.supabaseClient || !window.supabaseReady) return;
		try{
			const { data, error } = await supabaseClient.from('student_database').select('name,major,grade');
			if(error){ console.warn('[StudentLibrary][reconcile] æ‹‰å–å¤±è´¥', error.message); return; }
			const cloudNames = new Set((data||[]).map(r=>r.name));
			const localNames = new Set(store.items.map(s=>s.name));
			// æ‰¾å‡ºæœ¬åœ°å¤šä½™ï¼ˆåº”åˆ é™¤ï¼‰
			let removed=0;
			for(const n of [...localNames]){
				if(!cloudNames.has(n)){
					const i = store.items.findIndex(s=>s.name===n);
					if(i>=0){ store.items.splice(i,1); removed++; }
				}
			}
			if(removed>0){ save(); refreshUI(); refreshBTM(); console.log(`[StudentLibrary][reconcile] æ¸…ç†æœ¬åœ°å¤šä½™ ${removed} æ¡`); }
		}catch(e){ console.warn('[StudentLibrary][reconcile] å¼‚å¸¸', e.message); }
	};
	function refreshBTM(){ if(window.BTM){ try{ BTM.buildStudents(); BTM.buildSelections(); BTM.applyFilter(); }catch(e){ console.warn('[StudentLibrary] refreshBTM failed', e); } } }
	window.getAllActiveStudents = () => getAll(false).map(s=>({ name:s.name, grade:s.grade, major:s.major }));
	// UI
	let panel,listEl,searchEl,addBtn,addForm,showArchivedCb,exportBtn;
	function initDom(){ panel=document.getElementById('studentLibraryPanel'); listEl=document.getElementById('slList'); searchEl=document.getElementById('slSearch'); addBtn=document.getElementById('slAddBtn'); addForm=document.getElementById('slAddForm'); showArchivedCb=document.getElementById('slShowArchived'); }

	// ===== å«æ—¶é—´æ®µå¯¼å‡º (æ— éœ€å…ˆæ‰“å¼€ BTM) =====
	async function fetchAllSlotsMap(){
		const map={}; if(!window.supabaseClient){ return map; }
		try{ const {data,error}=await supabaseClient.from('student_time_slots').select('*'); if(error){ console.warn('fetchAllSlotsMap error', error); return map; } (data||[]).forEach(r=>{ const name=r.student_name; if(!map[name]) map[name]={monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]}; const weekdayMap=['monday','tuesday','wednesday','thursday','friday'][r.weekday-1]; if(!weekdayMap) return; map[name][weekdayMap].push({start:r.start_time,end:r.end_time}); }); Object.values(map).forEach(week=>{ Object.values(week).forEach(arr=>arr.sort((a,b)=>a.start.localeCompare(b.start))); }); }catch(e){ console.warn('fetchAllSlotsMap exception', e); }
		return map;
	}
	function weekSlotsToString(week){ if(!week) return ''; const order=['monday','tuesday','wednesday','thursday','friday']; const res={}; order.forEach(d=>{ const arr=(week[d]||[]).filter(sl=>/^\d{2}:\d{2}$/.test(sl.start)&&/^\d{2}:\d{2}$/.test(sl.end)); res[d]=arr.map(sl=>`${sl.start}-${sl.end}`).join(';'); }); return res; }
	async function exportCSVWithSlots(){
		try{
			const slotsMap=await fetchAllSlotsMap();
			const header=['name','grade','major','remark','mon','tue','wed','thu','fri'];
			const lines=[header.join(',')];
			getAll(true).forEach(s=>{ const week=weekSlotsToString(slotsMap[s.name]); const row=[s.name,s.grade||'',s.major||'',(s.remark||'').replace(/\r|\n/g,' '),week.monday||'',week.tuesday||'',week.wednesday||'',week.thursday||'',week.friday||'']; lines.push(row.map(v=>{ if(/[",\n]/.test(v)) return '"'+v.replace(/"/g,'""')+'"'; return v; }).join(',')); });
			const csv=lines.join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='students_with_slots_'+Date.now()+'.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
		}catch(e){ alert('å¯¼å‡ºå¤±è´¥:'+e.message); }
	}
	function parseCSV(text){
		const rows=[]; let cur=''; let inQuotes=false; let row=[]; for(let i=0;i<text.length;i++){ const ch=text[i]; if(inQuotes){ if(ch==='"'){ if(text[i+1]==='"'){ cur+='"'; i++; } else { inQuotes=false; } } else { cur+=ch; } } else { if(ch==='"'){ inQuotes=true; } else if(ch===','){ row.push(cur.trim()); cur=''; } else if(ch==='\n' || ch==='\r'){ if(ch==='\r' && text[i+1]==='\n') i++; row.push(cur.trim()); if(row.some(cell=>cell.length>0)) rows.push(row); row=[]; cur=''; } else { cur+=ch; } } } if(cur.length>0 || row.length>0){ row.push(cur.trim()); rows.push(row); }
		return rows;
	}
	// ç§»é™¤æ™®é€š CSV å¯¼å…¥é€»è¾‘ï¼Œä»…ä¿ç•™å«æ—¶é—´æ®µç‰ˆæœ¬
	// å«æ—¶é—´æ®µå¯¼å…¥ï¼šè¦†ç›–å‘¨ä¸€~å‘¨äº”å…¨éƒ¨æ—¶é—´æ®µ
	async function importCSVSlotsText(text){
		// æå‰åˆ›å»ºè¿›åº¦æ¡ï¼Œæ”¾ç½®åœ¨å­¦ç”Ÿåº“é¢æ¿åº•éƒ¨
		const progId='slotImportProgress'; let prog=document.getElementById(progId); if(!prog){
			prog=document.createElement('div'); prog.id=progId; prog.style.cssText='margin:8px 12px 12px; background:#f1f5f9; border:1px solid #cbd5e1; border-radius:6px; font-size:12px; line-height:1.4; color:#0f172a; padding:6px 10px; display:flex; flex-direction:column; gap:4px;';
			const bar=document.createElement('div'); bar.style.cssText='height:6px;background:#e2e8f0;border-radius:4px;overflow:hidden;position:relative;';
			const inner=document.createElement('div'); inner.style.cssText='height:100%;width:0%;background:linear-gradient(90deg,#2563eb,#3b82f6);transition:width .25s ease;'; inner.id='slotImportProgressBar'; bar.appendChild(inner);
			const text=document.createElement('div'); text.id='slotImportProgressText';
			prog.appendChild(text); prog.appendChild(bar);
			// æ”¾åœ¨å­¦ç”Ÿåº“é¢æ¿å†…ï¼Œè‹¥é¢æ¿å­˜åœ¨; å¦åˆ™é™„åŠ åˆ° body
			const panel=document.getElementById('studentLibraryPanel'); if(panel){ panel.appendChild(prog); } else { document.body.appendChild(prog); }
		}
		function setProg(msg, percent){ const txt=prog.querySelector('#slotImportProgressText'); if(txt) txt.textContent=msg; if(typeof percent==='number'){ const bar=prog.querySelector('#slotImportProgressBar'); if(bar) bar.style.width=Math.min(100,Math.max(0,percent))+'%'; } }
		setProg('è§£æ CSV...',0); await new Promise(r=>requestAnimationFrame(r));
		const parseT0=performance.now();
		const rows=parseCSV(text); if(!rows.length){ prog.remove(); alert('CSV ç©º'); return; }
		let header=rows[0].map(h=>h.toLowerCase()); let start=1; if(!header.includes('name')){ header=['name','grade','major','remark','mon','tue','wed','thu','fri']; start=0; }
		const idxName=header.indexOf('name'); const idxGrade=header.indexOf('grade'); const idxMajor=header.indexOf('major'); const idxRemark=header.indexOf('remark'); const idxMon=header.indexOf('mon'); const idxTue=header.indexOf('tue'); const idxWed=header.indexOf('wed'); const idxThu=header.indexOf('thu'); const idxFri=header.indexOf('fri');
		if(idxName<0){ prog.remove(); alert('ç¼ºå°‘ name åˆ—'); return; }
		let inserted=0, updated=0, skipped=0, slotTotal=0, slotInvalid=0; const slotRows=[]; const nowTs=now();
		for(let i=start;i<rows.length;i++){
			const r=rows[i]; if(!r.length) continue; const name=(r[idxName]||'').trim(); if(!name){ skipped++; continue; }
			const grade=idxGrade>=0?(r[idxGrade]||''):''; const major=idxMajor>=0?(r[idxMajor]||''):''; const remark=idxRemark>=0?(r[idxRemark]||''):'';
			let student=findByName(name); if(!student){ student={ id:crypto.randomUUID?crypto.randomUUID():('id_'+Math.random().toString(36).slice(2)), name, grade, major, remark, archived:false, created_at:nowTs, updated_at:nowTs }; store.items.push(student); inserted++; } else { let changed=false; if(grade && grade!==student.grade){ student.grade=grade; changed=true;} if(major && major!==student.major){ student.major=major; changed=true;} if(remark && remark!==student.remark){ student.remark=remark; changed=true;} if(changed){ student.updated_at=nowTs; updated++; } }
			const dayCols=[idxMon,idxTue,idxWed,idxThu,idxFri]; dayCols.forEach((col,di)=>{ if(col<0) return; const cell=(r[col]||'').trim(); if(!cell) return; cell.split(/;|ï¼›/).forEach(seg=>{ seg=seg.trim(); if(!seg) return; if(!/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(seg)){ slotInvalid++; return; } let [s,e]=seg.split('-'); const ns=s.padStart(5,'0'); const ne=e.padStart(5,'0'); if(ns>=ne){ slotInvalid++; return; } slotRows.push({ student_name:name, weekday:di+1, start_time:ns, end_time:ne }); slotTotal++; }); });
			if(i%400===0){ const p=Math.round(((i-start+1)/(rows.length-start))*15); setProg(`è§£æä¸­... ${(i-start+1)}/${rows.length-start}`,p); await new Promise(r=>requestAnimationFrame(r)); }
		}
		const parseMs=Math.round(performance.now()-parseT0);
		setProg(`è§£æå®Œæˆ(${rows.length-start}è¡Œ, ç”¨æ—¶${parseMs}ms)ï¼Œå‡†å¤‡åŒæ­¥å­¦ç”Ÿ...`,18);
		save(); refreshUI(); refreshBTM();
		// å­¦ç”ŸåŒæ­¥æ”¾åå°ï¼Œä¸é˜»å¡è¿›åº¦æ¡ç»§ç»­
		if(window.supabaseReady && window.supabaseClient){
			(async()=>{ try{ const rowsForCloud = store.items.map(s=>({ name:s.name, major:s.major||'', grade:s.grade||'' })); if(typeof syncStudentDatabaseToCloud==='function') await syncStudentDatabaseToCloud(rowsForCloud); }catch(e){ console.warn('[StudentLibrary] å­¦ç”Ÿä¿¡æ¯åŒæ­¥å¼‚å¸¸', e); }})();
		}
		if(!window.supabaseClient){ setProg('æ—  Supabase è¿æ¥ï¼Œä»…æœ¬åœ°æ›´æ–°',25); setTimeout(()=>prog.remove(),3000); alert(`å¯¼å…¥å®Œæˆ(ç¦»çº¿)ã€‚å­¦ç”Ÿ: æ–°å¢${inserted} æ›´æ–°${updated} è·³è¿‡${skipped} æ—¶é—´æ®µ${slotTotal} æ— æ•ˆ${slotInvalid}`); return; }
		const t0=performance.now();
		const names=[...new Set(slotRows.map(r=>r.student_name))];
		setProg('åˆ é™¤æ—§æ—¶é—´æ®µ...',30);
		if(names.length){ const delRes=await supabaseClient.from('student_time_slots').delete().in('student_name', names); if(delRes.error){ setProg('åˆ é™¤å¤±è´¥: '+delRes.error.message,30); alert('åˆ é™¤æ—§æ—¶é—´æ®µå¤±è´¥:'+delRes.error.message); return; } }
		setProg('å†™å…¥æ–°æ—¶é—´æ®µå‡†å¤‡ä¸­...',35);
		const allRows=slotRows.map(r=>{ const [sh,sm]=r.start_time.split(':').map(Number); const [eh,em]=r.end_time.split(':').map(Number); return { ...r, duration_minutes:(eh*60+em)-(sh*60+sm) }; });
		const total=allRows.length; const BATCH=600; let ok=0, fail=0; const errors=[]; let lastPercent=-1;
		for(let i=0;i<allRows.length;i+=BATCH){ const slice=allRows.slice(i,i+BATCH); const res=await supabaseClient.from('student_time_slots').insert(slice); if(res.error){ fail+=slice.length; errors.push(res.error.message); } else { ok+=slice.length; } const percent=Math.min(100,Math.round(((i+slice.length)/total)*100)); if(percent!==lastPercent){ // å°†å†™å…¥è¿›åº¦æ˜ å°„åˆ° 40%~95%
			const mapped=40 + Math.round(percent*0.55); setProg(`å†™å…¥ä¸­ ${percent}% (${ok+fail}/${total})`, mapped); lastPercent=percent; } await new Promise(r=>requestAnimationFrame(r)); }
		const ms=Math.round(performance.now()-t0);
		setProg(`å®Œæˆ: æˆåŠŸ${ok} å¤±è´¥${fail} ç”¨æ—¶${ms}ms`+(errors.length? ' é”™è¯¯:'+errors[0] : ''),100);
		setTimeout(()=>{ try{ prog.remove(); }catch(_){} }, 5000);
		if(window.BTM){ try{ await BTM.loadRemote(); BTM.buildSelections(); }catch(_){ } }
		alert(`å¯¼å…¥å®Œæˆ: å­¦ç”Ÿ æ–°å¢${inserted} æ›´æ–°${updated} è·³è¿‡${skipped}; æ—¶é—´æ®µæœ‰æ•ˆ${slotTotal} æ— æ•ˆ${slotInvalid}; æˆåŠŸ${ok} å¤±è´¥${fail}` + (errors.length?`\né¦–æ¡é”™è¯¯: ${errors[0]}`:''));
	}
	function openPanel(){ initDom(); if(!panel) return; panel.style.display='flex'; renderList(); updateTotal(); }
	// ä¿®æ”¹ openPanel: æ‰“å¼€æ—¶å°è¯• hydration
	async function openPanel(){ 
		initDom(); if(!panel) return; panel.style.display='flex'; 
		const list=document.getElementById('slList'); 
		const showSkeleton=()=>{ if(!list) return; list.innerHTML=`<div style=\"display:flex;flex-direction:column;gap:8px;padding:4px;\">${Array.from({length:5}).map(()=>'<div style=\"height:44px;border:1px solid #e2e8f0;border-radius:8px;position:relative;overflow:hidden;background:linear-gradient(90deg,#f1f5f9,#e2e8f0,#f1f5f9);background-size:200% 100%;animation:slShine 1.15s infinite;\"></div>').join('')}<style>@keyframes slShine{0%{background-position:0 0}100%{background-position:-200% 0}}</style><div style=\"font-size:12px;color:#64748b;padding:4px 2px;\" id=\"slLoadingHint\">æ­£åœ¨è¿æ¥å¹¶åŠ è½½å­¦ç”Ÿæ•°æ®...</div></div>`; };
		if(store.items.length===0) showSkeleton();
		// å¹¶å‘è§¦å‘ hydration
		try{ if(window.ensureStudentLibraryHydrated){ window.ensureStudentLibraryHydrated({ source:'open-panel' }); } }catch(_){ }
		// è‹¥é¦–æ¬¡ä¸”ä¸ºç©ºï¼šç­‰å¾… supabaseReady ç„¶åå†æ‹‰ä¸€æ¬¡
		if(store.items.length===0){
			await waitSupabaseReady(6000);
			try{ await loadFromCloud(); }catch(_){ }
			if(store.items.length===0){
				// å†åš 2 æ¬¡å¿«é€Ÿé‡è¯•
				for(let i=1;i<=2 && store.items.length===0;i++){
					await new Promise(r=>setTimeout(r,300*i));
					try{ await loadFromCloud(); }catch(_){ }
				}
			}
		}
		// æœ€ç»ˆæ¸²æŸ“
		renderList(); updateTotal();
		const hint=document.getElementById('slLoadingHint'); if(hint && store.items.length===0){ hint.textContent='æš‚æ— å­¦ç”Ÿæ•°æ®ï¼Œå¯æ‰‹åŠ¨æ·»åŠ æˆ–ç¨åé‡è¯•'; }
	}
	function closePanel(){ if(panel) panel.style.display='none'; }
	function toggleAddForm(show){ if(!addForm) return; addForm.style.display=show?'flex':'none'; if(show){ const n=document.getElementById('slName'); n&&n.focus(); } }
	function updateTotal(){ const el=document.getElementById('slTotal'); if(el) el.textContent=getAll().length+' äºº'; }
	function renderList(){ if(!listEl) return; const kw=(searchEl?.value||'').trim().toLowerCase(); const rows=getAll().filter(s=> !kw || s.name.toLowerCase().includes(kw) || (window.matchPinyin?matchPinyin(s.name,kw):false)); if(!rows.length){ listEl.innerHTML='<div style="padding:12px;color:#64748b;font-style:italic;">æ— æ•°æ®</div>'; return;} listEl.innerHTML=rows.map(s=>{ return `<div class=\"sl-row\" data-name=\"${s.name}\" style=\"display:flex;flex-direction:column;gap:4px;padding:8px 10px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;\">\n<div style=\"display:flex;align-items:center;gap:8px;\">\n<span style=\"font-weight:600;\">${s.name}</span><span style=\"font-size:11px;color:#475569;\">${s.major||'--'} Â· ${s.grade||'--'}</span>\n<span style=\"margin-left:auto;display:flex;gap:6px;\">\n<button data-act=\"edit\" class=\"sl-btn sl-btn-secondary sl-btn-mini\">ç¼–è¾‘</button>\n<button data-act=\"delete\" class=\"sl-btn sl-btn-danger sl-btn-mini\">åˆ é™¤</button>\n</span></div>\n</div>`; }).join(''); listEl.querySelectorAll('.sl-row button').forEach(btn=>{ btn.onclick=()=>{ const act=btn.dataset.act; const name=btn.closest('.sl-row').dataset.name; if(!name) return; if(act==='delete'){ if(confirm('æ°¸ä¹…åˆ é™¤ '+name+' åŠå…¶æ—¶é—´æ®µï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤')){ deleteStudent(name); try{ if(window.supabaseClient){ supabaseClient.from('student_time_slots').delete().eq('student_name', name); } }catch(_){} } } else if(act==='edit'){ openEditStudent(name); } }; }); }
	function refreshUI(){
		renderList(); updateTotal();
		// è‹¥å­¦ç”Ÿé€‰æ‹©å¼¹çª—å¼€å¯, åŒæ­¥åˆ·æ–°é‡Œé¢çš„åˆ—è¡¨(è°ƒç”¨ä¸Šå±‚ renderStudentList)
		try{ const modal=document.getElementById('studentModalBackdrop'); if(modal && modal.style.display==='flex' && typeof renderStudentList==='function'){ renderStudentList(); } }catch(_){ }
	}
	function bindGlobalButtons(){ if(!document.getElementById('openStudentLibraryBtn')){ const topBar=document.querySelector('header .top-actions')||document.querySelector('header'); if(topBar){ const btn=document.createElement('button'); btn.id='openStudentLibraryBtn'; btn.textContent='å­¦ç”Ÿåº“'; btn.style.cssText='margin-left:8px;padding:6px 14px;background:#1e3a8a;color:#fff;border:1px solid #1e40af;border-radius:6px;cursor:pointer;font-size:13px;'; btn.onclick=openPanel; topBar.appendChild(btn);} } }
	function exportJSON(){} // å ä½ï¼Œä¸å†æš´éœ² JSON å¯¼å‡º
	document.addEventListener('DOMContentLoaded', async () => {
		// ç­‰å¾… Supabase (è‹¥é¡µé¢åˆšé€šè¿‡å¯†ç è¿›å…¥, è„šæœ¬åˆå§‹åŒ–å¯èƒ½ç¨åå®Œæˆ)
		await waitSupabaseReady(6000);
		
		let cloudLoaded = false;
		try { cloudLoaded = await loadFromCloud(); } catch(_){ }
		
		if (!cloudLoaded) {
			console.log('[StudentLibrary] é¦–æ¬¡äº‘ç«¯æœªåŠ è½½æˆåŠŸï¼Œå°è¯•æœ¬åœ°/è¿ç§»');
			load();
			migrateFromRoomStore();
		}
		
		// é¦–æ¬¡å®Œå…¨ç©º -> é‡è¯•äº‘ç«¯æ‹‰å–ï¼ˆé€€é¿ 5 æ¬¡ï¼‰
		if (store.items.length === 0) {
			console.log('[StudentLibrary] é¦–æ¬¡åˆ—è¡¨ä¸ºç©ºï¼Œå¯åŠ¨é‡è¯•åŠ è½½');
			for(let i=1;i<=5 && store.items.length===0;i++){
				await new Promise(r=>setTimeout(r, 400*i));
				if(!window.supabaseReady) continue;
				try{
					const ok = await loadFromCloud();
					if(ok && store.items.length>0){ console.log(`[StudentLibrary] ç¬¬ ${i} æ¬¡é‡è¯•æˆåŠŸ`); break; }
				}catch(e){ console.warn('[StudentLibrary] é‡è¯•åŠ è½½å¼‚å¸¸', e.message); }
			}
			// ä»ä¸ºç©ºå†åš hydration å…œåº•
			if(store.items.length===0 && window.ensureStudentLibraryHydrated){
				try{ await window.ensureStudentLibraryHydrated({ source:'retry-hydrate' }); }catch(_){ }
			}
		}
		
		// åˆå§‹åŒ–UIå’Œç»‘å®šäº‹ä»¶
		bindGlobalButtons(); 
		initDom(); 
		refreshUI(); 
		
		const openBtn=document.getElementById('openStudentLibraryBtn'); 
		if(openBtn && !openBtn.dataset.bound){ 
			openBtn.dataset.bound='1'; 
			openBtn.addEventListener('click', openPanel); 
		} 
		
		const closeBtn=document.getElementById('slCloseBtn'); 
		if(closeBtn) closeBtn.onclick=closePanel; 
		
		const addBtnEl=document.getElementById('slAddBtn'); 
		if(addBtnEl) addBtnEl.onclick=()=>toggleAddForm(true); 
		
		const cancel=document.getElementById('slCancelAdd'); 
		if(cancel) cancel.onclick=()=>toggleAddForm(false); 
		
		const submit=document.getElementById('slSubmitAdd'); 
		if(submit) submit.onclick=()=>{ 
			const nameEl=document.getElementById('slName'); 
			const gradeEl=document.getElementById('slGrade'); 
			const majorEl=document.getElementById('slMajor'); 
			const name=(nameEl.value||'').trim(); 
			if(!name){ 
				alert('å§“åå¿…å¡«'); 
				nameEl.focus(); 
				return;
			} 
			try{ 
				addStudent({ name, grade:gradeEl.value.trim(), major:majorEl.value.trim() }); 
				nameEl.value=gradeEl.value=majorEl.value=''; 
				toggleAddForm(false);
			}catch(e){ 
				alert(e.message||e); 
			} 
		}; 
		
		if(searchEl) searchEl.oninput=()=>refreshUI(); 
		if(exportBtn) exportBtn.onclick=exportJSON; 
		
		const openBTM=document.getElementById('slOpenBTMBtn'); 
		if(openBTM) openBTM.onclick=()=>{ 
			if(window.openBulkTimeManager) openBulkTimeManager(); 
			else alert('BTM æœªåŠ è½½'); 
		}; 
		
		// ä»…ç»‘å®šå«æ—¶é—´æ®µ CSV æŒ‰é’®
		const exportCsvSlotsBtn=document.getElementById('slExportCsvSlotsBtn'); 
		if(exportCsvSlotsBtn) exportCsvSlotsBtn.onclick=()=>exportCSVWithSlots();
		
		const importCsvSlotsBtn=document.getElementById('slImportCsvSlotsBtn'); 
		const importSlotsFile=document.getElementById('slImportCsvSlotsFile');
		if(importCsvSlotsBtn && importSlotsFile){ 
			importCsvSlotsBtn.onclick=()=>importSlotsFile.click(); 
			importSlotsFile.onchange=e=>{ 
				const file=e.target.files && e.target.files[0]; 
				if(!file) return; 
				const reader=new FileReader(); 
				reader.onload=async ev=>{ 
					try{ 
						await importCSVSlotsText(String(ev.target.result||'')); 
						importSlotsFile.value=''; 
					}catch(err){ 
						alert('å¯¼å…¥å¤±è´¥: '+(err.message||err)); 
					} 
				}; 
				reader.readAsText(file,'utf-8'); 
			}; 
		}
		
		// å»¶è¿Ÿå†æ¬¡å°è¯•å¡«å……ï¼ˆå¦‚æœä»ç„¶ä¸ºç©ºï¼‰
		setTimeout(async () => {
			if (store.items.length === 0) {
				console.log('[StudentLibrary] å»¶è¿Ÿæ£€æŸ¥ï¼šå­¦ç”Ÿåº“ä»ä¸ºç©ºï¼Œå†æ¬¡å°è¯•å¡«å……');
				if (window.seedStudentLibraryFromRoomStore) {
					window.seedStudentLibraryFromRoomStore({ reason: 'studentLibrary-post-init' });
				}
				// å†æ¬¡å°è¯•äº‘ç«¯åŠ è½½
				await loadFromCloud();
				refreshUI();
			}
		}, 1200);
	});
	// æ‰‹åŠ¨åŒæ­¥å­¦ç”Ÿæ•°æ®åŠŸèƒ½
	window.manualSyncStudentData = async function() {
		if (!window.supabaseClient) {
			console.warn('Supabase æœªè¿æ¥');
			return;
		}
		
		try {
			console.log('å¼€å§‹æ‰‹åŠ¨åŒæ­¥å­¦ç”Ÿæ•°æ®...');
			
			// è·å–äº‘ç«¯æœ€æ–°æ•°æ®
			const { data: cloudStudents, error } = await window.supabaseClient
				.from('student_database')
				.select('*')
				.order('updated_at', { ascending: false });
			
			if (error) {
				console.error('è·å–äº‘ç«¯å­¦ç”Ÿæ•°æ®å¤±è´¥:', error);
				if (window.toast) window.toast('âŒ åŒæ­¥å¤±è´¥: ' + error.message, 'error');
				return;
			}
			
			let updated = 0;
			let added = 0;
			
			if (cloudStudents && cloudStudents.length > 0) {
				// å®Œå…¨åŒæ­¥ï¼šæ¸…ç©ºæœ¬åœ°æ•°æ®ï¼Œä½¿ç”¨äº‘ç«¯æ•°æ®
				store.items = [];
				
				cloudStudents.forEach(cloudStudent => {
					const newStudent = {
						id: crypto.randomUUID ? crypto.randomUUID() : ('id_' + Math.random().toString(36).slice(2)),
						name: cloudStudent.name,
						grade: cloudStudent.grade || '',
						major: cloudStudent.major || '',
						remark: '',
						archived: false,
						created_at: cloudStudent.created_at ? new Date(cloudStudent.created_at).getTime() : now(),
						updated_at: cloudStudent.updated_at ? new Date(cloudStudent.updated_at).getTime() : now()
					};
					store.items.push(newStudent);
					added++;
				});
				
				// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
				save();
				refreshUI();
				refreshBTM();
			}
			
			// æ›´æ–°æ—§ç³»ç»Ÿçš„ Store.students
			if (window.Store && Array.isArray(window.Store.students)) {
				window.Store.students.splice(0, window.Store.students.length);
				store.items.forEach(item => {
					window.Store.students.push({
						name: item.name,
						grade: item.grade,
						major: item.major
					});
				});
				if (window.rebuildStudentIndex) {
					window.rebuildStudentIndex();
				}
			}
			
			console.log(`å­¦ç”Ÿæ•°æ®åŒæ­¥å®Œæˆ: åŒæ­¥äº†${added}ä¸ªå­¦ç”Ÿ`);
			if (window.toast) {
				window.toast(`âœ… å­¦ç”Ÿæ•°æ®åŒæ­¥å®Œæˆ: å…±${added}ä¸ªå­¦ç”Ÿ`, 'success');
			}
			
		} catch (error) {
			console.error('å­¦ç”Ÿæ•°æ®åŒæ­¥å¤±è´¥:', error);
			if (window.toast) window.toast('âŒ å­¦ç”Ÿæ•°æ®åŒæ­¥å¤±è´¥', 'error');
		}
	};
	
	window.StudentLibrary={ addStudent, updateStudent, deleteStudent, list:getAll, refresh:refreshUI, _handleRemoteUpdate: handleRemoteUpdate };
})();
</script>

<script>
// ======= Practice Alerts (ç¼ºå‹¤ / å¼‚å¸¸) =======
(function(){
	console.log('[PracticeAlerts] IIFE å¼€å§‹æ‰§è¡Œ');
	// --- Practice Alerts ç›¸å…³ SQL ç»´æŠ¤æŒ‡å¼•ï¼ˆå¤åˆ¶åˆ° Supabase SQL Editor æ‰§è¡Œï¼ŒåŒ¿å key ä¸èƒ½ç›´æ¥è·‘ DDLï¼‰ ---
	/*
	-- 1. å­—æ®µä¸æ™®é€šç´¢å¼•ï¼ˆå¹‚ç­‰ï¼‰
	ALTER TABLE public.practice_alerts ADD COLUMN IF NOT EXISTS severity integer;
	CREATE INDEX IF NOT EXISTS idx_practice_alerts_created_at ON public.practice_alerts(created_at DESC);
	CREATE INDEX IF NOT EXISTS idx_practice_alerts_student_type ON public.practice_alerts(student_name, type);

	-- 2. æ—§å”¯ä¸€ç´¢å¼•ï¼ˆè‹¥å·²å­˜åœ¨éœ€åˆ é™¤ï¼Œå…è®¸è¢«å¿½ç•¥åé‡æ–°ç”Ÿæˆæé†’ï¼‰
	DROP INDEX IF EXISTS uniq_practice_alerts_day; -- æ—§ï¼šä¸åŒºåˆ† ignored

	-- 3. æ–°æ¡ä»¶å”¯ä¸€ç´¢å¼•ï¼šåªé™åˆ¶æœªå¿½ç•¥è®°å½•ï¼Œignored=true åå¯å†ç”ŸæˆåŒç»„åˆæ–°æé†’
	CREATE UNIQUE INDEX IF NOT EXISTS uniq_practice_alerts_day_active
	ON public.practice_alerts (student_name, type, slot_start, slot_end, (date(created_at)))
	WHERE ignored = false;

	-- å›æ»šæ–¹å¼ï¼ˆè‹¥æƒ³æ¢å¤â€œå¿½ç•¥åä¸å†å‡ºç°â€è¡Œä¸ºï¼‰
	-- DROP INDEX IF EXISTS uniq_practice_alerts_day_active;
	-- CREATE UNIQUE INDEX IF NOT EXISTS uniq_practice_alerts_day
	-- ON public.practice_alerts (student_name, type, slot_start, slot_end, (date(created_at)));
	*/

	// å·²ç§»é™¤ UI å¤åˆ¶æé†’ç´¢å¼• SQL æŒ‰é’®
	if(window.PracticeAlerts) {
		console.log('[PracticeAlerts] å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
		return;
	}
		const AlertStore={ list:[], byId:new Map(), slotsToday:null, timer:null, lastSlotLoadDay:null, _lastPeriodicReload:0, dedupe:new Set(), silenced:new Map(), prevActive:new Map() };
		const ALERT_TYPES={ ABSENT:'absent', ANOMALY:'anomaly' };
		// é˜ˆå€¼å¯è°ƒï¼ˆåˆ†é’Ÿï¼‰
		const THRESHOLDS={ ABSENT_WINDOW_START:5, ABSENT_WINDOW_END:15, ANOMALY_OVERRUN:20, ENDED_OVERRUN:30, ABSENT_PAST_GRACE:10, START_ABSENT_CONFIRM_DELAY:2 }; // ABSENT_PAST_GRACE: è¿‡å» slot ç»“æŸåå¤šå°‘åˆ†é’Ÿä»å…è®¸è¡¥å‘ç¼ºå‹¤; START_ABSENT_CONFIRM_DELAY: å¼€å§‹çª—å£æŒç»­æ— é‡å ç¡®è®¤åˆ†é’Ÿæ•°
	function now(){ return Date.now(); }
	function fmt(ts){ const d=new Date(ts); return d.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); }
	function ensureSlotsLoaded(){ const todayKey=new Date().toDateString(); if(AlertStore.lastSlotLoadDay===todayKey && AlertStore.slotsToday) return Promise.resolve(); return loadTodaySlots(); }
	async function loadTodaySlots(){ if(!window.supabaseClient) return; const weekday=(new Date().getDay()+6)%7 +1; // 1-7; we only use 1-5
		try{ const {data,error}=await supabaseClient.from('student_time_slots').select('*').eq('weekday', weekday).order('start_time'); if(error){ console.warn('loadTodaySlots error', error); return; } const map={}; (data||[]).forEach(r=>{ if(!map[r.student_name]) map[r.student_name]=[]; map[r.student_name].push(r); }); AlertStore.slotsToday=map; AlertStore.lastSlotLoadDay=new Date().toDateString(); }catch(e){ console.error(e); }
	}
		function forceReloadSlots(){ AlertStore.lastSlotLoadDay=null; return ensureSlotsLoaded(); }
	function currentFilter(){ return AlertStore.filter||'all'; }
	function applyFilter(list){ const f=currentFilter(); if(f==='all') return list; if(f==='absent') return list.filter(a=>a.type==='absent'); if(f==='anomaly') return list.filter(a=>a.type==='anomaly'); return list; }
	function updateFilterButtons(){ document.querySelectorAll('.alert-filter-btn').forEach(b=>{ b.classList.toggle('act', b.dataset.filter===currentFilter()); }); }

	// æ ¹æ®å­¦ç”Ÿå§“åæŸ¥æ‰¾å½“å‰æ‰€åœ¨ç´æˆ¿ï¼ˆæ”¯æŒå¤šäººç™»è®°ã€å„ç§åˆ†éš”ç¬¦ä¸æ‹¬å·é™„æ³¨ï¼‰
	function getCurrentRoomNameForStudent(studentName){
		try{
			if(!window.Store || !Array.isArray(window.Store.rooms)) {
				console.log('[getCurrentRoomNameForStudent] Store.rooms ä¸å¯ç”¨');
				return null;
			}
			console.log('[getCurrentRoomNameForStudent] æŸ¥æ‰¾å­¦ç”Ÿ:', studentName, 'æˆ¿é—´æ€»æ•°:', window.Store.rooms.length);
			
			const normalizeName = (s)=>{
				return (s||'')
					.replace(/\s+/g,'')
					.replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g,'')
					.replace(/\([^)]*\)/g,'')
					.replace(/\[[^\]]*\]/g,'')
					.replace(/ã€[^ã€‘]*ã€‘/g,'')
					.trim();
			};
			const target = normalizeName(studentName||'');
			console.log('[getCurrentRoomNameForStudent] æ ‡å‡†åŒ–åçš„å­¦ç”Ÿå:', target);
			
			// é¦–é€‰ï¼šæŒ‰åˆ†éš”ç¬¦æ‹†åˆ†åç²¾ç¡®åŒ¹é…
			let room = window.Store.rooms.find(r=>{
				if(!r || !r.occupant_student_name) return false;
				const occStr = String(r.occupant_student_name);
				const occupants = occStr.split(/[,ï¼Œã€;ï¼›|ï½œ\/\s]+/).map(n=>normalizeName(n)).filter(Boolean);
				console.log('[getCurrentRoomNameForStudent] æˆ¿é—´', r.name, 'å ç”¨è€…åˆ—è¡¨:', occupants, 'æ˜¯å¦åŒ…å«:', occupants.includes(target));
				return occupants.includes(target);
			});
			if(room) {
				console.log('[getCurrentRoomNameForStudent] æ‰¾åˆ°æˆ¿é—´ (ç²¾ç¡®åŒ¹é…):', room.name);
				return room.name;
			}
			
			// å…œåº•ï¼šä¸è§„åˆ™åˆ†éš”åœºæ™¯ï¼Œä½¿ç”¨å­—ç¬¦ä¸²åŒ…å«åŒ¹é…
			room = window.Store.rooms.find(r=>{
				if(!r || !r.occupant_student_name) return false;
				const occNorm = normalizeName(String(r.occupant_student_name));
				const match = occNorm.includes(target);
				console.log('[getCurrentRoomNameForStudent] æˆ¿é—´', r.name, 'åŒ…å«åŒ¹é…:', occNorm, 'includes', target, '=', match);
				return match;
			});
			
			if(room) {
				console.log('[getCurrentRoomNameForStudent] æ‰¾åˆ°æˆ¿é—´ (åŒ…å«åŒ¹é…):', room.name);
			} else {
				console.log('[getCurrentRoomNameForStudent] æœªæ‰¾åˆ°æˆ¿é—´ï¼Œå­¦ç”Ÿ:', studentName);
			}
			return room ? room.name : null;
		}catch(e){ 
			console.error('[getCurrentRoomNameForStudent] å¼‚å¸¸:', e);
			return null; 
		}
	}
	function renderAlerts(){ 
		console.log('[PracticeAlerts] renderAlerts å¼€å§‹ï¼ŒAlertStore.list:', AlertStore.list.length);
		const box=document.getElementById('alertList'); 
		if(!box) {
			console.error('[PracticeAlerts] alertList å…ƒç´ ä¸å­˜åœ¨ï¼');
			return;
		}
		// æ’åºï¼šæœ€è¿‘æ—¶é—´æ®µ -> æœ€è¿œã€‚ä¼˜å…ˆä½¿ç”¨ slot ç»“æŸæ—¶é—´ï¼ˆè‹¥æ— ç»“æŸç”¨å¼€å§‹ï¼‰ï¼Œç¼ºå°‘ slot ç”¨ created_atã€‚
		const sorted=[...AlertStore.list].sort((a,b)=>{
			function slotKey(x){
				if(x.slot){
					// ç»“æŸæ—¶é—´ä¼˜å…ˆï¼Œè½¬æ¢ä¸ºä»Šå¤©åˆ†é’Ÿæ•°ï¼›è‹¥åªæœ‰ start_time ä¹Ÿç”¨ start
					const et=x.slot.end_time||x.slot.start_time; 
					return timeStrToMinutes(et);
				}
				// æ²¡æœ‰ slotï¼šè‹¥æœ‰ created_at ç”¨å…¶æ—¶é—´æˆ³ï¼›å¦åˆ™ç½®æå°
				return (x.created_at? new Date(x.created_at).getTime()/60000 : -1);
			}
			const ka=slotKey(a); const kb=slotKey(b);
			// æ›´å¤§çš„(æ›´æ™šçš„)æ’åœ¨å‰é¢ => é™åº
			if(kb!==ka) return kb-ka;
			// æ¬¡çº§ï¼šåŒä¸€æ—¶é—´æ®µæŒ‰ id é™åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
			return (b.id||0)-(a.id||0);
		});
		const filtered=applyFilter(sorted); 
		console.log('[PracticeAlerts] è¿‡æ»¤åæé†’æ•°é‡:', filtered.length);
		if(!filtered.length){ 
			box.classList.add('alert-empty'); 
			box.innerHTML='æš‚æ— æé†’'; 
			console.log('[PracticeAlerts] æ˜¾ç¤ºï¼šæš‚æ— æé†’');
		} else { 
			box.classList.remove('alert-empty'); 
			box.innerHTML=filtered.map(a=>alertHtml(a)).join(''); 
			box.querySelectorAll('[data-act="ignore"]').forEach(btn=>{ btn.onclick=()=>ignoreAlert(btn.dataset.id); }); 
			console.log('[PracticeAlerts] æ¸²æŸ“äº†', filtered.length, 'æ¡æé†’');
		} 
		updateFilterButtons(); 
	}
		function alertHtml(a){ 
			const tags=[`<span class="alert-tag type-${a.type}">${a.type==='absent'?'ç¼ºå‹¤':'å¼‚å¸¸'}</span>`]; 
			
			// å¼‚å¸¸ç±»å‹ï¼šæ˜¾ç¤ºå½“å‰æ‰€åœ¨ç´æˆ¿ï¼ˆä¼˜å…ˆä½¿ç”¨åˆ›å»ºæ—¶æŸ¥è¯¢åˆ°çš„æˆ¿é—´åç§°ï¼‰
			let currentRoom = null;
			if(a.type==='anomaly'){
				// ä¼˜å…ˆä½¿ç”¨åˆ›å»ºæé†’æ—¶ä»æ•°æ®åº“æŸ¥è¯¢åˆ°çš„æˆ¿é—´åç§°
				if(a._roomName) {
					currentRoom = a._roomName;
					console.log('[alertHtml] ä½¿ç”¨å­˜å‚¨çš„æˆ¿é—´åç§°:', currentRoom);
				}
				if(currentRoom){
					tags.push(`<span class="alert-tag alert-room">${currentRoom}</span>`);
				}
			}
			
			if(a.slot){ 
				// æ—¶é—´æ ¼å¼éªŒè¯å’Œä¿®å¤
				let startTime = a.slot.start_time || '';
				let endTime = a.slot.end_time || '';
				
				// å¦‚æœæ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¦‚ "1" è€Œä¸æ˜¯ "11:07"ï¼‰ï¼Œå°è¯•ä¿®å¤
				if(!/^\d{2}:\d{2}$/.test(startTime) && /^\d{1,2}$/.test(startTime)) {
					startTime = startTime.padStart(2, '0') + ':00';
				}
				if(!/^\d{2}:\d{2}$/.test(endTime) && /^\d{1,2}$/.test(endTime)) {
					endTime = endTime.padStart(2, '0') + ':00';
				}
				
				// å¼‚å¸¸æé†’ï¼šåªæ˜¾ç¤ºå¼€å§‹æ—¶é—´ï¼›ç¼ºå‹¤æé†’ï¼šæ˜¾ç¤ºå®Œæ•´æ—¶é—´æ®µ
				let timeDisplay = '';
				if(a.type === 'anomaly') {
					// å¼‚å¸¸åªæ˜¾ç¤ºå¼€å§‹æ—¶é—´
					timeDisplay = startTime || 'æ—¶é—´å¼‚å¸¸';
				} else {
					// ç¼ºå‹¤æ˜¾ç¤ºå®Œæ•´æ—¶é—´æ®µ
					timeDisplay = (startTime && endTime) ? `${startTime}-${endTime}` : 
						(startTime || endTime || 'æ—¶é—´å¼‚å¸¸');
				}
				
				tags.push(`<span class="alert-tag slot-time">${timeDisplay}</span>`); 
			}
			
			// ç´§å‡‘å¸ƒå±€ï¼šå­¦ç”Ÿåã€æ ‡ç­¾ã€æ—¶é—´åœ¨ä¸€è¡Œï¼Œå»æ‰æè¿°æ–‡å­—
			return `<div class="alert-item ${a.type}${a.ignored?' ignored':''}" data-id="${a.id}" data-severity="${a.severity||0}">
			<div class="alert-content">
				<div class="alert-student">${a.student_name||''}</div>
				<div class="alert-info">
					${tags.join('')}
					<span class="alert-time">${fmt(a.created_at||a.createdAt||Date.now())}</span>
				</div>
			</div>
			<div class="alert-actions">
				<button class="alert-btn ignore" data-act="ignore" data-id="${a.id}">${a.ignored?'å·²å¿½ç•¥':'å¿½ç•¥'}</button>
				${a.ignored?'<span class="alert-ignored-flag">å·²å¿½ç•¥</span>':''}
			</div>
		</div>`; 
		}
		async function ignoreAlert(id){ const a=AlertStore.byId.get(id); if(!a) return; if(a.ignored) return; a.ignored=true; // æœ¬åœ°å…ˆç½®ä½
			removeAlertLocal(id); renderAlerts();
			// å¿½ç•¥åï¼šè®¾ç½®å½“å¤©é™é»˜ï¼Œç›´åˆ°è¯¥ç”Ÿé‡æ–°ç™»è®°
			try{ setSilenced(a.student_name, a.type, a.slot||{start_time:a.slot_start,end_time:a.slot_end}); }catch(_e){}
			// ç§»é™¤å»é‡ key (å…è®¸å¿½ç•¥åå†äº§ç”Ÿæ–°æé†’)
			try{ if(a.slot){ const k=`${a.student_name}|${a.type}|${a.slot.start_time}-${a.slot.end_time}|${(new Date()).toISOString().slice(0,10)}`; AlertStore.dedupe.delete(k); } }catch(_e){}
			// æœ¬åœ°å¹¿æ’­ï¼ˆåŒæµè§ˆå™¨å…¶å®ƒæ ‡ç­¾é¡µï¼‰
			try{ localStorage.setItem('practice_alerts_ignore_ping', JSON.stringify({id, t:Date.now()})); }catch(_e){}
			if(!window.supabaseClient) return; 
			try{ 
				console.log('[PracticeAlerts] æ ‡è®° ignored=true id=', id);
				const {data, error}=await supabaseClient.from('practice_alerts').update({ignored:true}).eq('id', id).select('id');
				if(error){ console.warn('ignore(update) fail', error); // å›æ»šæ¢å¤
					AlertStore.byId.set(String(id),a); AlertStore.list.unshift(a); renderAlerts(); 
				}else{
					console.log('[PracticeAlerts] æ ‡è®°æˆåŠŸ rows=', data?.length||0);
					// æˆåŠŸåé€šè¿‡ realtime UPDATE å…¶ä»–ç«¯ä¼šè‡ªåŠ¨ç§»é™¤ï¼›åŒæ—¶å¹¿æ’­å…œåº•
					try{ if(AlertStore._rtChannel){ AlertStore._rtChannel.send({type:'broadcast', event:'ignore', payload:{id}}); console.log('[PracticeAlerts][BC][ignore-update] å·²å‘é€å¹¿æ’­ id=', id); } }catch(e){ console.warn('[PracticeAlerts][BC] send update å¹¿æ’­å¤±è´¥', e); }
				}
			}catch(e){ console.error(e); AlertStore.byId.set(String(id),a); AlertStore.list.unshift(a); renderAlerts(); }
	}

		// ä¸€é”®å¿½ç•¥å½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„æ‰€æœ‰æé†’
		let _bulkIgnoreLock = false;
		async function ignoreAllAlerts() {
			if(_bulkIgnoreLock){ console.log('[PracticeAlerts] ignoreAll å·²åœ¨æ‰§è¡Œ'); return; }
			const sorted=[...AlertStore.list].sort((a,b)=>{
				function slotKey(x){
					if(x.slot){
						const et=x.slot.end_time||x.slot.start_time; 
						return timeStrToMinutes(et);
					}
					return (x.created_at? new Date(x.created_at).getTime()/60000 : -1);
				}
				const ka=slotKey(a); const kb=slotKey(b);
				if(kb!==ka) return kb-ka;
				return (b.id||0)-(a.id||0);
			});
			const candidates = applyFilter(sorted).filter(a=>!a.ignored);
			if(!candidates.length){ console.log('[PracticeAlerts] ä¸€é”®å¿½ç•¥ï¼šæ— å¯å¿½ç•¥æ¡ç›®'); toast?.('æ²¡æœ‰å¯å¿½ç•¥çš„æé†’'); return; }
			console.log('[PracticeAlerts] ä¸€é”®å¿½ç•¥ å¼€å§‹ æ•°é‡=', candidates.length);
			_bulkIgnoreLock = true;
			const todayStr=(new Date()).toISOString().slice(0,10);
			// æœ¬åœ°æ‰¹é‡å¤„ç†ï¼ˆä¸€æ¬¡æ¸²æŸ“ï¼‰
			for(const a of candidates){
				try{ a.ignored = true; removeAlertLocal(a.id); }catch(_e){}
				try{ setSilenced(a.student_name, a.type, a.slot||{start_time:a.slot_start,end_time:a.slot_end}); }catch(_e){}
				try{ if(a.slot){ const k=`${a.student_name}|${a.type}|${a.slot.start_time}-${a.slot.end_time}|${todayStr}`; AlertStore.dedupe.delete(k);} }catch(_e){}
			}
			try{ persistSilenced(); }catch(_e){}
			try{ localStorage.setItem('practice_alerts_ignore_ping', JSON.stringify({bulk: true, ids: candidates.map(c=>c.id), t:Date.now()})); }catch(_e){}
			renderAlerts();
			// è¿œç«¯æ‰¹é‡æ›´æ–°
			if(window.supabaseClient){
				try{
					const ids = candidates.map(c=>c.id);
					const {error} = await supabaseClient.from('practice_alerts').update({ignored:true}).in('id', ids);
					if(error){ console.warn('[PracticeAlerts] æ‰¹é‡å¿½ç•¥è¿œç«¯å¤±è´¥ï¼Œå›æ»š', error); // å›æ»š
						for(const a of candidates){ a.ignored=false; AlertStore.byId.set(String(a.id), a); AlertStore.list.push(a); }
						renderAlerts();
						toast?.('ä¸€é”®å¿½ç•¥å¤±è´¥');
					}else{
						// å¹¿æ’­æ¯æ¡ï¼Œå…¼å®¹ç°æœ‰ ignore ç›‘å¬
						try{ if(AlertStore._rtChannel){ for(const id of ids){ AlertStore._rtChannel.send({type:'broadcast', event:'ignore', payload:{id}}); } } }catch(e){ console.warn('[PracticeAlerts][BC][bulk-ignore] å¹¿æ’­å¤±è´¥', e); }
						console.log('[PracticeAlerts] ä¸€é”®å¿½ç•¥ æˆåŠŸ ids=', ids.length);
						toast?.(`å·²å¿½ç•¥ ${ids.length} æ¡æé†’`);
					}
				}catch(e){ console.error('[PracticeAlerts] æ‰¹é‡å¿½ç•¥å¼‚å¸¸', e); toast?.('æ‰¹é‡å¿½ç•¥å¼‚å¸¸'); }
			}
			_bulkIgnoreLock = false;
		}
		// ===== å¯¹è´¦ï¼šåŸºäºå­˜åœ¨æ€§ï¼ˆè®°å½•å·² delete å³æœ¬åœ°ç§»é™¤ï¼‰======
		async function reconcileIgnored(){
			if(!window.supabaseClient) return; 
			if(!AlertStore.list.length) return; 
			try{
				const ids=AlertStore.list.map(a=>a.id);
				const {data,error}=await supabaseClient.from('practice_alerts').select('id').in('id', ids);
				if(error){ console.warn('[PracticeAlerts] reconcile query error', error); return; }
				const existSet=new Set((data||[]).map(r=>String(r.id)));
				const before=AlertStore.list.length;
				AlertStore.list=AlertStore.list.filter(a=> existSet.has(String(a.id)) );
				let removed=0; AlertStore.byId.forEach((_,k)=>{ if(!existSet.has(k)){ AlertStore.byId.delete(k); removed++; }});
				if(removed>0 || before!==AlertStore.list.length){ console.log('[PracticeAlerts] reconcileIgnored ä¿®æ­£æœ¬åœ°ç¼ºå¤±', removed, 'æ¡'); renderAlerts(); }
			}catch(e){ console.error('[PracticeAlerts] reconcileIgnored å¼‚å¸¸', e); }
		}
		let _reconcileTimer=null; function scheduleReconcile(delay=0){ if(_reconcileTimer) clearTimeout(_reconcileTimer); _reconcileTimer=setTimeout(()=>{ reconcileIgnored(); }, delay); }
		// â€”â€” é™é»˜æ§åˆ¶ï¼šå¿½ç•¥åé™é»˜åˆ°â€œè¯¥ç”Ÿé‡æ–°ç™»è®°â€ä¸ºæ­¢ â€”â€”
		function todayKey(){ return (new Date()).toISOString().slice(0,10); }
		function silenceKey(stu,type,slot){ const d=todayKey(); const sp=slot?`${slot.start_time}-${slot.end_time}`:'none'; return `${d}|${stu}|${type}|${sp}`; }
		function setSilenced(stu,type,slot){ const k=silenceKey(stu,type,slot); AlertStore.silenced.set(k,true); try{ localStorage.setItem('practice_alerts_silence_ping', JSON.stringify({k,t:Date.now()})); }catch(_){} }
		// ---- é™é»˜æŒä¹…åŒ–æ”¯æŒ (A) ----
		function persistSilenced(){
			try{ const d=todayKey(); const list=Array.from(AlertStore.silenced.keys()).filter(k=>k.startsWith(d+'|')); localStorage.setItem('practice_alerts_silence_cache_'+d, JSON.stringify({d,list,ts:Date.now()})); }catch(e){ console.warn('[PracticeAlerts] persistSilenced fail', e); }
		}
		function restoreSilenced(){
			try{ 
				const d=todayKey(); 
				const raw=localStorage.getItem('practice_alerts_silence_cache_'+d); 
				if(!raw) return; 
				const obj=JSON.parse(raw); 
				if(!obj||obj.d!==d||!Array.isArray(obj.list)) return; 
				
				// æ£€æŸ¥ç¼“å­˜æ—¶æ•ˆæ€§ï¼šè¶…è¿‡6å°æ—¶çš„ç¼“å­˜ä¸æ¢å¤
				const cacheAge = Date.now() - (obj.ts || 0);
				if(cacheAge > 6 * 60 * 60 * 1000) {
					console.warn('[PracticeAlerts] æœ¬åœ°é™é»˜ç¼“å­˜è¿‡æœŸï¼Œè·³è¿‡æ¢å¤ (ç¼“å­˜æ—¶é—´:', Math.round(cacheAge/3600000), 'å°æ—¶å‰)');
					localStorage.removeItem('practice_alerts_silence_cache_'+d);
					return;
				}
				
				for(const k of obj.list){ AlertStore.silenced.set(k,true); } 
				console.log('[PracticeAlerts] æ¢å¤æœ¬åœ°é™é»˜æ¡ç›®æ•°', obj.list.length, '(ç¼“å­˜æ—¶é—´:', Math.round(cacheAge/60000), 'åˆ†é’Ÿå‰)'); 
			}catch(e){ console.warn('[PracticeAlerts] restoreSilenced fail', e); }
		}
		// åŒ…è£… setSilenced ä»¥è‡ªåŠ¨æŒä¹…åŒ–
		const __origSetSilenced = setSilenced; setSilenced = function(stu,type,slot){ __origSetSilenced(stu,type,slot); persistSilenced(); };
		function clearSilenced(stu,type,slot){ const k=silenceKey(stu,type,slot); AlertStore.silenced.delete(k); try{ localStorage.setItem('practice_alerts_silence_clear', JSON.stringify({k,t:Date.now()})); }catch(_){} }
		function clearSilencedForStudent(stu){ const d=todayKey(); const prefix=`${d}|${stu}|`; for(const k of Array.from(AlertStore.silenced.keys())){ if(k.startsWith(prefix)) AlertStore.silenced.delete(k); } }
		function isSilenced(stu,type,slot){ const k=silenceKey(stu,type,slot); return AlertStore.silenced.has(k); }
		// æœ¬åœ°å­˜å‚¨å¹¿æ’­ç›‘å¬ï¼ˆåŒæºå¤šæ ‡ç­¾é¡µï¼‰
		window.addEventListener('storage', e=>{ 
			if(e.key==='practice_alerts_ignore_ping'){ scheduleReconcile(500); }
			if(e.key==='practice_alerts_silence_ping'){
				try{ const p=JSON.parse(e.newValue||'null'); if(p&&p.k){ AlertStore.silenced.set(p.k,true); } }catch(_){ }
			}
			if(e.key==='practice_alerts_silence_clear'){
				try{ const p=JSON.parse(e.newValue||'null'); if(p&&p.k){ AlertStore.silenced.delete(p.k); } }catch(_){ }
			}
		});
	async function fetchExistingAlerts(){ 
		console.log('[PracticeAlerts] fetchExistingAlerts å¼€å§‹');
		if(!window.supabaseClient) {
			console.warn('[PracticeAlerts] supabaseClient ä¸å­˜åœ¨');
			return;
		}
		try{ 
				const since=new Date(); since.setHours(0,0,0,0); 
				console.log('[PracticeAlerts] æŸ¥è¯¢ä»Šæ—¥æé†’ï¼Œsince:', since.toISOString());
				// æ‹‰å–å½“å¤©å…¨éƒ¨æé†’ (A+B: åŒ…å« ignored, ç”¨äºé‡å»ºé™é»˜)
				const {data,error}=await supabaseClient.from('practice_alerts')
					.select('*')
					.gte('created_at', since.toISOString())
					.order('created_at',{ascending:false})
					.limit(400); 
			if(error){ 
				console.warn('[PracticeAlerts] fetch alerts error', error); 
				if(error.code === '42P01') {
					console.error('[PracticeAlerts] practice_alerts è¡¨ä¸å­˜åœ¨ï¼');
				}
				return;
			} 
			console.log('[PracticeAlerts] è·å–åˆ°æé†’æ•°æ®:', data?.length || 0, 'æ¡');
			function fmtHHMM(v){
				if(v==null) return '';
				if(typeof v==='number'){
					// å…¼å®¹æ—§æ•°æ®ï¼šæ—¢æ”¯æŒå°æ—¶(0-23)ï¼Œä¹Ÿæ”¯æŒåˆ†é’Ÿ(0-1440)
					if(v>=0 && v<24){ const hh=String(v).padStart(2,'0'); return `${hh}:00`; }
					if(v>=0 && v<=1440){ const h=Math.floor(v/60), m=v%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
					return String(v);
				}
				if(typeof v==='string'){
					// è§„èŒƒåˆ° HH:MM
					const m=v.match(/^(\d{1,2})(?::(\d{1,2}))?$/);
					if(m){ const hh=String(m[1]).padStart(2,'0'); const mm=String(m[2]??'0').padStart(2,'0'); return `${hh}:${mm}`; }
					const m2=v.match(/^(\d{2}):(\d{2})$/); if(m2) return v;
					return v;
				}
				return String(v);
			}
			// åˆå§‹åŒ–/åŠ è½½ç³»ç»Ÿè‡ªåŠ¨å¿½ç•¥è®°å½•(ä»…å½“å¤©ç”Ÿæ•ˆ)
			AlertStore.systemIgnored = AlertStore.systemIgnored || new Set();
			(function loadSystemIgnored(){
				try{
					const k = 'practice_alerts_system_ignored_' + todayKey();
					const raw = localStorage.getItem(k);
					if(raw){ const arr = JSON.parse(raw); if(Array.isArray(arr)){ AlertStore.systemIgnored = new Set(arr.map(x=>String(x))); } }
				}catch(e){ console.warn('[PracticeAlerts] åŠ è½½ systemIgnored å¤±è´¥', e); }
			})();

			// è¿‡æ»¤æœªå¿½ç•¥ï¼Œå¹¶è§„èŒƒ slot - ä¿ç•™å·²æœ‰è®°å½•çš„ä¸´æ—¶å­—æ®µï¼ˆå¦‚ _roomNameï¼‰
			const freshList = (data||[]).filter(a=>!a.ignored).map(a => {
				const s = fmtHHMM(a.slot_start);
				const e = fmtHHMM(a.slot_end);
				a.slot = (s && e) ? { start_time:s, end_time:e } : null;
				
				// å…³é”®ï¼šå¦‚æœæœ¬åœ°å·²æœ‰è¯¥è®°å½•ï¼Œä¿ç•™å…¶ä¸´æ—¶å­—æ®µ
				const existing = AlertStore.byId.get(String(a.id));
				if(existing) {
					// ä¿ç•™ä¸´æ—¶å­—æ®µï¼ˆä»¥ _ å¼€å¤´ï¼‰
					Object.keys(existing).forEach(key => {
						if(key.startsWith('_') && existing[key] != null) {
							a[key] = existing[key];
						}
					});
				}
				return a;
			}); 
			AlertStore.list = freshList;
			
			// æœ¬åœ°å»é‡ï¼šå¼‚å¸¸åŒä¸€å­¦ç”ŸåŒä¸€å¤©åªä¿ç•™æœ€æ–°ä¸€æ¡
			(function dedupeAnomalyLocal(){
				const latestByStu=new Map();
				for(const a of AlertStore.list){
					if(a.type!=='anomaly') continue;
					const key=a.student_name;
					const prev=latestByStu.get(key);
					const curTs=a.created_at? new Date(a.created_at).getTime(): (a.id||0);
					const prevTs=prev? (prev.created_at? new Date(prev.created_at).getTime(): (prev.id||0)) : -1;
					if(!prev || curTs>prevTs){ latestByStu.set(key,a); }
				}
				if(latestByStu.size){
					const keepSet=new Set(Array.from(latestByStu.values()).map(x=>String(x.id)));
					const before=AlertStore.list.length;
					AlertStore.list = AlertStore.list.filter(a=> a.type!=='anomaly' || keepSet.has(String(a.id)) );
					if(before!==AlertStore.list.length){ console.log('[PracticeAlerts] æœ¬åœ°å»é‡(å¼‚å¸¸) ç§»é™¤', before-AlertStore.list.length, 'æ¡é‡å¤'); }
				}
			})();
			AlertStore.byId.clear(); 
			AlertStore.list.forEach(a=>AlertStore.byId.set(String(a.id),a)); 

			// === å¯¹è´¦ï¼šè®¡ç®—â€œå½“å‰åº”å±•ç¤ºâ€çš„æé†’é›†åˆï¼Œå¹¶å°†å…¶ä½™æœªå¿½ç•¥çš„æé†’è‡ªåŠ¨å¿½ç•¥ï¼ˆä¸å½“ä½œç”¨æˆ·é™é»˜ï¼‰ ===
			try{
				await ensureSlotsLoaded();
				const toMin = (t)=>{ const [h,m]=String(t||'0:0').split(':').map(Number); return h*60+(m||0); };
				const nowM = minutesNow();
				const ABS_W = THRESHOLDS?.ABSENT_WINDOW_START ?? 5;
				// äº‘ç«¯å·²å¿½ç•¥é”®é›†åˆï¼ˆç”¨äºä¿æŒç”¨æˆ·å¿½ç•¥ä¼˜å…ˆçº§ï¼‰
				const ignoredKeys = new Set();
				for(const ig of (data||[])){
					if(!ig.ignored) continue;
					const key = ig.type==='anomaly'
						? `${ig.student_name}|anomaly|today`
						: `${ig.student_name}|absent|${fmtHHMM(ig.slot_start)}-${fmtHHMM(ig.slot_end)}`;
					ignoredKeys.add(key);
				}
				// è®¡ç®—å€™é€‰åº”å±•ç¤ºé”®
				const shouldDisplay = new Set();
				const students = Object.keys(AlertStore.slotsToday||{});
				for(const stu of students){
					const slots = AlertStore.slotsToday[stu]||[];
					// ç¼ºå‹¤ï¼šå½“å‰è½åœ¨æ—¶æ®µå†…ï¼ˆå¼€å§‹5åˆ†é’Ÿåï¼‰ï¼Œä¸”æ— é‡å 
					for(const slot of slots){
						const st=toMin(slot.start_time), et=toMin(slot.end_time);
						if(nowM>=st+ABS_W && nowM<=et){
							if(!hasPracticeOverlap(stu, slot)){
								const k = `${stu}|absent|${slot.start_time}-${slot.end_time}`;
								if(!ignoredKeys.has(k)) shouldDisplay.add(k);
							}
						}
					}
					// å¼‚å¸¸ï¼šå½“å‰åœ¨ç»ƒç´ï¼Œä¸”ä¸åœ¨ä»»ä¸€æ—¶æ®µï¼Œä¸”ç¦»å¼€ç´¯è®¡â‰¥é˜ˆå€¼
					const active = getActivePractice(stu);
					if(active && anomalyShouldTrigger(stu, active)){
						const k = `${stu}|anomaly|today`;
						if(!ignoredKeys.has(k)) shouldDisplay.add(k);
					}
				}
				// æ‰¾å‡ºæœªè¢«å¿½ç•¥ä½†åˆä¸åº”å±•ç¤ºçš„è®°å½• -> è‡ªåŠ¨ç½® ignored=trueï¼ˆç³»ç»Ÿå¿½ç•¥ï¼‰
				const toIgnoreIds = [];
				for(const rec of (data||[])){
					if(rec.ignored) continue;
					const key = rec.type==='anomaly'
						? `${rec.student_name}|anomaly|today`
						: `${rec.student_name}|absent|${fmtHHMM(rec.slot_start)}-${fmtHHMM(rec.slot_end)}`;
					if(shouldDisplay.has(key)) continue; // éœ€è¦å±•ç¤ºï¼Œä¿ç•™æœªå¿½ç•¥
					// é¢å¤–å®‰å…¨ï¼šåˆ¤å®šä¸ºâ€œå·²è¿‡æœŸ/ä¸åº”å­˜åœ¨â€å†å¿½ç•¥ï¼ˆé¿å…æŠ–åŠ¨ï¼‰
					let stale=false;
					if(rec.type==='absent'){
						const st=toMin(rec.slot_start), et=toMin(rec.slot_end);
						const inWindow = nowM>=st+ABS_W && nowM<=et;
						if(!inWindow) stale=true; // ä¸åœ¨æ£€æµ‹çª—å£
						else if(hasPracticeOverlap(rec.student_name, {start_time:fmtHHMM(rec.slot_start), end_time:fmtHHMM(rec.slot_end)})) stale=true; // å·²æœ‰é‡å 
					}
					else if(rec.type==='anomaly'){
						const slots = AlertStore.slotsToday?.[rec.student_name]||[];
						const active = getActivePractice(rec.student_name);
						const inAnySlotNow = slots.some(s=>{ const a=toMin(s.start_time), b=toMin(s.end_time); return nowM>=a && nowM<=b; });
						if(!active || inAnySlotNow || !anomalyShouldTrigger(rec.student_name, active)) stale=true;
					}
					// æ—¶é—´ä¿æŠ¤ï¼šåˆ›å»ºè¶…è¿‡2åˆ†é’Ÿå†å¤„ç†ï¼Œé¿å…ç«æ€
					const ageOk = (()=>{ try{ const t=new Date(rec.created_at).getTime(); return (Date.now()-t)>120000; }catch(_){ return true; }})();
					if(stale && ageOk){ toIgnoreIds.push(rec.id); }
				}
				if(toIgnoreIds.length){
					console.log('[PracticeAlerts] å¯¹è´¦: è‡ªåŠ¨å¿½ç•¥ stale æé†’æ•°é‡=', toIgnoreIds.length);
					try{
						await supabaseClient.from('practice_alerts').update({ignored:true}).in('id', toIgnoreIds);
						// æœ¬åœ°è®°å½• systemIgnoredï¼Œä¸”ä¸è§¦å‘é™é»˜
						for(const id of toIgnoreIds){ AlertStore.systemIgnored.add(String(id)); }
						try{ localStorage.setItem('practice_alerts_system_ignored_'+todayKey(), JSON.stringify(Array.from(AlertStore.systemIgnored))); }catch(_e){}
					}catch(e){ console.warn('[PracticeAlerts] è‡ªåŠ¨å¿½ç•¥å¤±è´¥', e); }
				}
			}catch(e){ console.warn('[PracticeAlerts] å¯¹è´¦ä¸è‡ªåŠ¨å¿½ç•¥æ­¥éª¤å¤±è´¥ï¼Œè·³è¿‡', e); }
			// å…³é”®ï¼šå…ˆæ¸…ç©ºæœ¬åœ°é™é»˜çŠ¶æ€ï¼Œä»¥äº‘ç«¯æ•°æ®ä¸ºå‡†
			const d = todayKey();
			const localKeys = Array.from(AlertStore.silenced.keys()).filter(k => k.startsWith(d + '|'));
			console.log('[PracticeAlerts] æ¸…ç©ºæœ¬åœ°é™é»˜çŠ¶æ€', localKeys.length, 'æ¡ï¼Œä»¥äº‘ç«¯æ•°æ®ä¸ºå‡†');
			localKeys.forEach(k => AlertStore.silenced.delete(k));
			
			// å°† ignored è®°å½•é™é»˜åŒ– (B) - ä»¥äº‘ç«¯æ•°æ®é‡å»ºé™é»˜çŠ¶æ€ï¼ˆè·³è¿‡ç³»ç»Ÿè‡ªåŠ¨å¿½ç•¥çš„è®°å½•ï¼‰
			try{ 
				const ignoredList=(data||[]).filter(a=>a.ignored); 
				for(const ig of ignoredList){ 
					if(AlertStore.systemIgnored && AlertStore.systemIgnored.has(String(ig.id))){
						continue; // ç³»ç»Ÿè‡ªåŠ¨å¿½ç•¥ï¼šä¸è®¾ç½®é™é»˜
					}
					if(ig.slot_start&&ig.slot_end){ 
						setSilenced(ig.student_name, ig.type, {start_time:ig.slot_start,end_time:ig.slot_end}); 
					} else { 
						setSilenced(ig.student_name, ig.type, null); 
					} 
				} 
				if(ignoredList.length) console.log('[PracticeAlerts] å·²ä»æœåŠ¡ç«¯ ignored é‡å»ºé™é»˜çŠ¶æ€', ignoredList.length); 
			}catch(e){ console.warn('[PracticeAlerts] ignored->silenced é‡å»ºå¤±è´¥', e); }
			
			console.log('[PracticeAlerts] AlertStore.list é•¿åº¦:', AlertStore.list.length);
			AlertStore._lastFullReload = Date.now();
			persistSilenced(); // ä¿å­˜ä»¥äº‘ç«¯æ•°æ®ä¸ºå‡†çš„é™é»˜çŠ¶æ€
			// å¯é€‰ï¼šå¼‚æ­¥æ¸…ç†æœåŠ¡ç«¯é‡å¤ï¼ˆåŒå­¦ç”Ÿå½“å¤©ä¿ç•™æœ€æ–°ï¼‰
			setTimeout(async()=>{
				try{
					const list=AlertStore.list.filter(x=>x.type==='anomaly');
					const byStu=new Map();
					for(const a of list){ const arr=(byStu.get(a.student_name)||[]); arr.push(a); byStu.set(a.student_name, arr); }
					const toDelete=[];
					for(const [stu,arr] of byStu){ if(arr.length<=1) continue; arr.sort((a,b)=> new Date(b.created_at).getTime() - new Date(a.created_at).getTime()); const del=arr.slice(1).map(x=>x.id); toDelete.push(...del); }
					if(toDelete.length && window.supabaseClient){
						console.log('[PracticeAlerts] æ¸…ç†æœåŠ¡ç«¯é‡å¤(å¼‚å¸¸) æ•°é‡=', toDelete.length);
						await supabaseClient.from('practice_alerts').delete().in('id', toDelete);
					}
				}catch(e){ console.warn('[PracticeAlerts] æ¸…ç†æœåŠ¡ç«¯é‡å¤å¤±è´¥', e); }
			}, 10);
			renderAlerts(); 
		}catch(e){ 
			console.error('[PracticeAlerts] fetchExistingAlerts å¼‚å¸¸:', e); 
		}
	}
		function getActivePractice(student){ // approximate current ongoing log
				// ä¼˜å…ˆä½¿ç”¨ practiceLogsï¼ˆå¦‚æœæœ‰åå°å†™å…¥ï¼‰
				if(window.practiceLogs){
					const nowTs=Date.now();
					const found=(practiceLogs[student]||[]).find(l=>!l.end_time && nowTs - (new Date(l.start_time).getTime()) < 6*60*60*1000);
					if(found) return found;
				}
				// å›é€€ï¼šæ ¹æ®å½“å‰æˆ¿é—´å ç”¨æ¨æ–­ï¼ˆæ— æ—¥å¿—æƒ…å†µä¸‹ï¼‰
				// æ”¯æŒå¤šäººç™»è®°ï¼šæ£€æŸ¥occupant_student_nameä¸­æ˜¯å¦åŒ…å«è¯¥å­¦ç”Ÿï¼ˆé€—å·åˆ†éš”ï¼‰
				for(const r of Store.rooms){ 
					if(r.occupant_student_name && r.registerTime){
						// å°†å­¦ç”Ÿåå­—æŒ‰é€—å·åˆ†éš”ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡å­¦ç”Ÿ
						const students = r.occupant_student_name.split(',').map(s => s.trim());
						if(students.includes(student)){
							return { start_time:new Date(r.registerTime).toISOString(), room:r.name, pseudo:true };
						}
					}
				}
				return null;
			}
		function anyPracticeLogs(student){ if(!window.practiceLogs) return []; return practiceLogs[student]||[]; }
		function timeStrToMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
		function minutesNow(){ const d=new Date(); return d.getHours()*60 + d.getMinutes(); }
		// åˆ¤æ–­æ˜¯å¦æœ‰ä»»æ„ç»ƒç´æ—¥å¿—ä¸ slot æ—¶é—´æ®µé‡å ï¼ˆå¼€å§‹æ—©äº slot ç»“æŸï¼Œç»“æŸæ™šäº slot å¼€å§‹ï¼‰
		function hasPracticeOverlap(student, slot){
			const slotStart=toMinutes(slot.start_time); const slotEnd=toMinutes(slot.end_time);
			// 1) å…ˆçœ‹å·²çŸ¥ç»ƒç´æ—¥å¿—
			const logs=anyPracticeLogs(student) || []; 
			const logOverlap = logs.some(l=>{
				const startMs=new Date(l.start_time).getTime();
				const endMs = l.end_time ? new Date(l.end_time).getTime() : Date.now();
				const sMin = new Date(startMs).getHours()*60 + new Date(startMs).getMinutes();
				const eMin = new Date(endMs).getHours()*60 + new Date(endMs).getMinutes();
				return sMin < slotEnd && eMin >= slotStart; // åŒ…å«å¼åˆ¤å®šï¼Œä¿®æ­£è¾¹ç•Œ
			});
			if(logOverlap) return true;
			// 2) æ— æ—¥å¿—æ—¶ï¼Œå…¼å®¹å®æ—¶å ç”¨ï¼šå°†â€œå½“å‰å ç”¨â€è§†ä½œä¸€æ¡ [registerTime, now] çš„ä¸´æ—¶ä¼šè¯
			const active = getActivePractice(student);
			if(active){
				const startMs=new Date(active.start_time).getTime();
				const endMs = Date.now();
				const sMin = new Date(startMs).getHours()*60 + new Date(startMs).getMinutes();
				const eMin = new Date(endMs).getHours()*60 + new Date(endMs).getMinutes();
				if(sMin < slotEnd && eMin >= slotStart) return true;
			}
			return false;
			function toMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
		}
		function slotAt(student){ const arr=AlertStore.slotsToday?.[student]; if(!arr) return null; const nowMin=minutesNow(); return arr.find(s=>{ const st=timeStrToMinutes(s.start_time); const et=timeStrToMinutes(s.end_time); return nowMin>=st && nowMin<=et; }); }
		function nextSlot(student){ const arr=AlertStore.slotsToday?.[student]; if(!arr) return null; const nowMin=minutesNow(); return arr.find(s=> timeStrToMinutes(s.start_time) > nowMin ); }
		function findSlotByStart(student, activeLog){ // æ ¹æ®æ´»åŠ¨æ—¥å¿—å¼€å§‹æ—¶é—´æ‰€å± slot - ä½¿ç”¨é‡å åˆ¤æ–­
			if(!activeLog) return null; 
			const arr=AlertStore.slotsToday?.[student]; 
			if(!arr) return null; 
			const stTime=new Date(activeLog.start_time); 
			const practiceStartMin=stTime.getHours()*60+stTime.getMinutes(); 
			// å‡è®¾ç»ƒç´è‡³å°‘æŒç»­1åˆ†é’Ÿæ¥æ£€æŸ¥é‡å 
			const practiceEndMin = activeLog.end_time ? 
				(new Date(activeLog.end_time).getHours()*60 + new Date(activeLog.end_time).getMinutes()) : 
				(practiceStartMin + 1);
			return arr.find(s=>{ 
				const sMin=timeStrToMinutes(s.start_time); 
				const eMin=timeStrToMinutes(s.end_time); 
				// ä½¿ç”¨é‡å åˆ¤æ–­ï¼šç»ƒç´å¼€å§‹æ—¶é—´ < æ—¶é—´æ®µç»“æŸ && ç»ƒç´ç»“æŸæ—¶é—´ > æ—¶é—´æ®µå¼€å§‹
				return practiceStartMin < eMin && practiceEndMin > sMin; 
			})||null; 
		}
		function anomalyShouldTrigger(student, activeLog){ 
				// æ–°é€»è¾‘ï¼šå½“å‰æ­£åœ¨ç»ƒç´ï¼Œä¸”å½“å‰æ—¶é—´ä¸å±äºè¯¥ç”Ÿä»»ä¸€ç»ƒç´æ—¶æ®µï¼Œå¹¶ä¸”â€œéæ—¶æ®µç»ƒç´ç´¯è®¡â‰¥é˜ˆå€¼(20åˆ†é’Ÿ)â€
				if(!activeLog) return false;
				const arr=AlertStore.slotsToday?.[student]||[]; 
				const nowMin=minutesNow();
				// è‹¥å½“å‰æ—¶é—´è½åœ¨ä»»ä¸€æ—¶æ®µå†…ï¼Œä¸è§¦å‘å¼‚å¸¸
				if(arr && arr.some(s=>{ const sMin=timeStrToMinutes(s.start_time); const eMin=timeStrToMinutes(s.end_time); return nowMin>=sMin && nowMin<=eMin; })) return false;
				// è®¡ç®—ä»ä¼šè¯å¼€å§‹èµ·åœ¨â€œéæ—¶æ®µâ€çŠ¶æ€æŒç»­äº†å¤šä¹…ï¼ˆåˆ†é’Ÿï¼‰
				const start = new Date(activeLog.start_time);
				let minutesOutside = Math.floor((Date.now() - start.getTime())/60000);
				// å¦‚æœå¼€å§‹æ—¶å…¶å®è½åœ¨æŸä¸ªæ—¶æ®µå†…ï¼Œéœ€è¦æ‰£é™¤åœ¨æ—¶æ®µå†…çš„é‚£æ®µæ—¶é—´ï¼Œä»…ç»Ÿè®¡ç¦»å¼€æ—¶æ®µåçš„æ—¶é•¿
				if(arr && arr.length){
					// æ‰¾åˆ°å¼€å§‹æ—¶æ‰€å¤„çš„æ—¶æ®µï¼ˆé‡å åˆ¤æ–­ï¼‰
					const sMin = start.getHours()*60 + start.getMinutes();
					const overlapAtStart = arr.find(s=>{ const a=timeStrToMinutes(s.start_time), b=timeStrToMinutes(s.end_time); return sMin < b && sMin >= a; });
					if(overlapAtStart){
						const endOfSlot = timeStrToMinutes(overlapAtStart.end_time);
						const delta = nowMin - endOfSlot; // åªæœ‰åœ¨ç»“æŸåæ‰å¼€å§‹è®¡æ—¶
						minutesOutside = Math.max(0, delta);
					}
				}
				return minutesOutside >= THRESHOLDS.ANOMALY_OVERRUN;
		}
		// è¿”å›ç”¨äºç”Ÿæˆå¼‚å¸¸æé†’çš„å‚è€ƒâ€œå½“å‰æ—¶é—´çª—å£â€ä¼ªæ—¶æ®µï¼ˆè‹¥ä¸åº”è§¦å‘åˆ™è¿”å› nullï¼‰
		function getReferenceAnomalySlot(student, activeLog){
				if(!anomalyShouldTrigger(student, activeLog)) return null;
					// å›ºå®šå±•ç¤ºï¼šä»â€œæœ¬æ¬¡ç»ƒç´çš„å¼€å§‹æ—¶é—´â€åˆ°â€œé¦–æ¬¡è¾¾åˆ°å¼‚å¸¸é˜ˆå€¼(ç¦»å¼€æ—¶æ®µç´¯è®¡â‰¥Nåˆ†é’Ÿ)â€çš„æ—¶é—´ç‚¹
					const pad = (n)=> String(n).padStart(2,'0');
					const st = new Date(activeLog.start_time);
					const start_time = `${pad(st.getHours())}:${pad(st.getMinutes())}`;
					// è®¡ç®— outsideStartï¼šå¦‚æœä¼šè¯å¼€å§‹æ—¶åœ¨æŸä¸ªæ—¶æ®µå†…ï¼Œåˆ™ä»¥è¯¥æ—¶æ®µç»“æŸä¸º outsideStartï¼›å¦åˆ™ä¸ºä¼šè¯å¼€å§‹
					const slots = AlertStore.slotsToday?.[student]||[];
					const stMin = st.getHours()*60 + st.getMinutes();
					let outsideStartMin = stMin;
					if(slots && slots.length){
						const overlapAtStart = slots.find(s=>{ const a=timeStrToMinutes(s.start_time), b=timeStrToMinutes(s.end_time); return stMin < b && stMin >= a; });
						if(overlapAtStart){ outsideStartMin = timeStrToMinutes(overlapAtStart.end_time); }
					}
					const detectionEndMin = (outsideStartMin + THRESHOLDS.ANOMALY_OVERRUN) % (24*60);
					const end_time = `${pad(Math.floor(detectionEndMin/60))}:${pad(detectionEndMin%60)}`;
					return { start_time, end_time };
		}
		let _lastDetectionDate=(new Date()).toDateString();
		// è®°å½•â€œå¼€å§‹çª—å£å†…é¦–æ¬¡åˆ¤å®šä¸ºæ— é‡å â€çš„æ—¶é—´æˆ³ï¼Œé”®: `${student}|${slot.start_time}-${slot.end_time}`
		const _startWindowNoOverlapSeen = new Map();
		// è§‚å¯Ÿåˆ°â€œè¯¥ç”Ÿåœ¨è¯¥æ—¶æ®µæœ‰è¿‡ä»»æ„é‡å ç»ƒç´â€çš„æ ‡è®°ï¼ˆå½“å¤©ç”Ÿæ•ˆï¼‰ï¼Œä¸€æ—¦æˆç«‹ï¼Œæ°¸ä¹…ä¸å†å¯¹è¯¥æ—¶æ®µç”Ÿæˆç¼ºå‹¤
		const _presentSeen = new Set();
		function presentKey(stu,slot){ const d=(new Date()).toISOString().slice(0,10); return `${d}|${stu}|${slot.start_time}-${slot.end_time}`; }
		async function detectionTick(){ // é¡ºåº: è·¨æ—¥é‡ç½® -> ç¡®ä¿slots -> å‘¨æœŸåˆ·æ–° -> ç¼ºå‹¤ -> æ´»åŠ¨è¶…æ—¶ -> ç»“æŸè¶…æ—¶
			if(AlertStore.recalcLock){
				return; // é‡ç®—æœŸé—´æš‚åœæ£€æµ‹
			}
			if(!window.supabaseClient) return; const todayStr=(new Date()).toDateString(); if(todayStr!==_lastDetectionDate){ // è·¨æ—¥ï¼šé‡ç½®slotsä¸å½“æ—¥alertsç¼“å­˜
			_lastDetectionDate=todayStr; AlertStore.slotsToday=null; AlertStore.lastSlotLoadDay=null; await fetchExistingAlerts(); AlertStore._lastFullReload = Date.now(); }
				// è¡¥å¿ï¼šæ¯5åˆ†é’Ÿå¼ºåˆ¶åˆ·æ–°æœªå¿½ç•¥æé†’ï¼Œé˜²æ­¢é”™è¿‡ UPDATE äº‹ä»¶å¯¼è‡´å¦ä¸€ç«¯å·²å¿½ç•¥å´ä»æ˜¾ç¤º
				if(!AlertStore._lastFullReload || (Date.now()-AlertStore._lastFullReload) > 5*60*1000){
					console.log('[PracticeAlerts] è§¦å‘å‘¨æœŸæ€§å…¨é‡åˆ·æ–° (5min)');
					await fetchExistingAlerts();
					AlertStore._lastFullReload = Date.now();
				}
				// å°é¢‘ç‡å¯¹è´¦ï¼šæ¯æ¬¡ tick åæ’ä¸€ä¸ªå»¶è¿Ÿå¯¹è´¦ï¼ˆé¿å…é«˜å¹¶å‘ç«‹åˆ»å¤šæ¬¡è¯·æ±‚ï¼‰
				scheduleReconcile(4000);
			await ensureSlotsLoaded(); const nowMin=minutesNow(); const students=Object.keys(AlertStore.slotsToday||{});
			// å‘¨æœŸåˆ·æ–°ï¼šæ¯10åˆ†é’Ÿå¼ºåˆ¶ (åˆ†é’Ÿæ•° %10 ==0) ä¸”è·ç¦»ä¸Šæ¬¡>2åˆ†é’Ÿï¼Œé¿å…åŒä¸€åˆ†é’Ÿå¤šæ¬¡
			const minute=new Date().getMinutes(); if(minute%10===0 && (now()-AlertStore._lastPeriodicReload)>120000){ forceReloadSlots().then(()=>{ AlertStore._lastPeriodicReload=now(); }); }
			for(const name of students){ 
				const arr=AlertStore.slotsToday[name]; 
				if(!arr||!arr.length) continue; 
				// æ£€æµ‹æ³¨å†Œè¾¹æ²¿ï¼šæ— åˆ°æœ‰ï¼Œè§†ä¸ºâ€œé‡æ–°ç™»è®°â€ï¼Œæ¸…ç†è¯¥ç”Ÿçš„é™é»˜
				const wasActive = AlertStore.prevActive.get(name) === true;
				const activeLogEdge = getActivePractice(name);
				const activeNowForEdge = !!activeLogEdge;
				if(!wasActive && activeNowForEdge){
					// ä»…æ¸…é™¤å½“å‰æ´»è·ƒä¼šè¯å¯¹åº”æ—¶æ®µé”®ï¼ˆabsent/anomalyï¼‰
					let curSlot=null; 
					const nowM=minutesNow();
					// 1) ä¼˜å…ˆæ ¹æ® active.start_time è½åœ¨å“ªä¸ª slot
					if(activeLogEdge){ 
						const stDate=new Date(activeLogEdge.start_time); const stM=stDate.getHours()*60+stDate.getMinutes();
						curSlot = arr.find(s=>{ const sM=timeStrToMinutes(s.start_time), eM=timeStrToMinutes(s.end_time); return stM>=sM && stM<=eM; }) || null;
					}
					// 2) è‹¥æœªå‘½ä¸­ï¼Œä½¿ç”¨å½“å‰æ—¶é—´è½åœ¨å“ªä¸ª slot
					if(!curSlot){ curSlot = arr.find(s=>{ const sM=timeStrToMinutes(s.start_time), eM=timeStrToMinutes(s.end_time); return nowM>=sM && nowM<=eM; }) || null; }
					if(curSlot){
						try{ clearSilenced(name,'absent',curSlot); }catch(_){ }
						try{ clearSilenced(name,'anomaly',curSlot); }catch(_){ }
					}
					// é‡æ–°ç™»è®°æ—¶ï¼Œæ¸…é™¤è¯¥ç”Ÿæ‰€æœ‰æœªè§£å†³çš„å¼‚å¸¸æé†’ï¼ˆçŠ¶æ€æ”¹å˜ï¼Œæ—§å¼‚å¸¸å¤±æ•ˆï¼‰
					const existingAnomalies = AlertStore.list.filter(a=> a.student_name===name && a.type==='anomaly' && !a.resolved);
					for(const a of existingAnomalies){ 
						await autoResolveAlert(a.id, 'å­¦ç”Ÿé‡æ–°ç™»è®°'); 
					}
				}
				AlertStore.prevActive.set(name, activeNowForEdge);
				// ç¼ºå‹¤ï¼šåªæ£€æµ‹å½“å‰æ­£åœ¨è¿›è¡Œçš„æ—¶é—´æ®µ
				for(const slot of arr){ 
					const st=timeStrToMinutes(slot.start_time); 
					const et=timeStrToMinutes(slot.end_time);
					
					// åªæ£€æµ‹å½“å‰æ­£åœ¨è¿›è¡Œçš„æ—¶é—´æ®µï¼ˆå¼€å§‹å5åˆ†é’Ÿå¼€å§‹æ£€æµ‹ï¼Œæ—¶æ®µç»“æŸååœæ­¢æ£€æµ‹ï¼‰
					if(nowMin>=st+THRESHOLDS.ABSENT_WINDOW_START && nowMin<=et){
						// è‹¥å·²è§‚å¯Ÿåˆ°è¯¥æ—¶æ®µå‡ºç°è¿‡é‡å ï¼Œåˆ™ä¸å†å¯¹è¯¥æ—¶æ®µç”Ÿæˆç¼ºå‹¤
						const pk = presentKey(name,slot);
						// å³æ—¶æ£€æµ‹å½“å‰æ˜¯å¦æœ‰é‡å ï¼ˆå«å ç”¨å…œåº•ï¼‰ï¼Œè‹¥æœ‰åˆ™æ‰“æ ‡
						if(!_presentSeen.has(pk) && hasPracticeOverlap(name,slot)) _presentSeen.add(pk);
						
						// è‹¥å­¦ç”Ÿå½“å‰æ­£å¤„äºæœ¬æ—¶æ®µå¹¶åœ¨ç»ƒç´ï¼Œä¸åº”åˆ¤ä¸ºç¼ºå‹¤
						const activeNow = getActivePractice(name);
						if(!(activeNow && nowMin>=st && nowMin<=et)){
							if(_presentSeen.has(pk)) continue; // æ›¾å‡ºç°è¿‡é‡å  -> æ°¸ä¸ç¼ºå‹¤
							const key = `${name}|${slot.start_time}-${slot.end_time}`;
							const overlapNow = hasPracticeOverlap(name,slot);
							if(overlapNow){
								// ä¸€æ—¦å‡ºç°é‡å ï¼Œæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ— é‡å æ ‡è®°
								_startWindowNoOverlapSeen.delete(key);
								_presentSeen.add(pk);
							}else if(!hasAlert(name,'absent',slot) && !isSilenced(name,'absent',slot)){
								// ç®€åŒ–é€»è¾‘ï¼šç›´æ¥åˆ›å»ºç¼ºå‹¤æé†’ï¼Œä¸éœ€è¦ç­‰å¾…ç¡®è®¤æœŸ
								await createAlert({type:ALERT_TYPES.ABSENT, student_name:name, slot, message:`${slot.start_time}-${slot.end_time} æ—¶æ®µç¼ºå‹¤`, severity:2});
							}
						}
					}
				}
				// è‡ªåŠ¨æ¶ˆå¤±ï¼šå¦‚æœå·²æœ‰ç¼ºå‹¤æé†’ï¼Œåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨åˆ é™¤ï¼š
				// 1. æ—¶æ®µå†…æœ‰äº†ç»ƒç´è®°å½•
				// 2. æ—¶æ®µå·²ç»ç»“æŸ
				const existingAbsentAlerts = AlertStore.list.filter(a => a.student_name === name && a.type === 'absent');
				for(const alert of existingAbsentAlerts) {
					if(alert.slot) {
						const alertSlotEnd = timeStrToMinutes(alert.slot.end_time);
						
						// æƒ…å†µ1ï¼šæ—¶æ®µå†…æœ‰äº†ç»ƒç´è®°å½•
						if(hasPracticeOverlap(name, alert.slot)) {
							const k = `${name}|${alert.slot.start_time}-${alert.slot.end_time}`;
							_startWindowNoOverlapSeen.delete(k);
							await autoResolveAlert(alert.id, `${alert.slot.start_time} æ—¶æ®µå·²å¼€å§‹ç»ƒç´`);
						}
						// æƒ…å†µ2ï¼šæ—¶æ®µå·²ç»ç»“æŸ
						else if(nowMin > alertSlotEnd) {
							await autoResolveAlert(alert.id, `${alert.slot.start_time}-${alert.slot.end_time} æ—¶æ®µå·²ç»“æŸ`);
						}
					}
				}
				// å¼‚å¸¸ï¼šéæ—¶æ®µç»ƒç´è¾¾é˜ˆå€¼ï¼ˆ20åˆ†é’Ÿï¼‰
				const active=getActivePractice(name); 
				if(active){
					const refSlot = getReferenceAnomalySlot(name, active);
					if(refSlot && !hasAlert(name,'anomaly',refSlot) && !isSilenced(name,'anomaly',refSlot)){
						console.log('[PracticeAlerts] è§¦å‘å¼‚å¸¸æé†’(éæ—¶æ®µç»ƒç´)', name, refSlot.start_time, refSlot.end_time);
						await createAlert({type:ALERT_TYPES.ANOMALY, student_name:name, slot:refSlot, severity:1}); 
					}
					// è‹¥å½“å‰å·²è¿›å…¥ä»»ä¸€æ’è¯¾æ—¶æ®µï¼Œè‡ªåŠ¨æ¶ˆå¤±åŒç¼ºå‹¤é€»è¾‘
					const arrSlots = AlertStore.slotsToday?.[name]||[]; const nowM=minutesNow();
					if(arrSlots.some(s=>{ const sM=timeStrToMinutes(s.start_time), eM=timeStrToMinutes(s.end_time); return nowM>=sM && nowM<=eM; })){
						const existingAnomaly = AlertStore.list.filter(a=> a.student_name===name && a.type==='anomaly');
						for(const a of existingAnomaly){ await autoResolveAlert(a.id, 'å·²è¿›å…¥æ’è¯¾æ—¶æ®µ'); }
					}
					if(active.pseudo && !window.practiceLogs){
						window.practiceLogs = window.practiceLogs || {}; 
						const arr2 = window.practiceLogs[name] || (window.practiceLogs[name]=[]);
						if(!arr2.some(l=>l.pseudo && !l.end_time)){
							arr2.push({start_time:active.start_time, room:active.room, pseudo:true});
						}
					}
				}else{
					// åœæ­¢ç»ƒç´åï¼Œå¼‚å¸¸æé†’è‡ªåŠ¨æ¶ˆå¤±
					const existingAnomaly = AlertStore.list.filter(a=> a.student_name===name && a.type==='anomaly');
					for(const a of existingAnomaly){ await autoResolveAlert(a.id, 'å·²åœæ­¢ç»ƒç´'); }
				}
			} // end students loop
		} // end detectionTick

		// ==== ä»Šæ—¥é‡ç®—å¹¶è¦†ç›–äº‘ç«¯ practice_alerts ====
		async function recalcToday(full=false){
			if(!window.supabaseClient){ console.warn('[PracticeAlerts][Recalc] no supabaseClient'); return; }
			if(AlertStore.recalcLock){ console.warn('[PracticeAlerts][Recalc] already running'); return; }
			AlertStore.recalcLock = true;
			console.log('[PracticeAlerts][Recalc] å¼€å§‹');
			const startedAt = Date.now();
			try{
				// 1. å‡†å¤‡æ•°æ®
				const today = new Date(); today.setHours(0,0,0,0); const todayIso = today.toISOString();
				const weekday=(new Date().getDay()+6)%7 +1; // 1-7
				const {data:slotRows, error:slotErr}=await supabaseClient.from('student_time_slots').select('*').eq('weekday', weekday);
				if(slotErr){ console.error('[PracticeAlerts][Recalc] slot fetch error', slotErr); return; }
				const slotsMap={}; (slotRows||[]).forEach(s=>{ (slotsMap[s.student_name] ||= []).push(s); });
				Object.values(slotsMap).forEach(arr=>arr.sort((a,b)=>a.start_time.localeCompare(b.start_time)));
				// ---- è·å–ç»ƒç´æ—¥å¿—ï¼šå…¼å®¹å¤šç‰ˆæœ¬åˆ—å (start_time/end_time æˆ– session_start/session_end) ----
				let logRows=[]; let logErr=null; let variantUsed=null;
				const variants=[
					{start:'start_time', end:'end_time'},
					{start:'session_start', end:'session_end'}
				];
				for(const v of variants){
					try{
						let q=supabaseClient.from('practice_logs').select(`student_name,${v.start},${v.end}`);
						q=q.gte(v.start, todayIso);
						const {data:eRows, error:eErr}=await q;
						if(eErr){ logErr=eErr; continue; }
						if(eRows && eRows.length){ logRows=eRows; variantUsed=v; break; }
						// è‹¥æ— æ•°æ®å°è¯•ä¸‹ä¸€ä¸ªå˜ä½“
					}catch(e){ logErr=e; }
				}
				if(!variantUsed){
					console.warn('[PracticeAlerts][Recalc] æœªåŒ¹é…åˆ°å«æ•°æ®çš„åˆ—åå˜ä½“ï¼Œæœ€åé”™è¯¯=', logErr); 
				}else{
					console.log('[PracticeAlerts][Recalc] ä½¿ç”¨æ—¥å¿—åˆ—å˜ä½“', variantUsed);
				}
				// å½’ä¸€åŒ–æ—¥å¿— -> {student_name, start_time, end_time}
				const logsByStu={};
				for(const raw of (logRows||[])){
					const stu=(raw.student_name||'').trim();
					const sCol=variantUsed? variantUsed.start : 'start_time';
					const eCol=variantUsed? variantUsed.end : 'end_time';
					const sVal=raw[sCol]; const eVal=raw[eCol];
					if(!sVal) continue; // æ²¡æœ‰å¼€å§‹æ—¶é—´æ— æ³•å‚ä¸é‡å 
					(constArr => { constArr.push({student_name:stu,start_time:sVal,end_time:eVal}); })( (logsByStu[stu] ||= []) );
				}
				// åˆå¹¶ï¼šåŒä¸€ start_time è‹¥åŒæ—¶å­˜åœ¨å·²ç»“æŸä¸æœªç»“æŸï¼Œä¼šä¼˜å…ˆä¿ç•™å·²ç»“æŸï¼ˆé¿å…â€œå¹½çµæœªç»“æŸâ€å¯¼è‡´æ•´ä¸Šåˆè¢«è§†ä¸ºä»åœ¨ç»ƒç´ï¼‰
				for(const stu of Object.keys(logsByStu)){
					const grouped = new Map();
					for(const l of logsByStu[stu]){
						const key=l.start_time; const prev=grouped.get(key);
						if(!prev) grouped.set(key,l);
						else{
							// é€‰æ‹©ç­–ç•¥ï¼šä¼˜å…ˆ end_time å­˜åœ¨çš„ï¼›è‹¥éƒ½æ—  end_time å–æœ€æ—©ï¼ˆä¿æŒåŸï¼‰
							if(prev.end_time) continue; // å·²æœ‰ç»“æŸçš„ï¼Œä¸æ›¿æ¢
							if(l.end_time){ grouped.set(key,l); }
						}
					}
					logsByStu[stu] = Array.from(grouped.values());
				}
				console.log('[PracticeAlerts][Recalc] slots å­¦ç”Ÿæ•°=', Object.keys(slotsMap).length, 'logs æ¡æ•°(è§„èŒƒåŒ–)=', logRows?.length||0);
				// 2. ç”Ÿæˆå€™é€‰
				const now=new Date(); const nowMin=now.getHours()*60+now.getMinutes();
				const alerts=[]; const dedupe=new Set();
				function toMin(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
				// å¤ç”¨é¡µé¢å®æ—¶é€»è¾‘ï¼šé‡å æ¡ä»¶ä¸ hasPracticeOverlap ä¿æŒä¸€è‡´ (sMin < slotEnd && eMin >= slotStart)
				function overlap(slot,log){
					const sS=toMin(slot.start_time), sE=toMin(slot.end_time);
					const stDate=new Date(log.start_time); const enDate = log.end_time? new Date(log.end_time): now;
					const sM=stDate.getHours()*60+stDate.getMinutes();
					const eM=enDate.getHours()*60+enDate.getMinutes();
					return sM < sE && eM >= sS; // ä¿®æ­£ >= è¾¹ç•Œ
				}
				const T=THRESHOLDS || {ABSENT_WINDOW_START:5,ABSENT_WINDOW_END:15,ABSENT_PAST_GRACE:25, ANOMALY_OVERRUN:15};
				let absentCount=0, anomalyCount=0;
				for(const student of Object.keys(slotsMap)){
					const slots=slotsMap[student]; const logs=logsByStu[student]||[];
					for(let i=0;i<slots.length;i++){
						const slot=slots[i]; const st=toMin(slot.start_time), et=toMin(slot.end_time);
						const hasOverlap = logs.some(l=>overlap(slot,l));
						// è°ƒè¯•ï¼šæ‰“å°è·¨æ®µé•¿ä¼šè¯ä¸è¯¥ slot çš„åˆ¤æ–­ï¼ˆä»…åœ¨éœ€è¦æ—¶å¯æ³¨é‡Šï¼‰
						// console.debug('[Recalc][OverlapDebug]', student, slot.start_time, slot.end_time, 'hasOverlap=', hasOverlap);
						if(!hasOverlap){
							// åªæ£€æµ‹å½“å‰æ­£åœ¨è¿›è¡Œçš„æ—¶é—´æ®µï¼ˆå¼€å§‹å5åˆ†é’Ÿå¼€å§‹æ£€æµ‹ï¼Œæ—¶æ®µç»“æŸååœæ­¢æ£€æµ‹ï¼‰
							const inCurrentSlot = nowMin>=st+T.ABSENT_WINDOW_START && nowMin<=et;
							if(inCurrentSlot){
								const key=`${student}|absent|${slot.start_time}-${slot.end_time}`;
								// å¢åŠ é™é»˜åˆ¤æ–­ï¼šè‹¥è¯¥å­¦ç”Ÿè¯¥æ—¶æ®µç¼ºå‹¤å·²è¢«å¿½ç•¥ï¼ˆé™é»˜ï¼‰ï¼Œåˆ™ä¸å†ç”Ÿæˆ
								if(!dedupe.has(key) && !isSilenced(student,'absent', {start_time:slot.start_time,end_time:slot.end_time})){
									dedupe.add(key);
									alerts.push({student_name:student,type:'absent',slot_start:slot.start_time,slot_end:slot.end_time});
									absentCount++;
								}
							}
						}else{
							// å¼‚å¸¸ï¼šè‹¥å½“å‰æœ‰è¿›è¡Œä¸­ä¼šè¯ï¼Œä¸”å½“å‰ä¸å¤„äºä»»ä½•æ—¶æ®µï¼Œå¹¶ä¸”ç¦»å¼€æ’è¯¾æ—¶æ®µç´¯è®¡â‰¥20åˆ†é’Ÿ
							const activeLog = logs.find(l=>!l.end_time);
							if(activeLog){
								const inAnySlotNow = slots.some(s=>{ const sM=toMin(s.start_time), eM=toMin(s.end_time); return nowMin>=sM && nowMin<=eM; });
								if(!inAnySlotNow){
									// è®¡ç®—éæ—¶æ®µæŒç»­æ—¶é•¿
									const stDate=new Date(activeLog.start_time); const stMin=stDate.getHours()*60+stDate.getMinutes();
									let outsideMinutes = Math.floor((now.getTime()-stDate.getTime())/60000);
									const overlapAtStart = slots.find(s=>{ const a=toMin(s.start_time), b=toMin(s.end_time); return stMin < b && stMin >= a; });
									if(overlapAtStart){ const endOfSlot = toMin(overlapAtStart.end_time); outsideMinutes = Math.max(0, nowMin - endOfSlot); }
									if(outsideMinutes >= T.ANOMALY_OVERRUN){
										// å›ºå®šå±•ç¤ºï¼šä»â€œæœ¬æ¬¡ç»ƒç´çš„å¼€å§‹æ—¶é—´â€åˆ°â€œé¦–æ¬¡è¢«åˆ¤å®šä¸ºå¼‚å¸¸â€çš„æ—¶é—´ç‚¹
										// outsideStartï¼šè‹¥ä¼šè¯å¼€å§‹æ—¶è½åœ¨æŸä¸ªæ—¶æ®µï¼Œåˆ™å–è¯¥æ—¶æ®µç»“æŸï¼›å¦åˆ™å–ä¼šè¯å¼€å§‹
										const pad=n=>String(n).padStart(2,'0');
										let outsideStartMin = stMin;
										if(overlapAtStart){
											outsideStartMin = toMin(overlapAtStart.end_time);
										}
										const detectionEndMin = (outsideStartMin + T.ANOMALY_OVERRUN) % (24*60);
										const endH = Math.floor(detectionEndMin/60), endM = detectionEndMin%60;
										const end_time=`${pad(endH)}:${pad(endM)}`;
										const start_time=`${pad(stDate.getHours())}:${pad(stDate.getMinutes())}`;
										const key=`${student}|anomaly|today`;
										if(!dedupe.has(key) && !isSilenced(student,'anomaly',{start_time:'none',end_time:'none'})){
											dedupe.add(key);
											alerts.push({student_name:student,type:'anomaly',slot_start:start_time,slot_end:end_time});
											anomalyCount++;
										}
									}
								}
							}
						}
					}
				}
				console.log('[PracticeAlerts][Recalc] ç”Ÿæˆå€™é€‰', alerts.length, 'ç¼ºå‹¤=', absentCount, 'å¼‚å¸¸=', anomalyCount, 'full=', full);
				// 3. è¦†ç›–ï¼šåˆ é™¤ä»Šæ—¥æ—§æ•°æ®
				const {error:delErr}=await supabaseClient.from('practice_alerts').delete().gte('created_at', todayIso);
				if(delErr){ console.error('[PracticeAlerts][Recalc] åˆ é™¤æ—§æé†’å¤±è´¥', delErr); return; }
				// 4. æ‰¹é‡æ’å…¥
				const batch=120; for(let i=0;i<alerts.length;i+=batch){ const slice=alerts.slice(i,i+batch); const {error:insErr}=await supabaseClient.from('practice_alerts').insert(slice); if(insErr){ console.error('[PracticeAlerts][Recalc] æ’å…¥å¤±è´¥ batch', i, insErr); return; } }
				console.log('[PracticeAlerts][Recalc] å†™å…¥å®Œæˆ ç”¨æ—¶(ms)=', Date.now()-startedAt);
				// 5. é‡æ–°æ‹‰å–æ¸²æŸ“
				await fetchExistingAlerts();
			}finally{
				AlertStore.recalcLock=false;
			}
		}
	function hasAlert(student,type,slot){ 
		return AlertStore.list.some(a=> { 
			if(a.student_name!==student || a.type!==type || a.resolved) return false; 
			if(type==='anomaly') return true; // åŒä¸€å¤©åŒä¸€å­¦ç”Ÿä»…ä¿ç•™ä¸€æ¡å¼‚å¸¸
			return a.slot && slot && a.slot.start_time===slot.start_time && a.slot.end_time===slot.end_time; 
		}); 
	}
	async function autoResolveAlert(id, reason) {
		const a = AlertStore.byId.get(String(id));
		if (!a) return;
		// æœ¬åœ°ç§»é™¤
		removeAlertLocal(id);
		renderAlerts();
		// æœåŠ¡ç«¯æ ‡è®°ä¸º resolved æˆ–åˆ é™¤
		if (!window.supabaseClient) return;
		try {
			const {error} = await supabaseClient.from('practice_alerts').delete().eq('id', id);
			if (error) {
				console.warn('auto resolve alert delete fail', error);
				// å›æ»š
				AlertStore.byId.set(String(id), a);
				AlertStore.list.unshift(a);
				renderAlerts();
			}
		} catch(e) {
			console.error(e);
			AlertStore.byId.set(String(id), a);
			AlertStore.list.unshift(a);
			renderAlerts();
		}
	}
		function dedupeKey(raw){ 
			const dKey=(new Date()).toISOString().slice(0,10); 
			if(raw.type==='anomaly'){
				// å¼‚å¸¸ï¼šåŒä¸€å¤©åŒä¸€å­¦ç”Ÿåªå…è®¸ä¸€æ¡æœªå¿½ç•¥æé†’
				return `${raw.student_name}|${raw.type}|${dKey}`;
			}
			const slotPart=raw.slot?`${raw.slot.start_time}-${raw.slot.end_time}`:'none'; 
			return `${raw.student_name}|${raw.type}|${slotPart}|${dKey}`; 
		}
		function markDedupe(key){ AlertStore.dedupe.add(key); setTimeout(()=>AlertStore.dedupe.delete(key), 60*60*1000); }
		async function createAlert(raw){ 
				const key=dedupeKey(raw); if(AlertStore.dedupe.has(key)) return; 
				
				// è°ƒè¯•æ—¥å¿—ï¼šè®°å½• slot æ•°æ®
				if(raw.slot) {
					console.log('[PracticeAlerts] createAlert slot data:', {
						student_name: raw.student_name,
						type: raw.type,
						slot_start_time: raw.slot.start_time,
						slot_end_time: raw.slot.end_time,
						slot_data: raw.slot
					});
				}
				
				// ğŸ” å¼‚å¸¸æé†’ï¼šä»æ•°æ®åº“å®æ—¶æŸ¥è¯¢å­¦ç”Ÿæ‰€åœ¨ç´æˆ¿
				let currentRoomName = null;
				if(raw.type === 'anomaly' && raw.student_name) {
					try {
						const normalizeName = (s)=>{
							return (s||'')
								.replace(/\s+/g,'')
								.replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g,'')
								.replace(/\([^)]*\)/g,'')
								.replace(/\[[^\]]*\]/g,'')
								.replace(/ã€[^ã€‘]*ã€‘/g,'')
								.trim();
						};
						const targetName = normalizeName(raw.student_name);
						
						// ä»æ•°æ®åº“æŸ¥è¯¢åŒ…å«è¯¥å­¦ç”Ÿçš„æˆ¿é—´
						const {data: rooms, error} = await supabaseClient
							.from('rooms')
							.select('name, occupant_student_name')
							.not('occupant_student_name', 'is', null);
						
						if(!error && rooms && rooms.length > 0) {
							console.log('[createAlert] æŸ¥è¯¢åˆ°æˆ¿é—´æ•°æ®:', rooms.length, 'ä¸ªæˆ¿é—´');
							// åœ¨è¿”å›çš„æˆ¿é—´ä¸­æŸ¥æ‰¾åŒ…å«è¯¥å­¦ç”Ÿçš„æˆ¿é—´
							const room = rooms.find(r => {
								const occStr = String(r.occupant_student_name || '');
								const occupants = occStr.split(/[,ï¼Œã€;ï¼›|ï½œ\/\s]+/).map(n=>normalizeName(n)).filter(Boolean);
								return occupants.includes(targetName);
							});
							if(room) {
								currentRoomName = room.name;
								console.log('[createAlert] æ‰¾åˆ°å­¦ç”Ÿæ‰€åœ¨æˆ¿é—´:', currentRoomName);
							} else {
								console.log('[createAlert] æœªæ‰¾åˆ°å­¦ç”Ÿæ‰€åœ¨æˆ¿é—´');
							}
						}
					} catch(e) {
						console.error('[createAlert] æŸ¥è¯¢æˆ¿é—´å¤±è´¥:', e);
					}
				}
				
				// æœåŠ¡å™¨è¡¨æ—  message å­—æ®µï¼šä»…å­˜ç»“æ„åŒ–å­—æ®µ
				const payload={ 
					student_name:raw.student_name, 
					type:raw.type, 
					slot_start:raw.slot?raw.slot.start_time:null, 
					slot_end:raw.slot?raw.slot.end_time:null, 
					ignored:false, 
					severity:typeof raw.severity==='number'?raw.severity:null 
				};
				if(!supabaseClient) return; 
				// å…ˆåšåŒæ—¥å­˜åœ¨æ€§æ£€æŸ¥ï¼Œé¿å…è·¨ç«¯åˆšå¿½ç•¥ååˆå› æœ¬ç«¯ tick ç«‹å³æ’å…¥
				try{
					const since=new Date(); since.setHours(0,0,0,0);
					let qry=supabaseClient.from('practice_alerts')
						.select('id')
						.gte('created_at', since.toISOString())
						.eq('student_name', payload.student_name)
						.eq('type', payload.type)
						.eq('ignored', false);
					// å¼‚å¸¸æé†’ï¼šä¸æŒ‰ slot å»é‡ï¼ŒåŒä¸€å­¦ç”ŸåŒä¸€å¤©åªä¿ç•™ä¸€æ¡
					if(payload.type!=='anomaly'){
						if(payload.slot_start!=null) qry = qry.eq('slot_start', payload.slot_start);
						if(payload.slot_end!=null) qry = qry.eq('slot_end', payload.slot_end);
					}
					const {data:exists, error:exErr} = await qry.limit(1);
					if(!exErr && exists && exists.length){ markDedupe(key); return; }
				}catch(ex){ console.warn('[PracticeAlerts] existence check fail, continue insert', ex); }
				try{ 
					const {data,error}=await supabaseClient.from('practice_alerts').insert(payload).select(); 
					if(error){ 
						if(error.code==='23505'){ // å”¯ä¸€çº¦æŸå†²çªï¼Œé™é»˜å¿½ç•¥
							markDedupe(key); return; 
						}
						console.warn('create alert fail', error); return;
					}
					if(!data || !Array.isArray(data) || data.length===0){
						console.debug('[PracticeAlerts] insert returned no row; will rely on realtime INSERT');
						markDedupe(key); return;
					}
					const rec=data[0]; 
					if(!rec){
						console.warn('[PracticeAlerts] insert returned undefined row; skip local add');
						markDedupe(key); return;
					}
					rec.slot={start_time:payload.slot_start,end_time:payload.slot_end}; 
					if(typeof payload.severity!=='undefined') rec.severity=payload.severity; 
					// ğŸ’¡ å­˜å‚¨æŸ¥è¯¢åˆ°çš„æˆ¿é—´åç§°ï¼ˆç”¨äºå¼‚å¸¸æé†’æ˜¾ç¤ºï¼‰
					if(currentRoomName) rec._roomName = currentRoomName;
					// å‰ç«¯åŠ¨æ€ç”Ÿæˆ message æ–‡æ¡ˆ
					rec._msg = raw.message || buildAlertMessage(rec);
					AlertStore.list.unshift(rec); 
					AlertStore.byId.set(String(rec.id),rec); 
					markDedupe(key); trimAlerts(); renderAlerts(); 
				}catch(e){ console.error(e); }
	}
	function trimAlerts(){ if(AlertStore.list.length>300){ AlertStore.list.length=300; } }
	// ğŸ’¡ ç»ƒä¹ æ—¶é—´æ£€æµ‹é¢‘ç‡ä¼˜åŒ– - ä»1åˆ†é’Ÿå»¶é•¿åˆ°5åˆ†é’Ÿ
	function startTimer(){ 
		if(AlertStore.timer) return; 
		const DETECTION_INTERVAL = 300000; // 5åˆ†é’Ÿé—´éš”ï¼Œå‡å°‘æœåŠ¡å™¨è¯·æ±‚
		logInfo(`ç»ƒä¹ æ—¶é—´æ£€æµ‹å¯åŠ¨ï¼Œé—´éš”${DETECTION_INTERVAL/60000}åˆ†é’Ÿ`);
		AlertStore.timer=setInterval(detectionTick, DETECTION_INTERVAL); 
	}
		function removeAlertLocal(id){ const idx=AlertStore.list.findIndex(i=>String(i.id)===String(id)); if(idx>=0) AlertStore.list.splice(idx,1); AlertStore.byId.delete(String(id)); }
		function buildAlertMessage(a){
			if(a.type==='absent'){
				return `${a.slot_start||a.slot?.start_time||''} æ—¶æ®µæœªç™»è®°`;
			}
			if(a.type==='anomaly'){
				// ä¼˜å…ˆä½¿ç”¨åˆ›å»ºæ—¶æŸ¥è¯¢åˆ°çš„æˆ¿é—´åç§°
				const currentRoom = a._roomName || null;
				const roomText = currentRoom ? `åœ¨ ${currentRoom} ` : '';
				return `${roomText}æ­£åœ¨éæ’è¯¾æ—¶æ®µç»ƒç´ï¼Œå·²æŒç»­ ${THRESHOLDS.ANOMALY_OVERRUN} åˆ†é’Ÿ`;
			}
			return '';
		}
		function setupRealtime(){ 
			if(!window.supabaseClient) return; 
			// é˜²æŠ–ï¼šå·²æœ‰è¿æ¥åœ¨è¿›è¡Œä¸­å°±ä¸é‡å¤
			if(AlertStore._rtConnecting) return; 
			AlertStore._rtConnecting = true;
			const MAX_RETRIES = 12;
			AlertStore._rtRetry = AlertStore._rtRetry || 0;
			try{ 
				if(AlertStore._rtChannel){
					try{ supabaseClient.removeChannel(AlertStore._rtChannel); }catch(_e){}
				}
				const channel=supabaseClient.channel('realtime-practice-alerts', { config: { broadcast: { self: false } } });
				AlertStore._rtChannel = channel;
				channel.on('broadcast', {event: 'ignore'}, payload => {
					const id = payload.payload?.id;
					console.log('[PracticeAlerts][BC][ignore] æ”¶åˆ°å¹¿æ’­ id=', id);
					if(id!=null){ removeAlertLocal(id); renderAlerts(); }
				});
				channel
					.on('postgres_changes',{event:'INSERT',schema:'public',table:'practice_alerts'}, payload=>{ 
						const rec=payload.new; 
						console.log('[PracticeAlerts][RT][INSERT]', rec.id, rec.type, 'ignored=', rec.ignored);
						window.__lastRealtimeDataUpdate = Date.now(); // è®°å½•æ•°æ®æ›´æ–°æ—¶é—´
						
						// å¦‚æœæ˜¯å¿½ç•¥çš„è®°å½•ï¼Œç›´æ¥è®¾ç½®é™é»˜çŠ¶æ€ï¼Œä¸æ˜¾ç¤º
						if(rec.ignored) {
							try {
								const slot = rec.slot_start && rec.slot_end ? 
									{start_time: rec.slot_start, end_time: rec.slot_end} : null;
								setSilenced(rec.student_name, rec.type, slot);
								console.log('[PracticeAlerts][RT][INSERT] å·²å¿½ç•¥è®°å½•ï¼Œè®¾ç½®é™é»˜çŠ¶æ€');
							} catch(e) {
								console.warn('[PracticeAlerts][RT][INSERT] è®¾ç½®é™é»˜çŠ¶æ€å¤±è´¥', e);
							}
							return;
						}
						
						// è§„èŒƒåŒ–æ—¶é—´ï¼ˆHH:MMï¼‰å¹¶æ„å»º slot
						function fmtHHMM(v){
							if(v==null) return '';
							if(typeof v==='number'){
								if(v>=0 && v<24){ return String(v).padStart(2,'0')+':00'; }
								if(v>=0 && v<=1440){ const h=Math.floor(v/60), m=v%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
								return String(v);
							}
							if(typeof v==='string'){
								const m=v.match(/^(\d{1,2})(?::(\d{1,2}))?$/);
								if(m){ return `${String(m[1]).padStart(2,'0')}:${String(m[2]??'0').padStart(2,'0')}`; }
								const m2=v.match(/^(\d{2}):(\d{2})$/); if(m2) return v;
								return v;
							}
							return String(v);
						}
						const s = fmtHHMM(rec.slot_start);
						const e = fmtHHMM(rec.slot_end);
						rec.slot = (s && e) ? {start_time:s, end_time:e} : null;
						
						// å»é‡åˆ¤æ–­ï¼šåŒä¸€ ID æˆ–åŒä¸€å­¦ç”ŸåŒä¸€ç±»å‹å½“æ—¥å·²å­˜åœ¨
						if(AlertStore.byId.has(String(rec.id))){ 
							console.log('[PracticeAlerts][RT][INSERT] è·³è¿‡ï¼šID å·²å­˜åœ¨', rec.id);
							return; 
						}
						// å¼‚å¸¸ï¼šåŒå­¦ç”Ÿå½“æ—¥ä»…ä¿ç•™ä¸€æ¡æœªå¿½ç•¥
						if(rec.type==='anomaly'){
							const existing = AlertStore.list.find(a=> a.student_name===rec.student_name && a.type==='anomaly' && !a.ignored);
							if(existing){
								console.log('[PracticeAlerts][RT][INSERT] è·³è¿‡ï¼šè¯¥å­¦ç”Ÿå½“æ—¥å·²æœ‰å¼‚å¸¸', rec.student_name, 'existing_id=', existing.id);
								return;
							}
						}
						// ç¼ºå‹¤ï¼šåŒå­¦ç”ŸåŒæ—¶æ®µå½“æ—¥ä»…ä¿ç•™ä¸€æ¡æœªå¿½ç•¥
						else if(rec.type==='absent' && rec.slot){
							const existing = AlertStore.list.find(a=> 
								a.student_name===rec.student_name && a.type==='absent' && !a.ignored &&
								a.slot && a.slot.start_time===rec.slot.start_time && a.slot.end_time===rec.slot.end_time
							);
							if(existing){
								console.log('[PracticeAlerts][RT][INSERT] è·³è¿‡ï¼šè¯¥å­¦ç”Ÿè¯¥æ—¶æ®µå·²æœ‰ç¼ºå‹¤', rec.student_name, rec.slot.start_time, 'existing_id=', existing.id);
								return;
							}
						}
						
						AlertStore.list.unshift(rec); 
						AlertStore.byId.set(String(rec.id),rec); 
						renderAlerts(); 
					})
					.on('postgres_changes',{event:'DELETE',schema:'public',table:'practice_alerts'}, payload=>{
						const rec=payload.old; 
						console.log('[PracticeAlerts][RT][DELETE]', rec?.id);
						window.__lastRealtimeDataUpdate = Date.now(); // è®°å½•æ•°æ®æ›´æ–°æ—¶é—´
						if(rec?.id!=null){ removeAlertLocal(rec.id); renderAlerts(); }
					})
					.on('postgres_changes',{event:'UPDATE',schema:'public',table:'practice_alerts'}, payload=>{ 
						const rec=payload.new; 
						console.log('[PracticeAlerts][RT][UPDATE]', rec.id, 'ignored=', rec.ignored);
						window.__lastRealtimeDataUpdate = Date.now(); // è®°å½•æ•°æ®æ›´æ–°æ—¶é—´
						// è‹¥è¢«æ ‡è®°å¿½ç•¥ï¼Œç›´æ¥æœ¬åœ°ç§»é™¤
						if(rec.ignored){ removeAlertLocal(rec.id); return renderAlerts(); }
						const exist=AlertStore.byId.get(String(rec.id)); 
						if(exist){ 
							Object.assign(exist,rec); 
							exist.slot={start_time:rec.slot_start,end_time:rec.slot_end}; 
							renderAlerts(); 
						} else {
							rec.slot={start_time:rec.slot_start,end_time:rec.slot_end};
							AlertStore.list.unshift(rec);
							AlertStore.byId.set(String(rec.id), rec);
							renderAlerts();
						}
					})
					.subscribe(status=>{ 
						if(status==='SUBSCRIBED'){
							AlertStore._rtRetry = 0;
							AlertStore._rtConnecting=false;
							AlertStore._lastSuccessConnect = Date.now();
							// åªåœ¨é¦–æ¬¡è¿æ¥æˆ–é‡è¿æˆåŠŸæ—¶è¾“å‡ºæ—¥å¿—
							if(AlertStore._rtRetry > 0 || !AlertStore._lastSuccessConnect) {
								console.log('[PracticeAlerts][RT] âœ… å·²è¿æ¥');
							}
							return;
						}
						if(status==='CHANNEL_ERROR' || status==='TIMED_OUT' || status==='CLOSED'){
							AlertStore._rtConnecting=false;
							
							// æ£€æŸ¥æ˜¯å¦åˆšè¿æ¥æˆåŠŸä¸ä¹…ï¼Œé¿å…é¢‘ç¹é‡è¿
							const timeSinceLastSuccess = Date.now() - (AlertStore._lastSuccessConnect || 0);
							if(timeSinceLastSuccess < 5000) { // 5ç§’å†…ä¸é‡è¿
								return;
							}
							
							const MAX_RETRIES = 6; // å‡å°‘é‡è¯•æ¬¡æ•°
							if(AlertStore._rtRetry < MAX_RETRIES){
								AlertStore._rtRetry++;
								// æ›´å¹³ç¼“çš„é€€é¿ç®—æ³•ï¼š2ç§’èµ·æ­¥ï¼Œæœ€å¤š30ç§’
								const base = 2000; 
								const delay = Math.min(30000, Math.round(base * Math.pow(1.8, AlertStore._rtRetry-1) + Math.random()*1000));
								
								// å‡å°‘æ—¥å¿—é¢‘ç‡ï¼šåªåœ¨å‰3æ¬¡æˆ–æ¯5æ¬¡è¾“å‡ºä¸€æ¬¡
								if(AlertStore._rtRetry <= 3 || AlertStore._rtRetry % 5 === 0) {
									console.warn(`[PracticeAlerts][RT] çŠ¶æ€=${status} é‡è¿#${AlertStore._rtRetry} in ${Math.round(delay/1000)}s`);
								}
								
								if(!AlertStore._rtTimer){
									AlertStore._rtTimer = setTimeout(()=>{ 
										AlertStore._rtTimer=null; 
										setupRealtime(); 
									}, delay);
								}
							}else{
								console.error('[PracticeAlerts][RT] è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
								AlertStore._rtRetry = 0; // é‡ç½®è®¡æ•°å™¨ï¼Œå…è®¸åç»­æ‰‹åŠ¨é‡è¯•
							}
						}
					}); 
			}catch(e){ 
				AlertStore._rtConnecting=false;
				console.error('realtime alerts subscribe fail', e); 
			}
	}
	
	// æ‰‹åŠ¨é‡ç½®è¿æ¥çŠ¶æ€å¹¶é‡æ–°è¿æ¥
	function resetConnection() {
		console.log('[PracticeAlerts] æ‰‹åŠ¨é‡ç½®è¿æ¥');
		if(AlertStore._rtTimer) {
			clearTimeout(AlertStore._rtTimer);
			AlertStore._rtTimer = null;
		}
		AlertStore._rtRetry = 0;
		AlertStore._rtConnecting = false;
		AlertStore._lastSuccessConnect = null;
		
		if(AlertStore._rtChannel) {
			try{ supabaseClient.removeChannel(AlertStore._rtChannel); }catch(_e){}
			AlertStore._rtChannel = null;
		}
		
		// å»¶è¿Ÿé‡è¿ï¼Œé¿å…ç«‹å³é‡è¿
		setTimeout(() => setupRealtime(), 1000);
	}
		async function initAlerts(){ 
			console.log('[PracticeAlerts] initAlerts å¼€å§‹');
			await fetchExistingAlerts(); 
			await ensureSlotsLoaded(); 
			startTimer(); 
			setupRealtime(); 
			detectionTick(); 
				// ğŸ’¡ å‘¨æœŸå¯¹è´¦é¢‘ç‡ä¼˜åŒ– - ä»30ç§’å»¶é•¿åˆ°5åˆ†é’Ÿ
				if(!AlertStore._reconcileInterval){ 
					const RECONCILE_INTERVAL = 300000; // 5åˆ†é’Ÿé—´éš”
					logInfo(`å¿½ç•¥çŠ¶æ€åè°ƒå¯åŠ¨ï¼Œé—´éš”${RECONCILE_INTERVAL/60000}åˆ†é’Ÿ`);
					AlertStore._reconcileInterval = setInterval(()=>reconcileIgnored(), RECONCILE_INTERVAL); 
				}
				scheduleReconcile(3000);
			console.log('[PracticeAlerts] initAlerts å®Œæˆ');
		}
		async function refreshSlots(runDetect){ await forceReloadSlots(); if(runDetect) detectionTick(); }
		window.PracticeAlerts={ initAlerts, renderAlerts, detectionTick, ignoreAlert, ignoreAllAlerts, createAlert, refreshSlots, recalcToday, resetConnection, setFilter(f){ AlertStore.filter=f; renderAlerts(); } };
	document.addEventListener('DOMContentLoaded',()=>{ 
		console.log('[PracticeAlerts] DOMContentLoaded è§¦å‘');
		console.log('[PracticeAlerts] window.supabaseClient:', !!window.supabaseClient);
		
		// ç›´æ¥æ£€æŸ¥ supabaseClient è€Œä¸æ˜¯ supabaseReady
		if(window.supabaseClient) {
			console.log('[PracticeAlerts] supabaseClient å­˜åœ¨ï¼Œ1.2ç§’åå¯åŠ¨');
			setTimeout(()=>initAlerts(), 1200); 
		} else { 
			console.log('[PracticeAlerts] supabaseClient ä¸å­˜åœ¨ï¼Œç­‰å¾…ä¸­...');
			const tick=setInterval(()=>{ 
				console.log('[PracticeAlerts] æ£€æŸ¥ supabaseClient:', !!window.supabaseClient);
				if(window.supabaseClient){ 
					console.log('[PracticeAlerts] supabaseClient å·²å°±ç»ªï¼Œå¯åŠ¨ä¸­...');
					clearInterval(tick); 
					initAlerts(); 
				} 
			}, 2000); // ğŸ’¡ å»¶é•¿åˆ°2ç§’é—´éš”ï¼Œå‡å°‘åˆå§‹åŒ–æ£€æŸ¥é¢‘ç‡ 
		} 
		document.addEventListener('click',e=>{ 
			const t=e.target; 
			if(t.classList && t.classList.contains('alert-filter-btn')){ 
				PracticeAlerts.setFilter(t.dataset.filter); 
			} else if(t.id === 'ignoreAllBtn') {
				// ä¸€é”®å¿½ç•¥åŠŸèƒ½
				const sorted=[...AlertStore.list].sort((a,b)=>{
					function slotKey(x){
						if(x.slot){
							const et=x.slot.end_time||x.slot.start_time; 
							return timeStrToMinutes(et);
						}
						return (x.created_at? new Date(x.created_at).getTime()/60000 : -1);
					}
					const ka=slotKey(a); const kb=slotKey(b);
					if(kb!==ka) return kb-ka;
					return (b.id||0)-(a.id||0);
				});
				const filtered=applyFilter(sorted);
				
				if(filtered.length === 0) {
					alert('å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å¯å¿½ç•¥çš„æé†’');
					return;
				}
				
				if(confirm(`ç¡®å®šè¦å¿½ç•¥å½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„æ‰€æœ‰ ${filtered.length} æ¡æé†’å—ï¼Ÿ`)) {
					t.disabled = true;
					t.textContent = 'å¿½ç•¥ä¸­...';
					PracticeAlerts.ignoreAllAlerts().then(() => {
						t.disabled = false;
						t.textContent = 'ä¸€é”®å¿½ç•¥';
					}).catch(error => {
						console.error('ä¸€é”®å¿½ç•¥å¤±è´¥:', error);
						t.disabled = false;
						t.textContent = 'ä¸€é”®å¿½ç•¥';
						alert('ä¸€é”®å¿½ç•¥æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
					});
				}
			}
		}); 
	});
})();
</script>

<script>
// ç´æˆ¿çŠ¶æ€åŒæ­¥å¢å¼ºåŠŸèƒ½
(function() {
	// æ‰‹åŠ¨åŒæ­¥æˆ¿é—´çŠ¶æ€åŠŸèƒ½
	window.manualSyncRoomStates = async function() {
		if (!window.supabaseClient) {
			console.warn('Supabase æœªè¿æ¥');
			return;
		}
		
		try {
			const rooms = window.Store?.rooms || [];
			console.log(`å¼€å§‹æ‰‹åŠ¨åŒæ­¥ ${rooms.length} ä¸ªæˆ¿é—´çŠ¶æ€`);
			
			for (const room of rooms) {
				if (room.name) {
					await reconcileRoomState(room.name);
					await new Promise(resolve => setTimeout(resolve, 50));
				}
			}
			
			if (window.toast) window.toast('âœ… æˆ¿é—´çŠ¶æ€åŒæ­¥å®Œæˆ', 'success');
			console.log('æ‰‹åŠ¨æˆ¿é—´çŠ¶æ€åŒæ­¥å®Œæˆ');
		} catch (error) {
			console.error('æˆ¿é—´çŠ¶æ€åŒæ­¥å¤±è´¥:', error);
			if (window.toast) window.toast('âŒ æˆ¿é—´çŠ¶æ€åŒæ­¥å¤±è´¥', 'error');
		}
	};
	
	// æ‰‹åŠ¨åŒæ­¥æ‰€æœ‰æ•°æ®ï¼ˆæˆ¿é—´+å­¦ç”Ÿï¼‰
	window.manualSyncAllData = async function() {
		if (!window.supabaseClient) {
			console.warn('Supabase æœªè¿æ¥');
			if (window.toast) window.toast('âŒ Supabase æœªè¿æ¥', 'error');
			return;
		}
		
		try {
			console.log('å¼€å§‹åŒæ­¥æ‰€æœ‰æ•°æ®...');
			if (window.toast) window.toast('ğŸ”„ å¼€å§‹åŒæ­¥æ‰€æœ‰æ•°æ®...', 'info');
			
			// åŒæ­¥æˆ¿é—´çŠ¶æ€
			await window.manualSyncRoomStates();
			
			// åŒæ­¥å­¦ç”Ÿæ•°æ®
			if (window.manualSyncStudentData) {
				await window.manualSyncStudentData();
			}
			
			console.log('æ‰€æœ‰æ•°æ®åŒæ­¥å®Œæˆ');
			if (window.toast) window.toast('âœ… æ‰€æœ‰æ•°æ®åŒæ­¥å®Œæˆ', 'success');
		} catch (error) {
			console.error('æ•°æ®åŒæ­¥å¤±è´¥:', error);
			if (window.toast) window.toast('âŒ æ•°æ®åŒæ­¥å¤±è´¥', 'error');
		}
	};
	
	// çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥å’Œä¿®å¤
	async function reconcileRoomState(roomName) {
		if (!window.supabaseClient || !window.Store) return;
		
		try {
			const { data: cloudRoom, error } = await window.supabaseClient
				.from('rooms')
				.select('*')
				.eq('name', roomName)
				.single();
				
			if (error) {
				console.warn(`è·å–æˆ¿é—´ ${roomName} äº‘ç«¯çŠ¶æ€å¤±è´¥:`, error.message);
				return;
			}
			
			const localRoom = window.Store.rooms.find(r => r.name === roomName);
			if (!localRoom) return;
			
			const cloudVersion = cloudRoom?.version || 0;
			const localVersion = localRoom.version || 0;
			
			// å¦‚æœäº‘ç«¯ç‰ˆæœ¬æ›´æ–°ï¼ŒåŒæ­¥åˆ°æœ¬åœ°
			if (cloudVersion > localVersion) {
				console.log(`åŒæ­¥æˆ¿é—´ ${roomName} çŠ¶æ€: v${localVersion} -> v${cloudVersion}`);
				localRoom.occupant_student_name = cloudRoom.occupant_student_name;
				localRoom.registerTime = cloudRoom.register_time ? new Date(cloudRoom.register_time).getTime() : null;
				localRoom.version = cloudVersion;
				localRoom.heartbeatAt = cloudRoom.heartbeat_at;
				
				// é‡æ–°æ¸²æŸ“æˆ¿é—´å¡ç‰‡
				if (window.renderRoomCard) window.renderRoomCard(roomName);
				if (window.updateUsageStats) window.updateUsageStats();
				
				const action = cloudRoom.occupant_student_name ? 'å ç”¨' : 'é‡Šæ”¾';
				if (window.toast) window.toast(`ğŸ”„ ${roomName} çŠ¶æ€å·²åŒæ­¥: ${action}`, 'info');
			}
		} catch (e) {
			console.warn(`æˆ¿é—´çŠ¶æ€åŒæ­¥å¼‚å¸¸ ${roomName}:`, e.message);
		}
	}
})();

// å…¨å±€æŒ‰é’®ç»‘å®šå‡½æ•°
function bind(id, handler){
	const el = document.getElementById(id);
	if(el){ 
		el.onclick = handler; 
		console.log(`[BIND] æˆåŠŸç»‘å®šæŒ‰é’®: ${id}`);
	}
	else { 
		console.warn('[WARN] æŒ‰é’®ç¼ºå¤±:', id); 
	}
}

// ä¸»è¦æŒ‰é’®ç»‘å®šåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
	
	// ç»‘å®šæ‰€æœ‰æŒ‰é’®
	bind('btnSyncToCloud', window.manualSyncToCloud);
	bind('btnEditRooms', window.toggleEditMode);
	
	console.log('[INIT] æŒ‰é’®ç»‘å®šå®Œæˆ');
	
	// ğŸ”§ é¡µé¢å®Œå…¨åŠ è½½åè¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆä»…åœ¨ç‰¹å®šæ¡ä»¶ä¸‹ï¼‰
	setTimeout(async () => {
		// åªæœ‰åœ¨æ£€æµ‹åˆ°å¯èƒ½çš„é—®é¢˜æ—¶æ‰æ‰§è¡ŒéªŒè¯
		const shouldValidate = 
			// æœ‰ç¼“å­˜æ®‹ç•™æ—¶
			localStorage.getItem('yms_timer_states') ||
			// é¡µé¢è®¿é—®æ—¶é—´é—´éš”è¾ƒé•¿æ—¶ï¼ˆè¶…è¿‡30åˆ†é’Ÿï¼‰
			(!window.__lastPageLoad || (Date.now() - window.__lastPageLoad) > 30 * 60 * 1000) ||
			// å¼ºåˆ¶éªŒè¯æ ‡è®°å­˜åœ¨æ—¶
			sessionStorage.getItem('force_consistency_check');
		
		if (shouldValidate && window.supabaseReady && window.DataConsistencyValidator) {
			try {
				logInfo('[INIT] æ‰§è¡Œé¡µé¢åŠ è½½å®Œæˆåçš„æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥');
				const validation = await window.DataConsistencyValidator.validateOnPageLoad();
				if (validation.issues > 0) {
					logWarn(`[INIT] é¡µé¢åˆå§‹åŒ–å‘ç° ${validation.issues} ä¸ªæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå·²ä¿®å¤`);
					toast(`é¡µé¢åˆå§‹åŒ–ä¿®å¤äº† ${validation.issues} ä¸ªæ•°æ®é—®é¢˜`, 'info');
				} else {
					logInfo('[INIT] é¡µé¢åˆå§‹åŒ–æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡');
				}
				// æ¸…é™¤å¼ºåˆ¶éªŒè¯æ ‡è®°
				sessionStorage.removeItem('force_consistency_check');
			} catch (error) {
				logErr('[INIT] é¡µé¢åˆå§‹åŒ–æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥:', error.message);
			}
		}
		
		// è®°å½•é¡µé¢åŠ è½½æ—¶é—´
		window.__lastPageLoad = Date.now();
	}, 10000); // é¡µé¢åŠ è½½10ç§’åæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰åˆå§‹åŒ–å®Œæˆ
	
	// åˆå§‹åŒ–è¿æ¥ç®¡ç†å™¨
	if (window.RealtimeConnectionManager) {
		// ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
		window.addEventListener('online', () => {
			console.log('[è¿æ¥ç®¡ç†] ç½‘ç»œå·²ä¸Šçº¿');
			RealtimeConnectionManager.checkNetworkStatus();
		});
		
		window.addEventListener('offline', () => {
			console.log('[è¿æ¥ç®¡ç†] ç½‘ç»œå·²ç¦»çº¿');
			RealtimeConnectionManager.checkNetworkStatus();
		});
		
		// é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬ï¼ˆç”¨æˆ·åˆ‡æ¢æ ‡ç­¾é¡µï¼‰
		document.addEventListener('visibilitychange', () => {
			if (!document.hidden) {
				// é¡µé¢é‡æ–°å¯è§æ—¶æ£€æŸ¥è¿æ¥çŠ¶æ€
				setTimeout(() => {
					if (window.RealtimeConnectionManager) {
						const status = RealtimeConnectionManager.getConnectionStatus();
						const hasActiveTimers = status.rooms.hasTimer || status.students.hasTimer;
						if (hasActiveTimers) {
							console.log('[è¿æ¥ç®¡ç†] é¡µé¢é‡æ–°æ¿€æ´»ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€');
							RealtimeConnectionManager.checkNetworkStatus();
						}
					}
				}, 1000);
			}
		});
		
		// å®šæœŸå¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤
		setInterval(() => {
			if (window.RealtimeConnectionManager) {
				RealtimeConnectionManager.checkNetworkStatus();
				
				const quality = RealtimeConnectionManager.assessConnectionQuality();
				const status = RealtimeConnectionManager.getConnectionStatus();
				
				// è‡ªåŠ¨ä¿®å¤é€»è¾‘
				if (quality === 'poor') {
					console.warn('[è¿æ¥ç®¡ç†] è¿æ¥è´¨é‡å·®ï¼Œè§¦å‘è‡ªåŠ¨ä¿®å¤');
					
					// æ£€æŸ¥æ˜¯å¦æœ‰è¿æ¥å¡åœ¨é‡è¿çŠ¶æ€è¶…è¿‡5åˆ†é’Ÿ
					const fiveMinutesAgo = Date.now() - 5 * 60 * 1000;
					const roomsStuck = status.rooms.hasTimer && status.rooms.attempts > 8;
					const studentsStuck = status.students.hasTimer && status.students.attempts > 8;
					const practiceStuck = status.practiceAlerts.hasTimer && status.practiceAlerts.attempts > 8;
					
					if (roomsStuck || studentsStuck || practiceStuck) {
						console.log('[è¿æ¥ç®¡ç†] æ£€æµ‹åˆ°è¿æ¥å¡æ­»ï¼Œæ‰§è¡Œå¼ºåˆ¶é‡ç½®');
						RealtimeConnectionManager.resetAllConnections(true);
					}
				}
				
				// æ¯10åˆ†é’Ÿè¾“å‡ºä¸€æ¬¡çŠ¶æ€æ‘˜è¦ï¼ˆä»…åœ¨æœ‰é—®é¢˜æ—¶ï¼‰
				if (Date.now() % (10 * 60 * 1000) < 60000) {
					const totalAttempts = status.rooms.attempts + status.students.attempts + status.practiceAlerts.attempts;
					if (totalAttempts > 0) {
						console.log('[è¿æ¥ç®¡ç†] çŠ¶æ€æ‘˜è¦ - æ€»é‡è¯•æ¬¡æ•°:', totalAttempts, 'ç½‘ç»œè´¨é‡:', quality);
					}
				}
			}
		}, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
	}
});

// å¢å¼ºçš„å®æ—¶è¿æ¥ç®¡ç†å™¨
window.RealtimeConnectionManager = {
	// è¿æ¥å¥åº·ç›‘æ§
	_healthCheck: {
		lastCheck: 0,
		checkInterval: 30000, // 30ç§’æ£€æŸ¥ä¸€æ¬¡
		consecutiveFailures: 0,
		maxFailures: 3,
		networkOffline: false
	},
	
	// æ£€æµ‹ç½‘ç»œçŠ¶æ€
	checkNetworkStatus: function() {
		const isOnline = navigator.onLine;
		if (!isOnline && !this._healthCheck.networkOffline) {
			console.log('[è¿æ¥ç®¡ç†] ç½‘ç»œå·²æ–­å¼€ï¼Œæš‚åœé‡è¿');
			this._healthCheck.networkOffline = true;
			this.pauseAllReconnections();
		} else if (isOnline && this._healthCheck.networkOffline) {
			console.log('[è¿æ¥ç®¡ç†] ç½‘ç»œå·²æ¢å¤ï¼Œé‡ç½®è¿æ¥çŠ¶æ€');
			this._healthCheck.networkOffline = false;
			this._healthCheck.consecutiveFailures = 0;
			// å»¶è¿Ÿé‡è¿ï¼Œé¿å…ç½‘ç»œåˆšæ¢å¤æ—¶ç«‹å³é‡è¿
			setTimeout(() => this.resetAllConnections(true), 2000);
		}
		return isOnline;
	},
	
	// è¿æ¥è´¨é‡è¯„ä¼°
	assessConnectionQuality: function() {
		const now = Date.now();
		const roomAttempts = window.__roomsRealtimeAttempts || 0;
		const studentAttempts = window.__studentsRealtimeAttempts || 0;
		const practiceAttempts = window.PracticeAlerts?._rtRetry || 0;
		
		// å¦‚æœæ‰€æœ‰æ¨¡å—éƒ½åœ¨é¢‘ç¹é‡è¿ï¼Œè¯´æ˜ç½‘ç»œè´¨é‡å·®
		const totalAttempts = roomAttempts + studentAttempts + practiceAttempts;
		if (totalAttempts > 10) {
			console.warn('[è¿æ¥ç®¡ç†] æ£€æµ‹åˆ°è¿æ¥è´¨é‡å·®ï¼Œè°ƒæ•´é‡è¿ç­–ç•¥');
			return 'poor';
		} else if (totalAttempts > 5) {
			return 'moderate';
		}
		return 'good';
	},
	
	// æš‚åœæ‰€æœ‰é‡è¿
	pauseAllReconnections: function() {
		console.log('[è¿æ¥ç®¡ç†] æš‚åœæ‰€æœ‰è‡ªåŠ¨é‡è¿');
		
		if(window.__roomsRealtimeReconnectTimer) {
			clearTimeout(window.__roomsRealtimeReconnectTimer);
			window.__roomsRealtimeReconnectTimer = null;
		}
		
		if(window.__studentsRealtimeReconnectTimer) {
			clearTimeout(window.__studentsRealtimeReconnectTimer);
			window.__studentsRealtimeReconnectTimer = null;
		}
		
		if(window.PracticeAlerts && window.PracticeAlerts._rtTimer) {
			clearTimeout(window.PracticeAlerts._rtTimer);
			window.PracticeAlerts._rtTimer = null;
		}
	},
	
	resetAllConnections: function(force = false) {
		console.log('[è¿æ¥ç®¡ç†] é‡ç½®æ‰€æœ‰å®æ—¶è¿æ¥çŠ¶æ€' + (force ? ' (å¼ºåˆ¶)' : ''));
		
		// æ£€æŸ¥ç½‘ç»œçŠ¶æ€
		if (!force && !this.checkNetworkStatus()) {
			console.log('[è¿æ¥ç®¡ç†] ç½‘ç»œç¦»çº¿ï¼Œè·³è¿‡é‡ç½®');
			return;
		}
		
		// è¯„ä¼°è¿æ¥è´¨é‡
		const quality = this.assessConnectionQuality();
		if (quality === 'poor' && !force) {
			console.log('[è¿æ¥ç®¡ç†] è¿æ¥è´¨é‡å·®ï¼Œå»¶è¿Ÿé‡ç½®');
			setTimeout(() => this.resetAllConnections(true), 10000);
			return;
		}
		
		// é‡ç½® rooms è¿æ¥çŠ¶æ€
		if(window.__roomsRealtimeReconnectTimer) {
			clearTimeout(window.__roomsRealtimeReconnectTimer);
			window.__roomsRealtimeReconnectTimer = null;
		}
		window.__roomsRealtimeAttempts = 0;
		window.__roomsRealtimeReconnecting = false;
		window.__roomsInitialConnected = false;
		
		// é‡ç½® students è¿æ¥çŠ¶æ€
		if(window.__studentsRealtimeReconnectTimer) {
			clearTimeout(window.__studentsRealtimeReconnectTimer);
			window.__studentsRealtimeReconnectTimer = null;
		}
		window.__studentsRealtimeAttempts = 0;
		window.__studentsInitialConnected = false;
		
		// é‡ç½® PracticeAlerts è¿æ¥çŠ¶æ€
		if(window.PracticeAlerts && window.PracticeAlerts.resetConnection) {
			window.PracticeAlerts.resetConnection();
		}
		
		// é‡ç½®å¥åº·æ£€æŸ¥çŠ¶æ€
		this._healthCheck.consecutiveFailures = 0;
		this._healthCheck.lastCheck = Date.now();
		
		console.log('[è¿æ¥ç®¡ç†] é‡ç½®å®Œæˆ');
	},
	
	getConnectionStatus: function() {
		const now = Date.now();
		return {
			network: {
				online: navigator.onLine,
				offline: this._healthCheck.networkOffline,
				quality: this.assessConnectionQuality(),
				lastCheck: new Date(this._healthCheck.lastCheck).toLocaleTimeString(),
				consecutiveFailures: this._healthCheck.consecutiveFailures
			},
			rooms: {
				attempts: window.__roomsRealtimeAttempts || 0,
				reconnecting: window.__roomsRealtimeReconnecting || false,
				initialConnected: window.__roomsInitialConnected || false,
				hasTimer: !!window.__roomsRealtimeReconnectTimer,
				lastClosedTime: window.__lastClosedTime ? new Date(window.__lastClosedTime).toLocaleTimeString() : 'N/A'
			},
			students: {
				attempts: window.__studentsRealtimeAttempts || 0,
				initialConnected: window.__studentsInitialConnected || false,
				hasTimer: !!window.__studentsRealtimeReconnectTimer,
				lastClosedTime: window.__lastStudentClosedTime ? new Date(window.__lastStudentClosedTime).toLocaleTimeString() : 'N/A'
			},
			practiceAlerts: {
				available: !!(window.PracticeAlerts && window.PracticeAlerts.resetConnection),
				attempts: window.PracticeAlerts?._rtRetry || 0,
				connecting: window.PracticeAlerts?._rtConnecting || false,
				hasTimer: window.PracticeAlerts?._rtTimer ? true : false
			},
			supabase: {
				ready: window.supabaseReady || false,
				client: !!window.supabaseClient
			}
		};
	},
	
	// æ˜¾ç¤ºè¯¦ç»†çš„è¿æ¥è¯Šæ–­ä¿¡æ¯
	diagnose: function() {
		const status = this.getConnectionStatus();
		console.group('ğŸ” å®æ—¶è¿æ¥è¯Šæ–­æŠ¥å‘Š');
		console.log('ğŸ“Š ç½‘ç»œçŠ¶æ€:', status.network);
		console.log('ğŸ  æˆ¿é—´è¿æ¥:', status.rooms);
		console.log('ğŸ‘¥ å­¦ç”Ÿè¿æ¥:', status.students);
		console.log('âš ï¸  ç»ƒä¹ æé†’:', status.practiceAlerts);
		console.log('â˜ï¸  Supabase:', status.supabase);
		
		// é—®é¢˜è¯Šæ–­
		const issues = [];
		if (!status.network.online) issues.push('ç½‘ç»œç¦»çº¿');
		if (status.network.quality === 'poor') issues.push('ç½‘ç»œè´¨é‡å·®');
		if (status.rooms.attempts > 5) issues.push('æˆ¿é—´è¿æ¥é¢‘ç¹é‡è¯•');
		if (status.students.attempts > 5) issues.push('å­¦ç”Ÿè¿æ¥é¢‘ç¹é‡è¯•');
		if (status.practiceAlerts.attempts > 5) issues.push('ç»ƒä¹ æé†’è¿æ¥é¢‘ç¹é‡è¯•');
		if (!status.supabase.ready) issues.push('Supabaseæœªå°±ç»ª');
		
		if (issues.length > 0) {
			console.warn('âš ï¸  å‘ç°çš„é—®é¢˜:', issues);
		} else {
			console.log('âœ… æœªå‘ç°æ˜æ˜¾é—®é¢˜');
		}
		
		console.groupEnd();
		return { status, issues };
	}
};
</script>

<!-- ==== æˆ¿é—´è½¬ç§»å‰ç«¯å¢å¼ºè„šæœ¬ï¼ˆæ— åç«¯å˜æ›´ç‰ˆï¼‰ ==== -->
<script>
// ç®€æ˜“ UUID ç”Ÿæˆï¼ˆé¿å…é¢å¤–ä¾èµ–ï¼‰
function genUUID(){return crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);});}

// ä¼ è¾“é˜¶æ®µæšä¸¾
const TransferPhase={Idle:'idle',Validating:'validating',OccupyingTarget:'occupying_target',ReleasingSource:'releasing_source',Retrying:'retrying',Done:'done',Failed:'failed'};

// ç»“æ„åŒ–æ—¥å¿—
function xlog(level,ctx,msg,extra){const payload={ts:new Date().toISOString(),level,transfer_id:ctx?.id,phase:ctx?.phase,source:ctx?.source,target:ctx?.target,student:ctx?.student,attemptTarget:ctx?.attemptTarget,attemptSource:ctx?.attemptSource,msg,...extra};(level==='error'?console.error:level==='warn'?console.warn:console.log)(payload);} 
const xLogInfo=(c,m,e)=>xlog('info',c,m,e);const xLogWarn=(c,m,e)=>xlog('warn',c,m,e);const xLogErr=(c,m,e)=>xlog('error',c,m,e);

// é€€é¿
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
function calcBackoff(attempt,base=80,max=1500){const raw=base*Math.pow(2,attempt-1);const jitter=raw*(Math.random()*0.4-0.2);return Math.min(max,Math.round(raw+jitter));}

// Supabase å®¢æˆ·ç«¯å¼•ç”¨
function sb(){if(!window.supabaseClient){console.warn('[transfer] supabaseClient ä¸å­˜åœ¨');}return window.supabaseClient;}

async function getRooms(names){const client=sb();if(!client) throw new Error('supabaseClient missing'); const {data,error}=await client.from('rooms').select('name,version,occupant_student_name,register_time').in('name',names); if(error) throw error; const map={}; (data||[]).forEach(r=>map[r.name]=r); return map;}

async function patchRoomConditional(roomName,expectedVersion,expectedOccupant,changes){const client=sb(); if(!client) return false; let q=client.from('rooms').update(changes).eq('name',roomName); if(expectedVersion!=null){q=q.eq('version',expectedVersion);} if(expectedOccupant===null){q=q.is('occupant_student_name',null);} else if(expectedOccupant!==undefined){q=q.eq('occupant_student_name',expectedOccupant);} const {data,error}=await q.select('name'); if(error){xLogErr({},'patch_error',{roomName,error}); return false;} return (data?.length||0)===1;}

// DOM æ›´æ–°ï¼ˆæœ€å°‘ä¾µå…¥ï¼‰: æŒ‰ data-room-name é€‰æ‹©å™¨æ›´æ–°å ç”¨çŠ¶æ€
function updateRoomDom(name,occupant){const card=document.querySelector(`[data-room-name="${name}"]`); if(!card) return; const prev=card.getAttribute('data-status'); if(occupant){card.setAttribute('data-status','occupied');} else {card.setAttribute('data-status','empty');} // occupant æ–‡æœ¬
	let occEl=card.querySelector('.room-occupant-line');
	if(!occEl){occEl=document.createElement('div'); occEl.className='room-occupant-line'; occEl.style.cssText='font-size:12px;opacity:.85;min-height:16px;'; card.appendChild(occEl);} 
	occEl.textContent=occupant?('å ç”¨: '+occupant):'ç©ºé—²';
	if(prev!==card.getAttribute('data-status')){card.classList.add('flash-status'); setTimeout(()=>card&&card.classList&&card.classList.remove('flash-status'),900);}
}

// è‡ªæ„ˆé˜Ÿåˆ—
const healQueue=[]; 
function scheduleHeal(task){task.createdAt=Date.now(); task.attempts=0; healQueue.push(task);} 
// heal: 2s é—´éš”ï¼Œæœ€å¤š 5 æ¬¡ï¼Œæ”¾å®½ä¸ºä»… occupant æ¡ä»¶
// æ”¯æŒå¤šäººç™»è®°ï¼šä»æºæˆ¿é—´ç§»é™¤å­¦ç”Ÿæ—¶ï¼Œå¦‚æœæœ‰å¤šä¸ªå­¦ç”Ÿï¼Œåªç§»é™¤ç›®æ ‡å­¦ç”Ÿ
setInterval(async()=>{if(!healQueue.length) return; const task=healQueue.shift(); try{task.attempts++; const rooms=await getRooms([task.source,task.target]); const s=rooms[task.source]; const t=rooms[task.target]; if(!s||!t) return; 
	// æ£€æŸ¥æºæˆ¿é—´å’Œç›®æ ‡æˆ¿é—´æ˜¯å¦éƒ½åŒ…å«è¯¥å­¦ç”Ÿ
	const sourceStudents = s.occupant_student_name ? s.occupant_student_name.split(',').map(st => st.trim()) : [];
	const targetStudents = t.occupant_student_name ? t.occupant_student_name.split(',').map(st => st.trim()) : [];
	
	if(sourceStudents.includes(task.student) && targetStudents.includes(task.student)){ 
		// ä»æºæˆ¿é—´ç§»é™¤è¯¥å­¦ç”Ÿ
		const remainingStudents = sourceStudents.filter(st => st !== task.student);
		const newOccupant = remainingStudents.length > 0 ? remainingStudents.join(',') : null;
		const ok=await patchRoomConditional(task.source,null,s.occupant_student_name,{occupant_student_name:newOccupant,version:(s.version||0)+1}); 
		if(ok){
			// æ›´æ–°Storeä¸­çš„æºæˆ¿é—´æ•°æ®
			if(window.Store && window.Store.rooms){
				const sourceRoom = window.Store.rooms.find(r => r.name === task.source);
				if(sourceRoom){
					sourceRoom.occupant_student_name = newOccupant;
					sourceRoom.version = (s.version || 0) + 1;
					if(!newOccupant){
						sourceRoom.registerTime = null;
					}
				}
			}
			// é‡æ–°æ¸²æŸ“æºæˆ¿é—´å¡ç‰‡
			if(typeof window.renderRoomCard === 'function'){
				window.renderRoomCard(task.source);
			} else if(typeof window.renderRoomCardForced === 'function'){
				window.renderRoomCardForced(task.source);
			} else {
				updateRoomDom(task.source,newOccupant);
			}
			xLogInfo(task,'heal_release_source');
		} else if(task.attempts<5){healQueue.push(task);} 
	} }catch(e){ if(task.attempts<5) healQueue.push(task); } },2000);

// å…¨å±€åŒå æ‰«æï¼ˆ15sï¼‰
// æ”¯æŒå¤šäººç™»è®°ï¼šå°†occupant_student_nameæŒ‰é€—å·åˆ†éš”ï¼Œæ£€æŸ¥æ¯ä¸ªå­¦ç”Ÿæ˜¯å¦è¢«å¤šä¸ªæˆ¿é—´å ç”¨
setInterval(()=>{try{ if(!window.Store||!Array.isArray(Store.rooms)) return; const byStu={}; const dups=[]; 
	for(const r of Store.rooms){
		if(!r.occupant_student_name) continue;
		// åˆ†éš”å¤šä¸ªå­¦ç”Ÿ
		const students = r.occupant_student_name.split(',').map(s => s.trim());
		for(const stu of students){
			(byStu[stu]=byStu[stu]||[]).push(r);
		}
	}
	Object.keys(byStu).forEach(stu=>{if(byStu[stu].length>1) dups.push(stu);}); 
	if(!dups.length) return; 
	dups.forEach(stu=>{const arr=byStu[stu]; arr.sort((a,b)=> (b.register_time||'').localeCompare(a.register_time||'')); for(let i=1;i<arr.length;i++){ scheduleHeal({source:arr[i].name,target:arr[0].name,student:stu}); } xLogWarn({},'detected_duplicate_occupancy',{student:stu,rooms:arr.map(x=>x.name)});}); }catch(e){console.error('duplicate scan error',e);}},15000);

// ä¸»è½¬ç§»å‡½æ•°ï¼šå…ˆå ç›®æ ‡å†é‡Šæ”¾æº
// æ”¯æŒå¤šäººç™»è®°ï¼šæ£€æŸ¥æºæˆ¿é—´æ˜¯å¦åŒ…å«è¯¥å­¦ç”Ÿï¼ˆé€—å·åˆ†éš”ï¼‰
async function transferStudent(source,target,student,opts){const ctx={id:genUUID(),source,target,student,phase:TransferPhase.Validating,attemptTarget:0,attemptSource:0,startedAt:Date.now()}; xLogInfo(ctx,'start'); const maxT=(opts&&opts.maxTargetAttempts)||5; const maxS=(opts&&opts.maxSourceAttempts)||3; 
	let rooms=await getRooms([source,target]); const src=rooms[source]; let tgt=rooms[target]; if(!src) return fail('source_not_found'); if(!tgt) return fail('target_not_found'); 
	// æ£€æŸ¥æºæˆ¿é—´æ˜¯å¦åŒ…å«è¯¥å­¦ç”Ÿ
	const sourceStudents = src.occupant_student_name ? src.occupant_student_name.split(',').map(s => s.trim()) : [];
	if(!sourceStudents.includes(student)) return fail('source_not_held_by_student'); 
	if(tgt.occupant_student_name!==null) return fail('target_not_empty');
	
	// è®°å½•åŸå§‹ç™»è®°æ—¶é—´ï¼ˆç”¨äºpractice_logsçš„å‡†ç¡®è®¡æ—¶ï¼‰
	const originalStartTime = src.register_time ? new Date(src.register_time).getTime() : Date.now();
	
	ctx.phase=TransferPhase.OccupyingTarget; for(let i=1;i<=maxT;i++){ctx.attemptTarget=i; const ok=await patchRoomConditional(target,tgt.version,null,{occupant_student_name:student,register_time:new Date().toISOString(),version:tgt.version+1}); if(ok){
		// æ›´æ–°Storeä¸­çš„ç›®æ ‡æˆ¿é—´æ•°æ®
		if(window.Store && window.Store.rooms){
			const targetRoom = window.Store.rooms.find(r => r.name === target);
			if(targetRoom){
				targetRoom.occupant_student_name = student;
				targetRoom.registerTime = Date.now();
				targetRoom.version = tgt.version + 1;
			}
		}
		// é‡æ–°æ¸²æŸ“ç›®æ ‡æˆ¿é—´å¡ç‰‡
		if(typeof window.renderRoomCard === 'function'){
			window.renderRoomCard(target);
		} else if(typeof window.renderRoomCardForced === 'function'){
			window.renderRoomCardForced(target);
		} else {
			updateRoomDom(target,student);
		}
		xLogInfo(ctx,'occupy_target_success',{versionBefore:tgt.version}); break;} else {xLogWarn(ctx,'occupy_target_conflict'); tgt=(await getRooms([target]))[target]; if(!tgt || (tgt.occupant_student_name && tgt.occupant_student_name!==student)){return fail('target_taken_by_others');} if(i===maxT) return fail('target_conflict_exhausted'); ctx.phase=TransferPhase.Retrying; await sleep(calcBackoff(i)); ctx.phase=TransferPhase.OccupyingTarget;}}
	
	// ç›®æ ‡å ç”¨æˆåŠŸåï¼Œå†™å…¥practice_logsï¼šå…ˆå†™æ—§æˆ¿é—´çš„endè®°å½•ï¼Œå†å†™æ–°æˆ¿é—´çš„startè®°å½•
	try {
		// 1. å…ˆå†™å…¥æ—§æˆ¿é—´çš„ç»“æŸè®°å½•ï¼ˆclearï¼‰
		if (typeof writePracticeLog === 'function') {
			await writePracticeLog(source, student, 'clear', { startMs: originalStartTime });
			xLogInfo(ctx, 'wrote_source_clear_log', { originalStartTime });
		}
		
		// 2. å†å†™å…¥æ–°æˆ¿é—´çš„å¼€å§‹è®°å½•ï¼ˆassignï¼‰
		if (typeof writePracticeLog === 'function') {
			await writePracticeLog(target, student, 'assign');
			xLogInfo(ctx, 'wrote_target_assign_log');
		}
	} catch (logError) {
		xLogWarn(ctx, 'practice_log_error', { error: logError.message });
		// æ—¥å¿—å†™å…¥å¤±è´¥ä¸å½±å“è½¬ç§»ç»§ç»­è¿›è¡Œ
	}
	
	ctx.phase=TransferPhase.ReleasingSource; let srcDyn=src; srcDyn.__pendingRelease=true; for(let j=1;j<=maxS;j++){ctx.attemptSource=j; srcDyn=(await getRooms([source]))[source]; if(!srcDyn) return fail('source_missing'); 
		// æ”¯æŒå¤šäººç™»è®°ï¼šä»æºæˆ¿é—´ç§»é™¤è¯¥å­¦ç”Ÿï¼Œå¦‚æœè¿˜æœ‰å…¶ä»–å­¦ç”Ÿåˆ™ä¿ç•™å…¶ä»–å­¦ç”Ÿ
		const currentSourceStudents = srcDyn.occupant_student_name ? srcDyn.occupant_student_name.split(',').map(s => s.trim()) : [];
		const remainingStudents = currentSourceStudents.filter(s => s !== student);
		const newSourceOccupant = remainingStudents.length > 0 ? remainingStudents.join(',') : null;
		const ok=await patchRoomConditional(source,null,srcDyn.occupant_student_name,{occupant_student_name:newSourceOccupant,version:(srcDyn.version||0)+1}); 
		if(ok){
			// æ›´æ–°Storeä¸­çš„æºæˆ¿é—´æ•°æ®
			if(window.Store && window.Store.rooms){
				const sourceRoom = window.Store.rooms.find(r => r.name === source);
				if(sourceRoom){
					sourceRoom.occupant_student_name = newSourceOccupant;
					sourceRoom.version = (srcDyn.version || 0) + 1;
					// å¦‚æœæˆ¿é—´æ¸…ç©ºäº†ï¼Œä¹Ÿæ¸…é™¤registerTime
					if(!newSourceOccupant){
						sourceRoom.registerTime = null;
					}
				}
			}
			// é‡æ–°æ¸²æŸ“æºæˆ¿é—´å¡ç‰‡
			if(typeof window.renderRoomCard === 'function'){
				window.renderRoomCard(source);
			} else if(typeof window.renderRoomCardForced === 'function'){
				window.renderRoomCardForced(source);
			} else {
				updateRoomDom(source,newSourceOccupant);
			}
			ctx.phase=TransferPhase.Done; xLogInfo(ctx,'enhanced_transfer_done'); toast('è½¬ç§»æˆåŠŸ'); return {success:true};
		} 
		xLogWarn(ctx,'release_source_retry'); 
		// æ£€æŸ¥æºæˆ¿é—´æ˜¯å¦ä»åŒ…å«è¯¥å­¦ç”Ÿ
		const checkStudents = srcDyn.occupant_student_name ? srcDyn.occupant_student_name.split(',').map(s => s.trim()) : [];
		if(!checkStudents.includes(student)){xLogErr(ctx,'source_taken_during_release'); ctx.phase=TransferPhase.Done; toast('ç›®æ ‡å·²è½¬ç§»ï¼Œæºå·²è¢«ä»–äººå '); return {success:true,error:'source_taken_during_release'};} 
		if(j===maxS){scheduleHeal({transferId:ctx.id,source,target,student}); return fail('release_source_exhausted');} 
		ctx.phase=TransferPhase.Retrying; await sleep(calcBackoff(j)); ctx.phase=TransferPhase.ReleasingSource; }
	return fail('unexpected');
	function fail(code){ctx.phase=TransferPhase.Failed; xLogErr(ctx,code); toast('è½¬ç§»å¤±è´¥: '+code); return {success:false,error:code};}
}

// Toast ç®€æ˜“ - æ˜¾ç¤ºåœ¨å³ä¸‹è§’
function toast(msg){let box=document.getElementById('dev-toast-box'); if(!box){box=document.createElement('div'); box.id='dev-toast-box'; box.style.cssText='position:fixed;bottom:16px;right:16px;display:flex;flex-direction:column-reverse;gap:8px;z-index:9999;'; document.body.appendChild(box);} const item=document.createElement('div'); item.textContent=msg; item.style.cssText='background:#1f2937;color:#fff;padding:8px 14px;border-radius:6px;font-size:12px;box-shadow:0 4px 14px rgba(0,0,0,.4);opacity:0;transform:translateY(4px);transition:.3s'; box.appendChild(item); requestAnimationFrame(()=>{item.style.opacity='1';item.style.transform='translateY(0)';}); setTimeout(()=>{item.style.opacity='0';item.style.transform='translateY(4px)'; setTimeout(()=>item.remove(),300);},3000);}

// ï¼ˆå·²ç§»é™¤å†…ç½®è½¬ç§»è°ƒè¯•é¢æ¿ï¼Œå¦‚éœ€å†æ¬¡å¯ç”¨è¯·å‚è€ƒç‰ˆæœ¬æ§åˆ¶å†å²ï¼‰
</script>
<!-- ==== /æˆ¿é—´è½¬ç§»å‰ç«¯å¢å¼ºè„šæœ¬ ==== -->

</body>
</html>
