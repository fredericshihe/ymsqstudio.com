<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ç´æˆ¿ç®¡ç†ç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root {
    --primary-color:#3498db;
    --secondary-color:#2ecc71;
    --background-color:#f5f7fa;
    --text-color:#34495e;
    --border-color:#bdc3c7;
    --hover-color:#2980b9;
    --queue-color:#9b59b6;
    --success-color:#27ae60;
    --warning-color:#f39c12;
    --danger-color:#e74c3c;
    --muted-color:#95a5a6;
    --panel-radius:16px;
    --transition:0.3s ease;
    --shadow-sm:0 2px 5px rgba(0,0,0,.1);
    --shadow-md:0 4px 8px rgba(0,0,0,.15);
    --shadow-lg:0 10px 30px rgba(0,0,0,.25);
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
}

/* ========== åŸºç¡€å¸ƒå±€ä¸æ ‡é¢˜ ========== */
body {
    margin:0 auto;
    max-width:1200px;
    padding:20px;
    background:var(--background-color);
    color:var(--text-color);
    font-size:14px;
}
h1,h2,h3,h4 {text-align:center;color:var(--primary-color);margin:0 0 15px;}
h3{font-size:1.2em} h1{margin-top:10px;}
button {
    background:var(--primary-color);
    color:#fff;
    border:none;
    padding:10px 15px;
    border-radius:6px;
    cursor:pointer;
    transition:background .25s;
    font-size:14px;
}
button:hover{background:var(--hover-color)}
small{font-size:.8em;}
.hidden{display:none!important;}
.flex{display:flex;}
.center{justify-content:center;align-items:center;}
.pointer{cursor:pointer;}
.text-muted{color:#666;}
.text-danger{color:var(--danger-color);}
.text-success{color:var(--success-color);}
.text-warning{color:var(--warning-color);}
.bold{font-weight:700;}
.panel {
    background:#fff;
    border-radius:var(--panel-radius);
    box-shadow:var(--shadow-sm);
    padding:20px;
    margin:20px 0;
    border-left:4px solid var(--primary-color);
}
.panel.secondary{border-left-color:var(--secondary-color);}
.panel.queue{border-left-color:var(--queue-color);}
.panel.warning{border-left-color:var(--warning-color);}
.panel.orange{border-left-color:#e67e22;}
.panel.no-pad{padding:0;}
.separator{height:1px;background:#eee;margin:15px 0;}
.inline-block{display:inline-block;}
.grid{display:grid;gap:15px;}
.fade-in{animation:fadeIn .4s;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
@keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}
@keyframes queueFlash{0%,50%{background:#fff3cd;border-color:#ffeaa7}51%,100%{background:#f8f9fa;border-color:var(--border-color)}}
@keyframes overtimeGlow{0%,100%{box-shadow:0 1px 3px rgba(0,0,0,.1)}50%{box-shadow:0 1px 3px rgba(231,76,60,.3),0 0 8px rgba(231,76,60,.2)}}
@keyframes preparingGlow{0%,100%{box-shadow:0 1px 3px rgba(0,0,0,.1)}50%{box-shadow:0 1px 3px rgba(243,156,18,.3),0 0 8px rgba(243,156,18,.2)}}
@keyframes timelineIconPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
@keyframes searchStatusPulse{0%{opacity:1}50%{opacity:.7}100%{opacity:1}}
@keyframes flash{0%{background:#fff3cd}100%{background:transparent}}
@keyframes pulseExpired{0%{box-shadow:0 0 0 0 rgba(231,76,60,.4)}70%{box-shadow:0 0 0 8px rgba(231,76,60,0)}100%{box-shadow:0 0 0 0 rgba(231,76,60,0)}}

/* ========== é€šç”¨è¡¨å•/è¾“å…¥ ========== */
input[type=text],input[type=password],select{
    padding:8px 10px;
    border:1px solid var(--border-color);
    border-radius:6px;
    font-size:14px;
    box-sizing:border-box;
}
input:focus,select:focus{outline:none;border-color:var(--primary-color);}
textarea{font-family:inherit;font-size:14px;}
.clear-btn{background:#95a5a6}
.clear-btn:hover{background:#7f8c8d}

/* ========== é¢œè‰²çŠ¶æ€æ ‡ç­¾ ========== */
/* æœç´¢ç»“æœä¸­çš„çŠ¶æ€ï¼ˆåªæœ‰æ–‡å­—é¢œè‰²ï¼‰ */
.status-preparing{color:var(--warning-color);font-weight:600;}
.status-practicing{color:#3498db;font-weight:600;}
.status-overtime{color:var(--danger-color)!important;font-weight:600;animation:pulse 2s infinite;}
.status-queuing{color:var(--queue-color)!important;font-weight:600;}
.status-available{color:var(--success-color)!important;font-weight:600;}
.status-free{color:var(--muted-color)!important;font-weight:400;}

/* æˆ¿é—´å¡ç‰‡ä¸­çš„çŠ¶æ€ï¼ˆæœ‰èƒŒæ™¯è‰²ï¼‰ - æ”¹ä¸ºæ›´å…·ä½“çš„é€‰æ‹©å™¨ */
.room .room-status-preparing,
.room-status-chip.preparing{color:#fff;background:var(--warning-color);font-weight:600;}
.room .room-status-practicing,
.room-status-chip.in-use{color:#fff;background:#3498db;font-weight:600;}
.room .room-status-overtime,
.room-status-chip.expired{color:var(--danger-color)!important;font-weight:600;animation:pulse 2s infinite;}
.attendance-status{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700;text-align:center;color:#fff;}
.attendance-status.status-absent{background:var(--danger-color);}
.attendance-status.status-present{background:var(--success-color);}
.attendance-status.status-low_efficiency{background:var(--warning-color);}
.attendance-status.status-under_review{background:var(--warning-color);}
.attendance-status.status-excused{background:var(--muted-color);}

/* å­¦ç”ŸçŠ¶æ€å¾½ç« ï¼ˆåˆ—è¡¨ä¸­ï¼‰ */
.student-status-badge{
    background:#7f8c8d;
    color:#fff;
    font-size:11px;
    padding:3px 8px;
    border-radius:12px;
    white-space:nowrap;
    max-width:140px;
    overflow:hidden;
    text-overflow:ellipsis;
}
.student-status-badge.practicing{background:#3498db;}
.student-status-badge.preparing{background:var(--warning-color);}
.student-status-badge.overtime{background:var(--danger-color);}
.student-status-badge.queuing{background:var(--queue-color);}

/* ========== Toast ========== */
.toast{
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.7);
    color:#fff;
    padding:10px 20px;
    border-radius:6px;
    display:none;
    z-index:2000;
    font-size:14px;
}

/* ========== ç´æˆ¿å¡ç‰‡ ========== */
/* ========== ç´æˆ¿å¡ç‰‡ç»Ÿä¸€æ ·å¼ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ ========== */
.room-container{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:12px;
  margin-top:15px;
  padding:4px;
}

.room{
  position:relative;
  background:#fff;
  border:1px solid #dbe1e5;
  border-radius:12px;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:8px;
  font-size:13px;
  line-height:1.4;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  transition:.22s ease;
  min-height:95px;
  cursor:pointer;
  overflow:hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
}

.room:hover{
  box-shadow:0 6px 16px rgba(0,0,0,.15);
  border-color:#c8d0d6;
  transform:translateY(-2px);
  z-index:2;
}

/* ç´æˆ¿ç±»å‹å·¦è¾¹æ¡†æ ·å¼ */
.room.type-grand{
  border-left:4px solid #9b59b6;
}
.room.type-upright{
  border-left:4px solid #3498db;
}
.room.type-none{
  border-left:4px solid #95a5a6;
}

/* Hover å¼ºè°ƒæ•ˆæœ */
.room.type-grand:hover{
  box-shadow:0 6px 16px rgba(155,89,182,.2);
}
.room.type-upright:hover{
  box-shadow:0 6px 16px rgba(52,152,219,.2);
}
.room.type-none:hover{
  box-shadow:0 6px 16px rgba(149,165,166,.2);
}

/* ç´æˆ¿åç§°æ ·å¼ - é€‚ä¸­æ˜¾ç¤º */
.room-name{
  font-weight:700;
  font-size:15px; /* ä»16pxè°ƒæ•´åˆ°15px */
  color:#2c3e50;
  margin-bottom:2px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* ç´æˆ¿çŠ¶æ€åŒºåŸŸ */
.room-status{
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  gap:6px;
}

/* å­¦ç”Ÿä¿¡æ¯è¡Œ - é€‚ä¸­æ˜¾ç¤º */
.room-student-info{
  font-size:13px; /* ä»15pxè°ƒæ•´åˆ°13px */
  color:#2f4150;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:6px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  margin-bottom:4px;
}

.room-student-dot{
  width:6px; /* ä»8pxè°ƒæ•´åˆ°6px */
  height:6px;
  border-radius:50%;
  background:#27ae60;
  flex-shrink:0;
}

.room.preparing .room-student-dot{
  background:#f39c12;
}

.room.in-use .room-student-dot{
  background:#3498db;
}

.room.expired .room-student-dot{
  background:#e74c3c;
}

/* åº•éƒ¨çŠ¶æ€å’Œæ“ä½œåŒºåŸŸ - ç´§å‡‘å¸ƒå±€ */
.room-bottom-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:auto;
  gap:8px;
  padding-top:6px;
  border-top:1px solid #f1f3f4;
  min-height:28px; /* ç¡®ä¿æœ€å°é«˜åº¦ */
}

/* çŠ¶æ€èŠ¯ç‰‡ - ç¼©å°å°ºå¯¸ */
.room-status-chip{
  padding:3px 8px; /* ä»5px 12pxè°ƒæ•´ */
  font-size:11px; /* ä»12pxè°ƒæ•´åˆ°11px */
  line-height:1.2;
  border-radius:6px; /* ä»8pxè°ƒæ•´ */
  font-weight:600; /* ä»700è°ƒæ•´ */
  letter-spacing:0.1px;
  white-space:nowrap;
  flex-shrink:0;
  max-width:120px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
  overflow:hidden;
  text-overflow:ellipsis;
}

.room-status-chip.preparing{
  background:#fff3cd;
  color:#856404;
  border:1px solid #ffeaa7;
}

.room-status-chip.in-use{
  background:#cce7ff;
  color:#0066cc;
  border:1px solid #99d6ff;
}

.room-status-chip.expired{
  background:#f8d7da;
  color:#721c24;
  border:1px solid #f1aeb5;
}

.room-status-chip.available{
  background:#d5f4e6;
  color:#0d7337;
  border:1px solid #a3e9c4;
}

/* æ“ä½œæŒ‰é’®åŒºåŸŸ */
.room-actions{
  display:flex;
  justify-content:flex-end;
  flex-shrink:0;
}

/* æ¸…ç©ºæŒ‰é’® - ç¼©å°å°ºå¯¸ */
.room-clear-btn{
  background:#e74c3c;
  color:#fff;
  border:none;
  padding:4px 8px; /* ä»6px 12pxè°ƒæ•´ */
  border-radius:4px; /* ä»6pxè°ƒæ•´ */
  font-size:10px; /* ä»11pxè°ƒæ•´ */
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease;
  display:flex;
  align-items:center;
  gap:2px; /* ä»4pxè°ƒæ•´ */
  opacity:0.9;
  white-space:nowrap;
  min-width:40px; /* ç¡®ä¿æœ€å°å®½åº¦ */
}

.room-clear-btn:hover{
  background:#c0392b;
  opacity:1;
  transform:translateY(-1px);
}

.room-clear-btn:active{
  transform:translateY(0);
}

/* æ¸…ç©ºæŒ‰é’®å›¾æ ‡å’Œæ–‡å­— */
.room-clear-btn span:first-child{
  font-size:8px; /* Xå›¾æ ‡æ›´å° */
}

.room-clear-btn span:last-child{
  font-size:10px; /* æ–‡å­—å¤§å° */
}
/* ==== åŒå‡»æ¸…ç©º & ç»­ç´æˆ¿ åŠŸèƒ½æ–°å¢æ ·å¼ BEGIN ==== */
.room-remark{
  font-size:11px;
  color:#666;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  margin:2px 0 4px;
}
.room-renew-btn{
  background:#27ae60;
  color:#fff;
  border:none;
  padding:4px 8px;
  border-radius:4px;
  font-size:10px;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease;
  display:flex;
  align-items:center;
  gap:2px;
  opacity:0.9;
  white-space:nowrap;
  min-width:40px;
  margin-left:4px;
}
.room-renew-btn:hover{
  background:#1e8449;
  opacity:1;
  transform:translateY(-1px);
}
.room-renew-btn:active{
  transform:translateY(0);
}
/* é¼ æ ‡æç¤ºï¼šæ”¯æŒåŒå‡»æ¸…ç©º */
.room[data-has-student="1"]{
  cursor:pointer;
}
.room[data-has-student="1"]::after{
  content:'åŒå‡»æ¸…ç©º';
  position:absolute;
  top:6px;
  right:8px;
  font-size:10px;
  color:#999;
  pointer-events:none;
}
/* ==== åŒå‡»æ¸…ç©º & ç»­ç´æˆ¿ åŠŸèƒ½æ–°å¢æ ·å¼ END ==== */

/* ç©ºé—²çŠ¶æ€çš„ç´æˆ¿ä¸æ˜¾ç¤ºåº•éƒ¨è¡Œ */
.room:not(.preparing):not(.in-use):not(.expired) .room-bottom-row{
  display:none;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
  .room-container{
    grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
    gap:10px;
  }
  
  .room{
    padding:12px;
    min-height:85px;
  }
  
  .room-name{
    font-size:14px;
  }
  
  .room-student-info{
    font-size:12px;
  }
  
  .room-status-chip{
    font-size:10px;
    padding:2px 6px;
    max-width:100px;
  }
  
  .room-clear-btn{
    padding:3px 6px;
    font-size:9px;
    min-width:35px;
  }
}

@media (max-width: 480px) {
  .room-container{
    grid-template-columns:1fr 1fr;
    gap:8px;
  }
  
  .room{
    padding:10px;
    min-height:80px;
  }
  
  .room-name{
    font-size:13px;
  }
  
  .room-student-info{
    font-size:11px;
  }
  
  .room-bottom-row{
    gap:6px;
  }
  
  .room-status-chip{
    font-size:9px;
    padding:2px 5px;
    max-width:80px;
  }
  
  .room-clear-btn{
    padding:2px 5px;
    font-size:8px;
    min-width:30px;
  }
}


/* ========== æ¥¼å±‚æ¦‚è§ˆæŒ‰é’® ========== */
.floor-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin:15px 0;}
.floor-btn{
    padding:18px 14px;
    background:var(--primary-color);
    color:#fff;
    border:none;
    border-radius:12px;
    font-size:16px;
    font-weight:700;
    text-align:center;
    transition:var(--transition);
    position:relative;
}
.floor-btn:hover{background:var(--hover-color);transform:translateY(-3px);box-shadow:var(--shadow-md);}
.floor-info{font-size:12px;margin-top:6px;opacity:.95;line-height:1.3;}

/* ========== éœ€æ±‚é¢æ¿æŒ‰é’® ========== */
.demand-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px;}
.demand-btn{
    border:none;
    border-radius:14px;
    color:#fff;
    font-weight:700;
    padding:18px 20px;
    cursor:pointer;
    font-size:16px;
    transition:var(--transition);
    text-align:center;
}
.demand-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2);}
.demand-btn.grand-piano{background:linear-gradient(135deg,#9b59b6,#8e44ad);}
.demand-btn.upright-piano{background:linear-gradient(135deg,#3498db,#2980b9);}
.demand-btn.no-piano{background:linear-gradient(135deg,#95a5a6,#7f8c8d);}
/* ==== å¿«é€Ÿéœ€æ±‚æŒ‰é’®çŠ¶æ€æ–‡å­—ç»Ÿä¸€ç™½è‰² BEGIN ==== */
/* ä»…å½±å“æ”¾åœ¨ .demand-btn å†…éƒ¨çš„çŠ¶æ€è¡Œï¼Œä¸æ”¹å…¶å®ƒä½ç½®çš„åŒç±»çŠ¶æ€è‰² */
.demand-btn .status-available,
.demand-btn .status-overtime,
.demand-btn .status-queue,
.demand-btn .status-queuing,
.demand-btn .status-preparing,
.demand-btn .status-practicing,
.demand-btn .status-free {
  color:#fff !important;
  text-shadow:0 1px 2px rgba(0,0,0,.25); /* æå‡åœ¨äº®/æµ…è‰²æ¸å˜ä¸Šçš„å¯è¯»æ€§ï¼Œå¯æŒ‰éœ€åˆ é™¤ */
}
/* å¦‚æœæœªæ¥è¿˜ä¼šå‡ºç°æ–°çš„ status-* ç±»ï¼Œä¹Ÿä¸€å¹¶å˜ç™½ï¼Œå¯ç”¨é€šé…å†™æ³•ï¼ˆå¯äºŒé€‰ä¸€ï¼‰ */
/*
.demand-btn [class^="status-"],
.demand-btn [class*=" status-"]{
  color:#fff !important;
  text-shadow:0 1px 2px rgba(0,0,0,.25);
}
*/
/* ==== å¿«é€Ÿéœ€æ±‚æŒ‰é’®çŠ¶æ€æ–‡å­—ç»Ÿä¸€ç™½è‰² END ==== */
/* ========== ç´æˆ¿é€‰æ‹©ç½‘æ ¼ ========== */
.room-select-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  max-height: 400px;
  overflow-y: auto;
  padding: 8px 4px;
}

.room-select-card {
  background: #fff;
  border: 2px solid #e3f2fd;
  border-radius: 12px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.25s ease;
  position: relative;
  min-height: 80px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.room-select-card:hover {
  border-color: var(--primary-color);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
}

.room-select-card.available {
  border-color: var(--success-color);
  background: linear-gradient(135deg, #e8f8f5, #fff);
}

.room-select-card.overtime {
  border-color: var(--danger-color);
  background: linear-gradient(135deg, #fdeaea, #fff);
}

.room-card-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.room-type-icon {
  font-size: 16px;
  flex-shrink: 0;
}

.room-card-name {
  font-weight: 700;
  font-size: 14px;
  color: var(--text-color);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

.room-card-location {
  font-size: 12px;
  color: #666;
  margin-bottom: 6px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.room-overtime-info {
  font-size: 11px;
  line-height: 1.3;
}

.room-select-arrow {
  position: absolute;
  bottom: 8px;
  right: 10px;
  color: var(--primary-color);
  font-weight: 600;
  font-size: 16px;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
  .room-select-grid {
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 8px;
  }
  
  .room-select-card {
    padding: 10px;
    min-height: 70px;
  }
}

@media (max-width: 480px) {
  .room-select-grid {
    grid-template-columns: 1fr 1fr;
  }
}

/* ========== æ’é˜Ÿç³»ç»Ÿ ========== */
.queue-section .queue-subsection{margin-bottom:20px;padding:15px;border:1px solid var(--border-color);border-radius:10px;background:#f9f9f9;}
.queue-header,.queue-subheader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.queue-title{color:var(--queue-color);margin:0;}
.queue-list{min-height:50px;border:2px dashed var(--border-color);border-radius:8px;padding:10px;background:#f9f9f9;}
.queue-item{
    display:flex;align-items:center;gap:8px;
    padding:8px 10px;
    margin-bottom:6px;
    background:#fff;
    border:1px solid var(--border-color);
    border-radius:8px;
    transition:.2s;
}
.queue-item:last-child{margin-bottom:0;}
.queue-item:hover{background:#f0f0f0;transform:translateX(5px);}
.queue-item.has-available-rooms{animation:queueFlash 2s infinite;cursor:pointer;}
.queue-number{
    background:var(--queue-color);
    color:#fff;
    width:25px;height:25px;
    display:flex;align-items:center;justify-content:center;
    border-radius:50%;font-size:.75em;font-weight:700;flex-shrink:0;
}
.queue-student-info{flex:1;display:flex;flex-direction:column;min-width:0;}
.queue-student-name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.queue-wait{font-size:.68em;color:#555;margin-top:4px;white-space:nowrap;}
.queue-actions{display:flex;gap:4px;}
.queue-btn{
    border:none;
    background:#eee;
    width:28px;height:28px;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
    display:flex;justify-content:center;align-items:center;
    transition:.25s;
}
/* é˜Ÿåˆ—å®¹å™¨æ˜ç¡®ä½¿ç”¨åˆ—å¸ƒå±€ï¼Œé¿å…é‡æ’é”™ä½ */
.queue-list{
  display:flex;
  flex-direction:column;
}

/* é¿å… hover ä½ç§»å¯¼è‡´å¿«é€Ÿåˆ é™¤æ—¶å¸ƒå±€é—ªçƒï¼Œå¯æ”¹ä¸ºèƒŒæ™¯é«˜äº® */
.queue-item{
  position:relative;
  transition:background .25s, box-shadow .25s;
  /* ç§»é™¤ transform ç›¸å…³è§†è§‰æŠ–åŠ¨ */
}
.queue-item:hover{
  background:#eef2f5;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  transform:none;
}

/* å¯ç‚¹å‡»ï¼ˆready=1ï¼‰æ—¶ç»Ÿä¸€æŒ‡é’ˆæ ·å¼ */
.queue-item.has-available-rooms{
  cursor:pointer;
  /* è‹¥ animation é€ æˆé”™ä½ï¼Œå¯ä¸´æ—¶å…³é—­ï¼š */
  /* animation:none; */
  outline:2px solid #ffe28a; /* æ›´ç¨³å®šæ˜¾ç¤º */
}

/* è‹¥ä»æ€€ç–‘ animation å¼•èµ·é”™ä½ï¼Œå¯å–æ¶ˆ */
@keyframes queueFlash{
  0%,50%{background:#fffbe6;border-color:#ffd666;}
  51%,100%{background:#f9f9f9;border-color:var(--border-color);}
}

.queue-btn:hover{background:#ddd;}
.queue-btn.up{color:var(--secondary-color);}
.queue-btn.down{color:var(--warning-color);}
.queue-btn.remove{color:var(--danger-color);}
.empty-queue{text-align:center;color:#999;font-style:italic;padding:12px;font-size:.85em;}

/* ========== æœç´¢ ========== */
.search-section{padding:20px;background:#fff;border-radius:var(--panel-radius);box-shadow:var(--shadow-sm);border-left:4px solid var(--primary-color);}
.search-container{display:flex;gap:10px;align-items:center;margin-bottom:15px;}
#globalSearch{flex:1;padding:12px 16px;border:2px solid var(--border-color);border-radius:8px;font-size:16px;transition:.3s;}
#globalSearch:focus{border-color:var(--primary-color);outline:none;}
.search-results{
    background:#f8f9fa;
    border:1px solid var(--border-color);
    border-radius:8px;
    max-height:420px;
    overflow-y:auto;
}
.search-category{background:var(--primary-color);color:#fff;padding:8px 14px;font-weight:700;font-size:.9em;position:sticky;top:0;z-index:1;}
.search-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 14px;
    border-bottom:1px solid #e0e0e0;
    transition:.2s;
}
.search-item:hover{background:#e3f2fd;}
.search-item:last-child{border-bottom:none;}
.search-item-name{font-weight:700;font-size:1.05em;}
.search-item-status{font-size:.85em;color:#666;}
.search-item-actions{display:flex;gap:6px;}
.search-action-btn{
    padding:6px 10px;
    border:none;
    border-radius:4px;
    cursor:pointer;
    font-size:.75em;
    font-weight:600;
}
.search-clear-btn{background:var(--danger-color);color:#fff;}
.search-clear-btn:hover{background:#c0392b;}
.search-queue-btn{background:var(--queue-color);color:#fff;}
.search-queue-btn:hover{background:#8e44ad;}
.search-assign-btn{background:var(--secondary-color);color:#fff;}
.search-assign-btn:hover{background:#27ae60;}
.search-no-results{text-align:center;padding:30px;color:#999;font-style:italic;}

/* ========== å­¦ç”Ÿé€‰æ‹©/æ•°æ®åº“/æ—¶é—´æ®µ ========== */
/* å¹´çº§å¾½ç« æ ·å¼ */
.grade-badge {
    display: inline-block;
    background: #e67e22;
    color: #fff;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    white-space: nowrap;
    margin-left: 4px;
    font-weight: 600;
}

/* å¹´çº§ç­›é€‰å™¨æ ·å¼ */
#gradeFilter {
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 12px;
    min-width: 100px;
}

/* å¹´çº§è¾“å…¥æ¡†æç¤ºæ ·å¼ */
#editStudentGrade {
    font-family: monospace;
}

#editStudentGrade::placeholder {
    font-family: inherit;
    color: #999;
    font-style: italic;
}

.student-item{
    display:flex;align-items:center;gap:10px;padding:8px 12px;cursor:pointer;transition:.2s;width:100%;box-sizing:border-box;border-radius:6px;
}
.student-item:hover{background:#e0e0e0;}
.student-item.disabled-student{opacity:.55;cursor:not-allowed;}
/* ğŸ”¥ æ–°å¢ï¼šé”®ç›˜é€‰ä¸­çŠ¶æ€æ ·å¼ */
.student-item.keyboard-selected{
    background:#007acc !important;
    color:#fff !important;
    box-shadow:0 0 0 2px rgba(0,122,204,0.3);
}
.student-item.keyboard-selected .student-name-text{
    color:#fff;
}
.student-name-text{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:500;}
/* åœ¨ç°æœ‰CSSä¸­æ·»åŠ ä»¥ä¸‹æ ·å¼ */

/* å¯å¼ºåˆ¶æ›¿æ¢çš„å­¦ç”Ÿé¡¹æ ·å¼ */
.student-item.force-replaceable {
    border-left: 3px solid #f39c12;
    background: linear-gradient(135deg, #fff3cd, #ffffff);
}

.student-item.force-replaceable:hover {
    background: linear-gradient(135deg, #ffeaa7, #fff3cd);
    cursor: pointer;
}

/* å¼ºåˆ¶æ›¿æ¢æç¤ºå›¾æ ‡ */
.force-replace-hint {
    color: #f39c12;
    font-weight: bold;
    margin-left: 8px;
    animation: pulse 2s infinite;
}

/* è„‰å†²åŠ¨ç”» */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* ç¦ç”¨çŠ¶æ€ä½†å¯å¼ºåˆ¶æ›¿æ¢çš„ç‰¹æ®Šæ ·å¼ */
.student-item.disabled-student.force-replaceable {
    opacity: 0.8;
    cursor: pointer;
}

.student-item.disabled-student.force-replaceable:hover {
    opacity: 1;
}

.time-slot-badge,.weekly-summary-slot{display:inline-block;background:#e3f2fd;color:var(--primary-color);padding:2px 8px;border-radius:12px;font-size:.75em;margin:2px 4px 2px 0;}
.time-slot-item{display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:8px;background:#fff;border:1px solid var(--border-color);border-radius:6px;}
.delete-time-slot{background:var(--danger-color);color:#fff;padding:4px 8px;font-size:12px;border:none;border-radius:4px;cursor:pointer;}
.delete-time-slot:hover{background:#c0392b;}
.weekly-summary{background:#f8f9fa;padding:15px;border-radius:8px;margin:20px 0;border:1px solid var(--border-color);}
.weekly-summary-day{margin-bottom:12px;padding:10px;background:#fff;border-radius:6px;border-left:4px solid var(--primary-color);}
.weekly-summary-day-title{font-weight:700;margin-bottom:5px;}
.weekly-summary-empty{text-align:center;color:#999;font-style:italic;padding:25px;}
/* ä¼˜åŒ–å­¦ç”Ÿåº“æŒ‰é’®æ˜¾ç¤º */
.student-db-item .student-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.student-db-item .student-action-btn {
    padding: 6px 5px;
    font-size: 12px;
    min-width: 70px;
    white-space: nowrap;
    border-radius: 6px;
}

/* ========== æ—¶é—´æ®µç®¡ç†æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– ========== */
.weekday-buttons{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:12px; /* å¢åŠ é—´è· */
  margin-bottom:20px;
}

.weekday-btn{
  padding:14px 16px; /* å¢åŠ å†…è¾¹è· */
  border:2px solid var(--border-color);
  background:#fff;
  border-radius:10px; /* æ›´åœ†æ¶¦ */
  cursor:pointer;
  font-size:16px; /* å¢å¤§å­—ä½“ */
  font-weight:600; /* åŠ ç²— */
  color:#2c3e50; /* æ·±è‰²æ–‡å­— */
  transition:all .25s ease;
  min-height:50px; /* ç¡®ä¿æœ€å°é«˜åº¦ */
  display:flex;
  align-items:center;
  justify-content:center;
}

.weekday-btn:hover{
  border-color:var(--primary-color);
  background:#e3f2fd;
  color:var(--primary-color);
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(52,152,219,.2);
}

.weekday-btn.active{
  background:var(--primary-color);
  color:#fff;
  border-color:var(--primary-color);
  font-weight:700;
  box-shadow:0 4px 12px rgba(52,152,219,.3);
}

.weekday-btn.active:hover{
  background:var(--hover-color);
  border-color:var(--hover-color);
}
@keyframes pulse-green{
    0%,100%{box-shadow:0 0 0 0 rgba(46,204,113,.4)}
    50%{box-shadow:0 0 0 4px rgba(46,204,113,0)}
}

/* ========== æ—¶é—´è½´ã€é¢„æµ‹ä¸åˆ†ç±»ç»Ÿè®¡ ========== */
.timeline-control-container{display:flex;justify-content:center;margin:15px 0;}
.timeline-control-btn{
    background:linear-gradient(135deg,#e67e22,#d35400);
    color:#fff;
    padding:12px 24px;
    border-radius:25px;
    display:flex;
    align-items:center;
    gap:8px;
    font-size:14px;
    font-weight:500;
    box-shadow:0 2px 8px rgba(230,126,34,.3);
    cursor:pointer;
    border:none;
    min-width:180px;
    transition:.3s;
}
/* ==== Focus ç›‘æ§ï¼šä¸€è¡Œ 4 ä¸ªå¡ç‰‡ï¼Œè¶…å‡ºç«–å‘æ»šåŠ¨ ==== */
.focus-group-body{
  display:grid;
  grid-template-columns:repeat(4,1fr) !important;
  gap:12px;
  max-height:160px;         /* å¢åŠ é«˜åº¦ä»¥å®¹çº³ hover æ•ˆæœ */
  overflow-y:auto;
  padding:4px 4px 8px 4px;  /* å¢åŠ ä¸Šä¸‹å†…è¾¹è· */
}

.focus-group-body::-webkit-scrollbar{
  width:8px;
}
.focus-group-body::-webkit-scrollbar-thumb{
  background:#d0d4d8;
  border-radius:4px;
}
.focus-group-body::-webkit-scrollbar-thumb:hover{
  background:#b5bbc0;
}

.focus-card{
  padding:8px 8px 8px;
  min-height:86px;
  font-size:12px;
  /* å…³é”®ï¼šç¡®ä¿ hover æ—¶ä¸è¢«é®æŒ¡ */
  position:relative;
  z-index:1;
}

/* ä¼˜åŒ– hover æ•ˆæœï¼Œé¿å…è¾¹ç¼˜é®æŒ¡ */
.focus-card:hover{
  box-shadow:0 6px 16px rgba(0,0,0,.15);
  border-color:#c8d0d6;
  transform:translateY(-4px);
  z-index:2; /* hover æ—¶æå‡å±‚çº§ */
}

/* å“åº”å¼é™çº§ï¼šå±å¹•çª„æ—¶è‡ªåŠ¨å‡å°‘åˆ—æ•° */
@media (max-width:1100px){
  .focus-group-body{
    grid-template-columns:repeat(3,1fr) !important;
    max-height:180px; /* 3åˆ—æ—¶éœ€è¦æ›´å¤šé«˜åº¦ */
  }
}
@media (max-width:780px){
  .focus-group-body{
    grid-template-columns:repeat(2,1fr) !important;
    max-height:none;              /* å°å±ç›´æ¥å…¨éƒ¨å±•å¼€ï¼Œè§¦æ§æ›´å‹å¥½ */
    overflow-y:visible;
    padding:4px;
  }
}
@media (max-width:460px){
  .focus-group-body{
    grid-template-columns:repeat(1,1fr) !important;
    max-height:none;
    overflow-y:visible;
  }
}

/* === èšç„¦ï¼š15åˆ†é’Ÿå†…é‡Šæ”¾ + è¶…æ—¶ æ ·å¼ ä¼˜åŒ–ç‰ˆ === */
.focus-groups{
  display:flex;
  flex-direction:column;
  gap:20px;
}
.focus-group{
  background:#fff;
  border:1px solid #e3e6e9;
  border-radius:16px;
  padding:16px 18px 18px;
  box-shadow:var(--shadow-sm);
  display:flex;
  flex-direction:column;
  gap:14px;
  position:relative;
}
.focus-group.soon{border-left:6px solid #3498db;}
.focus-group.overtime{border-left:6px solid var(--danger-color);}
.focus-group-header{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.focus-group-title{
  font-size:16px;
  font-weight:700;
  color:#2c3e50;
  display:flex;
  align-items:center;
  gap:8px;
}
.focus-group-title span{
  font-weight:600;
  font-size:14px;
  color:#666;
  margin-left:2px;
}
.focus-group-sub{
  font-size:12px;
  color:#8b98a3;
  line-height:1.4;
}

/* ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šç»Ÿä¸€ä½¿ç”¨ç´æˆ¿å¡ç‰‡çš„ç½‘æ ¼å¸ƒå±€ */
.focus-group-body{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:12px;
  margin-top:15px;
  padding:4px;
}

/* ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šç»Ÿä¸€å¡ç‰‡æ ·å¼ä¸ç´æˆ¿å¡ç‰‡ä¿æŒä¸€è‡´ */
.focus-card{
  position:relative;
  background:#fff;
  border:1px solid #dbe1e5;
  border-radius:12px;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:8px;
  font-size:13px;
  line-height:1.4;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  transition:.22s ease;
  min-height:95px;
  cursor:default;
  overflow:hidden;
}

.focus-card:hover{
  box-shadow:0 6px 16px rgba(0,0,0,.15);
  border-color:#c8d0d6;
  transform:translateY(-2px);
  z-index:2;
}

/* ç´æˆ¿ç±»å‹å·¦è¾¹æ¡†æ ·å¼ */
.focus-card.soon{
  border-left:4px solid #3498db;
}
.focus-card.overtime{
  border-left:4px solid var(--danger-color);
}

/* Hover å¼ºè°ƒæ•ˆæœ */
.focus-card.soon:hover{
  box-shadow:0 6px 16px rgba(52,152,219,.2);
}
.focus-card.overtime:hover{
  box-shadow:0 6px 16px rgba(231,76,60,.2);
}

/* ç´æˆ¿åç§°æ ·å¼ - ä¸ç´æˆ¿å¡ç‰‡ä¸€è‡´ */
.focus-card .fc-room{
  font-weight:700;
  font-size:15px;
  color:#2c3e50;
  margin-bottom:2px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* ç±»å‹æ ‡ç­¾ä¼˜åŒ– - æ›´å°æ›´ç®€æ´ */
.fc-tag{
  background:#f0f3f6;
  color:#556270;
  padding:2px 6px;
  border-radius:8px;
  font-size:9px;
  font-weight:700;
  flex-shrink:0;
  letter-spacing:0.2px;
  margin-left:6px;
}
.fc-tag.grand{background:#fff3e0;color:#b06000;border:1px solid #f4d03f;}
.fc-tag.upright{background:#e8f4fd;color:#1a628f;border:1px solid #aed6f1;}
.fc-tag.none{background:#f4f4f4;color:#555;border:1px solid #d5d8dc;}

/* å­¦ç”Ÿä¿¡æ¯è¡Œ - ä¸ç´æˆ¿å¡ç‰‡ä¸€è‡´ */
.fc-stu{
  font-size:13px;
  color:#2f4150;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:6px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  margin-bottom:4px;
}
.fc-stu .dot{
  width:6px;
  height:6px;
  border-radius:50%;
  background:#3498db;
  flex-shrink:0;
}
.focus-card.overtime .fc-stu .dot{
  background:var(--danger-color);
}
.focus-card.soon .fc-stu .dot{
  background:#3498db;
}

/* çŠ¶æ€ä¿¡æ¯åŒºåŸŸ - ç®€åŒ–å¸ƒå±€ */
.focus-card .fc-status{
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  gap:6px;
}

/* åº•éƒ¨çŠ¶æ€è¡Œ - ä»¿ç…§ç´æˆ¿å¡ç‰‡ */
.focus-card .fc-bottom-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:auto;
  gap:8px;
  padding-top:6px;
  border-top:1px solid #f1f3f4;
  min-height:28px;
}

/* çŠ¶æ€èŠ¯ç‰‡ - ä¸ç´æˆ¿å¡ç‰‡æ ·å¼ä¸€è‡´ */
.fc-chip{
  padding:3px 8px;
  font-size:11px;
  line-height:1.2;
  border-radius:6px;
  font-weight:600;
  letter-spacing:0.1px;
  white-space:nowrap;
  flex-shrink:0;
  max-width:120px;
  overflow:hidden;
  text-overflow:ellipsis;
}

.fc-chip.remain{
  background:#d5f4e6;
  color:#0d7337;
  border:1px solid #a3e9c4;
}
.fc-chip.soon{
  background:#cce7ff;
  color:#0066cc;
  border:1px solid #99d6ff;
}
.fc-chip.overtime{
  background:#f8d7da;
  color:#721c24;
  border:1px solid #f1aeb5;
}
.fc-chip.location{
  background:#f8f9fa;
  color:#687580;
  font-weight:500;
  max-width:100%;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* ç©ºçŠ¶æ€ä¼˜åŒ– */
.focus-empty{
  grid-column:1/-1;
  font-size:13px;
  color:#999;
  text-align:center;
  padding:24px 12px;
  border:2px dashed #d5dadd;
  border-radius:12px;
  background:#fafbfc;
  font-style:italic;
}

/* è¿‡æ»¤ç»“æœä¸ºç©ºæ—¶çš„æç¤º */
.focus-empty-filter{
  grid-column:1/-1;
  text-align:center;
  font-size:13px;
  padding:18px 12px;
  border:2px dashed #d5dadd;
  border-radius:12px;
  color:#999;
  background:#fafbfc;
  font-style:italic;
}

/* è„šæ³¨è¯´æ˜ä¼˜åŒ– */
.focus-foot-note{
  margin-top:16px;
  font-size:12px;
  color:#82909a;
  line-height:1.6;
  background:#f8f9fa;
  padding:12px 16px;
  border-radius:12px;
  border:1px solid #e1e5e8;
  text-align:center;
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
  .focus-group-body{
    grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
    gap:10px;
  }
  
  .focus-card{
    padding:12px;
    min-height:85px;
  }
  
  .focus-card .fc-room{
    font-size:14px;
  }
  
  .fc-stu{
    font-size:12px;
  }
  
  .fc-chip{
    font-size:10px;
    padding:2px 6px;
    max-width:100px;
  }
}

@media (max-width: 480px) {
  .focus-group-body{
    grid-template-columns:1fr 1fr;
    gap:8px;
  }
  
  .focus-card{
    padding:10px;
    min-height:80px;
  }
  
  .focus-card .fc-room{
    font-size:13px;
  }
  
  .fc-stu{
    font-size:11px;
  }
  
  .fc-bottom-row{
    gap:6px;
  }
  
  .fc-chip{
    font-size:9px;
    padding:2px 5px;
    max-width:80px;
  }
}

/* ================ èšç„¦ï¼š15åˆ†é’Ÿå†…é‡Šæ”¾ + è¶…æ—¶ æ ·å¼ end ================ */

.timeline-control-btn:hover{background:linear-gradient(135deg,#d35400,#c0392b);transform:translateY(-2px);box-shadow:0 4px 12px rgba(230,126,34,.4);}
.timeline-control-btn.active{background:linear-gradient(135deg,#27ae60,#229954);box-shadow:0 2px 8px rgba(39,174,96,.3);}
.timeline-control-btn.active:hover{background:linear-gradient(135deg,#229954,#1e8449);}
.timeline-control-icon{font-size:16px;animation:timelineIconPulse 2s infinite;}
.timeline-section{display:none;margin:20px 0;padding:20px;background:#fff;border-radius:var(--panel-radius);box-shadow:var(--shadow-sm);border-left:4px solid #e67e22;}
.timeline-main{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:10px;}
.timeline-category{background:#f8f9fa;border-radius:12px;padding:15px;border:2px solid transparent;display:flex;flex-direction:column;min-height:360px;}
.timeline-category.grand{border-color:#f39c12;background:linear-gradient(135deg,#fef9e7,#f8f9fa);}
.timeline-category.upright{border-color:#3498db;background:linear-gradient(135deg,#e8f4fd,#f8f9fa);}
.timeline-category.other{border-color:#95a5a6;background:linear-gradient(135deg,#f4f4f4,#f8f9fa);}
.timeline-category-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;margin-bottom:10px;border-bottom:1px solid rgba(0,0,0,.1);}
.timeline-category-count{background:rgba(0,0,0,.1);padding:4px 8px;border-radius:12px;font-size:.75em;font-weight:700;}
.timeline-rooms-container{display:flex;flex-direction:column;flex:1;}
.timeline-rooms-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding-right:5px;}
.timeline-room-item{
    background:#fff;
    border-radius:8px;
    padding:12px;
    box-shadow:0 1px 3px rgba(0,0,0,.1);
    cursor:pointer;
    border-left:4px solid transparent;
    transition:.2s;
}
.timeline-room-item.available{border-left-color:var(--success-color);background:linear-gradient(135deg,#e8f8f5,#fff);}
.timeline-room-item.preparing{border-left-color:#f39c12;background:linear-gradient(135deg,#fef9e7,#fff);animation:preparingGlow 2s infinite;}
.timeline-room-item.practicing{border-left-color:#3498db;background:linear-gradient(135deg,#e8f4fd,#fff);}
.timeline-room-item.overtime{border-left-color:var(--danger-color);background:linear-gradient(135deg,#fdeaea,#fff);animation:overtimeGlow 1.5s infinite;}
.timeline-room-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.timeline-room-name{font-weight:700;color:#2c3e50;}
.timeline-room-status{font-size:.7em;padding:3px 8px;border-radius:12px;font-weight:700;text-transform:uppercase;color:#fff;}
.timeline-room-status.available{background:var(--success-color);}
.timeline-room-status.preparing{background:var(--warning-color);}
.timeline-room-status.practicing{background:#3498db;}
.timeline-room-status.overtime{background:var(--danger-color);}
.timeline-room-info{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:.85em;color:#666;}
.timeline-room-prediction{grid-column:1/-1;margin-top:5px;padding:6px 8px;background:rgba(52,152,219,.1);border-radius:6px;font-size:.75em;text-align:center;font-style:italic;color:#2980b9;}
.timeline-room-prediction.soon{background:rgba(39,174,96,.1);color:var(--success-color);}
.timeline-room-prediction.overtime-pred{background:rgba(231,76,60,.1);color:var(--danger-color);}
.category-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding:10px;background:rgba(255,255,255,.95);border-radius:8px;border:1px solid rgba(0,0,0,.1);margin-top:10px;flex-shrink:0;}
.category-stat-item{text-align:center;padding:6px;background:#fff;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.stat-number{display:block;font-size:1.2em;font-weight:700;margin-bottom:2px;}
.stat-number.available{color:var(--success-color);}
.stat-number.will-free{color:#3498db;}
.stat-number.overtime{color:var(--danger-color);}
.stat-label{font-size:.7em;color:#666;}

/* ========== è¶…æ—¶ç®¡ç† ========== */
.overtime-item.highlight-expired{animation:pulseExpired 1.5s infinite;}
.overtime-category{margin-bottom:20px;border:1px solid var(--border-color);border-radius:8px;overflow:hidden;}
.overtime-category-header{background:var(--primary-color);color:#fff;padding:12px 15px;font-weight:700;display:flex;justify-content:space-between;align-items:center;}
.overtime-category-count{background:rgba(255,255,255,.2);padding:2px 8px;border-radius:12px;font-size:.8em;}
.overtime-list-header,.overtime-item{
    display:grid;
    grid-template-columns:100px 120px 120px 120px 1fr 120px;
    gap:8px;
    padding:8px 12px;
    font-size:13px;
    align-items:center;
}
.overtime-list-header{font-weight:700;background:#f8f9fa;border-bottom:1px solid var(--border-color);}
.overtime-item{border-bottom:1px solid #eee;background:#fff;}
.overtime-item:nth-child(even){background:#fafafa;}
.overtime-badge{display:inline-block;padding:2px 6px;border-radius:12px;font-size:11px;background:var(--danger-color);color:#fff;margin-left:4px;}
.btn-mini-primary,.btn-mini-danger{
    padding:4px 8px;
    font-size:11px;
    border:none;
    border-radius:4px;
    cursor:pointer;
}
.btn-mini-primary{background:#3498db;color:#fff;}
.btn-mini-primary:hover{background:#2178b8;}
.btn-mini-danger{background:var(--danger-color);color:#fff;}
.btn-mini-danger:hover{background:#c0392b;}

/* ========== è€ƒå‹¤ ========== */
.attendance-category{margin-bottom:25px;border:1px solid var(--border-color);border-radius:8px;overflow:hidden;}
.attendance-category-header{background:linear-gradient(135deg,#e67e22,#d35400);color:#fff;padding:12px 15px;font-weight:700;display:flex;justify-content:space-between;align-items:center;}
.attendance-category-count{background:rgba(255,255,255,.2);padding:2px 8px;border-radius:12px;font-size:.8em;}
.attendance-list-header,.attendance-item{
    display:grid;
    grid-template-columns:120px 150px 150px 120px 1fr 100px; /* ç§»é™¤äº†å­æ®µæ•°åˆ— */
    gap:8px;
    padding:8px 12px;
    font-size:13px;
    align-items:center;
}
.attendance-list-header{font-weight:700;background:#f8f9fa;border-bottom:1px solid var(--border-color);}
.attendance-item{border-bottom:1px solid #eee;background:#fff;}
.attendance-item:nth-child(even){background:#fafafa;}
.attendance-item.absent{background:linear-gradient(135deg,#fdeaea,#fff);border-left:4px solid var(--danger-color);}
.attendance-summary{background:#ecf0f1;border-radius:8px;padding:15px;margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;}
.attendance-summary-item{text-align:center;background:#fff;padding:10px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.attendance-summary-number{font-size:1.4em;font-weight:700;margin-bottom:4px;}
.attendance-summary-number.absent-count{color:var(--danger-color);}
.attendance-summary-number.present-count{color:var(--success-color);}
.attendance-summary-number.total-count{color:var(--text-color);}
.attendance-empty{text-align:center;padding:40px;color:#999;font-style:italic;}
.attendance-auto-check{background:#e8f5e8;border:1px solid var(--success-color);border-radius:6px;padding:10px;margin-bottom:15px;font-size:12px;color:var(--success-color);text-align:center;}
/* ========== è¯·å‡æ ·å¼ ========== */
/* ğŸ”¥ æ–°å¢ï¼šè¯·å‡é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€æ ·å¼ */
.excuse-reason-option input[type="radio"]:checked + span {
    font-weight: 600;
    color: #2c3e50;
}

.excuse-reason-option:has(input[type="radio"]:checked) {
    border-color: #3498db !important;
    background-color: #e3f2fd !important;
}

#excuseDurationOptions label:has(input[type="radio"]:checked) {
    border-color: #3498db !important;
    background-color: #e3f2fd !important;
}

#excuseDurationOptions label input[type="radio"]:checked + span {
    font-weight: 600;
    color: #2c3e50;
}

/* ç¡®ä¿æœªé€‰ä¸­çŠ¶æ€çš„é»˜è®¤æ ·å¼ */
.excuse-reason-option:not(:has(input[type="radio"]:checked)) {
    border-color: #ddd;
    background-color: transparent;
}

#excuseDurationOptions label:not(:has(input[type="radio"]:checked)) {
    border-color: #ddd;
    background-color: transparent;
}

/* ========== è®¾ç½®æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– ========== */
.settings-modal-content {
  max-width: 700px;
  width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  margin: 2% auto;
  padding: 25px 30px;
}

.settings-section {
  margin-bottom: 35px;
  padding: 25px;
  background: linear-gradient(135deg, #f8f9fa, #ffffff);
  border-radius: 12px;
  border: 1px solid #e9ecef;
  border-left: 4px solid var(--primary-color);
  box-shadow: 0 2px 8px rgba(0,0,0,.05);
}

.settings-section h3 {
  margin: 0 0 20px 0;
  color: var(--primary-color);
  font-size: 18px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}

.setting-item {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 25px;
  align-items: start;
  margin-bottom: 25px;
  padding: 20px;
  background: #fff;
  border-radius: 10px;
  border: 1px solid #f0f0f0;
  transition: all 0.2s ease;
}

.setting-item:hover {
  border-color: #d0d7de;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}

.setting-item:last-child {
  margin-bottom: 0;
}

.setting-info {
  flex: 1;
}

.setting-label {
  font-weight: 700;
  font-size: 16px;
  color: #2c3e50;
  margin-bottom: 8px;
}

.setting-description {
  font-size: 14px;
  color: #6c757d;
  line-height: 1.5;
  margin-bottom: 8px;
}

.setting-description.admin-required {
  color: var(--danger-color);
  font-weight: 600;
}

.setting-preview {
  font-size: 13px;
  color: #e67e22;
  font-weight: 600;
  font-style: italic;
  background: #fff3cd;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ffeaa7;
  display: inline-block;
}

.setting-control {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
  min-width: 200px;
}

/* è¾“å…¥ç»„ä»¶æ ·å¼ */
.input-group {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #fff;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 4px 12px;
  transition: border-color 0.2s ease;
}

.input-group:focus-within {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.setting-input {
  border: none;
  outline: none;
  padding: 8px 4px;
  font-size: 14px;
  text-align: center;
  background: transparent;
  min-width: 60px;
}

.input-unit {
  font-size: 13px;
  color: #6c757d;
  font-weight: 500;
  white-space: nowrap;
}

.setting-range {
  font-size: 11px;
  color: #999;
  text-align: right;
}

/* æ—¶é—´è¾“å…¥ç»„ä»¶ */
.time-input-group {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #fff;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 8px 12px;
  transition: border-color 0.2s ease;
}

.time-input-group:focus-within {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.time-input {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.time-input-field {
  width: 50px;
  text-align: center;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 6px 4px;
  font-size: 14px;
  font-weight: 600;
}

.time-input label {
  font-size: 11px;
  color: #6c757d;
  font-weight: 500;
}

.time-separator {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary-color);
  margin: 0 4px;
}

/* å®‰å…¨è®¾ç½®ç‰¹æ®Šæ ·å¼ */
.security-section {
  border-left-color: var(--danger-color);
}

.security-section h3 {
  color: var(--danger-color);
}

.security-notice {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  background: linear-gradient(135deg, #fff5f5, #fef2f2);
  border: 1px solid #fecaca;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
}

.notice-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.notice-text {
  font-size: 14px;
  line-height: 1.5;
  color: #dc2626;
}

.password-input-group {
  display: flex;
  align-items: center;
  background: #fff;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  overflow: hidden;
  transition: border-color 0.2s ease;
  min-width: 220px;
}

.password-input-group:focus-within {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.password-field {
  flex: 1;
  border: none;
  outline: none;
  padding: 10px 12px;
  font-size: 14px;
  background: transparent;
}

.password-toggle {
  background: #f8f9fa;
  border: none;
  padding: 10px 12px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.2s ease;
  border-left: 1px solid #e9ecef;
}

.password-toggle:hover {
  background: #e9ecef;
}

/* æ“ä½œæŒ‰é’®åŒºåŸŸ */
.settings-actions {
  display: flex;
  justify-content: flex-end;
  gap: 15px;
  padding: 25px 0 5px;
  border-top: 2px solid #f8f9fa;
  margin-top: 30px;
  position: sticky;
  bottom: 0;
  background: #fff;
}

.settings-save-btn, .settings-cancel-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 120px;
  justify-content: center;
}

.settings-save-btn {
  background: linear-gradient(135deg, var(--secondary-color), #27ae60);
  color: #fff;
  box-shadow: 0 2px 4px rgba(46, 204, 113, 0.3);
}

.settings-save-btn:hover {
  background: linear-gradient(135deg, #27ae60, #229954);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(46, 204, 113, 0.4);
}

.settings-cancel-btn {
  background: linear-gradient(135deg, #95a5a6, #7f8c8d);
  color: #fff;
  box-shadow: 0 2px 4px rgba(149, 165, 166, 0.3);
}

.settings-cancel-btn:hover {
  background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(149, 165, 166, 0.4);
}

.btn-icon {
  font-size: 16px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .settings-modal-content {
    width: 98%;
    padding: 20px 15px;
    margin: 1% auto;
  }
  
  .settings-section {
    padding: 20px 15px;
    margin-bottom: 25px;
  }
  
  .setting-item {
    grid-template-columns: 1fr;
    gap: 15px;
    padding: 15px;
  }
  
  .setting-control {
    align-items: stretch;
    min-width: auto;
  }
  
  .password-input-group,
  .input-group,
  .time-input-group {
    min-width: auto;
    width: 100%;
  }
  
  .settings-actions {
    flex-direction: column;
    gap: 10px;
  }
  
  .settings-save-btn, .settings-cancel-btn {
    width: 100%;
  }
}

@media (max-width: 480px) {
  .settings-section h3 {
    font-size: 16px;
  }
  
  .setting-label {
    font-size: 15px;
  }
  
  .setting-description {
    font-size: 13px;
  }
  
  .time-input-group {
    justify-content: center;
  }
}

/* ========== è®¾ç½®ã€æ¨¡æ€ã€å¯å¤ç”¨å®¹å™¨ ========== */
.modal-content{
    background:#fff;
    margin:8% auto;
    padding:20px;
    border:1px solid #888;
    width:80%;
    max-width:500px;
    border-radius:16px;
    box-shadow:var(--shadow-md);
    position:relative;
}
.modal-content.large{max-width:900px;}
.modal-content.mid{max-width:700px;}
.modal-content.wide{max-width:800px;}
.close{
    position:absolute;
    top:15px;
    right:20px;  /* å¢åŠ å³è¾¹è·ï¼Œé¿å…ä¸æŒ‰é’®ç»„é‡å  */
    font-size:26px;
    font-weight:700;
    color:#aaa;
    cursor:pointer;
    z-index:1001;  /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
    background:rgba(255,255,255,0.8);  /* æ·»åŠ åŠé€æ˜èƒŒæ™¯ */
    border-radius:50%;
    width:30px;
    height:30px;
    display:flex;
    align-items:center;
    justify-content:center;
    line-height:1;
}
.close:hover{
    color:#000;
    background:rgba(255,255,255,1);
}

/* æ‰€æœ‰æ¨¡æ€å®¹å™¨åŸºç±» */
[id$="Modal"]{
    display:none;
    position:fixed;
    z-index:1000;
    left:0;top:0;width:100%;height:100%;
    background:rgba(0,0,0,.4);
    overflow:auto;
}
#unlockModal{z-index:10000;}
.replaceable-room-item,.available-room-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 15px;
    margin-bottom:10px;
    background:#f8f9fa;
    border:1px solid var(--border-color);
    border-radius:8px;
    transition:.2s;
}
.replaceable-room-item:hover,.available-room-item:hover{
    background:#e0e0e0;
}
.replace-btn{
    background:var(--primary-color);
    border:none;
    color:#fff;
    padding:8px 16px;
    border-radius:6px;
    cursor:pointer;
}
.replace-btn:hover{background:var(--hover-color);}
.time-slot-modal-content{max-width:600px;width:90%;max-height:80vh;overflow-y:auto;margin:2% auto;}
.settings-modal-content{max-width:600px;width:90%;max-height:85vh;overflow-y:auto;margin:3% auto;}
.settings-section{margin-bottom:25px;padding:20px;background:#f8f9fa;border-radius:8px;border-left:4px solid var(--primary-color);}
.setting-item{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:18px;}
.setting-label{font-weight:600;}
.setting-description{font-size:.85em;color:#666;margin-top:4px;}
.setting-control{display:flex;align-items:center;gap:8px;}
.setting-input{width:90px;text-align:center;}
.setting-preview{font-size:.75em;color:#e67e22;margin-top:6px;font-style:italic;}
.settings-actions{display:flex;justify-content:flex-end;gap:12px;padding-top:15px;border-top:1px solid var(--border-color);position:sticky;bottom:0;background:#fff;}
.settings-save-btn{background:var(--secondary-color);}
.settings-save-btn:hover{background:#27ae60;}
.settings-cancel-btn{background:#95a5a6;}
.settings-cancel-btn:hover{background:#7f8c8d;}

/* ========== å­¦ç”Ÿ DBã€ç´æˆ¿ DB åˆ—è¡¨ ========== */
.student-db-item,.room-db-item{
    display:flex;
    align-items:center;
    padding:12px 15px;
    border-bottom:1px solid #eee;
    transition:.15s;
    font-size:13px;
}
.student-db-item:hover,.room-db-item:hover{background:#f8f9fa;}
.student-db-item:last-child,.room-db-item:last-child{border-bottom:none;}
.student-info{flex:1;}
.student-name{font-weight:700;font-size:1.05em;}
.student-details{font-size:.8em;color:#666;margin-top:4px;}
.student-actions,.ot-actions{display:flex;gap:8px;flex-wrap:wrap;}
.student-action-btn{
    border:none;
    border-radius:4px;
    padding:5px 10px;
    cursor:pointer;
    font-size:.75em;
    font-weight:600;
}
.edit-btn{background:var(--primary-color);color:#fff;}
.edit-btn:hover{background:var(--hover-color);}
.delete-btn{background:var(--danger-color);color:#fff;}
.delete-btn:hover{background:#c0392b;}
.major-badge{display:inline-block;background:var(--primary-color);color:#fff;padding:2px 8px;border-radius:12px;font-size:.7em;margin-left:6px;}
.student-db-stats,.room-db-stats{
    background:#f8f9fa;
    padding:12px 15px;
    border-radius:8px;
    border:1px solid var(--border-color);
    font-size:.85em;
    color:#666;
    margin-top:8px;
    line-height:1.5;
}
.empty-database{padding:40px;text-align:center;font-style:italic;color:#999;}
.room-db-item{display:grid;grid-template-columns:90px 90px 110px 1fr 140px;gap:8px;}
.room-db-item.header{background:#e8f2fb;font-weight:700;position:sticky;top:0;z-index:2;}
.room-tag{display:inline-block;padding:2px 6px;border-radius:10px;font-size:11px;background:#eee;margin-left:4px;}
.tag-grand{background:#f39c12;color:#fff;}
.tag-upright{background:#2980b9;color:#fff;}
.tag-none{background:#7f8c8d;color:#fff;}
.room-edit-btn,.room-del-btn,.room-save-btn,.room-cancel-btn{
    padding:4px 8px;
    border:none;
    border-radius:4px;
    cursor:pointer;
    font-size:12px;
    margin:2px 0;
}
.room-edit-btn{background:var(--primary-color);color:#fff;}
.room-del-btn{background:var(--danger-color);color:#fff;}
.room-save-btn{background:var(--success-color);color:#fff;}
.room-cancel-btn{background:#95a5a6;color:#fff;}
.room-inline-input,.room-inline-select{width:100%;box-sizing:border-box;padding:4px 6px;font-size:12px;}
.add-room-btn{background:var(--secondary-color);color:#fff;}
.add-room-btn:hover{background:#27ae60;}
.import-room-btn{background:#16a085;color:#fff;}
.import-room-btn:hover{background:#12836c;}
.export-btn{background:#8e44ad;color:#fff;}
.export-btn:hover{background:#732d91;}
/* === ç´æˆ¿ç±»å‹é¢œè‰²åŒºåˆ† === */
.room.type-grand{
  background:linear-gradient(135deg,#f9f1ff,#f2e3ff);
  border:1px solid #e1ccfa;
  border-left:6px solid #9b59b6;
}
.room.type-upright{
  background:linear-gradient(135deg,#eef7ff,#dff0ff);
  border:1px solid #c8e2f7;
  border-left:6px solid #3498db;
}
.room.type-none{
  background:linear-gradient(135deg,#f4f6f7,#eceff1);
  border:1px solid #d6dadd;
  border-left:6px solid #95a5a6;
}

/* Hover å¼ºè°ƒï¼ˆä¿ç•™åŸä½ç§»é˜´å½±ï¼Œä½†é¢œè‰²ä¸å˜å½¢ï¼‰ */
.room.type-grand:hover{
  box-shadow:0 6px 18px rgba(155,89,182,.25);
}
.room.type-upright:hover{
  box-shadow:0 6px 18px rgba(52,152,219,.25);
}
.room.type-none:hover{
  box-shadow:0 6px 18px rgba(149,165,166,.25);
}

/* ========== å¯ç”¨ / æ›¿æ¢ç´æˆ¿æ¨¡æ€åˆ—è¡¨ ========== */
.replaceable-room-name,.room-name-large{font-weight:700;font-size:1.05em;}
.replaceable-room-details,.room-details{font-size:.85em;color:#666;margin-top:4px;}
.replaceable-room-status{font-size:.7em;color:var(--danger-color);margin-top:3px;}

/* ========== Unlock å¼¹çª—ç‰¹æ®Šæ ·å¼ï¼ˆç‹¬ç«‹ç”Ÿæˆæ—¶è¦†ç›–ï¼‰ ========== */

/* ========== ç¼“å­˜ç›‘è§†ç»„ä»¶ ========== */
.cache-info{
    position:fixed;
    top:10px;right:10px;
    background:rgba(255,255,255,.95);
    border:1px solid var(--border-color);
    border-radius:8px;
    padding:8px 12px;
    font-size:12px;
    color:var(--text-color);
    box-shadow:0 2px 8px rgba(0,0,0,.1);
    z-index:999;
    min-width:120px;
    transition:.3s;
}
.cache-info:hover{background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.15);}
.cache-size{font-weight:700;margin-bottom:2px;}
.cache-size.warning{color:var(--warning-color);}
.cache-size.danger{color:var(--danger-color);}
.cache-percentage{font-size:10px;color:#666;}
.cache-details{font-size:10px;color:#999;margin-top:3px;border-top:1px solid #eee;padding-top:3px;line-height:1.2;}

/* ========== è‡ªé€‚åº” ========== */
@media (max-width:900px){
    .attendance-list-header,.attendance-item{
        grid-template-columns:100px 80px 120px 100px 1fr 90px; /* ç§»é™¤äº†å­æ®µæ•°åˆ— */
        font-size:12px;
    }
    .overtime-list-header,.overtime-item{grid-template-columns:80px 100px 100px 100px 1fr 90px;font-size:12px;}
    .room-db-item{grid-template-columns:70px 70px 90px 1fr 110px;font-size:12px;}
    .setting-item{flex-direction:column;align-items:flex-start;}
    .settings-actions{position:static;}
}
@media (max-width:600px){
    .search-item{flex-direction:column;align-items:flex-start;gap:6px;}
    .search-item-actions{align-self:flex-end;}
    .timeline-room-info{grid-template-columns:1fr;}
    .category-stats{grid-template-columns:repeat(2,1fr);}
    .weekday-buttons{grid-template-columns:repeat(3,1fr);}
}
/* === ç»ƒç´çŠ¶æ€æ£€æŸ¥æé†’é¢æ¿ ç¾åŒ–ç‰ˆ BEGIN === */
.overrun-panel{
  position:fixed;
  top:72px;
  right:0;
  bottom:16px;
  width:380px;
  display:flex;
  flex-direction:column;
  background:linear-gradient(145deg, #ffffff, #f8f9fa);
  border:1px solid #e8ecef;
  border-right:none;
  border-top-left-radius:20px;
  border-bottom-left-radius:20px;
  box-shadow:0 8px 32px rgba(231,76,60,.15), 0 2px 8px rgba(0,0,0,.08);
  font-size:13px;
  z-index:1500;
  transition:all .4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter:blur(10px);
}

.overrun-panel.collapsed{
  transform:translateX(calc(100% - 50px));
  opacity:.9;
  box-shadow:0 4px 16px rgba(231,76,60,.12);
}

.overrun-panel-header{
  user-select:none;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 18px;
  background:linear-gradient(135deg, #e74c3c, #c0392b, #a93226);
  color:#fff;
  border-top-left-radius:20px;
  cursor:pointer;
  position:relative;
  min-height:50px;
  box-shadow:0 2px 8px rgba(231,76,60,.3);
  transition:all .3s ease;
}

.overrun-panel-header:hover{
  background:linear-gradient(135deg, #c0392b, #a93226, #922b21);
  transform:translateY(-1px);
}

.overrun-panel-header h4{
  margin:0;
  font-size:15px;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:8px;
  color: #fff !important;
}

.overrun-panel-header .header-subtitle{
  font-size:11px;
  opacity:.85;
  font-weight:400;
  margin-top:2px;
}

.overrun-panel-body{
  overflow-y:auto;
  padding:16px 12px 18px;
  flex:1;
  min-height:0;
  background:rgba(255,255,255,.6);
}

.overrun-panel-toggle-tip{
  position:absolute;
  right:-36px;
  top:50%;
  transform:translateY(-50%);
  background:linear-gradient(135deg, #c0392b, #a93226);
  color:#fff;
  width:32px;
  height:70px;
  border-top-left-radius:8px;
  border-bottom-left-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
  font-weight:600;
  writing-mode:vertical-rl;
  letter-spacing:1px;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(192,57,43,.4);
  transition:all .3s ease;
}

.overrun-panel-toggle-tip:hover{
  background:linear-gradient(135deg, #a93226, #922b21);
  transform:translateY(-50%) translateX(-2px);
  box-shadow:0 6px 16px rgba(192,57,43,.5);
}

.overrun-panel-body::-webkit-scrollbar{
  width:6px;
}
.overrun-panel-body::-webkit-scrollbar-track{
  background:rgba(0,0,0,.05);
  border-radius:3px;
}
.overrun-panel-body::-webkit-scrollbar-thumb{
  background:linear-gradient(180deg, #e74c3c, #c0392b);
  border-radius:3px;
  transition:all .3s ease;
}
.overrun-panel-body::-webkit-scrollbar-thumb:hover{
  background:linear-gradient(180deg, #c0392b, #a93226);
}

/* å¼‚å¸¸é¡¹ç›®å¡ç‰‡æ ·å¼ */
.overrun-item{
  background:linear-gradient(135deg, #fff, #fefefe);
  border:1px solid #f1c2c2;
  border-radius:12px;
  padding:14px 16px;
  margin-bottom:12px;
  box-shadow:0 2px 8px rgba(231,76,60,.08);
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  position:relative;
  overflow:hidden;
}

.overrun-item::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  width:4px;
  height:100%;
  background:linear-gradient(180deg, #e74c3c, #c0392b);
  border-radius:0 2px 2px 0;
}

.overrun-item:hover{
  transform:translateY(-2px) translateX(4px);
  box-shadow:0 8px 24px rgba(231,76,60,.15);
  border-color:#e8b4b4;
}

.overrun-item-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:10px;
  gap:12px;
}

.overrun-item-header > div:first-child{
  font-weight:700;
  font-size:14px;
  color:#2c3e50;
  line-height:1.3;
  flex:1;
}

.overrun-item-header .student-major{
  color:#7f8c8d;
  font-weight:500;
  font-size:12px;
  margin-left:6px;
}

.overrun-over{
  background:linear-gradient(135deg, #e74c3c, #c0392b);
  color:#fff;
  padding:4px 10px;
  border-radius:8px;
  font-size:12px;
  font-weight:700;
  white-space:nowrap;
  box-shadow:0 2px 6px rgba(231,76,60,.3);
  animation:overrunPulse 2s infinite;
}

@keyframes overrunPulse{
  0%, 100%{ transform:scale(1); }
  50%{ transform:scale(1.05); }
}

.overrun-item-room, .overrun-slot{
  font-size:12px;
  color:#5a6c7d;
  margin-bottom:6px;
  display:flex;
  align-items:center;
  gap:6px;
}

.overrun-item-room::before{
  content:'ğŸ ';
  font-size:11px;
}

.overrun-slot::before{
  content:'â°';
  font-size:11px;
}

.overrun-actions{
  display:flex;
  gap:8px;
  margin-top:12px;
  padding-top:10px;
  border-top:1px solid #f8f9fa;
}

.overrun-btn-ignore, .overrun-btn-record{
  flex:1;
  padding:8px 12px;
  border:none;
  border-radius:8px;
  font-size:12px;
  font-weight:600;
  cursor:pointer;
  transition:all .3s ease;
  position:relative;
  overflow:hidden;
}

.overrun-btn-ignore{
  background:linear-gradient(135deg, #95a5a6, #7f8c8d);
  color:#fff;
}

.overrun-btn-ignore:hover{
  background:linear-gradient(135deg, #7f8c8d, #6c7b7d);
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(149,165,166,.3);
}

.overrun-btn-record{
  background:linear-gradient(135deg, #3498db, #2980b9);
  color:#fff;
}

.overrun-btn-record:hover{
  background:linear-gradient(135deg, #2980b9, #21618c);
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(52,152,219,.3);
}

.overrun-btn-ignore:active, .overrun-btn-record:active{
  transform:translateY(0);
}

.overrun-empty{
  text-align:center;
  padding:40px 20px;
  color:#95a5a6;
  font-style:italic;
  font-size:14px;
  background:linear-gradient(135deg, rgba(255,255,255,.8), rgba(248,249,250,.6));
  border:2px dashed #ddd;
  border-radius:12px;
  margin:20px 0;
}

.overrun-count-badge{
  background:linear-gradient(135deg, #fff, #f8f9fa);
  color:#e74c3c;
  font-size:11px;
  font-weight:700;
  padding:3px 8px;
  border-radius:10px;
  margin-left:8px;
  border:1px solid rgba(255,255,255,.3);
  box-shadow:0 2px 4px rgba(0,0,0,.1);
  animation:badgePulse 2s infinite;
}

@keyframes badgePulse{
  0%, 100%{ transform:scale(1); opacity:1; }
  50%{ transform:scale(1.1); opacity:.9; }
}

.overrun-panel-footer{
  padding:12px 16px;
  background:rgba(248,249,250,.8);
  border-top:1px solid #e9ecef;
  font-size:11px;
  line-height:1.4;
  color:#6c757d;
  border-bottom-left-radius:20px;
}
/* === ç»ƒç´çŠ¶æ€æ£€æŸ¥æé†’é¢æ¿ ç¾åŒ–ç‰ˆ END === */
/* =======åœ¨ç°æœ‰CSSä¸­æ·»åŠ äº‘åŒæ­¥æ ·å¼==== */
.connection-online {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
}

.connection-offline {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
}

.connection-online:hover,
.connection-offline:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* ğŸ”¥ æ–°å¢ï¼šè‡ªåŠ¨é”å®šè­¦å‘Šæ ·å¼ */
.auto-lock-warning {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    padding: 25px 35px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
    z-index: 10001;
    text-align: center;
    min-width: 350px;
    animation: autoLockPulse 1s infinite;
}

.auto-lock-warning h3 {
    margin: 0 0 15px 0;
    color: white !important;
    font-size: 18px;
}

.auto-lock-warning p {
    margin: 0 0 20px 0;
    font-size: 16px;
    line-height: 1.4;
}

.auto-lock-countdown {
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    margin: 10px 0;
}

.auto-lock-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.auto-lock-continue-btn {
    background: #27ae60;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.auto-lock-continue-btn:hover {
    background: #229954;
    transform: translateY(-1px);
}

.auto-lock-lock-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.auto-lock-lock-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

@keyframes autoLockPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.02); }
}
/* ===== æ‰¹é‡æ—¶é—´æ®µç®¡ç†ï¼ˆBTMï¼‰ ===== */

#bulkTimeManagerModal{
  position:fixed;
  left:0;top:0;right:0;bottom:0;
  background:rgba(0,0,0,.55);
  z-index:3000;
  display:none;
  backdrop-filter:blur(4px);
}
#bulkTimeManagerModal .btm-wrapper{
  width:90%;
  height:90%;
  margin:auto;
  background:#fff;
  border-radius:16px;
  display:flex;
  flex-direction:column;
  box-shadow:0 6px 30px rgba(0,0,0,.25);
  overflow:hidden;
  font-size:14px;
}
#bulkTimeManagerModal .btm-header{
  flex:0 0 auto;
  padding:14px 20px;
  background:linear-gradient(135deg,#007AFF,#5856D6);
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#bulkTimeManagerModal .btm-title{
  font-size:18px;
  font-weight:700;
  letter-spacing:.5px;
}
#bulkTimeManagerModal .btm-actions{display:flex;gap:10px;flex-wrap:wrap;}
#bulkTimeManagerModal .btm-btn{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
  font-size:13px;
  letter-spacing:.5px;
  transition:.25s;
}
#bulkTimeManagerModal .btm-btn:hover{opacity:.9;transform:translateY(-2px);}
#bulkTimeManagerModal .btm-primary{background:#007AFF;color:#fff;}
#bulkTimeManagerModal .btm-secondary{background:#4e5d78;color:#fff;}
#bulkTimeManagerModal .btm-danger{background:#e74c3c;color:#fff;}
#bulkTimeManagerModal .btm-body{flex:1;display:flex;overflow:hidden;}
#bulkTimeManagerModal .btm-left{flex:1;display:flex;flex-direction:column;padding:16px;overflow:hidden;}
#bulkTimeManagerModal .btm-right{width:320px;border-left:1px solid #eee;padding:16px;display:flex;flex-direction:column;gap:12px;background:#f8f9fb;}
#bulkTimeManagerModal .btm-student-bar{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
#bulkTimeManagerModal .btm-select{
  flex:1;
  padding:8px 10px;
  border:2px solid #d6dae2;
  border-radius:8px;
  font-size:14px;
  outline:none;
  transition:.25s;
}
#bulkTimeManagerModal .btm-select:focus{border-color:#007AFF;box-shadow:0 0 0 3px rgba(0,122,255,.15);}
#bulkTimeManagerModal .btm-stu-nav button{
  padding:6px 10px;
  border:none;
  background:#007AFF;
  color:#fff;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
  transition:.25s;
}
#bulkTimeManagerModal .btm-stu-nav button:hover{opacity:.85;}
#bulkTimeManagerModal .btm-stu-info{
  font-size:13px;
  color:#555;
  margin-bottom:10px;
  line-height:1.5;
  min-height:32px;
}
#bulkTimeManagerModal .btm-legend{
  display:flex;
  gap:18px;
  flex-wrap:wrap;
  font-size:12px;
  color:#333;
  padding:8px 10px;
  background:#f2f5f9;
  border:1px solid #e0e4ea;
  border-radius:8px;
  margin-bottom:10px;
}
#bulkTimeManagerModal .btm-table-wrap{
  flex:1;
  overflow:auto;
  border:1px solid #e0e4ea;
  border-radius:10px;
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,.05) inset;
}
#bulkTimeManagerModal .btm-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width:900px;
  font-size:12px;
  user-select:none;
}
#bulkTimeManagerModal .btm-table thead th{
  background:#f0f3f7;
  position:sticky;
  top:0;
  z-index:2;
  padding:10px 8px;
  font-weight:700;
  border-bottom:1px solid #d6dae2;
  color:#2c3e50;
}
#bulkTimeManagerModal .btm-time-col{width:120px;}

/* ç»Ÿä¸€å•å…ƒæ ¼åŸºç¡€æ ·å¼ */
#bulkTimeManagerModal .btm-table tbody td{
  text-align:center;
  padding:8px 6px;
  border-bottom:1px solid #eef1f5;
  border-right:1px solid #eef1f5;
  position:relative;
  line-height:1.3;
  transition: all 0.25s ease;
  cursor: pointer;
  font-weight: 500;
  color: #2f4150;
}
#bulkTimeManagerModal .btm-table tbody td:last-child{border-right:none;}
#bulkTimeManagerModal .btm-table tbody tr:last-child td{border-bottom:none;}

/* ç»Ÿä¸€æœªé€‰ä¸­çŠ¶æ€ */
#bulkTimeManagerModal .btm-cell:not(.btm-cell-selected):not(.btm-cell-rest) {
  background: #fff;
  color: #2f4150;
  border-color: #eef1f5;
}

/* ç»Ÿä¸€æ‚¬åœæ•ˆæœ */
#bulkTimeManagerModal .btm-cell:hover:not(.btm-cell-rest):not(.btm-cell-selected) {
  background: #e6f1ff;
  border-color: #b1d3ff;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 122, 255, 0.15);
  z-index: 1;
}

/* ç»Ÿä¸€é€‰ä¸­çŠ¶æ€ */
#bulkTimeManagerModal .btm-cell-selected {
  background: linear-gradient(135deg, #007AFF, #5856D6);
  color: #fff;
  font-weight: 700;
  border-color: #3366cc;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) inset;
}

/* ç»Ÿä¸€ä¼‘æ¯çŠ¶æ€ */
#bulkTimeManagerModal .btm-cell-rest {
  background: linear-gradient(135deg, #6C757D, #495057);
  color: #fff;
  cursor: not-allowed;
  font-weight: 600;
  border-color: #495057;
}

/* é€‰ä¸­çŠ¶æ€æ‚¬åœæ•ˆæœ */
#bulkTimeManagerModal .btm-cell-selected:hover {
  opacity: 0.9;
  transform: translateY(-1px);
  box-shadow: 0 3px 10px rgba(0, 122, 255, 0.25);
}

/* ä¼‘æ¯çŠ¶æ€æ‚¬åœæ•ˆæœï¼ˆæ— å˜åŒ–ï¼‰ */
#bulkTimeManagerModal .btm-cell-rest:hover {
  transform: none;
  box-shadow: none;
  opacity: 0.8;
}

/* æ´»è·ƒçŠ¶æ€ï¼ˆç‚¹å‡»æ—¶çš„åé¦ˆï¼‰ */
#bulkTimeManagerModal .btm-cell:active:not(.btm-cell-rest) {
  transform: translateY(0);
  transition: all 0.1s ease;
}

#bulkTimeManagerModal .btm-wed-subwrap{
  display:flex;
  flex-direction:column;
  gap:2px;
}

/* ç»Ÿä¸€å‘¨ä¸‰å­å•å…ƒæ ¼æ ·å¼ - ä¸å…¶ä»–åˆ—å®Œå…¨ä¸€è‡´ */
#bulkTimeManagerModal .btm-wed-sub{
  flex:1;
  padding:4px 2px;
  border:1px solid #eef1f5; /* ä¸å…¶ä»–å•å…ƒæ ¼è¾¹æ¡†é¢œè‰²ä¸€è‡´ */
  border-radius:4px;
  transition: all 0.25s ease;
  cursor: pointer;
  font-weight: 500;
  background: #fff; /* ç¡®ä¿é»˜è®¤èƒŒæ™¯ä¸ºç™½è‰² */
  color: #2f4150; /* ç¡®ä¿é»˜è®¤æ–‡å­—é¢œè‰²ä¸€è‡´ */
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 20px;
}

/* ç»Ÿä¸€å‘¨ä¸‰å­å•å…ƒæ ¼æ‚¬åœæ•ˆæœ - ä¸å…¶ä»–åˆ—å®Œå…¨ä¸€è‡´ */
#bulkTimeManagerModal .btm-wed-sub:hover:not(.rest):not(.selected) {
  background: #e6f1ff;
  border-color: #b1d3ff;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 122, 255, 0.15);
}

/* ç»Ÿä¸€å‘¨ä¸‰å­å•å…ƒæ ¼é€‰ä¸­çŠ¶æ€ - ä¸å…¶ä»–åˆ—å®Œå…¨ä¸€è‡´ */
#bulkTimeManagerModal .btm-wed-sub.selected {
  background: linear-gradient(135deg, #007AFF, #5856D6);
  color: #fff;
  font-weight: 700;
  border-color: #3366cc;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) inset;
}

/* ç»Ÿä¸€å‘¨ä¸‰å­å•å…ƒæ ¼ä¼‘æ¯çŠ¶æ€ - ä¸å…¶ä»–åˆ—å®Œå…¨ä¸€è‡´ */
#bulkTimeManagerModal .btm-wed-sub.rest {
  background: linear-gradient(135deg, #6C757D, #495057);
  color: #fff;
  cursor: not-allowed;
  font-weight: 600;
  border-color: #495057;
}

/* å‘¨ä¸‰å­å•å…ƒæ ¼é€‰ä¸­çŠ¶æ€æ‚¬åœæ•ˆæœ - ä¸å…¶ä»–åˆ—å®Œå…¨ä¸€è‡´ */
#bulkTimeManagerModal .btm-wed-sub.selected:hover {
  opacity: 0.9;
  transform: translateY(-1px);
  box-shadow: 0 3px 10px rgba(0, 122, 255, 0.25);
}

/* å‘¨ä¸‰å­å•å…ƒæ ¼ä¼‘æ¯çŠ¶æ€æ‚¬åœæ•ˆæœ - ä¸å…¶ä»–åˆ—å®Œå…¨ä¸€è‡´ */
#bulkTimeManagerModal .btm-wed-sub.rest:hover {
  transform: none;
  box-shadow: none;
  opacity: 0.8;
}

/* å‘¨ä¸‰å­å•å…ƒæ ¼æ´»è·ƒçŠ¶æ€ - ä¸å…¶ä»–åˆ—å®Œå…¨ä¸€è‡´ */
#bulkTimeManagerModal .btm-wed-sub:active:not(.rest) {
  transform: translateY(0);
  transition: all 0.1s ease;
}

#bulkTimeManagerModal .btm-right .btm-summary-title{
  font-size:15px;
  font-weight:700;
  color:#2c3e50;
}
#bulkTimeManagerModal .btm-selected-list{
  flex:1;
  overflow:auto;
  background:#fff;
  border:1px solid #e0e4ea;
  border-radius:10px;
  padding:10px;
  font-size:12px;
  line-height:1.5;
  display:flex;
  flex-direction:column;
  gap:6px;
}
#bulkTimeManagerModal .btm-chip{
  display:inline-block;
  background:#007aff22;
  border:1px solid #007aff88;
  color:#007AFF;
  padding:3px 8px;
  border-radius:14px;
  font-size:11px;
  margin:2px;
  font-weight:600;
  cursor:default;
}
#bulkTimeManagerModal .btm-chip.wed{background:#5856d622;border-color:#5856d6aa;color:#4b49c8;}
#bulkTimeManagerModal .btm-note{
  font-size:11px;
  line-height:1.6;
  background:#fff9e6;
  border:1px solid #ffe3a3;
  padding:10px 12px;
  border-radius:8px;
  color:#8a6113;
}
@media (max-width:1200px){
  #bulkTimeManagerModal .btm-right{width:280px;}
}
@media (max-width:960px){
  #bulkTimeManagerModal .btm-wrapper{width:96%;height:94%;}
  #bulkTimeManagerModal .btm-right{display:none;}
  #bulkTimeManagerModal .btm-left{padding:10px;}
}
/* ===== BTM ç­›é€‰åŠŸèƒ½æ–°å¢æ ·å¼ BEGIN ===== */
.btm-filter-bar{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin:4px 0 14px;
  background:#f2f5f9;
  padding:10px 12px;
  border:1px solid #e0e4ea;
  border-radius:10px;
}
.btm-filter-bar input,
.btm-filter-bar select{
  padding:8px 10px;
  border:2px solid #d6dae2;
  border-radius:8px;
  font-size:13px;
  outline:none;
  min-width:140px;
  background:#fff;
  transition:.25s;
}
.btm-filter-bar input:focus,
.btm-filter-bar select:focus{
  border-color:#007AFF;
  box-shadow:0 0 0 3px rgba(0,122,255,.15);
}
#btmFilterResetBtn{
  background:#4e5d78;
  color:#fff;
  padding:8px 16px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  transition:.25s;
}
#btmFilterResetBtn:hover{
  background:#3d4a63;
  transform:translateY(-2px);
}
.btm-filter-empty{
  font-size:13px;
  color:#999;
  padding:12px 4px 4px;
  font-style:italic;
}
/* è‡ªé€‚åº” */
@media (max-width:680px){
  .btm-filter-bar{
    flex-direction:column;
    align-items:stretch;
  }
  .btm-filter-bar input,
  .btm-filter-bar select{
    width:100%;
    min-width:unset;
  }
  #btmFilterResetBtn{
    width:100%;
  }
}
/* ===== BTM ç­›é€‰åŠŸèƒ½æ–°å¢æ ·å¼ END ===== */
/* === æ¥¼å±‚å¿«é€Ÿåˆ‡æ¢æ¡ï¼ˆæ–°å¢ï¼‰ === */
.floor-switch-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 0 0 14px;
}

.floor-switch-btn {
    background: #ecf0f1;
    color: #34495e;
    border: none;
    padding: 6px 14px;
    border-radius: 22px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    line-height: 1;
    transition: .25s;
}

.floor-switch-btn:hover {
    background: var(--hover-color);
    color: #fff;
}

.floor-switch-btn.active {
    background: var(--primary-color);
    color: #fff;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0,0,0,.15);
    cursor: default;
}

</style>
</head>
<body>
<!-- ===== ç¼“å­˜æ˜¾ç¤º ===== -->
<div id="cacheInfo" class="cache-info" style="display:none;">
  <div class="cache-size" id="cacheSize">è®¡ç®—ä¸­...</div>
  <div class="cache-percentage" id="cachePercentage">0%</div>
  <div class="cache-details" id="cacheDetails">è¯¦æƒ…</div>
</div>

<div id="systemContent" style="display:none;">
  <h1>è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ç´æˆ¿ç®¡ç†ç³»ç»Ÿ</h1>
  <div id="currentTime" style="text-align:center;font-size:20px;font-weight:600;"></div>
  <div id="autoResetInfo" class="auto-reset-info" style="text-align:center;font-size:.9em;color:#7f8c8d;margin-top:10px;margin-bottom:20px;">


    ç³»ç»Ÿå°†åœ¨æ¯å¤©æ™šä¸Š21:45è‡ªåŠ¨é‡ç½®æ‰€æœ‰ç´æˆ¿çŠ¶æ€
  </div>

  <!-- æœç´¢åŠŸèƒ½ -->
  <div class="search-section">
    <div class="search-container">
      <input type="text" id="globalSearch" placeholder="æœç´¢å­¦ç”Ÿæˆ–ç´æˆ¿...">
      <button onclick="clearSearch()" id="clearSearchBtn" class="clear-btn" style="display:none;">å…³é—­</button>
    </div>
    <div id="searchResults" class="search-results" style="display:none;"></div>
  </div>

  <!-- æ—¶é—´è½´æ§åˆ¶ -->
  <div class="timeline-control-container">
    <button class="timeline-control-btn" id="timelineMainControlBtn" onclick="toggleTimeline()">
      <span class="timeline-control-icon">â°</span>
      <span class="timeline-control-text">æ˜¾ç¤ºç´æˆ¿çŠ¶æ€é¢„æµ‹</span>
    </button>
  </div>

<!-- çŠ¶æ€èšç„¦ï¼š15åˆ†é’Ÿå†…é‡Šæ”¾ + è¶…æ—¶ -->
<div class="timeline-section" id="timelineSection">
  <div class="focus-header" style="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;">
    <h3 style="margin:0;display:flex;align-items:center;gap:8px;color:#e67e22;">â° å³å°†é‡Šæ”¾ä¸è¶…æ—¶ç›‘æ§</h3>
    <div class="focus-tools" style="display:flex;gap:8px;flex-wrap:wrap;">
      <select id="focusTypeFilter" onchange="filterFocusCards()" style="padding:6px 8px;border:1px solid var(--border-color);border-radius:6px;font-size:12px;">
        <option value="">æ‰€æœ‰ç±»å‹</option>
        <option value="ä¸‰è§’é’¢ç´">ä¸‰è§’é’¢ç´</option>
        <option value="ç«‹å¼é’¢ç´">ç«‹å¼é’¢ç´</option>
        <option value="æ— é’¢ç´">æ— é’¢ç´</option>
      </select>
    </div>
  </div>

  <div class="focus-groups">
    <!-- 15 åˆ†é’Ÿå†…é‡Šæ”¾ -->
    <div class="focus-group soon" data-group="soon">
      <div class="focus-group-header">
        <div class="focus-group-title">ğŸ•’ 15 åˆ†é’Ÿå†…é‡Šæ”¾ <span id="focusSoonCount">0</span></div>
        <div class="focus-group-sub">å‰©ä½™ â‰¤ 15 åˆ†é’Ÿçš„æ­£åœ¨ä½¿ç”¨ç´æˆ¿</div>
      </div>
      <div class="focus-group-body" id="focusSoonBody">
        <div class="focus-empty">æš‚æ—  15 åˆ†é’Ÿå†…å°†é‡Šæ”¾çš„ç´æˆ¿</div>
      </div>
    </div>

    <!-- è¶…æ—¶ -->
    <div class="focus-group overtime" data-group="overtime">
      <div class="focus-group-header">
        <div class="focus-group-title">â›” è¶…æ—¶ä½¿ç”¨ <span id="focusOverCount">0</span></div>
        <div class="focus-group-sub">å·²è¶…è¿‡åŸºç¡€ç»ƒç´æ—¶é•¿</div>
      </div>
      <div class="focus-group-body" id="focusOverBody">
        <div class="focus-empty">æš‚æ— è¶…æ—¶ç´æˆ¿</div>
      </div>
    </div>
  </div>

  <div class="focus-foot-note">
    è¯´æ˜ï¼šå‡†å¤‡é˜¶æ®µ 1 åˆ†é’Ÿåå¼€å§‹è®¡æ—¶ï¼›ä»…åœ¨å‡†å¤‡ç»“æŸåä¸”å‰©ä½™ â‰¤ 15 åˆ†é’Ÿæ—¶åˆ—å…¥â€œ15 åˆ†é’Ÿå†…é‡Šæ”¾â€ï¼›è¶…è¿‡åŸºç¡€ç»ƒç´æ—¶é•¿åˆ—å…¥â€œè¶…æ—¶â€ã€‚
  </div>
</div>
  <!-- å¿«é€Ÿéœ€æ±‚ -->
  <div class="panel secondary">
    <h3 style="margin-top:0;color:var(--secondary-color);">å¿«é€Ÿéœ€æ±‚</h3>
    <p class="text-muted" style="font-size:15px;line-height:1.4;margin-top:4px;">
  æ ¹æ®ç´æˆ¿ç±»å‹å¿«é€ŸæŸ¥æ‰¾å¯ç”¨ç´æˆ¿æˆ–åŠ å…¥æ’é˜Ÿ<br>
      <span style="color:#e67e22; font-size:13px;">æ³¨æ„ï¼šæœ‰äººæ’é˜Ÿæ—¶éœ€å…ˆæ’é˜Ÿï¼ˆå…ˆåˆ°å…ˆå¾—ï¼‰</span><br>
    </p>
    <div class="demand-buttons">
      <button class="demand-btn grand-piano" onclick="handleDemandRequest('grand')">
        <div>ğŸ¹ ä¸‰è§’ç´æˆ¿</div>
        <div id="grandStatus" style="font-size:.75em;margin-top:6px;">æ£€æŸ¥ä¸­...</div>
      </button>
      <button class="demand-btn upright-piano" onclick="handleDemandRequest('upright')">
        <div>ğŸ¹ ç«‹å¼ç´æˆ¿</div>
        <div id="uprightStatus" style="font-size:.75em;margin-top:6px;">æ£€æŸ¥ä¸­...</div>
      </button>
      <button class="demand-btn no-piano" onclick="handleDemandRequest('none')">
        <div>ğŸµ æ™®é€šç´æˆ¿</div>
        <div id="noneStatus" style="font-size:.75em;margin-top:6px;">æ£€æŸ¥ä¸­...</div>
      </button>
    </div>
  </div>

  <!-- æ’é˜Ÿç³»ç»Ÿ -->
  <div class="panel queue">
    <div class="queue-header">
      <h3 class="queue-title">æ’é˜Ÿç³»ç»Ÿ</h3>
    </div>

    <div class="queue-subsection" id="grandQueueSection">
      <div class="queue-subheader">
        <h4 style="margin:0;">ä¸‰è§’ç´æˆ¿æ’é˜Ÿ</h4>
      </div>
      <div class="queue-list" id="grandQueueList">
        <div class="empty-queue">æš‚æ— æ’é˜Ÿå­¦ç”Ÿ</div>
      </div>
    </div>

    <div class="queue-subsection" id="uprightQueueSection">
      <div class="queue-subheader">
        <h4 style="margin:0;">ç«‹å¼ç´æˆ¿æ’é˜Ÿ</h4>
      </div>
      <div class="queue-list" id="uprightQueueList">
        <div class="empty-queue">æš‚æ— æ’é˜Ÿå­¦ç”Ÿ</div>
      </div>
    </div>

    <div class="queue-subsection" id="noneQueueSection">
      <div class="queue-subheader">
        <h4 style="margin:0;">æ™®é€šç´æˆ¿æ’é˜Ÿ</h4>
      </div>
      <div class="queue-list" id="noneQueueList">
        <div class="empty-queue">æš‚æ— æ’é˜Ÿå­¦ç”Ÿ</div>
      </div>
    </div>
  </div>
  <!-- ç´æˆ¿æ˜¾ç¤ºå®¹å™¨ -->
  <div id="rooms" class="fade-in"></div>
  <div id="utilizationRate" style="text-align:center;font-size:1.05em;color:var(--primary-color);margin:15px 0;"></div>

  <!-- ç®¡ç†æ“ä½œ -->
  <div class="admin-controls" style="text-align:center;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;">
    <button onclick="manualReset()">æ‰‹åŠ¨é‡ç½®ç³»ç»Ÿ</button>
    <button onclick="lockSystem()">é”å®šç³»ç»Ÿ</button>
    <button onclick="exportPracticeLogs()">å¯¼å‡ºç»ƒç´æ—¥å¿—</button>
    <button onclick="backupSystemData()">å¤‡ä»½ç³»ç»Ÿæ•°æ®</button>
    <button onclick="restoreSystemData()">æ¢å¤ç³»ç»Ÿæ•°æ®</button>
    <button onclick="viewOperationLogs()">æŸ¥çœ‹æ“ä½œæ—¥å¿—</button>
    <button onclick="clearLocalStorage()">æ¸…ç†ç¼“å­˜</button>
    <button onclick="manageStudentDatabase()">ç®¡ç†å­¦ç”Ÿåº“</button>
    <button onclick="manageRoomDatabase()">ç®¡ç†ç´æˆ¿åº“</button>
    <button onclick="openSettingsModal()">ç³»ç»Ÿè®¾ç½®</button>
    <button onclick="openAttendanceModal()" style="background:#e67e22;">è€ƒå‹¤æ£€æŸ¥</button>
    <button class="overtime-manage-btn" onclick="openOvertimeModal()" style="background:var(--danger-color);">è¶…æ—¶ç®¡ç†</button>


  </div>
</div>

<!-- å…¬ç”¨æç¤º -->
<div id="toast" class="toast"></div>

<!-- å„æ¨¡æ€ (ä¿æŒåŸ ID) -->
<div id="studentListModal"><div class="modal-content mid">
  <span class="close" onclick="closeModal()">&times;</span>
  <h2>é€‰æ‹©å­¦ç”Ÿ</h2>
  <input type="text" id="modalStudentSearch" placeholder="æœç´¢æˆ–æ·»åŠ æ–°å­¦ç”Ÿ (æ”¯æŒâ†‘â†“é”®é€‰æ‹©ï¼Œå›è½¦ç¡®è®¤)" oninput="searchStudentsModal(this.value)" style="width:100%;margin-bottom:12px;">
  <div id="modalStudentList" style="max-height:320px;overflow:auto;border:1px solid var(--border-color);border-radius:8px;padding:6px;"></div>
  <div id="addNewStudentSection" style="display:none;margin-top:10px;">
    <button onclick="addNewStudent()">æ·»åŠ æ–°å­¦ç”Ÿ</button>
  </div>
</div></div>

<div id="queueStudentModal"><div class="modal-content mid">
  <span class="close" onclick="closeQueueStudentModal()">&times;</span>
  <h2>é€‰æ‹©æ’é˜Ÿå­¦ç”Ÿ</h2>
  <input type="text" id="queueStudentSearch" placeholder="æœç´¢æˆ–æ·»åŠ æ–°å­¦ç”Ÿ (æ”¯æŒâ†‘â†“é”®é€‰æ‹©ï¼Œå›è½¦ç¡®è®¤)" oninput="searchQueueStudents(this.value)" style="width:100%;margin-bottom:12px;">
  <div id="queueStudentList" style="max-height:320px;overflow:auto;border:1px solid var(--border-color);border-radius:8px;padding:6px;"></div>
  <div id="addNewQueueStudentSection" style="display:none;margin-top:10px;">
    <button onclick="addNewQueueStudent()">æ·»åŠ æ–°å­¦ç”Ÿåˆ°æ’é˜Ÿ</button>
  </div>
</div></div>

<div id="queueModal"><div class="modal-content">
  <span class="close" onclick="closeQueueModal()">&times;</span>
  <h2 id="queueModalTitle">é€‰æ‹©æ’é˜Ÿå­¦ç”Ÿ</h2>
  <div id="queueModalList" style="max-height:320px;overflow:auto;"></div>
</div></div>

<div id="availableRoomsModal"><div class="modal-content mid">
  <span class="close" onclick="closeAvailableRoomsModal()">&times;</span>
  <h2 id="availableRoomsTitle">é€‰æ‹©ç´æˆ¿</h2>
  <div id="availableRoomsInfo" style="margin-bottom:10px;"></div>
  <div id="availableRoomsList"></div>
</div></div>

<div id="replaceableRoomsModal"><div class="modal-content mid">
  <span class="close" onclick="closeReplaceableRoomsModal()">&times;</span>
  <h2 id="replaceableRoomsTitle">é€‰æ‹©è¦æ›¿æ¢çš„ç´æˆ¿</h2>
  <div id="replaceableRoomsInfo" style="margin-bottom:10px;"></div>
  <div id="replaceableRoomsList"></div>
</div></div>

<div id="studentDatabaseModal"><div class="modal-content wide">
  <span class="close" onclick="closeStudentDatabaseModal()">&times;</span>
  <h2>å­¦ç”Ÿåº“ç®¡ç†</h2>
<div class="student-db-controls" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;align-items:center;">
    <input type="text" id="studentDbSearch" placeholder="æœç´¢å­¦ç”Ÿå§“å..."style="flex:1;min-width:200px;">
    <select id="majorFilter" onchange="filterByMajor()"><option value="">æ‰€æœ‰ä¸“ä¸š</option></select>
    <select id="gradeFilter" onchange="filterByGrade()"><option value="">æ‰€æœ‰å¹´çº§</option></select>
    <button onclick="addNewStudentToDatabase()">æ·»åŠ æ–°å­¦ç”Ÿ</button>
    <button onclick="exportStudentDatabase()" style="background:var(--success-color);">å¯¼å‡ºå­¦ç”Ÿåº“</button>
    <input type="file" id="importStudentFile" accept=".json,.csv" style="display:none;" onchange="importStudentDatabase(event)">
    <button onclick="document.getElementById('importStudentFile').click()" style="background:var(--warning-color);" title="æ”¯æŒJSONå’ŒCSVæ ¼å¼ï¼Œæ”¯æŒå¹´çº§G1-G12æ ¼å¼">å¯¼å…¥å­¦ç”Ÿåº“</button>
    <button onclick="openBulkTimeManager()" style="background:#007AFF;">æ‰¹é‡ç®¡ç†æ—¶é—´æ®µ</button>
</div>
  <div id="studentDatabaseList" style="max-height:400px;overflow:auto;border:1px solid var(--border-color);border-radius:8px;margin-bottom:10px;"></div>
  <div id="studentDbStats" class="student-db-stats"></div>
</div></div>

<div id="editStudentModal"><div class="modal-content">
  <span class="close" onclick="closeEditStudentModal()">&times;</span>
  <h2>ç¼–è¾‘å­¦ç”Ÿä¿¡æ¯</h2>
  <div class="form-group" style="margin-bottom:12px;">
    <label for="editStudentName" style="display:inline-block;width:80px;font-weight:600;">å§“åï¼š</label>
    <input type="text" id="editStudentName" placeholder="è¯·è¾“å…¥å­¦ç”Ÿå§“å" style="width:calc(100% - 90px);">
  </div>
  <div class="form-group" style="margin-bottom:12px;">
    <label for="editStudentMajor" style="display:inline-block;width:80px;font-weight:600;">ä¸“ä¸šï¼š</label>
    <select id="editStudentMajor" style="width:calc(100% - 90px);"></select>
  </div>
  <div class="form-group" style="margin-bottom:12px;">
    <label for="editStudentGrade" style="display:inline-block;width:80px;font-weight:600;">å¹´çº§ï¼š</label>
    <input type="text" id="editStudentGrade" placeholder="å¦‚ï¼šG1, G12, 1å¹´çº§ç­‰" style="width:calc(100% - 90px);" title="æ”¯æŒæ ¼å¼ï¼šG1-G12, 1-12, 1å¹´çº§-12å¹´çº§">
  </div>
  <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
    <button onclick="saveStudentChanges()">ä¿å­˜ä¿®æ”¹</button>
    <button onclick="closeEditStudentModal()" class="clear-btn">å–æ¶ˆ</button>
  </div>
</div></div>

<div id="majorSelectionModal"><div class="modal-content" style="max-width:420px;">
  <span class="close" onclick="closeMajorSelectionModal()">&times;</span>
  <h2>é€‰æ‹©æˆ–åˆ›å»ºä¸“ä¸š</h2>
  <div id="existingMajors" style="margin-bottom:15px;">
    <h4 style="margin:0 0 10px;color:var(--primary-color);text-align:left;">ç°æœ‰ä¸“ä¸šï¼š</h4>
    <div id="majorButtonsList" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
  </div>
  <div style="border-top:1px solid var(--border-color);padding-top:15px;">
    <h4 style="margin:0 0 10px;color:var(--secondary-color);text-align:left;">åˆ›å»ºæ–°ä¸“ä¸šï¼š</h4>
    <input type="text" id="newMajorInput" placeholder="è¾“å…¥æ–°ä¸“ä¸šåç§°" style="width:100%;margin-bottom:10px;">
    <button onclick="createNewMajor()" style="width:100%;">åˆ›å»ºæ–°ä¸“ä¸š</button>
  </div>
</div></div>

<div id="roomDatabaseModal"><div class="modal-content wide">
  <span class="close" onclick="closeRoomDatabaseModal()">&times;</span>
  <h2>ç´æˆ¿åº“ç®¡ç†</h2>
  <div class="room-db-controls">
<div id="roomQuickAdd" style="display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 12px;">
  <input type="text" id="newRoomNameInput" placeholder="åç§°" style="flex:0 0 120px;">
  <input type="text" id="newRoomLocationInput" placeholder="ä½ç½®(å¯é€‰)" style="flex:0 0 120px;">
  <select id="newRoomTypeSelect" style="flex:0 0 110px;">
    <option value="ä¸‰è§’é’¢ç´">ä¸‰è§’é’¢ç´</option>
    <option value="ç«‹å¼é’¢ç´">ç«‹å¼é’¢ç´</option>
    <option value="æ— é’¢ç´">æ— é’¢ç´</option>
  </select>
  <input type="text" id="newRoomRemarkInput" placeholder="å¤‡æ³¨(å¯é€‰)" style="flex:1;min-width:140px;">
  <button style="flex:0 0 90px;" onclick="roomDbAddRoom()">æ–°å¢</button>
</div>
    <input type="text" id="roomSearchInput" placeholder="æŒ‰åç§°/å¤‡æ³¨æœç´¢..." oninput="displayRoomDatabase()">
    <select id="roomLocationFilter" onchange="displayRoomDatabase()"><option value="">æ‰€æœ‰ä½ç½®</option></select>
    <select id="roomTypeFilter" onchange="displayRoomDatabase()">
      <option value="">æ‰€æœ‰ç±»å‹</option>
      <option value="ä¸‰è§’é’¢ç´">ä¸‰è§’é’¢ç´</option>
      <option value="ç«‹å¼é’¢ç´">ç«‹å¼é’¢ç´</option>
      <option value="æ— é’¢ç´">æ— é’¢ç´</option>
    </select>
    <button class="import-room-btn" onclick="importRoomDatabase()">å¯¼å…¥ç´æˆ¿åº“</button>
    <button class="export-btn" onclick="exportRoomDatabase()">å¯¼å‡ºç´æˆ¿åº“</button>
  </div>
  <div class="small-tip" style="font-size:11px;color:#888;margin:4px 0 10px;">æç¤ºï¼šä¿®æ”¹ç±»å‹ä¼šå³æ—¶å½±å“åˆ†ç±»ï¼›å·²å ç”¨ç´æˆ¿åç§°ä¸æ”¯æŒæ›´åï¼ˆç»Ÿä¸€ä¿ç•™ï¼‰</div>
  <div id="roomDatabaseList" style="border:1px solid var(--border-color);border-radius:8px;max-height:480px;overflow:auto;"></div>
  <div class="room-db-stats" id="roomDbStats"></div>
</div></div>

<div id="timeSlotModal"><div class="modal-content time-slot-modal-content">
  <span class="close" onclick="closeTimeSlotModal()">&times;</span>
  <h2 id="timeSlotModalTitle">ç®¡ç†ç»ƒç´æ—¶é—´æ®µ</h2>
  <div class="weekday-selector" style="margin-bottom:15px;padding:15px;background:#f8f9fa;border-radius:8px;border:1px solid var(--border-color);">
    <h4 style="margin:0 0 10px;color:var(--primary-color);">é€‰æ‹©æ˜ŸæœŸï¼š</h4>
    <div class="weekday-buttons">
      <button class="weekday-btn active" data-day="monday" onclick="selectWeekday('monday')">å‘¨ä¸€</button>
      <button class="weekday-btn" data-day="tuesday" onclick="selectWeekday('tuesday')">å‘¨äºŒ</button>
      <button class="weekday-btn" data-day="wednesday" onclick="selectWeekday('wednesday')">å‘¨ä¸‰</button>
      <button class="weekday-btn" data-day="thursday" onclick="selectWeekday('thursday')">å‘¨å››</button>
      <button class="weekday-btn" data-day="friday" onclick="selectWeekday('friday')">å‘¨äº”</button>
    </div>
  </div>
  <div class="time-input-group" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px;">
    <label style="font-weight:600;">å¼€å§‹æ—¶é—´:</label>
    <select id="startHour"></select><span>:</span><select id="startMinute"></select>
  </div>
  <div class="time-input-group" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:15px;">
    <label style="font-weight:600;">ç»“æŸæ—¶é—´:</label>
    <select id="endHour"></select><span>:</span><select id="endMinute"></select>
  </div>
  <div style="text-align:center;margin-bottom:18px;">
    <button onclick="addTimeSlot()" style="background:var(--secondary-color);">æ·»åŠ æ—¶é—´æ®µ</button>
  </div>
  <div class="weekly-summary">
    <h4 style="margin:0 0 10px;color:var(--primary-color);">æœ¬å‘¨æ—¶é—´æ®µæ±‡æ€»ï¼š</h4>
    <div id="weeklySummaryDisplay"></div>
    <div style="text-align:center;margin-top:15px;">
      <button onclick="clearAllTimeSlots()" style="background:var(--danger-color);">æ¸…ç©ºå…¨éƒ¨æ—¶é—´æ®µ</button>
    </div>
  </div>
  <div class="current-time-slots" style="background:#f8f9fa;padding:15px;border-radius:8px;">
    <h4 id="currentDayTitle" style="margin:0 0 10px;">å‘¨ä¸€æ—¶é—´æ®µï¼š</h4>
    <div id="currentTimeSlotsList"></div>
  </div>
</div></div>
<div id="bulkTimeManagerModal" style="display:none;">
  <div class="btm-wrapper">
    <div class="btm-header">
      <div class="btm-title">æ‰¹é‡ç»ƒç´æ—¶é—´æ®µç®¡ç†</div>
      <div class="btm-actions">
        <button class="btm-btn btm-secondary" onclick="BTM.clearAllSelections()">æ¸…ç©ºå…¨éƒ¨é€‰æ‹©</button>
        <button class="btm-btn btm-primary" onclick="BTM.applyAndSave()">ä¿å­˜å¹¶åŒæ­¥</button>
        <button class="btm-btn btm-danger" onclick="closeBulkTimeManager()">å…³é—­</button>
      </div>
    </div>
    <div class="btm-body">
      <div class="btm-left">
        <div class="btm-student-bar">
            <select id="btmStudentSelect" onchange="BTM.selectStudent()" class="btm-select"></select>
            <div class="btm-stu-nav">
              <button onclick="BTM.prevStudent()">â†</button>
              <button onclick="BTM.nextStudent()">â†’</button>
            </div>
          </div>

          <!-- ç­›é€‰å·¥å…·æ¡ï¼ˆæ–°å¢ï¼‰ -->
          <div class="btm-filter-bar">
            <input type="text" id="btmSearchInput" placeholder="æœç´¢å­¦ç”Ÿå§“å (æ”¯æŒæ‹¼éŸ³é¦–å­—æ¯)" />
            <select id="btmMajorFilter"></select>
            <select id="btmGradeFilter"></select>
            <button id="btmFilterResetBtn" onclick="BTM.resetFilters()">é‡ç½®</button>
          </div>

        <div class="btm-stu-info" id="btmStudentInfo"></div>
        <div class="btm-legend">
          <span><b style="background:#007aff33;border:1px solid #007aff66;width:16px;height:16px;display:inline-block;border-radius:4px;margin-right:4px;"></b>å¯é€‰</span>
          <span><b style="background:#007AFF;color:#fff;border:1px solid #0060c8;width:16px;height:16px;display:inline-block;border-radius:4px;margin-right:4px;"></b>å·²é€‰</span>
          <span><b style="background:#555;color:#fff;border:1px solid #333;width:16px;height:16px;display:inline-block;border-radius:4px;margin-right:4px;"></b>ä¼‘æ¯/åˆé¤</span>
        </div>
        <div class="btm-table-wrap">
          <table class="btm-table" id="btmTable">
            <thead>
              <tr>
                <th class="btm-time-col">æ—¶é—´æ®µ</th>
                <th>å‘¨ä¸€</th>
                <th>å‘¨äºŒ</th>
                <th>å‘¨ä¸‰</th>
                <th>å‘¨å››</th>
                <th>å‘¨äº”</th>
              </tr>
            </thead>
            <tbody id="btmTbody"></tbody>
          </table>
        </div>
      </div>
      <div class="btm-right">
        <div class="btm-summary-title">å½“å‰å­¦ç”Ÿå·²é€‰æ—¶é—´æ®µ</div>
        <div id="btmSelectedList" class="btm-selected-list"></div>
        <div class="btm-note">
          è¯´æ˜ï¼š<br>
          1) æ­¤ç•Œé¢åŸºäºå›ºå®šèŠ‚æ¬¡ï¼ˆé€‚åˆæ ‡å‡†å¿«é€Ÿæ ‡è®°ï¼‰ï¼›<br>
          2) ä¿å­˜åä¼šè¦†ç›–è¯¥å­¦ç”Ÿå¯¹åº”èŠ‚æ¬¡çš„åŸæœ‰æ—¶é—´æ®µï¼ˆä»…å¯¹åº”åˆ°èƒ½åŒ¹é…çš„å›ºå®šæ—¶æ®µï¼Œä¸ä¼šåˆ é™¤ä¸åœ¨è¡¨é‡Œçš„è‡ªå®šä¹‰ 10 åˆ†é’ŸèŠ‚æ¬¡ï¼‰ï¼›<br>
          3) å‘¨ä¸‰å«æ‹†åˆ†èŠ‚æ¬¡ï¼ˆåˆé—´/ä¸‹åˆå¤šä¸ªå­æ®µï¼‰ï¼›<br>
          4) ä¿å­˜å¹¶åŒæ­¥ä¼šè§¦å‘æœ¬åœ°æŒä¹…åŒ–ä¸ï¼ˆåœ¨çº¿æ—¶ï¼‰äº‘åŒæ­¥ã€‚<br>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="settingsModal"><div class="modal-content settings-modal-content">
  <span class="close" onclick="closeSettingsModal()">&times;</span>
  <h2>ç³»ç»Ÿè®¾ç½®</h2>
  
  <!-- ç»ƒç´æ—¶é•¿è®¾ç½® -->
  <div class="settings-section">
    <h3>â° ç»ƒç´æ—¶é•¿è®¾ç½®</h3>
    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">åŸºç¡€ç»ƒç´æ—¶é•¿</div>
        <div class="setting-description">è¶…è¿‡è¯¥æ—¶é•¿å°†è¢«æ ‡è®°ä¸ºè¶…æ—¶ä½¿ç”¨ï¼ˆå»ºè®®èŒƒå›´ï¼š60-180åˆ†é’Ÿï¼‰</div>
        <div class="setting-preview" id="durationPreview">å½“å‰è®¾ç½®ï¼š120åˆ†é’Ÿ</div>
      </div>
      <div class="setting-control">
        <div class="input-group">
          <input type="number" id="baseDurationInput" class="setting-input" min="1" max="240" value="120" onchange="updateDurationPreview()">
          <span class="input-unit">åˆ†é’Ÿ</span>
        </div>
        <div class="setting-range">
          <small>èŒƒå›´ï¼š1-240åˆ†é’Ÿ</small>
        </div>
      </div>
    </div>
  </div>

  <!-- è‡ªåŠ¨é‡ç½®è®¾ç½® -->
  <div class="settings-section">
    <h3>ğŸ”„ è‡ªåŠ¨é‡ç½®è®¾ç½®</h3>
    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">æ¯æ—¥é‡ç½®æ—¶é—´</div>
        <div class="setting-description">ç³»ç»Ÿå°†åœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨æ¸…ç©ºæ‰€æœ‰ç´æˆ¿å ç”¨çŠ¶æ€å’Œæ’é˜Ÿä¿¡æ¯</div>
        <div class="setting-preview" id="resetTimePreview">å½“å‰è®¾ç½®ï¼š21:45</div>
      </div>
      <div class="setting-control">
        <div class="time-input-group">
          <div class="time-input">
            <input type="number" id="resetHourInput" class="setting-input time-input-field" min="0" max="23" value="21" onchange="updateResetTimePreview()">
            <label>æ—¶</label>
          </div>
          <div class="time-separator">:</div>
          <div class="time-input">
            <input type="number" id="resetMinuteInput" class="setting-input time-input-field" min="0" max="59" value="45" onchange="updateResetTimePreview()">
            <label>åˆ†</label>
          </div>
        </div>
      </div>
    </div>
    
    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">å¼‚å¸¸æ£€æŸ¥å¼€å§‹æ—¶é—´</div>
        <div class="setting-description">æ¯å¤©å‡ ç‚¹å¼€å§‹è¿›è¡Œç»ƒç´å¼‚å¸¸æé†’æ£€æŸ¥</div>
        <div class="setting-preview" id="startAnomalyPreview">å½“å‰è®¾ç½®ï¼š08:00å¼€å§‹</div>
      </div>
      <div class="setting-control">
        <div class="time-input-group">
          <div class="time-input">
            <input type="number" id="startAnomalyHourInput" class="setting-input time-input-field" min="0" max="23" value="8" onchange="updateStartAnomalyPreview()">
            <label>æ—¶</label>
          </div>
          <div class="time-separator">:</div>
          <div class="time-input">
            <input type="number" id="startAnomalyMinuteInput" class="setting-input time-input-field" min="0" max="59" value="0" onchange="updateStartAnomalyPreview()">
            <label>åˆ†</label>
          </div>
        </div>
      </div>
    </div>
    
    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">å¼‚å¸¸æ£€æŸ¥åœæ­¢æ—¶é—´</div>
        <div class="setting-description">æ¯å¤©è¶…è¿‡æŒ‡å®šæ—¶é—´ååœæ­¢ç»ƒç´å¼‚å¸¸æé†’æ£€æŸ¥ï¼Œé¿å…æ·±å¤œè¯¯æŠ¥</div>
        <div class="setting-preview" id="stopAnomalyPreview">å½“å‰è®¾ç½®ï¼š19:00ååœæ­¢</div>
      </div>
      <div class="setting-control">
        <div class="time-input-group">
          <div class="time-input">
            <input type="number" id="stopAnomalyHourInput" class="setting-input time-input-field" min="0" max="23" value="19" onchange="updateStopAnomalyPreview()">
            <label>æ—¶</label>
          </div>
          <div class="time-separator">:</div>
          <div class="time-input">
            <input type="number" id="stopAnomalyMinuteInput" class="setting-input time-input-field" min="0" max="59" value="0" onchange="updateStopAnomalyPreview()">
            <label>åˆ†</label>
          </div>
        </div>
      </div>
    </div>

  </div>
  <!-- è‡ªåŠ¨é”å®šè®¾ç½® -->
  <div class="settings-section">
    <h3>ğŸ”’ è‡ªåŠ¨é”å®šè®¾ç½®</h3>
    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">è‡ªåŠ¨é”å®šæ—¶é—´</div>
        <div class="setting-description">ç³»ç»Ÿåœ¨æŒ‡å®šæ—¶é—´æ— æ“ä½œåè‡ªåŠ¨é”å®šï¼ˆå»ºè®®èŒƒå›´ï¼š5-60åˆ†é’Ÿï¼‰</div>
        <div class="setting-preview" id="autoLockPreview">å½“å‰è®¾ç½®ï¼š10åˆ†é’Ÿ</div>
      </div>
      <div class="setting-control">
        <div class="input-group">
          <input type="number" id="autoLockTimeInput" class="setting-input" min="1" max="120" value="10" onchange="updateAutoLockPreview()">
          <span class="input-unit">åˆ†é’Ÿ</span>
        </div>
        <div class="setting-range">
          <small>èŒƒå›´ï¼š1-120åˆ†é’Ÿ</small>
        </div>
      </div>
    </div>
    
    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">å¯ç”¨è‡ªåŠ¨é”å®š</div>
        <div class="setting-description">å…³é—­æ­¤é€‰é¡¹å°†å®Œå…¨ç¦ç”¨è‡ªåŠ¨é”å®šåŠŸèƒ½</div>
      </div>
      <div class="setting-control">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="autoLockEnabledInput" checked onchange="updateAutoLockPreview()">
          <span>å¯ç”¨è‡ªåŠ¨é”å®š</span>
        </label>
      </div>
    </div>
  </div>

  <!-- å®‰å…¨è®¾ç½® -->
  <div class="settings-section security-section">
    <h3>ğŸ” å®‰å…¨è®¾ç½®</h3>
    <div class="security-notice">
      <div class="notice-icon">âš ï¸</div>
      <div class="notice-text">
        <strong>é‡è¦æé†’ï¼š</strong>ä¿®æ”¹ç™»å½•å¯†ç æ—¶å¿…é¡»æä¾›ç®¡ç†å‘˜å¯†ç è¿›è¡ŒéªŒè¯
      </div>
    </div>
    
    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">ä¿®æ”¹ç™»å½•å¯†ç </div>
        <div class="setting-description">ç”¨äºç³»ç»Ÿè§£é”çš„å¯†ç ï¼Œç•™ç©ºåˆ™ä¸ä¿®æ”¹å½“å‰å¯†ç </div>
      </div>
      <div class="setting-control">
        <div class="password-input-group">
          <input type="password" id="loginPasswordInput" class="setting-input password-field" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆå¯é€‰ï¼‰">
          <button type="button" class="password-toggle" onclick="togglePasswordVisibility('loginPasswordInput')" title="æ˜¾ç¤º/éšè—å¯†ç ">
            ğŸ‘ï¸
          </button>
        </div>
      </div>
    </div>
    
    <div class="setting-item">
      <div class="setting-info">
        <div class="setting-label">ç®¡ç†å‘˜å¯†ç éªŒè¯</div>
        <div class="setting-description admin-required">ä¿®æ”¹ç™»å½•å¯†ç æ—¶å¿…é¡»å¡«å†™æ­¤é¡¹è¿›è¡Œèº«ä»½éªŒè¯</div>
      </div>
      <div class="setting-control">
        <div class="password-input-group">
          <input type="password" id="adminPasswordInput" class="setting-input password-field" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
          <button type="button" class="password-toggle" onclick="togglePasswordVisibility('adminPasswordInput')" title="æ˜¾ç¤º/éšè—å¯†ç ">
            ğŸ‘ï¸
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ“ä½œæŒ‰é’® -->
  <div class="settings-actions">
    <button class="settings-save-btn" onclick="saveSettings()">
      <span class="btn-icon">ğŸ’¾</span>
      <span>ä¿å­˜è®¾ç½®</span>
    </button>
    <button class="settings-cancel-btn" onclick="closeSettingsModal()">
      <span class="btn-icon">âŒ</span>
      <span>å–æ¶ˆ</span>
    </button>
  </div>
</div></div>

<div id="attendanceModal"><div class="modal-content large">
  <span class="close" onclick="closeAttendanceModal()">&times;</span>
  <div class="attendance-header" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px;padding-right:50px;">
    <h2 class="attendance-title" style="margin:0;display:flex;align-items:center;gap:10px;color:#e67e22;">ğŸ“‹ å­¦ç”Ÿè€ƒå‹¤æ£€æŸ¥
      <span id="attendanceBadge" class="overtime-badge" style="display:none;"></span>
    </h2>
    <div class="attendance-controls" style="display:flex;gap:8px;flex-wrap:wrap;">
      <select id="attendanceMajorFilter" class="attendance-filter" onchange="renderAttendanceList()" style="padding:6px 8px;border:1px solid var(--border-color);border-radius:4px;font-size:12px;">
        <option value="">æ‰€æœ‰ä¸“ä¸š</option>
      </select>
      <select id="attendanceStatusFilter" class="attendance-filter" onchange="renderAttendanceList()" style="padding:6px 8px;border:1px solid var(--border-color);border-radius:4px;font-size:12px;">
        <option value="">æ‰€æœ‰çŠ¶æ€</option>
        <option value="absent">ç¼ºå‹¤</option>
        <option value="present">æ­£å¸¸å‡ºå‹¤</option>
        <option value="low_efficiency">ä½æ•ˆå‡ºå‹¤</option>
        <option value="under_review">å¾…è§‚å¯Ÿ</option>
        <option value="excused">å·²è¯·å‡</option>
        <option value="queuing">æ’é˜Ÿä¸­</option>
        <option value="practicing">ç»ƒç´ä¸­</option>
        <option value="preparing">å‡†å¤‡ä¸­</option>
        <option value="overtime">è¶…æ—¶ç»ƒç´</option>
      </select>
      <button class="btn-mini-primary" onclick="exportAttendanceReport()">å¯¼å‡ºæŠ¥å‘Š</button>
      <!-- ğŸ”¥ æ–°å¢äº‘ç«¯å¯¼å‡ºæŒ‰é’® -->
          <button class="btn-mini-primary" onclick="exportCloudAttendanceReport()" style="background:#e67e22;">â˜ï¸ äº‘ç«¯å¯¼å‡º</button>
    </div>
  </div>
  <div id="attendanceContent"></div>
  <div id="attendanceSummary" class="attendance-summary" style="margin-top:10px;"></div>
</div></div>

<div id="overtimeModal"><div class="modal-content wide">
  <span class="close" onclick="closeOvertimeModal()">&times;</span>
  <div class="overtime-header" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px;padding-right:50px;">
    <h2 style="margin:0;">è¶…æ—¶ç»ƒç´ç®¡ç† <span id="overtimeCountBadge" class="overtime-badge" style="display:none;"></span></h2>
    <div class="overtime-filter-group" style="display:flex;flex-wrap:wrap;gap:8px;">
      <input type="text" id="overtimeSearch" placeholder="æœç´¢å­¦ç”Ÿ/ç´æˆ¿" oninput="renderOvertimeList()" style="padding:6px 8px;border:1px solid var(--border-color);border-radius:4px;font-size:12px;">
      <button class="btn-mini-primary" onclick="renderOvertimeList(true)">åˆ·æ–°</button>
      <button class="btn-mini-danger" onclick="clearAllOvertimeRooms()">å…¨éƒ¨æ¸…ç©º</button>
    </div>
  </div>
  <div class="overtime-tools" style="font-size:12px;color:#666;margin-bottom:10px;">æ˜¾ç¤ºæ‰€æœ‰è¶…æ—¶ç»ƒç´è®°å½•ï¼ŒæŒ‰ç±»å‹åˆ†ç±»å¹¶æŒ‰è¶…æ—¶æ—¶é•¿æ’åº</div>
  <div id="overtimeContent"></div>
  <div id="overtimeStats" class="overtime-stat" style="font-size:12px;color:#555;margin-top:8px;"></div>
</div></div>
<!-- ç»ƒç´çŠ¶æ€æ£€æŸ¥æé†’é¢æ¿ -->
<div id="overrunReminderPanel" class="overrun-panel collapsed" style="display:none;">
  <div class="overrun-panel-header" onclick="toggleOverrunPanel()">
    <div>
      <h4>âš ï¸ å¼‚å¸¸æé†’ <span id="overrunCountBadge" class="overrun-count-badge" style="display:none;">0</span></h4>
      <div class="header-subtitle">ç»ƒç´è¶…å‡ºç»ƒç´æ—¶é—´æ®µç›‘æ§</div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <button onclick="clearAllOverrunReminders();event.stopPropagation();" style="background:#e74c3c;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">
        ğŸ—‘ï¸ ä¸€é”®æ¸…ç©º
      </button>
      <div style="font-size:12px;opacity:.9;">ç‚¹å‡»å…³é—­</div>
    </div>
    <div class="overrun-panel-toggle-tip" onclick="toggleOverrunPanel();event.stopPropagation();">å¼‚å¸¸</div>
  </div>
  <div class="overrun-panel-body" id="overrunPanelBody">
    <div class="overrun-empty">ğŸ‰ æš‚æ— å¼‚å¸¸ç»ƒç´<br><small>ç³»ç»Ÿè¿è¡Œæ­£å¸¸</small></div>
  </div>
  <div class="overrun-panel-footer">
    <strong>ç›‘æ§è§„åˆ™ï¼š</strong>å­¦ç”Ÿåœ¨é¢„å®šç»ƒç´æ—¶é—´æ®µç»“æŸåä»æŒç»­å ç”¨ â‰¥ 15 åˆ†é’Ÿ<br>
    <small>ğŸ’¡ "å¿½ç•¥"ä¸è®¡å…¥è€ƒå‹¤ï¼›"è®°å½•"å°†å†™å…¥è€ƒå‹¤æŠ¥å‘Š</small>
  </div>
</div>



<!-- ===== JS ä¸»è„šæœ¬ï¼ˆé‡æ„åï¼‰ ===== -->
<script>
/* =========================================================
 *  è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ç´æˆ¿ç®¡ç†ç³»ç»Ÿï¼ˆé‡æ„ç‰ˆï¼‰
 *  åˆ†å±‚ç»“æ„ï¼š
 *   1. å¸¸é‡ä¸å·¥å…·
 *   2. æ•°æ®æ¨¡å‹ä¸æŒä¹…åŒ–
 *   3. UI é€šç”¨ï¼ˆæ¨¡æ€ã€Toastã€è§£é”ï¼‰
 *   4. æˆ¿é—´ä¸ç´æˆ¿åº“
 *   5. å­¦ç”Ÿåº“ä¸æ—¶é—´æ®µ
 *   6. æ’é˜Ÿç³»ç»Ÿ
 *   7. å¿«é€Ÿéœ€æ±‚ï¼ˆå¯ç”¨/æ›¿æ¢ï¼‰
 *   8. æ—¶é—´è½´é¢„æµ‹
 *   9. è¶…æ—¶ç®¡ç†
 *  10. è€ƒå‹¤ç³»ç»Ÿ
 *  10-1. ç»ƒç´çŠ¶æ€å¼‚å¸¸æé†’
 *  11. ç³»ç»Ÿè®¾ç½® / å¤‡ä»½æ¢å¤ / æ—¥å¿—
 *  12. å…¨å±€æœç´¢
 *  13. ç¼“å­˜ç›‘æ§
 *  14. åˆå§‹åŒ–ä¸äº‹ä»¶ç»‘å®š
 *  15. å…¼å®¹æš´éœ²ï¼ˆæ—§å‡½æ•°åæ˜ å°„ï¼‰
 * =======================================================*/

/* =============== 1. å¸¸é‡ä¸å·¥å…· =============== */
const KEYS = {
  ROOMS:'rooms',
  ROOM_DB:'roomDatabase',
  STUD_DB:'studentDatabase',
  STUD_SLOTS:'studentTimeSlots',
  PRACTICE_LOG:'practiceLogs',
  QUEUE:'queueList',
  OPS:'operationLogs',
  SETTINGS:'systemSettings',
  AUTO_RESET:'autoResetSettings',
  TIMELINE_VISIBLE:'timelineVisible',
  OVERRUN_REMINDERS:'practiceOverrunReminders',
  OVERRUN_IGNORED:'practiceOverrunIgnored',
  OVERRUN_STATS:'practiceOverrunStats'
};

const SLOT_HISTORY_KEY = 'studentSlotHistory';

const DEFAULT_SETTINGS = {
  basePracticeDuration:120,
  loginPassword:'password',
  adminPassword:'ymsq2022',
  autoResetHour:21,
  autoResetMinute:45,
  stopAnomalyCheckHour:19,  // æ–°å¢ï¼šæ¯å¤©å‡ ç‚¹ååœæ­¢å¼‚å¸¸æ£€æŸ¥ï¼ˆé»˜è®¤19ç‚¹ï¼‰
  stopAnomalyCheckMinute:0,
  startAnomalyCheckHour:8,  // ğŸ”¥ æ–°å¢ï¼šå¼‚å¸¸æ£€æŸ¥å¼€å§‹æ—¶é—´ï¼ˆå°æ—¶ï¼‰
  startAnomalyCheckMinute:0,
  dataProtectionMode: true, // ğŸ”¥ æ–°å¢ï¼šæ•°æ®ä¿æŠ¤æ¨¡å¼
  autoLockEnabled: true,        // ğŸ”¥ æ–°å¢ï¼šæ˜¯å¦å¯ç”¨è‡ªåŠ¨é”å®š
  autoLockTimeMinutes: 10    
};

const WEEK_MAP = {1:'monday',2:'tuesday',3:'wednesday',4:'thursday',5:'friday'};
const WEEK_CN  = {monday:'å‘¨ä¸€',tuesday:'å‘¨äºŒ',wednesday:'å‘¨ä¸‰',thursday:'å‘¨å››',friday:'å‘¨äº”'};

// ğŸ”¥ æ·»åŠ  Firebase é…ç½®
const firebaseConfig = {
  apiKey: "AIzaSyBVo2SAW85dT1e0oaxJor4idPKnfZ21Bww",
  authDomain: "menuhin-backup.firebaseapp.com",
  databaseURL: "https://menuhin-backup-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "menuhin-backup",
  storageBucket: "menuhin-backup.firebasestorage.app",
  messagingSenderId: "573338040341",
  appId: "1:573338040341:web:01a627216b050c2abef61c",
  measurementId: "G-EKF09W8PVP"
};

/* =============== Firebase å®æ—¶åŒæ­¥åŠŸèƒ½ =============== */
let firebaseApp = null;
let database = null;
let isOnline = false;
let syncEnabled = true;
let lastSyncTime = 0;
let deviceId = null;

const FIREBASE_PATHS = {
    ROOMS: 'rooms',
    ROOM_DB: 'roomDatabase', 
    STUDENT_DB: 'studentDatabase',
    STUDENT_SLOTS: 'studentTimeSlots',
    QUEUE: 'queueList',
    LAST_UPDATE: 'lastUpdate',
    DEVICE_STATUS: 'deviceStatus',
    SYSTEM_SETTINGS: 'systemSettings',
    ATTENDANCE_DATA: 'attendanceData',
    OVERRUN_REMINDERS: 'practiceOverrunReminders',
    OVERRUN_STATS: 'overrunStats',
    OVERRUN_IGNORED: 'overrunIgnored',
    EXCUSE_DATA: 'excuseData' , // æ–°å¢ï¼šä¸“é—¨å­˜å‚¨è¯·å‡æ•°æ®
    OVERRUN_DATA: 'overrunData',
    PRACTICE_RECORDS: 'practiceRecords', // ğŸ”¥ æ–°å¢ï¼šç»ƒä¹ æ—¶é•¿è®°å½•
    PRACTICE_SESSIONS: 'practiceSessions' // ğŸ”¥ æ–°å¢ï¼šç»ƒä¹ ä¼šè¯æ•°æ®
};

// ğŸ”¥ æ–°å¢ï¼šæ¸…ç†å¯¹è±¡ä¸­çš„ undefined å€¼
function cleanDataForFirebase(obj) {
    if (obj === null || obj === undefined) {
        return null;
    }
    
    if (Array.isArray(obj)) {
        return obj.map(item => cleanDataForFirebase(item));
    }
    
    if (typeof obj === 'object') {
        const cleaned = {};
        for (const [key, value] of Object.entries(obj)) {
            if (value !== undefined) {
                // ğŸ”¥ ç‰¹æ®Šå¤„ç†æˆ¿é—´æ•°æ®
                if (key === 'student' || key === 'registerTime') {
                    cleaned[key] = value === null ? null : value;
                } else {
                    cleaned[key] = cleanDataForFirebase(value);
                }
            }
        }
        return cleaned;
    }
    
    return obj;
}


// åˆå§‹åŒ– Firebase
function initFirebase() {
    try {
        console.log('ğŸ”¥ å¼€å§‹åˆå§‹åŒ– Firebase...');

        // ===== è‡ªé€‚åº”è¿æ¥ç­–ç•¥ï¼šå¤šæ¬¡æ–­çº¿åé™çº§ä¸ºé•¿è½®è¯¢ =====
        (function(){
          if(!window.__fbTransportState){
            window.__fbTransportState={
              disconnectCount:0,
              lastDisconnectAt:0,
              forcedLongPolling:false
            };
          }
          // è‹¥ 10 åˆ†é’Ÿå†…ç´¯è®¡æ–­çº¿ â‰¥3 æ¬¡ä¸”å°šæœªé™çº§ï¼Œåˆ™å¯ç”¨é•¿è½®è¯¢
          if(window.__fbTransportState.disconnectCount>=3 && !window.__fbTransportState.forcedLongPolling){
            console.warn('[net] å¤šæ¬¡æ–­çº¿ï¼Œå¯ç”¨é•¿è½®è¯¢é™çº§æ¨¡å¼');
            window.firebase && window.firebase.database && window.firebase.database.INTERNAL && (window.firebase.database.INTERNAL.forceLongPolling=true);
            window.__fbTransportState.forcedLongPolling=true;
          }
        })();
        
        firebaseApp = firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        deviceId = getDeviceId();
        
        console.log('âœ… Firebase åº”ç”¨åˆå§‹åŒ–æˆåŠŸ');
        
        // ğŸ”¥ æ›¿æ¢åŸæœ‰çš„è¿æ¥çŠ¶æ€ç›‘å¬å™¨
        database.ref('.info/connected').on('value', (snapshot) => {
            const connected = snapshot.val() === true;
            const wasOnline = isOnline;
            isOnline = connected;
            updateConnectionStatus();
            
            if (connected && !wasOnline) {
                // é‡æ–°è¿æ¥çš„æƒ…å†µ
                console.log('ğŸŸ¢ Firebase é‡æ–°è¿æ¥æˆåŠŸ');
                showToast('ğŸŸ¢ å·²é‡æ–°è¿æ¥åˆ°äº‘ç«¯æœåŠ¡å™¨', 2000);
                
                // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šè¿æ¥åç«‹å³æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥
                setTimeout(() => {
                    const deviceStatus = detectDeviceStatus();
                    if (deviceStatus.isNewDevice || deviceStatus.totalScore === 0) {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°æ— æ•°æ®è®¾å¤‡ï¼Œç«‹å³åŒæ­¥...');
                        performInitialSync();
                    } else {
                        console.log('ğŸ”„ æ­£å¸¸è®¾å¤‡é‡è¿ï¼Œæ‰§è¡Œå¸¸è§„åŒæ­¥...');
                        performInitialSync();
                    }
                    // è§¦å‘çŠ¶æ€æ›´æ–°
                    triggerRealTimePracticeStatusUpdate();
                }, 500);
                
            } else if (connected && wasOnline === undefined) {
                // é¦–æ¬¡è¿æ¥çš„æƒ…å†µ
                console.log('ğŸŸ¢ Firebase é¦–æ¬¡è¿æ¥æˆåŠŸ');
                showToast('ğŸŸ¢ å·²è¿æ¥åˆ°äº‘ç«¯æœåŠ¡å™¨', 2000);
                
                // ğŸ”¥ é¦–æ¬¡è¿æ¥æ—¶ç«‹å³åŒæ­¥
                setTimeout(() => {
                    const deviceStatus = detectDeviceStatus();
                    console.log('ğŸ“± é¦–æ¬¡è¿æ¥è®¾å¤‡çŠ¶æ€:', deviceStatus);
                    
                    // ğŸ”¥ å…³é”®ï¼šæ ¹æ®è®¾å¤‡çŠ¶æ€å†³å®šåŒæ­¥ç­–ç•¥
                    if (deviceStatus.isNewDevice || deviceStatus.totalScore === 0) {
                        console.log('ğŸ“¥ æ–°è®¾å¤‡æˆ–æ— æ•°æ®ï¼Œä¼˜å…ˆæ‹‰å–äº‘ç«¯æ•°æ®...');
                    }
                    
                    performInitialSync();
                    setupPeriodicSync();
                    // å¯ç”¨åŒæ­¥å¥åº·ç›‘æ§
                    setTimeout(monitorSyncHealth, 30000);
                    // é¦–æ¬¡è¿æ¥æ—¶ç«‹å³åŒæ­¥å®æ—¶çŠ¶æ€
                    triggerRealTimePracticeStatusUpdate();
                }, 1000);
                
            } else if (!connected) {
                console.log('ğŸ”´ Firebase è¿æ¥å·²æ–­å¼€');
                // è®°å½•æ–­çº¿æ¬¡æ•°å¹¶å¯èƒ½è§¦å‘é™çº§
                const st=window.__fbTransportState; if(st){
                  const now=Date.now();
                  if(now - st.lastDisconnectAt > 10*60*1000){ st.disconnectCount=0; }
                  st.lastDisconnectAt=now; st.disconnectCount++;
                  if(st.disconnectCount===3 && !st.forcedLongPolling){
                    console.warn('[net] è§¦å‘é™çº§: forceLongPolling');
                    try{ window.firebase.database.INTERNAL.forceLongPolling=true; st.forcedLongPolling=true; }catch(e){console.warn('é™çº§å¤±è´¥',e);} }
                }
                showToast('ğŸ”´ ä¸äº‘ç«¯æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼', 3000);
                // è¿æ¥æ–­å¼€æ—¶ä¿å­˜å½“å‰çŠ¶æ€
                persistAllData();
                flushPendingOperations(); // å°è¯•è½ç›˜å¾…å¤„ç†æ“ä½œ
            }
        }, (error) => {
            console.error('è¿æ¥çŠ¶æ€ç›‘å¬é”™è¯¯:', error);
            isOnline = false;
            updateConnectionStatus();
            showToast('âš ï¸ è¿æ¥ç›‘å¬å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 3000);
        });
        
        createConnectionIndicator();
        setupDataListeners();
        registerDevice();

        // å¯åŠ¨ç½‘ç»œè¯Šæ–­ (ç®€åŒ–ç‰ˆï¼šæµ‹é‡ fetch gstatic HEAD è€—æ—¶) & è¾“å‡ºç»“æœ
        runLightweightNetworkDiagnostics();
        // å‘¨æœŸ 2 åˆ†é’Ÿé‡æµ‹ä¸€æ¬¡ï¼ˆä»…åœ¨æœªå¼ºåˆ¶é™çº§æ—¶ï¼‰
        setInterval(()=>{ if(!window.__fbTransportState.forcedLongPolling) runLightweightNetworkDiagnostics(); }, 120000);
        
    } catch (error) {
        console.error('âŒ Firebase åˆå§‹åŒ–å¤±è´¥:', error);
        showToast('âŒ äº‘ç«¯åŒæ­¥ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼', 5000);
        isOnline = false;
        updateConnectionStatus();
    }
}

// ===== è½»é‡ç½‘ç»œè¯Šæ–­ =====
function runLightweightNetworkDiagnostics(){
  const target='https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
  const start=performance.now();
  fetch(target,{method:'HEAD',cache:'no-cache',mode:'no-cors'}).catch(()=>{}).finally(()=>{
    const dur=Math.round(performance.now()-start);
    let quality = dur<150?'good': dur<600?'moderate':'poor';
    console.log(`[net] è¯Šæ–­ gstatic HEAD=${dur}ms quality=${quality}`);
    window.__lastNetDiag={dur,quality,ts:Date.now()};
  });
}

// ===== ç¦»çº¿ç™»è®°æ“ä½œé˜Ÿåˆ— =====
const pendingOps=[]; // {type:'register'|'clear', roomName, student, ts, payload}
function enqueueOperation(op){
  op.ts=Date.now();
  pendingOps.push(op);
  try{ localStorage.setItem('pendingOps', JSON.stringify(pendingOps.slice(-200))); }catch(e){}
  console.warn('[offline-queue] å·²ç¼“å­˜æ“ä½œ', op.type, op.roomName || op.student, 'é˜Ÿåˆ—é•¿åº¦=', pendingOps.length);
}
function restorePendingOps(){
  try{ const raw=localStorage.getItem('pendingOps'); if(raw){ const arr=JSON.parse(raw); if(Array.isArray(arr)) {pendingOps.length=0; arr.forEach(o=>pendingOps.push(o)); if(arr.length) console.log('[offline-queue] æ¢å¤å¾…å¤„ç†æ“ä½œ', arr.length);} } }catch(e){}
}
restorePendingOps();
function flushPendingOperations(){
  if(!isOnline || !database) return;
  if(!pendingOps.length) return;
  console.log('[offline-queue] å°è¯•å›æ”¾æ“ä½œ æ•°é‡=', pendingOps.length);
  const copy=pendingOps.slice();
  pendingOps.length=0; // ä¹è§‚æ¸…ç©º
  let success=0,failed=0; const remain=[];
  const doOne=(op)=>{
    if(op.type==='register'){
      return performRegisterRoom(op.roomName, op.student, {queued:true});
    }else if(op.type==='clear'){
      return performClearRoom(op.roomName,{queued:true});
    }
    return Promise.resolve();
  };
  (async()=>{
    for(const op of copy){
      try{ await doOne(op); success++; }catch(e){ failed++; remain.push(op); console.warn('[offline-queue] å›æ”¾å¤±è´¥å°†é‡è¯•', op, e); }
    }
    if(remain.length){ pendingOps.push(...remain); }
    try{ localStorage.setItem('pendingOps', JSON.stringify(pendingOps.slice(-200))); }catch(e){}
    console.log(`[offline-queue] å›æ”¾å®Œæˆ success=${success} failed=${failed} å‰©ä½™=${pendingOps.length}`);
  })();
}

// åœ¨ä»»ä½•ç™»è®°/æ¸…ç©ºå…¥å£å¤„ï¼ˆç¤ºä¾‹å‡½æ•°å ä½ï¼Œè‹¥å·²æœ‰åˆ™è¡¥å……è°ƒç”¨ enqueueOperationï¼‰
function performRegisterRoom(roomName, student, opts={}){
  // ...existing code... ï¼ˆæ­¤å¤„å‡è®¾åŸæœ¬æœ‰çœŸæ­£å†™å…¥ Firebase çš„é€»è¾‘ï¼‰
  if(!isOnline){ enqueueOperation({type:'register',roomName,student}); return Promise.resolve('queued'); }
  // çœŸå®å†™å…¥é€»è¾‘å¾…æ¥å…¥ç°æœ‰å®ç°
  // placeholder: è¿”å› Promise
  return new Promise((res)=>{ res('ok'); });
}
function performClearRoom(roomName, opts={}){
  // ...existing code...
  if(!isOnline){ enqueueOperation({type:'clear',roomName}); return Promise.resolve('queued'); }
  return new Promise((res)=>{ res('ok'); });
}


// ğŸ”¥ æ–°å¢ï¼šè®¾å¤‡æ•°æ®çŠ¶æ€æ£€æµ‹
let isNewDevice = false;
let hasValidLocalData = false;

function detectDeviceStatus() {
    // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æœ¬åœ°æ•°æ®
    const roomCount = Object.keys(roomDatabase).length;
    const studentCount = Object.values(studentDatabase).reduce((a,b)=>a+b.length,0);
    const hasRooms = rooms && rooms.length > 0;
    const hasTimeSlots = Object.keys(studentTimeSlots).length > 0;
    const hasLogs = practiceLogs && practiceLogs.length > 0;
    const hasQueues = queueList && (queueList.grand.length + queueList.upright.length + queueList.none.length) > 0;
    
    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šæ›´å®½æ¾çš„æœ‰æ•ˆæ•°æ®åˆ¤æ–­
    const coreDataScore = roomCount * 3 + studentCount * 2;
    const extendedDataScore = (hasTimeSlots ? 5 : 0) + (hasLogs ? 2 : 0) + (hasQueues ? 1 : 0);
    const totalScore = coreDataScore + extendedDataScore;
    
    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šé™ä½é˜ˆå€¼ï¼Œæ›´å®¹æ˜“è§¦å‘äº‘ç«¯æ‹‰å–
    hasValidLocalData = totalScore > 0; // ä»2é™ä½åˆ°0ï¼Œä»»ä½•æ•°æ®éƒ½ç®—æœ‰æ•ˆ
    isNewDevice = totalScore === 0; // å®Œå…¨æ²¡æœ‰æ•°æ®æ‰ç®—æ–°è®¾å¤‡
    
    console.log('ğŸ“± è®¾å¤‡çŠ¶æ€æ£€æµ‹:', {
        isNewDevice,
        hasValidLocalData,
        totalScore,
        roomCount,
        studentCount
    });
    
    return { isNewDevice, hasValidLocalData, totalScore };
}


// è®¾ç½®è¿æ¥ç›‘å¬
function setupConnectionMonitoring() {
    const connectedRef = database.ref('.info/connected');
    connectedRef.on('value', (snapshot) => {
        const connected = snapshot.val() === true;
        
        if (connected !== isOnline) {
            isOnline = connected;
            updateConnectionStatus();
            
            if (connected) {
                console.log('ğŸŸ¢ Firebase è¿æ¥å·²å»ºç«‹');
                showToast('ğŸŸ¢ å·²è¿æ¥åˆ°äº‘ç«¯æœåŠ¡å™¨', 2000);
                
                // é‡æ–°è¿æ¥åå»¶è¿ŸåŒæ­¥
                setTimeout(() => {
                    performInitialSync();
                }, 1000);
            } else {
                console.log('ğŸ”´ Firebase è¿æ¥å·²æ–­å¼€');
                showToast('ğŸ”´ ä¸äº‘ç«¯æœåŠ¡å™¨æ–­å¼€è¿æ¥', 3000);
            }
        }
    });
}

// ğŸ”¥ æ–°å¢ï¼šæ•°æ®ä¿æŠ¤æ£€æŸ¥
function validateDataBeforeSync(data) {
    const checks = {
        hasRooms: data.rooms && Array.isArray(data.rooms) && data.rooms.length > 0,
        hasRoomDb: data.roomDatabase && Object.keys(data.roomDatabase).length > 0,
        hasStudents: data.studentDatabase && Object.keys(data.studentDatabase).length > 0,
        isValid: false
    };
    
    // è‡³å°‘è¦æœ‰æˆ¿é—´æ•°æ®åº“æˆ–å­¦ç”Ÿæ•°æ®åº“
    checks.isValid = checks.hasRoomDb || checks.hasStudents;
    
    console.log('ğŸ” æ•°æ®éªŒè¯ç»“æœ:', checks);
    return checks;
}

// ğŸ”¥ æ–°å¢ï¼šå±é™©æ“ä½œç¡®è®¤
function confirmDataOverwrite() {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:10001;';
        modal.innerHTML = `
            <div style="background:#fff;padding:30px;border-radius:16px;max-width:500px;width:90%;text-align:center;">
                <h3 style="color:#e74c3c;margin-bottom:20px;">âš ï¸ æ•°æ®åŒæ­¥ç¡®è®¤</h3>
                <p style="margin-bottom:20px;line-height:1.5;">
                    æ£€æµ‹åˆ°æ‚¨çš„è®¾å¤‡æ•°æ®è¾ƒå°‘ï¼Œäº‘ç«¯å¯èƒ½æœ‰æ›´å®Œæ•´çš„æ•°æ®ã€‚<br>
                    æ˜¯å¦è¦ä»äº‘ç«¯è·å–æœ€æ–°æ•°æ®ï¼Ÿ
                </p>
                <div style="display:flex;gap:15px;justify-content:center;">
                    <button onclick="resolveConfirm(true)" style="background:#27ae60;color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;">
                        ä»äº‘ç«¯è·å–
                    </button>
                    <button onclick="resolveConfirm(false)" style="background:#95a5a6;color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;">
                        ä½¿ç”¨æœ¬åœ°æ•°æ®
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        window.resolveConfirm = (result) => {
            document.body.removeChild(modal);
            delete window.resolveConfirm;
            resolve(result);
        };
    });
}

// æ‰§è¡Œåˆå§‹åŒæ­¥
function performInitialSync() {
    if (!database || !isOnline) return;
    
    const deviceStatus = detectDeviceStatus();
    console.log('ğŸ”„ æ‰§è¡Œåˆå§‹åŒæ­¥...', deviceStatus);
    
    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šæ–°è®¾å¤‡æˆ–æ— æ•°æ®è®¾å¤‡ç«‹å³æ‹‰å–
    if (deviceStatus.isNewDevice || deviceStatus.totalScore === 0) {
        console.log('ğŸ“¥ æ–°è®¾å¤‡æˆ–æ— æ•°æ®ï¼Œç«‹å³æ‹‰å–äº‘ç«¯æ•°æ®...');
        pullDataFromCloud().then(() => {
            console.log('âœ… äº‘ç«¯æ•°æ®æ‹‰å–å®Œæˆ');
            // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°æœ¬åœ°å ç”¨å¿«ç…§
            lastLocalSnapshotOccupancy = rooms.filter(r=>r.student).length;
            // æ‹‰å–å®Œæˆåæ£€æŸ¥æ˜¯å¦éœ€è¦æ¨é€æœ¬åœ°è¡¥å……æ•°æ®
            setTimeout(() => {
                const updatedStatus = detectDeviceStatus();
                if (updatedStatus.totalScore > 0) {
                    console.log('ğŸ“¤ æ¨é€æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯...');
                    pushDataToCloud();
                }
                // ğŸ”¥ æ–°å¢ï¼šé¦–å¸§å®Œæˆæ ‡è®°
                initialSyncCompleted = true;
                initialSyncInProgress = false;
                console.log('ğŸ¯ åˆå§‹åŒæ­¥å®Œæˆ - æ–°è®¾å¤‡åˆ†æ”¯');
            }, 2000);
        });
    } else {
        // æœ‰æ•°æ®çš„è®¾å¤‡ï¼Œå…ˆæ‹‰å–å†æ¨é€
        console.log('ğŸ“¥ ç°æœ‰è®¾å¤‡ï¼Œå…ˆæ‹‰å–åæ¨é€...');
        setTimeout(() => {
            pullDataFromCloud().then(() => {
                // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°æœ¬åœ°å ç”¨å¿«ç…§
                lastLocalSnapshotOccupancy = rooms.filter(r=>r.student).length;
                setTimeout(() => {
                    console.log('ğŸ“¤ æ¨é€æœ€æ–°çŠ¶æ€åˆ°äº‘ç«¯...');
                    pushDataToCloud();
                    // ğŸ”¥ æ–°å¢ï¼šé¦–å¸§å®Œæˆæ ‡è®°
                    initialSyncCompleted = true;
                    initialSyncInProgress = false;
                    console.log('ğŸ¯ åˆå§‹åŒæ­¥å®Œæˆ - ç°æœ‰è®¾å¤‡åˆ†æ”¯');
                }, 1000);
            });
        }, 1000);
    }
}



// ğŸ”¥ ä¿®æ”¹ï¼šå¢å¼ºäº‘ç«¯æ•°æ®æ‹‰å–é€»è¾‘
function pullDataFromCloud() {
    console.log('ğŸ“¥ å¼€å§‹ä»äº‘ç«¯æ‹‰å–æ•°æ®...');
    
    // ğŸ”¥ æ–°å¢ï¼šæ•°æ®ä¿æŠ¤æ£€æŸ¥
    if (systemSettings.dataProtectionMode) {
        const localOccupancy = rooms.filter(r => r.student && r.registerTime);
        const recentWakeup = Date.now() - lastWakeupTime < 60000; // 1åˆ†é’Ÿå†…å”¤é†’
        
        if (localOccupancy.length > 0 && recentWakeup) {
            console.log('ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤æ¨¡å¼ï¼šæ‹’ç»è¦†ç›–æœ¬åœ°å ç”¨çŠ¶æ€ï¼ˆåˆšå”¤é†’ï¼‰');
            console.log('æœ¬åœ°å ç”¨:', localOccupancy.map(r => `${r.name}:${r.student}`));
            
            // æ¨é€æœ¬åœ°æ•°æ®è€Œä¸æ˜¯æ‹‰å–
            setTimeout(() => {
                pushDataToCloud();
            }, 1000);
            return Promise.resolve();
        }
    }
    return database.ref().once('value')
        .then((snapshot) => {
            const cloudData = snapshot.val();
            
            if (!cloudData) {
                console.log('â˜ï¸ äº‘ç«¯æ— æ•°æ®ï¼Œä¿æŒæœ¬åœ°çŠ¶æ€');
                return;
            }
            
            console.log('ğŸ“¥ æ”¶åˆ°äº‘ç«¯æ•°æ®:', Object.keys(cloudData));
            
            // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šæ–°è®¾å¤‡æ— æ¡ä»¶æ¥å—äº‘ç«¯æ•°æ®
            const deviceStatus = detectDeviceStatus();
            const cloudTimestamp = cloudData[FIREBASE_PATHS.LAST_UPDATE]?.timestamp || 0;
            const localTimestamp = lastSyncTime || 0;
            
            const shouldApplyCloudData = deviceStatus.isNewDevice || 
                                       cloudTimestamp > localTimestamp || 
                                       !deviceStatus.hasValidLocalData;
            
            if (shouldApplyCloudData) {
                console.log('ğŸ“¥ åº”ç”¨äº‘ç«¯æ•°æ®ï¼Œè®¾å¤‡çŠ¶æ€:', deviceStatus, 'äº‘ç«¯æ—¶é—´æˆ³:', new Date(cloudTimestamp).toLocaleString());
                applyCloudDataSafely(cloudData);
                
                // ğŸ”¥ æ–°å¢ï¼šåº”ç”¨å®Œæˆåç«‹å³é€šçŸ¥å…¶ä»–è®¾å¤‡
                setTimeout(() => {
                    notifyOtherDevicesOfSync();
                }, 1000);
            } else {
                console.log('ğŸ“¥ æœ¬åœ°æ•°æ®è¾ƒæ–°æˆ–è®¾å¤‡çŠ¶æ€ä¸é€‚åˆåº”ç”¨äº‘ç«¯æ•°æ®');
            }
            
            // ğŸ”¥ æ–°å¢ï¼šè®°å½•è¿œç«¯å ç”¨æ•°
            if(cloudData && Array.isArray(cloudData[FIREBASE_PATHS.ROOMS])){
                const occ = cloudData[FIREBASE_PATHS.ROOMS].filter(r=>r && r.student).length;
                lastRemoteSnapshotOccupancy = occ;
                console.log('â˜ï¸ äº‘ç«¯å ç”¨æ•°ç¼“å­˜ä¸º', occ);
            }
            
        })
        .catch((error) => {
            console.error('âŒ æ‹‰å–äº‘ç«¯æ•°æ®å¤±è´¥:', error);
            showToast('âŒ æ— æ³•è·å–äº‘ç«¯æ•°æ®ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼', 3000);
        });
}


function safePushAllRooms(reason='manual'){
    if(!canSyncNow('bulk_push',{reason})) return;
    pushDataToCloud();
}


// ğŸ”¥ æ–°å¢ï¼šå®‰å…¨åº”ç”¨äº‘ç«¯æ•°æ®
function applyCloudDataSafely(cloudData) {
    // ğŸ”¥ æ–°å¢ï¼šæœ¬åœ°æ•°æ®ä¸ºç©ºæ—¶çš„ç‰¹æ®Šå¤„ç†
    const localDataScore = Object.keys(roomDatabase).length + 
                          Object.values(studentDatabase).reduce((a,b)=>a+b.length,0);
    
    if (localDataScore === 0) {
        console.log('ğŸ“¥ æœ¬åœ°æ•°æ®ä¸ºç©ºï¼Œç›´æ¥åº”ç”¨äº‘ç«¯æ•°æ®...');
        // æœ¬åœ°æ•°æ®ä¸ºç©ºæ—¶ï¼Œç›´æ¥åº”ç”¨äº‘ç«¯æ•°æ®ï¼Œè·³è¿‡å¤æ‚çš„ä¿æŠ¤é€»è¾‘
        applyCloudDataDirectly(cloudData);
        return;
    }
    
    // ğŸ”¥ æ–°å¢ï¼šæ•°æ®ä¿æŠ¤æ£€æŸ¥ï¼ˆåŸæœ‰é€»è¾‘ä¿æŒä¸å˜ï¼‰
    const localOccupiedRooms = rooms.filter(r => r.student && r.registerTime);
    const cloudRooms = cloudData[FIREBASE_PATHS.ROOMS] || [];
    const cloudOccupiedRooms = cloudRooms.filter(r => r && r.student && r.registerTime);
    
    // å¦‚æœå¯ç”¨æ•°æ®ä¿æŠ¤æ¨¡å¼ä¸”æœ¬åœ°æœ‰å ç”¨çŠ¶æ€è€Œäº‘ç«¯æ²¡æœ‰ï¼Œæ‹’ç»åº”ç”¨
    if (systemSettings.dataProtectionMode && localOccupiedRooms.length > 0 && cloudOccupiedRooms.length === 0) {
        console.warn('ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤æ¨¡å¼ï¼šæ‹’ç»åº”ç”¨ç©ºçš„äº‘ç«¯æ•°æ®ï¼Œæœ¬åœ°æœ‰å ç”¨çŠ¶æ€éœ€è¦ä¿æŠ¤');
        console.log('æœ¬åœ°å ç”¨æˆ¿é—´:', localOccupiedRooms.map(r => `${r.name}:${r.student}`));
        
        // åå‘æ¨é€æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
        setTimeout(() => {
            console.log('ğŸ”„ æ¨é€æœ¬åœ°å ç”¨çŠ¶æ€åˆ°äº‘ç«¯...');
            pushDataToCloud();
        }, 1000);
        
        showToast('ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤ï¼šå·²ä¿æŠ¤æœ¬åœ°å ç”¨çŠ¶æ€', 3000);
        return;
    }
    
    // ğŸ”¥ æ–°å¢ï¼šæ—¶é—´æœ‰æ•ˆæ€§æ£€æŸ¥
    const now = Date.now();
    const maxAge = 10 * 60 * 1000; // 10åˆ†é’Ÿ
    
    if (cloudOccupiedRooms.length > 0) {
        const hasValidData = cloudOccupiedRooms.some(r => {
            const age = now - (r.registerTime || 0);
            return age >= 0 && age <= maxAge;
        });
        
        if (!hasValidData) {
            console.warn('ğŸ›¡ï¸ äº‘ç«¯æ•°æ®æ—¶æ•ˆæ€§æ£€æŸ¥å¤±è´¥ï¼Œä¿æŠ¤æœ¬åœ°çŠ¶æ€');
            return;
        }
    }
    
    // åº”ç”¨äº‘ç«¯æ•°æ®çš„åŸæœ‰é€»è¾‘...
    applyCloudDataDirectly(cloudData);
}
function forceCloudSync() {
    if (!database || !isOnline) {
        showToast('âŒ æœªè¿æ¥åˆ°äº‘ç«¯æœåŠ¡å™¨', 3000);
        return;
    }
    
    if (!confirm('ç¡®å®šè¦å¼ºåˆ¶ä»äº‘ç«¯åŒæ­¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–æœ¬åœ°æ•°æ®ã€‚')) {
        return;
    }
    
    console.log('ğŸ”„ å¼ºåˆ¶ä»äº‘ç«¯åŒæ­¥æ•°æ®...');
    
    // ä¸´æ—¶ç¦ç”¨æ•°æ®ä¿æŠ¤
    const originalProtectionMode = systemSettings.dataProtectionMode;
    systemSettings.dataProtectionMode = false;
    
    pullDataFromCloud().then(() => {
        // æ¢å¤æ•°æ®ä¿æŠ¤è®¾ç½®
        systemSettings.dataProtectionMode = originalProtectionMode;
        showToast('âœ… å¼ºåˆ¶åŒæ­¥å®Œæˆ', 3000);
    }).catch(error => {
        systemSettings.dataProtectionMode = originalProtectionMode;
        showToast('âŒ å¼ºåˆ¶åŒæ­¥å¤±è´¥: ' + error.message, 5000);
    });
}

// æ·»åŠ åˆ°ç®¡ç†æŒ‰é’®ä¸­
window.forceCloudSync = forceCloudSync;

// ğŸ”¥ æ–°å¢ï¼šç›´æ¥åº”ç”¨äº‘ç«¯æ•°æ®ï¼ˆç”¨äºæœ¬åœ°æ•°æ®ä¸ºç©ºçš„æƒ…å†µï¼‰
function applyCloudDataDirectly(cloudData) {
    let hasUpdates = false;
    
    try {
        // ç¦ç”¨åŒæ­¥é¿å…å¾ªç¯
        syncEnabled = false;
        
        // åº”ç”¨ç´æˆ¿æ•°æ®åº“
        if (cloudData[FIREBASE_PATHS.ROOM_DB]) {
            roomDatabase = { ...cloudData[FIREBASE_PATHS.ROOM_DB] };
            rebuildRoomsFromDb();
            hasUpdates = true;
            console.log('âœ… åº”ç”¨äº‘ç«¯ç´æˆ¿æ•°æ®åº“');
        }
        
        // åº”ç”¨å­¦ç”Ÿæ•°æ®åº“
        if (cloudData[FIREBASE_PATHS.STUDENT_DB]) {
            studentDatabase = { ...cloudData[FIREBASE_PATHS.STUDENT_DB] };
            hasUpdates = true;
            console.log('âœ… åº”ç”¨äº‘ç«¯å­¦ç”Ÿæ•°æ®åº“');
        }
        
        // åº”ç”¨å­¦ç”Ÿæ—¶é—´æ®µ
        if (cloudData[FIREBASE_PATHS.STUDENT_SLOTS]) {
            studentTimeSlots = { ...cloudData[FIREBASE_PATHS.STUDENT_SLOTS] };
            hasUpdates = true;
            console.log('âœ… åº”ç”¨äº‘ç«¯å­¦ç”Ÿæ—¶é—´æ®µ');
        }
        
        // åº”ç”¨æˆ¿é—´çŠ¶æ€ï¼ˆæŒ‰åç§°åŒ¹é…ï¼Œç¦æ­¢ä½¿ç”¨æ•°ç»„ä¸‹æ ‡ï¼‰
        if (cloudData[FIREBASE_PATHS.ROOMS] && Array.isArray(cloudData[FIREBASE_PATHS.ROOMS])) {
            const now = Date.now();
            const PROTECT_MS = 30000; // ç™»è®°å30ç§’å†…é¿å…è¢«è¿œç«¯"ç©ºå†™"è¦†ç›–

            // å…ˆåšä¸€å¼  name -> remoteRoom çš„ç´¢å¼•è¡¨
            const remoteMap = new Map();
            cloudData[FIREBASE_PATHS.ROOMS]
                .filter(r => r && r.name)
                .forEach(r => remoteMap.set(r.name, r));

            let changedRooms = [];
            
            rooms.forEach(localRoom => {
                const remote = remoteMap.get(localRoom.name);
                if(!remote) return; // äº‘ç«¯æ²¡æœ‰è¯¥æˆ¿é—´è®°å½•ï¼Œå¿½ç•¥
                
        // è‹¥æœ¬åœ°åˆšæ¸…ç©ºä¸”å¤„äºä¿æŠ¤æœŸå†…ï¼Œä¸”è¿œç«¯ä»æœ‰æ—§å­¦ç”Ÿ â†’ æ‹’ç»å›å¡«
        const CLEAR_PROTECT_MS = 30000;
        if(localRoom.student==null && localRoom.clearTime){
          const sinceClear = now - localRoom.clearTime;
          if(remote.student && sinceClear < CLEAR_PROTECT_MS){
            console.warn('[æˆ¿é—´ä¿æŠ¤-æ¸…ç©º] æ‹’ç»è¿œç«¯å›å¡«', localRoom.name, 'sinceClear(ms)=', sinceClear);
            return;
          }
        }

        // è¿œç«¯æœ‰å­¦ç”Ÿ
                if(remote.student){
                    // å¦‚æœæœ¬åœ°æ²¡æœ‰å­¦ç”Ÿ â†’ ç›´æ¥å¥—ç”¨
                    if(!localRoom.student){
                        localRoom.student = remote.student;
                        localRoom.registerTime = remote.registerTime || null;
                        changedRooms.push({room: localRoom.name, action: 'apply_remote_student'});
                        return;
                    }
                    
                    // å¦‚æœæœ¬åœ°ä¹Ÿæœ‰å­¦ç”Ÿä½†ä¸åŒ â†’ ç”¨æ—¶é—´æˆ³å†³èƒœ
                    const localTime = localRoom.registerTime || 0;
                    const remoteTime = remote.registerTime || 0;
                    if(remote.student !== localRoom.student){
                        if(remoteTime > localTime){
                            changedRooms.push({room: localRoom.name, action:'replace_local_with_remote', from: localRoom.student, to: remote.student});
                            localRoom.student = remote.student;
                            localRoom.registerTime = remoteTime;
                        }else{
                            // æœ¬åœ°æ›´æ–°æ›´æ–° â†’ ä¿ç•™æœ¬åœ°ï¼Œå¿½ç•¥è¿œç«¯
                            // å¯åœ¨æ­¤å†™æ—¥å¿—
                        }
                    }else{
                        // åŒä¸€ä¸ªå­¦ç”Ÿ â†’ å¦‚æœè¿œç«¯æ—¶é—´æ›´æ–°ã€æ›´å¤§åˆ™åŒæ­¥ registerTime
                        if(remoteTime > (localRoom.registerTime || 0)){
                            localRoom.registerTime = remoteTime;
                        }
                    }
                }else{
                    // è¿œç«¯ä¸ºç©ºï¼Œæœ¬åœ°æœ‰å­¦ç”Ÿ â†’ ä¿æŠ¤æœŸåˆ¤æ–­
                    if(localRoom.student){
                        const age = now - (localRoom.registerTime || 0);
                        if(age < PROTECT_MS){
                            // ä¿æŠ¤æœŸå†…æ‹’ç»è¿œç«¯æ¸…ç©º
                            console.warn('[æˆ¿é—´ä¿æŠ¤] æ‹’ç»è¿œç«¯æ¸…ç©º(ä¿æŠ¤æœŸå†…)', localRoom.name, localRoom.student, 'age(ms)=', age);
                            return;
                        }
                        // å¦åˆ™æ¥å—æ¸…ç©º
                        changedRooms.push({room: localRoom.name, action:'remote_clear', student: localRoom.student});
                        localRoom.student = null;
                        localRoom.registerTime = null;
                    }
                }
            });

            if(changedRooms.length){
                console.log('âœ… æŒ‰åç§°å®‰å…¨åº”ç”¨äº‘ç«¯æˆ¿é—´çŠ¶æ€ï¼Œå˜æ›´åˆ—è¡¨: ', changedRooms);
                hasUpdates = true;
            }else{
                console.log('â„¹ï¸ äº‘ç«¯æˆ¿é—´çŠ¶æ€æ— å®è´¨å˜åŒ–ï¼ˆåç§°åŒ¹é…æ£€æŸ¥ï¼‰');
            }
        }

        
        // åº”ç”¨æ’é˜Ÿä¿¡æ¯
        if (cloudData[FIREBASE_PATHS.QUEUE]) {
            queueList = {
                grand: cloudData[FIREBASE_PATHS.QUEUE].grand || [],
                upright: cloudData[FIREBASE_PATHS.QUEUE].upright || [],
                none: cloudData[FIREBASE_PATHS.QUEUE].none || []
            };
            hasUpdates = true;
            console.log('âœ… åº”ç”¨äº‘ç«¯æ’é˜Ÿä¿¡æ¯');
        }
        
        // åº”ç”¨ç³»ç»Ÿè®¾ç½®
        if (cloudData[FIREBASE_PATHS.SYSTEM_SETTINGS]) {
            systemSettings = { 
                ...DEFAULT_SETTINGS, 
                ...cloudData[FIREBASE_PATHS.SYSTEM_SETTINGS] 
            };
            hasUpdates = true;
            console.log('âœ… åº”ç”¨äº‘ç«¯ç³»ç»Ÿè®¾ç½®');
        }
        
        // åº”ç”¨å¼‚å¸¸æé†’æ•°æ®
        if (cloudData[FIREBASE_PATHS.OVERRUN_DATA]) {
            handleRemoteOverrunDataUpdate(cloudData[FIREBASE_PATHS.OVERRUN_DATA]);
            hasUpdates = true;
            console.log('âœ… åº”ç”¨äº‘ç«¯å¼‚å¸¸æé†’æ•°æ®');
        }
        
        if (hasUpdates) {
            // æŒä¹…åŒ–åˆ°æœ¬åœ°
            persistAllData();
            
            // åˆ·æ–°UI
            needsFullUpdate = true;
            updateRooms();
            updateQueueDisplay();
            updateDemandButtonsStatus();
            
            showToast('âœ… å·²ä»äº‘ç«¯åŒæ­¥æœ€æ–°æ•°æ®', 3000);
            console.log('ğŸ‰ äº‘ç«¯æ•°æ®åŒæ­¥å®Œæˆ');
        }
        
    } catch (error) {
        console.error('âŒ åº”ç”¨äº‘ç«¯æ•°æ®å¤±è´¥:', error);
        showToast('âŒ æ•°æ®åŒæ­¥å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢', 5000);
    } finally {
        // é‡æ–°å¯ç”¨åŒæ­¥
        setTimeout(() => {
            syncEnabled = true;
        }, 2000);
    }
}

// ğŸ”¥ æ–°å¢ï¼šé€šçŸ¥å…¶ä»–è®¾å¤‡åŒæ­¥å®Œæˆ
function notifyOtherDevicesOfSync() {
    if (!database || !isOnline) return;
    
    const notification = {
        deviceId: deviceId,
        action: 'sync_completed',
        timestamp: Date.now(),
        message: 'è®¾å¤‡åŒæ­¥å®Œæˆ'
    };
    
    database.ref('sync_notifications').push(notification)
        .then(() => {
            console.log('ğŸ“¢ å·²é€šçŸ¥å…¶ä»–è®¾å¤‡åŒæ­¥å®Œæˆ');
        })
        .catch(error => {
            console.warn('âš ï¸ é€šçŸ¥å‘é€å¤±è´¥:', error);
        });
}

// ğŸ”¥ æ–°å¢ï¼šç›‘å¬å…¶ä»–è®¾å¤‡çš„åŒæ­¥é€šçŸ¥
function listenForSyncNotifications() {
    if (!database) return;
    
    database.ref('sync_notifications').limitToLast(10).on('child_added', (snapshot) => {
        const notification = snapshot.val();
        
        // å¿½ç•¥è‡ªå·±çš„é€šçŸ¥
        if (notification.deviceId === deviceId) return;
        
        // å¦‚æœæ˜¯å…¶ä»–è®¾å¤‡çš„åŒæ­¥å®Œæˆé€šçŸ¥ï¼Œå»¶è¿Ÿæ‹‰å–æœ€æ–°æ•°æ®
        if (notification.action === 'sync_completed') {
            console.log('ğŸ“¢ æ”¶åˆ°å…¶ä»–è®¾å¤‡åŒæ­¥é€šçŸ¥:', notification);
            
            setTimeout(() => {
                console.log('ğŸ”„ å“åº”å…¶ä»–è®¾å¤‡åŒæ­¥ï¼Œæ‹‰å–æœ€æ–°æ•°æ®...');
                pullDataFromCloud();
            }, 2000);
        }
    });
}


// ğŸ”¥ æ–°å¢ï¼šè°¨æ…åº”ç”¨æˆ¿é—´çŠ¶æ€
function applyRoomStatesCarefully(cloudRooms) {
    const now = Date.now();
    const maxAge = 10 * 60 * 1000; // 10åˆ†é’Ÿ
    
    cloudRooms.forEach((cloudRoom, index) => {
        const localRoom = rooms.find(r => r.name === cloudRoom.name);
        if (!localRoom) return;
        
        // ğŸ”¥ å…³é”®ï¼šæ£€æŸ¥æ•°æ®æ—¶æ•ˆæ€§
        if (cloudRoom.student && cloudRoom.registerTime) {
            const age = now - cloudRoom.registerTime;
            
            if (age > maxAge) {
                console.warn(`âš ï¸ è·³è¿‡è¿‡æœŸçš„æˆ¿é—´çŠ¶æ€: ${cloudRoom.name}, å¹´é¾„: ${Math.round(age/60000)}åˆ†é’Ÿ`);
                return;
            }
            
            // æ£€æŸ¥åˆç†æ€§
            if (age < 0) {
                console.warn(`âš ï¸ è·³è¿‡æœªæ¥æ—¶é—´çš„æˆ¿é—´çŠ¶æ€: ${cloudRoom.name}`);
                return;
            }
        }
        
        // åº”ç”¨çŠ¶æ€
        localRoom.student = cloudRoom.student || null;
        localRoom.registerTime = cloudRoom.registerTime || null;
    });
}

// ğŸ”¥ æ–°å¢ï¼šæ¨é€æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
function pushDataToCloud() {
    if(!canSyncNow('direct_push',{})) return;
    const now = Date.now();
    lastOverrunVersion = now;
    
    const updates = {};
    
    // æŒ‰åç§°ç¨³å®šæ’åºï¼Œé¿å…ä¸åŒè®¾å¤‡å†™å…¥é¡ºåºä¸åŒå¯¼è‡´æ½œåœ¨é‡æ”¾é£é™©
    const sortedRooms = [...rooms]
        .sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN',{numeric:true}))
        .map(r => ({
            ...r,
            lastModified: Date.now()  // ç®€å•çš„ç»Ÿä¸€æ—¶é—´æˆ³ï¼›åç»­å¯æ”¹ä¸ºé€æˆ¿é—´å˜åŠ¨æ—¶é—´
        }));
    updates[FIREBASE_PATHS.ROOMS] = cleanDataForFirebase(sortedRooms);
    
    updates[FIREBASE_PATHS.ROOM_DB] = cleanDataForFirebase(roomDatabase);
    updates[FIREBASE_PATHS.STUDENT_DB] = cleanDataForFirebase(studentDatabase);
    updates[FIREBASE_PATHS.STUDENT_SLOTS] = cleanDataForFirebase(studentTimeSlots);
    updates[FIREBASE_PATHS.QUEUE] = cleanDataForFirebase(queueList);
    updates[FIREBASE_PATHS.SYSTEM_SETTINGS] = cleanDataForFirebase(systemSettings);
    
    // å¼‚å¸¸æé†’æ•°æ®
    updates[FIREBASE_PATHS.OVERRUN_DATA] = {
        version: now,
        reminders: cleanDataForFirebase(practiceOverrunReminders),
        ignored: [...overrunIgnoredKeys],
        stats: cleanDataForFirebase(overrunStats),
        updatedAt: now,
        action: 'push_local_data'
    };
    
    updates[FIREBASE_PATHS.LAST_UPDATE] = {
        timestamp: now,
        deviceId,
        action: 'push_local_data'
    };
    
    database.ref().update(updates)
        .then(() => {
            console.log('âœ… æœ¬åœ°æ•°æ®æ¨é€å®Œæˆ');
            lastSyncTime = Date.now();
            showToast('âœ… æœ¬åœ°æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯', 2000);
        })
        .catch(err => {
            console.error('âŒ æ¨é€æœ¬åœ°æ•°æ®å¤±è´¥:', err);
            showToast('âŒ æ•°æ®åŒæ­¥å¤±è´¥', 3000);
        });
}


// ğŸ”¥ ä¿®æ”¹ï¼šç§»é™¤å®šæœŸåŒæ­¥ï¼Œæ”¹ä¸ºå®æ—¶ç›‘å¬
function setupPeriodicSync() {
    console.log('âœ… ä½¿ç”¨å®æ—¶ç›‘å¬æ¨¡å¼ï¼Œæ— éœ€å®šæœŸåŒæ­¥');
    // ä¸å†è®¾ç½®å®šæœŸæ£€æŸ¥ï¼Œå®Œå…¨ä¾èµ– Firebase å®æ—¶ç›‘å¬
}



// ğŸ”¥ ä¿®å¤ï¼šç»Ÿä¸€çš„ syncToFirebase å‡½æ•°ï¼ˆé˜²æŠ–ç‰ˆï¼‰
function syncToFirebase(action = 'update', metadata = {}) {
    if (!database || !isOnline || !syncEnabled) {
        console.log('â¸ï¸ è·³è¿‡åŒæ­¥ï¼š', { database: !!database, isOnline, syncEnabled });
        return;
    }
    
    // ğŸ”¥ æ•°æ®ä¿æŠ¤æ£€æŸ¥
    const dataCheck = validateDataBeforeSync({
        rooms,
        roomDatabase,
        studentDatabase
    });
    
    if (!dataCheck.isValid && action !== 'force_sync') {
        console.warn('âš ï¸ æ•°æ®ä¸å®Œæ•´ï¼Œè·³è¿‡åŒæ­¥:', dataCheck);
        return;
    }
    
    // ğŸ”¥ é˜²æŠ–å¤„ç†ï¼šçŸ­æ—¶é—´å†…å¤šæ¬¡è°ƒç”¨åªæ‰§è¡Œæœ€åä¸€æ¬¡
    if (syncDebounceTimeout) {
        clearTimeout(syncDebounceTimeout);
    }
    
    syncDebounceTimeout = setTimeout(() => {
        performActualSync(action, metadata);
        syncDebounceTimeout = null;
    }, SYNC_DEBOUNCE_MS);
}
// ==== æ–°å¢ï¼šå…¨å±€å®‰å…¨å‰ç½®æ£€æŸ¥ BEGIN ====
function canSyncNow(action, metadata){
    // 1. åˆå§‹åŒæ­¥æœŸé—´ç¦æ­¢
    if(initialSyncInProgress){
        console.log('â¸ï¸ åŒæ­¥è¢«é˜»æ­¢ï¼šinitialSyncInProgress=true');
        return false;
    }
    // 2. å°šæœªå®Œæˆé¦–å¸§æ‹‰å–ä¹Ÿç¦æ­¢ï¼ˆå…œåº•ï¼‰
    if(!initialSyncCompleted){
        console.log('â¸ï¸ åŒæ­¥è¢«é˜»æ­¢ï¼šinitialSyncCompleted=false');
        return false;
    }
    // 3. ç©ºé›†è¦†ç›–ä¿æŠ¤ï¼šæœ¬åœ°æ— å ç”¨ + äº‘ç«¯ä¹‹å‰è®°å½•æœ‰å ç”¨
  const localOcc = rooms.filter(r=>r.student).length;
  if(action!=='single_clear' && localOcc===0 && lastRemoteSnapshotOccupancy>0){
    console.warn('ğŸ›¡ï¸ é˜»æ­¢ç©ºé›†åˆè¦†ç›–ï¼šæœ¬åœ°0å ç”¨ï¼Œäº‘ç«¯è®°å½•', lastRemoteSnapshotOccupancy);
    return false;
  }
    // 4. å¤§å¹…ä¸‹é™ä¿æŠ¤ï¼šä¸€æ¬¡æ€§å‡å°‘ >80% ä¸”æ— ç”¨æˆ·è¿‘æœŸæ“ä½œ
    const drop = lastLocalSnapshotOccupancy>0 ? (lastLocalSnapshotOccupancy - localOcc)/lastLocalSnapshotOccupancy : 0;
  if(action!=='single_clear' && drop > 0.8){
        const now = Date.now();
        if(now - lastUserDestructiveActionTs > DESTRUCTIVE_ACTION_WINDOW){
            console.warn('ğŸ›¡ï¸ é˜»æ­¢ç–‘ä¼¼å¼‚å¸¸æ¸…ç©ºï¼šä¸‹é™æ¯”ä¾‹', (drop*100).toFixed(1),'%');
            return false;
        }
    }
    return true;
}
// ==== æ–°å¢ï¼šå…¨å±€å®‰å…¨å‰ç½®æ£€æŸ¥ END ====

// ğŸ”¥ æ–°å¢ï¼šæ‰§è¡Œå®é™…åŒæ­¥çš„å‡½æ•°
function performActualSync(action, metadata) {
    if(!canSyncNow(action, metadata)) return;
    const now = Date.now();
    
    // ğŸ”¥ å…³é”®æ”¹è¿›ï¼šè®¡ç®—æ•°æ®æŒ‡çº¹ï¼Œæ£€æµ‹å®é™…å˜åŒ–
    const cleanRooms = cleanDataForFirebase(rooms).map(room => ({
        ...room,
        student: room.student || null,
  registerTime: room.registerTime || null,
  clearTime: room.clearTime || null
    }));
    
    const cleanQueue = cleanDataForFirebase({
        grand: queueList.grand || [],
        upright: queueList.upright || [],
        none: queueList.none || []
    });
    
    // ç”Ÿæˆæ•°æ®æŒ‡çº¹ï¼ˆæ’é™¤æ—¶é—´æˆ³ï¼‰
    const currentFingerprint = JSON.stringify({
        rooms: cleanRooms,
        queue: cleanQueue
    });
    
    // ğŸ”¥ æ ¸å¿ƒï¼šå¦‚æœæ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡åŒæ­¥
    if (lastDataFingerprint === currentFingerprint) {
        console.log('â¸ï¸ è·³è¿‡åŒæ­¥ï¼šæ•°æ®æ— å˜åŒ–');
        return;
    }
    
    console.log('ğŸ”„ æ£€æµ‹åˆ°æ•°æ®å˜åŒ–ï¼ŒåŒæ­¥åˆ° Firebase...', action);
    
    const updates = {};
    updates[FIREBASE_PATHS.ROOMS] = cleanRooms;
    updates[FIREBASE_PATHS.QUEUE] = cleanQueue;
    updates[FIREBASE_PATHS.LAST_UPDATE] = {
        timestamp: now,
        deviceId: deviceId,
        action: action,
        metadata: metadata,
        changeHash: generateChangeHash(currentFingerprint) // ğŸ”¥ æ–°å¢ï¼šå˜åŒ–å“ˆå¸Œ
    };
    
    database.ref().update(updates)
        .then(() => {
            console.log('âœ… æ•°æ®åŒæ­¥æˆåŠŸ -', action);
            lastSyncTime = now;
            // ğŸ”¥ æ›´æ–°æŒ‡çº¹ç¼“å­˜
            lastDataFingerprint = currentFingerprint;
        })
        .catch((error) => {
            console.error('âŒ æ•°æ®åŒæ­¥å¤±è´¥:', error);
            // ğŸ”¥ åŒæ­¥å¤±è´¥æ—¶ä¸æ›´æ–°æŒ‡çº¹ï¼Œç¡®ä¿ä¸‹æ¬¡é‡è¯•
        });
}

// ğŸ”¥ æ–°å¢ï¼šç”Ÿæˆå˜åŒ–å“ˆå¸Œï¼ˆç”¨äºæ›´ç²¾ç¡®çš„å˜åŒ–æ£€æµ‹ï¼‰
function generateChangeHash(fingerprint) {
    // ç®€å•å“ˆå¸Œå‡½æ•°
    let hash = 0;
    for (let i = 0; i < fingerprint.length; i++) {
        const char = fingerprint.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
    }
    return hash.toString(36);
}


function handleRemoteRoomsUpdate(remoteRooms) {
    if (!Array.isArray(remoteRooms) || !syncEnabled) return;
  // è‡ªæ„ˆå¢å¼ºï¼šè‹¥æœ‰æ“ä½œé”ï¼Œè¿›å…¥æ’é˜Ÿé˜Ÿåˆ—è€Œä¸æ˜¯æ— é™é€’å½’å»¶è¿Ÿ
  if(operationLocks.size > 0){
    window.__pendingRemoteRooms = remoteRooms; // åªä¿ç•™æœ€æ–°å¿«ç…§
    window.__pendingRemoteRoomsFirstTs = window.__pendingRemoteRoomsFirstTs || Date.now();
    const waited = Date.now() - window.__pendingRemoteRoomsFirstTs;
    const attempts = (window.__pendingRemoteRoomsAttempts = (window.__pendingRemoteRoomsAttempts||0)+1);
    if(waited > 10000 || attempts > 8){
      console.warn('[remoteQueue] è¶…è¿‡ç­‰å¾…é˜ˆå€¼ï¼Œå¼ºåˆ¶åº”ç”¨è¿œç¨‹æ›´æ–° (waited='+waited+'ms attempts='+attempts+')');
    } else {
      if(!window.__remoteQueueNoticeShown){
        console.log('âš ï¸ æœ‰æ­£åœ¨è¿›è¡Œçš„æ“ä½œï¼Œæ’é˜Ÿè¿œç¨‹æ›´æ–° (attempt '+attempts+')');
        window.__remoteQueueNoticeShown = true;
      }
      // ç­‰å¾…é”é‡Šæ”¾æ—¶ç”±é”é‡Šæ”¾é€»è¾‘ä¸»åŠ¨å†è°ƒç”¨
      return;
    }
  } else {
    // æ¸…ç†æ’é˜ŸçŠ¶æ€
    window.__pendingRemoteRooms = null; window.__pendingRemoteRoomsAttempts=0; window.__pendingRemoteRoomsFirstTs=null; window.__remoteQueueNoticeShown=false;
  }
    
    // ğŸ”¥ æ–°å¢ï¼šæ£€æµ‹è¿œç¨‹é‡ç½®æ“ä½œ
    const remoteOccupiedCount = remoteRooms.filter(r => r && r.student).length;
    const localOccupiedCount = rooms.filter(r => r.student).length;
    
    // å¦‚æœè¿œç¨‹æ•°æ®å…¨éƒ¨ä¸ºç©ºä¸”æœ¬åœ°æœ‰å ç”¨ï¼Œå¯èƒ½æ˜¯è¿œç¨‹é‡ç½®
    if (remoteOccupiedCount === 0 && localOccupiedCount > 0) {
        // æ£€æŸ¥æ˜¯å¦åœ¨ä¿æŠ¤æœŸå†…ï¼ˆåˆšç™»è®°çš„æˆ¿é—´ä¸è¢«è¿œç¨‹æ¸…ç©ºè¦†ç›–ï¼‰
        const now = Date.now();
        const recentRegistrations = rooms.filter(r => 
            r.student && r.registerTime && (now - r.registerTime) < 30000 // 30ç§’å†…
        );
        
        if (recentRegistrations.length > 0) {
            console.log('ğŸ›¡ï¸ æ£€æµ‹åˆ°è¿œç¨‹é‡ç½®ï¼Œä½†æœ¬åœ°æœ‰è¿‘æœŸç™»è®°ï¼Œä¿æŠ¤æœ¬åœ°çŠ¶æ€');
            // æ¨é€æœ¬åœ°çŠ¶æ€åˆ°äº‘ç«¯è€Œä¸æ˜¯æ¥å—è¿œç¨‹æ¸…ç©º
            setTimeout(() => {
                pushDataToCloud();
            }, 1000);
            return;
        } else {
            console.log('ğŸ”„ æ£€æµ‹åˆ°è¿œç¨‹é‡ç½®æ“ä½œï¼ŒåŒæ­¥æœ¬åœ°çŠ¶æ€');
            // æ¥å—è¿œç¨‹é‡ç½®
            rooms.forEach(r => {
                if (r.student) {
                    addPracticeLog(r.student, r.name, r.registerTime, now, 'è¿œç¨‹é‡ç½®åŒæ­¥');
                    r.student = null;
                    r.registerTime = null;
                }
            });
            
            persistRooms();
            needsFullUpdate = true;
            updateRooms();
            showToast('ğŸ”„ å·²åŒæ­¥è¿œç¨‹é‡ç½®æ“ä½œ', 3000);
            return;
        }
    }
    
    // ğŸ”¥ æ–°å¢ï¼šæ•°æ®å®Œæ•´æ€§æ£€æŸ¥
    if (isNewDevice && remoteRooms.length === 0) {
        console.log('âš ï¸ æ–°è®¾å¤‡æ”¶åˆ°ç©ºæˆ¿é—´æ•°æ®ï¼Œå¿½ç•¥æ›´æ–°');
        return;
    }
    
    // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„æ“ä½œ
    if (operationLocks.size > 0) {
        console.log('âš ï¸ æœ‰æ­£åœ¨è¿›è¡Œçš„æ“ä½œï¼Œå»¶è¿Ÿå¤„ç†è¿œç¨‹æ›´æ–°');
        setTimeout(() => handleRemoteRoomsUpdate(remoteRooms), 1000);
        return;
    }
    
    console.log('ğŸ“¥ æ”¶åˆ°è¿œç¨‹æˆ¿é—´æ•°æ®æ›´æ–°');
    
    let hasChanges = false;
    const changes = [];
    const now = Date.now();
    const conflicts = [];
    
    remoteRooms.forEach((remoteRoom, index) => {
        const localRoom = rooms.find(r => r.name === remoteRoom.name);
        if (!localRoom) return;
        
        const oldStudent = localRoom.student;
        const newStudent = remoteRoom.student;
        const oldTime = localRoom.registerTime;
        const newTime = remoteRoom.registerTime;
        
        // ğŸ”¥ æ–°å¢ï¼šä¿æŠ¤æœ€è¿‘çš„åŒå‡»æ¸…ç©ºæ“ä½œï¼Œé˜²æ­¢è¢«è¿œç¨‹æ›´æ–°è¦†ç›–
        const recentClearTime = window.lastClearOperations?.get(remoteRoom.name);
        if (recentClearTime && (now - recentClearTime) < 2000) { // 2ç§’å†…çš„æ¸…ç©ºæ“ä½œä¿æŠ¤
            if (newStudent && !oldStudent) {
                console.log(`ğŸ›¡ï¸ ä¿æŠ¤æœ€è¿‘æ¸…ç©ºæ“ä½œï¼šå¿½ç•¥ ${remoteRoom.name} çš„è¿œç¨‹å­¦ç”Ÿç™»è®° (${newStudent})`);
                return; // è·³è¿‡è¿™ä¸ªæˆ¿é—´çš„æ›´æ–°
            }
        }
        
        // ğŸ”¥ æ–°å¢ï¼šæ¸…ç†è¿‡æœŸçš„æ¸…ç©ºæ“ä½œè®°å½•ï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
        if (window.lastClearOperations) {
            for (const [roomName, clearTime] of window.lastClearOperations.entries()) {
                if (now - clearTime > 5000) { // 5ç§’åæ¸…ç†
                    window.lastClearOperations.delete(roomName);
                }
            }
        }
        
        // ğŸ”¥ å¢å¼ºå†²çªæ£€æµ‹é€»è¾‘
        if (oldStudent && newStudent && oldStudent !== newStudent) {
            const timeDiff = Math.abs((newTime || 0) - (oldTime || 0));
            
            // ğŸ”¥ å…³é”®ï¼šå¦‚æœæ—¶é—´å·®å¾ˆå°ï¼Œè¯´æ˜æ˜¯åŒæ—¶æ“ä½œå†²çª
            if (timeDiff < 3000) { // 3ç§’å†…çš„æ“ä½œè®¤ä¸ºæ˜¯å†²çª
                conflicts.push({
                    room: remoteRoom.name,
                    local: { student: oldStudent, time: oldTime },
                    remote: { student: newStudent, time: newTime },
                    timeDiff: timeDiff
                });
                
                // ğŸ”¥ å†²çªè§£å†³ï¼šä½¿ç”¨æ—¶é—´æˆ³è¾ƒæ–°çš„
                if ((newTime || 0) > (oldTime || 0)) {
                    changes.push(`ğŸ”„ å†²çªè§£å†³ï¼š${remoteRoom.name} ç”± ${oldStudent} æ”¹ä¸º ${newStudent}`);
                    localRoom.student = newStudent;
                    localRoom.registerTime = newTime;
                    hasChanges = true;
                    
                    // è®°å½•å†²çªè§£å†³æ—¥å¿—
                    addPracticeLog(oldStudent, remoteRoom.name, oldTime, now, `å†²çªè§£å†³è¢«æ›¿æ¢(è¿œç¨‹ä¼˜å…ˆ,æ—¶å·®${timeDiff}ms)`);
                } else {
                    console.log(`âš ï¸ å¿½ç•¥è¾ƒæ—§çš„è¿œç¨‹æ›´æ–°: ${remoteRoom.name}, æ—¶å·®: ${timeDiff}ms`);
                    return;
                }
            } else {
                // æ—¶é—´å·®è¾ƒå¤§ï¼Œæ­£å¸¸å¤„ç†
                if ((newTime || 0) > (oldTime || 0)) {
                    changes.push(`ğŸ”„ æ­£å¸¸æ›´æ–°ï¼š${remoteRoom.name} ç”± ${oldStudent} æ”¹ä¸º ${newStudent}`);
                    localRoom.student = newStudent;
                    localRoom.registerTime = newTime;
                    hasChanges = true;
                    addPracticeLog(oldStudent, remoteRoom.name, oldTime, now, 'è¿œç¨‹æ›´æ–°æ›¿æ¢');
                }
            }
        } else {
            // æ­£å¸¸çš„å˜åŒ–æ£€æµ‹
            const studentChanged = oldStudent !== newStudent;
            const timeChanged = oldTime !== newTime;
            
            if (studentChanged || timeChanged) {
                const timeIsValid = !newTime || (newTime > 0 && newTime <= now + 60000);
                
                if (!timeIsValid && newStudent) {
                    console.warn('âš ï¸ æ£€æµ‹åˆ°æ— æ•ˆæ—¶é—´æˆ³ï¼Œè·³è¿‡æ­¤æ¬¡æ›´æ–°:', {
                        room: remoteRoom.name,
                        student: newStudent,
                        time: newTime
                    });
                    return;
                }
                
                localRoom.student = newStudent;
                localRoom.registerTime = newTime;
                hasChanges = true;
                
                if (newStudent && !oldStudent) {
                    changes.push(`${newStudent} ç™»è®°äº† ${remoteRoom.name}`);
                } else if (!newStudent && oldStudent) {
                    changes.push(`${oldStudent} ç¦»å¼€äº† ${remoteRoom.name}`);
                } else if (newStudent && oldStudent && newStudent !== oldStudent) {
                    changes.push(`${remoteRoom.name}: ${oldStudent} â†’ ${newStudent}`);
                }
            }
        }
    });
    
    if (hasChanges) {
        console.log('ğŸ”„ åº”ç”¨è¿œç¨‹æˆ¿é—´å˜åŒ–:', changes);
        
        if (conflicts.length > 0) {
            console.warn('âš ï¸ æ£€æµ‹åˆ°åˆ†é…å†²çª:', conflicts);
            showToast(`âš ï¸ æ£€æµ‹åˆ° ${conflicts.length} ä¸ªåˆ†é…å†²çªï¼Œå·²è‡ªåŠ¨è§£å†³`, 4000);
        }
        
        // ğŸ”¥ å¢å¼ºï¼šä½¿ç”¨é˜²æŠ–æ›´æ–°ï¼Œé¿å…é¢‘ç¹åˆ·æ–°
        clearTimeout(window.remoteUpdateTimeout);
        window.remoteUpdateTimeout = setTimeout(() => {
            syncEnabled = false;
            
            persistRooms();
            needsFullUpdate = true;
            updateRooms();
            
            // åˆ·æ–°ç›¸å…³ç•Œé¢
            const overtimeModal = document.getElementById('overtimeModal');
            if (overtimeModal && overtimeModal.style.display === 'block') {
                renderOvertimeList(true);
            }
            
            if (changes.length > 0) {
                showToast('ğŸ”„ ' + changes.slice(0, 3).join('; ') + (changes.length > 3 ? '...' : ''), 4000);
            }
            
            setTimeout(() => {
                syncEnabled = true;
            }, 1500); // å¢åŠ ç¦ç”¨æ—¶é—´
        }, 200); // 200ms é˜²æŠ–
    }
}


// å¤„ç†è¿œç¨‹æ’é˜Ÿæ•°æ®æ›´æ–°
function handleRemoteQueueUpdate(remoteQueue) {
    if (!remoteQueue || typeof remoteQueue !== 'object' || !syncEnabled) return;
    
    console.log('ğŸ“¥ æ”¶åˆ°è¿œç¨‹æ’é˜Ÿæ•°æ®æ›´æ–°');
    
    let hasChanges = false;
    const changes = [];
    
    ['grand', 'upright', 'none'].forEach(type => {
        const remoteList = remoteQueue[type] || [];
        const localList = queueList[type] || [];
        
        if (JSON.stringify(remoteList) !== JSON.stringify(localList)) {
            const typeName = type === 'grand' ? 'ä¸‰è§’' : type === 'upright' ? 'ç«‹å¼' : 'æ™®é€š';
            changes.push(`${typeName}æ’é˜Ÿ: ${localList.length} â†’ ${remoteList.length}äºº`);
            
            queueList[type] = [...remoteList];
            hasChanges = true;
        }
    });
    
    if (hasChanges) {
        console.log('ğŸ”„ åº”ç”¨è¿œç¨‹æ’é˜Ÿå˜åŒ–:', changes);
        
        syncEnabled = false;
        persistQueues();
        updateQueueDisplay();
        
        if (changes.length > 0) {
            showToast('ğŸ”„ æ’é˜Ÿæ›´æ–°: ' + changes.join('; '), 3000);
        }
        
        setTimeout(() => {
            syncEnabled = true;
        }, 1000);
    }
}

// å¤„ç†è¿œç¨‹å­¦ç”Ÿæ•°æ®åº“æ›´æ–°
function handleRemoteStudentDbUpdate(remoteStudentDb) {
    if (!remoteStudentDb || typeof remoteStudentDb !== 'object' || !syncEnabled) return;
    
    if (JSON.stringify(studentDatabase) !== JSON.stringify(remoteStudentDb)) {
        console.log('ğŸ“¥ æ”¶åˆ°è¿œç¨‹å­¦ç”Ÿæ•°æ®åº“æ›´æ–°');
        
        syncEnabled = false;
        studentDatabase = { ...remoteStudentDb };
        persistStudents();
        
        // åˆ·æ–°ç›¸å…³UI
        if ($('studentDatabaseModal').style.display === 'block') {
            renderStudentDatabaseList();
        }
        
        showToast('ğŸ”„ å­¦ç”Ÿæ•°æ®åº“å·²åŒæ­¥', 2000);
        
        setTimeout(() => {
            syncEnabled = true;
        }, 1000);
    }
}
// ğŸ”¥ æ–°å¢ï¼šå¤„ç†è¿œç¨‹è¯·å‡æ•°æ®æ›´æ–°
function handleRemoteExcuseUpdate(excuseData, action) {
    if (!excuseData || typeof excuseData !== 'object' || !syncEnabled) return;
    
    console.log('ğŸ“¥ æ”¶åˆ°è¿œç¨‹è¯·å‡æ•°æ®æ›´æ–°:', excuseData);
    
    const studentName = excuseData.studentName;
    const isCancel = excuseData.action === 'cancel_excuse';
    const isAutoRecover = excuseData.action === 'auto_recover_expired_excuses';
    
    // ğŸ”¥ æ–°å¢ï¼šå¤„ç†è‡ªåŠ¨æ¢å¤è®°å½•
    if (isAutoRecover) {
        // è§¦å‘æœ¬åœ°çš„è¿‡æœŸæ£€æŸ¥
        checkExpiredExcuses();
        return;
    }
    
    // æŸ¥æ‰¾å¯¹åº”çš„è€ƒå‹¤è®°å½•
    const targets = [...(attendanceData.students || []), ...(attendanceData.endedSlots || [])]
        .filter(s => s.name === studentName);
    
    if (!targets.length) {
        console.log('âš ï¸ æœªæ‰¾åˆ°å¯¹åº”çš„è€ƒå‹¤è®°å½•:', studentName);
        return;
    }
    
    let hasChanges = false;
    
    targets.forEach(stu => {
        if (isCancel) {
            // å–æ¶ˆè¯·å‡ï¼šé‡æ–°è®¡ç®—çŠ¶æ€
            if (stu.finalAttendanceStatus === 'excused') {
                const practicedSec = getStudentPracticeTimeInSlot(stu.name, stu);
                const realtimeStatus = getStudentAttendanceStatus(stu.name);
                const calc = calculateAttendanceStatus(stu.name, stu, realtimeStatus, practicedSec);
                Object.assign(stu, calc, {
                    practicedSec,
                    practicedText: fmtPracticeSec(practicedSec),
                    excuseEndDate: null // ğŸ”¥ æ¸…é™¤è¯·å‡ç»“æŸæ—¥æœŸ
                });
                hasChanges = true;
            }
        } else {
            // è®¾ç½®è¯·å‡
            if (stu.finalAttendanceStatus !== 'excused') {
                // ğŸ”¥ æ–°å¢ï¼šå¤„ç†è¯·å‡æœ‰æ•ˆæœŸ
                const statusText = excuseData.endDate 
                    ? `å·²è¯·å‡ï¼š${excuseData.reason}ï¼ˆ${excuseData.durationText || 'æœ‰æœŸé™'}ï¼‰`
                    : `å·²è¯·å‡ï¼š${excuseData.reason}ï¼ˆä»…æœ¬æ¬¡ï¼‰`;
                
                stu.finalAttendanceStatus = 'excused';
                stu.finalStatusText = statusText;
                stu.excuseEndDate = excuseData.endDate; // ğŸ”¥ æ–°å¢ï¼šä¿å­˜è¯·å‡ç»“æŸæ—¥æœŸ
                hasChanges = true;
            }
        }
    });
    
    if (hasChanges) {
        syncEnabled = false;
        
        // åˆ·æ–°UI
        if (isAttendanceModalOpen) {
            renderAttendanceList(false);
        }
        updateAttendanceBadge();
        
        const action = isCancel ? 'å–æ¶ˆè¯·å‡' : 'è¯·å‡';
        showToast(`ğŸ”„ ${studentName} ${action}çŠ¶æ€å·²åŒæ­¥`, 2000);
        
        setTimeout(() => {
            syncEnabled = true;
        }, 1000);
    }
}

// ä¿®æ”¹ç°æœ‰çš„ handleRemoteRoomDbUpdate å‡½æ•°
function handleRemoteRoomDbUpdate(remoteRoomDb) {
    if (!remoteRoomDb || typeof remoteRoomDb !== 'object' || !syncEnabled) return;
    
    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æˆ¿é—´è¢«åˆ é™¤
    const localRoomNames = new Set(Object.keys(roomDatabase));
    const remoteRoomNames = new Set(Object.keys(remoteRoomDb));
    
    // æ‰¾å‡ºè¢«åˆ é™¤çš„æˆ¿é—´
    const deletedRooms = [];
    localRoomNames.forEach(name => {
        if (!remoteRoomNames.has(name)) {
            deletedRooms.push(name);
        }
    });
    
    // æ‰¾å‡ºæ–°å¢æˆ–æ›´æ–°çš„æˆ¿é—´
    const hasChanges = JSON.stringify(roomDatabase) !== JSON.stringify(remoteRoomDb);
    
    if (hasChanges || deletedRooms.length > 0) {
        console.log('ğŸ“¥ æ”¶åˆ°è¿œç¨‹æˆ¿é—´æ•°æ®åº“æ›´æ–°');
        
        if (deletedRooms.length > 0) {
            console.log('ğŸ—‘ï¸ æ£€æµ‹åˆ°è¿œç¨‹åˆ é™¤çš„æˆ¿é—´:', deletedRooms);
            
            // å¤„ç†è¢«åˆ é™¤æˆ¿é—´çš„å ç”¨çŠ¶æ€
            deletedRooms.forEach(roomName => {
                const room = rooms.find(r => r.name === roomName);
                if (room && room.student) {
                    console.log(`ğŸ“ è®°å½•è¢«åˆ é™¤æˆ¿é—´çš„å ç”¨æ—¥å¿—: ${roomName} - ${room.student}`);
                    addPracticeLog(
                        room.student,
                        room.name,
                        room.registerTime,
                        Date.now(),
                        'æˆ¿é—´è¢«è¿œç¨‹åˆ é™¤'
                    );
                }
            });
        }
        
        syncEnabled = false;
        roomDatabase = { ...remoteRoomDb };
        persistRoomDb();
        
        // ğŸ”¥ å…³é”®ï¼šä½¿ç”¨ä¿®å¤åçš„åŒæ­¥å‡½æ•°ï¼Œä¼šæ­£ç¡®å¤„ç†åˆ é™¤
        roomDbSyncRoomsFromDatabase();
        
        // åˆ·æ–°æˆ¿é—´æ•°æ®åº“ç•Œé¢ï¼ˆå¦‚æœæ‰“å¼€ï¼‰
        if ($('roomDatabaseModal').style.display === 'block') {
            roomDbRenderList();
        }
        
        const changeMsg = deletedRooms.length > 0 
            ? `æˆ¿é—´æ•°æ®åº“å·²åŒæ­¥ï¼ˆåˆ é™¤${deletedRooms.length}é—´ï¼‰`
            : 'æˆ¿é—´æ•°æ®åº“å·²åŒæ­¥';
            
        showToast('ğŸ”„ ' + changeMsg, 2000);
        
        setTimeout(() => {
            syncEnabled = true;
        }, 1000);
    }
}
// ğŸ”¥ æ–°å¢ï¼šä¸“é—¨å¤„ç†æˆ¿é—´åˆ é™¤çš„åŒæ­¥å‡½æ•°
function syncRoomDeletion(roomName, wasOccupied = false) {
    if (!syncEnabled || !isOnline || !database) return;
    
    console.log(`ğŸ”„ åŒæ­¥æˆ¿é—´åˆ é™¤åˆ°äº‘ç«¯: ${roomName}`);
    
    const updates = {};
    
    // æ›´æ–°æˆ¿é—´æ•°æ®åº“
    updates[FIREBASE_PATHS.ROOM_DB] = roomDatabase;
    
    // æ›´æ–°è¿è¡Œæ—¶æˆ¿é—´æ•°ç»„
    const cleanRooms = rooms.map(r => ({
        ...r,
        student: r.student || null,
        registerTime: r.registerTime || null
    }));
    updates[FIREBASE_PATHS.ROOMS] = cleanRooms;
    
    // æ·»åŠ åˆ é™¤æ“ä½œè®°å½•
    updates[FIREBASE_PATHS.LAST_UPDATE] = {
        timestamp: Date.now(),
        deviceId: deviceId,
        action: 'room_delete',
        roomName: roomName,
        wasOccupied: wasOccupied
    };
    
    database.ref().update(updates)
        .then(() => {
            console.log('âœ… æˆ¿é—´åˆ é™¤åŒæ­¥æˆåŠŸ');
            showToast('âœ… æˆ¿é—´åˆ é™¤å·²åŒæ­¥åˆ°æ‰€æœ‰è®¾å¤‡', 2000);
        })
        .catch(error => {
            console.error('âŒ æˆ¿é—´åˆ é™¤åŒæ­¥å¤±è´¥:', error);
            showToast('âŒ æˆ¿é—´åˆ é™¤åŒæ­¥å¤±è´¥', 3000);
        });
}

// ğŸ”¥ æ–°å¢ï¼šå¤„ç†è¿œç¨‹å­¦ç”Ÿæ—¶é—´æ®µæ›´æ–°
function handleRemoteStudentSlotsUpdate(remoteSlots) {
    if (!remoteSlots || typeof remoteSlots !== 'object' || !syncEnabled) return;
    
    if (JSON.stringify(studentTimeSlots) !== JSON.stringify(remoteSlots)) {
        console.log('ğŸ“¥ æ”¶åˆ°è¿œç¨‹å­¦ç”Ÿæ—¶é—´æ®µæ›´æ–°');
        
        syncEnabled = false;
        studentTimeSlots = { ...remoteSlots };
        persistStudentSlots();
        
        // åˆ·æ–°ç›¸å…³UI
        if ($('timeSlotModal').style.display === 'block') {
            displayCurrentTimeSlots();
            displayWeeklySummary();
        }
        if ($('studentDatabaseModal').style.display === 'block') {
            renderStudentDatabaseList();
        }
        if ($('attendanceModal').style.display === 'block') {
            renderAttendanceList(true);
        }
        
        showToast('ğŸ”„ å­¦ç”Ÿæ—¶é—´æ®µå·²åŒæ­¥', 2000);
        
        setTimeout(() => {
            syncEnabled = true;
        }, 1000);
    }
}

// ğŸ”¥ æ–°å¢ï¼šå¤„ç†è¿œç¨‹ç³»ç»Ÿè®¾ç½®æ›´æ–°
function handleRemoteSystemSettingsUpdate(remoteSettings) {
    if (!remoteSettings || typeof remoteSettings !== 'object' || !syncEnabled) return;
    
    if (JSON.stringify(systemSettings) !== JSON.stringify(remoteSettings)) {
        console.log('ğŸ“¥ æ”¶åˆ°è¿œç¨‹ç³»ç»Ÿè®¾ç½®æ›´æ–°');
        
        syncEnabled = false;
        const oldDuration = systemSettings.basePracticeDuration;
        systemSettings = { ...DEFAULT_SETTINGS, ...remoteSettings };
        persistSettings();
        
        // å¦‚æœåŸºç¡€æ—¶é•¿å˜åŒ–ï¼Œéœ€è¦åˆ·æ–°æ‰€æœ‰çŠ¶æ€
        if (oldDuration !== systemSettings.basePracticeDuration) {
            applyAfterBaseDurationChange();
        }
        
        // åˆ·æ–°ç›¸å…³UI
        if ($('settingsModal').style.display === 'block') {
            $('baseDurationInput').value = systemSettings.basePracticeDuration;
            $('resetHourInput').value = systemSettings.autoResetHour;
            $('resetMinuteInput').value = systemSettings.autoResetMinute;
            $('stopAnomalyHourInput').value = systemSettings.stopAnomalyCheckHour;
            $('stopAnomalyMinuteInput').value = systemSettings.stopAnomalyCheckMinute || 0;
            updateDurationPreview();
            updateResetTimePreview();
            updateStopAnomalyPreview();
        }
        
        showToast('ğŸ”„ ç³»ç»Ÿè®¾ç½®å·²åŒæ­¥', 2000);
        
        setTimeout(() => {
            syncEnabled = true;
        }, 1000);
    }
}



// æ³¨å†Œè®¾å¤‡
function registerDevice() {
    if (!database || !isOnline) return;
    
    const deviceRef = database.ref(FIREBASE_PATHS.DEVICE_STATUS + '/' + deviceId);
    deviceRef.set({
        lastSeen: Date.now(),
        userAgent: navigator.userAgent,
        online: true
    });
    
    // è®¾ç½®ç¦»çº¿æ—¶çš„çŠ¶æ€
    deviceRef.onDisconnect().update({
        online: false,
        lastSeen: Date.now()
    });
}

// è·å–è®¾å¤‡ID
function getDeviceId() {
    let id = localStorage.getItem('deviceId');
    if (!id) {
        id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', id);
    }
    return id;
}

// åˆ›å»ºè¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨
function createConnectionIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'connectionStatus';
    indicator.style.cssText = `
        position: fixed;
        top: 50px;
        left: 10px;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        z-index: 1000;
        transition: all 0.3s ease;
        cursor: pointer;
        user-select: none;
    `;
    
    indicator.addEventListener('click', showSyncStatus);
    document.body.appendChild(indicator);
    
    updateConnectionStatus();
}

// æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
function updateConnectionStatus() {
    const indicator = document.getElementById('connectionStatus');
    if (!indicator) return;
    
    if (isOnline) {
        indicator.className = 'connection-online';
        indicator.textContent = 'ğŸŸ¢ äº‘ç«¯å·²è¿æ¥';
        indicator.title = 'ç‚¹å‡»æŸ¥çœ‹åŒæ­¥çŠ¶æ€è¯¦æƒ…';
        indicator.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
        indicator.style.color = 'white';
        indicator.style.boxShadow = '0 2px 8px rgba(39, 174, 96, 0.3)';
    } else {
        indicator.className = 'connection-offline';
        indicator.textContent = 'ğŸ”´ äº‘ç«¯æ–­å¼€';
        indicator.title = 'ä¸äº‘ç«¯æœåŠ¡å™¨æ–­å¼€è¿æ¥';
        indicator.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
        indicator.style.color = 'white';
        indicator.style.boxShadow = '0 2px 8px rgba(231, 76, 60, 0.3)';
    }
}

// æ˜¾ç¤ºåŒæ­¥çŠ¶æ€è¯¦æƒ…
function showSyncStatus() {
    const roomCount = Object.keys(roomDatabase).length;
    const studentCount = Object.values(studentDatabase).reduce((a,b)=>a+b.length,0);
    const slotCount = Object.keys(studentTimeSlots).length;
    const reminderCount = practiceOverrunReminders.length;
    
    const status = `
Firebase åŒæ­¥çŠ¶æ€è¯¦æƒ…ï¼š

â€¢ è¿æ¥çŠ¶æ€: ${isOnline ? 'âœ… å·²è¿æ¥' : 'âŒ å·²æ–­å¼€'}
â€¢ åŒæ­¥åŠŸèƒ½: ${syncEnabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'}
â€¢ è®¾å¤‡ID: ${deviceId}
â€¢ é¡¹ç›®ID: ${firebaseConfig.projectId}
â€¢ æ•°æ®åº“: ${firebaseConfig.databaseURL}
â€¢ ä¸Šæ¬¡åŒæ­¥: ${lastSyncTime ? new Date(lastSyncTime).toLocaleString() : 'æœªåŒæ­¥'}

åŒæ­¥æ•°æ®æ¦‚è§ˆï¼š
â€¢ ç´æˆ¿åº“: ${roomCount} é—´
â€¢ å­¦ç”Ÿåº“: ${studentCount} äºº
â€¢ æ—¶é—´æ®µ: ${slotCount} äººå·²è®¾ç½®
â€¢ å¼‚å¸¸æé†’: ${reminderCount} æ¡
â€¢ è€ƒå‹¤æ•°æ®: ${attendanceData.students?.length || 0} æ¡è®°å½•

æµ‹è¯•è¯´æ˜ï¼š
1. åœ¨å¦ä¸€å°è®¾å¤‡æ‰“å¼€åŒæ ·çš„ç³»ç»Ÿ
2. åœ¨ä»»ä¸€è®¾å¤‡è¿›è¡Œæ“ä½œï¼ˆç™»è®°ã€æ’é˜Ÿã€è®¾ç½®ç­‰ï¼‰
3. å¦ä¸€å°è®¾å¤‡åº”ç«‹å³æ˜¾ç¤ºæ›´æ–°
    `.trim();
    
    alert(status);
}

/// ä¿®æ”¹ç°æœ‰çš„æŒä¹…åŒ–å‡½æ•°ï¼Œæ·»åŠ  Firebase åŒæ­¥
const originalPersistRooms = persistRooms;
persistRooms = function() {
    originalPersistRooms();
    if (syncEnabled && isOnline) {
        syncToFirebase('room_update');
    }
};

const originalPersistQueues = persistQueues;
persistQueues = function() {
    originalPersistQueues();
    if (syncEnabled && isOnline) {
        syncToFirebase('queue_update');
    }
};

const originalPersistStudents = persistStudents;
persistStudents = function() {
    originalPersistStudents();
    if (syncEnabled && isOnline && database) {
        database.ref(FIREBASE_PATHS.STUDENT_DB).set(studentDatabase);
    }
};

const originalPersistRoomDb = persistRoomDb;
persistRoomDb = function() {
    originalPersistRoomDb();
    if (syncEnabled && isOnline && database) {
        database.ref(FIREBASE_PATHS.ROOM_DB).set(roomDatabase);
    }
};

// ğŸ”¥ æ–°å¢ï¼šå­¦ç”Ÿæ—¶é—´æ®µåŒæ­¥
const originalPersistStudentSlots = persistStudentSlots;
persistStudentSlots = function() {
    originalPersistStudentSlots();
    if (syncEnabled && isOnline && database) {
        database.ref(FIREBASE_PATHS.STUDENT_SLOTS).set(studentTimeSlots);
    }
};

// ğŸ”¥ æ–°å¢ï¼šç³»ç»Ÿè®¾ç½®åŒæ­¥
const originalPersistSettings = persistSettings;
persistSettings = function() {
    originalPersistSettings();
    if (syncEnabled && isOnline && database) {
        database.ref(FIREBASE_PATHS.SYSTEM_SETTINGS).set(systemSettings);
    }
};



// ========== å¤„ç†è¿œç«¯ overrunData å…¨é‡åŒ… ==========
function handleRemoteOverrunDataUpdate(remote) {
  if (!remote || typeof remote !== 'object') return;

  // ç‰ˆæœ¬åˆ¤æ–­ï¼šè‹¥è¿œç«¯ç‰ˆæœ¬ <= æœ¬åœ°ç‰ˆæœ¬ï¼Œåˆ™å¿½ç•¥ï¼ˆé¿å…å›é€€ï¼‰
  if (remote.version && lastOverrunVersion && remote.version <= lastOverrunVersion) {
    console.log('â¸ï¸ è·³è¿‡è¾ƒæ—§çš„è¿œç¨‹å¼‚å¸¸æé†’æ•°æ®:', remote.version, '<=', lastOverrunVersion);
    return;
  }

  console.log('ğŸ“¥ æ”¶åˆ°è¿œç¨‹å¼‚å¸¸æé†’æ•°æ®æ›´æ–°:', remote);

  // ä¸å†ç”¨ syncEnabled é˜»æŒ¡"è¯»"ï¼Œåªé™åˆ¶"å†™"
  const { reminders = [], ignored = [], stats = {}, version = Date.now() } = remote;

  // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ­£ç¡®å¤„ç†å¿½ç•¥é›†åˆ
  let ignoredArray = [];
  if (Array.isArray(ignored)) {
    ignoredArray = ignored;
  } else if (ignored && typeof ignored === 'object') {
    // å¤„ç†å¯èƒ½çš„å¯¹è±¡æ ¼å¼
    ignoredArray = Object.values(ignored).filter(v => typeof v === 'string');
  }

  // åº”ç”¨è¿œç¨‹æ•°æ®
  practiceOverrunReminders = Array.isArray(reminders) ? reminders : [];
  overrunIgnoredKeys = new Set(ignoredArray);
  overrunStats = stats || {};
  lastOverrunVersion = version;

  // åªæœ¬åœ°ç¼“å­˜ï¼Œä¸å†å›å†™äº‘ç«¯ï¼Œé¿å…é•œåƒå†™
  lsSet(KEYS.OVERRUN_REMINDERS, practiceOverrunReminders);
  lsSet(KEYS.OVERRUN_IGNORED, [...overrunIgnoredKeys]);
  lsSet(KEYS.OVERRUN_STATS, overrunStats);
  
  updateOverrunPanel();

  // è‹¥è€ƒå‹¤é¢æ¿æ‰“å¼€ï¼Œå¯åˆ·æ–°
  const attModal = $('attendanceModal');
  if (attModal && attModal.style.display === 'block') {
    renderAttendanceList(false);
  }

  console.log('âœ… è¿œç¨‹å¼‚å¸¸æé†’æ•°æ®å·²åº”ç”¨:', {
    reminders: practiceOverrunReminders.length,
    ignored: overrunIgnoredKeys.size,
    statsKeys: Object.keys(overrunStats).length
  });
}
// ğŸ”¥ æ–°å¢ï¼šå¤„ç†è¿œç¨‹ç»ƒä¹ è®°å½•æ›´æ–°
function handleRemotePracticeRecordUpdate(dateKey, remoteData) {
    if (!remoteData || typeof remoteData !== 'object' || !syncEnabled) return;
    
    console.log('ğŸ“¥ æ”¶åˆ°è¿œç¨‹ç»ƒä¹ è®°å½•æ›´æ–°:', dateKey);
    
    if (!dailyPracticeRecords[dateKey]) {
        dailyPracticeRecords[dateKey] = {};
    }
    
    Object.keys(remoteData).forEach(studentName => {
        const remoteRecord = remoteData[studentName];
        const localRecord = dailyPracticeRecords[dateKey][studentName];
        
        // å¦‚æœè¿œç¨‹è®°å½•æ›´æ–°æ—¶é—´æ›´æ–°ï¼Œåˆ™åº”ç”¨è¿œç¨‹æ•°æ®
        if (!localRecord || remoteRecord.lastUpdated > localRecord.lastUpdated) {
            dailyPracticeRecords[dateKey][studentName] = {
                inSlot: remoteRecord.inSlotSeconds || 0,
                outSlot: remoteRecord.outSlotSeconds || 0,
                totalSessions: remoteRecord.totalSessions || 0,
                sessions: [], // è¯¦ç»†ä¼šè¯ä¿¡æ¯ä¸ä»è¿œç¨‹åŒæ­¥
                lastUpdated: remoteRecord.lastUpdated || Date.now()
            };
        }
    });
    
    persistPracticeRecords();
    console.log('âœ… è¿œç¨‹ç»ƒä¹ è®°å½•å·²åº”ç”¨');
}


function setupDataListeners() {
    console.log('ğŸ‘‚ è®¾ç½®æ•°æ®ç›‘å¬å™¨...');
    
    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šç¡®ä¿databaseå·²æ­£ç¡®åˆå§‹åŒ–
    if (!database) {
        console.error('Database not initialized');
        return;
    }
    
    try {
        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬åŒæ­¥é€šçŸ¥
        listenForSyncNotifications();
        
        // ç›‘å¬æˆ¿é—´æ•°æ®å˜åŒ–
        database.ref(FIREBASE_PATHS.ROOMS).on('value', (snapshot) => {
            if (snapshot.exists()) {
                handleRemoteRoomsUpdate(snapshot.val());
            }
        }, (error) => {
            console.error('æˆ¿é—´æ•°æ®ç›‘å¬é”™è¯¯:', error);
        });
        
        // ç›‘å¬æ’é˜Ÿæ•°æ®å˜åŒ–
        database.ref(FIREBASE_PATHS.QUEUE).on('value', (snapshot) => {
            if (snapshot.exists()) {
                handleRemoteQueueUpdate(snapshot.val());
            }
        }, (error) => {
            console.error('æ’é˜Ÿæ•°æ®ç›‘å¬é”™è¯¯:', error);
        });
        
        // ç›‘å¬å­¦ç”Ÿæ•°æ®åº“å˜åŒ–
        database.ref(FIREBASE_PATHS.STUDENT_DB).on('value', (snapshot) => {
            if (snapshot.exists()) {
                handleRemoteStudentDbUpdate(snapshot.val());
            }
        }, (error) => {
            console.error('å­¦ç”Ÿæ•°æ®åº“ç›‘å¬é”™è¯¯:', error);
        });
        
        // ğŸ”¥ åˆ é™¤ï¼šå®æ—¶ç»ƒç´çŠ¶æ€ç›‘å¬ï¼ˆå·²åˆå¹¶åˆ°æˆ¿é—´çŠ¶æ€ï¼‰
        
        // ç›‘å¬ç´æˆ¿æ•°æ®åº“å˜åŒ–
        database.ref(FIREBASE_PATHS.ROOM_DB).on('value', (snapshot) => {
            if (snapshot.exists()) {
                handleRemoteRoomDbUpdate(snapshot.val());
            }
        }, (error) => {
            console.error('ç´æˆ¿æ•°æ®åº“ç›‘å¬é”™è¯¯:', error);
        });
        
        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬ç»ƒä¹ è®°å½•å˜åŒ–
        database.ref(FIREBASE_PATHS.PRACTICE_RECORDS).on('child_changed', (snapshot) => {
            if (snapshot.exists()) {
                handleRemotePracticeRecordUpdate(snapshot.key, snapshot.val());
            }
        }, (error) => {
            console.error('ç»ƒä¹ è®°å½•ç›‘å¬é”™è¯¯:', error);
        });

        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬å­¦ç”Ÿæ—¶é—´æ®µå˜åŒ–
        database.ref(FIREBASE_PATHS.STUDENT_SLOTS).on('value', (snapshot) => {
            if (snapshot.exists()) {
                handleRemoteStudentSlotsUpdate(snapshot.val());
            }
        }, (error) => {
            console.error('å­¦ç”Ÿæ—¶é—´æ®µç›‘å¬é”™è¯¯:', error);
        });
        
        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬ç³»ç»Ÿè®¾ç½®å˜åŒ–
        database.ref(FIREBASE_PATHS.SYSTEM_SETTINGS).on('value', (snapshot) => {
            if (snapshot.exists()) {
                handleRemoteSystemSettingsUpdate(snapshot.val());
            }
        }, (error) => {
            console.error('ç³»ç»Ÿè®¾ç½®ç›‘å¬é”™è¯¯:', error);
        });
        
        // ğŸ”¥ ä¿®å¤ï¼šç»Ÿä¸€ç›‘å¬å¼‚å¸¸æé†’ overrunData
        database.ref(FIREBASE_PATHS.OVERRUN_DATA).on('value', snapshot => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            console.log('ğŸ“¥ æ”¶åˆ°è¿œç¨‹ overrunData æ›´æ–°:', data);
            handleRemoteOverrunDataUpdate(data);
          }
        }, err => {
          console.error('å¼‚å¸¸æé†’ overrunData ç›‘å¬é”™è¯¯:', err);
        });      

        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬è¯·å‡æ•°æ®å˜åŒ–
        database.ref(FIREBASE_PATHS.EXCUSE_DATA).on('child_added', (snapshot) => {
            if (snapshot.exists()) {
                handleRemoteExcuseUpdate(snapshot.val(), 'added');
            }
        }, (error) => {
            console.error('è¯·å‡æ•°æ®ç›‘å¬é”™è¯¯:', error);
        });
        
        // ğŸ”¥ æ–°å¢ï¼šç›‘å¬è¯·å‡æ•°æ®ä¿®æ”¹
        database.ref(FIREBASE_PATHS.EXCUSE_DATA).on('child_changed', (snapshot) => {
            if (snapshot.exists()) {
                handleRemoteExcuseUpdate(snapshot.val(), 'changed');
            }
        }, (error) => {
            console.error('è¯·å‡æ•°æ®ä¿®æ”¹ç›‘å¬é”™è¯¯:', error);
        });
        
    } catch (error) {
        console.error('è®¾ç½®ç›‘å¬å™¨å¤±è´¥:', error);
    }
    
    console.log('âœ… æ•°æ®ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
}


function pad2(n){return n.toString().padStart(2,'0');}

// æ ‡å‡†åŒ–æ—¶é—´æ ¼å¼ï¼Œå°† "8:00" è½¬æ¢ä¸º "08:00"
function normalizeTimeFormat(timeStr) {
  if (!timeStr || typeof timeStr !== 'string') return timeStr;
  const parts = timeStr.trim().split(':');
  if (parts.length !== 2) return timeStr;
  const hours = parts[0].padStart(2, '0');
  const minutes = parts[1].padStart(2, '0');
  return `${hours}:${minutes}`;
}
function todayKey(){
  const d=new Date();
  return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate());
}
function toDateKey(dateLike){
  if(!dateLike) return null;
  // å·²æ˜¯ yyyy-mm-dd
  if(/^\d{4}-\d{2}-\d{2}$/.test(dateLike)) return dateLike;
  const d=new Date(dateLike);
  if(isNaN(d.getTime())) return null;
  return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate());
}

function formatHMS(sec){
  const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;
  return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
}
function minutesToTime(m){return `${pad2(Math.floor(m/60))}:${pad2(m%60)}`;}
function timeToMinutes(t){const [H,M]=t.split(':').map(Number);return H*60+M;}
function formatDurationHuman(seconds){
  if(seconds<=0) return '0ç§’';
  const h=Math.floor(seconds/3600),m=Math.floor((seconds%3600)/60),s=seconds%60;
  if(h) return `${h}å°æ—¶${m?m+'åˆ†':''}${s? s+'ç§’':''}`;
  if(m) return `${m}åˆ†${s? s+'ç§’':''}`;
  return `${s}ç§’`;
}
function formatWait(ms){
  if(ms<=0) return 'å‡ºç°å¯ç”¨ç´æˆ¿ï¼(ç‚¹å‡»æŸ¥çœ‹)';
  return formatDurationHuman(Math.ceil(ms/1000));
}
function escapeCSV(v){
  if(v==null) return '';
  const s=String(v);
  return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;
}

/* æ‹¼éŸ³æ˜ å°„ï¼ˆä¿ç•™ï¼‰ */
const pinyinMap={'é³':'jin','è“':'lan','ç†™':'xi','é‚“':'deng','æ¶µ':'han','å‘¨':'zhou','é™':'jing','è¿œ':'yuan','å†¯':'feng','ç‘':'rui','å¤•':'xi','å•':'lv','é‡‘':'jin','æ˜‚':'ang','å¾':'xu','æ¶¬':'shuang','å®¸':'chen','çª¦':'dou','ç’Ÿ':'jing','å':'hua','æ—':'lin','æ™':'yan','ç†¹':'xi','æ®µ':'duan','é‰´':'jian','å¶':'ye','è”š':'wei','åˆ˜':'liu','æ³½':'ze','æ–‡':'wen','æ½˜':'pan','ç‘¾':'jin','ç† ':'yi','æ':'li','åš':'bo','æ©':'en','ç‹':'wang','å¥•':'yi','ç„¶':'ran','éŸ©':'han','æ˜€':'yun','æ¡¦':'hua','å­”':'kong','ç’‡':'xuan','è‡§':'zang','æ˜±':'yu','æ£‹':'qi','è”º':'lin','è½©':'xuan','å®‹':'song','æ¢“':'zi','æš„':'xuan','ç”°':'tian','å­':'zi','è±':'xuan','å¼ ':'zhang','ä¾':'yi','é™ˆ':'chen','æ€':'si','å½¤':'tong','æ¨':'yang','é›¨':'yu','æ¡':'tong','èµµ':'zhao','æ¬£':'xin','æ€¡':'yi','é©¬':'ma','æ™¨':'chen','æ›¦':'xi','é«˜':'gao','æ¢¦':'meng','çª':'qi','éƒ‘':'zheng','è¯—':'shi','å´':'wu','ä½³':'jia','ä½•':'he','æœ±':'zhu','å¿ƒ':'xin','è¯­':'yu','èƒ¡':'hu','è‹¥':'ruo','æ±':'xi','è®¸':'xu','ç‘¶':'yao','ç½—':'luo','é›…':'ya','é’Ÿ':'zhong','å«£':'yan','è°¢':'xie','è‹':'su','ç³':'lin','æ±Ÿ':'jiang','å­™':'sun','è¢':'yuan','æ±ª':'wang','æ›¹':'cao','å§š':'yao','æ²ˆ':'shen','å¢':'lu','éŸ¦':'wei','è‘£':'dong','å‚…':'fu','ç¨‹':'cheng','ä¸':'ding','çŸ³':'shi','ä»»':'ren','é‚¹':'zou','é¾™':'long','å²':'shi','æ–¹':'fang','å¤':'xia','ä¾¯':'hou','é‚±':'qiu','å°¹':'yin','é»':'li','æ±¤':'tang','æ˜“':'yi','å¸¸':'chang','æ­¦':'wu','ä¹”':'qiao','è´º':'he','èµ–':'lai','é¾š':'gong','åº':'pang','æ¨Š':'fan','å…°':'lan','æ®·':'yin','æ–½':'shi','é™¶':'tao','ç¿':'weng','å®‰':'an','å€ª':'ni','ä¸¥':'yan','ç‰›':'niu','æ¸©':'wen','èŠ¦':'lu','å­£':'ji','ä¿':'yu','ç« ':'zhang','é²':'lu','è‘›':'ge','ä¼':'wu','ç”³':'shen','å°¤':'you','æ¯•':'bi','è‚':'nie','ä¸›':'cong','ç„¦':'jiao','å‘':'xiang','æŸ¯':'ke','å²³':'yue','æ¹˜':'xiang','æ‚¦':'yue','ç®':'wei','ç®¡':'guan','å“²':'zhe','å©·':'ting','é‡Š':'shi','è¨€':'yan','ç¥':'zhu','å®':'bao','å½­':'peng','ç¾':'mei','æ·‡':'qi','åº·':'kang','ç¾¤':'qun','è€¿':'geng','å¹„':'wo','åƒ':'qian','ç‘œ':'yu','åˆ':'you','é›¯':'wen','ä¿Š':'jun','æ°':'jie','åŠ²':'jin','è±ª':'hao','ç¬™':'sheng','æƒ':'quan','è–›':'xue','å®œ':'yi','é™†':'lu','æ›œ':'yao','å¶™':'lin','é¦¨':'xin','è£•':'yu','æ˜•':'xin','æ²':'mu','å”':'tang','å›':'jun','ç››':'sheng','ç¡•':'shuo','æ™—':'han','å¦‚':'ru','ç‰§':'mu','é£':'feng','æ™':'xi','ä¼Š':'yi','æ¸…':'qing','å¦ƒ':'fei','æœˆ':'yue','ç¥º':'qi','è’²':'pu','æŸ':'bai','ç¾½':'yu','å† ':'guan','æˆ':'cheng','é¢œ':'yan','äº¦':'yi','æ²…':'yuan','æ‰¿':'cheng','ç§¦':'qin','é“‚':'bo','ç­µ':'yan','æ…§':'hui','ä½œ':'zuo','ç¿°':'han','ä¸Š':'shang','ä¹‹':'zhi','è·¯':'lu','ç“’':'zan','è‘—':'zhu','ç¿':'rui','ç±½':'zi','ä¸':'cheng','å¦':'yan','æ ©':'xu','ä¹':'le','é€¸':'yi','è¯š':'cheng','é’°':'yu','æ´':'jie','åª›':'yuan','é‹†':'yun','è°¨':'jin','ç•…':'chang','èŒ¹':'ru','æ²‚':'yi','å©‰':'wan','è·':'he','æ´‹':'yang','æ˜':'ming','å¤š':'duo','éƒ—':'xi','ä¼ ':'chuan','å¹³':'ping','ä¸–':'shi','å…ƒ':'yuan','æ±‡':'hui','æ²™':'sha','çš“':'hao','å®¶':'jia','æ¥ ':'nan','å®˜':'guan','æŸ˜':'zhe','å¸Œ':'xi','æº¥':'pu','å°š':'shang','å‡Œ':'ling','ç¿¾':'xuan','å§œ':'jiang','ç…Š':'xuan','ç¬':'wan','è¿ª':'di','æ˜':'xuan','æ²':'qin','ç¥':'yi','çˆ':'jia','æ”¿':'zheng','é˜³':'yang','ä»¥':'yi','éª':'qian','ä¹™':'yi','é“®':'zheng','å•†':'shang','å¤©':'tian','èµ':'ci','æ™Ÿ':'sheng','å³°':'feng','é‚µ':'shao','é¢¢':'hao','æµ©':'hao','ä½™':'yu','æµ¡':'bo','ç€š':'han','å³»':'jun','äº':'yu','é’²':'zheng','åŸ¼':'qi','è‹':'su','å½¦':'yan','ç‚³':'bing','å²':'qi','ç’ ':'fan','ç™½':'bai','å’':'yong','ç':'ding','åº„':'zhuang','ç¬›':'di','è–ª':'xin','ç±³':'mi','çª':'qi','å­˜':'cun','å’Œ':'he','ç¬‘':'xiao','æ¬§':'ou','ç¿°':'han','å–†':'zhe','åº­':'ting','å½°':'zhang','é‚°':'tai','è”¡':'cai','å±¹':'yi','æ½†':'ying','æ½':'lu','ä¿®':'xiu','å†‰':'ran','å…‰':'guang','ç¿¼':'yi','çº':'jun','é—»':'wen','æ²»':'zhi','ç¥':'yue','å©§':'jing','å©':'qi','æ¤':'zhi','å¯…':'yin','äº•':'jing','æºª':'xi','ç´«':'zi','èˆª':'hang','æ˜¾':'xian','ç¿”':'xiang','æ™¯':'jing','å›­':'yuan','ç¾¿':'yi','è¾¾':'da','æ­£':'zheng','æ½¼':'tong','å˜‰':'jia','å´š':'ling','æ±‰':'han','å†¼':'xian','æ˜Š':'hao','æ•¬':'jing','å°”':'er','å“':'zhuo','å¸…':'shuai','å¿—':'zhi','å¯':'ke','é’§':'jun','é‰´':'jian','ç¬™':'sheng','æƒ':'quan','æ˜¾':'xian','ç¿”':'xiang','æ™':'yan','ç†¹':'xi','é‡Š':'shi','è¨€':'yan','æ£®':'sen','è´¤':'xian','æŸ³':'liu','æ©':'en','å¥•':'yi','æ½¼':'tong','å˜‰':'jia','æ€¡':'yi','é‡‘':'jin','æ˜‚':'ang','ç‘¾':'jin','ç† ':'yi','ç¾':'mei','æ·‡':'qi','åƒ':'qian','ç‘œ':'yu','å­':'zi','è½©':'xuan','å¿—':'zhi','æ˜Š':'hao','è±':'xuan','ç”³':'shen','å´š':'ling','æ¢“':'zi','åº·':'kang','å²³':'yue','æ±‰':'han','æ˜Š':'hao','ç†¹':'xi','åˆ':'you','å®‰':'an','æ¶¬':'shuang','å®¸':'chen','å®œ':'yi','è‰º':'yi','å“':'zhuo','ç„¶':'ran','è”š':'wei','è“':'lan','æ•¬':'jing','è½©':'xuan','æ˜±':'yu','æ£‹':'qi','å°”':'er','æ¶µ':'han','é›¯':'wen','å©·':'ting','å“':'zhuo','ç¾¤':'qun','å­':'zi','å¸…':'shuai','å­':'zi','ä¾':'yi','åš':'bo','ç®':'wei','æ¬£':'xin','æ€¡':'yi','é™':'jing','è¿œ':'yuan','å®':'bao','æ€¡':'yi','å¸¸':'chang','æ¬£':'xin','æ´‹':'yang','å©‰':'wan','èŒ¹':'ru','æ˜':'ming','å¤š':'duo','æ°':'jie','æ¬£':'xin','è·':'he','åƒ':'qian','çš“':'hao','æ±‡':'hui','æ³½':'ze','ä¼ ':'chuan','å¹³':'ping','ä¸–':'shi','å…ƒ':'yuan','å† ':'guan','æº':'yuan','ç±³':'mi','çª':'qi','å•':'dan','è‹¥':'ruo','æºª':'xi','æ©':'en','å’Œ':'he','é‡‘':'jin','é»„':'huang','å¯':'ke','æ¬£':'xin','å­”':'kong','æ¢“':'zi','è¯­':'yu','å­˜':'cun','æµ©':'hao','å˜‰':'jia','è·':'he','é›¨':'yu','ç¬›':'di','å­':'zi','è½©':'xuan','è–ª':'xin','ç‘œ':'yu','æ¢“':'zi','å®¸':'chen','æ‰¿':'cheng','ç†¹':'xi','å­':'zi','å¢¨':'mo','å¡˜':'tang','æ¬£':'xin','å¦':'yan','ç¬‘':'xiao','æ¬§':'ou','ç¥':'yi','ç¥':'yue','å©§':'jing','å©':'qi','æ¤':'zhi','å…ƒ':'yuan','æµ©':'hao','å…ƒ':'yuan','æ¢“':'zi','å¯…':'yin','ä¾':'yi','è¯º':'nuo','é’§':'jun','å±¹':'yi','åš':'bo','é—»':'wen','åº­':'ting','å½°':'zhang','æ½†':'ying','æ½':'lu','ç† ':'yi','å®¸':'chen','å¤©':'tian','ç¿¼':'yi','æ²»':'zhi','é’§':'jun','æ—':'lin','ç† ':'yi','æ¢“':'zi','å³°':'feng','ä¿®':'xiu','å†‰':'ran','çº':'jun','ç¿°':'han','å–†':'zhe','ç±³':'mi','é˜³':'yang','å…‰':'guang','æ ©':'xu','ä¹':'le','å®‰':'an','æ…§':'hui','å† ':'guan','å':'hua','è‹¥':'ruo','æ˜•':'xin','é›¨':'yu','ç†™':'xi','é‡‘':'jin','æ²‚':'yi','ä»¥':'yi','è¯º':'nuo','é’°':'yu','æ²':'mu','æ›¦':'xi','ç‰§':'mu','é£':'feng','æ¬£':'xin','å¦':'yan','æ²…':'yuan','æ‰¿':'cheng','ç±½':'zi','ä¸':'cheng','è°¨':'jin','ç•…':'chang','ä½œ':'zuo','ç¿°':'han','æ–‡':'wen','ç››':'sheng','è·¯':'lu','é›¨':'yu','ç“’':'zan','äº¦':'yi','å®¸':'chen','é€¸':'yi','è¯š':'cheng','å­':'zi','æ¸…':'qing','æŸ':'bai','ç¾½':'yu','é“‚':'bo','ç­µ':'yan','æ›œ':'yao','å¶™':'lin','è½©':'xuan','å­':'zi','èŒ¹':'ru','å˜‰':'jia','å›':'jun','æ´':'jie','åª›':'yuan','æœˆ':'yue','ç¥º':'qi','æ·‡':'qi','æ™—':'han','å¦‚':'ru','ä¸Š':'shang','æ©':'en','é›…':'ya','æ™':'xi','ä¸€':'yi','å¦ƒ':'fei','æ€¡':'yi','æ–‡':'wen','é­':'wei','ä¼Š':'yi','è±':'xuan','æ˜“':'yi','æˆ':'cheng','æ™Ÿ':'sheng','å˜‰':'jia','å®¶':'jia','ç¡•':'shuo','ä½³':'jia','é¦¨':'xin','è¯­':'yu','è‘—':'zhu','ç¿':'rui','è¯—':'shi','æ‚¦':'yue','ä¾':'yi','å®¸':'chen','å­':'zi','é‹†':'yun','æ¶µ':'han','ä¹‹':'zhi','è£•':'yu','è¾¾':'da'
};
function matchPinyin(name, searchTerm) {
  if (!searchTerm) return true;
  const searchLower = searchTerm.toLowerCase().trim();
  const nameLower = name.toLowerCase();
  
  // ç›´æ¥åŒ¹é…ä¸­æ–‡
  if (nameLower.includes(searchLower)) return true;
  
  // ğŸ”¥ æ–°å¢ï¼šå¤„ç†ç©ºæ ¼åˆ†éš”çš„å¤šå…³é”®è¯æœç´¢
  const keywords = searchLower.split(/\s+/).filter(k => k.length > 0);
  if (keywords.length > 1) {
    return matchMultipleKeywords(name, keywords);
  }
  
  // å•å…³é”®è¯çš„åŸæœ‰é€»è¾‘
  const nameChars = name.split('');
  const firstLetters = nameChars.map(char => {
    const py = pinyinMap[char];
    return py ? py.charAt(0) : char.toLowerCase();
  });
  
  // å¦‚æœæœç´¢è¯åªæœ‰ä¸€ä¸ªå­—æ¯ï¼ŒåªåŒ¹é…ç¬¬ä¸€ä¸ªå­—çš„é¦–å­—æ¯
  if (searchLower.length === 1) {
    return firstLetters[0] === searchLower;
  }
  
  // å¤šå­—æ¯æœç´¢æ—¶çš„è¿ç»­é¦–å­—æ¯åŒ¹é…
  const firstLettersStr = firstLetters.join('');
  
  // 1. å®Œæ•´çš„é¦–å­—æ¯åŒ¹é…ï¼ˆå¦‚ "å½­ç¾å²" -> "pmq"ï¼‰
  if (firstLettersStr === searchLower) return true;
  
  // 2. ä»å¼€å¤´å¼€å§‹çš„éƒ¨åˆ†åŒ¹é…ï¼ˆå¦‚ "å½­ç¾å²" -> "pm"ï¼‰
  if (firstLettersStr.startsWith(searchLower)) return true;
  
  // 3. è¿ç»­å­ä¸²åŒ¹é…ï¼ˆå¦‚ "å½­ç¾å²" -> "mq" åŒ¹é… "ç¾å²"ï¼‰
  if (searchLower.length >= 2 && firstLettersStr.includes(searchLower)) return true;
  
  // 4. å…¨æ‹¼éŸ³åŒ¹é…ï¼ˆå¦‚æœæœ‰ toPinyin å‡½æ•°ï¼‰
  if (typeof toPinyin === 'function') {
    const pinyin = toPinyin(name).toLowerCase();
    if (pinyin.includes(searchLower)) return true;
  }
  
  return false;
}

// ğŸ”¥ æ›´æ–°ï¼šå¤šå…³é”®è¯åŒ¹é…å‡½æ•°ï¼ˆå®Œæ•´ç‰ˆï¼‰
function matchMultipleKeywords(name, keywords) {
  const nameLower = name.toLowerCase();
  const nameChars = name.split('');
  const firstLetters = nameChars.map(char => {
    const py = pinyinMap[char];
    return py ? py.charAt(0) : char.toLowerCase();
  });
  const firstLettersStr = firstLetters.join('');
  
  // æ–¹æ¡ˆ1ï¼šæ¯ä¸ªå…³é”®è¯éƒ½å¿…é¡»å•ç‹¬åŒ¹é…ï¼ˆAND é€»è¾‘ï¼‰
  const allMatch = keywords.every(keyword => {
    // 1. ç›´æ¥ä¸­æ–‡åŒ¹é…
    if (nameLower.includes(keyword)) return true;
    
    // 2. å•å­—æ¯é¦–å­—æ¯åŒ¹é…
    if (keyword.length === 1) {
      return firstLetters.includes(keyword);
    }
    
    // 3. å¤šå­—æ¯è¿ç»­åŒ¹é…
    if (keyword.length >= 2) {
      return firstLettersStr.includes(keyword);
    }
    
    return false;
  });
  
  if (allMatch) return true;
  
  // æ–¹æ¡ˆ2ï¼šæ™ºèƒ½é¦–å­—æ¯ç»„åˆåŒ¹é…
  // ä¾‹å¦‚ï¼š["p", "m"] åŒ¹é… "å½­ç¾å²" çš„è¿ç»­é¦–å­—æ¯ "pm"
  const isAllSingleLetters = keywords.every(k => k.length === 1);
  if (isAllSingleLetters) {
    return matchSmartKeywords(name, keywords);
  }
  
  // æ–¹æ¡ˆ3ï¼šç»„åˆå…³é”®è¯åŒ¹é…
  // ä¾‹å¦‚ï¼š["p", "mei"] åŒ¹é… "å½­ç¾å²" çš„ "p" + "ç¾"
  return matchCombinedKeywords(name, keywords, firstLetters, nameLower);
}

// ğŸ”¥ æ–°å¢ï¼šç»„åˆå…³é”®è¯åŒ¹é…
function matchCombinedKeywords(name, keywords, firstLetters, nameLower) {
  // å°è¯•ä¸åŒçš„åŒ¹é…ç»„åˆ
  for (let i = 0; i < keywords.length; i++) {
    const keyword = keywords[i];
    let matched = false;
    
    // æ£€æŸ¥å½“å‰å…³é”®è¯æ˜¯å¦èƒ½åŒ¹é…
    if (keyword.length === 1) {
      // å•å­—æ¯ï¼šæ£€æŸ¥é¦–å­—æ¯
      matched = firstLetters.includes(keyword);
    } else {
      // å¤šå­—æ¯ï¼šæ£€æŸ¥ä¸­æ–‡æˆ–æ‹¼éŸ³
      matched = nameLower.includes(keyword) || 
                firstLetters.join('').includes(keyword);
    }
    
    if (!matched) return false;
  }
  
  return true;
}


// ğŸ”¥ æ–°å¢ï¼šæ™ºèƒ½å…³é”®è¯åŒ¹é…ï¼ˆæ”¯æŒé¦–å­—æ¯ç»„åˆï¼‰
function matchSmartKeywords(name, keywords) {
  const nameChars = name.split('');
  const firstLetters = nameChars.map(char => {
    const py = pinyinMap[char];
    return py ? py.charAt(0) : char.toLowerCase();
  });
  
  // å°è¯•å°†å…³é”®è¯ç»„åˆåŒ¹é…åˆ°è¿ç»­çš„é¦–å­—æ¯
  // ä¾‹å¦‚ï¼š["p", "m"] åŒ¹é… "å½­ç¾å²" çš„ "p" å’Œ "m"
  if (keywords.length <= nameChars.length) {
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¿ç»­çš„é¦–å­—æ¯åŒ¹é…
    for (let i = 0; i <= firstLetters.length - keywords.length; i++) {
      let match = true;
      for (let j = 0; j < keywords.length; j++) {
        if (firstLetters[i + j] !== keywords[j]) {
          match = false;
          break;
        }
      }
      if (match) return true;
    }
    
    // ğŸ”¥ å…³é”®æ”¹è¿›ï¼šæ”¯æŒéè¿ç»­ä½†æŒ‰é¡ºåºçš„é¦–å­—æ¯åŒ¹é…
    // ä¾‹å¦‚ï¼š["p", "q"] å¯ä»¥åŒ¹é… "å½­ç¾å²" çš„ "p"(å½­) å’Œ "q"(å²)
    let keywordIndex = 0;
    for (let i = 0; i < firstLetters.length && keywordIndex < keywords.length; i++) {
      if (firstLetters[i] === keywords[keywordIndex]) {
        keywordIndex++;
      }
    }
    if (keywordIndex === keywords.length) return true;
  }
  
  return false;
}




/* =============== 2. æ•°æ®æ¨¡å‹ä¸å˜é‡ =============== */
let rooms=[];
let roomDatabase={};
let studentDatabase={};
let studentTimeSlots={};
let practiceLogs=[];
let queueList={grand:[],upright:[],none:[]};
let operationLogs=[];
let systemSettings={...DEFAULT_SETTINGS};
let lastResetDate=null;
let currentRoom=null;
let isLocked=true;
let roomViewMode='overview';
let currentFloor=null;
let needsFullUpdate=true;
let timelineVisible=false;
let attendanceData={};


let lastAttendanceCheck=null;
let timelineCats = ['grand','upright','other'];
let currentTimelineCatIndex = 0;
/* === ç»ƒç´å¼‚å¸¸æé†’æ–°å¢å…¨å±€å˜é‡ BEGIN === */
let practiceOverrunReminders = [];
let overrunIgnoredKeys = new Set();
let lastOverrunCheck = 0;  // èŠ‚æµæ£€æµ‹
/* === ç»ƒç´å¼‚å¸¸æé†’æ–°å¢å…¨å±€å˜é‡ END === */
/* === è¶…æ—¶æ®µç»Ÿè®¡ === */
let overrunStats = {};  // { dateKey: { studentName:{count:number} } }
/* === ç»ƒä¹ æ—¶é•¿è®°å½•ç³»ç»Ÿ === */
let dailyPracticeRecords = {}; // { dateKey: { studentName: { inSlot: seconds, outSlot: seconds, totalSlots: [], details: [] } } }
let practiceSessionTracker = new Map(); // å½“å‰ç»ƒç´ä¼šè¯è·Ÿè¸ªå™¨
let lastPracticeSync = 0; // ä¸Šæ¬¡åŒæ­¥æ—¶é—´

let studentSlotHistory = new Set();
// åœ¨å…¨å±€å˜é‡åŒºåŸŸæ·»åŠ 
let operationLocks = new Set(); // æ“ä½œé”é›†åˆ
let operationLockTimestamps = new Map(); // æ“ä½œé”æ—¶é—´æˆ³ï¼Œç”¨äºè¶…æ—¶æ¸…ç†
let pendingOperations = new Map(); // å¾…å¤„ç†æ“ä½œé˜Ÿåˆ—

// æ“ä½œé”è¶…æ—¶æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰
// é”è¶…æ—¶ï¼šç”±åŸ 5 åˆ†é’Ÿé™ä¸º 90 ç§’ï¼Œå‡å°‘é—ç•™é”å½±å“ (D)
const OPERATION_LOCK_TIMEOUT = 90 * 1000;

// ========== å¼‚å¸¸æé†’åŒæ­¥ç‰ˆæœ¬æ§åˆ¶ ==========
let lastOverrunVersion = 0; 
// ğŸ”¥ æ–°å¢ï¼šæ™ºèƒ½åŒæ­¥ç›¸å…³å˜é‡
let lastDataFingerprint = null;
let syncDebounceTimeout = null;
const SYNC_DEBOUNCE_MS = 500;
           // æœ¬åœ°å·²åº”ç”¨çš„ç‰ˆæœ¬å·
let lastOverrunSyncTime = 0;           // èŠ‚æµå†™å…¥

const OVERRUN_SYNC_DEBOUNCE = 800;     // æ¯«ç§’ï¼Œé¿å…çŸ­æ—¶é—´é‡å¤å†™
// ğŸ”¥ æ–°å¢ï¼šè¯·å‡çŠ¶æ€æ£€æŸ¥é—´éš”ï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¿‡æœŸçŠ¶æ€ï¼‰
let excuseCheckInterval = null;

// ğŸ”¥ æ–°å¢ï¼šè¯·å‡æ“ä½œå†å²è®°å½•
let excuseOperationHistory = [];
let anomalyCheckInterval = null; // å¼‚å¸¸æ£€æŸ¥å®šæ—¶å™¨
let isAnomalyCheckActive = false; // å¼‚å¸¸æ£€æŸ¥æ˜¯å¦æ¿€æ´»
// ğŸ”¥ æ–°å¢ï¼šæ•°æ®ä¿æŠ¤ç›¸å…³å˜é‡
let deviceSleepTime = null;
let dataProtectionMode = true; // å¯ç”¨æ•°æ®ä¿æŠ¤æ¨¡å¼
let lastWakeupTime = 0;

// ğŸ”¥ æ–°å¢ï¼šè‡ªåŠ¨é”å®šåŠŸèƒ½å˜é‡
let autoLockTimer = null;
let autoLockWarningTimer = null;
let lastActivityTime = Date.now();
let autoLockWarningShown = false;
// ==== æ–°å¢ï¼šåŒæ­¥é˜²æŠ¤æ§åˆ¶å˜é‡ BEGIN ====
let initialSyncInProgress = true;        // é¦–æ¬¡äº‘ç«¯æ•°æ®æ‹‰å–æœŸé—´ä¸å…è®¸ push
let initialSyncCompleted = false;        // å®Œæˆç¬¬ä¸€è½®å®‰å…¨ pull
let lastRemoteSnapshotOccupancy = 0;     // ç¼“å­˜äº‘ç«¯ä¸Šä¸€æ¬¡å ç”¨æ•°é‡
let lastLocalSnapshotOccupancy = 0;      // æœ¬åœ°æœ€è¿‘ä¸€æ¬¡å·²æˆåŠŸä¸ŠæŠ¥çš„å ç”¨æ•°é‡
let lastUserDestructiveActionTs = 0;     // è®°å½•æœ€è¿‘ä¸€æ¬¡â€œç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºâ€æ“ä½œæ—¶é—´
const DESTRUCTIVE_ACTION_WINDOW = 10000; // 10 ç§’å†…å…è®¸ä¸€æ¬¡å¤§å¹…ä¸‹é™ï¼ˆä¾‹å¦‚æ‰‹åŠ¨é‡ç½®ï¼‰
// ==== æ–°å¢ï¼šåŒæ­¥é˜²æŠ¤æ§åˆ¶å˜é‡ END ====

const AUTO_LOCK_WARNING_TIME = 30 * 1000; // æå‰30ç§’è­¦å‘Š

// ğŸ”¥ æ–°å¢ï¼šè·å–è‡ªåŠ¨é”å®šè¶…æ—¶æ—¶é—´çš„å‡½æ•°
function getAutoLockTimeout() {
  return systemSettings.autoLockTimeMinutes * 60 * 1000;
}
/* =============== 3. å­˜å–å°è£… =============== */
function lsGet(k,def){try{return JSON.parse(localStorage.getItem(k))??def;}catch{return def;}}
function lsSet(k,v){localStorage.setItem(k,JSON.stringify(v));}
function updateAutoLockPreview(){
  const enabled = $('autoLockEnabledInput').checked;
  const minutes = parseInt($('autoLockTimeInput').value) || 10;
  
  if (!enabled) {
    $('autoLockPreview').textContent = 'å½“å‰è®¾ç½®ï¼šå·²ç¦ç”¨';
    $('autoLockPreview').style.color = '#95a5a6';
  } else {
    $('autoLockPreview').textContent = `å½“å‰è®¾ç½®ï¼š${minutes}åˆ†é’Ÿ`;
    $('autoLockPreview').style.color = '#e67e22';
  }
}

function loadAll(){
  roomDatabase=lsGet(KEYS.ROOM_DB,{});
  rooms=lsGet(KEYS.ROOMS,[]);
  if(!rooms.length) rebuildRoomsFromDb();
  studentDatabase=lsGet(KEYS.STUD_DB,{});
  
  // ğŸ”¥ æ–°å¢ï¼šå‡çº§å­¦ç”Ÿæ•°æ®åº“ç»“æ„ä»¥æ”¯æŒå¹´çº§
  upgradeStudentDatabaseStructure();
  
  studentTimeSlots=lsGet(KEYS.STUD_SLOTS,{});
  practiceLogs=lsGet(KEYS.PRACTICE_LOG,[]);
  queueList=lsGet(KEYS.QUEUE,{grand:[],upright:[],none:[]});
  operationLogs=lsGet(KEYS.OPS,[]);
  systemSettings={...DEFAULT_SETTINGS,...lsGet(KEYS.SETTINGS,{})};
  // ğŸ”¥ æ–°å¢ï¼šåŠ è½½è¯·å‡æ“ä½œå†å²
  excuseOperationHistory=lsGet('excuseOperationHistory',[]);
  // ç¡®ä¿æ–°å­—æ®µå­˜åœ¨é»˜è®¤å€¼
  if(systemSettings.stopAnomalyCheckMinute === undefined) {
    systemSettings.stopAnomalyCheckMinute = 0;
  }
  // ğŸ”¥ æ–°å¢ï¼šç¡®ä¿å¼€å§‹æ—¶é—´å­—æ®µå­˜åœ¨é»˜è®¤å€¼
  if(systemSettings.startAnomalyCheckHour === undefined) {
    systemSettings.startAnomalyCheckHour = 8;
  }
  if(systemSettings.startAnomalyCheckMinute === undefined) {
    systemSettings.startAnomalyCheckMinute = 0;
  }
  lastResetDate=lsGet(KEYS.AUTO_RESET,{lastResetDate:null}).lastResetDate;
  // æ—§æ ¼å¼è¿ç§»ï¼ˆè‹±è¯­ toDateString -> yyyy-mm-ddï¼‰
  if(lastResetDate){
    const migrated = toDateKey(lastResetDate);
    if(migrated && migrated !== lastResetDate){
      lastResetDate = migrated;
      persistReset();
    }
  }

  timelineVisible=localStorage.getItem(KEYS.TIMELINE_VISIBLE)==='true';
  /* === åŠ è½½ç»ƒç´å¼‚å¸¸æé†’æ•°æ® BEGIN === */
  practiceOverrunReminders = lsGet(KEYS.OVERRUN_REMINDERS,[]);
  const ignoredArr = lsGet(KEYS.OVERRUN_IGNORED,[]);
  overrunIgnoredKeys = new Set(ignoredArr);
  /* === åŠ è½½ç»ƒç´å¼‚å¸¸æé†’æ•°æ® END === */
  /* === åŠ è½½è¶…æ—¶æ®µç»Ÿè®¡ === */
  overrunStats = lsGet(KEYS.OVERRUN_STATS, {});
  /* === åŠ è½½ç»ƒä¹ æ—¶é•¿è®°å½• === */
  dailyPracticeRecords = lsGet('dailyPracticeRecords', {});
  // æ¸…ç†è¿‡æœŸæ•°æ®ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
  cleanupOldPracticeRecords();

  // ğŸ”¥ æ–°å¢ï¼šåŠ è½½å®æ—¶ç»ƒç´çŠ¶æ€
  realTimePracticeStatus = lsGet('realTimePracticeStatus', {});
}


function persistRooms(){lsSet(KEYS.ROOMS,rooms);}
function persistRoomDb(){lsSet(KEYS.ROOM_DB,roomDatabase);}
function persistStudents(){lsSet(KEYS.STUD_DB,studentDatabase);}
function persistStudentSlots(){lsSet(KEYS.STUD_SLOTS,studentTimeSlots);}
function persistLogs(){lsSet(KEYS.PRACTICE_LOG,practiceLogs);}
function persistQueues(){lsSet(KEYS.QUEUE,queueList);}
function persistOps(){lsSet(KEYS.OPS,operationLogs);}
function persistSettings(){lsSet(KEYS.SETTINGS,systemSettings);}
function persistReset(){lsSet(KEYS.AUTO_RESET,{lastResetDate});}
function persistOverrunsLocal() {
  lsSet(KEYS.OVERRUN_REMINDERS, practiceOverrunReminders);
  lsSet(KEYS.OVERRUN_IGNORED, [...overrunIgnoredKeys]);
  lsSet(KEYS.OVERRUN_STATS, overrunStats);
}
/**
 * å®Œæ•´æŒä¹…åŒ–ï¼ˆæœ¬åœ° + å¯é€‰äº‘ç«¯åŒæ­¥ï¼‰
 * @param {boolean} triggerSync - æ˜¯å¦è§¦å‘äº‘ç«¯åŒæ­¥
 * @param {string} action - åŒæ­¥åŠ¨ä½œç±»å‹
 * @param {object} meta - å…ƒæ•°æ®
 */

function logOperation(type,detail){operationLogs.push({time:new Date().toISOString(),type,detail});persistOps();}
// ========== äº‘ç«¯åŒæ­¥å‡½æ•° ==========
function syncOverrunData(action = 'update', meta = {}) {
  if (!isOnline || !syncEnabled || !database) {
    console.log('â¸ï¸ è·³è¿‡äº‘ç«¯åŒæ­¥ï¼š', { isOnline, syncEnabled, hasDatabase: !!database });
    return;
  }
  
  const now = Date.now();
  
  // é¢‘ç‡æ§åˆ¶ï¼šæ™®é€šæ›´æ–°é™åˆ¶ï¼Œé‡è¦æ“ä½œä¸é™åˆ¶
  if (now - lastOverrunSyncTime < OVERRUN_SYNC_DEBOUNCE && action === 'update') {
    console.log('â¸ï¸ è·³è¿‡äº‘ç«¯åŒæ­¥ï¼šé¢‘ç‡é™åˆ¶');
    return;
  }
  
  lastOverrunVersion = now;
  lastOverrunSyncTime = now;

  const payload = {
    version: lastOverrunVersion,
    reminders: practiceOverrunReminders,
    ignored: [...overrunIgnoredKeys], // ğŸ”¥ ç¡®ä¿ Set è½¬æ•°ç»„
    stats: overrunStats,
    updatedAt: now,
    action,
    meta
  };

  console.log('ğŸ”„ åŒæ­¥å¼‚å¸¸æé†’æ•°æ®åˆ°äº‘ç«¯:', action, {
    reminders: payload.reminders.length,
    ignored: payload.ignored.length,
    statsKeys: Object.keys(payload.stats).length
  });

  database
    .ref(FIREBASE_PATHS.OVERRUN_DATA)
    .set(payload)
    .then(() => {
      console.log('âœ… å¼‚å¸¸æé†’æ•°æ®åŒæ­¥æˆåŠŸ:', action);
    })
    .catch(err => {
      console.error('âŒ å¼‚å¸¸æé†’æ•°æ®åŒæ­¥å¤±è´¥:', err);
    });
}

// ========== ç»Ÿä¸€å¯¹å¤–è°ƒç”¨çš„ persistOverrunsï¼ˆå…¼å®¹æ—§è°ƒç”¨ç‚¹ï¼‰ ==========
function persistOverruns(triggerSync = true, action = 'update', meta = {}) {
  // 1. å…ˆæ‰§è¡Œæœ¬åœ°æŒä¹…åŒ–
  persistOverrunsLocal();
  
  // 2. å¯é€‰çš„äº‘ç«¯åŒæ­¥
  if (triggerSync && isOnline && syncEnabled) {
    syncOverrunData(action, meta);
  }
}
/* =============== 4. UI åŸºç¡€ï¼šToast / æ¨¡æ€ / æ—¶é—´æ˜¾ç¤º =============== */
function showToast(msg, ms=3000){
  const t = document.getElementById('toast');
  if (t._lastMsg === msg && Date.now() - (t._lastTime||0) < 800) {
    // 800ms å†…åŒæ ·å†…å®¹ä¸å†é‡å¤åˆ·æ–°ï¼Œé˜²æ­¢çŸ­æ—¶é—´ spam
    return;
  }
  t._lastMsg = msg;
  t._lastTime = Date.now();
  t.textContent = msg;
  t.style.display='block';
  clearTimeout(t._to);
  t._to = setTimeout(()=>{ t.style.display='none'; }, ms);
}
function $(id){return document.getElementById(id);}
function updateClock(){ $('currentTime').textContent=new Date().toLocaleString(); }

/* =============== 5. æˆ¿é—´ä¸ç´æˆ¿åº“ =============== */
function rebuildRoomsFromDb(){
  rooms=Object.values(roomDatabase).map(r=>({
    name:r.name,
    type:r.pianoType==='ä¸‰è§’é’¢ç´'?'grand':'other',
    pianoKind:r.pianoType,
    location:r.location,
    remark:r.remark,
    student:null,
    registerTime:null,
  }));
  
  // ğŸ”¥ æ–°å¢ï¼šæŒ‰åç§°è‡ªç„¶æ’åº
  rooms.sort((a, b) => {
    return a.name.localeCompare(b.name, 'zh-Hans-CN', {
      numeric: true,
      sensitivity: 'base'
    });
  });
  
  persistRooms();
}

function isGrand(room){return room.pianoKind==='ä¸‰è§’é’¢ç´';}

function getFloorKey(room){
  const loc=room.location||'';
  if(loc.includes('è´Ÿä¸€')) return '-1';
  if(loc.includes('ä¸€æ¥¼')) return '1';
  if(loc.includes('äºŒæ¥¼')) return '2';
  if(loc.includes('ä¸‰æ¥¼')) return '3';
  if(loc.includes('å››æ¥¼')) return '4';
  return 'å…¶ä»–';
}
function floorStats(){
  const f={};
  // é¢„å®šä¹‰æ¥¼å±‚åˆå§‹åŒ–
  ['-1','1','2','3','4','temp'].forEach(key => {
    f[key] = {total:0,occ:0};
  });
  
  rooms.forEach(r=>{
    const k=getFloorKey(r);
    if(!f[k]) f[k]={total:0,occ:0}; // åŠ¨æ€åˆ›å»ºæ–°æ¥¼å±‚ç»Ÿè®¡
    f[k].total++; 
    if(r.student) f[k].occ++;
  });
  return f;
}
function renderRoomsLayout() {
    const container = $('rooms');
    if (roomViewMode === 'overview') {
        const fs = floorStats();
        let html = '<h2>ç´æˆ¿çŠ¶æ€</h2><div class="floor-buttons">';
        Object.entries(fs).forEach(([k, v]) => {
            if (!v.total) return;
            const name = 
                k === '-1' ? 'è´Ÿ1æ¥¼' : 
                k === 'temp' ? 'ä¸´æ—¶æ–°å¢' : 
                k === 'å…¶ä»–' ? 'å…¶ä»–ä½ç½®' :
                /^\d+$/.test(k) ? k + 'æ¥¼' : k; // çº¯æ•°å­—åŠ "æ¥¼"ï¼Œå¦åˆ™ç›´æ¥æ˜¾ç¤º
            const rate = (v.occ / v.total * 100).toFixed(0);
            html += `<button class="floor-btn" onclick="showFloorDetails('${k}')">
                <div>${name}</div>
                <div class="floor-info">${v.occ}/${v.total} ä½¿ç”¨ä¸­ (${rate}%)</div>
            </button>`;
        });
        html += '</div>';
        container.innerHTML = html;
    } else {
        // å½“å‰æ¥¼å±‚æ•°æ®
        const currentList = rooms.filter(r => getFloorKey(r) === currentFloor);
        const floorName =
            currentFloor === '-1' ? 'è´Ÿ1æ¥¼' :
            currentFloor === 'temp' ? 'ä¸´æ—¶æ–°å¢ç´æˆ¿' :
            currentFloor === 'å…¶ä»–' ? 'å…¶ä»–ä½ç½®' :
            /^\d+$/.test(currentFloor) ? currentFloor + 'æ¥¼' : currentFloor;

        // é‡æ–°è·å–æ‰€æœ‰æ¥¼å±‚ç»Ÿè®¡ç”¨äºç”Ÿæˆåˆ‡æ¢æ¡
        const fs = floorStats();
        // æŒ‰æ˜¾ç¤ºé¡ºåºæ’åºï¼ˆæ‰‹åŠ¨å®šä¹‰é¡ºåºï¼Œç„¶åæ·»åŠ å…¶ä»–æ¥¼å±‚ï¼‰
        const predefinedOrder = ['-1', '1', '2', '3', '4', 'temp'];
        const predefinedFloors = predefinedOrder.filter(f => fs[f] && fs[f].total > 0);
        // æ·»åŠ æœªé¢„å®šä¹‰ä½†æœ‰æˆ¿é—´çš„æ¥¼å±‚
        const otherFloors = Object.keys(fs).filter(f => fs[f] && fs[f].total > 0 && !predefinedOrder.includes(f)).sort();
        const orderedFloors = [...predefinedFloors, ...otherFloors];

        // ç”Ÿæˆå¿«é€Ÿåˆ‡æ¢æŒ‰é’®
        const switchBar = `
            <div class="floor-switch-bar">
                ${orderedFloors.map(f => {
                    const name =
                        f === '-1' ? 'è´Ÿ1æ¥¼' :
                        f === 'temp' ? 'ä¸´æ—¶æ–°å¢' :
                        f === 'å…¶ä»–' ? 'å…¶ä»–ä½ç½®' :
                        /^\d+$/.test(f) ? f + 'æ¥¼' : f; // çº¯æ•°å­—åŠ "æ¥¼"ï¼Œå¦åˆ™ç›´æ¥æ˜¾ç¤º
                    const stat = fs[f];
                    const occText = `${stat.occ}/${stat.total}`;
                    const active = f === currentFloor ? 'active' : '';
                    return `<button class="floor-switch-btn ${active}" ${f === currentFloor ? 'disabled' : ''} onclick="showFloorDetails('${f}')">${name}<span style="margin-left:4px;font-size:11px;opacity:.8;">${occText}</span></button>`;
                }).join('')}
            </div>
        `;

        // åˆ†ç»„
        const group = { grand: [], upright: [], other: [] };
        currentList.forEach(r => {
            if (r.pianoKind === 'ä¸‰è§’é’¢ç´') group.grand.push(r);
            else if (r.pianoKind === 'ç«‹å¼é’¢ç´') group.upright.push(r);
            else group.other.push(r);
        });

        const renderGroup = (title, list) => {
            if (!list.length) return '';
            return `<h4 style="margin:16px 0 6px;">${title}</h4>
                    <div class="room-container">${list.map(renderRoomCard).join('')}</div>`;
        };

        let html = `<h2>ç´æˆ¿çŠ¶æ€</h2>
            <div class="floor-header" style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <button class="floor-back-btn" style="background:var(--secondary-color);" onclick="showFloorOverview()">â† è¿”å›æ¦‚è§ˆ</button>
                <h3 style="margin:0;">${floorName}</h3>
            </div>
            ${switchBar}
            ${renderGroup('ä¸‰è§’é’¢ç´ç´æˆ¿', group.grand)}
            ${renderGroup('ç«‹å¼é’¢ç´ç´æˆ¿', group.upright)}
            ${renderGroup('å…¶ä»–ç´æˆ¿', group.other)}
        `;
        container.innerHTML = html;
    }
}


function updateRoomCardContents(){
  if(roomViewMode === 'overview') return;

  const roomCards = document.querySelectorAll('.room[data-room-name]');
  const now = Date.now();

  roomCards.forEach(cardEl => {
    const roomName = cardEl.dataset.roomName;
    const room = rooms.find(r => r.name === roomName);
    if(!room) return;

    const oldClasses = ['available','preparing','in-use','expired'];
    oldClasses.forEach(c=>cardEl.classList.remove(c));

    let newStatusClass = '';
    let statusChipHTML = '';
    let showBottomRow = false;

    if(room.student){
      const prepEnd = room.registerTime + 60000;
      showBottomRow = true;
      if(now < prepEnd){
        const remainSec = Math.ceil((prepEnd - now)/1000);
        newStatusClass = 'preparing';
        statusChipHTML = `<span class="room-status-chip preparing">å‡†å¤‡ä¸­ ${remainSec}s</span>`;
      }else{
        const used = Math.floor((now - prepEnd)/1000);
        const limit = systemSettings.basePracticeDuration * 60;
        if(used <= limit){
          newStatusClass = 'in-use';
          statusChipHTML = `<span class="room-status-chip in-use">${formatHMS(used)}</span>`;
        }else{
          newStatusClass = 'expired';
          const overtime = used - limit;
          statusChipHTML = `<span class="room-status-chip expired">è¶…æ—¶ ${formatDurationHuman(overtime)}</span>`;
        }
      }
    }else{
      newStatusClass = 'available';
      statusChipHTML = `<span class="room-status-chip available">ç©ºé—²</span>`;
      showBottomRow = false;
    }

    if(newStatusClass) cardEl.classList.add(newStatusClass);
    cardEl.dataset.hasStudent = room.student ? '1':'0';

    // å¤‡æ³¨è¡Œå¦‚æœä¸å­˜åœ¨ä¸”æœ‰å¤‡æ³¨ï¼Œè¡¥ä¸€æ¬¡ï¼ˆé¿å…å®Œå…¨é‡ç»˜ï¼‰
    if(room.remark && !cardEl.querySelector('.room-remark')){
      const nameEl = cardEl.querySelector('.room-name');
      if(nameEl){
        nameEl.insertAdjacentHTML('afterend',
          `<div class="room-remark" title="${room.remark.replace(/"/g,'&quot;')}">${room.remark}</div>`);
      }
    }

    const chipEl = cardEl.querySelector('.room-status-chip');
    if(chipEl){
      if(chipEl.outerHTML !== statusChipHTML){
        chipEl.outerHTML = statusChipHTML;
      }
    }else{
      // ä¸å­˜åœ¨åˆ™åœ¨åº•éƒ¨è¡Œé‡Œè¿½åŠ ï¼ˆæå°‘æ•°åŠ¨æ€æ’å…¥ï¼‰
      const bottom = cardEl.querySelector('.room-bottom-row');
      if(bottom){
        bottom.insertAdjacentHTML('afterbegin', statusChipHTML);
      }
    }

    const bottomRow = cardEl.querySelector('.room-bottom-row');
    if(bottomRow){
      bottomRow.style.display = showBottomRow ? 'flex' : 'none';
    }

    // æ¸…ç©ºæŒ‰é’®
    const actionsEl = cardEl.querySelector('.room-actions');
    if(room.student){
      if(actionsEl){
        // ç»­ç´æˆ¿æŒ‰é’®æ£€æŸ¥
        if(!actionsEl.querySelector('.room-renew-btn')){
          actionsEl.insertAdjacentHTML('beforeend',
            `<button class="room-renew-btn" onclick="event.stopPropagation();renewRoom('${roomName}')">
               <span>âŸ³</span><span>ç»­</span>
             </button>`);
        }
      }
    }else{
      if(actionsEl){
        const renewBtn = actionsEl.querySelector('.room-renew-btn');
        if(renewBtn) renewBtn.remove();
      }
    }
  });
}


function updateRoomStatuses(){
  if(roomViewMode==='overview'){
    // æ¦‚è§ˆæ¨¡å¼ä¸éœ€è¦æ›´æ–°å•ä¸ªå¡ç‰‡çŠ¶æ€
    return;
  }
  
  // è¯¦ç»†æ¨¡å¼ï¼šåªæ›´æ–°åŠ¨æ€å†…å®¹ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªå¸ƒå±€
  updateRoomCardContents();
}


function renderRoomCard(room){
  const now = Date.now();
  let statusClass = '', studentInfo = '', statusChip = '';

  const typeClass =
    room.pianoKind === 'ä¸‰è§’é’¢ç´' ? 'type-grand' :
    room.pianoKind === 'ç«‹å¼é’¢ç´' ? 'type-upright' : 'type-none';

  if(room.student){
    const prepEnd = room.registerTime + 60000;
    studentInfo = `
      <div class="room-student-info">
        <span class="room-student-dot"></span>
        <span>${room.student}</span>
      </div>`;
    if(now < prepEnd){
      const remainSec = Math.ceil((prepEnd - now)/1000);
      statusClass = 'preparing';
      statusChip = `<span class="room-status-chip preparing">å‡†å¤‡ä¸­ ${remainSec}s</span>`;
    }else{
      const used = Math.floor((now - prepEnd)/1000);
      const limit = systemSettings.basePracticeDuration * 60;
      if(used <= limit){
        statusClass = 'in-use';
        statusChip = `<span class="room-status-chip in-use">${formatHMS(used)}</span>`;
      }else{
        statusClass = 'expired';
        const overtime = used - limit;
        statusChip = `<span class="room-status-chip expired">è¶…æ—¶ ${formatDurationHuman(overtime)}</span>`;
      }
    }
  }else{
    statusClass = 'available';
    statusChip = `<span class="room-status-chip available">ç©ºé—²</span>`;
  }

  const metaTitle = `åç§°:${room.name}
ä½ç½®:${room.location||'æœªçŸ¥'}
ç±»å‹:${room.pianoKind||''}
å¤‡æ³¨:${room.remark||'æ— '}`.replace(/"/g,'"');

  const remarkLine = room.remark
    ? `<div class="room-remark" title="${room.remark.replace(/"/g,'&quot;')}">${room.remark}</div>`
    : '';

  return `
    <div class="room ${typeClass} ${statusClass}"
         title="${metaTitle}"
         data-room-name="${room.name}"
         data-has-student="${room.student?1:0}"
         onclick="roomCardClick(event,'${room.name}')"
         ondblclick="roomCardDoubleClick(event,'${room.name}')">
      <div class="room-name">${room.name}</div>
      ${remarkLine}
      <div class="room-status">
        ${studentInfo}
        <div class="room-bottom-row">
          ${statusChip}
          ${room.student ? `
          <div class="room-actions">
            <button class="room-clear-btn" onclick="event.stopPropagation();clearRoomWithConfirm('${room.name}')">
              <span>âœ•</span><span>æ¸…ç©º</span>
            </button>
            <button class="room-renew-btn" onclick="event.stopPropagation();renewRoom('${room.name}')">
              <span>âŸ³</span><span>ç»­</span>
            </button>
          </div>` : ''}
        </div>
      </div>
    </div>`;
}
/* ==== åŒå‡»æ¸…ç©º & ç»­ç´æˆ¿ åŠŸèƒ½æ–°å¢ BEGIN ==== */
function roomCardClick(event, roomName){
  const card = event.currentTarget;
  // é˜²æ­¢åŒå‡»ç¬¬äºŒæ¬¡ click è§¦å‘å·²æ’é˜Ÿçš„é€»è¾‘ï¼ˆåŒå‡»ä¼šå‡ºç°ä¸¤æ¬¡å•å‡» + ä¸€æ¬¡ dblclickï¼‰
  if(card._clickTimer){
    return;
  }
  card._clickTimer = setTimeout(()=>{
    card._clickTimer = null;
    handleRoomClick(roomName);
  },180);
}

function roomCardDoubleClick(event, roomName){
  event.stopPropagation();
  event.preventDefault();
  const card = event.currentTarget;
  if(card._clickTimer){
    clearTimeout(card._clickTimer);
    card._clickTimer = null;
  }
  handleRoomDoubleClick(roomName);
}

function handleRoomDoubleClick(name){
    if(isLocked){
        alert('ç³»ç»Ÿå·²é”å®š');return;
    }
    const r = rooms.find(x=>x.name===name);
    if(!r){
        showToast('æœªæ‰¾åˆ°ç´æˆ¿');return;
    }
    if(!r.student){
        showToast('è¯¥ç´æˆ¿å½“å‰ä¸ºç©º');return;
    }
    
    // ğŸ”¥ æ–°å¢ï¼šæ“ä½œé”ä¿æŠ¤ï¼Œé˜²æ­¢å¹¶å‘å†²çª
    const lockKey = `double_clear_${name}`;
    if(operationLocks.has(lockKey)){
        showToast('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å...');
        return;
    }
    operationLocks.add(lockKey);
    
    const studentName = r.student;
    const now = Date.now();

    // ğŸ”¥ æ–°å¢ï¼šæ ‡è®°æœ€è¿‘æ¸…ç©ºæ“ä½œæ—¶é—´æˆ³ï¼Œç”¨äºè¿œç¨‹æ›´æ–°ä¿æŠ¤
    window.lastClearOperations = window.lastClearOperations || new Map();
    window.lastClearOperations.set(name, now);

    try {
        // å†™ç»ƒç´æ—¥å¿—
        addPracticeLog(studentName, r.name, r.registerTime, now, 'åŒå‡»æ¸…ç©º');

        // æœ¬åœ°æ¸…ç©º
        r.student = null;
        r.registerTime = null;
        r.clearTime = now; // ğŸ”¥ æ–°å¢ï¼šè®°å½•æ¸…ç©ºæ—¶é—´

        // ç»Ÿä¸€çŠ¶æ€å¤„ç†
        handleRoomStatusChange('room_double_clear',{
            roomName:name,
            clearedStudent:studentName
        });

        // æŒä¹…åŒ– & UI
        persistRooms();
        needsFullUpdate = true;
        updateRooms();
        showToast(`${studentName} å·²ä» ${name} æ¸…ç©º (åŒå‡»)`);
        refreshSearchResults();

        // ğŸ”¥ å¢å¼ºï¼šä½¿ç”¨äº‹åŠ¡å¼æ¸…ç©ºç¡®ä¿åŸå­æ€§
        if(database && isOnline){
            attemptAtomicClear(name, studentName, now, lockKey);
        } else {
            // ç¦»çº¿æ¨¡å¼ä¸‹çš„ç«‹å³æ¨é€
            forcePushRoomsImmediately('room_double_clear_offline');
            setTimeout(() => operationLocks.delete(lockKey), 500);
        }
        
    } catch(error) {
        console.error('åŒå‡»æ¸…ç©ºå¤±è´¥:', error);
        operationLocks.delete(lockKey);
        showToast('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

// ğŸ”¥ æ–°å¢ï¼šåŸå­æ¸…ç©ºå‡½æ•°ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶
function attemptAtomicClear(roomName, expectedStudent, clearTime, lockKey) {
    const roomPath = `${FIREBASE_PATHS.ROOMS}`;
    
    database.ref(roomPath).transaction((currentRooms) => {
        if (!Array.isArray(currentRooms)) {
            console.warn('åŸå­æ¸…ç©ºå¤±è´¥ï¼šäº‘ç«¯æˆ¿é—´æ•°æ®æ ¼å¼é”™è¯¯');
            return currentRooms;
        }
        
        const targetRoom = currentRooms.find(r => r && r.name === roomName);
        if (!targetRoom) {
            console.warn(`åŸå­æ¸…ç©ºå¤±è´¥ï¼šäº‘ç«¯æœªæ‰¾åˆ°æˆ¿é—´ ${roomName}`);
            return currentRooms;
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿˜æ˜¯é¢„æœŸçš„å­¦ç”Ÿï¼ˆé˜²æ­¢è¢«å…¶ä»–æ“ä½œæ›¿æ¢ï¼‰
        if (targetRoom.student !== expectedStudent) {
            console.warn(`åŸå­æ¸…ç©ºå¤±è´¥ï¼šæˆ¿é—´ ${roomName} å­¦ç”Ÿå·²å˜æ›´ (æœŸæœ›:${expectedStudent}, å®é™…:${targetRoom.student})`);
            return; // å–æ¶ˆäº‹åŠ¡
        }
        
        // æ‰§è¡ŒåŸå­æ¸…ç©º
        targetRoom.student = null;
        targetRoom.registerTime = null;
        targetRoom.clearTime = clearTime;
        targetRoom.lastModified = Date.now();
        
        console.log(`âœ… åŸå­æ¸…ç©ºæˆåŠŸï¼š${roomName} (${expectedStudent})`);
        return currentRooms;
        
    }).then((result) => {
        if (result.committed) {
            console.log(`ğŸ”„ åŸå­æ¸…ç©ºå·²æäº¤åˆ°äº‘ç«¯ï¼š${roomName}`);
        } else {
            console.warn(`âš ï¸ åŸå­æ¸…ç©ºè¢«å–æ¶ˆï¼š${roomName}ï¼Œå¯èƒ½å·²è¢«å…¶ä»–è®¾å¤‡ä¿®æ”¹`);
            showToast(`${roomName} å¯èƒ½å·²è¢«å…¶ä»–è®¾å¤‡ä¿®æ”¹ï¼Œè¯·æ£€æŸ¥çŠ¶æ€`);
        }
        setTimeout(() => operationLocks.delete(lockKey), 500);
    // é”é‡Šæ”¾åè‹¥æœ‰æ’é˜Ÿçš„è¿œç¨‹æ›´æ–°å°è¯•å¤„ç†
    if(operationLocks.size===0 && window.__pendingRemoteRooms){
      const queued = window.__pendingRemoteRooms; // å–å½“å‰æœ€æ–°
      // ç«‹å³æ¸…ç©ºæ ‡è®°é¿å…é€’å½’å†²çª
      window.__pendingRemoteRooms = null; window.__pendingRemoteRoomsAttempts=0; window.__pendingRemoteRoomsFirstTs=null; window.__remoteQueueNoticeShown=false;
      setTimeout(()=>{ try{ handleRemoteRoomsUpdate(queued);}catch(e){console.warn('å¤„ç†æ’é˜Ÿè¿œç¨‹æ›´æ–°å¤±è´¥',e);} }, 50);
    }
    }).catch((error) => {
        console.error(`âŒ åŸå­æ¸…ç©ºå¤±è´¥ï¼š${roomName}`, error);
        showToast('æ¸…ç©ºæ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        // å›é€€ï¼šå†æ¬¡å°è¯•å¼ºåˆ¶æ¨é€
        forcePushRoomsImmediately('atomic_clear_fallback');
        setTimeout(() => operationLocks.delete(lockKey), 1000);
    if(operationLocks.size===0 && window.__pendingRemoteRooms){
      const queued = window.__pendingRemoteRooms;
      window.__pendingRemoteRooms = null; window.__pendingRemoteRoomsAttempts=0; window.__pendingRemoteRoomsFirstTs=null; window.__remoteQueueNoticeShown=false;
      setTimeout(()=>{ try{ handleRemoteRoomsUpdate(queued);}catch(e){console.warn('å¤„ç†æ’é˜Ÿè¿œç¨‹æ›´æ–°å¤±è´¥',e);} }, 100);
    }
    });
}


function renewRoom(name){
    if(isLocked){
        alert('ç³»ç»Ÿå·²é”å®š');return;
    }
    const r = rooms.find(x=>x.name===name);
    if(!r || !r.student){
        showToast('æ— æ³•ç»­ï¼šç´æˆ¿ä¸ºç©º');return;
    }

    // ====== æ–°å¢ï¼šå…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ’é˜Ÿï¼ˆåŒç±»å‹ï¼‰ ======
    // ç±»å‹æ˜ å°„
    const queueType =
        r.pianoKind === 'ä¸‰è§’é’¢ç´' ? 'grand' :
        r.pianoKind === 'ç«‹å¼é’¢ç´' ? 'upright' : 'none';

    const qArr = queueList[queueType] || [];
    if(qArr.length > 0){
        const first = qArr[0];

        // å¦‚æœé˜Ÿé¦–ä¸æ˜¯å½“å‰ä½¿ç”¨è€… => æŒ‰è§„åˆ™åº”è¯¥å…ˆç»™æ’é˜Ÿ
        if(first !== r.student){
            const keep = confirm(
                `å½“å‰æœ‰ ${qArr.length} äººåœ¨æ’é˜Ÿï¼ˆç¬¬1ä½ï¼š${first}ï¼‰ã€‚\n`+
                `æŒ‰è§„åˆ™éœ€ä¼˜å…ˆåˆ†é…ç»™æ’é˜Ÿå­¦ç”Ÿã€‚\n\n`+
                `ã€ç¡®å®šã€‘= ä»ç„¶å¼ºåˆ¶ä¸º ${r.student} ç»­æ—¶ï¼ˆè¦†ç›–æ’é˜Ÿä¼˜å…ˆï¼‰\n`+
                `ã€å–æ¶ˆã€‘= æ‰“å¼€æ’é˜Ÿåˆ†é…çª—å£å¤„ç†åˆ†é…`
            );
            if(!keep){
                // æ‰“å¼€é˜Ÿåˆ—åˆ†é…å¼¹çª—ï¼Œä¼˜å…ˆå¤„ç†æ’é˜Ÿ
                showQueueModal(name, queueType);
                return;
            }else{
                // è®°å½•ä¸€æ¬¡è¦†ç›–é˜Ÿåˆ—çš„æ“ä½œï¼Œæ–¹ä¾¿å®¡è®¡
                logOperation('renew_override_queue', {
                    room: name,
                    currentStudent: r.student,
                    queueFirst: first,
                    queueLength: qArr.length,
                    timestamp: Date.now()
                });
            }
        }
    }
    // ====== é˜Ÿåˆ—å¤„ç†ç»“æŸ ======

    if(!confirm(`ç»­ç´æˆ¿ï¼š${name}\nå½“å‰å­¦ç”Ÿï¼š${r.student}\næ­¤æ“ä½œå°†é‡æ–°è®¡æ—¶ï¼Œä¿ç•™åŒä¸€å­¦ç”Ÿã€‚`)){
        return;
    }

    const now = Date.now();
    // è®°å½•ä¸Šä¸€æ®µ
    addPracticeLog(r.student, r.name, r.registerTime, now, 'ç»­ç´æˆ¿');
    // é‡è®¾å¼€å§‹æ—¶é—´
    r.registerTime = now;

    handleRoomStatusChange('room_renew',{
        roomName:name,
        student:r.student
    });

    persistRooms();
    needsFullUpdate = true;
    updateRooms();
    showToast(`${r.student} å·²åœ¨ ${name} ç»­æ—¶æˆåŠŸ`);
    refreshSearchResults();

    // äº‘ç«¯åŒæ­¥ï¼šç«‹å³æ¨é€
    if(syncEnabled && isOnline){
        try{
            syncToFirebase('room_renew',{
                roomName:name,
                student:r.student,
                newRegisterTime:now,
                timestamp:now
            });
        }catch(e){
            console.warn('room_renew åŒæ­¥å¤±è´¥(ç¨åè‡ªåŠ¨é‡è¯•):',e);
        }
    }
}

/* ==== åŒå‡»æ¸…ç©º & ç»­ç´æˆ¿ åŠŸèƒ½æ–°å¢ END ==== */


function updateRooms(){
  // ğŸ”¥ æ–°å¢ï¼šéªŒè¯æˆ¿é—´æ•°æ®ä¸€è‡´æ€§
  const dbRoomNames = new Set(Object.keys(roomDatabase));
  const invalidRooms = rooms.filter(r => r && r.name && !dbRoomNames.has(r.name));
  
  if(invalidRooms.length > 0) {
    console.warn('ğŸ”§ å‘ç°æ— æ•ˆæˆ¿é—´ï¼Œè‡ªåŠ¨æ¸…ç†:', invalidRooms.map(r => r.name));
    rooms = rooms.filter(r => !r || !r.name || dbRoomNames.has(r.name));
    persistRooms();
    needsFullUpdate = true;
  }
  
  if(needsFullUpdate){
    renderRoomsLayout();
    needsFullUpdate=false;
  } else {
    updateRoomStatuses();
  }
  
  updateUtilization();
  updateDemandButtonsStatus();
  if(timelineVisible) updateTimeline();
}



function updateUtilization(){
  const total=rooms.length;
  const occ=rooms.filter(r=>r.student).length;
  $('utilizationRate').textContent=`ç´æˆ¿ä½¿ç”¨ç‡: ${(occ/Math.max(total,1)*100).toFixed(2)}%`;
}
function showFloorDetails(f){roomViewMode='detailed';currentFloor=f;needsFullUpdate=true;updateRooms();}
function showFloorOverview(){roomViewMode='overview';currentFloor=null;needsFullUpdate=true;updateRooms();}

/* æˆ¿é—´æ“ä½œ */

function deleteRoom(name){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  if(!confirm('ç¡®å®šåˆ é™¤ç´æˆ¿ '+name+' ?'))return;
  const idx=rooms.findIndex(r=>r.name===name);
  if(idx>-1){
    const r=rooms[idx];
    if(r.student){addPracticeLog(r.student,r.name,r.registerTime,Date.now(),'åˆ é™¤æ—¶æ¸…é™¤');}
    rooms.splice(idx,1);
  }
  delete roomDatabase[name];
  persistRoomDb();persistRooms();
  needsFullUpdate=true;updateRooms();
  showToast('å·²åˆ é™¤ç´æˆ¿');
}
function clearRoomWithConfirm(name){
    if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
    const r=rooms.find(x=>x.name===name);
    if(!r||!r.student)return;
    if(!confirm(`ç¡®å®šæ¸…é™¤ ${name} ä¸­çš„å­¦ç”Ÿ ${r.student} ?`))return;
    
    const studentName = r.student;  // ä¿å­˜å­¦ç”Ÿåç§°
    
    addPracticeLog(r.student,r.name,r.registerTime,Date.now(),'æ‰‹åŠ¨æ¸…é™¤');
    // ğŸ”¥ æ–°å¢ï¼šç»“æŸç»ƒä¹ æ—¶é•¿è®°å½•
    const sessionId = `${studentName}_${name}_${r.registerTime}`;
    endPracticeSession(sessionId, Date.now(), 'æ‰‹åŠ¨æ¸…é™¤');

    
    // ğŸ”¥ ç¡®ä¿è®¾ç½®ä¸º null è€Œä¸æ˜¯ undefined
  r.student = null;
  r.registerTime = null;
  r.clearTime = Date.now(); // è®°å½•æ¸…ç©ºæ—¶é—´ç”¨äºä¿æŠ¤
    
    // ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„æˆ¿é—´çŠ¶æ€å˜åŒ–å¤„ç†
    handleRoomStatusChange('room_clear', {
        roomName: name,
        clearedStudent: studentName,
        source: 'manual_clear'
    });
    
    needsFullUpdate=true;
    updateRooms();
    
    showToast('å·²æ¸…é™¤');
    
  // ğŸ”¥ æ–°å¢ï¼šåˆ·æ–°æœç´¢ç»“æœ
  refreshSearchResults();
  // ğŸ”¥ ç«‹å³æ¨é€å•æˆ¿é—´æ¸…ç©ºï¼ˆè·³è¿‡æ‰¹é‡é˜²æŠ–ï¼‰
  try{ performActualSync('single_clear',{room:name}); }catch(e){ console.warn('single_clear sync failed',e); }
}

function clearOvertimeRoom(name){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  const r=rooms.find(x=>x.name===name);
  if(!r||!r.student)return;
  if(!confirm(`ç¡®å®šæ¸…é™¤ ${name} ä¸­çš„å­¦ç”Ÿ ${r.student} ?`))return;
  
  const studentName = r.student;  // ä¿å­˜å­¦ç”Ÿåç§°
  const operationTime = Date.now();
  
  addPracticeLog(r.student,r.name,r.registerTime,operationTime,'è¶…æ—¶ç®¡ç†æ¸…é™¤');
  
  // ğŸ”¥ ç¡®ä¿è®¾ç½®ä¸º null è€Œä¸æ˜¯ undefined
  r.student = null;
  r.registerTime = null;
  r.clearTime = Date.now();
  
  // ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„æˆ¿é—´çŠ¶æ€å˜åŒ–å¤„ç†
  handleRoomStatusChange('overtime_clear', {
      roomName: name,
      clearedStudent: studentName,
      source: 'overtime_management'
  });
  
  // åˆ·æ–°UI
  needsFullUpdate=true;
  updateRooms();
  
  // è‹¥è¶…æ—¶ç®¡ç†é¢æ¿å½“å‰å¯è§åˆ™ç«‹å³é‡æ¸²æŸ“
  const modal = $('overtimeModal');
  if(modal && modal.style.display === 'block'){
    renderOvertimeList(true);
  }
  
  showToast('å·²æ¸…é™¤');
  
  // ğŸ”¥ æ–°å¢ï¼šåˆ·æ–°æœç´¢ç»“æœ
  refreshSearchResults();
  // ğŸ”¥ ç«‹å³æ¨é€å•æˆ¿é—´æ¸…ç©º
  try{ performActualSync('single_clear',{room:name}); }catch(e){ console.warn('single_clear sync failed',e); }
}

window.clearOvertimeRoom = clearOvertimeRoom; // ä¾›å†…è” onclick ä½¿ç”¨

/* ç»ƒç´æ—¥å¿— */
function addPracticeLog(student,room,start,end,reason='æ­£å¸¸ç»“æŸ'){
  const prepare=60000;
  const actualStart=start+prepare;
  const dur=Math.max(0,end-actualStart);
  practiceLogs.push({
    student,room,startTime:start,endTime:end,
    duration:dur,actualStartTime:actualStart,
    date:new Date(start).toDateString(),endReason:reason
  });
  persistLogs();
}

/* =============== 6. å­¦ç”Ÿåº“ä¸æ—¶é—´æ®µï¼ˆæ ¸å¿ƒç²¾ç®€ï¼‰ =============== */
// ğŸ”¥ ä¿®å¤ï¼šæ”¹è¿› getStudentMajor å‡½æ•°ï¼Œå¢åŠ å¹´çº§è¯†åˆ«
function getStudentMajor(studentName) {
    // ğŸ”¥ æ·»åŠ è°ƒè¯•æ—¥å¿—
    console.log('ğŸ” æŸ¥æ‰¾å­¦ç”Ÿä¸“ä¸š:', studentName);
    
    for (const [major, students] of Object.entries(studentDatabase)) {
        if (Array.isArray(students)) {
            const studentRecord = students.find(s => {
                if (typeof s === 'string') {
                    return s === studentName;
                } else if (typeof s === 'object' && s.name) {
                    return s.name === studentName;
                }
                return false;
            });
            
            if (studentRecord) {
                console.log('âœ… æ‰¾åˆ°ä¸“ä¸š:', studentName, '->', major);
                return major;
            }
        }
    }
    
    console.warn('âš ï¸ æœªæ‰¾åˆ°å­¦ç”Ÿä¸“ä¸šï¼Œä½¿ç”¨é»˜è®¤:', studentName, '-> å…¶ä»–');
    return 'å…¶ä»–';
}

// ğŸ”¥ æ–°å¢ï¼šè·å–å­¦ç”Ÿå¹´çº§ä¿¡æ¯
function getStudentGrade(studentName) {
    for (const [major, students] of Object.entries(studentDatabase)) {
        if (Array.isArray(students)) {
            const studentRecord = students.find(s => {
                if (typeof s === 'string') {
                    return s === studentName;
                } else if (typeof s === 'object' && s.name) {
                    return s.name === studentName;
                }
                return false;
            });
            
            if (studentRecord && typeof studentRecord === 'object') {
                return studentRecord.grade || '';
            }
        }
    }
    return '';
}

// ğŸ”¥ æ–°å¢ï¼šè§£æå¹´çº§æ ¼å¼ï¼ˆæ”¯æŒG1-G12æ ¼å¼ï¼‰
function parseGradeInput(input) {
    if (!input || typeof input !== 'string') return '';
    
    const cleaned = input.trim().toUpperCase();
    
    // åŒ¹é… G1-G12 æ ¼å¼
    const gradeMatch = cleaned.match(/^G(\d{1,2})$/);
    if (gradeMatch) {
        const gradeNum = parseInt(gradeMatch[1]);
        if (gradeNum >= 1 && gradeNum <= 12) {
            return `G${gradeNum}`;
        }
    }
    
    // åŒ¹é…ä¸­æ–‡å¹´çº§æ ¼å¼
    const chineseMatch = cleaned.match(/^(\d{1,2})[å¹´çº§]?$/);
    if (chineseMatch) {
        const gradeNum = parseInt(chineseMatch[1]);
        if (gradeNum >= 1 && gradeNum <= 12) {
            return `G${gradeNum}`;
        }
    }
    
    // ç›´æ¥æ•°å­—æ ¼å¼
    const numMatch = cleaned.match(/^\d{1,2}$/);
    if (numMatch) {
        const gradeNum = parseInt(cleaned);
        if (gradeNum >= 1 && gradeNum <= 12) {
            return `G${gradeNum}`;
        }
    }
    
    return input; // ä¿æŒåŸè¾“å…¥ï¼Œè®©ç”¨æˆ·è‡ªç”±å¡«å†™
}

// ğŸ”¥ æ–°å¢ï¼šæ ¼å¼åŒ–å¹´çº§æ˜¾ç¤º
function formatGradeDisplay(grade) {
    if (!grade) return '';
    
    const gradeMatch = grade.match(/^G(\d{1,2})$/);
    if (gradeMatch) {
        const num = parseInt(gradeMatch[1]);
        return `${num}å¹´çº§`;
    }
    
    return grade;
}
// ğŸ”¥ ä¿®æ”¹ï¼šå‡çº§å­¦ç”Ÿæ•°æ®åº“ç»“æ„ä»¥æ”¯æŒå¹´çº§
function upgradeStudentDatabaseStructure() {
    let hasChanges = false;
    
    Object.keys(studentDatabase).forEach(major => {
        const students = studentDatabase[major];
        if (Array.isArray(students)) {
            const upgradedStudents = students.map(student => {
                if (typeof student === 'string') {
                    // å°†å­—ç¬¦ä¸²æ ¼å¼å‡çº§ä¸ºå¯¹è±¡æ ¼å¼
                    hasChanges = true;
                    return {
                        name: student,
                        grade: '' // é»˜è®¤ç©ºå¹´çº§ï¼Œç­‰å¾…ç”¨æˆ·å¡«å†™
                    };
                } else if (typeof student === 'object' && student.name) {
                    // ç¡®ä¿å¯¹è±¡æ ¼å¼æœ‰å¹´çº§å­—æ®µ
                    if (!student.hasOwnProperty('grade')) {
                        hasChanges = true;
                        student.grade = '';
                    }
                    return student;
                }
                return student;
            });
            studentDatabase[major] = upgradedStudents;
        }
    });
    
    if (hasChanges) {
        persistStudents();
        console.log('âœ… å­¦ç”Ÿæ•°æ®åº“ç»“æ„å·²å‡çº§ï¼Œæ”¯æŒå¹´çº§ä¿¡æ¯');
    }
}


// ğŸ”¥ ä¿®æ”¹ï¼šè·å–å­¦ç”Ÿå§“åï¼ˆå…¼å®¹æ–°æ—§æ ¼å¼ï¼‰
/**
 * ğŸ”¥ ä¿®å¤ï¼šå®‰å…¨è·å–å­¦ç”Ÿå§“åï¼ˆå…¼å®¹æ‰€æœ‰æ ¼å¼ï¼‰
 */
function getStudentName(studentRecord) {
    if (!studentRecord) {
        console.warn('âš ï¸ getStudentName: å­¦ç”Ÿè®°å½•ä¸ºç©º');
        return '';
    }
    
    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥è¿”å›
    if (typeof studentRecord === 'string') {
        return safeTrim(studentRecord);
    }
    
    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°è¯•è·å– name å­—æ®µ
    if (typeof studentRecord === 'object' && studentRecord !== null) {
        if (studentRecord.name) {
            return safeTrim(studentRecord.name);
        }
        
        // å…¼å®¹å…¶ä»–å¯èƒ½çš„å­—æ®µå
        if (studentRecord.studentName) {
            return safeTrim(studentRecord.studentName);
        }
        
        // å¦‚æœå¯¹è±¡æ²¡æœ‰ name å­—æ®µï¼Œå°è¯•è½¬æ¢ä¸ºå­—ç¬¦ä¸²
        console.warn('âš ï¸ å­¦ç”Ÿå¯¹è±¡ç¼ºå°‘ name å­—æ®µ:', studentRecord);
        return safeTrim(JSON.stringify(studentRecord));
    }
    
    // å…¶ä»–ç±»å‹ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²
    console.warn('âš ï¸ æœªçŸ¥çš„å­¦ç”Ÿæ•°æ®ç±»å‹:', typeof studentRecord, studentRecord);
    return safeTrim(studentRecord);
}


// ğŸ”¥ ä¿®æ”¹ï¼šè·å–å­¦ç”Ÿå®Œæ•´ä¿¡æ¯
function getStudentInfo(studentName) {
    for (const [major, students] of Object.entries(studentDatabase)) {
        if (Array.isArray(students)) {
            const studentRecord = students.find(s => getStudentName(s) === studentName);
            if (studentRecord) {
                return {
                    name: getStudentName(studentRecord),
                    major: major,
                    grade: typeof studentRecord === 'object' ? (studentRecord.grade || '') : ''
                };
            }
        }
    }
    return { name: studentName, major: 'å…¶ä»–', grade: '' };
}
/**
 * ğŸ”¥ ä¿®å¤ï¼šæ•°æ®åº“æ¸…ç†å’ŒéªŒè¯å‡½æ•°
 */
function validateAndCleanStudentDatabase() {
    console.log('ğŸ”§ å¼€å§‹éªŒè¯å’Œæ¸…ç†å­¦ç”Ÿæ•°æ®åº“...');
    
    let cleanedCount = 0;
    let errorCount = 0;
    
    Object.keys(studentDatabase).forEach(major => {
        if (!Array.isArray(studentDatabase[major])) {
            console.warn(`âš ï¸ ä¸“ä¸š ${major} çš„æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œå°è¯•ä¿®å¤...`);
            
            // å°è¯•ä¿®å¤éæ•°ç»„æ•°æ®
            if (typeof studentDatabase[major] === 'object' && studentDatabase[major] !== null) {
                studentDatabase[major] = Object.values(studentDatabase[major]).filter(v => v);
            } else {
                studentDatabase[major] = [];
            }
            cleanedCount++;
        }
        
        // æ¸…ç†æ•°ç»„ä¸­çš„æ— æ•ˆæ•°æ®
        const originalLength = studentDatabase[major].length;
        studentDatabase[major] = studentDatabase[major].filter(student => {
            try {
                const name = getStudentName(student);
                if (!name || name.length === 0) {
                    console.warn(`âš ï¸ å‘ç°ç©ºå§“åå­¦ç”Ÿè®°å½•:`, student);
                    errorCount++;
                    return false;
                }
                return true;
            } catch (error) {
                console.error(`âŒ å¤„ç†å­¦ç”Ÿè®°å½•æ—¶å‡ºé”™:`, student, error);
                errorCount++;
                return false;
            }
        });
        
        if (studentDatabase[major].length !== originalLength) {
            cleanedCount++;
            console.log(`ğŸ”§ ä¸“ä¸š ${major}: æ¸…ç†äº† ${originalLength - studentDatabase[major].length} ä¸ªæ— æ•ˆè®°å½•`);
        }
        
        // ç¡®ä¿æ‰€æœ‰å­¦ç”Ÿè®°å½•éƒ½æ˜¯æ­£ç¡®çš„æ ¼å¼
        studentDatabase[major] = studentDatabase[major].map(student => {
            if (typeof student === 'string') {
                return {
                    name: student,
                    grade: ''
                };
            } else if (typeof student === 'object' && student !== null) {
                return {
                    name: getStudentName(student),
                    grade: student.grade || ''
                };
            } else {
                return {
                    name: String(student),
                    grade: ''
                };
            }
        });
    });
    
    // ç§»é™¤ç©ºä¸“ä¸š
    Object.keys(studentDatabase).forEach(major => {
        if (!studentDatabase[major] || studentDatabase[major].length === 0) {
            delete studentDatabase[major];
            cleanedCount++;
        }
    });
    
    if (cleanedCount > 0 || errorCount > 0) {
        persistStudents();
        console.log(`âœ… æ•°æ®åº“æ¸…ç†å®Œæˆ: æ¸…ç†äº† ${cleanedCount} ä¸ªé—®é¢˜ï¼Œç§»é™¤äº† ${errorCount} ä¸ªæ— æ•ˆè®°å½•`);
        showToast(`ğŸ”§ æ•°æ®åº“å·²æ¸…ç†: ä¿®å¤ ${cleanedCount} ä¸ªé—®é¢˜`, 3000);
    } else {
        console.log('âœ… å­¦ç”Ÿæ•°æ®åº“éªŒè¯é€šè¿‡ï¼Œæ— éœ€æ¸…ç†');
    }
    
    return { cleanedCount, errorCount };
}

function handleRoomClick(name){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  const room = rooms.find(r=>r.name===name);
  if(!room) return;

  const type = room.pianoKind==='ä¸‰è§’é’¢ç´' ? 'grand' :
               room.pianoKind==='ç«‹å¼é’¢ç´' ? 'upright' : 'none';

  // è‹¥è¯¥ç±»å‹æœ‰æ’é˜Ÿ -> æ‰“å¼€å¿«é€Ÿåˆ†é…/æ›¿æ¢å¼¹çª—
  if(queueList[type] && queueList[type].length){
    showQueueModal(name,type);
    return;
  }

  // æ²¡æœ‰æ’é˜Ÿ
  if(room.student){
    alert('è¯¥ç´æˆ¿æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œæ— æ’é˜Ÿä¸èƒ½ç›´æ¥æ›¿æ¢ã€‚');
    return;
  }
  currentRoom = name;
  openStudentSelectModal(room);
}

function openStudentSelectModal(room){
  $('modalStudentSearch').value='';
  $('studentListModal').style.display='block';
  
  // åˆå§‹åŒ–è¾“å…¥å¤„ç†å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
  setTimeout(() => {
    if (!inputHandlers.has('modalStudentSearch')) {
      const handler = new SmartInputHandler('modalStudentSearch', searchStudentsModal);
      inputHandlers.set('modalStudentSearch', handler);
    }
    
    // èšç„¦åˆ°æœç´¢æ¡†
    const searchInput = $('modalStudentSearch');
    if (searchInput) {
      searchInput.focus();
    }
  }, 50);
  
  if(room.pianoKind==='ä¸‰è§’é’¢ç´') renderPianoStudents();
  else renderMajorButtons();
}

function renderPianoStudents(){
  const list=$('modalStudentList');
  const arr=studentDatabase['é’¢ç´æ•™ç ”å®¤']||[];
  const studentNames = arr.map(s => getStudentName(s)); // ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®è·å–å­¦ç”Ÿå§“å
  list.innerHTML='<div class="category-title" style="margin-bottom:6px;">é’¢ç´æ•™ç ”å®¤</div>' +
    (studentNames.length ? studentNames.map(name=>renderStudentSelectable(name)).join('') : '<div style="text-align:center;color:#999;padding:15px;">æš‚æ— å­¦ç”Ÿ</div>');
  $('addNewStudentSection').style.display='block';
}

function renderMajorButtons(){
  const list=$('modalStudentList');
  const majors=Object.keys(studentDatabase);
  list.innerHTML='<div class="major-buttons" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;">'+
    majors.map(m=>`<button class="major-btn" style="background:var(--primary-color);" onclick="showMajorStudents('${m}')">${m} (${studentDatabase[m].length})</button>`).join('')+
    '</div>';
  $('addNewStudentSection').style.display='none';
}
function showMajorStudents(m){
  const list=$('modalStudentList');
  const arr=studentDatabase[m]||[];
  const studentNames = arr.map(s => getStudentName(s)); // ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®è·å–å­¦ç”Ÿå§“å
  let html=`<div class="major-header" style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
      <button class="back-btn" style="background:var(--secondary-color);" onclick="renderMajorButtons()">â† è¿”å›</button>
      <div class="category-title">${m} (${studentNames.length})</div>
    </div>`;
  html+=studentNames.map(name=>renderStudentSelectable(name)).join('');
  list.innerHTML=html;
  $('addNewStudentSection').style.display='block';
}

function renderStudentSelectable(name) {
    const statusInfo = getStudentStatusForModal(name);
    const occupiedRoom = rooms.find(r => r.student === name);
    const canForceReplace = statusInfo.isDisabled && occupiedRoom && currentRoom && occupiedRoom.name !== currentRoom;
    
    // æ ¹æ®æ˜¯å¦å¯ä»¥å¼ºåˆ¶æ›¿æ¢æ¥å†³å®šç‚¹å‡»è¡Œä¸º
    let clickAction;
    if (statusInfo.isDisabled) {
        if (canForceReplace) {
            clickAction = `onclick="showStudentStatusHint('${name}','${statusInfo.reason||''}')"`;
        } else {
            clickAction = `onclick="showStudentStatusHint('${name}','${statusInfo.reason||''}')"`;
        }
    } else {
        clickAction = `onclick="selectStudent('${name}')"`;
    }
    
    // æ·»åŠ ç‰¹æ®Šæ ·å¼ç±»
    let itemClass = 'student-item';
    if (statusInfo.isDisabled) {
        itemClass += ' disabled-student';
        if (canForceReplace) {
            itemClass += ' force-replaceable';
        }
    }
    
    return `<div class="${itemClass}" ${clickAction}>
        <span class="student-name-text">${name}</span>
        ${statusInfo.statusBadge || ''}
        ${canForceReplace ? '<span class="force-replace-hint" title="ç‚¹å‡»å¯å¼ºåˆ¶æ›¿æ¢">âš¡</span>' : ''}
    </div>`;
}
function closeModal(){ 
  const modal = $('studentListModal');
  modal.style.display='none'; 
  currentRoom=null; 
  
  // ğŸ”¥ æ–°å¢ï¼šè§¦å‘æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
  modal.dispatchEvent(new CustomEvent('modalClosed'));
}

function searchStudentsModal(q){
  if(!currentRoom){
    console.warn('currentRoom is null in searchStudentsModal');
    return;
  }
  const room=rooms.find(r=>r.name===currentRoom);
  if(!room){
    console.warn('Room not found:', currentRoom);
    return;
  }
  
  const isGrand=room && room.pianoKind==='ä¸‰è§’é’¢ç´';
  const list=$('modalStudentList');
  q=q.trim();
  
  if(!q){
    if(isGrand) renderPianoStudents(); 
    else renderMajorButtons();
    return;
  }
  
  let out=[];
  if(isGrand){
    (studentDatabase['é’¢ç´æ•™ç ”å®¤']||[])
      .filter(s=>{
        const studentName = getStudentName(s); // ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®è·å–å­¦ç”Ÿå§“å
        return matchPinyin(studentName, q);
      })
      .forEach(s=>out.push(renderStudentSelectable(getStudentName(s)))); // ğŸ”¥ ä¿®å¤ï¼šä¼ é€’å§“åå­—ç¬¦ä¸²
  }else{
    for(const [m,arr] of Object.entries(studentDatabase)){
      const filtered=arr.filter(s=>{
        const studentName = getStudentName(s); // ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®è·å–å­¦ç”Ÿå§“å
        return matchPinyin(studentName, q);
      });
      if(filtered.length){
        out.push(`<div class="category-title" style="margin-top:10px;">${m}</div>`);
        filtered.forEach(s=>out.push(renderStudentSelectable(getStudentName(s)))); // ğŸ”¥ ä¿®å¤ï¼šä¼ é€’å§“åå­—ç¬¦ä¸²
      }
    }
  }
  
  if(!out.length){
    list.innerHTML=`<div style="text-align:center;color:#999;padding:20px;">æœªæ‰¾åˆ°åŒ¹é…å­¦ç”Ÿ</div>`;
    $('addNewStudentSection').style.display='block';
  }else{
    list.innerHTML=out.join('');
    $('addNewStudentSection').style.display='none';
  }
}

function addNewStudent(){
  const name=$('modalStudentSearch').value.trim();
  if(!name){alert('è¯·è¾“å…¥å§“å');return;}
  // æ£€æŸ¥é‡å¤
  if(Object.values(studentDatabase).some(a=>a.includes(name))){
    alert('å­¦ç”Ÿå·²å­˜åœ¨');return;
  }
  const room=rooms.find(r=>r.name===currentRoom);
  let major='å…¶ä»–';
  if(room && room.pianoKind==='ä¸‰è§’é’¢ç´') major='é’¢ç´æ•™ç ”å®¤';
  else major=prompt('è¯·è¾“å…¥å­¦ç”Ÿä¸“ä¸š(é»˜è®¤ å…¶ä»–)ï¼š','å…¶ä»–') || 'å…¶ä»–';
  if(!studentDatabase[major]) studentDatabase[major]=[];
  studentDatabase[major].push(name);
  persistStudents();
  showToast('å·²æ·»åŠ  '+name);
  selectStudent(name);
}

function getStudentStatusForModal(student){
  // å ç”¨
  const occ=rooms.find(r=>r.student===student);
  const inG=queueList.grand.includes(student);
  const inU=queueList.upright.includes(student);
  const inN=queueList.none.includes(student);
  let badge='',dis=false,cls='',reason='';
  if(occ){
    const now=Date.now();
    const prepEnd=occ.registerTime+60000;
    if(now<prepEnd){badge=`<span class="student-status-badge preparing">å‡†å¤‡ä¸­:${occ.name}</span>`;reason='å‡†å¤‡ä¸­';}
    else{
      const used=Math.floor((now-prepEnd)/1000);
      const limit=systemSettings.basePracticeDuration*60;
      if(used<=limit){badge=`<span class="student-status-badge practicing">ç»ƒç´:${occ.name}</span>`;reason='ç»ƒç´ä¸­';}
      else{badge=`<span class="student-status-badge overtime">è¶…æ—¶:${occ.name}</span>`;reason='è¶…æ—¶ä¸­';}
    }
    dis=true;cls='disabled-student';
  }else if(inG||inU||inN){
    let type=inG?'ä¸‰è§’':inU?'ç«‹å¼':'æ™®é€š';
    const pos=(inG?queueList.grand:inU?queueList.upright:queueList.none).indexOf(student)+1;
    badge=`<span class="student-status-badge queuing">${type}æ’é˜Ÿç¬¬${pos}ä½</span>`;
    reason='å·²åœ¨æ’é˜Ÿ';
    dis=true;cls='disabled-student';
  }
  return {
    statusBadge:badge,
    isDisabled:dis,
    disabledClass:cls,
    reason
  };
}

// ä¿®æ”¹ showStudentStatusHint å‡½æ•°ï¼Œæ·»åŠ å¼ºåˆ¶æ›¿æ¢é€‰é¡¹
function showStudentStatusHint(name, reason) {
    // è·å–å­¦ç”Ÿå½“å‰çŠ¶æ€è¯¦æƒ…
    const studentStatus = getStudentStatusForModal(name);
    const occupiedRoom = rooms.find(r => r.student === name);
    
    // æ„å»ºè¯¦ç»†ä¿¡æ¯
    let detailInfo = `å­¦ç”Ÿ ${name} å½“å‰ä¸å¯é€‰æ‹©\nåŸå› ï¼š${reason}`;
    
    if (occupiedRoom) {
        const now = Date.now();
        const prepEnd = occupiedRoom.registerTime + 60000;
        let timeInfo = '';
        
        if (now < prepEnd) {
            const remainSec = Math.ceil((prepEnd - now) / 1000);
            timeInfo = `æ­£åœ¨ ${occupiedRoom.name} å‡†å¤‡ä¸­ï¼ˆå‰©ä½™ ${remainSec} ç§’ï¼‰`;
        } else {
            const used = Math.floor((now - prepEnd) / 1000);
            const limit = systemSettings.basePracticeDuration * 60;
            if (used <= limit) {
                timeInfo = `æ­£åœ¨ ${occupiedRoom.name} ç»ƒç´ï¼ˆå·²ç”¨ ${formatHMS(used)}ï¼‰`;
            } else {
                const overtime = used - limit;
                timeInfo = `æ­£åœ¨ ${occupiedRoom.name} è¶…æ—¶ç»ƒç´ï¼ˆè¶…æ—¶ ${formatDurationHuman(overtime)}ï¼‰`;
            }
        }
        detailInfo += `\nå½“å‰çŠ¶æ€ï¼š${timeInfo}`;
    }
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼ºåˆ¶æ›¿æ¢
    const canForceReplace = occupiedRoom && currentRoom && occupiedRoom.name !== currentRoom;
    
    if (canForceReplace) {
        detailInfo += `\n\næ˜¯å¦è¦å°† ${name} ä» ${occupiedRoom.name} è½¬ç§»åˆ° ${currentRoom}ï¼Ÿ`;
        detailInfo += `\nâš ï¸ æ³¨æ„ï¼šè¿™å°†ç»“æŸå…¶åœ¨åŸç´æˆ¿çš„ç»ƒç´å¹¶è®°å½•åˆ°æ—¥å¿—ä¸­ã€‚`;
        
        if (confirm(detailInfo)) {
            // ç”¨æˆ·ç¡®è®¤å¼ºåˆ¶æ›¿æ¢
            forceReplaceStudent(name, occupiedRoom.name, currentRoom);
        }
    } else {
        // ä¸èƒ½å¼ºåˆ¶æ›¿æ¢çš„æƒ…å†µï¼Œåªæ˜¾ç¤ºä¿¡æ¯
        alert(detailInfo);
    }
}

// æ–°å¢ï¼šå¼ºåˆ¶æ›¿æ¢å­¦ç”Ÿå‡½æ•°
function forceReplaceStudent(studentName, fromRoom, toRoom) {
    if (isLocked) {
        alert('ç³»ç»Ÿå·²é”å®š');
        return;
    }
    
    const fromRoomObj = rooms.find(r => r.name === fromRoom);
    const toRoomObj = rooms.find(r => r.name === toRoom);
    
    if (!fromRoomObj || !toRoomObj) {
        alert('ç´æˆ¿ä¿¡æ¯é”™è¯¯');
        return;
    }
    
    const now = Date.now();
    
    // è®°å½•åŸç´æˆ¿çš„ç»ƒç´æ—¥å¿—
    addPracticeLog(
        studentName,
        fromRoom,
        fromRoomObj.registerTime,
        now,
        `å¼ºåˆ¶è½¬ç§»åˆ° ${toRoom}`
    );
    
    // å¦‚æœç›®æ ‡ç´æˆ¿æœ‰å…¶ä»–å­¦ç”Ÿï¼Œä¹Ÿè¦è®°å½•æ—¥å¿—
    if (toRoomObj.student && toRoomObj.student !== studentName) {
        addPracticeLog(
            toRoomObj.student,
            toRoom,
            toRoomObj.registerTime,
            now,
            `è¢« ${studentName} å¼ºåˆ¶æ›¿æ¢`
        );
    }
    
    // æ¸…ç©ºåŸç´æˆ¿
    fromRoomObj.student = null;
    fromRoomObj.registerTime = null;
    
    // åˆ†é…åˆ°æ–°ç´æˆ¿
    toRoomObj.student = studentName;
    toRoomObj.registerTime = now;
    
    // æŒä¹…åŒ–å’Œæ›´æ–°UI
    persistRooms();
    
    // ğŸ”¥ æ”¹è¿›ï¼šå¸¦æ“ä½œæ ‡è¯†çš„åŒæ­¥
    if (syncEnabled && isOnline) {
        syncToFirebase('force_replace', {
            studentName,
            fromRoom,
            toRoom,
            timestamp: now,
            source: 'force_selection'
        });
    }
    
    needsFullUpdate = true;
    updateRooms();
    
    // å…³é—­å­¦ç”Ÿé€‰æ‹©æ¨¡æ€æ¡†
    closeModal();
    
    // åˆ·æ–°æœç´¢ç»“æœ
    refreshSearchResults();
    
    showToast(`${studentName} å·²å¼ºåˆ¶è½¬ç§»åˆ° ${toRoom}`);
    
    // è®°å½•æ“ä½œæ—¥å¿—
    logOperation('force_replace_student', {
        student: studentName,
        fromRoom,
        toRoom,
        timestamp: now
    });
}

async function selectStudent(student) {
    // é˜²è¿ç‚¹ï¼šè‹¥å·²æœ‰æ­£åœ¨è¿›è¡Œçš„é€‰æ‹©ï¼Œç›´æ¥å¿½ç•¥
    if (window.__selectingInProgress) {
        console.log('[selectStudent] å¿½ç•¥é‡å¤ç‚¹å‡»:', student);
        return;
    }
    window.__selectingInProgress = true;
  window.__selectingStartTs = Date.now();
    // UI ç¦ç”¨ï¼ˆæŒ‰é’®/å¯ç‚¹å‡»é¡¹ï¼‰
    try{
      const modal = document.getElementById('studentSelectModal') || document;
      const clickable = modal.querySelectorAll('button, [data-student-name], .student-item, .student-row');
      clickable.forEach(el=>{ el.__oldPointerEvents = el.style.pointerEvents; el.style.pointerEvents='none'; el.classList.add('selecting-disabled'); });
    }catch(_){ }
    if (!currentRoom) {
        console.error('currentRoom is null when selecting student:', student);
        showToast('é”™è¯¯ï¼šæœªé€‰æ‹©ç´æˆ¿');
        closeModal();
        return;
    }
    
    const room = rooms.find(r => r.name === currentRoom);
    if (!room) {
        console.error('Room not found:', currentRoom);
        showToast('é”™è¯¯ï¼šç´æˆ¿ä¸å­˜åœ¨');
        closeModal();
        return;
    }
    
    // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥æ“ä½œé”
    const lockKey = `assign_${student}`;
    if (operationLocks.has(lockKey)) {
        // æ£€æŸ¥é”æ˜¯å¦è¶…æ—¶
        const lockTime = operationLockTimestamps.get(lockKey);
        if (lockTime && (Date.now() - lockTime > OPERATION_LOCK_TIMEOUT)) {
            // è¶…æ—¶é”ï¼Œè‡ªåŠ¨æ¸…ç†
            operationLocks.delete(lockKey);
            operationLockTimestamps.delete(lockKey);
            console.log('ğŸ”“ æ“ä½œé”è¶…æ—¶æ¸…ç†:', lockKey);
        } else {
            showToast('è¯¥å­¦ç”Ÿæ­£åœ¨è¢«å…¶ä»–æ“ä½œå¤„ç†ä¸­ï¼Œè¯·ç¨åé‡è¯•');
            return;
        }
    }
    
    // ğŸ”¥ æ–°å¢ï¼šæ·»åŠ æ“ä½œé”
    operationLocks.add(lockKey);
    operationLockTimestamps.set(lockKey, Date.now());
    console.log('ğŸ”’ è®¾ç½®æ“ä½œé”:', lockKey, 'å½“å‰é”æ•°é‡:', operationLocks.size);
    
    try {
        // ğŸ”¥ æ–°å¢ï¼šä½¿ç”¨ Firebase äº‹åŠ¡ç¡®ä¿åŸå­æ€§
        const success = await assignStudentWithTransaction(student, room);
        if (success) {
            showToast(`${student} å·²ç™»è®°åˆ° ${room.name}`);
            closeModal();
            // ğŸ”¥ æ–°å¢ï¼šåˆ·æ–°æœç´¢ç»“æœ
            refreshSearchResults();
        } else {
            showToast('åˆ†é…å¤±è´¥ï¼šå­¦ç”Ÿå¯èƒ½å·²è¢«å…¶ä»–è®¾å¤‡åˆ†é…');
        }
    } catch (error) {
        console.error('åˆ†é…å­¦ç”Ÿæ—¶å‘ç”Ÿé”™è¯¯:', error);
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
        // ğŸ”¥ ç§»é™¤æ“ä½œé”
        operationLocks.delete(lockKey);
        operationLockTimestamps.delete(lockKey);
        console.log('ğŸ”“ ç§»é™¤æ“ä½œé”:', lockKey, 'å‰©ä½™é”æ•°é‡:', operationLocks.size);
        // è§£é™¤ UI ç¦ç”¨
        try{
          const modal = document.getElementById('studentSelectModal') || document;
          const clickable = modal.querySelectorAll('button, [data-student-name], .student-item, .student-row');
          clickable.forEach(el=>{ el.style.pointerEvents = el.__oldPointerEvents || ''; el.classList.remove('selecting-disabled'); });
        }catch(_){ }
        window.__selectingInProgress = false;
    window.__selectingStartTs = null;
    if(operationLocks.size===0 && window.__pendingRemoteRooms){
      const queued = window.__pendingRemoteRooms;
      window.__pendingRemoteRooms = null; window.__pendingRemoteRoomsAttempts=0; window.__pendingRemoteRoomsFirstTs=null; window.__remoteQueueNoticeShown=false;
      setTimeout(()=>{ try{ handleRemoteRoomsUpdate(queued);}catch(e){console.warn('å¤„ç†æ’é˜Ÿè¿œç¨‹æ›´æ–°å¤±è´¥',e);} }, 30);
    }
    }
}

// âœ… ä¿®å¤ç‰ˆï¼šä½¿ç”¨æ—§å¼ / compat transaction å†™æ³•
async function assignStudentWithTransaction(student, targetRoom) {
    if (!database || !isOnline) {
        return assignStudentLocal(student, targetRoom);
    }

    const roomsRef = database.ref('rooms');
  let abortReason = null; // æ ‡è®°äº‹åŠ¡æ”¾å¼ƒåŸå› ï¼ˆåŒºåˆ†æœ€è¿‘å ç”¨ vs å…¶å®ƒï¼‰

    // è®°å½•æœ¬åœ°å¿«ç…§ç”¨äºåç»­æ—¥å¿—å¯¹æ¯”ï¼ˆé¿å…åœ¨äº‹åŠ¡å‡½æ•°é‡Œåšå‰¯ä½œç”¨ï¼‰
    const localBefore = Array.isArray(rooms) ? rooms.map(r => r ? {
        name: r.name,
        student: r.student,
        registerTime: r.registerTime
    } : r) : [];

    // ç”¨äºåœ¨ updateFunction å†…æš‚å­˜å˜åŒ–ï¼ˆåªå­˜æ•°æ®ï¼Œä¸å†™æ—¥å¿—ï¼Œä¸åšå¤–éƒ¨è°ƒç”¨ï¼‰
    let changeSummary = null;

    const result = await new Promise((resolve, reject) => {
        roomsRef.transaction(function(currentRooms){
            if (!Array.isArray(currentRooms)) {
                // äº‘ç«¯è¿˜ä¸æ˜¯æ•°ç»„æˆ–ä¸ºç©º â†’ ä¸åšå†™å…¥ï¼Œç­‰å¾…åˆå§‹åŒ–é€»è¾‘
                return currentRooms;
            }

            const idx = currentRooms.findIndex(r => r && r.name === targetRoom.name);
            if (idx === -1) {
                console.warn('äº‹åŠ¡ä¸­æ­¢ï¼šæ‰¾ä¸åˆ°æˆ¿é—´', targetRoom.name);
                return; // undefined â†’ abortï¼Œä¸æäº¤
            }

            // å…‹éš†
            const next = currentRooms.slice();

            const now = Date.now();

            // å­¦ç”Ÿæ˜¯å¦åœ¨å…¶å®ƒæˆ¿é—´
            const otherIndex = next.findIndex((r,i)=> r && r.student === student && i !== idx);

            // ç›®æ ‡æˆ¿é—´å½“å‰å ç”¨è€…
            const originalStudent = next[idx].student || null;
            const originalRegister = next[idx].registerTime || null;

            // å¦‚æœåŒä¸€ä¸ªå­¦ç”Ÿå·²ç»åœ¨ç›®æ ‡æˆ¿é—´ï¼Œæ— éœ€æ”¹åŠ¨ï¼ˆè¿”å›åŸæ•°ç»„ï¼Œäº‹åŠ¡ä¼šåˆ¤æ–­æ— å˜åŒ–ï¼‰
            if (originalStudent === student) {
                return currentRooms; // ä¸åšå˜åŒ–
            }

      // â€œåˆšåˆšè¢«åˆ«äººå ç”¨â€é˜²æŠ–ï¼šçª—å£ä» 5000ms å‡ä¸º 1500ms (A)
      if (originalStudent && originalStudent !== student) {
        const existingTime = next[idx].registerTime || 0;
        if (now - existingTime < 1500) {
          console.log('ğŸš« æ‹’ç»è¦†ç›–ï¼šæˆ¿é—´åˆšè¢«', originalStudent, 'å ç”¨ <1.5s');
          abortReason = 'recent_occupy';
          return; // abort (committed=false)
        }
      }

            // å…ˆæ¸…ç†è¯¥å­¦ç”Ÿåœ¨å…¶å®ƒæˆ¿é—´çš„å ç”¨
            let clearedRoom = null;
            if (otherIndex !== -1) {
                clearedRoom = {
                    name: next[otherIndex].name,
                    fromRegisterTime: next[otherIndex].registerTime
                };
                next[otherIndex] = {
                    ...next[otherIndex],
                    student: null,
                    registerTime: null
                };
            }

            // å†™å…¥ç›®æ ‡æˆ¿é—´
            next[idx] = {
                ...next[idx],
                student: student,
                registerTime: now
            };

            // è®°å½•å˜åŒ–æ¦‚è¦ï¼ˆä¸ä¼šå†™åˆ°æ•°æ®åº“ï¼Œåªåœ¨ JS é‡Œï¼Œç”¨äºæäº¤æˆåŠŸåç”Ÿæˆæ—¥å¿—ï¼‰
            changeSummary = {
                targetRoom: next[idx].name,
                newStudent: student,
                previousStudent: originalStudent,
                previousRegisterTime: originalRegister,
                clearedRoom: clearedRoom
            };

            return next;
        }, function(error, committed, snapshot){
            if (error) return reject(error);
            resolve({ committed, snapshot });
        }, false); // ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ applyLocallyï¼ˆå¯ true/falseï¼›false = ä¸åšä¹è§‚æœ¬åœ°æ›´æ–°ï¼‰
    });

  if (!result.committed) {
    if (abortReason === 'recent_occupy') {
      console.warn('âš ï¸ äº‹åŠ¡æœªæäº¤ï¼šæˆ¿é—´åˆšè¢«å ç”¨(1.5s é˜²æŠ–)');
      showToast('æˆ¿é—´åˆšè¢«å ç”¨ï¼Œè¯· 1~2 ç§’åå†è¯•');
    } else {
      console.warn('âš ï¸ äº‹åŠ¡æœªæäº¤ï¼ˆæ¡ä»¶ä¸æ»¡è¶³æˆ–è¢«å¹¶å‘è¦†ç›–ï¼‰');
    }
    return false;
  }

    const serverRooms = result.snapshot.val();
    if (!Array.isArray(serverRooms)) {
        console.warn('âš ï¸ äº‹åŠ¡åäº‘ç«¯ rooms éæ•°ç»„ï¼Œå¿½ç•¥');
        return false;
    }

    // æ›´æ–°æœ¬åœ°ï¼ˆå»ºè®®æ•´ä½“æ›¿æ¢ï¼Œä¿æŒä¸äº‘ç«¯ä¸€è‡´ï¼‰
    syncEnabled = false;
    rooms = serverRooms.map(r => r ? { ...r } : r);
    persistRooms();
    needsFullUpdate = true;
    updateRooms();
    triggerRealTimePracticeStatusUpdate();
    setTimeout(()=>{ syncEnabled = true; }, 500);

    // ç°åœ¨å†å†™æ—¥å¿—ï¼ˆä¸ä¼šé‡å¤ï¼‰
    if (changeSummary) {
        const now = Date.now();
        if (changeSummary.previousStudent && changeSummary.previousStudent !== student) {
            addPracticeLog(
                changeSummary.previousStudent,
                changeSummary.targetRoom,
                changeSummary.previousRegisterTime,
                now,
                `è¢« ${student} æ›¿æ¢(äº‹åŠ¡)`
            );
        }
        if (changeSummary.clearedRoom) {
            addPracticeLog(
                student,
                changeSummary.clearedRoom.name,
                changeSummary.clearedRoom.fromRegisterTime,
                now,
                'è½¬ç§»(äº‹åŠ¡)'
            );
        }
    }

    return true;
}

// ğŸ”¥ æ–°å¢ï¼šæ¸…ç†è¶…æ—¶çš„æ“ä½œé”
function cleanupExpiredOperationLocks() {
    const now = Date.now();
    let cleaned = 0;
    
    for (const [lockKey, timestamp] of operationLockTimestamps.entries()) {
        if (now - timestamp > OPERATION_LOCK_TIMEOUT) {
            operationLocks.delete(lockKey);
            operationLockTimestamps.delete(lockKey);
            cleaned++;
            console.log('ğŸ”“ æ“ä½œé”è¶…æ—¶æ¸…ç†:', lockKey, 'æŒç»­æ—¶é—´:', Math.round((now - timestamp) / 1000), 'ç§’');
        }
    }
    
    if (cleaned > 0) {
        console.log(`ğŸ§¹ å·²æ¸…ç† ${cleaned} ä¸ªè¶…æ—¶æ“ä½œé”`);
    }
}

// å‘¨æœŸæ€§æ¸…ç†é—ç•™æ“ä½œé” (D) - æ¯ 30 ç§’
if(!window.__opLockCleaner){
  window.__opLockCleaner = setInterval(()=>{
    try{ cleanupExpiredOperationLocks(); }catch(e){ console.warn('cleanupExpiredOperationLocks error', e); }
    // é”çœ‹é—¨ç‹—ï¼šæ£€æµ‹é•¿æ—¶é—´æœªé‡Šæ”¾çš„é” (>20s) ä¸»åŠ¨é‡Šæ”¾
    try{
      const now = Date.now();
      for(const [k,ts] of operationLockTimestamps.entries()){
        if(now - ts > 20000){
          console.warn('[lock-watchdog] å¼ºåˆ¶é‡Šæ”¾é•¿æ—¶é—´é”', k, 'å­˜æ´»(ms)=', now-ts);
          operationLocks.delete(k); operationLockTimestamps.delete(k);
        }
      }
      if(operationLocks.size===0 && window.__pendingRemoteRooms){
        const queued = window.__pendingRemoteRooms;
        window.__pendingRemoteRooms = null; window.__pendingRemoteRoomsAttempts=0; window.__pendingRemoteRoomsFirstTs=null; window.__remoteQueueNoticeShown=false;
        setTimeout(()=>{ try{ handleRemoteRoomsUpdate(queued);}catch(e){console.warn('å¤„ç†æ’é˜Ÿè¿œç¨‹æ›´æ–°å¤±è´¥',e);} }, 10);
      }
    }catch(e){ console.warn('lock watchdog error', e); }
    // selectingInProgress è¶…æ—¶è‡ªæ„ˆ (>8s)
    try{
      if(window.__selectingInProgress && window.__selectingStartTs && (Date.now() - window.__selectingStartTs > 8000)){
        console.warn('[selecting-watchdog] é‡Šæ”¾å¡ä½çš„é€‰æ‹©æµç¨‹');
        window.__selectingInProgress=false; window.__selectingStartTs=null;
        const modal = document.getElementById('studentSelectModal') || document;
        const clickable = modal.querySelectorAll('button, [data-student-name], .student-item, .student-row');
        clickable.forEach(el=>{ el.style.pointerEvents = el.__oldPointerEvents || ''; el.classList.remove('selecting-disabled'); });
      }
    }catch(e){ console.warn('selecting watchdog error', e); }
  }, 30000);
}

// ğŸ”¥ æ–°å¢ï¼šæ‰‹åŠ¨æ¸…ç†æ‰€æœ‰æ“ä½œé”ï¼ˆè°ƒè¯•ç”¨ï¼‰
function clearAllOperationLocks() {
    const count = operationLocks.size;
    operationLocks.clear();
    operationLockTimestamps.clear();
    console.log(`ğŸ§¹ å·²æ‰‹åŠ¨æ¸…ç† ${count} ä¸ªæ“ä½œé”`);
    showToast(`å·²æ¸…ç† ${count} ä¸ªæ“ä½œé”`);
}


// ğŸ”¥ æ–°å¢ï¼šæœ¬åœ°åˆ†é…å‡½æ•°ï¼ˆç¦»çº¿æ¨¡å¼æˆ–äº‹åŠ¡å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
function assignStudentLocal(student, room) {
    // ğŸ”¥ å¢å¼ºï¼šæœ¬åœ°å†²çªæ£€æµ‹
    const occupiedRooms = rooms.filter(r => r.student === student);
    const otherRooms = occupiedRooms.filter(r => r.name !== room.name);
    
    if (otherRooms.length > 0) {
        const confirmMsg = `å­¦ç”Ÿ ${student} æ­£åœ¨ ${otherRooms.map(r => r.name).join('ã€')} ç»ƒç´ï¼Œæ˜¯å¦è½¬ç§»åˆ° ${room.name}?`;
        if (!confirm(confirmMsg)) {
            return false;
        }
        
        // æ¸…ç©ºå…¶ä»–æˆ¿é—´
        const now = Date.now();
        otherRooms.forEach(or => {
            addPracticeLog(or.student, or.name, or.registerTime, now, 'è½¬ç§»(æœ¬åœ°å†²çªè§£å†³)');
            or.student = null;
            or.registerTime = null;
        });
    }
    
    // ğŸ”¥ å¢å¼ºï¼šæ£€æŸ¥ç›®æ ‡æˆ¿é—´çŠ¶æ€
    if (room.student && room.student !== student) {
        const confirmReplace = confirm(`${room.name} æ­£è¢« ${room.student} ä½¿ç”¨ï¼Œç¡®å®šè¦æ›¿æ¢å—ï¼Ÿ`);
        if (!confirmReplace) {
            return false;
        }
    }
    
    // åˆ†é…åˆ°ç›®æ ‡æˆ¿é—´
    assignStudentToRoom(student, room, Date.now());
    return true;
}


function assignStudentToRoom(student, room, time) {
    // ğŸ”¥ å¢å¼ºï¼šè®°å½•è¢«æ›¿æ¢å­¦ç”Ÿçš„è¯¦ç»†æ—¥å¿—
    if (room.student && room.student !== student) {
        addPracticeLog(room.student, room.name, room.registerTime, time, `è¢« ${student} æ›¿æ¢`);
        console.log(`ğŸ“ è®°å½•è¢«æ›¿æ¢: ${room.student} åœ¨ ${room.name} è¢« ${student} æ›¿æ¢`);
    }
    
    // ğŸ”¥ ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
    room.student = student;
    // ğŸ”¥ æ–°å¢ï¼šå¼€å§‹ç»ƒä¹ æ—¶é•¿è®°å½•
    startPracticeSession(student, room.name, time);

    room.registerTime = time;
    
    // ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„æˆ¿é—´çŠ¶æ€å˜åŒ–å¤„ç†
    handleRoomStatusChange('student_assign', {
        roomName: room.name,
        studentName: student,
        source: 'student_selection'
    });
    
    needsFullUpdate = true;
    updateRooms();
    
    // ğŸ”¥ è®°å½•æ“ä½œæ—¥å¿—
    logOperation('student_assign', {
        student: student,
        room: room.name,
        timestamp: time,
        method: 'assignStudentToRoom'
    });
}


function refreshAllDerivedAfterSlotChange(affectedStudents){
  // 1. ç«‹å³é‡ç®—è€ƒå‹¤
  checkAttendance();
  // 2. æ¸…ç†ç›¸å…³å¼‚å¸¸æé†’
  if (Array.isArray(affectedStudents)) {
    const before = practiceOverrunReminders.length;
    practiceOverrunReminders = practiceOverrunReminders.filter(r=> !affectedStudents.includes(r.student));
    if (practiceOverrunReminders.length !== before) {
      persistOverruns(true,'slot_change_cleanup',{removed:before-practiceOverrunReminders.length});
      updateOverrunPanel();
    }
  }
  // 3. æ­£åœ¨è¿›è¡Œçš„ä¼šè¯æ›´æ–° currentSlot
  practiceSessionTracker.forEach(sess=>{
     if(affectedStudents && affectedStudents.includes(sess.studentName)){
        sess.currentSlot = findCurrentTimeSlot(getStudentTodaySlots(sess.studentName), Date.now());
     }
  });
}


function addTimeSlot(){
  if(!currentEditingStudent||!currentEditingWeekday) return;
  const sh=$('startHour').value, sm=$('startMinute').value, eh=$('endHour').value, em=$('endMinute').value;
  const start=`${sh}:${sm}`, end=`${eh}:${em}`;
  if(!validateTimeSlot(start,end)) return;
  
  // ç¡®ä¿å­¦ç”Ÿæ—¶é—´æ®µç»“æ„å­˜åœ¨
  initStudentSlotStructure(currentEditingStudent);
  
  // æ·»åŠ å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿ dayArr å­˜åœ¨
  const dayArr = studentTimeSlots[currentEditingStudent][currentEditingWeekday];
  if(!dayArr) {
    // å¦‚æœä»ç„¶ä¸å­˜åœ¨ï¼Œé‡æ–°åˆå§‹åŒ–
    studentTimeSlots[currentEditingStudent][currentEditingWeekday] = [];
  }
  
  const finalDayArr = studentTimeSlots[currentEditingStudent][currentEditingWeekday];
  
  if(hasTimeConflict(finalDayArr,{start,end})){
    alert('æ—¶é—´å†²çª');return;
  }
  
  finalDayArr.push({start,end,duration:calcDurationText(start,end)});
  finalDayArr.sort((a,b)=>a.start.localeCompare(b.start));
  persistStudentSlots();
  displayCurrentTimeSlots();
  
  // ğŸ”¥ ä¿®å¤ï¼šåªåœ¨å­¦ç”Ÿæ•°æ®åº“æ¨¡æ€æ¡†ç¡®å®æ‰“å¼€ä¸”å½“å‰ä¸åœ¨æ—¶é—´æ®µç®¡ç†ä¸­æ—¶æ‰åˆ·æ–°å­¦ç”Ÿåˆ—è¡¨
  if($('studentDatabaseModal').style.display === 'block' && $('timeSlotModal').style.display !== 'block'){
    renderStudentDatabaseList();
  }
  refreshAllDerivedAfterSlotChange([currentEditingStudent]);
  showToast('å·²æ·»åŠ æ—¶é—´æ®µ');
}

function initStudentSlotStructure(name){
  if(!studentTimeSlots[name]){
    studentTimeSlots[name]={monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]};
  }
  // é¢å¤–æ£€æŸ¥ï¼šç¡®ä¿æ¯ä¸ªæ˜ŸæœŸçš„æ•°ç»„éƒ½å­˜åœ¨
  ['monday','tuesday','wednesday','thursday','friday'].forEach(day => {
    if(!studentTimeSlots[name][day]) {
      studentTimeSlots[name][day] = [];
    }
  });
}

function validateTimeSlot(start,end){
  const s=timeToMinutes(start), e=timeToMinutes(end);
  if(isNaN(s)||isNaN(e)){alert('æ—¶é—´æ ¼å¼æ— æ•ˆ');return false;}
  if(e<=s){alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´');return false;}
  // å…è®¸ 00:00 - 23:59 ä¹‹é—´ä»»æ„åˆ†é’Ÿ
  if(s<0 || e>24*60){alert('æ—¶é—´éœ€åœ¨ 00:00 - 23:59 èŒƒå›´å†…');return false;}
  return true;
}

function hasTimeConflict(list,slot){
  const ns=timeToMinutes(slot.start), ne=timeToMinutes(slot.end);
  return list.some(s=>{
    const es=timeToMinutes(s.start), ee=timeToMinutes(s.end);
    return ns<ee && ne>es;
  });
}
function calcDurationText(start,end){
  const m=timeToMinutes(end)-timeToMinutes(start);
  const h=Math.floor(m/60),mm=m%60;
  if(h && mm) return `${h}å°æ—¶${mm}åˆ†é’Ÿ`;
  if(h) return `${h}å°æ—¶`;
  return `${mm}åˆ†é’Ÿ`;
}

/* æ—¶é—´æ®µç®¡ç†ï¼ˆä»…ä¿ç•™è°ƒç”¨éœ€è¦çš„æ ¸å¿ƒ UI å‡½æ•°å˜é‡ï¼‰ */
let currentEditingStudent=null;
let currentEditingWeekday='monday';
let currentEditingMajor=null;

function manageStudentTimeSlots(student,major){
  currentEditingStudent=student;
  currentEditingMajor=major;
  currentEditingWeekday='monday';
  $('timeSlotModalTitle').textContent=`ç®¡ç† ${student} çš„ç»ƒç´æ—¶é—´æ®µ`;
  initTimeSelectors();
  selectWeekday('monday');
  displayWeeklySummary();
  $('timeSlotModal').style.display='block';
}
function initTimeSelectors(){
  const sh=$('startHour'), eh=$('endHour'), sm=$('startMinute'), em=$('endMinute');
  sh.innerHTML=''; eh.innerHTML=''; sm.innerHTML=''; em.innerHTML='';
  
  // å°æ—¶ 0-23
  for(let h=0; h<=23; h++){
    const opt=`<option>${pad2(h)}</option>`;
    sh.innerHTML+=opt;
    eh.innerHTML+=opt;
  }
  
  // ğŸ”¥ ä¿®æ”¹ï¼šåˆ†é’Ÿåªèƒ½é€‰æ‹© 10 çš„å€æ•°
  for(let m=0;m<60;m++){
    const opt=`<option>${pad2(m)}</option>`;
    sm.innerHTML+=opt;
    em.innerHTML+=opt;
  }

  
  // é»˜è®¤ï¼š08:00 - 09:00
  sh.value='08'; sm.value='00';
  eh.value='09'; em.value='00';
}

function selectWeekday(d){
  currentEditingWeekday=d;
  document.querySelectorAll('.weekday-btn').forEach(b=>b.classList.toggle('active',b.dataset.day===d));
  $('currentDayTitle').textContent=WEEK_CN[d]+'æ—¶é—´æ®µï¼š';
  displayCurrentTimeSlots();
}
function displayCurrentTimeSlots(){
  const c=$('currentTimeSlotsList');
  const slots=studentTimeSlots[currentEditingStudent]?.[currentEditingWeekday]||[];
  if(!slots.length){c.innerHTML='<div style="text-align:center;color:#999;padding:20px;">å½“å‰æ˜ŸæœŸæš‚æ— æ—¶é—´æ®µ</div>';displayWeeklySummary();return;}
  c.innerHTML=slots.map((s,i)=>`
    <div class="time-slot-item">
      <div class="time-slot-info">
        <div class="time-slot-time">${s.start} - ${s.end}</div>
        <div class="time-slot-duration">æ—¶é•¿ï¼š${s.duration}</div>
      </div>
      <button class="delete-time-slot" onclick="deleteTimeSlot(${i})">åˆ é™¤</button>
    </div>`).join('');
  displayWeeklySummary();
}
function deleteTimeSlot(i){
  if(!currentEditingStudent) return;
  const arr=studentTimeSlots[currentEditingStudent][currentEditingWeekday];
  if(!arr||!arr[i])return;
  if(!confirm(`åˆ é™¤æ—¶é—´æ®µ ${arr[i].start}-${arr[i].end}?`))return;
  
  // åˆ é™¤æŒ‡å®šçš„æ—¶é—´æ®µ
  arr.splice(i,1);
  
  // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ—¶é—´æ®µéƒ½è¢«æ¸…ç©º
  const hasAnySlots = Object.values(studentTimeSlots[currentEditingStudent]).some(a=>a.length);
  if(!hasAnySlots) {
    // å¦‚æœæ‰€æœ‰æ—¶é—´æ®µéƒ½è¢«æ¸…ç©ºï¼Œåˆ é™¤è¯¥å­¦ç”Ÿçš„æ—¶é—´æ®µè®°å½•
    delete studentTimeSlots[currentEditingStudent];
  }
  
  // æŒä¹…åŒ–æ•°æ®
  persistStudentSlots();
  
  // ğŸ”¥ ä¿®å¤ï¼šåªåˆ·æ–°å½“å‰æ—¶é—´æ®µç®¡ç†ç•Œé¢ï¼Œä¸è§¦å‘å¤–éƒ¨ç•Œé¢åˆ·æ–°
  displayCurrentTimeSlots();
  
  // ğŸ”¥ ä¿®å¤ï¼šåªåœ¨å­¦ç”Ÿæ•°æ®åº“æ¨¡æ€æ¡†ç¡®å®æ‰“å¼€ä¸”å½“å‰ä¸åœ¨æ—¶é—´æ®µç®¡ç†ä¸­æ—¶æ‰åˆ·æ–°å­¦ç”Ÿåˆ—è¡¨
  if($('studentDatabaseModal').style.display === 'block' && $('timeSlotModal').style.display !== 'block'){
    renderStudentDatabaseList();
  }
  
  // åˆ·æ–°ç›¸å…³çš„æ´¾ç”Ÿæ•°æ®ï¼ˆè€ƒå‹¤ã€å¼‚å¸¸æé†’ç­‰ï¼‰
  refreshAllDerivedAfterSlotChange([currentEditingStudent]);
  
  showToast('å·²åˆ é™¤æ—¶é—´æ®µ');
}

function displayWeeklySummary(){
  const box=$('weeklySummaryDisplay');
  const data=studentTimeSlots[currentEditingStudent];
  if(!data){box.innerHTML='<div class="weekly-summary-empty">æš‚æ— æ—¶é—´æ®µè®¾ç½®</div>';return;}
  let html='';let total=0;
  Object.keys(WEEK_CN).forEach(k=>{
    const arr=data[k]||[];
    if(arr.length){
      total+=arr.length;
      html+=`<div class="weekly-summary-day">
        <div class="weekly-summary-day-title">${WEEK_CN[k]} (${arr.length}æ®µ)</div>
        <div>${arr.map(s=>`<span class="weekly-summary-slot">${s.start}-${s.end}</span>`).join('')}</div>
      </div>`;
    }
  });
  if(!html) html='<div class="weekly-summary-empty">æš‚æ— æ—¶é—´æ®µè®¾ç½®</div>';
  box.innerHTML=html;
}
function clearAllTimeSlots(){
  if(!currentEditingStudent) return;
  const d=studentTimeSlots[currentEditingStudent];
  if(!d){showToast('æ— æ—¶é—´æ®µ');return;}
  let total=Object.values(d).reduce((a,b)=>a+b.length,0);
  if(!total){showToast('æ— æ—¶é—´æ®µ');return;}
  if(!confirm(`ç¡®å®šæ¸…ç©º ${currentEditingStudent} çš„å…¨éƒ¨ ${total} ä¸ªæ—¶é—´æ®µ?`))return;
  delete studentTimeSlots[currentEditingStudent];
  persistStudentSlots();
  displayCurrentTimeSlots();
  // ğŸ”¥ ä¿®å¤ï¼šåªåœ¨å­¦ç”Ÿæ•°æ®åº“æ¨¡æ€æ¡†ç¡®å®æ‰“å¼€ä¸”å½“å‰ä¸åœ¨æ—¶é—´æ®µç®¡ç†ä¸­æ—¶æ‰åˆ·æ–°å­¦ç”Ÿåˆ—è¡¨
  if($('studentDatabaseModal').style.display === 'block' && $('timeSlotModal').style.display !== 'block'){
    renderStudentDatabaseList();
  }
  refreshAllDerivedAfterSlotChange([currentEditingStudent]);
  showToast('å·²æ¸…ç©º');
}

function closeTimeSlotModal(){
  $('timeSlotModal').style.display='none';
  currentEditingStudent=null;
  currentEditingMajor=null;
  currentEditingWeekday='monday';
  
  // ğŸ”¥ æ–°å¢ï¼šå…³é—­æ—¶é—´æ®µç®¡ç†åï¼Œå¦‚æœå­¦ç”Ÿæ•°æ®åº“æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œåˆ·æ–°å­¦ç”Ÿåˆ—è¡¨
  if($('studentDatabaseModal').style.display === 'block'){
    renderStudentDatabaseList();
  }
}


function searchStudentDatabase(){
  // åªéœ€è¦é‡æ–°æ¸²æŸ“å³å¯ï¼ˆrenderStudentDatabaseList ä¼šè¯»å–è¾“å…¥æ¡†å€¼ï¼‰
  renderStudentDatabaseList();
}
function refreshAllMajorSelectors(){
  populateMajorFilter();           // å­¦ç”Ÿåº“ç­›é€‰
  populateGradeFilter();           // ğŸ”¥ æ–°å¢å¹´çº§ç­›é€‰
  populateAttendanceMajorFilter(); // è€ƒå‹¤ç­›é€‰ï¼ˆä¸‹é¢æ–°å¢ï¼‰
}
function populateAttendanceMajorFilter(){
  const sel = $('attendanceMajorFilter');
  if(!sel) return;
  const current = sel.value;
  const majors = Object.keys(studentDatabase).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));
  sel.innerHTML = '<option value="">æ‰€æœ‰ä¸“ä¸š</option>' +
    majors.map(m=>`<option value="${m}">${m}</option>`).join('');
  // å°½é‡ä¿ç•™ç”¨æˆ·å½“å‰é€‰æ‹©
  if([...sel.options].some(o=>o.value===current)) sel.value=current;
}
function cleanupEmptyMajors(){
  let removed = 0;
  Object.keys(studentDatabase).forEach(m=>{
    if(!Array.isArray(studentDatabase[m]) || studentDatabase[m].length===0){
      delete studentDatabase[m];
      removed++;
    }
  });
  if(removed){
    persistStudents();
    refreshAllMajorSelectors();
  }
}
function injectStudentDbHint(){
  if(document.querySelector('.usage-tip')) return;
  const modal=$('studentDatabaseModal').querySelector('.modal-content');
  const tip=document.createElement('div');
  tip.className='usage-tip';
  tip.style.cssText='background:#e8f5e8;border:1px solid #27ae60;border-radius:6px;padding:10px;font-size:12px;color:#27ae60;margin:10px 0;cursor:pointer;';
  tip.innerHTML='<div style="font-weight:700;">ğŸ’¡ ä½¿ç”¨æç¤º (ç‚¹å‡»å±•å¼€)</div><div style="display:none;line-height:1.5;margin-top:6px;">' +
    'â€¢ åªæœ‰å·¥ä½œæ—¥è€ƒå‹¤ï¼›æ—¶é—´æ®µåˆ†é’Ÿä¸º10çš„å€æ•°ï¼›æ”¯æŒ CSV æ™ºèƒ½å¢é‡å¯¼å…¥ï¼›è¯·å‡åŠŸèƒ½åœ¨è€ƒå‹¤é¢æ¿ã€‚' +
    '</div>';
  tip.addEventListener('click',()=>{
    const c=tip.querySelector('div:nth-child(2)');
    const show=c.style.display!=='none';
    c.style.display=show?'none':'block';
  });
  modal.insertBefore(tip,modal.children[2]);
}
function populateMajorFilter(){
  const sel=$('majorFilter');
  const majors=Object.keys(studentDatabase).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));
  sel.innerHTML='<option value="">æ‰€æœ‰ä¸“ä¸š</option>'+majors.map(m=>`<option value="${m}">${m}</option>`).join('');
}
function renderStudentDatabaseList(){
  const box = $('studentDatabaseList');
  if(!box) return;
  const q = $('studentDbSearch') ? $('studentDbSearch').value.trim() : '';
  const filter = $('majorFilter') ? $('majorFilter').value : '';
  const gradeFilter = $('gradeFilter') ? $('gradeFilter').value : ''; // ğŸ”¥ æ–°å¢å¹´çº§ç­›é€‰

  // ä¿åº•æ ¼å¼åŒ–
  Object.keys(studentDatabase).forEach(m=>{
    if(!Array.isArray(studentDatabase[m])){
      studentDatabase[m] = (studentDatabase[m] && typeof studentDatabase[m]==='object')
        ? Object.values(studentDatabase[m]).filter(v=>typeof v==='string')
        : [];
    }
  });

  const majors = Object.keys(studentDatabase)
    .sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));

  let html='';
  let shownStudents = 0;

  majors.forEach(m=>{
    if(filter && filter!==m) return;
    const students = studentDatabase[m]
      .filter(s=>{
        const name = getStudentName(s);
        const grade = typeof s === 'object' ? (s.grade || '') : '';
        
        // ğŸ”¥ æ–°å¢ï¼šå¹´çº§ç­›é€‰
        if(gradeFilter) {
          if(gradeFilter === 'no_grade' && grade) return false;
          if(gradeFilter !== 'no_grade' && grade !== gradeFilter) return false;
        }
        
        return matchPinyin(name, q);
      })
      .sort((a,b)=>{
        const nameA = getStudentName(a);
        const nameB = getStudentName(b);
        return nameA.localeCompare(nameB,'zh-Hans-CN');
      });

    if(!students.length) return;

    shownStudents += students.length;

    html += `
      <div class="student-major-block" data-major="${m}">
        <div class="student-major-header" style="
          display:flex;justify-content:space-between;align-items:center;
          background:#f0f6fb;border:1px solid #d5e4f1;
          padding:8px 12px;border-radius:8px;margin-top:14px;cursor:pointer;
        " onclick="toggleMajorCollapse('${m}')">
          <div style="font-weight:700;color:#2c3e50;">${m} 
            <span style="font-size:12px;color:#666;font-weight:500;">(${students.length})</span>
          </div>
          <div style="font-size:12px;color:#3498db;" id="majorCollapseIcon_${m}">æ”¶èµ· â–²</div>
        </div>
        <div class="student-major-body" id="majorBody_${m}" style="border:1px solid #e0e6eb;border-top:none;border-radius:0 0 8px 8px;padding:6px 6px 2px 6px;">
          ${students.map(s=>{
            const name = getStudentName(s);
            const grade = typeof s === 'object' ? (s.grade || '') : '';
            const hasSlots = studentTimeSlots[name] && Object.values(studentTimeSlots[name]).some(daySlots => daySlots.length > 0);
            const slotCount = hasSlots ? Object.values(studentTimeSlots[name]).reduce((total, daySlots) => total + daySlots.length, 0) : 0;
            
            return `<div class="student-db-item" style="border:none;border-bottom:1px solid #eef3f6;">
              <div class="student-info">
                <span class="student-name">${name}</span>
                <span class="major-badge">${m}</span>
                ${grade ? `<span class="grade-badge" style="background:#e67e22;color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:4px;">${formatGradeDisplay(grade)}</span>` : ''}
                ${hasSlots ? `<span class="slot-count-badge" style="background:#27ae60;color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:4px;">${slotCount}æ®µ</span>` : ''}
                <div class="time-slots-display" style="margin-top:6px;">
                  ${getStudentTimeSlotsDisplay(name)}
                </div>
              </div>
              <div class="student-actions">
                <button class="student-action-btn ${hasSlots?'edit-btn':'add-time-btn'}" onclick="manageStudentTimeSlots('${name}','${m}')" style="background:${hasSlots?'#3498db':'#27ae60'};">
                  ${hasSlots?'â° ç®¡ç†æ—¶é—´æ®µ':'â• æ·»åŠ æ—¶é—´æ®µ'}
                </button>
                <button class="student-action-btn edit-btn" onclick="editStudent('${name}','${m}')">ç¼–è¾‘</button>
                <button class="student-action-btn delete-btn" onclick="deleteStudent('${name}','${m}')">åˆ é™¤</button>
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
  });

  if(!html){
    if(q){
      html=`<div class="empty-database">æœªæ‰¾åˆ°åŒ¹é…ç»“æœï¼š${q}</div>`;
    }else{
      html='<div class="empty-database">æš‚æ— å­¦ç”Ÿ</div>';
    }
  }

  box.innerHTML = html;
  
  // ğŸ”¥ å¢å¼ºç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…å«å¹´çº§ç»Ÿè®¡
  const totalSlots = Object.values(studentTimeSlots).reduce((total, studentSlots) => {
    return total + Object.values(studentSlots).reduce((dayTotal, daySlots) => dayTotal + daySlots.length, 0);
  }, 0);
  
  // ç»Ÿè®¡å¹´çº§åˆ†å¸ƒ
  const gradeStats = {};
  let studentsWithGrade = 0;
  Object.values(studentDatabase).forEach(students => {
    students.forEach(s => {
      const grade = typeof s === 'object' ? (s.grade || '') : '';
      if (grade) {
        studentsWithGrade++;
        gradeStats[grade] = (gradeStats[grade] || 0) + 1;
      }
    });
  });
  
  const gradeStatsText = Object.keys(gradeStats).length > 0 
    ? `ï¼›å¹´çº§åˆ†å¸ƒï¼š${Object.entries(gradeStats).map(([grade, count]) => `${formatGradeDisplay(grade)}(${count})`).join('ï¼Œ')}`
    : '';
  
  $('studentDbStats').innerHTML = `å…±æœ‰ä¸“ä¸š ${majors.length} ä¸ªï¼›æ€»å­¦ç”Ÿ ${Object.values(studentDatabase).reduce((a,b)=>a+b.length,0)} äººï¼›å½“å‰æ˜¾ç¤º ${shownStudents} äººï¼›å·²è®¾ç½®æ—¶é—´æ®µ ${totalSlots} ä¸ªï¼›å·²è®¾ç½®å¹´çº§ ${studentsWithGrade} äºº${gradeStatsText}ã€‚`;
}


// æŠ˜å /å±•å¼€å‡½æ•°
function toggleMajorCollapse(major){
  const body = $('majorBody_'+major);
  const icon = $('majorCollapseIcon_'+major);
  if(!body) return;
  const collapsed = body.style.display === 'none';
  body.style.display = collapsed ? 'block' : 'none';
  if(icon){
    icon.textContent = collapsed ? 'æ”¶èµ· â–²' : 'å±•å¼€ â–¼';
  }
}

function filterByMajor(){
  // åªæ˜¯åŒ…è£…ä¸€ä¸‹ï¼Œåç»­è‹¥è¦åšé¢å¤–é€»è¾‘å¯åŠ è¿™é‡Œ
  renderStudentDatabaseList();
}

function getStudentTimeSlotsDisplay(name){
  const d = studentTimeSlots[name];
  if(!d) return '<span style="color:#e74c3c;font-size:12px;font-weight:700;">âš ï¸ æœªè®¾ç½®ç»ƒç´æ—¶é—´</span>';
  
  let totalSlots = 0;
  let displaySlots = [];
  const weekDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
  
  // ğŸ”¥ æŒ‰æ˜ŸæœŸé¡ºåºæ”¶é›†æ‰€æœ‰æ—¶é—´æ®µ
  weekDays.forEach(day => {
    const daySlots = d[day] || [];
    daySlots.forEach(slot => {
      totalSlots++;
      if(displaySlots.length < 3) { // æ˜¾ç¤ºå‰3ä¸ª
        displaySlots.push({
          day: WEEK_CN[day],
          slot: slot
        });
      }
    });
  });
  
  if(!totalSlots) return '<span style="color:#e74c3c;font-size:12px;font-weight:700;">âš ï¸ æœªè®¾ç½®ç»ƒç´æ—¶é—´</span>';
  
  // ğŸ”¥ ç”Ÿæˆæ˜¾ç¤ºå†…å®¹
  let html = displaySlots.map(item => 
    `<span class="time-slot-badge" title="${item.day} ${item.slot.start}-${item.slot.end} (${item.slot.duration})">${item.day} ${item.slot.start}-${item.slot.end}</span>`
  ).join('');
  
  if(totalSlots > 3) {
    html += `<span class="time-slot-badge more-slots" style="background:#3498db;color:#fff;cursor:pointer;" title="ç‚¹å‡»æŸ¥çœ‹å…¨éƒ¨${totalSlots}ä¸ªæ—¶é—´æ®µ" onclick="showStudentSlotsPreview('${name}')">+${totalSlots-3}ä¸ª</span>`;
  }
  
  // ğŸ”¥ æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
  html += `<div style="font-size:11px;color:#666;margin-top:4px;">å…±${totalSlots}ä¸ªæ—¶é—´æ®µï¼Œè¦†ç›–${Object.keys(d).filter(day => d[day] && d[day].length > 0).length}å¤©</div>`;
  
  return html;
}


/* ==== å­¦ç”Ÿåº“å¯¼å‡º / å¯¼å…¥ï¼ˆæ—¶é—´æ®µ CSV / JSON æ™ºèƒ½å¤„ç†ï¼‰ ==== */

/**
 * å¯¼å‡ºå­¦ç”Ÿåº“
 * æç¤ºé€‰æ‹©æ ¼å¼ï¼š1=CSV 2=JSON (é»˜è®¤ CSV)
 */
function exportStudentDatabase(){
  if(!Object.keys(studentDatabase).length){
    alert('å­¦ç”Ÿåº“ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');return;
  }
  const choice = prompt("é€‰æ‹©å¯¼å‡ºæ ¼å¼:\n1 CSV (é»˜è®¤)\n2 JSON","1") || "1";
  if(choice==="2"){
    exportStudentDatabaseJSON();
  }else{
    exportStudentDatabaseCSV();
  }
  logOperation('export_student_db',{format:choice==="2"?'json':'csv'});
}

/* CSV: å§“å,ä¸“ä¸š,å¹´çº§,å‘¨ä¸€,å‘¨äºŒ,å‘¨ä¸‰,å‘¨å››,å‘¨äº” */
function exportStudentDatabaseCSV(){
  const header = ['å§“å','ä¸“ä¸š','å¹´çº§','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”']; // ğŸ”¥ æ–°å¢å¹´çº§åˆ—
  const lines=[header.join(',')];
  const majors = Object.keys(studentDatabase).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));
  majors.forEach(major=>{
    studentDatabase[major].sort((a,b)=>getStudentName(a).localeCompare(getStudentName(b),'zh-Hans-CN')).forEach(studentRecord=>{
      const name = getStudentName(studentRecord);
      const grade = typeof studentRecord === 'object' ? (studentRecord.grade || '') : ''; // ğŸ”¥ æ–°å¢
      const slotObj = studentTimeSlots[name] || {};
      const dayCells = ['monday','tuesday','wednesday','thursday','friday'].map(day=>{
        const arr = slotObj[day]||[];
        return arr.map(s=>`${s.start}-${s.end}`).join(';');
      });
      lines.push([escapeCSV(name),escapeCSV(major),escapeCSV(grade),...dayCells.map(escapeCSV)].join(',')); // ğŸ”¥ æ–°å¢å¹´çº§
    });
  });
  const csv = '\uFEFF'+lines.join('\n'); // åŠ  BOM æ–¹ä¾¿ Excel
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='å­¦ç”Ÿåº“_'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
  showToast('å­¦ç”Ÿåº“ CSV å·²å¯¼å‡º');
}

function exportStudentDatabaseJSON(){
  const payload = {
    version:'student-db-v1',
    exportedAt:new Date().toISOString(),
    students:buildStudentExportJSON()
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='å­¦ç”Ÿåº“_'+new Date().toISOString().replace(/[:T]/g,'-').split('.')[0]+'.json';
  a.click();
  showToast('å­¦ç”Ÿåº“ JSON å·²å¯¼å‡º');
}

function buildStudentExportJSON(){
  const out=[];
  Object.keys(studentDatabase).forEach(major=>{
    studentDatabase[major].forEach(studentRecord=>{
      const name = getStudentName(studentRecord);
      const grade = typeof studentRecord === 'object' ? (studentRecord.grade || '') : ''; // ğŸ”¥ æ–°å¢
      out.push({
        name,
        major,
        grade, // ğŸ”¥ æ–°å¢å¹´çº§å­—æ®µ
        slots: studentTimeSlots[name] || {monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]}
      });
    });
  });
  return out;
}

/**
 * å¯¼å…¥å…¥å£
 */
function importStudentDatabase(evt){
  const file = evt.target.files[0];
  if(!file){return;}
  const name=file.name.toLowerCase();
  const isCSV = name.endsWith('.csv');
  const reader=new FileReader();
  reader.onload = e=>{
    let text=e.target.result;
    try{
      if(isCSV){
        handleStudentCSVImport(text);
      }else{
        handleStudentJSONImport(text);
      }
    }catch(err){
      console.error(err);
      alert('å¯¼å…¥å¤±è´¥: '+err.message);
    }finally{
      // é‡ç½® input ä»¥ä¾¿é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
      evt.target.value='';
    }
  };
  reader.readAsText(file,'utf-8');
}

/* === JSON å¯¼å…¥ === */
function handleStudentJSONImport(text){
  let data=JSON.parse(text);
  if(Array.isArray(data.students)){
    data = data.students;
  }else if(Array.isArray(data)){
    // ok
  }else if(data.version && data.students){
    data = data.students;
  }else{
    throw new Error('JSON ç»“æ„ä¸ç¬¦åˆ: æœŸå¾… {students:[...]} æˆ–æ•°ç»„');
  }
  const normalized = data.map(s=>({
    name: s.name?.trim(),
    major: (s.major && s.major.trim()) ? s.major.trim() : null,
    grade: parseGradeInput(s.grade || ''), // ğŸ”¥ æ–°å¢å¹´çº§å¤„ç†
    slots: normalizeStudentSlotsObject(s.slots||{})
  }));
  proceedStudentImport(normalized,'json');
}


function detectDelimiter(line){
  // ç»Ÿè®¡å€™é€‰åˆ†éš”ç¬¦å‡ºç°æ¬¡æ•°
  const candidates = [',',';','\t','ï¼Œ','|'];
  let best = ',', bestCount = -1;
  candidates.forEach(d=>{
    const c = line.split(d).length - 1;
    if(c > bestCount){ best = d; bestCount = c; }
  });
  return best;
}

function cleanHeaderCell(h){
  return h
    .replace(/\uFEFF/g,'')                 // BOM
    .replace(/[\u0000-\u001F]/g,'')        // æ§åˆ¶å­—ç¬¦(å« \u0000)
    .replace(/[\u200B-\u200F\u202A-\u202E\u2060\u2061]/g,'') // é›¶å®½/æ–¹å‘æ§åˆ¶
    .replace(/\u00A0/g,' ')                // ä¸é—´æ–­ç©ºæ ¼
    .replace(/\u3000/g,'')                 // å…¨è§’ç©ºæ ¼
    .trim()
    .toLowerCase();
}

/* === CSV å¯¼å…¥ === */
function handleStudentCSVImport(csvText){
  // å…ˆç§»é™¤æ•´ä½“ BOM
  if(csvText.charCodeAt(0)===0xFEFF){
    csvText = csvText.slice(1);
  }
  // å…¼å®¹ UTF-16 è¢«é”™è¯¯æŒ‰ UTF-8 è¯»å…¥å‡ºç°å¤§é‡ \u0000ï¼šå»æ‰å…¨éƒ¨ \u0000
  csvText = csvText.replace(/\u0000/g,'');
  // ç»Ÿä¸€æ¢è¡Œ
  csvText = csvText.replace(/\r/g,'');
  const rawLines = csvText.split('\n');
  // ä¸ç”¨ç®€å• trim è¿‡æ»¤æ‰€æœ‰è¡Œï¼Œå…ˆä¿ç•™ä»¥ä¾¿è°ƒè¯•
  // æ‰¾åˆ°ç¬¬ä¸€æ¡"éçº¯ç©ºç™½ä¸”å«éæ§åˆ¶å­—ç¬¦"ä½œä¸º header
  let headerIndex = -1;
  for(let i=0;i<rawLines.length;i++){
    const temp = rawLines[i].replace(/[\u0000-\u001F]/g,'').trim();
    if(temp){ headerIndex = i; break; }
  }
  if(headerIndex === -1) throw new Error('CSV ç©ºå†…å®¹');
  const headerLine = rawLines[headerIndex];
  const delimiter = detectDelimiter(headerLine);
  const headers = headerLine.split(delimiter);
  const map = mapCSVHeaders(headers);

  if(map.name == null){
    // Debug è¾“å‡º
    console.warn('[CSV å¯¼å…¥è°ƒè¯•] Headers åŸå§‹ï¼š', headers);
    console.warn('[CSV å¯¼å…¥è°ƒè¯•] Headers CharCodesï¼š', headers.map(h=>[...h].map(c=>c.charCodeAt(0).toString(16))));
    // æœ€ç»ˆä»æ—  -> å¼ºåˆ¶è®¾ä¸º 0ï¼Œé¿å…æŠ¥é”™ï¼ˆæœ€åçš„å…œåº•ï¼‰
    map.name = 0;
  }

  const records = [];
  for(let i=headerIndex+1;i<rawLines.length;i++){
    const raw = rawLines[i];
    if(!raw) continue;
    const cols = raw.split(delimiter);
    if(cols.length===1 && !cols[0].trim()) continue;

    let rawName = (cols[map.name]||'')
        .replace(/\uFEFF/g,'')
        .replace(/[\u0000-\u001F]/g,'')
        .replace(/[\u200B-\u200F\u202A-\u202E\u2060]/g,'')
        .trim();
    if(!rawName) continue;
    const name = rawName.replace(/\s{2,}/g,' ');

    // ä¸“ä¸š
    let majorCandidate = null;
    if(map.major != null){
      const mraw = (cols[map.major]||'').replace(/[\u0000-\u001F]/g,'').trim();
      if(mraw && !/^(æœªè®¾ç½®|null|none)$/i.test(mraw)) majorCandidate = mraw;
    }

    // ğŸ”¥ æ–°å¢ï¼šå¹´çº§å¤„ç†
    let gradeCandidate = '';
    if(map.grade != null){
      const graw = (cols[map.grade]||'').replace(/[\u0000-\u001F]/g,'').trim();
      if(graw && !/^(æœªè®¾ç½®|null|none)$/i.test(graw)) {
        gradeCandidate = parseGradeInput(graw);
      }
    }

    const slotObj={monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]};

    const weekdayColsPresent = ['monday','tuesday','wednesday','thursday','friday'].some(d=>map[d]!=null);
    if(weekdayColsPresent){
      ['monday','tuesday','wednesday','thursday','friday'].forEach(day=>{
        const idx=map[day];
        if(idx==null) return;
        const cell=(cols[idx]||'').trim();
        if(!cell || /æœªè®¾ç½®/i.test(cell)) return;
        parseSimpleDayCellToSlots(cell, slotObj[day]);
      });
    }
    if(map.aggregate != null){
      const aggCell = (cols[map.aggregate]||'').trim();
      if(aggCell && !/æœªè®¾ç½®/i.test(aggCell)){
        parseAggregateSlotsCell(aggCell, slotObj);
      }
    }
    Object.keys(slotObj).forEach(d=>{
      slotObj[d] = sanitizeSlotList(slotObj[d]);
    });

    records.push({name,major:majorCandidate,grade:gradeCandidate,slots:slotObj}); // ğŸ”¥ æ–°å¢å¹´çº§
  }

  proceedStudentImport(records,'csv');
}
function parseSimpleDayCellToSlots(cell, targetArr){
  if(!cell || !cell.trim()) return;
  
  // ğŸ”¥ æ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼šåˆ†å·ã€é€—å·ã€æ–œæ ã€æ¢è¡Œç­‰
  const parts = cell.split(/[\s;ï¼Œ,\/|ã€\n\r]+/).filter(Boolean);
  
  parts.forEach(seg=>{
    // ğŸ”¥ å¢å¼ºæ­£åˆ™ï¼šæ”¯æŒå•ä½æ•°å°æ—¶å’Œæ›´å¤šæ ¼å¼
    // æ”¯æŒæ ¼å¼ï¼š8:00-8:45, 08:00-08:45, 8:00-8:45, 8-9ç­‰
    const timeMatch = seg.match(/^(\d{1,2}):?(\d{0,2})\s*[-~è‡³åˆ°]\s*(\d{1,2}):?(\d{0,2})$/);
    
    if(timeMatch){
      let [, startH, startM, endH, endM] = timeMatch;
      
      // å¤„ç†çœç•¥åˆ†é’Ÿçš„æƒ…å†µï¼ˆå¦‚ 8-9ï¼‰
      startM = startM || '00';
      endM = endM || '00';
      
      // è¡¥é›¶
      const start = `${startH.padStart(2,'0')}:${startM.padStart(2,'0')}`;
      const end = `${endH.padStart(2,'0')}:${endM.padStart(2,'0')}`;
      
      if(isValidSlotFormat(start, end, true)){
        targetArr.push({
          start: start,
          end: end,
          duration: calcDurationText(start, end)
        });
      }
    } else {
      // ğŸ”¥ å°è¯•å…¶ä»–æ ¼å¼è§£æ
      const altMatch = seg.match(/^(\d{1,2})[:ï¼š](\d{2})\s*[-~è‡³åˆ°]\s*(\d{1,2})[:ï¼š](\d{2})$/);
      if(altMatch){
        const [, startH, startM, endH, endM] = altMatch;
        const start = `${startH.padStart(2,'0')}:${startM}`;
        const end = `${endH.padStart(2,'0')}:${endM}`;
        
        if(isValidSlotFormat(start, end, true)){
          targetArr.push({
            start: start,
            end: end,
            duration: calcDurationText(start, end)
          });
        }
      }
    }
  });
}




// è§£æç±»ä¼¼ï¼š å‘¨ä¸€:08:00-10:00;å‘¨ä¸€:13:00-15:00;å‘¨äºŒ:09:00-10:00 ...
function parseAggregateSlotsCell(cell, slotObj){
  if(!cell || !cell.trim()) return;
  
  // ç»Ÿä¸€åˆ†éš”ç¬¦å¤„ç†
  const pieces = cell.split(/[\s;ï¼Œ,\/|ã€\n\r]+/).filter(Boolean);
  
  pieces.forEach(p=>{
    // ğŸ”¥ æ”¯æŒæ›´å¤šæ ¼å¼ï¼š
    // "å‘¨ä¸€:08:00-09:00", "æ˜ŸæœŸä¸€:08:00-09:00", "å‘¨ä¸€ 08:00-09:00"
    // "Monday:08:00-09:00", "å‘¨ä¸€08:00-09:00"
    const dayTimeMatch = p.match(/^(å‘¨|æ˜ŸæœŸ)?(ä¸€|äºŒ|ä¸‰|å››|äº”|Monday|Tuesday|Wednesday|Thursday|Friday|Mon|Tue|Wed|Thu|Fri)\s*[:ï¼š]?\s*(\d{1,2}):?(\d{0,2})\s*[-~è‡³åˆ°]\s*(\d{1,2}):?(\d{0,2})$/i);
    
    if(dayTimeMatch){
      let [, prefix, dayPart, startH, startM, endH, endM] = dayTimeMatch;
      
      // å¤„ç†è‹±æ–‡æ˜ŸæœŸ
      const dayMap = {
        'ä¸€': 'monday', 'äºŒ': 'tuesday', 'ä¸‰': 'wednesday', 'å››': 'thursday', 'äº”': 'friday',
        'monday': 'monday', 'tuesday': 'tuesday', 'wednesday': 'wednesday', 'thursday': 'thursday', 'friday': 'friday',
        'mon': 'monday', 'tue': 'tuesday', 'wed': 'wednesday', 'thu': 'thursday', 'fri': 'friday'
      };
      
      const dayKey = dayMap[dayPart.toLowerCase()];
      if(!dayKey) return;
      
      // å¤„ç†çœç•¥åˆ†é’Ÿ
      startM = startM || '00';
      endM = endM || '00';
      
      const start = `${startH.padStart(2,'0')}:${startM.padStart(2,'0')}`;
      const end = `${endH.padStart(2,'0')}:${endM.padStart(2,'0')}`;
      
      if(isValidSlotFormat(start, end, true)){
        slotObj[dayKey].push({
          start: start,
          end: end,
          duration: calcDurationText(start, end)
        });
      }
    }
  });
}


/* === å¤´éƒ¨æ˜ å°„ï¼šå…¼å®¹å¤šè¯­è¨€/åˆ«å === */
function mapCSVHeaders(headers){
  const map = {};
  headers.forEach((raw,i)=>{
    const key = cleanHeaderCell(raw);
    
    // åŸºç¡€å­—æ®µæ˜ å°„
    if(/^(å§“å|å­¦ç”Ÿ|name|student)$/.test(key)) map.name = i;
    else if(/^(ä¸“ä¸š|major|department)$/.test(key)) map.major = i;
    else if(/^(å¹´çº§|grade|level|class)$/.test(key)) map.grade = i; // ğŸ”¥ æ–°å¢å¹´çº§æ˜ å°„
    
    // ğŸ”¥ å¢å¼ºæ˜ŸæœŸæ˜ å°„ - æ”¯æŒæ›´å¤šæ ¼å¼
    else if(/^(å‘¨ä¸€|æ˜ŸæœŸä¸€|monday|mon|week1|w1)$/.test(key)) map.monday = i;
    else if(/^(å‘¨äºŒ|æ˜ŸæœŸäºŒ|tuesday|tue|week2|w2)$/.test(key)) map.tuesday = i;
    else if(/^(å‘¨ä¸‰|æ˜ŸæœŸä¸‰|wednesday|wed|week3|w3)$/.test(key)) map.wednesday = i;
    else if(/^(å‘¨å››|æ˜ŸæœŸå››|thursday|thu|week4|w4)$/.test(key)) map.thursday = i;
    else if(/^(å‘¨äº”|æ˜ŸæœŸäº”|friday|fri|week5|w5)$/.test(key)) map.friday = i;
    
    // ğŸ”¥ èšåˆæ—¶é—´æ®µåˆ—æ˜ å°„
    else if(/^(ç»ƒç´æ—¶é—´æ®µ|æ—¶é—´æ®µ|æ—¶é—´å®‰æ’|schedule|slots|timetable|å…¨éƒ¨æ—¶é—´|æ‰€æœ‰æ—¶é—´)$/.test(key)) map.aggregate = i;
    
    // ğŸ”¥ å…¶ä»–å¯èƒ½çš„æ—¶é—´ç›¸å…³åˆ—
    else if(/æ—¶é—´|time|slot/.test(key) && !/^(å‘¨|æ˜ŸæœŸ|monday|tuesday|wednesday|thursday|friday)/.test(key)) {
      map.aggregate = i; // ä½œä¸ºèšåˆåˆ—å¤„ç†
    }
  });
  
  // ğŸ”¥ Fallbacké€»è¾‘å¢å¼º
  if(map.name == null){
    // å°è¯•åŸºäºå†…å®¹å’Œä½ç½®åˆ¤æ–­
    const first = headers[0] || '';
    const cleanedFirst = cleanHeaderCell(first);
    if(/å§“|å|student/.test(cleanedFirst) || /^[a-z]*name$/.test(cleanedFirst) || /^[\u4e00-\u9fa5]{1,6}$/.test(cleanedFirst)){
      map.name = 0;
    }
  }
  
  return map;
}


/* æ‹† CSV è¡Œï¼ˆç®€å•é€—å·æ‹†åˆ† + å¤„ç†å¼•å·ï¼‰ */
function splitCSVRow(line, expectedLen){
  const out=[];
  let current='',inQuotes=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){
      if(inQuotes && line[i+1]==='"'){ // åŒå¼•å·è½¬ä¹‰
        current+='"'; i++;
      }else{
        inQuotes=!inQuotes;
      }
    }else if(ch===',' && !inQuotes){
      out.push(current); current='';
    }else{
      current+=ch;
    }
  }
  out.push(current);
  // é•¿åº¦ä¸è¶³è¡¥ç©º
  while(out.length<expectedLen) out.push('');
  return out;
}

function isValidSlotFormat(start,end,isImporting=false){
  try{
    if(!/^\d{1,2}:\d{2}$/.test(start) || !/^\d{1,2}:\d{2}$/.test(end)) return false;
    const s=timeToMinutes(start), e=timeToMinutes(end);
    if(isNaN(s)||isNaN(e)) return false;
    if(s<0 || e>1440) return false;
    if(e<=s) return false;
    
    // ğŸ”¥ ä¿®å¤ï¼šæ£€æŸ¥åˆ†é’Ÿæ˜¯å¦ä¸º10çš„å€æ•°ï¼ˆä»…åœ¨æ‰‹åŠ¨æ·»åŠ æ—¶é™åˆ¶ï¼‰
    // å¯¼å…¥æ—¶å…è®¸ä»»ä½•åˆ†é’Ÿå€¼
    if (!isImporting) {
      const startParts = start.split(':');
      const endParts = end.split(':');
      const startMin = parseInt(startParts[1]);
      const endMin = parseInt(endParts[1]);
      
      if (startMin % 10 !== 0 || endMin % 10 !== 0) {
        return false; // æ‰‹åŠ¨æ·»åŠ æ—¶å¿…é¡»æ˜¯10çš„å€æ•°
      }
    }
    
    return true;
  }catch{return false;}
}



/* æ¸…ç†é‡å ä¸æ’åº */
function sanitizeSlotList(list){
  if(!list.length) return [];
  // å…ˆè§„èŒƒå¯¹è±¡
  list=list.map(s=>({start:s.start,end:s.end,duration:calcDurationText(s.start,s.end)}));
  list.sort((a,b)=>a.start.localeCompare(b.start));
  const result=[];
  list.forEach(s=>{
    if(!result.length){
      result.push(s);return;
    }
    const last=result[result.length-1];
    const ls=timeToMinutes(last.start), le=timeToMinutes(last.end);
    const cs=timeToMinutes(s.start),   ce=timeToMinutes(s.end);
    if(cs<le){ 
      // é‡å ï¼šè·³è¿‡ï¼ˆå¯æ‰©å±•ä¸ºåˆå¹¶ï¼šå– max ç»“æŸï¼‰
      // è‹¥éœ€åˆå¹¶æŠŠ le è°ƒæˆ max(le,ce) å¹¶æ›´æ–° last.end / duration
      // è¿™é‡Œç»´æŒ"è·³è¿‡"ç­–ç•¥
      return;
    }
    result.push(s);
  });
  return result;
}

/* æ ‡å‡†åŒ– JSON slots å¯¹è±¡ */
function normalizeStudentSlotsObject(slots){
  const out={monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]};
  Object.keys(out).forEach(day=>{
    const arr=Array.isArray(slots[day])?slots[day]:[];
    out[day]=sanitizeSlotList(arr.filter(s=>s.start && s.end && isValidSlotFormat(s.start,s.end,true))); // ğŸ”¥ ä¿®æ”¹ï¼šå¯¼å…¥æ—¶å…è®¸ä»»æ„åˆ†é’Ÿ
  });
  return out;
}


/**
 * ç»Ÿä¸€å¯¼å…¥å¤„ç†
 * records: [{name,major,grade,slots:{monday:[],...}}]
 * source: 'csv'|'json'
 */
function proceedStudentImport(records,source){
  if(!records.length){
    alert('æ— æœ‰æ•ˆæ•°æ®');return;
  }
  const strategy = prompt("é€‰æ‹©å¯¼å…¥ç­–ç•¥:\n1 åˆå¹¶è¿½åŠ (é»˜è®¤)\n2 è¦†ç›–åŒåå­¦ç”Ÿæ—¶é—´æ®µ\n3 ä»…æ–°å¢å­¦ç”Ÿ\n4 å…¨é‡é‡ç½®(æ¸…ç©ºåå¯¼å…¥)","1") || "1";
  if(!/^[1-4]$/.test(strategy)){alert('å–æ¶ˆå¯¼å…¥');return;}

  const summary={
    source,
    strategy,
    totalInput:records.length,
    newStudents:0,
    updatedStudents:0,
    skippedExisting:0,
    newMajors:0,
    newSlots:0,
    gradesUpdated:0, // ğŸ”¥ æ–°å¢å¹´çº§æ›´æ–°ç»Ÿè®¡
    majorUpdated:0   // ğŸ”¥ æ–°å¢ä¸“ä¸šæ›´æ–°ç»Ÿè®¡
  };

  if(strategy==="4"){
    // å®Œå…¨æ¸…ç©ºï¼ˆä¿ç•™ç³»ç»Ÿå…¶ä»–æ•°æ®ï¼‰
    studentDatabase={};
    studentTimeSlots={};
    // ğŸ”¥ ç«‹å³æŒä¹…åŒ–æ¸…ç©ºæ“ä½œ
    persistStudents();
    persistStudentSlots();
  }
  const existingMajors = new Set(Object.keys(studentDatabase));

  records.forEach(rec=>{
    const {name,major,grade,slots}=rec; // ğŸ”¥ æ–°å¢gradeè§£æ„
    if(!name) return;

    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šæ”¹è¿›å­¦ç”ŸæŸ¥æ‰¾é€»è¾‘ï¼ŒåŒæ—¶è®°å½•å­¦ç”Ÿæ‰€åœ¨çš„ä¸“ä¸š
    let hasStudent = false;
    let existingMajorOfStudent = null;
    let existingStudentRecord = null;
    let studentIndex = -1;
    
    for(const [m,arr] of Object.entries(studentDatabase)){
      const foundIndex = arr.findIndex(s=>getStudentName(s)===name);
      if(foundIndex !== -1){ 
        hasStudent=true; 
        existingMajorOfStudent=m; 
        existingStudentRecord=arr[foundIndex];
        studentIndex = foundIndex;
        break; 
      }
    }

    // å†³å®š targetMajorï¼š
    // 1) å¦‚æœå¯¼å…¥æœ‰æ˜ç¡® majorï¼ˆé nullï¼‰ï¼Œå°±ç”¨å¯¼å…¥çš„
    // 2) å¦åˆ™å¦‚æœå­¦ç”Ÿå·²å­˜åœ¨ï¼Œç”¨å…¶åŸä¸“ä¸š
    // 3) å¦åˆ™ç”¨ 'å…¶ä»–'
    let targetMajor;
    if(major){ 
      targetMajor = major;
    }else if(hasStudent){
      targetMajor = existingMajorOfStudent;
    }else{
      targetMajor = 'å…¶ä»–';
    }

    // å¦‚æœè¯¥ä¸“ä¸šä¸å­˜åœ¨åˆ™åˆ›å»º
    if(!studentDatabase[targetMajor]){
      studentDatabase[targetMajor]=[];
      // å¦‚æœæ˜¯"æ²¿ç”¨æ—§ä¸“ä¸š"åˆ™ä¸ä¼šèµ°åˆ°åˆ›å»ºï¼›åªæœ‰çœŸæ­£æ–°å»ºæ‰è®¡æ•°
      if(!existingMajors.has(targetMajor)) {
        summary.newMajors++;
      }
    }

    if(!hasStudent){
      // æ–°å­¦ç”Ÿ - ğŸ”¥ ä½¿ç”¨å¯¹è±¡æ ¼å¼æ”¯æŒå¹´çº§
      studentDatabase[targetMajor].push({
        name: name,
        grade: grade || ''
      });
      summary.newStudents++;
      studentTimeSlots[name]=slots;
      summary.newSlots += countSlots(slots);
      if(grade) summary.gradesUpdated++; // ğŸ”¥ æ–°å¢
    }else{
      // å·²å­˜åœ¨å­¦ç”Ÿ
      if(strategy==="3"){ // ä»…æ–°å¢
        summary.skippedExisting++;
        return;
      }
      
      // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šå¤„ç†ä¸“ä¸šå˜æ›´
      let needsMajorUpdate = false;
      if(major && targetMajor !== existingMajorOfStudent) {
        // éœ€è¦å°†å­¦ç”Ÿä»åŸä¸“ä¸šç§»åŠ¨åˆ°æ–°ä¸“ä¸š
        needsMajorUpdate = true;
        
        // ä»åŸä¸“ä¸šä¸­ç§»é™¤
        studentDatabase[existingMajorOfStudent].splice(studentIndex, 1);
        
        // å¦‚æœåŸä¸“ä¸šå˜ç©ºï¼Œåˆ é™¤å®ƒ
        if(studentDatabase[existingMajorOfStudent].length === 0) {
          delete studentDatabase[existingMajorOfStudent];
        }
        
        // æ·»åŠ åˆ°æ–°ä¸“ä¸šï¼ˆä½¿ç”¨ç°æœ‰çš„å­¦ç”Ÿè®°å½•ç»“æ„ï¼‰
        const updatedRecord = typeof existingStudentRecord === 'string' 
          ? { name: name, grade: grade || '' }
          : { ...existingStudentRecord, grade: grade || existingStudentRecord.grade || '' };
        
        studentDatabase[targetMajor].push(updatedRecord);
        summary.majorUpdated++;
        
        // æ›´æ–°å¼•ç”¨
        existingStudentRecord = updatedRecord;
      }
      
      // ğŸ”¥ å¤„ç†å¹´çº§æ›´æ–°ï¼ˆæ— è®ºæ˜¯å¦æ›´æ¢ä¸“ä¸šï¼‰
      if(grade) {
        if(typeof existingStudentRecord === 'string') {
          // å¦‚æœæ²¡æœ‰æ›´æ¢ä¸“ä¸šï¼Œéœ€è¦å‡çº§å­—ç¬¦ä¸²æ ¼å¼ä¸ºå¯¹è±¡æ ¼å¼
          if(!needsMajorUpdate) {
            const index = studentDatabase[existingMajorOfStudent].indexOf(existingStudentRecord);
            studentDatabase[existingMajorOfStudent][index] = {
              name: name,
              grade: grade
            };
          }
          summary.gradesUpdated++;
        } else if(typeof existingStudentRecord === 'object') {
          // æ›´æ–°å¹´çº§
          if(existingStudentRecord.grade !== grade) {
            existingStudentRecord.grade = grade;
            summary.gradesUpdated++;
          }
        }
      }
      
      // ğŸ”¥ å¤„ç†æ—¶é—´æ®µæ›´æ–°
      if(strategy==="2"){ // è¦†ç›–æ—¶é—´æ®µ
        studentTimeSlots[name]=slots;
        summary.updatedStudents++;
        summary.newSlots += countSlots(slots);
      }else if(strategy==="1"){ // åˆå¹¶
        initStudentSlotStructure(name);
        const before=countSlots(studentTimeSlots[name]);
        mergeSlots(studentTimeSlots[name],slots);
        const after=countSlots(studentTimeSlots[name]);
        if(after>before || needsMajorUpdate){
          summary.updatedStudents++;
          summary.newSlots += (after-before);
        }else if(!needsMajorUpdate){
          summary.skippedExisting++;
        }
      } else {
        // å³ä½¿ä¸æ›´æ–°æ—¶é—´æ®µï¼Œå¦‚æœæ›´æ–°äº†ä¸“ä¸šæˆ–å¹´çº§ï¼Œä¹Ÿç®—ä½œæ›´æ–°
        if(needsMajorUpdate || (grade && summary.gradesUpdated > 0)) {
          summary.updatedStudents++;
        } else {
          summary.skippedExisting++;
        }
      }
    }
  });

  persistStudents();
  persistStudentSlots();

  // åˆ·æ–° UI
  populateMajorFilter();
  populateGradeFilter(); // ğŸ”¥ æ–°å¢
  renderStudentDatabaseList();
  cleanupEmptyMajors();
  refreshAllMajorSelectors();

  showStudentImportSummary(summary);
  logOperation('import_student_db',summary);
}


function countSlots(slotObj){
  return Object.values(slotObj).reduce((a,b)=>a+b.length,0);
}

/* åˆå¹¶è¿½åŠ ï¼šä»…è¿½åŠ ä¸ä¸ç°æœ‰å†²çªçš„æ—¶é—´æ®µ */
function mergeSlots(baseSlots, newSlots){
  Object.keys(baseSlots).forEach(day=>{
    const existing = baseSlots[day];
    const incoming = newSlots[day]||[];
    if(!incoming.length) return;
    incoming.forEach(ns=>{
      // åˆ¤æ–­ä¸ existing å†²çª
      const nsStart=timeToMinutes(ns.start), nsEnd=timeToMinutes(ns.end);
      const conflict = existing.some(es=>{
        const esStart=timeToMinutes(es.start), esEnd=timeToMinutes(es.end);
        return nsStart<esEnd && nsEnd>esStart;
      });
      if(!conflict){
        existing.push({...ns});
      }
    });
    existing.sort((a,b)=>a.start.localeCompare(b.start));
  });
}

/* å¯¼å…¥ç»“æœå±•ç¤º */
/* å¯¼å…¥ç»“æœå±•ç¤º */
function showStudentImportSummary(sum){
  const details = [];
  
  if(sum.newStudents > 0) details.push(`âœ… æ–°å¢å­¦ç”Ÿ: ${sum.newStudents}äºº`);
  if(sum.updatedStudents > 0) details.push(`ğŸ”„ æ›´æ–°å­¦ç”Ÿ: ${sum.updatedStudents}äºº`);
  if(sum.skippedExisting > 0) details.push(`â­ï¸ è·³è¿‡é‡å¤: ${sum.skippedExisting}äºº`);
  if(sum.newMajors > 0) details.push(`ğŸ†• æ–°å»ºä¸“ä¸š: ${sum.newMajors}ä¸ª`);
  if(sum.majorUpdated > 0) details.push(`ğŸ”„ æ›´æ–°ä¸“ä¸š: ${sum.majorUpdated}äºº`); // ğŸ”¥ æ–°å¢
  if(sum.newSlots > 0) details.push(`â° æ–°å¢æ—¶é—´æ®µ: ${sum.newSlots}ä¸ª`);
  if(sum.gradesUpdated > 0) details.push(`ğŸ“ æ›´æ–°å¹´çº§: ${sum.gradesUpdated}äºº`); // ğŸ”¥ æ–°å¢
  
  const msg = [
    'ğŸ“Š å¯¼å…¥å®Œæˆç»Ÿè®¡',
    '',
    `ğŸ“ æ¥æºæ ¼å¼: ${sum.source.toUpperCase()}`,
    `ğŸ”§ å¯¼å…¥ç­–ç•¥: ${({'1':'åˆå¹¶è¿½åŠ ','2':'è¦†ç›–æ—¶é—´æ®µ','3':'ä»…æ–°å¢','4':'å…¨é‡é‡ç½®'})[sum.strategy]}`,
    `ğŸ“ è¾“å…¥è®°å½•: ${sum.totalInput}æ¡`,
    '',
    ...details,
    '',
    'ğŸ‰ æ‰€æœ‰æ•°æ®å·²æˆåŠŸå¯¼å…¥å¹¶ä¿å­˜ï¼'
  ].join('\n');
  
  alert(msg);
  showToast('âœ… å­¦ç”Ÿåº“å¯¼å…¥å®Œæˆ', 3000);
}


function addNewStudentToDatabase(){
  const name=prompt('å­¦ç”Ÿå§“åï¼š').trim();
  if(!name) return;
  if(Object.values(studentDatabase).some(a=>a.includes(name))){alert('å·²å­˜åœ¨');return;}
  window.pendingStudentName=name;
  $('majorSelectionModal').style.display='block';
  renderMajorSelectionButtons();
}
function renderMajorSelectionButtons(){
  const box=$('majorButtonsList');
  const majors=Object.keys(studentDatabase).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));
  box.innerHTML=majors.map(m=>`<button class="major-btn" style="background:var(--primary-color);" onclick="selectExistingMajor('${m}')">${m} (${studentDatabase[m].length})</button>`).join('')||
    '<div style="color:#999;font-style:italic;">æš‚æ— ä¸“ä¸š</div>';
}
function selectExistingMajor(m){ finalizeAddStudent(m); }
function createNewMajor(){
  const m=$('newMajorInput').value.trim(); if(!m){alert('è¯·è¾“å…¥');return;}
  if(studentDatabase[m]){alert('å·²å­˜åœ¨');return;}
  finalizeAddStudent(m);
}
function finalizeAddStudent(major){
  const name=window.pendingStudentName;
  if(!studentDatabase[major]) studentDatabase[major]=[];
  
  // ğŸ”¥ ä¿®æ”¹ï¼šä½¿ç”¨å¯¹è±¡æ ¼å¼æ·»åŠ å­¦ç”Ÿï¼Œæ”¯æŒå¹´çº§
  studentDatabase[major].push({
    name: name,
    grade: '' // é»˜è®¤ç©ºå¹´çº§ï¼Œç”¨æˆ·å¯åç»­ç¼–è¾‘
  });
  
  persistStudents();
  showToast(`å·²æ·»åŠ  ${name} åˆ° ${major}`);
  $('majorSelectionModal').style.display='none';
  window.pendingStudentName=null;
  renderStudentDatabaseList();
  refreshAllMajorSelectors();
  populateGradeFilter(); // ğŸ”¥ æ–°å¢
  cleanupEmptyMajors();
  
  // è®©æ–°å­¦ç”Ÿä¸€å®šå¯è§ï¼šå¦‚æœå½“å‰æœç´¢æ¡†æœ‰å€¼ä¸”ä¸åŒ¹é…ï¼Œæ¸…ç©ºæœç´¢åå†åˆ·æ–°
  const q = $('studentDbSearch').value.trim();
  if(q && !matchPinyin(name, q)){
    $('studentDbSearch').value='';
    renderStudentDatabaseList();
  }
}


function closeMajorSelectionModal(){
  $('majorSelectionModal').style.display='none';
  window.pendingStudentName=null;
}
// ğŸ”¥ æ–°å¢ï¼šå¹´çº§ç­›é€‰å‡½æ•°
function filterByGrade(){
  renderStudentDatabaseList();
}
let editingStudent=null;
function editStudent(name,major){
  editingStudent={oldName:name,oldMajor:major};
  $('editStudentName').value=name;
  
  // å¡«å……ä¸“ä¸šé€‰æ‹©å™¨
  const sel=$('editStudentMajor');
  const existingMajors = Object.keys(studentDatabase).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));
  
  // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šæ·»åŠ "æ·»åŠ æ–°ä¸“ä¸š"é€‰é¡¹
  let optionsHTML = existingMajors.map(m=>`<option value="${m}" ${m===major?'selected':''}>${m}</option>`).join('');
  optionsHTML += '<option value="__ADD_NEW__">+ æ·»åŠ æ–°ä¸“ä¸š</option>';
  sel.innerHTML = optionsHTML;
  
  // ğŸ”¥ æ–°å¢ï¼šç›‘å¬ä¸“ä¸šé€‰æ‹©å˜åŒ–
  sel.addEventListener('change', handleMajorSelectionChange);
  
  // ğŸ”¥ æ–°å¢ï¼šå¡«å……å¹´çº§ä¿¡æ¯
  const studentInfo = getStudentInfo(name);
  $('editStudentGrade').value = studentInfo.grade || '';
  
  $('editStudentModal').style.display='block';
}
function handleMajorSelectionChange(event) {
  const selectedValue = event.target.value;
  
  if (selectedValue === '__ADD_NEW__') {
    const newMajor = prompt('è¯·è¾“å…¥æ–°ä¸“ä¸šåç§°ï¼š');
    
    if (newMajor && newMajor.trim()) {
      const majorName = newMajor.trim();
      
      // æ£€æŸ¥ä¸“ä¸šæ˜¯å¦å·²å­˜åœ¨
      if (studentDatabase[majorName]) {
        alert('è¯¥ä¸“ä¸šå·²å­˜åœ¨');
        // é‡æ–°é€‰æ‹©å·²å­˜åœ¨çš„ä¸“ä¸š
        event.target.value = majorName;
        return;
      }
      
      // åˆ›å»ºæ–°ä¸“ä¸š
      studentDatabase[majorName] = [];
      persistStudents();
      
      // é‡æ–°å¡«å……é€‰æ‹©å™¨å¹¶é€‰ä¸­æ–°ä¸“ä¸š
      const sel = event.target;
      const existingMajors = Object.keys(studentDatabase).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));
      let optionsHTML = existingMajors.map(m=>`<option value="${m}" ${m===majorName?'selected':''}>${m}</option>`).join('');
      optionsHTML += '<option value="__ADD_NEW__">+ æ·»åŠ æ–°ä¸“ä¸š</option>';
      sel.innerHTML = optionsHTML;
      sel.value = majorName;
      
      showToast(`æ–°ä¸“ä¸š"${majorName}"å·²åˆ›å»º`);
      
      // åˆ·æ–°ç›¸å…³UI
      refreshAllMajorSelectors();
      
    } else {
      // ç”¨æˆ·å–æ¶ˆæˆ–è¾“å…¥ä¸ºç©ºï¼Œæ¢å¤åˆ°åŸæ¥çš„é€‰æ‹©
      const editingStudent = window.editingStudent;
      if (editingStudent) {
        event.target.value = editingStudent.oldMajor;
      } else {
        // å›é€€åˆ°ç¬¬ä¸€ä¸ªé€‰é¡¹
        event.target.selectedIndex = 0;
      }
    }
  }
}

function closeEditStudentModal(){ 
  $('editStudentModal').style.display='none'; 
  
  // ğŸ”¥ æ–°å¢ï¼šæ¸…ç†äº‹ä»¶ç›‘å¬å™¨
  const sel = $('editStudentMajor');
  if (sel) {
    sel.removeEventListener('change', handleMajorSelectionChange);
  }
  
  editingStudent=null; 
}

function saveStudentChanges(){
  if(!editingStudent) return;
  const newName=$('editStudentName').value.trim();
  const newMajor=$('editStudentMajor').value;
  const newGrade=parseGradeInput($('editStudentGrade').value.trim()); // ğŸ”¥ æ–°å¢
  
  if(!newName){alert('å§“åå¿…å¡«');return;}
  if(newName!==editingStudent.oldName && Object.values(studentDatabase).some(a=>a.some(s=>getStudentName(s)===newName))){
    alert('è¯¥å§“åå·²å­˜åœ¨');return;
  }
  
  // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå…ˆä¿å­˜æ—¶é—´æ®µæ•°æ®ï¼Œå†è¿›è¡Œè¿ç§»
  const oldTimeSlots = studentTimeSlots[editingStudent.oldName];
  
  // ç§»é™¤æ—§è®°å½•
  const arr=studentDatabase[editingStudent.oldMajor];
  const idx=arr.findIndex(s=>getStudentName(s)===editingStudent.oldName);
  if(idx>-1) arr.splice(idx,1);
  if(!arr.length) delete studentDatabase[editingStudent.oldMajor];
  
  // æ·»åŠ æ–°è®°å½•ï¼ˆä½¿ç”¨å¯¹è±¡æ ¼å¼æ”¯æŒå¹´çº§ï¼‰
  if(!studentDatabase[newMajor]) studentDatabase[newMajor]=[];
  const existingIndex = studentDatabase[newMajor].findIndex(s=>getStudentName(s)===newName);
  if(existingIndex === -1) {
    studentDatabase[newMajor].push({
      name: newName,
      grade: newGrade
    });
  } else {
    // æ›´æ–°ç°æœ‰è®°å½•
    if (typeof studentDatabase[newMajor][existingIndex] === 'string') {
      studentDatabase[newMajor][existingIndex] = {
        name: newName,
        grade: newGrade
      };
    } else {
      studentDatabase[newMajor][existingIndex].grade = newGrade;
    }
  }
  
  // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ­£ç¡®è¿ç§»æ—¶é—´æ®µæ•°æ®
  if(oldTimeSlots && editingStudent.oldName !== newName){
    // å¦‚æœå­¦ç”Ÿå§“åå‘ç”Ÿå˜åŒ–ï¼Œè¿ç§»æ—¶é—´æ®µæ•°æ®
    studentTimeSlots[newName] = oldTimeSlots;
    delete studentTimeSlots[editingStudent.oldName];
  }
  
  persistStudents();persistStudentSlots();
  editingStudent=null;
  closeEditStudentModal();
  renderStudentDatabaseList();
  cleanupEmptyMajors();
  refreshAllMajorSelectors();
  populateMajorFilter();
  populateGradeFilter(); // ğŸ”¥ æ–°å¢
  showToast('å·²ä¿å­˜');
}
function deleteStudent(name,major){
  if(!confirm(`åˆ é™¤å­¦ç”Ÿ ${name}?`))return;
  studentDatabase[major]=studentDatabase[major].filter(s=>getStudentName(s)!==name);
  if(!studentDatabase[major].length) delete studentDatabase[major];
  if(studentTimeSlots[name]) delete studentTimeSlots[name];
  rooms.forEach(r=>{
    if(r.student===name){
      addPracticeLog(name,r.name,r.registerTime,Date.now(),'å­¦ç”Ÿåˆ é™¤');
      r.student=null;r.registerTime=null;
    }
  });
  ['grand','upright','none'].forEach(t=>queueList[t]=queueList[t].filter(s=>s!==name));
  persistStudents();persistStudentSlots();persistQueues();persistRooms();
  renderStudentDatabaseList();
  updateRooms();
  showToast('å­¦ç”Ÿå·²åˆ é™¤');
  cleanupEmptyMajors();
  refreshAllMajorSelectors();
  populateGradeFilter(); // ğŸ”¥ æ–°å¢
}
function closeStudentDatabaseModal(){ $('studentDatabaseModal').style.display='none'; }

/* =============== 7. æ’é˜Ÿç³»ç»Ÿ =============== */
function validateQueueAdd(student,type){
  if(queueList[type].includes(student)) return {ok:false,reason:'å·²åœ¨è¯¥é˜Ÿåˆ—'};
  for(const t of ['grand','upright','none']) if(t!==type && queueList[t].includes(student)) return {ok:false,reason:'å·²åœ¨å…¶ä»–é˜Ÿåˆ—'};
  if(rooms.some(r=>r.student===student)) return {ok:false,reason:'æ­£åœ¨ç»ƒç´'};
  return {ok:true};
}
function showQueueStudentModal(type){
  currentQueueType=type;
  $('queueStudentSearch').value='';
  searchQueueStudents('');
  $('queueStudentModal').style.display='block';
  
  // åˆå§‹åŒ–è¾“å…¥å¤„ç†å™¨å¹¶èšç„¦
  setTimeout(() => {
    if (!inputHandlers.has('queueStudentSearch')) {
      const handler = new SmartInputHandler('queueStudentSearch', searchQueueStudents);
      inputHandlers.set('queueStudentSearch', handler);
    }
    
    const searchInput = $('queueStudentSearch');
    if (searchInput) {
      searchInput.focus();
    }
  }, 50);
}

function manageStudentDatabase(){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  
  const searchInput = $('studentDbSearch');
  const majorSel = $('majorFilter');
  const gradeSel = $('gradeFilter'); // ğŸ”¥ æ–°å¢å¹´çº§ç­›é€‰å™¨
  if(searchInput) searchInput.value = '';
  if(majorSel) majorSel.value = '';
  if(gradeSel) gradeSel.value = ''; // ğŸ”¥ æ–°å¢

  populateMajorFilter();
  populateGradeFilter(); // ğŸ”¥ æ–°å¢
  if(majorSel && ![...majorSel.options].some(o=>o.value===majorSel.value)){
    majorSel.value = '';
  }
  renderStudentDatabaseList();
  $('studentDatabaseModal').style.display='block';
  injectStudentDbHint();
  
  // åˆå§‹åŒ–è¾“å…¥å¤„ç†å™¨
  setTimeout(() => {
    if (!inputHandlers.has('studentDbSearch')) {
      const handler = new SmartInputHandler('studentDbSearch', searchStudentDatabase);
      inputHandlers.set('studentDbSearch', handler);
    }
  }, 50);
}

// ğŸ”¥ æ–°å¢ï¼šå¡«å……å¹´çº§ç­›é€‰å™¨
function populateGradeFilter(){
  const sel = $('gradeFilter');
  if (!sel) return;
  
  const grades = new Set();
  Object.values(studentDatabase).forEach(students => {
    students.forEach(s => {
      const grade = typeof s === 'object' ? (s.grade || '') : '';
      if (grade) {
        grades.add(grade);
      }
    });
  });
  
  const sortedGrades = Array.from(grades).sort((a, b) => {
    // ä¼˜å…ˆæŒ‰G1-G12æ’åº
    const aMatch = a.match(/^G(\d+)$/);
    const bMatch = b.match(/^G(\d+)$/);
    
    if (aMatch && bMatch) {
      return parseInt(aMatch[1]) - parseInt(bMatch[1]);
    } else if (aMatch) {
      return -1;
    } else if (bMatch) {
      return 1;
    } else {
      return a.localeCompare(b, 'zh-Hans-CN');
    }
  });
  
  sel.innerHTML = '<option value="">æ‰€æœ‰å¹´çº§</option>' +
    '<option value="no_grade">æœªè®¾ç½®å¹´çº§</option>' +
    sortedGrades.map(g => `<option value="${g}">${formatGradeDisplay(g)}</option>`).join('');
}


function closeQueueStudentModal(){ $('queueStudentModal').style.display='none'; currentQueueType=null; }
let currentQueueType=null;
function searchQueueStudents(q){
  const list=$('queueStudentList'); q=q.trim();
  const type=currentQueueType;
  if(!type){list.innerHTML='<div style="text-align:center;color:#999;padding:20px;">æ— ç±»å‹</div>';return;}
  let html='';
  if(!q){
    // æ˜¾ç¤ºä¸»è¦åˆ†ç±»æŒ‰é’®
    if(type==='grand'){
      const arr=studentDatabase['é’¢ç´æ•™ç ”å®¤']||[];
      const studentNames = arr.map(s => getStudentName(s)); // ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®è·å–å­¦ç”Ÿå§“å
      html='<div class="category-title">é’¢ç´æ•™ç ”å®¤</div>'+
        studentNames.map(name=>renderQueueSelectable(name,type)).join('')||'<div style="text-align:center;color:#999;padding:15px;">æš‚æ— å­¦ç”Ÿ</div>';
    }else{
      for(const [m,arr] of Object.entries(studentDatabase)){
        const studentNames = arr.map(s => getStudentName(s)); // ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®è·å–å­¦ç”Ÿå§“å
        html+=`<div class="category-title">${m}</div>`+
          studentNames.map(name=>renderQueueSelectable(name,type)).join('');
      }
    }
  }else{
    for(const [m,arr] of Object.entries(studentDatabase)){
      const f=arr.filter(s=>{
        const studentName = getStudentName(s); // ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®è·å–å­¦ç”Ÿå§“å
        return matchPinyin(studentName, q);
      }).map(s => getStudentName(s)); // ğŸ”¥ ä¿®å¤ï¼šè½¬æ¢ä¸ºå§“åå­—ç¬¦ä¸²
      if(f.length){
        html+=`<div class="category-title">${m}</div>`+f.map(name=>renderQueueSelectable(name,type)).join('');
      }
    }
  }
  if(!html) html='<div style="text-align:center;color:#999;padding:20px;">æœªæ‰¾åˆ°åŒ¹é…å­¦ç”Ÿ</div>';
  list.innerHTML=html;
  $('addNewQueueStudentSection').style.display='block';
}

function renderQueueSelectable(name,type){
  const v=validateQueueAdd(name,type);
  const status = getStudentStatusForModal(name);
  const cls = 'student-item'+(v.ok?'': ' disabled-student');
  const click = v.ok? `onclick="attemptQueueAdd('${name}')"`:`onclick="showStudentStatusHint('${name}','${status.reason||'ä¸å¯åŠ å…¥'}')"`;
  return `<div class="${cls}" ${click}>
    <span class="student-name-text">${name}</span>${status.statusBadge||''}
  </div>`;
}
function attemptQueueAdd(name){
  if(!currentQueueType) return;
  const v=validateQueueAdd(name,currentQueueType);
  if(!v.ok){showToast(v.reason);return;}
  queueList[currentQueueType].push(name);
  persistQueues();
  updateQueueDisplay();
  closeQueueStudentModal();
  showToast(`${name} å·²åŠ å…¥æ’é˜Ÿ`);
}
function addNewQueueStudent(){
  if(!currentQueueType){showToast('æ— ç±»å‹');return;}
  const name=$('queueStudentSearch').value.trim();
  if(!name){alert('è¯·è¾“å…¥å§“å');return;}
  if(Object.values(studentDatabase).some(a=>a.includes(name))){
    // å·²å­˜åœ¨ -> ç›´æ¥éªŒè¯åŠ å…¥
    const v=validateQueueAdd(name,currentQueueType);
    if(!v.ok){alert(v.reason);return;}
  }else{
    let major=currentQueueType==='grand'?'é’¢ç´æ•™ç ”å®¤':'å…¶ä»–';
    if(!studentDatabase[major]) studentDatabase[major]=[];
    studentDatabase[major].push(name);
    persistStudents();
  }
  queueList[currentQueueType].push(name);
  persistQueues();
  updateQueueDisplay();
  closeQueueStudentModal();
  showToast('å·²æ·»åŠ å¹¶æ’é˜Ÿ');
}
function updateQueueDisplay(){
  ['grand','upright','none'].forEach(type=>{
    const box = $(type + 'QueueList');
    const arr = queueList[type];
    if(!box) return;

    if(!arr.length){
      box.innerHTML = '<div class="empty-queue">æš‚æ— æ’é˜Ÿå­¦ç”Ÿ</div>';
    }else{
      const waits = computeQueueWaits(type);
      const html = arr.map((student,i)=>{
        const waitMs = waits[i];
        const ready = waitMs <= 0;
        const waitText = formatWait(waitMs);
        return `
          <div class="queue-item${ready?' has-available-rooms':''}" 
               data-type="${type}" 
               data-index="${i}" 
               data-student="${student}" 
               ${ready?`data-ready="1"`:''}>
            <div class="queue-number">${i+1}</div>
            <div class="queue-student-info">
              <div class="queue-student-name">${student}</div>
              <div class="queue-wait">${waitText}</div>
            </div>
            <div class="queue-actions">
              <button class="queue-btn up" ${i===0?'disabled':''} data-action="up">â†‘</button>
              <button class="queue-btn down" ${i===arr.length-1?'disabled':''} data-action="down">â†“</button>
              <button class="queue-btn remove" data-action="remove">âœ•</button>
            </div>
          </div>`;
      }).join('');
      box.innerHTML = html;
    }

    // æ–°å¢ï¼šæ ¹æ®æ˜¯å¦ä¸ºç©ºéšè—å¯¹åº” section
    const sectionIdMap = {grand:'grandQueueSection',upright:'uprightQueueSection',none:'noneQueueSection'};
    const section = $(sectionIdMap[type]);
    if(section){
      section.style.display = queueList[type].length ? 'block' : 'none';
    }
  });

  bindQueueListEventsOnce();

  // é¢æ¿æ€»ä½“æ˜¾ç¤ºæ¡ä»¶ï¼šä»»ä¸€éç©º
  const visible = queueList.grand.length || queueList.upright.length || queueList.none.length;
  document.querySelector('.panel.queue').style.display = visible ? 'block':'none';
}

let queueEventsBound = false;
function bindQueueListEventsOnce(){
  if(queueEventsBound) return;
  const panel = document.querySelector('.panel.queue');
  if(!panel) return;
  panel.addEventListener('click', e=>{
    const item = e.target.closest('.queue-item');
    const btn  = e.target.closest('.queue-btn');
    if(btn && item){
      const type = item.dataset.type;
      const index = parseInt(item.dataset.index);
      const action = btn.dataset.action;
      if(action==='up'){ moveQueueItem(type,index,-1); }
      else if(action==='down'){ moveQueueItem(type,index,1); }
      else if(action==='remove'){ removeFromQueue(type,index); }
      return;
    }
    if(item && item.dataset.ready==='1'){
      // åªæœ‰ ready æ—¶æ‰å…è®¸ç‚¹å‡»æ•´ä½“è¿›å…¥é€‰æ‹©
      const type = item.dataset.type;
      const student = item.dataset.student;
      showReplaceableRoomsModal(student,type);
    }
  });
  queueEventsBound = true;
}

/* è¦†ç›– move / remove åç›´æ¥è°ƒç”¨ updateQueueDisplay (ä¸å†å•ç‹¬ refreshAllQueueWaits) */
function moveQueueItem(type,i,dir){
  const arr=queueList[type];
  const ni=i+dir;
  if(ni<0||ni>=arr.length) return;
  [arr[i],arr[ni]]=[arr[ni],arr[i]];
  persistQueues();
  updateQueueDisplay();
}
function removeFromQueue(type,i){
  const arr=queueList[type];
  const stu=arr[i];
  if(!confirm(`å°† ${stu} ç§»å‡º${type==='grand'?'ä¸‰è§’':type==='upright'?'ç«‹å¼':'æ™®é€š'}é˜Ÿåˆ—?`))return;
  arr.splice(i,1);
  persistQueues();
  updateQueueDisplay();
  showToast('å·²ç§»é™¤');
}

function clearQueue(type){
  if(!queueList[type].length){showToast('é˜Ÿåˆ—ä¸ºç©º');return;}
  if(!confirm(`æ¸…ç©º${type==='grand'?'ä¸‰è§’':type==='upright'?'ç«‹å¼':'æ™®é€š'}ç´æˆ¿æ’é˜Ÿ?`))return;
  queueList[type]=[];
  persistQueues();updateQueueDisplay();
}
function clearAllQueues(){
  if(!queueList.grand.length && !queueList.upright.length && !queueList.none.length){
    showToast('æ— ä»»ä½•æ’é˜Ÿ');
    return;
  }
  if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ’é˜Ÿ?'))return;
  queueList={grand:[],upright:[],none:[]};
  persistQueues();updateQueueDisplay();
  showToast('å·²æ¸…ç©ºå…¨éƒ¨æ’é˜Ÿ');
}

/* ç­‰å¾…æ—¶é—´ä¼°ç®— */
function computeQueueWaits(type){
  const now=Date.now();
  const prep=60000;
  const max=systemSettings.basePracticeDuration*60*1000;
  const candidates=rooms.filter(r=>{
    if(type==='grand') return r.pianoKind==='ä¸‰è§’é’¢ç´';
    if(type==='upright') return r.pianoKind==='ç«‹å¼é’¢ç´';
    return r.pianoKind==='æ— é’¢ç´';
  });
  if(!candidates.length) return queueList[type].map(()=>0);
  const finishTimes=candidates.map(r=>{
    if(!r.student) return now;
    const prepEnd=r.registerTime+prep;
    if(now<prepEnd) return r.registerTime+prep+max;
    const used=now-prepEnd;
    if(used>max) return now;
    return r.registerTime+prep+max;
  });
  const servers=[...finishTimes];
  const waits=[];
  queueList[type].forEach(()=>{
    let mi=0;
    for(let j=1;j<servers.length;j++) if(servers[j]<servers[mi]) mi=j;
    const wait=Math.max(0,servers[mi]-now);
    waits.push(wait);
    servers[mi]+=prep+max;
  });
  return waits;
}
function refreshAllQueueWaits(){
  ['grand','upright','none'].forEach(type=>{
    const arr=queueList[type];
    if(!arr.length) return;
    const waits=computeQueueWaits(type);
    waits.forEach((w,i)=>{
      const el=$(`queue-wait-${type}-${i}`);
      if(el) el.textContent=formatWait(w);
      const item=el?el.closest('.queue-item'):null;
      if(item){
        if(w<=0){
          item.classList.add('has-available-rooms');
          item.onclick=()=>showReplaceableRoomsModal(arr[i],type);
        }else{
          item.classList.remove('has-available-rooms');
          item.onclick=null;
        }
      }
    });
  });
}
/* ========= é˜Ÿåˆ—å¿«é€Ÿåˆ†é… / æ›¿æ¢å¼¹çª— ========= */
function showQueueModal(roomName,type){
  const modal = $('queueModal');
  const listBox = $('queueModalList');
  const room = rooms.find(r=>r.name===roomName);
  if(!modal || !room) return;

  $('queueModalTitle').textContent = `ä¸º ${roomName} åˆ†é…ï¼ˆ${type==='grand'?'ä¸‰è§’':type==='upright'?'ç«‹å¼':'æ™®é€š'}é˜Ÿåˆ—ï¼‰`;

  const qArr = queueList[type];
  if(!qArr.length){
    listBox.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">å½“å‰æ— æ’é˜Ÿ</div>';
    modal.style.display='block';
    return;
  }

  const roomStatusLine = room.student
    ? `<div style="margin-bottom:10px;font-size:13px;color:#c0392b;">
         å½“å‰å ç”¨ï¼š${room.student}ï¼ˆ${getRoomOccupyRuntime(room)}ï¼‰
       </div>`
    : `<div style="margin-bottom:10px;font-size:13px;color:#27ae60;">
         å½“å‰ä¸ºç©ºé—²ï¼Œå¯ç›´æ¥åˆ†é…
       </div>`;

  // æ„é€ é˜Ÿåˆ—åˆ—è¡¨
  const rows = qArr.map((stu,idx)=>{
    const isFirst = idx===0;
    return `<div style="display:flex;align-items:center;justify-content:space-between;
                        padding:8px 10px;border:1px solid #e0e0e0;border-radius:8px;
                        margin-bottom:8px;background:${isFirst?'#fffbe6':'#fff'};">
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${idx+1}. ${stu}</div>
          ${isFirst?'<div style="font-size:11px;color:#b37400;">æ¨èä¼˜å…ˆ</div>':''}
        </div>
        <button style="background:#3498db;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;"
          onclick="assignQueueStudentToRoom('${stu}','${roomName}','${type}')">
          åˆ†é…
        </button>
      </div>`;
  }).join('');

  listBox.innerHTML = roomStatusLine + rows +
    `<div style="margin-top:6px;font-size:11px;line-height:1.4;color:#777;">
       åˆ†é…é€»è¾‘ï¼šç‚¹å‡»â€œåˆ†é…â€åè¯¥å­¦ç”Ÿå°†è¿›å…¥æ­¤ç´æˆ¿ï¼Œå¹¶è‡ªåŠ¨ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼›
       ${room.student?'åŸå­¦ç”Ÿå°†è¢«æå‰ç»“æŸå¹¶è®°å½•æ—¥å¿—ã€‚':''}
     </div>`;

  modal.style.display='block';
}

function getRoomOccupyRuntime(room){
  if(!room.student) return '';
  const now=Date.now();
  const prepEnd = room.registerTime+60000;
  if(now<prepEnd){
    return 'å‡†å¤‡ä¸­';
  }
  const used = Math.floor((now-prepEnd)/1000);
  const limit = systemSettings.basePracticeDuration*60;
  if(used<=limit) return 'å·²ç”¨ '+formatHMS(used);
  return 'è¶…æ—¶ '+formatHMS(used);
}

function assignQueueStudentToRoom(student,roomName,type){
  const room = rooms.find(r=>r.name===roomName);
  if(!room) return;
  const now = Date.now();

  // è‹¥å­¦ç”Ÿå·²åœ¨å…¶å®ƒæˆ¿é—´ï¼Œå…ˆæ¸…ç©ºå…¶å®ƒæˆ¿é—´
  const otherRooms = rooms.filter(r=>r.student===student && r.name!==roomName);
  otherRooms.forEach(or=>{
    addPracticeLog(or.student,or.name,or.registerTime,now,'è½¬ç§»(é˜Ÿåˆ—åˆ†é…)');
    or.student=null;or.registerTime=null;
  });

  // å¦‚æœæˆ¿é—´å·²æœ‰å­¦ç”Ÿ -> æ—¥å¿— & è¦†ç›–
  if(room.student){
    if(!confirm(`ç¡®è®¤å°† ${student} åˆ†é…åˆ° ${roomName} å¹¶ç»“æŸå½“å‰ ${room.student} çš„ä½¿ç”¨ï¼Ÿ`)){
      return;
    }
    addPracticeLog(room.student,room.name,room.registerTime,now,`è¢« ${student} é˜Ÿåˆ—æ›¿æ¢`);
  }

  room.student = student;
  room.registerTime = now;

  // ä»é˜Ÿåˆ—ç§»é™¤
  const arr = queueList[type];
  const idx = arr.indexOf(student);
  if(idx>-1) arr.splice(idx,1);

  persistRooms();
  persistQueues();
  updateQueueDisplay();
  needsFullUpdate=true;
  updateRooms();
  closeQueueModal();
  showToast(`${student} å·²è¿›å…¥ ${roomName}`);
  // ğŸ”¥ ç«‹å³è§¦å‘å®æ—¶çŠ¶æ€æ›´æ–°
  triggerRealTimePracticeStatusUpdate();
}


function closeQueueModal(){
  const m=$('queueModal');
  if(m) m.style.display='none';
}

/* =============== 8. å¿«é€Ÿéœ€æ±‚ï¼ˆå¯ç”¨/æ›¿æ¢ï¼‰ =============== */
let currentDemandType=null;
let currentDemandRooms=[];
function handleDemandRequest(type){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  currentDemandType=type;
  if(queueList[type] && queueList[type].length){
    if(confirm('å½“å‰æœ‰æ’é˜Ÿï¼Œéœ€å…ˆåŠ å…¥é˜Ÿåˆ—ï¼Œæ˜¯å¦æ‰“å¼€æ’é˜Ÿé€‰æ‹©ï¼Ÿ')){
      showQueueStudentModal(type);
    }
    return;
  }
  const res=analyzeDemandAvailability(type);
  if(res.available.length){
    showAvailableRoomsModal(res.available,type,'available');
  }else if(res.overtime.length){
    showAvailableRoomsModal(res.overtime,type,'overtime');
  }else{
    if(confirm('æ— å¯ç”¨/è¶…æ—¶ç´æˆ¿ï¼Œæ˜¯å¦åŠ å…¥æ’é˜Ÿï¼Ÿ')){
      showQueueStudentModal(type);
    }
  }
}
function analyzeDemandAvailability(type){
  const now=Date.now();
  const available=[], overtime=[];
  rooms.forEach(r=>{
    const match = (type==='grand' && r.pianoKind==='ä¸‰è§’é’¢ç´')
               || (type==='upright' && r.pianoKind==='ç«‹å¼é’¢ç´')
               || (type==='none' && r.pianoKind==='æ— é’¢ç´');
    if(!match) return;
    if(!r.student) available.push(r);
    else{
      const prepEnd=r.registerTime+60000;
      if(now>prepEnd){
        const used=Math.floor((now-prepEnd)/1000);
        const limit=systemSettings.basePracticeDuration*60;
        if(used>limit){
          overtime.push({...r,overtimeSeconds:used-limit,elapsedTime:used+60});
        }
      }
    }
  });
  overtime.sort((a,b)=>b.overtimeSeconds-a.overtimeSeconds);
  return {available,overtime};
}
function showAvailableRoomsModal(list,type,mode){
  currentDemandRooms=list;
  $('availableRoomsTitle').textContent= mode==='available'
    ?`é€‰æ‹©${type==='grand'?'ä¸‰è§’':'upright'===type?'ç«‹å¼':'æ™®é€š'}ç´æˆ¿`
    :'é€‰æ‹©è¶…æ—¶ç´æˆ¿ï¼ˆå°†æ›¿æ¢å½“å‰å­¦ç”Ÿï¼‰';
  
  const info=$('availableRoomsInfo');
  info.innerHTML= mode==='available'
    ? `<div style="color:var(--success-color);margin-bottom:12px;">æ‰¾åˆ° ${list.length} é—´ç©ºé—²ç´æˆ¿</div>`
    : `<div class="overtime-info" style="margin-bottom:12px;">æ— ç©ºé—²ç´æˆ¿ï¼Œä»¥ä¸‹ä¸ºå¯æ›¿æ¢çš„è¶…æ—¶ç´æˆ¿</div>`;
  
  // æ·»åŠ æœç´¢æ¡†
  const searchBox = `
    <div style="margin-bottom:15px;">
      <input type="text" id="roomSelectSearch" placeholder="æœç´¢ç´æˆ¿åç§°ã€ä½ç½®..." 
             style="width:100%;padding:8px 12px;border:1px solid var(--border-color);border-radius:6px;font-size:14px;"
             oninput="filterRoomSelection(this.value)">
    </div>`;
  
  // ç½‘æ ¼å¸ƒå±€æ˜¾ç¤ºç´æˆ¿
  const roomCards = list.map((r,idx)=>{
    let statusInfo = '';
    let cardClass = 'room-select-card available';
    
    if(mode==='overtime'){
      statusInfo = `
        <div class="room-overtime-info">
          <span style="color:var(--danger-color);font-weight:600;">è¶…æ—¶ ${formatDurationHuman(r.overtimeSeconds)}</span>
          <div style="font-size:11px;color:#666;margin-top:2px;">å½“å‰ï¼š${r.student}</div>
        </div>`;
      cardClass = 'room-select-card overtime';
    } else if(r.remark) {
      statusInfo = `<div class="room-remark" style="font-size:11px;color:#666;margin-top:4px;">${r.remark}</div>`;
    }
    
    const typeIcon = r.pianoKind==='ä¸‰è§’é’¢ç´' ? 'ğŸ¹' : r.pianoKind==='ç«‹å¼é’¢ç´' ? 'ğŸ¹' : 'ğŸµ';
    
    return `
      <div class="${cardClass}" 
           data-name="${r.name.toLowerCase()}" 
           data-location="${(r.location||'').toLowerCase()}"
           onclick="selectDemandRoom('${r.name}','${mode}')">
        <div class="room-card-header">
          <span class="room-type-icon">${typeIcon}</span>
          <span class="room-card-name">${r.name}</span>
        </div>
        <div class="room-card-location">${r.location||'æœªçŸ¥ä½ç½®'}</div>
        ${statusInfo}
        <div class="room-select-arrow">â†’</div>
      </div>`;
  }).join('');

  $('availableRoomsList').innerHTML = searchBox + 
    `<div class="room-select-grid">${roomCards}</div>` + 
    (list.length === 0 ? '<div style="text-align:center;color:#999;padding:25px;">æš‚æ— ç´æˆ¿</div>' : '');
  
  $('availableRoomsModal').style.display='block';
  
  // èšç„¦æœç´¢æ¡†
  setTimeout(()=>{
    const searchInput = $('roomSelectSearch');
    if(searchInput) searchInput.focus();
  }, 100);
}
function filterRoomSelection(query) {
  const cards = document.querySelectorAll('.room-select-card');
  const q = query.toLowerCase().trim();
  
  let visibleCount = 0;
  cards.forEach(card => {
    const name = card.dataset.name || '';
    const location = card.dataset.location || '';
    const shouldShow = !q || name.includes(q) || location.includes(q);
    
    card.style.display = shouldShow ? 'block' : 'none';
    if(shouldShow) visibleCount++;
  });
  
  // æ˜¾ç¤ºè¿‡æ»¤ç»“æœæç¤º
  let resultHint = document.querySelector('.filter-result-hint');
  if(q && visibleCount === 0) {
    if(!resultHint) {
      resultHint = document.createElement('div');
      resultHint.className = 'filter-result-hint';
      resultHint.style.cssText = 'text-align:center;color:#999;padding:20px;font-style:italic;';
      document.querySelector('.room-select-grid').appendChild(resultHint);
    }
    resultHint.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„ç´æˆ¿';
    resultHint.style.display = 'block';
  } else if(resultHint) {
    resultHint.style.display = 'none';
  }
}

function selectDemandRoom(name,mode){
  currentRoom=name;
  $('availableRoomsModal').style.display='none';
  // æ‰“å¼€å­¦ç”Ÿé€‰æ‹©
  const room=rooms.find(r=>r.name===name);
  openStudentSelectModal(room);
}
function closeAvailableRoomsModal(){
  $('availableRoomsModal').style.display='none';
  currentDemandType=null;currentDemandRooms=[];
  currentRoom=null;
}

/* æ›¿æ¢è¶…æ—¶ï¼ˆæ¥è‡ªæ’é˜Ÿé—ªçƒç‚¹å‡»ï¼‰ */
function showReplaceableRoomsModal(student,type){
  const {available, overtime}=analyzeDemandAvailability(type);
  if(!available.length && !overtime.length){
    alert('å½“å‰æ— å¯ç”¨æˆ–å¯æ›¿æ¢ç´æˆ¿');return;
  }
  
  $('replaceableRoomsTitle').textContent=`ä¸º ${student} é€‰æ‹©ç´æˆ¿`;
  const info=$('replaceableRoomsInfo');
  info.innerHTML=`<div style="margin-bottom:12px;">ç©ºé—²: <span style="color:var(--success-color);font-weight:600;">${available.length}</span> é—´ Â· è¶…æ—¶: <span style="color:var(--danger-color);font-weight:600;">${overtime.length}</span> é—´</div>`;
  
  // æ·»åŠ æœç´¢æ¡†
  const searchBox = `
    <div style="margin-bottom:15px;">
      <input type="text" id="replaceRoomSearch" placeholder="æœç´¢ç´æˆ¿åç§°ã€ä½ç½®..." 
             style="width:100%;padding:8px 12px;border:1px solid var(--border-color);border-radius:6px;font-size:14px;"
             oninput="filterReplaceRoomSelection(this.value)">
    </div>`;
  
  const allRooms = [...available, ...overtime];
  const roomCards = allRooms.map(r=>{
    const isAvailable = available.includes(r);
    const cardClass = isAvailable ? 'room-select-card available' : 'room-select-card overtime';
    const statusIcon = isAvailable ? 'ğŸŸ¢' : 'ğŸ”´';
    const statusText = isAvailable ? 'ç©ºé—²' : 'è¶…æ—¶';
    const typeIcon = r.pianoKind==='ä¸‰è§’é’¢ç´' ? 'ğŸ¹' : r.pianoKind==='ç«‹å¼é’¢ç´' ? 'ğŸ¹' : 'ğŸµ';
    
    let extraInfo = '';
    if(!isAvailable) {
      extraInfo = `<div style="font-size:11px;color:var(--danger-color);margin-top:2px;">å½“å‰ï¼š${r.student}</div>`;
    }
    
    const action = isAvailable ? 'available' : 'replace';
    
    return `
      <div class="${cardClass}" 
           data-name="${r.name.toLowerCase()}" 
           data-location="${(r.location||'').toLowerCase()}"
           onclick="replaceWithQueueStudent('${student}','${type}','${r.name}','${action}')">
        <div class="room-card-header">
          <span class="room-type-icon">${typeIcon}</span>
          <span class="room-card-name">${r.name}</span>
          <span style="font-size:12px;">${statusIcon}</span>
        </div>
        <div class="room-card-location">${r.location||'æœªçŸ¥ä½ç½®'}</div>
        <div style="font-size:11px;color:#666;font-weight:600;">${statusText}</div>
        ${extraInfo}
        <div class="room-select-arrow">â†’</div>
      </div>`;
  }).join('');
  
  $('replaceableRoomsList').innerHTML = searchBox + 
    `<div class="room-select-grid">${roomCards}</div>`;
  
  $('replaceableRoomsModal').style.display='block';
  
  // èšç„¦æœç´¢æ¡†
  setTimeout(()=>{
    const searchInput = $('replaceRoomSearch');
    if(searchInput) searchInput.focus();
  }, 100);
}

function filterReplaceRoomSelection(query) {
  const cards = document.querySelectorAll('#replaceableRoomsList .room-select-card');
  const q = query.toLowerCase().trim();
  
  let visibleCount = 0;
  cards.forEach(card => {
    const name = card.dataset.name || '';
    const location = card.dataset.location || '';
    const shouldShow = !q || name.includes(q) || location.includes(q);
    
    card.style.display = shouldShow ? 'block' : 'none';
    if(shouldShow) visibleCount++;
  });
}
function closeReplaceableRoomsModal(){ $('replaceableRoomsModal').style.display='none'; }
function replaceWithQueueStudent(student,type,roomName,mode){
  const room=rooms.find(r=>r.name===roomName);
  if(!room){alert('ç´æˆ¿ä¸å­˜åœ¨');return;}
  const idx=queueList[type].indexOf(student);
  if(idx<0){alert('å­¦ç”Ÿå·²ä¸åœ¨é˜Ÿåˆ—');closeReplaceableRoomsModal();return;}
  const now=Date.now();
  if(mode==='replace' && room.student){
    addPracticeLog(room.student,room.name,room.registerTime,now,`è¢« ${student} æ›¿æ¢`);
  }
  room.student=student;
  room.registerTime=now;
  queueList[type].splice(idx,1);
  persistRooms();persistQueues();
  updateQueueDisplay();
  needsFullUpdate=true;updateRooms();
  closeReplaceableRoomsModal();
  showToast(`${student} å·²è¿›å…¥ ${roomName}`);
  // ğŸ”¥ ç«‹å³è§¦å‘å®æ—¶çŠ¶æ€æ›´æ–°
  triggerRealTimePracticeStatusUpdate();
  // ğŸ”¥ æ–°å¢ï¼šåˆ·æ–°æœç´¢ç»“æœ
  refreshSearchResults();
}

/* =============== 9. æ—¶é—´è½´é¢„æµ‹ =============== */
function toggleTimeline(){
  timelineVisible=!timelineVisible;
  localStorage.setItem(KEYS.TIMELINE_VISIBLE, timelineVisible.toString());
  const btn=$('timelineMainControlBtn');
  const section=$('timelineSection');
  if(timelineVisible){
    section.style.display='block';
    btn.classList.add('active');
    btn.querySelector('.timeline-control-text').textContent='éšè—ç´æˆ¿çŠ¶æ€é¢„æµ‹';
    btn.querySelector('.timeline-control-icon').textContent='ğŸ‘ï¸';
    updateTimeline();
  }else{
    section.style.display='none';
    btn.classList.remove('active');
    btn.querySelector('.timeline-control-text').textContent='æ˜¾ç¤ºç´æˆ¿çŠ¶æ€é¢„æµ‹';
    btn.querySelector('.timeline-control-icon').textContent='â°';
  }
}
function updateTimeline(){
  if(!timelineVisible) return;

  const now = Date.now();
  const baseMs = systemSettings.basePracticeDuration * 60000;
  const prepMs = 60000;

  const soonList = [];      // å‰©ä½™ <= 15 åˆ†é’Ÿ
  const overtimeList = [];  // å·²è¶…æ—¶

  // ç¡®ä¿ rooms æ•°ç»„å­˜åœ¨ä¸”æœ‰æ•ˆ
  if(!rooms || !Array.isArray(rooms)) {
    rooms = [];
  }

  rooms.forEach(r=>{
    if(!r.student) return;

    const card = {
      name: r.name,
      pianoType: r.pianoKind || 'æ— é’¢ç´',
      location: r.location || '',
      remark: r.remark || '',
      student: r.student,
      remainMs: null,
      overtimeMs: null,
      isPreparing: false,
      usedSeconds: 0
    };

    const prepEnd = r.registerTime + prepMs;
    const endLimit = prepEnd + baseMs;

    if(now < prepEnd){
      // å‡†å¤‡é˜¶æ®µ
      card.isPreparing = true;
      return;
    }

    const used = now - prepEnd;
    card.usedSeconds = Math.floor(used/1000);

    if(used > baseMs){
      card.overtimeMs = used - baseMs;
      overtimeList.push(card);
    }else{
      const remain = endLimit - now;
      card.remainMs = remain;
      if(remain <= 15*60000){
        soonList.push(card);
      }
    }
  });

  // æ’åºï¼šsoon æŒ‰å‰©ä½™å‡åº / åç§°ï¼›overtime æŒ‰è¶…æ—¶é™åº / åç§°
  soonList.sort((a,b)=>{
    if(a.remainMs !== b.remainMs) return a.remainMs - b.remainMs;
    return a.name.localeCompare(b.name,'zh-Hans-CN');
  });
  overtimeList.sort((a,b)=>{
    if(a.overtimeMs !== b.overtimeMs) return b.overtimeMs - a.overtimeMs;
    return a.name.localeCompare(b.name,'zh-Hans-CN');
  });

  // æ›´æ–°è®¡æ•°æ˜¾ç¤º
  const soonCountEl = $('focusSoonCount');
  const overCountEl = $('focusOverCount');
  if(soonCountEl) soonCountEl.textContent = soonList.length;
  if(overCountEl) overCountEl.textContent = overtimeList.length;

  // ğŸ”¥ å…³é”®æ”¹è¿›ï¼šå¢é‡æ›´æ–°è€Œéé‡å»ºæ•´ä¸ªå®¹å™¨
  updateTimelineContainer('focusSoonBody', soonList, 'soon');
  updateTimelineContainer('focusOverBody', overtimeList, 'overtime');

  // åº”ç”¨è¿‡æ»¤å™¨
  filterFocusCards();
}

// ğŸ”¥ æ–°å¢ï¼šå¢é‡æ›´æ–°å®¹å™¨å‡½æ•°
function updateTimelineContainer(containerId, dataList, type) {
  const container = $(containerId);
  if(!container) return;

  // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
  if(!dataList.length) {
    const emptyMsg = type === 'soon' 
      ? 'æš‚æ—  15 åˆ†é’Ÿå†…å°†é‡Šæ”¾çš„ç´æˆ¿' 
      : 'æš‚æ— è¶…æ—¶ç´æˆ¿';
    
    if(container.children.length !== 1 || !container.querySelector('.focus-empty')) {
      container.innerHTML = `<div class="focus-empty">${emptyMsg}</div>`;
    }
    return;
  }

  // ç§»é™¤ç©ºçŠ¶æ€æç¤º
  const emptyEl = container.querySelector('.focus-empty');
  if(emptyEl) emptyEl.remove();

  // è·å–ç°æœ‰å¡ç‰‡
  const existingCards = Array.from(container.querySelectorAll('.focus-card'));
  const existingNames = existingCards.map(card => card.dataset.name);
  const newNames = dataList.map(item => item.name);

  // 1. ç§»é™¤ä¸å†å­˜åœ¨çš„å¡ç‰‡
  existingCards.forEach(card => {
    if(!newNames.includes(card.dataset.name)) {
      card.remove();
    }
  });

  // 2. æ›´æ–°æˆ–æ·»åŠ å¡ç‰‡
  dataList.forEach((item, index) => {
    let card = container.querySelector(`[data-name="${item.name}"]`);
    
    if(!card) {
      // åˆ›å»ºæ–°å¡ç‰‡
      card = document.createElement('div');
      card.className = `focus-card ${type}`;
      card.dataset.name = item.name;
      card.dataset.type = item.pianoType;
      card.dataset.location = item.location;
      card.dataset.student = item.student;
      
      // æ’å…¥åˆ°æ­£ç¡®ä½ç½®
      if(index === 0) {
        container.insertBefore(card, container.firstChild);
      } else {
        const prevCard = container.querySelector(`[data-name="${dataList[index-1].name}"]`);
        if(prevCard && prevCard.nextSibling) {
          container.insertBefore(card, prevCard.nextSibling);
        } else {
          container.appendChild(card);
        }
      }
    }

    // æ›´æ–°å¡ç‰‡å†…å®¹ï¼ˆåªæ›´æ–°åŠ¨æ€éƒ¨åˆ†ï¼‰
    updateCardContent(card, item, type);
    
    // ç¡®ä¿å¡ç‰‡åœ¨æ­£ç¡®ä½ç½®
    const currentIndex = Array.from(container.children).indexOf(card);
    if(currentIndex !== index) {
      if(index === 0) {
        container.insertBefore(card, container.firstChild);
      } else {
        const targetPrev = container.children[index - 1];
        if(targetPrev) {
          container.insertBefore(card, targetPrev.nextSibling);
        }
      }
    }
  });
}

// ğŸ”¥ ä¿®å¤ï¼šæ›´æ–°å•ä¸ªå¡ç‰‡çš„åŠ¨æ€å†…å®¹
function updateCardContent(cardElement, data, type) {
  // å·¥å…·å‡½æ•°
  function typeTag(t){
    if(t==='ä¸‰è§’é’¢ç´') return '<span class="fc-tag grand">ä¸‰è§’</span>';
    if(t==='ç«‹å¼é’¢ç´') return '<span class="fc-tag upright">ç«‹å¼</span>';
    return '<span class="fc-tag none">æ™®é€š</span>';
  }
  
  function fmt(ms){
    if(ms==null) return '';
    let s = Math.ceil(ms/1000);
    if(s<60) return s+'ç§’';
    let m = Math.ceil(s/60);
    if(m<60) return m+'åˆ†';
    const h = Math.floor(m/60), mm = m%60;
    return h+'å°æ—¶'+(mm?mm+'åˆ†':'');
  }

  // æ›´æ–°æˆ–åˆ›å»ºåŸºç¡€ç»“æ„ - ä¿®æ”¹ä¸ºä¸ç´æˆ¿å¡ç‰‡ä¸€è‡´çš„ç»“æ„
  if(!cardElement.querySelector('.fc-room')) {
    cardElement.innerHTML = `
      <div class="fc-room"></div>
      <div class="fc-stu">
        <span class="dot"></span><span class="fc-stu-name"></span>
      </div>
      <div class="fc-status">
        <div class="fc-bottom-row">
          <div class="fc-status-chip"></div>
        </div>
      </div>
    `;
  }

  // æ›´æ–°æˆ¿é—´åç§°ï¼ˆç›¸å¯¹é™æ€ï¼‰
  const roomEl = cardElement.querySelector('.fc-room');
  const expectedRoomContent = `${data.name}${typeTag(data.pianoType)}`;
  if(roomEl.innerHTML !== expectedRoomContent) {
    roomEl.innerHTML = expectedRoomContent;
    roomEl.title = data.name;
  }

  // æ›´æ–°å­¦ç”Ÿåç§°ï¼ˆç›¸å¯¹é™æ€ï¼‰
  const stuNameEl = cardElement.querySelector('.fc-stu-name');
  if(stuNameEl.textContent !== data.student) {
    stuNameEl.textContent = data.student;
    cardElement.querySelector('.fc-stu').title = data.student;
  }

  // æ›´æ–°çŠ¶æ€èŠ¯ç‰‡ - ğŸ”¥ å…³é”®ä¿®å¤ï¼šè®©ä½ç½®å’Œå¤‡æ³¨ä¸çŠ¶æ€èŠ¯ç‰‡åœ¨åŒä¸€è¡Œæ˜¾ç¤º
  const chipEl = cardElement.querySelector('.fc-status-chip');

  if(type === 'soon') {
    // 15åˆ†é’Ÿå†…é‡Šæ”¾ - åªæ˜¾ç¤ºå‰©ä½™æ—¶é—´ + ä½ç½®
    const chips = [];
    chips.push(`<span class="fc-chip remain">å‰© ${fmt(data.remainMs)}</span>`);
    
    // åªæ·»åŠ ä½ç½®ä¿¡æ¯ - ğŸ”¥ æ·»åŠ å·¦è¾¹è·
    if(data.location && data.location.trim()) {
      chips.push(`<span class="fc-chip location" title="${data.location}" style="margin-left: 8px;">${data.location}</span>`);
    }
    
    chipEl.innerHTML = chips.join('');
    
  } else if(type === 'overtime') {
    // è¶…æ—¶ - åªæ˜¾ç¤ºè¶…æ—¶æ—¶é•¿ + ä½ç½®
    const chips = [];
    chips.push(`<span class="fc-chip overtime">è¶…æ—¶ ${fmt(data.overtimeMs)}</span>`);
    
    // åªæ·»åŠ ä½ç½®ä¿¡æ¯ - ğŸ”¥ æ·»åŠ å·¦è¾¹è·
    if(data.location && data.location.trim()) {
      chips.push(`<span class="fc-chip location" title="${data.location}" style="margin-left: 8px;">${data.location}</span>`);
    }
    
    chipEl.innerHTML = chips.join('');
  }
}

function filterFocusCards(){
  const kw = '';
  const typeF = $('focusTypeFilter')?.value || '';
  ['SoonBody','OverBody'].forEach(suffix=>{
    const box = $('focus'+suffix);
    if(!box) return;
    const cards = box.querySelectorAll('.focus-card');
    if(!cards.length) return;
    let visible = 0;
    cards.forEach(card=>{
      const name = card.dataset.name.toLowerCase();
      const loc  = (card.dataset.location||'').toLowerCase();
      const stu  = (card.dataset.student||'').toLowerCase();
      const type = card.dataset.type;
      let show = true;
      if(typeF && type !== typeF) show = false;
      if(kw && !(name.includes(kw)||loc.includes(kw)||stu.includes(kw))) show = false;
      card.style.display = show ? '' : 'none';
      if(show) visible++;
    });
    // å¤„ç†è¿‡æ»¤ç©ºæç¤º
    const old = box.querySelector('.focus-empty-filter');
    if(visible===0 && cards.length){
      if(!old){
        const div=document.createElement('div');
        div.className='focus-empty-filter';
        div.textContent='æ— åŒ¹é…ç»“æœ';
        box.appendChild(div);
      }
    }else if(old){
      box.removeChild(old);
    }
  });
}

/* =============== 10. è¶…æ—¶ç®¡ç† =============== */
function getOvertimeRecords(){
  const now=Date.now();
  const rec={grand:[],upright:[],other:[]};
  rooms.forEach(r=>{
    if(!r.student) return;
    const prepEnd=r.registerTime+60000;
    if(now<=prepEnd) return;
    const used=Math.floor((now-prepEnd)/1000);
    const limit=systemSettings.basePracticeDuration*60;
    if(used>limit){
      const over=used-limit;
      const target = r.pianoKind==='ä¸‰è§’é’¢ç´'?'grand':r.pianoKind==='ç«‹å¼é’¢ç´'?'upright':'other';
      rec[target].push({
        room:r.name,student:r.student,usedSeconds:used,overtimeSeconds:over,location:r.location,pianoKind:r.pianoKind
      });
    }
  });
  Object.values(rec).forEach(arr=>arr.sort((a,b)=>b.overtimeSeconds-a.overtimeSeconds));
  return rec;
}
function openOvertimeModal(){renderOvertimeList(true);$('overtimeModal').style.display='block';}
function closeOvertimeModal(){$('overtimeModal').style.display='none';}
function renderOvertimeList(force){
  const search=$('overtimeSearch').value.trim().toLowerCase();
  const rec=getOvertimeRecords();
  let total=0;
  const box=$('overtimeContent');
  const build=(title,arr)=>{
    if(!arr.length) return '';
    const fil=arr.filter(r=>!search||r.room.toLowerCase().includes(search)||r.student.toLowerCase().includes(search));
    if(!fil.length) return '';
    total+=fil.length;
    return `<div class="overtime-category">
      <div class="overtime-category-header"><span>${title}</span><span class="overtime-category-count">${fil.length} é—´</span></div>
      <div class="overtime-list-header"><div>ç´æˆ¿</div><div>å­¦ç”Ÿ</div><div>ä½ç½®</div><div>å·²ç”¨æ—¶</div><div>è¶…æ—¶æ—¶é•¿</div><div>æ“ä½œ</div></div>
      ${fil.map(r=>`<div class="overtime-item highlight-expired">
        <div>${r.room}</div><div>${r.student}</div><div>${r.location||''}</div>
        <div>${formatHMS(r.usedSeconds)}</div>
        <div style="color:var(--danger-color);font-weight:700;">${formatDurationHuman(r.overtimeSeconds)}</div>
        <div class="ot-actions">
          <button class="btn-mini-danger" onclick="clearOvertimeRoom('${r.room}')">æ¸…ç©º</button>
        </div>
      </div>`).join('')}
    </div>`;
  };
  box.innerHTML=
    build('ä¸‰è§’é’¢ç´',rec.grand)+
    build('ç«‹å¼é’¢ç´',rec.upright)+
    build('å…¶ä»–ç´æˆ¿',rec.other) ||
    '<div style="text-align:center;color:#999;padding:40px;">æš‚æ— è¶…æ—¶è®°å½•</div>';
  $('overtimeStats').textContent=`å…± ${rec.grand.length+rec.upright.length+rec.other.length} æ¡ï¼Œå½“å‰æ˜¾ç¤º ${total} æ¡`;
  refreshOvertimeBadge();
}
function clearAllOvertimeRooms(){
  const rec=getOvertimeRecords();
  const list=[...rec.grand,...rec.upright,...rec.other];
  if(!list.length){showToast('æ— è¶…æ—¶ç´æˆ¿');return;}
  if(!confirm(`ç¡®å®šæ¸…ç©ºæ‰€æœ‰ ${list.length} é—´è¶…æ—¶ç´æˆ¿?`))return;
  const now=Date.now();
  let cleared=[];
  list.forEach(r=>{
    const room=rooms.find(x=>x.name===r.room);
    if(room&&room.student){
      addPracticeLog(room.student,room.name,room.registerTime,now,'è¶…æ—¶æ‰¹é‡æ¸…ç©º');
      cleared.push({room:room.name,student:room.student});
      room.student=null;room.registerTime=null;
    }
  });
  
  // ğŸ”¥ ç«‹å³æŒä¹…åŒ–å’ŒåŒæ­¥
  persistRooms();
  
  // ğŸ”¥ æ–°å¢ï¼šæ ‡è®°ä¸ºç”¨æˆ·ä¸»åŠ¨æ“ä½œ
  lastUserDestructiveActionTs = Date.now();
  
  // ğŸ”¥ æ”¹è¿›ï¼šæ‰¹é‡æ¸…ç©ºçš„FirebaseåŒæ­¥
  if (syncEnabled && isOnline && cleared.length > 0) {
      syncToFirebase('overtime_batch_clear', {
          clearedRooms: cleared,
          timestamp: now,
          count: cleared.length,
          source: 'overtime_management'
      });
  }
  
  updateRooms();
  renderOvertimeList(true);
  showToast('å·²æ¸…ç©ºè¶…æ—¶ç´æˆ¿');
  logOperation('clear_all_overtime',{count:cleared.length,details:cleared});
}


function refreshOvertimeBadge(){
  const badge = $('overtimeCountBadge');
  const btn = document.querySelector('.overtime-manage-btn');
  if(!badge || !btn) return;
  
  const rec = getOvertimeRecords();
  const total = rec.grand.length + rec.upright.length + rec.other.length;
  
  if(total > 0){
    badge.style.display = 'inline-block';
    badge.textContent = total;
  } else {
    badge.style.display = 'none';
  }
}
/* =============== 10.5. ç»ƒä¹ æ—¶é•¿è®°å½•ç³»ç»Ÿ =============== */

/**
 * æ¸…ç†è¿‡æœŸçš„ç»ƒä¹ è®°å½•ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
 */
function cleanupOldPracticeRecords() {
    const now = new Date();
    const cutoffDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    const cutoffKey = toDateKey(cutoffDate);
    
    let cleaned = 0;
    Object.keys(dailyPracticeRecords).forEach(dateKey => {
        if (dateKey < cutoffKey) {
            delete dailyPracticeRecords[dateKey];
            cleaned++;
        }
    });
    
    if (cleaned > 0) {
        console.log(`ğŸ§¹ æ¸…ç†äº† ${cleaned} å¤©çš„è¿‡æœŸç»ƒä¹ è®°å½•`);
        persistPracticeRecords();
    }
}

/**
 * å¼€å§‹ç»ƒç´ä¼šè¯è®°å½•
 */
function startPracticeSession(studentName, roomName, registerTime) {
    const sessionId = `${studentName}_${roomName}_${registerTime}`;
    const now = Date.now();
    
    // æ£€æŸ¥å­¦ç”Ÿçš„æ—¶é—´æ®µè®¾ç½®
    const studentSlots = getStudentTodaySlots(studentName);
    const currentSlot = findCurrentTimeSlot(studentSlots, now);
    
    const session = {
        sessionId,
        studentName,
        roomName,
        startTime: registerTime,
        prepEndTime: registerTime + 60000, // å‡†å¤‡ç»“æŸæ—¶é—´
        actualStartTime: null, // å®é™…å¼€å§‹ç»ƒç´æ—¶é—´ï¼ˆå‡†å¤‡ç»“æŸåï¼‰
        endTime: null,
        inSlotTime: 0, // æ—¶é—´æ®µå†…ç»ƒä¹ æ—¶é•¿ï¼ˆç§’ï¼‰
        outSlotTime: 0, // æ—¶é—´æ®µå¤–ç»ƒä¹ æ—¶é•¿ï¼ˆç§’ï¼‰
        currentSlot: currentSlot, // å½“å‰æ‰€åœ¨æ—¶é—´æ®µ
        slotTransitions: [], // æ—¶é—´æ®µè½¬æ¢è®°å½•
        isActive: true
    };
    
    practiceSessionTracker.set(sessionId, session);
    console.log('ğŸ¹ å¼€å§‹ç»ƒç´ä¼šè¯:', sessionId, currentSlot ? `åœ¨æ—¶é—´æ®µ ${currentSlot.start}-${currentSlot.end}` : 'ä¸åœ¨æ—¶é—´æ®µå†…');
    
    return session;
}

/**
 * æ›´æ–°ç»ƒç´ä¼šè¯ï¼ˆæ¯åˆ†é’Ÿè°ƒç”¨ï¼‰
 */
function updatePracticeSessions() {
    const now = Date.now();
    
    practiceSessionTracker.forEach((session, sessionId) => {
        if (!session.isActive) return;
        
        // æ£€æŸ¥æˆ¿é—´çŠ¶æ€æ˜¯å¦ä»ç„¶åŒ¹é…
        const room = rooms.find(r => r.name === session.roomName && r.student === session.studentName);
        if (!room) {
            // æˆ¿é—´å·²è¢«æ¸…ç©ºï¼Œç»“æŸä¼šè¯
            endPracticeSession(sessionId, now, 'æˆ¿é—´çŠ¶æ€å˜æ›´');
            return;
        }
        
        // å¦‚æœè¿˜åœ¨å‡†å¤‡é˜¶æ®µï¼Œä¸è®¡ç®—ç»ƒä¹ æ—¶é•¿
        if (now < session.prepEndTime) {
            return;
        }
        
        // è®¾ç½®å®é™…å¼€å§‹æ—¶é—´
        if (!session.actualStartTime) {
            session.actualStartTime = session.prepEndTime;
        }
        
        // è·å–å½“å‰æ—¶é—´æ®µçŠ¶æ€
        const studentSlots = getStudentTodaySlots(session.studentName);
        const currentSlot = findCurrentTimeSlot(studentSlots, now);
        
        // æ£€æŸ¥æ—¶é—´æ®µæ˜¯å¦å‘ç”Ÿå˜åŒ–
        if (JSON.stringify(currentSlot) !== JSON.stringify(session.currentSlot)) {
            session.slotTransitions.push({
                time: now,
                fromSlot: session.currentSlot,
                toSlot: currentSlot
            });
            session.currentSlot = currentSlot;
            console.log(`ğŸ”„ ${session.studentName} æ—¶é—´æ®µå˜åŒ–:`, currentSlot ? `è¿›å…¥ ${currentSlot.start}-${currentSlot.end}` : 'ç¦»å¼€æ—¶é—´æ®µ');
        }
        
        // è®¡ç®—è‡ªä¸Šæ¬¡æ›´æ–°ä»¥æ¥çš„æ—¶é•¿å¢é‡ï¼ˆ60ç§’ï¼‰
        const increment = 60; // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
        
        if (currentSlot) {
            session.inSlotTime += increment;
        } else {
            session.outSlotTime += increment;
        }
        
        console.log(`â±ï¸ ${session.studentName} ç»ƒä¹ æ—¶é•¿æ›´æ–°: æ®µå†…${Math.floor(session.inSlotTime/60)}åˆ† æ®µå¤–${Math.floor(session.outSlotTime/60)}åˆ†`);
    });
}

/**
 * ç»“æŸç»ƒç´ä¼šè¯
 */
function endPracticeSession(sessionId, endTime, reason = 'æ­£å¸¸ç»“æŸ') {
    const session = practiceSessionTracker.get(sessionId);
    if (!session || !session.isActive) return null;
    
    session.endTime = endTime;
    session.isActive = false;
    session.endReason = reason;
    
    // è®¡ç®—æœ€ç»ˆæ—¶é•¿
    const actualEndTime = endTime;
    const actualStartTime = session.actualStartTime || session.prepEndTime;
    
    if (actualEndTime > actualStartTime) {
        const totalPracticeTime = Math.floor((actualEndTime - actualStartTime) / 1000);
        
        // é‡æ–°ç²¾ç¡®è®¡ç®—æ—¶é—´æ®µå†…å¤–æ—¶é•¿
        recalculateSessionTimes(session);
        
        // è®°å½•åˆ°æ—¥å¸¸ç»ƒä¹ è®°å½•
        recordDailyPractice(session);
        
        console.log(`ğŸ ç»“æŸç»ƒç´ä¼šè¯: ${session.studentName} - ${reason}`);
        console.log(`   æ€»æ—¶é•¿: ${Math.floor(totalPracticeTime/60)}åˆ†${totalPracticeTime%60}ç§’`);
        console.log(`   æ®µå†…: ${Math.floor(session.inSlotTime/60)}åˆ†${session.inSlotTime%60}ç§’`);
        console.log(`   æ®µå¤–: ${Math.floor(session.outSlotTime/60)}åˆ†${session.outSlotTime%60}ç§’`);
    }
    
    // ä»è·Ÿè¸ªå™¨ä¸­ç§»é™¤
    practiceSessionTracker.delete(sessionId);
    
    return session;
}

/**
 * é‡æ–°ç²¾ç¡®è®¡ç®—ä¼šè¯çš„æ—¶é—´æ®µå†…å¤–æ—¶é•¿
 */
function recalculateSessionTimes(session) {
    if (!session.actualStartTime || !session.endTime) return;
    
    const studentSlots = getStudentTodaySlots(session.studentName);
    let inSlotTime = 0;
    let outSlotTime = 0;
    
    // æŒ‰åˆ†é’Ÿç²¾ç¡®è®¡ç®—
    const startMinute = Math.floor(session.actualStartTime / 60000) * 60000;
    const endMinute = Math.floor(session.endTime / 60000) * 60000;
    
    for (let time = startMinute; time < endMinute; time += 60000) {
        const slot = findCurrentTimeSlot(studentSlots, time);
        if (slot) {
            inSlotTime += 60;
        } else {
            outSlotTime += 60;
        }
    }
    
    // å¤„ç†æœ€åä¸è¶³ä¸€åˆ†é’Ÿçš„éƒ¨åˆ†
    const remainingSeconds = Math.floor((session.endTime - session.actualStartTime) / 1000) % 60;
    const lastSlot = findCurrentTimeSlot(studentSlots, session.endTime);
    if (lastSlot) {
        inSlotTime += remainingSeconds;
    } else {
        outSlotTime += remainingSeconds;
    }
    
    session.inSlotTime = inSlotTime;
    session.outSlotTime = outSlotTime;
}

/**
 * è®°å½•åˆ°æ—¥å¸¸ç»ƒä¹ è®°å½•
 */
function recordDailyPractice(session) {
    const dateKey = toDateKey(new Date(session.startTime));
    
    if (!dailyPracticeRecords[dateKey]) {
        dailyPracticeRecords[dateKey] = {};
    }
    
    if (!dailyPracticeRecords[dateKey][session.studentName]) {
        dailyPracticeRecords[dateKey][session.studentName] = {
            inSlot: 0,
            outSlot: 0,
            totalSessions: 0,
            sessions: [],
            lastUpdated: Date.now()
        };
    }
    
    const record = dailyPracticeRecords[dateKey][session.studentName];
    record.inSlot += session.inSlotTime;
    record.outSlot += session.outSlotTime;
    record.totalSessions++;
    record.lastUpdated = Date.now();
    
    // è®°å½•ä¼šè¯è¯¦æƒ…
    record.sessions.push({
        sessionId: session.sessionId,
        roomName: session.roomName,
        startTime: session.startTime,
        endTime: session.endTime,
        inSlotTime: session.inSlotTime,
        outSlotTime: session.outSlotTime,
        endReason: session.endReason,
        slotTransitions: session.slotTransitions.length
    });
    
    // æŒä¹…åŒ–
    persistPracticeRecords();
    
    // åŒæ­¥åˆ°Firebase
    syncPracticeRecordsToFirebase(dateKey, session.studentName);
    
    console.log(`ğŸ“Š è®°å½•æ—¥å¸¸ç»ƒä¹ : ${session.studentName} ${dateKey}`);
    console.log(`   ç´¯è®¡æ®µå†…: ${Math.floor(record.inSlot/60)}åˆ† æ®µå¤–: ${Math.floor(record.outSlot/60)}åˆ†`);
}

/**
 * è·å–å­¦ç”Ÿä»Šæ—¥æ—¶é—´æ®µ
 */
function getStudentTodaySlots(studentName) {
    const now = new Date();
    const weekday = WEEK_MAP[now.getDay()];
    if (!weekday || !studentTimeSlots[studentName]) return [];
    
    return studentTimeSlots[studentName][weekday] || [];
}

/**
 * æŸ¥æ‰¾å½“å‰æ—¶é—´æ‰€åœ¨çš„æ—¶é—´æ®µ
 */
function findCurrentTimeSlot(slots, timestamp) {
    const date = new Date(timestamp);
    const currentMinutes = date.getHours() * 60 + date.getMinutes();
    
    return slots.find(slot => {
        const startMin = timeToMinutes(slot.start);
        const endMin = timeToMinutes(slot.end);
        return currentMinutes >= startMin && currentMinutes < endMin;
    });
}

/**
 * è·å–å­¦ç”ŸæŒ‡å®šæ—¥æœŸçš„ç»ƒä¹ è®°å½•
 */
function getStudentPracticeRecord(studentName, dateKey = null) {
    if (!dateKey) dateKey = todayKey();
    
    return dailyPracticeRecords[dateKey]?.[studentName] || {
        inSlot: 0,
        outSlot: 0,
        totalSessions: 0,
        sessions: [],
        lastUpdated: 0
    };
}

/**
 * è·å–å­¦ç”Ÿæœ€è¿‘å‡ å¤©çš„ç»ƒä¹ ç»Ÿè®¡
 */
function getStudentPracticeStats(studentName, days = 7) {
    const stats = {
        totalDays: 0,
        totalInSlot: 0,
        totalOutSlot: 0,
        totalSessions: 0,
        dailyDetails: []
    };
    
    const today = new Date();
    for (let i = 0; i < days; i++) {
        const date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
        const dateKey = toDateKey(date);
        const record = getStudentPracticeRecord(studentName, dateKey);
        
        if (record.totalSessions > 0) {
            stats.totalDays++;
            stats.totalInSlot += record.inSlot;
            stats.totalOutSlot += record.outSlot;
            stats.totalSessions += record.totalSessions;
            
            stats.dailyDetails.push({
                date: dateKey,
                inSlot: record.inSlot,
                outSlot: record.outSlot,
                sessions: record.totalSessions
            });
        }
    }
    
    return stats;
}

/**
 * æŒä¹…åŒ–ç»ƒä¹ è®°å½•
 */
function persistPracticeRecords() {
    lsSet('dailyPracticeRecords', dailyPracticeRecords);
}

/**
 * åŒæ­¥ç»ƒä¹ è®°å½•åˆ°Firebase
 */
function syncPracticeRecordsToFirebase(dateKey, studentName) {
    if (!isOnline || !syncEnabled || !database) return;
    
    const now = Date.now();
    if (now - lastPracticeSync < 5000) return;
    
    lastPracticeSync = now;
    
    const record = dailyPracticeRecords[dateKey]?.[studentName];
    if (!record) return;
    
    // é™åˆ¶ä¼šè¯è®°å½•æ•°é‡
    const MAX_SESSION_KEEP = 50;
    let sessions = record.sessions || [];
    
    if (sessions.length > MAX_SESSION_KEEP) {
        sessions = sessions.slice(-MAX_SESSION_KEEP);
        record.sessions = sessions;
    }
    
    // ğŸ”¥ ä¿æŒåŸå§‹æ•°æ®ç»“æ„ï¼Œä¸åšå­—æ®µè½¬æ¢
    const syncData = {
        studentName,
        dateKey,
        inSlotSeconds: record.inSlot,
        outSlotSeconds: record.outSlot,
        totalSessions: record.totalSessions,
        lastUpdated: record.lastUpdated,
        syncTime: now,
        sessions: sessions,  // ğŸ”¥ ä¿æŒåŸå§‹çš„ start/end å­—æ®µ
        // ğŸ”¥ å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ·»åŠ å…ƒæ•°æ®è¯´æ˜å‡†å¤‡æœŸå¤„ç†æ–¹å¼
        metadata: {
            preparationPeriodSec: 60,
            note: "sessions contain raw start/end times including preparation period"
        }
    };
    
    database.ref(`${FIREBASE_PATHS.PRACTICE_RECORDS}/${dateKey}/${studentName}`)
        .update(syncData)
        .then(() => {
            console.log(`âœ… ç»ƒä¹ è®°å½•å·²åŒæ­¥: ${studentName} ${dateKey}`);
        })
        .catch(error => {
            console.error('âŒ ç»ƒä¹ è®°å½•åŒæ­¥å¤±è´¥:', error);
        });
}


/**
 * æ ¼å¼åŒ–ç»ƒä¹ æ—¶é•¿æ˜¾ç¤º
 */
function formatPracticeTime(seconds) {
    if (seconds <= 0) return '0åˆ†é’Ÿ';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    let result = '';
    if (hours > 0) result += `${hours}å°æ—¶`;
    if (minutes > 0) result += `${minutes}åˆ†é’Ÿ`;
    if (secs > 0 && hours === 0) result += `${secs}ç§’`;
    
    return result || '0åˆ†é’Ÿ';
}

/**
 * å¯¼å‡ºå­¦ç”Ÿç»ƒä¹ æ—¶é•¿æŠ¥å‘Š
 */
function exportStudentPracticeReport(studentName = null, days = 7) {
    const today = new Date();
    const students = studentName ? [studentName] : Object.keys(studentDatabase).flatMap(major => 
        studentDatabase[major].map(s => getStudentName(s))
    );
    
    let csvContent = 'å­¦ç”Ÿå§“å,æ—¥æœŸ,æ—¶é—´æ®µå†…ç»ƒä¹ (åˆ†é’Ÿ),æ—¶é—´æ®µå¤–ç»ƒä¹ (åˆ†é’Ÿ),æ€»ç»ƒä¹ æ—¶é•¿(åˆ†é’Ÿ),ç»ƒç´æ¬¡æ•°,ä¸“ä¸š\n';
    
    students.forEach(student => {
        const major = getStudentMajor(student);
        
        for (let i = 0; i < days; i++) {
            const date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
            const dateKey = toDateKey(date);
            const record = getStudentPracticeRecord(student, dateKey);
            
            if (record.totalSessions > 0) {
                const inSlotMin = Math.floor(record.inSlot / 60);
                const outSlotMin = Math.floor(record.outSlot / 60);
                const totalMin = inSlotMin + outSlotMin;
                
                csvContent += `${escapeCSV(student)},${dateKey},${inSlotMin},${outSlotMin},${totalMin},${record.totalSessions},${escapeCSV(major)}\n`;
            }
        }
    });
    
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `å­¦ç”Ÿç»ƒä¹ æ—¶é•¿æŠ¥å‘Š_${todayKey()}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('âœ… ç»ƒä¹ æ—¶é•¿æŠ¥å‘Šå·²å¯¼å‡º', 3000);
}

/* =============== 11. è€ƒå‹¤ç³»ç»Ÿï¼ˆèšåˆç‰ˆæœ€ç»ˆæ•´åˆï¼‰ =============== */
let attendanceRealTimeInterval = null;
let isAttendanceModalOpen = false;
/**
 * ğŸ”¥ ä¿®å¤ï¼šå®‰å…¨çš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°
 */
function safeString(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value);
}

/**
 * ğŸ”¥ ä¿®å¤ï¼šå®‰å…¨çš„ trim å‡½æ•°
 */
function safeTrim(value) {
    return safeString(value).trim();
}
function initAttendanceCheck() {
    // æ¯5åˆ†é’Ÿåˆ·æ–°ï¼Œé¡µé¢åŠ è½½å2ç§’é¦–æ¬¡è®¡ç®—
    setInterval(checkAttendance, 5 * 60 * 1000);
    setTimeout(checkAttendance, 2000);
}

/* ===== å¯è°ƒå¸¸é‡ ===== */
const ATTEND_BUFFER_MIN = 5; // èšåˆæ®µé¦–ç¼“å†²åˆ†é’Ÿ

/* ===== å·¥å…·å‡½æ•° ===== */
function fmtPracticeSec(sec) {
    if (sec <= 0) return '0åˆ†';
    const m = Math.floor(sec / 60), s = sec % 60;
    if (m && s) return `${m}åˆ†${s}ç§’`;
    if (m) return `${m}åˆ†`;
    return `${s}ç§’`;
}
function getCurrentOvertimeCount(){
  const now = Date.now();
  const limit = systemSettings.basePracticeDuration * 60 * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
  let count = 0;
  
  rooms.forEach(r => {
    if(!r.student) return;
    const prepEnd = r.registerTime + 60000;
    if(now <= prepEnd) return; // è¿˜åœ¨å‡†å¤‡é˜¶æ®µ
    
    const usedMs = now - prepEnd;
    if(usedMs > limit) {
      count++; // å½“å‰æ­£åœ¨è¶…æ—¶
    }
  });
  
  return count;
}
// å…¼å®¹ï¼šæŸäº›å‡½æ•°é‡Œè°ƒç”¨äº† getTodayDateStringï¼Œè¿™é‡Œè¡¥ä¸€ä¸ªåˆ«å
function getTodayDateString() {
  return todayKey(); // todayKey å·²ç»è¿”å› YYYY-MM-DD
}

// =====================
// è®¡ç®—æŸå­¦ç”Ÿåœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…çš„ç»ƒç´æƒ…å†µ
// è¿”å› { seconds, inPreparingSlot }
// seconds: å·²è®¡å…¥ï¼ˆå»æ‰å‡†å¤‡æœŸï¼‰çš„æœ‰æ•ˆç»ƒç´ç§’æ•°
// inPreparingSlot: å­¦ç”Ÿå·²åœ¨æˆ¿é—´ä¸”å½“å‰æ—¶é—´ä½äº slot å†…ï¼Œä½†ä»æœªè¿‡å‡†å¤‡æœŸï¼ˆç”¨äºåç»­ä¸åˆ¤ç¼ºå‹¤ï¼‰
// =====================
function getStudentPracticeTimeInSlot(studentName, slot, dateStr, registerTimeMs) {
  if(!dateStr) dateStr = todayKey();
  try {
    if (!slot || !slot.start || !slot.end) {
      return { seconds: 0, inPreparingSlot: false };
    }

    // å½“å‰æ—¶é—´ï¼ˆåªç”¨äºå½“å¤©ï¼›å†å²å›æ”¾å¯æ ¹æ®éœ€è¦ä¼ å…¥ä¸€ä¸ªå›ºå®šæ—¶é—´ï¼‰
    const now = Date.now();
    const todayStr = getTodayDateString();
    const isToday = (dateStr === todayStr);

    // å¦‚æœä¸æ˜¯ä»Šå¤©ï¼Œæˆ‘ä»¬ç”¨è¯¥æ—¥ slot ç»“æŸæ—¶é—´åšâ€œè§‚å¯Ÿæ—¶é—´ç‚¹â€
    const observeNow = isToday ? now : new Date(dateStr + 'T' + slot.end + ':00').getTime();

    // æ²¡æœ‰ registerTimeï¼ˆä¸åœ¨æˆ¿é—´ / æ²¡å¼€å§‹ï¼‰
    if (!registerTimeMs || isNaN(registerTimeMs)) {
      return { seconds: 0, inPreparingSlot: false };
    }

    const prepEnd = registerTimeMs + 60000; // 1 åˆ†é’Ÿå‡†å¤‡
    const slotStartMs = new Date(`${dateStr}T${slot.start}:00`).getTime();
    const slotEndMs = new Date(`${dateStr}T${slot.end}:00`).getTime();

    // æœªè¿›å…¥è¯¥æ—¶é—´æ®µ
    if (observeNow <= slotStartMs) {
      return { seconds: 0, inPreparingSlot: false };
    }

    // å·²ç»è¿‡äº†æ—¶é—´æ®µ
    if (observeNow >= slotEndMs && registerTimeMs >= slotEndMs) {
      // å…¥æˆ¿æ¯”æ®µç»“æŸè¿˜æ™š
      return { seconds: 0, inPreparingSlot: false };
    }

    // æƒ…å½¢ä¸€ï¼šè¿›å…¥æ®µå†…ä½†ä»åœ¨å‡†å¤‡æœŸ
    if (observeNow < prepEnd && observeNow > slotStartMs) {
      return { seconds: 0, inPreparingSlot: true };
    }

    // è®¡ç®—æœ‰æ•ˆå¼€å§‹æ—¶é—´ï¼ˆç•¥è¿‡å‡†å¤‡æœŸ & ä¸æ—©äº slotStartï¼‰
    const effectiveStart = Math.max(prepEnd, slotStartMs);

    // è§‚å¯Ÿç‚¹ä¸åº”è¶…è¿‡ slotEnd
    const effectiveObserve = Math.min(observeNow, slotEndMs);

    if (effectiveObserve <= effectiveStart) {
      // å¯èƒ½æ˜¯ï¼šå‡†å¤‡æœŸè¿˜æ²¡ç»“æŸ æˆ– slot å¾ˆçŸ­
      return {
        seconds: 0,
        inPreparingSlot: (observeNow > slotStartMs && observeNow <= prepEnd)
      };
    }

    const seconds = Math.max(0, Math.floor((effectiveObserve - effectiveStart) / 1000));
    return {
      seconds,
      inPreparingSlot: false
    };
  } catch (e) {
    console.error('getStudentPracticeTimeInSlot é”™è¯¯', e);
    return { seconds: 0, inPreparingSlot: false };
  }
}


/* å®æ—¶çŠ¶æ€ */
function getStudentAttendanceStatus(student) {
    const r = rooms.find(x => x.student === student);
    if (r) {
        const now = Date.now();
        const prepEnd = r.registerTime + 60000;
        if (now < prepEnd) return { presence: 'practicing', label: 'å‡†å¤‡ä¸­', room: r.name };
        const usedSec = Math.floor((now - prepEnd) / 1000);
        const limit = systemSettings.basePracticeDuration * 60;
        if (usedSec <= limit) return { presence: 'practicing', label: 'ç»ƒç´ä¸­', room: r.name };
        return { presence: 'practicing', label: 'è¶…æ—¶ç»ƒç´', room: r.name };
    }
    if (queueList.grand.includes(student))
        return { presence: 'queuing', label: `ä¸‰è§’æ’é˜Ÿç¬¬${queueList.grand.indexOf(student) + 1}ä½`, room: 'æ’é˜Ÿ' };
    if (queueList.upright.includes(student))
        return { presence: 'queuing', label: `ç«‹å¼æ’é˜Ÿç¬¬${queueList.upright.indexOf(student) + 1}ä½`, room: 'æ’é˜Ÿ' };
    if (queueList.none.includes(student))
        return { presence: 'queuing', label: `æ™®é€šæ’é˜Ÿç¬¬${queueList.none.indexOf(student) + 1}ä½`, room: 'æ’é˜Ÿ' };
    return { presence: 'absent', label: 'ç¼ºå‹¤', room: 'ä¸åœ¨ç´æˆ¿' };
}

// ğŸ”¥ ç»Ÿä¸€çš„è€ƒå‹¤çŠ¶æ€è®¡ç®—å‡½æ•°
function calculateAttendanceStatus(student, slot, realtimeStatus, practicedSec, opts = {}) {
  // ---- æ•°å€¼é˜²å¾¡ ----
  practicedSec = Number(practicedSec);
  if (isNaN(practicedSec) || practicedSec < 0) practicedSec = 0;

  // å¯é€‰é…ç½®
  const {
    lowEffImmediate = false,     // true: è¿›è¡Œä¸­åªè¦ >0 ä¸” <60% å°±ç«‹åˆ» low_efficiency
    lowEffReviewRatio = 0.3,     // false æƒ…å†µä¸‹ï¼šå…ˆ under_reviewï¼Œè¶…è¿‡è¯¥æ¯”ä¾‹ä»æœªåˆ° 60% åˆ¤ä½æ•ˆ
    dynamicThresholdEnabled = true // æ˜¯å¦å¯ç”¨åŠ¨æ€é˜ˆå€¼
  } = opts;

  // ğŸ”¥ ç»Ÿä¸€çš„æ—¶é—´è®¡ç®—
  const now = Date.now();
  const slotStartMs = new Date(`${getTodayDateString()}T${slot.start}:00`).getTime();
  const slotEndMs = new Date(`${getTodayDateString()}T${slot.end}:00`).getTime();
  const slotDurationSec = Math.floor((slotEndMs - slotStartMs) / 1000);
  
  // ğŸ”¥ è®¡ç®—æœ‰æ•ˆæ—¶é•¿ï¼ˆä¼˜å…ˆä½¿ç”¨ effectiveTotalSecï¼‰
  const effectiveTotalSec = (slot.effectiveTotalSec && slot.effectiveTotalSec > 0)
    ? slot.effectiveTotalSec
    : ((slot.totalPlannedMinutes || 0) * 60);
  
  const efficiencyThresholdSec = Math.floor(effectiveTotalSec * 0.6); // 60% é˜ˆå€¼
  
  // ğŸ”¥ è®¡ç®—ç»ƒç´æ¯”ä¾‹
  let practiceRatio = 0;
  if (effectiveTotalSec > 0) {
    practiceRatio = practicedSec / effectiveTotalSec;
    if (!isFinite(practiceRatio) || isNaN(practiceRatio) || practiceRatio < 0) {
      practiceRatio = 0;
    }
    // é™åˆ¶æœ€å¤§ä¸º 100%
    if (practiceRatio > 1) practiceRatio = 1;
  }

  const practicedMin = Math.floor(practicedSec / 60);
  const isFinished = (now >= slotEndMs);
  const isNotStartedYet = (now < slotStartMs);
  const slotElapsedSec = isNotStartedYet ? 0 : Math.min(slotDurationSec, Math.floor((now - slotStartMs) / 1000));
  
  // ğŸ”¥ æ£€æŸ¥æ˜¯å¦åœ¨å‡†å¤‡æœŸ
  const inPreparingSlot = realtimeStatus.presence === 'practicing' && 
                         (realtimeStatus.label?.includes('å‡†å¤‡ä¸­') || realtimeStatus.label?.includes('å‡†å¤‡æœŸ'));

  const practicedText = practicedSec > 0
    ? `${practicedMin}åˆ†é’Ÿ`
    : (inPreparingSlot ? 'å‡†å¤‡ä¸­' : '0åˆ†é’Ÿ');

  // ğŸ”¥ æœªå¼€å§‹çš„æ—¶é—´æ®µ
  if (isNotStartedYet || slot.slotPhase === 'future') {
    return {
      finalAttendanceStatus: 'under_review',
      finalStatusText: 'æœªå¼€å§‹',
      practiceRatio,
      practicedText,
      practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ` +
        (slot.segments && slot.segments.length > 1 ? ` (åˆå¹¶${slot.segments.length}æ®µ)` : '')
    };
  }

  // ğŸ”¥ ç¼“å†²æœŸç‰¹æ®Šå¤„ç†
  if (slot.slotPhase === 'pre-buffer') {
    if (practicedSec <= 0) {
      // ç¼“å†²æœŸå†…æ— ç»ƒç´è®°å½•
      if (realtimeStatus.presence === 'queuing') {
        return {
          finalAttendanceStatus: 'under_review',
          finalStatusText: 'æ’é˜Ÿä¸­(ç¼“å†²æœŸ)',
          practiceRatio,
          practicedText,
          practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
        };
      }
      return {
        finalAttendanceStatus: 'absent',
        finalStatusText: 'ç¼ºå‹¤(ç¼“å†²æœŸ)',
        practiceRatio,
        practicedText,
        practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
      };
    } else {
      return {
        finalAttendanceStatus: 'under_review',
        finalStatusText: 'ç¼“å†²è§‚å¯Ÿ',
        practiceRatio,
        practicedText,
        practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
      };
    }
  }

  // ğŸ”¥ æ®µå†…å‡†å¤‡æœŸ
  if (inPreparingSlot && realtimeStatus.presence === 'practicing') {
    const statusText = slot.slotPhase === 'active' ? 'å‡†å¤‡ä¸­(æ­£å¼æ—¶æ®µ)' : 'å‡†å¤‡ä¸­';
    return {
      finalAttendanceStatus: 'under_review',
      finalStatusText: statusText,
      practiceRatio,
      practicedText,
      practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
    };
  }

  // ğŸ”¥ æ’é˜ŸçŠ¶æ€çš„ç‰¹æ®Šå¤„ç†
  if (realtimeStatus.presence === 'queuing' && !isFinished) {
    let queueStatusText = 'æ’é˜Ÿä¸­';
    if (practicedSec > 0) {
      queueStatusText = `æ’é˜Ÿä¸­(å·²ç»ƒ${practicedMin}åˆ†)`;
    } else if (slot.slotPhase === 'active') {
      queueStatusText = 'æ’é˜Ÿä¸­(å¾…è§‚å¯Ÿ)';
    }
    
    return {
      finalAttendanceStatus: 'under_review',
      finalStatusText: queueStatusText,
      practiceRatio,
      practicedText,
      practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
    };
  }

  // ğŸ”¥ è¿›è¡Œä¸­ï¼ˆæœªç»“æŸï¼‰
  if (!isFinished && slot.slotPhase === 'active') {
    // äººä¸åœ¨æˆ¿é—´ä¸”æ— ç»ƒç´è®°å½•
    if (realtimeStatus.presence !== 'practicing' && practicedSec === 0) {
      return {
        finalAttendanceStatus: 'absent',
        finalStatusText: 'ç¼ºå‹¤(æœªå¼€å§‹)',
        practiceRatio,
        practicedText,
        practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
      };
    }

    // ğŸ”¥ åŠ¨æ€é˜ˆå€¼è®¡ç®—
    let currentThreshold = efficiencyThresholdSec;
    if (dynamicThresholdEnabled) {
      currentThreshold = Math.min(
        efficiencyThresholdSec,
        Math.max(60, Math.floor(slotElapsedSec * 0.6)) // æ—©æœŸåˆ«å¤ªä¸¥ï¼šè‡³å°‘ 60 ç§’
      );
    }

    // æ»¡è¶³é˜ˆå€¼ï¼šç›´æ¥å‡ºå‹¤
    if (practicedSec >= currentThreshold) {
      return {
        finalAttendanceStatus: 'present',
        finalStatusText: `å‡ºå‹¤ ${(practiceRatio * 100).toFixed(1)}%`,
        practiceRatio,
        practicedText,
        practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
      };
    }

    // æœªè¾¾åˆ°é˜ˆå€¼ä½†æœ‰ç»ƒç´è®°å½•
    if (practicedSec > 0) {
      if (lowEffImmediate) {
        return {
          finalAttendanceStatus: 'low_efficiency',
          finalStatusText: `ä½æ•ˆ ${(practiceRatio * 100).toFixed(1)}%`,
          practiceRatio,
          practicedText,
          practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
        };
      } else {
        // ç­‰è¿‡äº†ä¸€å®šçš„å·²è¿‡æ—¶æ®µæ¯”ä¾‹å†ç»™ä½æ•ˆï¼Œå¦åˆ™ç»§ç»­è§‚å¯Ÿ
        const elapsedRatio = slotDurationSec > 0 ? slotElapsedSec / slotDurationSec : 0;
        if (elapsedRatio >= lowEffReviewRatio) {
          return {
            finalAttendanceStatus: 'low_efficiency',
            finalStatusText: `ä½æ•ˆ ${(practiceRatio * 100).toFixed(1)}%`,
            practiceRatio,
            practicedText,
            practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
          };
        }
        return {
          finalAttendanceStatus: 'under_review',
          finalStatusText: 'è¿›è¡Œä¸­',
          practiceRatio,
          practicedText,
          practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
        };
      }
    }

    // å®Œå…¨æ— ç»ƒç´è®°å½•
    return {
      finalAttendanceStatus: 'under_review',
      finalStatusText: 'è¿›è¡Œä¸­',
      practiceRatio,
      practicedText,
      practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
    };
  }

  // ğŸ”¥ å·²ç»“æŸï¼šæœ€ç»ˆåˆ¤å®š
  if (isFinished || slot.slotPhase === 'ended') {
    if (practicedSec <= 0) {
      return {
        finalAttendanceStatus: 'absent',
        finalStatusText: 'ç¼ºå‹¤(å·²ç»“æŸ)',
        practiceRatio,
        practicedText,
        practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
      };
    }

    // è¾¾åˆ° 60% é˜ˆå€¼
    if (practicedSec >= efficiencyThresholdSec) {
      return {
        finalAttendanceStatus: 'present',
        finalStatusText: `å·²å®Œæˆ ${(practiceRatio * 100).toFixed(1)}%`,
        practiceRatio,
        practicedText,
        practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
      };
    }

    // æœ‰ç»ƒç´ä½†æœªè¾¾åˆ° 60%
    return {
      finalAttendanceStatus: 'low_efficiency',
      finalStatusText: `ä½æ•ˆ ${(practiceRatio * 100).toFixed(1)}%`,
      practiceRatio,
      practicedText,
      practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
    };
  }

  // ğŸ”¥ é»˜è®¤æƒ…å†µ
  return {
    finalAttendanceStatus: 'under_review',
    finalStatusText: 'å¾…è§‚å¯Ÿ',
    practiceRatio,
    practicedText,
    practiceDetails: `${practicedMin}åˆ†é’Ÿ / ${slot.totalPlannedMinutes}åˆ†é’Ÿ`
  };
}



/* åˆå¹¶ï¼šå»é™¤è¢«åŒ…å« + end==next.start å½’å¹¶ */
function buildMergedDaySlots(originalDaySlots) {
    if (!Array.isArray(originalDaySlots)) return [];
    const sorted = [...originalDaySlots].sort((a, b) => a.start.localeCompare(b.start));
    const filtered = [];
    sorted.forEach(s => {
        if (!filtered.length) { filtered.push({ ...s }); return; }
        const last = filtered[filtered.length - 1];
        if (last.start <= s.start && last.end >= s.end) {
            // è¢«åŒ…å« -> ä¸¢
        } else filtered.push({ ...s });
    });
    const merged = [];
    filtered.forEach(s => {
        if (!merged.length) {
            merged.push({ start: s.start, end: s.end, segments: [{ ...s }] });
            return;
        }
        const last = merged[merged.length - 1];
        if (last.end === s.start) {
            last.end = s.end;
            last.segments.push({ ...s });
        } else {
            merged.push({ start: s.start, end: s.end, segments: [{ ...s }] });
        }
    });
    return merged;
}

/* ä¸»æ‰«æï¼ˆèšåˆç‰ˆï¼‰ */
// ğŸ”¥ ä¿®å¤ï¼šè€ƒå‹¤æ£€æŸ¥å‡½æ•° - é¿å…é¢‘ç¹åŒæ­¥
function checkAttendance() {
    if (isLocked) return;
    const now = new Date();
    const w = now.getDay();
    if (w === 0 || w === 6) return;
    const weekday = WEEK_MAP[w];
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    // ğŸ”¥ è®¡ç®—æ–°çš„è€ƒå‹¤æ•°æ®
    const newAttendanceData = {
        checkTime: now.toISOString(),
        students: [],
        endedSlots: [],
        futureSlots: []
    };

    Object.keys(studentTimeSlots).forEach(student => {
        const weekly = studentTimeSlots[student];
        if (!weekly || !weekly[weekday] || !weekly[weekday].length) return;

        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šåœ¨è¿™é‡Œå°±è·å–å¹¶ç¼“å­˜ä¸“ä¸šä¿¡æ¯
        const studentMajor = getStudentMajor(student);
        console.log('ğŸ“Š è€ƒå‹¤æ£€æŸ¥ - å­¦ç”Ÿä¸“ä¸š:', student, '->', studentMajor);

        const mergedSlots = buildMergedDaySlots(weekly[weekday]);
        const r = rooms.find(r => r.student === student);
        const inRoomBefore = !!r;

        mergedSlots.forEach(slotBase => {
            const startMin = timeToMinutes(slotBase.start);
            const endMin = timeToMinutes(slotBase.end);
            const totalPlannedMinutes = endMin - startMin;
            if (totalPlannedMinutes <= 0) return;

            let bufferMinutes = ATTEND_BUFFER_MIN;
            if (inRoomBefore && r) {
                const reg = new Date(r.registerTime);
                const regMinutes = reg.getHours() * 60 + reg.getMinutes();
                if (regMinutes <= startMin) bufferMinutes = 0;
            }

            const bufferedStartMin = Math.min(endMin, startMin + bufferMinutes);
            let slotPhase = 'future';
            if (currentMinutes < startMin) slotPhase = 'future';
            else if (currentMinutes >= startMin && currentMinutes < bufferedStartMin) slotPhase = 'pre-buffer';
            else if (currentMinutes >= bufferedStartMin && currentMinutes <= endMin) slotPhase = 'active';
            else slotPhase = 'ended';

            const slotObj = {
                start: slotBase.start,
                end: slotBase.end,
                segments: slotBase.segments,
                bufferMinutes,
                bufferedStart: minutesToTime(bufferedStartMin),
                slotPhase,
                totalPlannedMinutes,
                effectiveTotalSec: Math.max(0, (endMin - (startMin + bufferMinutes)) * 60)
            };

            const practicedObj = getStudentPracticeTimeInSlot(student, slotObj);
            const practicedSec = practicedObj.seconds || 0;   // åªå–ç§’æ•°
            const realtimeStatus = getStudentAttendanceStatus(student);
            const calc = calculateAttendanceStatus(student, slotObj, realtimeStatus, practicedSec);
            const row = {
                name: student,
                major: studentMajor, // ğŸ”¥ ä½¿ç”¨é¢„å…ˆè·å–çš„ä¸“ä¸šä¿¡æ¯
                practicedSec,
                practicedText: fmtPracticeSec(practicedSec),
                presence: realtimeStatus.presence,
                presenceText: realtimeStatus.label,
                room: realtimeStatus.room,
                overrunCountToday: getTodayOverrunCount(student),
                ...slotObj,
                ...calc
            };

            if (slotPhase === 'active' || slotPhase === 'pre-buffer') newAttendanceData.students.push(row);
            else if (slotPhase === 'ended') newAttendanceData.endedSlots.push(row);
            else newAttendanceData.futureSlots.push(row);
        });
    });

    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¿ç•™ç°æœ‰çš„è¯·å‡çŠ¶æ€ï¼Œå¹¶ç¡®ä¿ä¸“ä¸šä¿¡æ¯ä¸ä¸¢å¤±
    if (attendanceData && attendanceData.students) {
        const excusedStudents = new Map();
        
        // æ”¶é›†ç°æœ‰çš„è¯·å‡çŠ¶æ€
        [...attendanceData.students, ...attendanceData.endedSlots].forEach(student => {
            if (student.finalAttendanceStatus === 'excused') {
                const key = `${student.name}_${student.start}_${student.end}`;
                excusedStudents.set(key, {
                    finalAttendanceStatus: student.finalAttendanceStatus,
                    finalStatusText: student.finalStatusText,
                    major: student.major || getStudentMajor(student.name) // ğŸ”¥ ç¡®ä¿ä¸“ä¸šä¿¡æ¯
                });
            }
        });
        
        // åº”ç”¨åˆ°æ–°æ•°æ®ä¸­
        [...newAttendanceData.students, ...newAttendanceData.endedSlots].forEach(student => {
            const key = `${student.name}_${student.start}_${student.end}`;
            if (excusedStudents.has(key)) {
                const excusedState = excusedStudents.get(key);
                student.finalAttendanceStatus = excusedState.finalAttendanceStatus;
                student.finalStatusText = excusedState.finalStatusText;
                // ğŸ”¥ ç¡®ä¿ä¸“ä¸šä¿¡æ¯æ­£ç¡®
                if (excusedState.major && excusedState.major !== 'æœªçŸ¥ä¸“ä¸š') {
                    student.major = excusedState.major;
                }
            }
        });
    }

    // ğŸ”¥ æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿æ‰€æœ‰å­¦ç”Ÿéƒ½æœ‰æ­£ç¡®çš„ä¸“ä¸šä¿¡æ¯
    [...newAttendanceData.students, ...newAttendanceData.endedSlots, ...newAttendanceData.futureSlots].forEach(student => {
        if (!student.major || student.major === 'æœªçŸ¥ä¸“ä¸š') {
            student.major = getStudentMajor(student.name);
            console.log('ğŸ”§ ä¿®å¤å­¦ç”Ÿä¸“ä¸šä¿¡æ¯:', student.name, '->', student.major);
        }
    });

    attendanceData = newAttendanceData;
    checkExpiredExcuses();
    updateAttendanceBadge();
    lastAttendanceCheck = now;
    
    if (isAttendanceModalOpen) {
        renderAttendanceList(false);
    }
}

/* æ¸²æŸ“ */
function renderAttendanceList(force) {
    if (force) {
        checkAttendance();
        setTimeout(() => renderAttendanceList(false), 30);
        return;
    }
    
    const majorF = $('attendanceMajorFilter').value;
    const statusF = $('attendanceStatusFilter').value;
    const container = $('attendanceContent');
    
    // ğŸ”¥ æ·»åŠ å®‰å…¨æ£€æŸ¥
    const listAll = attendanceData.students || [];

    if (!listAll.length) {
        container.innerHTML = '<div class="attendance-empty"><h3>å½“å‰æ—¶é—´æ®µæ— å­¦ç”Ÿéœ€è¦ç»ƒç´</h3><p style="color:#666;">ç¼“å†²æˆ–è¿›è¡Œä¸­çš„èšåˆæ—¶æ®µæ‰ä¼šæ˜¾ç¤ºã€‚</p></div>';
        updateAttendanceSummary([], []);
        return;
    }

    const list = listAll.filter(s => {
        if (majorF && s.major !== majorF) return false;
        if (statusF) {
            if (['absent', 'present', 'low_efficiency', 'under_review', 'excused'].includes(statusF)) {
                if (s.finalAttendanceStatus !== statusF) return false;
            } else if (statusF === 'queuing' && s.presence !== 'queuing') return false;
            else if (statusF === 'practicing' && s.presence !== 'practicing') return false;
            else if (statusF === 'preparing' && s.presenceText !== 'å‡†å¤‡ä¸­') return false;
            else if (statusF === 'overtime' && !s.presenceText.includes('è¶…æ—¶')) return false;
        }
        return true;
    });

    const byMajor = {};
    list.forEach(s => (byMajor[s.major] ||= []).push(s));

    let html = '';
    Object.keys(byMajor).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN')).forEach(m => {
        const arr = byMajor[m];
        const absent = arr.filter(s => s.finalAttendanceStatus === 'absent').length;
        const low = arr.filter(s => s.finalAttendanceStatus === 'low_efficiency').length;
        const exc = arr.filter(s => s.finalAttendanceStatus === 'excused').length;

        html += `<div class="attendance-category">
            <div class="attendance-category-header">
                <span>${m}</span>
                <span class="attendance-category-count">${arr.length}æ®µ(ç¼ºå‹¤${absent} ä½æ•ˆ${low} è¯·å‡${exc})</span>
            </div>
            <div class="attendance-list-header">
                <div>å­¦ç”Ÿ</div><div>é˜¶æ®µ/çŠ¶æ€</div><div>ç»ƒç´æ—¶é—´æ®µ</div>
                <div>æ‰€åœ¨ç´æˆ¿</div><div>å·²ç»ƒ/åº”ç»ƒ</div><div>æ“ä½œ</div>
            </div>
            ${arr.sort((a, b) => {
                const phaseOrder = { active: 0, 'pre-buffer': 1, ended: 2, future: 3 };
                if (phaseOrder[a.slotPhase] !== phaseOrder[b.slotPhase]) return phaseOrder[a.slotPhase] - phaseOrder[b.slotPhase];
                const statusOrder = { present: 0, low_efficiency: 1, under_review: 2, absent: 3, excused: 4 };
                if (statusOrder[a.finalAttendanceStatus] !== statusOrder[b.finalAttendanceStatus]) return statusOrder[a.finalAttendanceStatus] - statusOrder[b.finalAttendanceStatus];
                return a.name.localeCompare(b.name, 'zh-Hans-CN');
            }).map(s => {
                const cls = `attendance-status status-${s.finalAttendanceStatus}`;
                const slotTxt = `${s.start}-${s.end}` +
                    (s.slotPhase === 'pre-buffer' ? `(ç¼“å†²${s.bufferMinutes}åˆ†)` :
                        s.slotPhase === 'active' ? '(è¿›è¡Œä¸­)' : '');
                const segmentsPreview = s.segments.map(seg => `${seg.start}-${seg.end}`).join('ï¼Œ');
                let act = 'â€”';
                if (s.finalAttendanceStatus === 'absent') {
                    act = `<button class="attendance-action-btn btn-excuse" style="background:#3498db;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:12px;" onclick="excuseStudent('${s.name}')">è¯·å‡</button>`;
                } else if (s.finalAttendanceStatus === 'excused') {
                    act = `<button class="attendance-action-btn" style="background:#e67e22;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:12px;" onclick="cancelExcuse('${s.name}')">å–æ¶ˆè¯·å‡</button>`;
                }
                return `<div class="attendance-item ${s.finalAttendanceStatus === 'absent' ? 'absent' : ''}">
                    <div>${s.name}</div>
                    <div><span class="${cls}">${s.finalStatusText}${s.slotPhase === 'pre-buffer' ? ' / ç¼“å†²' : ''}</span></div>
                    <div title="å­æ®µ: ${segmentsPreview}">${slotTxt}</div>
                    <div>${s.room}</div>
                    <div title="${s.practiceDetails}">${s.practiceDetails}</div>
                    <div>${act}</div>
                </div>`;
            }).join('')}
        </div>`;
    });

    container.innerHTML = html || '<div class="attendance-empty">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿ</div>';
    updateAttendanceSummary(listAll, list);
}

/* æ±‡æ€» */
function updateAttendanceSummary(allActive, _shown) {
    const box = $('attendanceSummary');
    // ğŸ”¥ æ·»åŠ å®‰å…¨æ£€æŸ¥
    allActive = allActive || [];
    const effective = allActive.filter(s => s.slotPhase === 'active' && s.finalAttendanceStatus !== 'excused');
    const total = effective.length;
    const present = effective.filter(s => s.finalAttendanceStatus === 'present').length;
    const low = effective.filter(s => s.finalAttendanceStatus === 'low_efficiency').length;
    const absent = effective.filter(s => s.finalAttendanceStatus === 'absent').length;
    const under = effective.filter(s => s.finalAttendanceStatus === 'under_review').length;
    const exc = allActive.filter(s => s.finalAttendanceStatus === 'excused').length;
    const rate = total ? ((present + low) / total * 100).toFixed(1) : '0.0';
    const overrunTotal = getCurrentOvertimeCount(); // ä½¿ç”¨å®æ—¶è¶…æ—¶æ•°é‡

    box.innerHTML = `
        <div class="attendance-summary-item"><div class="attendance-summary-number total-count">${total}</div><div class="attendance-summary-label">åº”åˆ°äººæ•°</div></div>
        <div class="attendance-summary-item"><div class="attendance-summary-number present-count">${present}</div><div class="attendance-summary-label">æ­£å¸¸</div></div>
        <div class="attendance-summary-item"><div class="attendance-summary-number" style="color:#f39c12;">${low}</div><div class="attendance-summary-label">ä½æ•ˆ</div></div>
        <div class="attendance-summary-item"><div class="attendance-summary-number absent-count">${absent}</div><div class="attendance-summary-label">ç¼ºå‹¤</div></div>
        <div class="attendance-summary-item"><div class="attendance-summary-number" style="color:#3498db;">${under}</div><div class="attendance-summary-label">å¾…è§‚å¯Ÿ</div></div>
        <div class="attendance-summary-item"><div class="attendance-summary-number" style="color:#95a5a6;">${exc}</div><div class="attendance-summary-label">è¯·å‡</div></div>
        <div class="attendance-summary-item"><div class="attendance-summary-number">${rate}%</div><div class="attendance-summary-label">å‡ºå‹¤ç‡</div></div>
        <div class="attendance-summary-item" style="cursor:pointer;" onclick="switchToOvertimeManagement()" title="ç‚¹å‡»æŸ¥çœ‹è¶…æ—¶ç®¡ç†"><div class="attendance-summary-number" style="color:#e74c3c;">${overrunTotal}</div><div class="attendance-summary-label">è¶…æ—¶</div></div>

    `;
}

/* å¾½ç«  */
function updateAttendanceBadge() {
    const badge = $('attendanceBadge');
    if (!badge) return;
    
    // ğŸ”¥ æ·»åŠ å®‰å…¨æ£€æŸ¥
    const students = attendanceData.students || [];
    const problem = students
        .filter(s => ['absent', 'low_efficiency'].includes(s.finalAttendanceStatus) && s.slotPhase === 'active').length;
    
    if (problem) {
        badge.style.display = 'inline-block';
        badge.textContent = problem;
    } else {
        badge.style.display = 'none';
    }
}


/* =============== æ™ºèƒ½æ±‡æ€»è€ƒå‹¤å¯¼å‡ºç³»ç»Ÿï¼ˆä¿®å¤ç‰ˆï¼‰ =============== */

function exportAttendanceReport() {
    if (!attendanceData.students.length && !(attendanceData.endedSlots || []).length) {
        alert('æš‚æ— å¯å¯¼å‡ºçš„è€ƒå‹¤æ•°æ®');
        return;
    }
    
    showSmartExportModal();
}

function showSmartExportModal() {
    const modal = document.createElement('div');
    modal.id = 'smartExportModal';
    modal.style.cssText = 'position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:3000;display:flex;align-items:center;justify-content:center;';
    
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    const weekAgo = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
    const weekAgoStr = weekAgo.toISOString().split('T')[0];
    
    modal.innerHTML = `
        <div style="background:#fff;padding:30px;border-radius:16px;max-width:600px;width:95%;max-height:90vh;overflow-y:auto;">
            <h3 style="margin:0 0 20px;color:var(--primary-color);text-align:center;">ğŸ“Š æ™ºèƒ½è€ƒå‹¤æ±‡æ€»å¯¼å‡º</h3>
            
            <!-- æ—¥æœŸèŒƒå›´é€‰æ‹© -->
            <div class="export-section" style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                <h4 style="margin:0 0 10px;color:#2c3e50;">ğŸ“… æ—¥æœŸèŒƒå›´</h4>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="radio" name="dateRange" value="today" checked>
                        <span>ä»…ä»Šå¤© (${todayStr})</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="radio" name="dateRange" value="yesterday">
                        <span>æ˜¨å¤©</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="radio" name="dateRange" value="week">
                        <span>æœ€è¿‘7å¤© (${weekAgoStr} è‡³ ${todayStr})</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="radio" name="dateRange" value="custom">
                        <span>è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´</span>
                    </label>
                </div>
                
                <!-- è‡ªå®šä¹‰æ—¥æœŸè¾“å…¥ -->
                <div id="customDateInputs" style="display:none;margin-top:10px;padding:10px;background:#fff;border-radius:6px;border:1px solid #ddd;">
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                        <label>å¼€å§‹æ—¥æœŸï¼š<input type="date" id="startDate" value="${weekAgoStr}" style="margin-left:5px;"></label>
                        <label>ç»“æŸæ—¥æœŸï¼š<input type="date" id="endDate" value="${todayStr}" style="margin-left:5px;"></label>
                    </div>
                </div>
            </div>
            
            <!-- å†…å®¹ç­›é€‰ -->
            <div class="export-section" style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                <h4 style="margin:0 0 10px;color:#2c3e50;">ğŸ” å†…å®¹ç­›é€‰</h4>
                <div style="display:flex;flex-direction:column;gap:6px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="includeAllStudents" checked>
                        <span>åŒ…å«æ‰€æœ‰å­¦ç”Ÿæ±‡æ€»</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="highlightProblems" checked>
                        <span>çªå‡ºæ˜¾ç¤ºé—®é¢˜å­¦ç”Ÿï¼ˆç¼ºå‹¤/ä½æ•ˆï¼‰</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="includeExcused">
                        <span>åŒ…å«è¯·å‡å­¦ç”Ÿè¯¦æƒ…</span>
                    </label>
                </div>
            </div>
            
            <!-- æŠ¥å‘Šæ ¼å¼ -->
            <div class="export-section" style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                <h4 style="margin:0 0 10px;color:#2c3e50;">ğŸ“‹ æŠ¥å‘Šæ ¼å¼</h4>
                <div style="display:flex;flex-direction:column;gap:6px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="includeSummary" checked>
                        <span>åŒ…å«æ•´ä½“ç»Ÿè®¡æ±‡æ€»</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="includeAnalysis" checked>
                        <span>åŒ…å«é—®é¢˜å­¦ç”Ÿåˆ†æ</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="includePracticeDetails" checked>
                        <span>åŒ…å«è¯¦ç»†ç»ƒç´æ—¶é—´</span>
                    </label>
                </div>
            </div>
            
            <!-- ä¸“ä¸šç­›é€‰ -->
            <div class="export-section" style="margin-bottom:25px;padding:15px;background:#f8f9fa;border-radius:8px;">
                <h4 style="margin:0 0 10px;color:#2c3e50;">ğŸ“ ä¸“ä¸šç­›é€‰</h4>
                <select id="majorFilterExport" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <option value="">æ‰€æœ‰ä¸“ä¸š</option>
                    ${Object.keys(studentDatabase).sort().map(major => 
                        `<option value="${major}">${major}</option>`
                    ).join('')}
                </select>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div style="display:flex;justify-content:flex-end;gap:12px;">
                <button id="cancelExportBtn" style="padding:10px 20px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;">å–æ¶ˆ</button>
                <button id="generateReportBtn" style="padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:6px;cursor:pointer;">ğŸ“Š ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // äº‹ä»¶ç»‘å®š
    modal.addEventListener('change', (e) => {
        if (e.target.name === 'dateRange') {
            const customInputs = modal.querySelector('#customDateInputs');
            if (customInputs) {
                customInputs.style.display = e.target.value === 'custom' ? 'block' : 'none';
            }
        }
    });
    
    const cancelBtn = modal.querySelector('#cancelExportBtn');
    const generateBtn = modal.querySelector('#generateReportBtn');
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            closeSmartExportModal();
        });
    }
    
    if (generateBtn) {
        generateBtn.addEventListener('click', () => {
            executeSmartExport();
        });
    }
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeSmartExportModal();
        }
    });
}

function closeSmartExportModal() {
    const modal = document.getElementById('smartExportModal');
    if (modal) document.body.removeChild(modal);
}

function executeSmartExport() {
    const modal = document.getElementById('smartExportModal');
    
    // æ”¶é›†ç­›é€‰æ¡ä»¶
    const filters = {
        dateRange: modal.querySelector('input[name="dateRange"]:checked').value,
        startDate: modal.querySelector('#startDate').value,
        endDate: modal.querySelector('#endDate').value,
        includeAllStudents: modal.querySelector('#includeAllStudents').checked,
        highlightProblems: modal.querySelector('#highlightProblems').checked,
        includeExcused: modal.querySelector('#includeExcused').checked,
        includeSummary: modal.querySelector('#includeSummary').checked,
        includeAnalysis: modal.querySelector('#includeAnalysis').checked,
        includePracticeDetails: modal.querySelector('#includePracticeDetails').checked,
        majorFilter: modal.querySelector('#majorFilterExport').value
    };
    
    closeSmartExportModal();
    generateSmartAttendanceReport(filters);
}

function generateSmartAttendanceReport(filters) {
    // ç¡®å®šæ—¥æœŸèŒƒå›´
    const dateRange = getDateRange(filters);
    
    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šæ”¶é›†æ±‡æ€»æ•°æ®è€Œéè¯¦ç»†è®°å½•
    const reportData = collectAggregatedAttendanceData(dateRange, filters);
    
    // ç”ŸæˆCSVæŠ¥å‘Š
    let csv = generateReportHeader(dateRange, filters);
    
    if (filters.includeSummary) {
        csv += generateSummarySection(reportData, dateRange);
    }
    
    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šå§‹ç»ˆä½¿ç”¨æ±‡æ€»æ¨¡å¼
    csv += generateStudentAggregatedReport(reportData, filters, dateRange);
    
    if (filters.includeAnalysis) {
        csv += generateProblemAnalysis(reportData, dateRange);
    }
    
    // å¯¼å‡ºæ–‡ä»¶
    exportCSVFile(csv, `è€ƒå‹¤æ±‡æ€»æŠ¥å‘Š_${dateRange.startStr}_${dateRange.endStr}.csv`);
    
    showToast('âœ… è€ƒå‹¤æ±‡æ€»æŠ¥å‘Šå·²å¯¼å‡º', 3000);
}

// ğŸ”¥ æ–°å¢ï¼šæ”¶é›†æ±‡æ€»è€ƒå‹¤æ•°æ®
function collectAggregatedAttendanceData(dateRange, filters) {
    const data = {
        studentSummaries: new Map(),
        dailyStats: {},
        problemStudents: {
            consecutive: [],
            lowEfficiency: [],
            frequent: []
        }
    };
    
    // æ”¶é›†å½“å‰è€ƒå‹¤æ•°æ®
    const currentData = [...(attendanceData.students || []), ...(attendanceData.endedSlots || [])];
    
    // ğŸ”¥ è°ƒè¯•ï¼šæ£€æŸ¥åŸå§‹æ•°æ®ä¸­çš„ä¸“ä¸šä¿¡æ¯
    console.log('ğŸ“Š åŸå§‹è€ƒå‹¤æ•°æ®ä¸“ä¸šåˆ†å¸ƒ:');
    const majorCount = {};
    currentData.forEach(record => {
        const major = record.major || 'æœªè®¾ç½®';
        majorCount[major] = (majorCount[major] || 0) + 1;
        if (!record.major || record.major === 'æœªçŸ¥ä¸“ä¸š') {
            console.warn('âš ï¸ å‘ç°ä¸“ä¸šä¿¡æ¯ç¼ºå¤±:', record.name, record.major);
        }
    });
    console.log('ä¸“ä¸šç»Ÿè®¡:', majorCount);
    
    // æŒ‰ä¸“ä¸šç­›é€‰
    const filteredData = filters.majorFilter 
        ? currentData.filter(s => s.major === filters.majorFilter)
        : currentData;
    
    // ğŸ”¥ å…³é”®ï¼šæŒ‰å­¦ç”Ÿæ±‡æ€»æ•°æ®
    filteredData.forEach(record => {
        const studentName = record.name;
        
        // ğŸ”¥ ç¡®ä¿ä¸“ä¸šä¿¡æ¯æ­£ç¡® - å¤šé‡éªŒè¯
        let studentMajor = record.major;
        if (!studentMajor || studentMajor === 'æœªçŸ¥ä¸“ä¸š') {
            studentMajor = getStudentMajor(studentName);
            console.log('ğŸ”§ é‡æ–°è·å–å­¦ç”Ÿä¸“ä¸š:', studentName, '->', studentMajor);
        }
        
        if (!data.studentSummaries.has(studentName)) {
            data.studentSummaries.set(studentName, {
                name: studentName,
                major: studentMajor, // ğŸ”¥ ä½¿ç”¨éªŒè¯åçš„ä¸“ä¸šä¿¡æ¯
                totalSlots: 0,
                presentSlots: 0,
                lowEfficiencySlots: 0,
                absentSlots: 0,
                excusedSlots: 0,
                underReviewSlots: 0,
                totalPracticeTime: 0,
                totalPlannedTime: 0,
                timeSlots: [],
                overrunCount: record.overrunCountToday || 0,
                finalStatus: 'unknown',
                attendanceRate: 0
            });
        }
        
        const summary = data.studentSummaries.get(studentName);
        
        // ğŸ”¥ ç¡®ä¿ä¸“ä¸šä¿¡æ¯ä¸€è‡´ä¸”æ­£ç¡®
        if (!summary.major || summary.major === 'æœªçŸ¥ä¸“ä¸š') {
            summary.major = studentMajor;
        }
        
        summary.totalSlots++;
        summary.totalPracticeTime += record.practicedSec || 0;
        summary.totalPlannedTime += (record.totalPlannedMinutes || 0) * 60;
        
        // è®°å½•æ—¶é—´æ®µè¯¦æƒ…
        summary.timeSlots.push({
            timeRange: `${record.start}-${record.end}`,
            status: record.finalAttendanceStatus,
            statusText: record.finalStatusText,
            practiceTime: record.practicedSec || 0,
            plannedTime: (record.totalPlannedMinutes || 0) * 60
        });
        
        // ç»Ÿè®¡å„çŠ¶æ€æ•°é‡
        switch (record.finalAttendanceStatus) {
            case 'present':
                summary.presentSlots++;
                break;
            case 'low_efficiency':
                summary.lowEfficiencySlots++;
                break;
            case 'absent':
                summary.absentSlots++;
                break;
            case 'excused':
                summary.excusedSlots++;
                break;
            case 'under_review':
                summary.underReviewSlots++;
                break;
        }
    });
    
    // ğŸ”¥ æœ€ç»ˆéªŒè¯å’Œè®¡ç®—
    data.studentSummaries.forEach((summary, studentName) => {
        // ğŸ”¥ æœ€åä¸€æ¬¡ç¡®ä¿ä¸“ä¸šä¿¡æ¯æ­£ç¡®
        if (!summary.major || summary.major === 'æœªçŸ¥ä¸“ä¸š') {
            summary.major = getStudentMajor(studentName);
            console.log('ğŸ”§ æœ€ç»ˆä¿®å¤ä¸“ä¸šä¿¡æ¯:', studentName, '->', summary.major);
        }
        
        // è®¡ç®—å‡ºå‹¤ç‡ï¼ˆæ’é™¤è¯·å‡ï¼‰
        const effectiveSlots = summary.totalSlots - summary.excusedSlots;
        if (effectiveSlots > 0) {
            summary.attendanceRate = ((summary.presentSlots + summary.lowEfficiencySlots) / effectiveSlots * 100);
        }
        
        // è®¡ç®—ç»ƒç´å®Œæˆç‡
        summary.practiceCompletionRate = summary.totalPlannedTime > 0 
            ? (summary.totalPracticeTime / summary.totalPlannedTime * 100) 
            : 0;
        
        // ç»¼åˆè¯„ä¼°æœ€ç»ˆçŠ¶æ€
        if (summary.excusedSlots === summary.totalSlots) {
            summary.finalStatus = 'excused';
        } else if (summary.absentSlots >= summary.totalSlots * 0.5) {
            summary.finalStatus = 'mostly_absent';
        } else if (summary.attendanceRate >= 80) {
            summary.finalStatus = 'good';
        } else if (summary.attendanceRate >= 60) {
            summary.finalStatus = 'fair';
        } else {
            summary.finalStatus = 'poor';
        }
    });
    
    // ğŸ”¥ è°ƒè¯•ï¼šè¾“å‡ºæœ€ç»ˆçš„ä¸“ä¸šåˆ†å¸ƒ
    console.log('ğŸ“Š æœ€ç»ˆæ±‡æ€»æ•°æ®ä¸“ä¸šåˆ†å¸ƒ:');
    const finalMajorCount = {};
    data.studentSummaries.forEach(summary => {
        const major = summary.major || 'æœªè®¾ç½®';
        finalMajorCount[major] = (finalMajorCount[major] || 0) + 1;
    });
    console.log('æœ€ç»ˆä¸“ä¸šç»Ÿè®¡:', finalMajorCount);
    
    // åˆ†æé—®é¢˜å­¦ç”Ÿ
    data.problemStudents = analyzeProblemStudentsFromSummaries(data.studentSummaries, dateRange);
    
    return data;
}
// ğŸ”¥ æ–°å¢ï¼šç”Ÿæˆå­¦ç”Ÿæ±‡æ€»æŠ¥å‘Š
function generateStudentAggregatedReport(reportData, filters, dateRange) {
    let report = `=== å­¦ç”Ÿè€ƒå‹¤æ±‡æ€»æŠ¥å‘Š ===\n`;
    
    // è¡¨å¤´
    let headers = [
        'å§“å', 'ä¸“ä¸š', 'æ€»æ—¶é—´æ®µæ•°', 'æ­£å¸¸å‡ºå‹¤', 'ä½æ•ˆå‡ºå‹¤', 'ç¼ºå‹¤', 'è¯·å‡', 'å¾…è§‚å¯Ÿ',
        'æœ‰æ•ˆå‡ºå‹¤ç‡', 'æ€»ç»ƒç´æ—¶é•¿', 'æ€»è®¡åˆ’æ—¶é•¿', 'ç»ƒç´å®Œæˆç‡', 'ç»¼åˆè¯„ä¼°'
    ];
    
    if (filters.includePracticeDetails) {
        headers.push('æœªè¿˜å¡æ¬¡æ•°', 'æ—¶é—´æ®µè¯¦æƒ…');
    }
    
    report += headers.join(',') + '\n';
    
    // æŒ‰ä¸“ä¸šå’Œç»¼åˆè¯„ä¼°æ’åº
    const sortedStudents = Array.from(reportData.studentSummaries.values()).sort((a, b) => {
        // å…ˆæŒ‰ä¸“ä¸šæ’åº
        if (a.major !== b.major) return a.major.localeCompare(b.major, 'zh-Hans-CN');
        
        // å†æŒ‰ç»¼åˆè¯„ä¼°æ’åºï¼ˆé—®é¢˜å­¦ç”Ÿä¼˜å…ˆï¼‰
        const statusOrder = { 'poor': 0, 'mostly_absent': 1, 'fair': 2, 'good': 3, 'excused': 4 };
        if (statusOrder[a.finalStatus] !== statusOrder[b.finalStatus]) {
            return statusOrder[a.finalStatus] - statusOrder[b.finalStatus];
        }
        
        // æœ€åæŒ‰å§“åæ’åº
        return a.name.localeCompare(b.name, 'zh-Hans-CN');
    });
    
    sortedStudents.forEach(student => {
        const practiceHours = Math.floor(student.totalPracticeTime / 3600);
        const practiceMinutes = Math.floor((student.totalPracticeTime % 3600) / 60);
        const practiceTimeText = practiceHours > 0 
            ? `${practiceHours}å°æ—¶${practiceMinutes}åˆ†` 
            : `${practiceMinutes}åˆ†é’Ÿ`;
        
        const plannedHours = Math.floor(student.totalPlannedTime / 3600);
        const plannedMinutes = Math.floor((student.totalPlannedTime % 3600) / 60);
        const plannedTimeText = plannedHours > 0 
            ? `${plannedHours}å°æ—¶${plannedMinutes}åˆ†` 
            : `${plannedMinutes}åˆ†é’Ÿ`;
        
        // ç»¼åˆè¯„ä¼°æ–‡æœ¬
        const statusTexts = {
            'good': 'è‰¯å¥½',
            'fair': 'ä¸€èˆ¬',
            'poor': 'è¾ƒå·®',
            'mostly_absent': 'å¤šæ¬¡ç¼ºå‹¤',
            'excused': 'å·²è¯·å‡'
        };
        
        let row = [
            escapeCSV(student.name),
            escapeCSV(student.major),
            student.totalSlots,
            student.presentSlots,
            student.lowEfficiencySlots,
            student.absentSlots,
            student.excusedSlots,
            student.underReviewSlots,
            student.attendanceRate.toFixed(1) + '%',
            practiceTimeText,
            plannedTimeText,
            student.practiceCompletionRate.toFixed(1) + '%',
            statusTexts[student.finalStatus] || 'æœªçŸ¥'
        ];
        
        if (filters.includePracticeDetails) {
            row.push(student.overrunCount);
            
            // æ—¶é—´æ®µè¯¦æƒ…
            const slotDetails = student.timeSlots.map(slot => 
                `${slot.timeRange}(${getStatusShortName(slot.status)})`
            ).join(';');
            row.push(escapeCSV(slotDetails));
        }
        
        report += row.join(',') + '\n';
    });
    
    return report + '\n';
}

// ğŸ”¥ æ–°å¢ï¼šçŠ¶æ€ç®€ç§°æ˜ å°„
function getStatusShortName(status) {
    const mapping = {
        'present': 'æ­£å¸¸',
        'low_efficiency': 'ä½æ•ˆ',
        'absent': 'ç¼ºå‹¤',
        'excused': 'è¯·å‡',
        'under_review': 'è§‚å¯Ÿ'
    };
    return mapping[status] || status;
}

// ğŸ”¥ ä¿®æ”¹ï¼šæ±‡æ€»ç‰ˆçš„ç»Ÿè®¡éƒ¨åˆ†
function generateSummarySection(reportData, dateRange) {
    const summaries = Array.from(reportData.studentSummaries.values());
    const total = summaries.length;
    
    if (total === 0) {
        return `=== æ•´ä½“ç»Ÿè®¡æ±‡æ€» ===\næš‚æ— æ•°æ®\n\n`;
    }
    
    // ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿ä¸“ä¸šä¿¡æ¯æ­£ç¡®
    summaries.forEach(summary => {
        if (!summary.major || summary.major === 'undefined') {
            console.warn('âš ï¸ ä¿®å¤ç©ºä¸“ä¸šä¿¡æ¯:', summary.name);
            summary.major = getStudentMajor(summary.name);
        }
    });
    
    // æŒ‰æœ€ç»ˆçŠ¶æ€ç»Ÿè®¡
    const statusCounts = {
        good: summaries.filter(s => s.finalStatus === 'good').length,
        fair: summaries.filter(s => s.finalStatus === 'fair').length,
        poor: summaries.filter(s => s.finalStatus === 'poor').length,
        mostly_absent: summaries.filter(s => s.finalStatus === 'mostly_absent').length,
        excused: summaries.filter(s => s.finalStatus === 'excused').length
    };
    
    // è®¡ç®—å¹³å‡å‡ºå‹¤ç‡
    const avgAttendanceRate = total > 0 
        ? summaries.reduce((sum, s) => sum + s.attendanceRate, 0) / total 
        : 0;
    
    // è®¡ç®—å¹³å‡ç»ƒç´å®Œæˆç‡
    const avgPracticeRate = total > 0 
        ? summaries.reduce((sum, s) => sum + s.practiceCompletionRate, 0) / total 
        : 0;
    
    let summary = `=== æ•´ä½“ç»Ÿè®¡æ±‡æ€» ===
æŠ¥å‘Šå‘¨æœŸ: ${dateRange.startStr} è‡³ ${dateRange.endStr}
ç»Ÿè®¡å­¦ç”Ÿæ€»æ•°: ${total}

ç»¼åˆè¯„ä¼°åˆ†å¸ƒ:
â€¢ è‰¯å¥½: ${statusCounts.good} äºº (${total > 0 ? (statusCounts.good/total*100).toFixed(1) : '0.0'}%)
â€¢ ä¸€èˆ¬: ${statusCounts.fair} äºº (${total > 0 ? (statusCounts.fair/total*100).toFixed(1) : '0.0'}%)
â€¢ è¾ƒå·®: ${statusCounts.poor} äºº (${total > 0 ? (statusCounts.poor/total*100).toFixed(1) : '0.0'}%)
â€¢ å¤šæ¬¡ç¼ºå‹¤: ${statusCounts.mostly_absent} äºº (${total > 0 ? (statusCounts.mostly_absent/total*100).toFixed(1) : '0.0'}%)
â€¢ å·²è¯·å‡: ${statusCounts.excused} äºº (${total > 0 ? (statusCounts.excused/total*100).toFixed(1) : '0.0'}%)

å¹³å‡å‡ºå‹¤ç‡: ${avgAttendanceRate.toFixed(1)}%
å¹³å‡ç»ƒç´å®Œæˆç‡: ${avgPracticeRate.toFixed(1)}%

`;

    // ğŸ”¥ ä¿®å¤ï¼šæŒ‰ä¸“ä¸šç»Ÿè®¡ - æ·»åŠ è°ƒè¯•å’ŒéªŒè¯
    const byMajor = {};
    summaries.forEach(s => {
        const major = s.major || 'æœªçŸ¥ä¸“ä¸š';
        
        // ğŸ”¥ æ·»åŠ è°ƒè¯•æ—¥å¿—
        console.log('ğŸ“Š ä¸“ä¸šç»Ÿè®¡:', s.name, '->', major);
        
        if (!byMajor[major]) {
            byMajor[major] = { 
                total: 0, good: 0, fair: 0, poor: 0, mostly_absent: 0, excused: 0,
                totalAttendanceRate: 0, totalPracticeRate: 0
            };
        }
        const stats = byMajor[major];
        stats.total++;
        stats[s.finalStatus]++;
        stats.totalAttendanceRate += s.attendanceRate;
        stats.totalPracticeRate += s.practiceCompletionRate;
    });
    
    // ğŸ”¥ æ·»åŠ ä¸“ä¸šç»Ÿè®¡è°ƒè¯•ä¿¡æ¯
    console.log('ğŸ“Š ä¸“ä¸šç»Ÿè®¡æ±‡æ€»:', byMajor);
    
    summary += `=== å„ä¸“ä¸šç»Ÿè®¡ ===
ä¸“ä¸š,æ€»äººæ•°,è‰¯å¥½,ä¸€èˆ¬,è¾ƒå·®,å¤šæ¬¡ç¼ºå‹¤,å·²è¯·å‡,å¹³å‡å‡ºå‹¤ç‡,å¹³å‡ç»ƒç´å®Œæˆç‡
`;
    
    Object.keys(byMajor).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN')).forEach(major => {
        const stats = byMajor[major];
        const avgAttendance = stats.total > 0 ? (stats.totalAttendanceRate / stats.total).toFixed(1) : '0.0';
        const avgPractice = stats.total > 0 ? (stats.totalPracticeRate / stats.total).toFixed(1) : '0.0';
        
        // ğŸ”¥ æ·»åŠ è°ƒè¯•æ—¥å¿—
        console.log('ğŸ“Š è¾“å‡ºä¸“ä¸šç»Ÿè®¡:', major, stats);
        
        summary += `${escapeCSV(major)},${stats.total},${stats.good},${stats.fair},${stats.poor},${stats.mostly_absent},${stats.excused},${avgAttendance}%,${avgPractice}%\n`;
    });
    
    return summary + '\n';
}
// ğŸ”¥ æ–°å¢ï¼šåŸºäºæ±‡æ€»æ•°æ®åˆ†æé—®é¢˜å­¦ç”Ÿ
function analyzeProblemStudentsFromSummaries(studentSummaries, dateRange) {
    const problemStudents = {
        consecutive: [],
        lowEfficiency: [],
        frequent: []
    };
    
    studentSummaries.forEach((summary, studentName) => {
        // å¤šæ¬¡ç¼ºå‹¤å­¦ç”Ÿ
        if (summary.finalStatus === 'mostly_absent' || summary.absentSlots >= 2) {
            problemStudents.consecutive.push({
                name: studentName,
                major: summary.major,
                absentSlots: summary.absentSlots,
                totalSlots: summary.totalSlots,
                attendanceRate: summary.attendanceRate
            });
        }
        
        // ä½æ•ˆç»ƒç´å­¦ç”Ÿ
        if (summary.lowEfficiencySlots > 0 || summary.practiceCompletionRate < 60) {
            problemStudents.lowEfficiency.push({
                name: studentName,
                major: summary.major,
                lowEfficiencySlots: summary.lowEfficiencySlots,
                practiceCompletionRate: summary.practiceCompletionRate,
                attendanceRate: summary.attendanceRate
            });
        }
    });
    
    // é¢‘ç¹è¯·å‡å­¦ç”Ÿåˆ†æï¼ˆåŸºäºå†å²è®°å½•ï¼‰
    const excuseStats = analyzeExcuseFrequency(dateRange);
    problemStudents.frequent = excuseStats.filter(stat => stat.count >= 2);
    
    return problemStudents;
}

// ğŸ”¥ ä¿®æ”¹ï¼šé—®é¢˜åˆ†ææŠ¥å‘Š
function generateProblemAnalysis(reportData, dateRange) {
    let analysis = `=== é—®é¢˜å­¦ç”Ÿåˆ†æ ===\n`;
    
    // å¤šæ¬¡ç¼ºå‹¤å­¦ç”Ÿ
    analysis += `=== ç¼ºå‹¤é—®é¢˜å­¦ç”Ÿ ===
å§“å,ä¸“ä¸š,ç¼ºå‹¤æ¬¡æ•°,æ€»æ—¶é—´æ®µ,å‡ºå‹¤ç‡,å»ºè®®æªæ–½\n`;
    
    reportData.problemStudents.consecutive.forEach(student => {
        const suggestion = student.absentSlots >= 3 ? 'ç´§æ€¥è”ç³»' : 
                          student.absentSlots >= 2 ? 'é‡ç‚¹å…³æ³¨' : 'ä¸€èˆ¬æé†’';
        
        analysis += `${escapeCSV(student.name)},${escapeCSV(student.major)},${student.absentSlots},${student.totalSlots},${student.attendanceRate.toFixed(1)}%,${suggestion}\n`;
    });
    
    analysis += `\n=== ç»ƒç´æ•ˆç‡é—®é¢˜å­¦ç”Ÿ ===
å§“å,ä¸“ä¸š,ä½æ•ˆæ¬¡æ•°,ç»ƒç´å®Œæˆç‡,å‡ºå‹¤ç‡,éœ€è¦å…³æ³¨\n`;
    
    reportData.problemStudents.lowEfficiency.forEach(student => {
        const concern = student.practiceCompletionRate < 30 ? 'é«˜åº¦å…³æ³¨' : 
                       student.practiceCompletionRate < 50 ? 'ä¸­åº¦å…³æ³¨' : 'è½»åº¦å…³æ³¨';
        
        analysis += `${escapeCSV(student.name)},${escapeCSV(student.major)},${student.lowEfficiencySlots},${student.practiceCompletionRate.toFixed(1)}%,${student.attendanceRate.toFixed(1)}%,${concern}\n`;
    });
    
    analysis += `\n=== é¢‘ç¹è¯·å‡å­¦ç”Ÿ ===
å§“å,ä¸“ä¸š,è¯·å‡æ¬¡æ•°,è¯·å‡åŸå› ,æœ€è¿‘è¯·å‡æ—¥æœŸ\n`;
    
    reportData.problemStudents.frequent.forEach(stat => {
        analysis += `${escapeCSV(stat.studentName)},${escapeCSV(stat.major)},${stat.count}æ¬¡,${escapeCSV(stat.reasons.join(';'))},${stat.lastExcuseDate}\n`;
    });
    
    return analysis;
}

// ä¿ç•™åŸæœ‰çš„è¾…åŠ©å‡½æ•°
function getDateRange(filters) {
    const today = new Date();
    let startDate, endDate;
    
    switch (filters.dateRange) {
        case 'today':
            startDate = endDate = new Date(today);
            break;
        case 'yesterday':
            startDate = endDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            break;
        case 'week':
            startDate = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
            endDate = new Date(today);
            break;
        case 'custom':
            startDate = new Date(filters.startDate);
            endDate = new Date(filters.endDate);
            break;
    }
    
    return {
        start: startDate,
        end: endDate,
        startStr: startDate.toISOString().split('T')[0],
        endStr: endDate.toISOString().split('T')[0],
        days: Math.ceil((endDate - startDate) / (24 * 60 * 60 * 1000)) + 1
    };
}

function generateReportHeader(dateRange, filters) {
    const rangeText = dateRange.days === 1 
        ? `${dateRange.startStr}` 
        : `${dateRange.startStr} è‡³ ${dateRange.endStr}`;
    
    return `æ™ºèƒ½è€ƒå‹¤æ±‡æ€»æŠ¥å‘Š
æŠ¥å‘Šæ—¥æœŸèŒƒå›´: ${rangeText}
ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
ç­›é€‰æ¡ä»¶: ${filters.majorFilter || 'æ‰€æœ‰ä¸“ä¸š'}
${filters.highlightProblems ? 'âœ“ çªå‡ºé—®é¢˜å­¦ç”Ÿ' : ''}
${filters.includeExcused ? 'âœ“ åŒ…å«è¯·å‡è¯¦æƒ…' : ''}

`;
}

function analyzeConsecutiveAbsence(studentName) {
    const student = [...(attendanceData.students || []), ...(attendanceData.endedSlots || [])]
        .find(s => s.name === studentName && s.finalAttendanceStatus === 'absent');
    
    return student ? 1 : 0;
}

function getLastAttendanceDate(studentName) {
    const recentLogs = practiceLogs
        .filter(log => log.student === studentName)
        .sort((a, b) => b.startTime - a.startTime);
    
    return recentLogs.length > 0 
        ? new Date(recentLogs[0].startTime).toLocaleDateString('zh-CN')
        : 'æœªçŸ¥';
}

function analyzeExcuseFrequency(dateRange) {
    const stats = new Map();
    
    (excuseOperationHistory || []).forEach(op => {
        const opDate = new Date(op.timestamp);
        if (opDate >= dateRange.start && opDate <= dateRange.end) {
            if (!stats.has(op.studentName)) {
                stats.set(op.studentName, {
                    studentName: op.studentName,
                    major: getStudentMajor(op.studentName),
                    count: 0,
                    reasons: [],
                    lastExcuseDate: null
                });
            }
            
            const stat = stats.get(op.studentName);
            stat.count++;
            if (!stat.reasons.includes(op.reason)) {
                stat.reasons.push(op.reason);
            }
            if (!stat.lastExcuseDate || opDate > new Date(stat.lastExcuseDate)) {
                stat.lastExcuseDate = opDate.toLocaleDateString('zh-CN');
            }
        }
    });
    
    return Array.from(stats.values());
}

function exportCSVFile(csvContent, filename) {
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function getStudentMajor(studentName) {
    try {
        const safeName = safeTrim(studentName);
        if (!safeName) {
            console.warn('âš ï¸ getStudentMajor: å­¦ç”Ÿå§“åä¸ºç©º');
            return 'å…¶ä»–';
        }

        for (const [major, students] of Object.entries(studentDatabase)) {
            if (!Array.isArray(students)) {
                console.warn(`âš ï¸ ä¸“ä¸š ${major} çš„æ•°æ®ä¸æ˜¯æ•°ç»„:`, students);
                continue;
            }

            const studentRecord = students.find(s => {
                try {
                    const name = getStudentName(s);
                    return name === safeName;
                } catch (error) {
                    console.warn('âš ï¸ æ¯”è¾ƒå­¦ç”Ÿå§“åæ—¶å‡ºé”™:', s, error);
                    return false;
                }
            });
            
            if (studentRecord) {
                return major;
            }
        }
        
        console.warn('âš ï¸ æœªæ‰¾åˆ°å­¦ç”Ÿä¸“ä¸š:', safeName);
        return 'å…¶ä»–';
        
    } catch (error) {
        console.error('âŒ getStudentMajor å‡ºé”™:', studentName, error);
        return 'å…¶ä»–';
    }
}
/**
 * ğŸ”¥ æ–°å¢ï¼šæ•°æ®åº“å¥åº·æ£€æŸ¥å’Œä¿®å¤å·¥å…·
 */
function performDatabaseHealthCheck() {
    console.log('ğŸ¥ å¼€å§‹æ•°æ®åº“å¥åº·æ£€æŸ¥...');
    
    const report = {
        studentDatabase: validateAndCleanStudentDatabase(),
        roomDatabase: validateRoomDatabase(),
        timeSlots: validateTimeSlots()
    };
    
    console.log('ğŸ¥ å¥åº·æ£€æŸ¥å®Œæˆ:', report);
    return report;
}

function validateRoomDatabase() {
    let issues = 0;
    Object.keys(roomDatabase).forEach(name => {
        const room = roomDatabase[name];
        if (!room.name || !room.pianoType) {
            console.warn('âš ï¸ æˆ¿é—´æ•°æ®ä¸å®Œæ•´:', name, room);
            issues++;
        }
    });
    return { issues };
}

function validateTimeSlots() {
    let issues = 0;
    Object.keys(studentTimeSlots).forEach(studentName => {
        const slots = studentTimeSlots[studentName];
        if (!slots || typeof slots !== 'object') {
            console.warn('âš ï¸ å­¦ç”Ÿæ—¶é—´æ®µæ•°æ®å¼‚å¸¸:', studentName, slots);
            issues++;
        }
    });
    return { issues };
}
// è¾…åŠ©å‡½æ•°ï¼šCSVè½¬ä¹‰
function escapeCSV(str) {
    if (typeof str !== 'string') return str;
    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return `"${str.replace(/"/g, '""')}"`;
    }
    return str;
}


// æ›´æ–°å…¨å±€å‡½æ•°æ˜ å°„
window.exportAttendanceReport = exportAttendanceReport;
window.closeSmartExportModal = closeSmartExportModal;
window.executeSmartExport = executeSmartExport;

/* è¯·å‡å¼¹çª—ä¸é€»è¾‘ï¼ˆé€‚é…èšåˆç»“æ„ï¼‰ */
function excuseStudent(name) {
    const reasons = [
        { v: 'sick', t: 'ç”Ÿç—…' }, { v: 'class_change', t: 'è°ƒè¯¾' },
        { v: 'leave', t: 'è¯·å‡' }, { v: 'other', t: 'å…¶ä»–ï¼ˆè‡ªå®šä¹‰ï¼‰' }
    ];
    
    const wrap = document.createElement('div');
    wrap.id = 'excuseModal';
    wrap.style.cssText = 'position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:3000;display:flex;align-items:center;justify-content:center;';
    wrap.innerHTML = `<div style="background:#fff;padding:25px 28px;border-radius:16px;max-width:480px;width:95%;box-shadow:0 6px 24px rgba(0,0,0,.3);">
        <h3 style="margin:0 0 18px;color:var(--primary-color);text-align:center;">ä¸º ${name} è®°å½•è¯·å‡</h3>
        
        <!-- è¯·å‡åŸå›  -->
        <div style="margin-bottom:15px;">
            <h4 style="margin:0 0 8px;color:#2c3e50;font-size:14px;">è¯·å‡åŸå› ï¼š</h4>
            <div id="excuseOptions" style="display:flex;flex-direction:column;gap:6px;">
                ${reasons.map((r, index) => `<label class="excuse-reason-option" style="display:flex;align-items:center;gap:8px;border:1px solid #ddd;border-radius:8px;padding:8px 12px;cursor:pointer;transition:all 0.2s;">
                    <input type="radio" name="excuseReason" value="${r.v}" ${index === 0 ? 'checked' : ''}>
                    <span>${r.t}</span>
                </label>`).join('')}
            </div>
        </div>

        <!-- è‡ªå®šä¹‰åŸå› è¾“å…¥æ¡† -->
        <div id="customReasonBox" style="display:none;margin-bottom:15px;">
            <input type="text" id="customReasonInput" placeholder="è¯·è¾“å…¥å…·ä½“åŸå› ..." style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;">
        </div>
        
        <!-- è¯·å‡æœ‰æ•ˆæœŸé€‰æ‹© -->
        <div style="margin-bottom:18px;">
            <h4 style="margin:0 0 8px;color:#2c3e50;font-size:14px;">è¯·å‡æœ‰æ•ˆæœŸï¼š</h4>
            <div id="excuseDurationOptions" style="display:flex;flex-direction:column;gap:6px;">
                <label style="display:flex;align-items:center;gap:8px;border:1px solid #ddd;border-radius:8px;padding:8px 12px;cursor:pointer;transition:all 0.2s;">
                    <input type="radio" name="excuseDuration" value="once" checked>
                    <span>ğŸ• ä»…æœ¬æ¬¡æ—¶é—´æ®µ</span>
                </label>
                <label style="display:flex;align-items:center;gap:8px;border:1px solid #ddd;border-radius:8px;padding:8px 12px;cursor:pointer;transition:all 0.2s;">
                    <input type="radio" name="excuseDuration" value="tomorrow">
                    <span>ğŸ“… åˆ°æ˜å¤©ä¸Šåˆæ¢å¤</span>
                </label>
                <label style="display:flex;align-items:center;gap:8px;border:1px solid #ddd;border-radius:8px;padding:8px 12px;cursor:pointer;transition:all 0.2s;">
                    <input type="radio" name="excuseDuration" value="custom">
                    <span>ğŸ“† è‡ªå®šä¹‰æˆªæ­¢æ—¥æœŸ</span>
                </label>
            </div>
        </div>
        
        <!-- è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹© -->
        <div id="customDateBox" style="display:none;margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-weight:600;color:#2c3e50;font-size:13px;">è¯·å‡æˆªæ­¢æ—¥æœŸï¼š</label>
            <input type="date" id="customEndDate" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;" min="${new Date().toISOString().split('T')[0]}">
            <small style="color:#666;font-size:12px;margin-top:4px;display:block;">å°†åœ¨æ‰€é€‰æ—¥æœŸçš„ä¸Šåˆ8:00è‡ªåŠ¨æ¢å¤è€ƒå‹¤</small>
        </div>
        
        <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:20px;">
            <button class="clear-btn" onclick="closeExcuseModal()" style="padding:10px 20px;">å–æ¶ˆ</button>
            <button onclick="confirmExcuse('${name}')" style="padding:10px 20px;">ç¡®è®¤è¯·å‡</button>
        </div>
    </div>`;
    
    document.body.appendChild(wrap);
    
    // ğŸ”¥ ä¿®å¤ï¼šäº‹ä»¶ç›‘å¬å™¨
    wrap.addEventListener('change', e => {
        if (e.target.name === 'excuseReason') {
            // æ¸…é™¤æ‰€æœ‰é€‰é¡¹çš„é€‰ä¸­æ ·å¼
            const allReasonOptions = wrap.querySelectorAll('.excuse-reason-option');
            allReasonOptions.forEach(option => {
                option.style.borderColor = '#ddd';
                option.style.backgroundColor = 'transparent';
            });
            
            // è®¾ç½®å½“å‰é€‰ä¸­é¡¹çš„æ ·å¼
            const selectedOption = e.target.closest('.excuse-reason-option');
            if (selectedOption) {
                selectedOption.style.borderColor = '#3498db';
                selectedOption.style.backgroundColor = '#e3f2fd';
            }
            
            $('customReasonBox').style.display = (e.target.value === 'other') ? 'block' : 'none';
        }
        
        if (e.target.name === 'excuseDuration') {
            // æ¸…é™¤æ‰€æœ‰æ—¶é•¿é€‰é¡¹çš„é€‰ä¸­æ ·å¼
            const allDurationOptions = wrap.querySelectorAll('#excuseDurationOptions label');
            allDurationOptions.forEach(option => {
                option.style.borderColor = '#ddd';
                option.style.backgroundColor = 'transparent';
            });
            
            // è®¾ç½®å½“å‰é€‰ä¸­é¡¹çš„æ ·å¼
            const selectedOption = e.target.closest('label');
            if (selectedOption) {
                selectedOption.style.borderColor = '#3498db';
                selectedOption.style.backgroundColor = '#e3f2fd';
            }
            
            $('customDateBox').style.display = (e.target.value === 'custom') ? 'block' : 'none';
            if (e.target.value === 'custom') {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                $('customEndDate').value = tomorrow.toISOString().split('T')[0];
            }
        }
    });
    
    // ğŸ”¥ ä¿®å¤ï¼šhover æ•ˆæœ
    wrap.addEventListener('mouseover', e => {
        const label = e.target.closest('label');
        if (label && (label.classList.contains('excuse-reason-option') || label.closest('#excuseDurationOptions'))) {
            const radio = label.querySelector('input[type="radio"]');
            if (radio && !radio.checked) {
                label.style.borderColor = '#3498db';
                label.style.backgroundColor = '#f8f9fa';
            }
        }
    });

    wrap.addEventListener('mouseout', e => {
        const label = e.target.closest('label');
        if (label && (label.classList.contains('excuse-reason-option') || label.closest('#excuseDurationOptions'))) {
            const radio = label.querySelector('input[type="radio"]');
            if (radio && !radio.checked) {
                label.style.borderColor = '#ddd';
                label.style.backgroundColor = 'transparent';
            }
        }
    });

    // ğŸ”¥ æ–°å¢ï¼šåˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
    setTimeout(() => {
        // åˆå§‹åŒ–è¯·å‡åŸå› çš„é»˜è®¤é€‰ä¸­çŠ¶æ€
        const firstReasonRadio = wrap.querySelector('input[name="excuseReason"]:checked');
        if (firstReasonRadio) {
            const firstOption = firstReasonRadio.closest('.excuse-reason-option');
            if (firstOption) {
                firstOption.style.borderColor = '#3498db';
                firstOption.style.backgroundColor = '#e3f2fd';
            }
        }
        
        // åˆå§‹åŒ–æœ‰æ•ˆæœŸçš„é»˜è®¤é€‰ä¸­çŠ¶æ€
        const defaultDurationRadio = wrap.querySelector('input[name="excuseDuration"]:checked');
        if (defaultDurationRadio) {
            const defaultOption = defaultDurationRadio.closest('label');
            if (defaultOption) {
                defaultOption.style.borderColor = '#3498db';
                defaultOption.style.backgroundColor = '#e3f2fd';
            }
        }
    }, 10);
}



function closeExcuseModal() {
    const m = $('excuseModal');
    if (m) document.body.removeChild(m);
}

// ğŸ”¥ ä¿®å¤ï¼šè¯·å‡æ“ä½œ - ç§»é™¤è‡ªåŠ¨åŒæ­¥ï¼Œæ”¹ä¸ºæ‰‹åŠ¨æ§åˆ¶
// ğŸ”¥ ä¿®å¤ï¼šè¯·å‡æ“ä½œ - åªåŒæ­¥è¯·å‡çŠ¶æ€
// ğŸ”¥ ä¿®å¤ï¼šè¯·å‡æ“ä½œ - æ·»åŠ æ“ä½œIDå’Œå†å²è®°å½•
function confirmExcuse(name) {
    const reasonRadio = [...document.querySelectorAll('#excuseOptions input[name=excuseReason]')].find(r => r.checked);
    const durationRadio = [...document.querySelectorAll('#excuseDurationOptions input[name=excuseDuration]')].find(r => r.checked);
    
    if (!reasonRadio) { alert('è¯·é€‰æ‹©è¯·å‡åŸå› '); return; }
    if (!durationRadio) { alert('è¯·é€‰æ‹©è¯·å‡æœ‰æ•ˆæœŸ'); return; }
    
    let reason = reasonRadio.value === 'other' ? $('customReasonInput').value.trim() : reasonRadio.value;
    if (reasonRadio.value === 'other' && !reason) { alert('è¯·è¾“å…¥å…·ä½“åŸå› '); return; }
    
    // ğŸ”¥ æ–°å¢ï¼šå¤„ç†æœ‰æ•ˆæœŸ
    const duration = durationRadio.value;
    let endDate = null;
    let durationText = '';
    
    if (duration === 'once') {
        endDate = null;
        durationText = 'ä»…æœ¬æ¬¡';
    } else if (duration === 'tomorrow') {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(8, 0, 0, 0);
        endDate = tomorrow.toISOString();
        durationText = 'åˆ°æ˜å¤©ä¸Šåˆ';
    } else if (duration === 'custom') {
        const customDate = $('customEndDate').value;
        if (!customDate) { alert('è¯·é€‰æ‹©æˆªæ­¢æ—¥æœŸ'); return; }
        
        const endDateTime = new Date(customDate);
        endDateTime.setHours(8, 0, 0, 0);
        
        if (endDateTime <= new Date()) {
            alert('æˆªæ­¢æ—¥æœŸä¸èƒ½æ˜¯è¿‡å»çš„æ—¶é—´');
            return;
        }
        
        endDate = endDateTime.toISOString();
        durationText = `åˆ°${customDate}ä¸Šåˆ`;
    }

    const target = [...attendanceData.students, ...attendanceData.endedSlots].filter(s => s.name === name);
    
    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šç”Ÿæˆå”¯ä¸€æ“ä½œID
    const operationId = `excuse_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // ğŸ”¥ ä¿®æ”¹ï¼šå¢å¼ºè¯·å‡è®°å½•ç»“æ„
    const excuseRecord = {
        operationId: operationId, // ğŸ”¥ æ–°å¢ï¼šå”¯ä¸€æ“ä½œID
        studentName: name,
        reason: reason === 'sick' ? 'ç”Ÿç—…' :
                reason === 'class_change' ? 'è°ƒè¯¾' :
                reason === 'leave' ? 'è¯·å‡' : reason,
        duration: duration,
        durationText: durationText,
        endDate: endDate,
        timestamp: Date.now(),
        date: todayKey(),
        slots: []
    };

    target.forEach(stu => {
        const statusText = endDate 
            ? `å·²è¯·å‡ï¼š${excuseRecord.reason}ï¼ˆ${durationText}ï¼‰`
            : `å·²è¯·å‡ï¼š${excuseRecord.reason}ï¼ˆä»…æœ¬æ¬¡ï¼‰`;
            
        stu.finalAttendanceStatus = 'excused';
        stu.finalStatusText = statusText;
        stu.excuseEndDate = endDate;
        stu.excuseOperationId = operationId; // ğŸ”¥ æ–°å¢ï¼šå…³è”æ“ä½œID
        
        excuseRecord.slots.push({
            start: stu.start,
            end: stu.end,
            major: stu.major
        });
    });
    
    // ğŸ”¥ æ–°å¢ï¼šè®°å½•åˆ°æ“ä½œå†å²
    excuseOperationHistory.push({
        operationId: operationId,
        studentName: name,
        reason: excuseRecord.reason,
        timestamp: excuseRecord.timestamp,
        duration: excuseRecord.duration,
        durationText: excuseRecord.durationText,
        affectedSlots: excuseRecord.slots.length,
        endDate: endDate
    });
    
    // æŒä¹…åŒ–å†å²è®°å½•
    lsSet('excuseOperationHistory', excuseOperationHistory);
    
    closeExcuseModal();
    renderAttendanceList(false);
    updateAttendanceBadge();
    
    // FirebaseåŒæ­¥éƒ¨åˆ†ä¿æŒä¸å˜
    if (syncEnabled && isOnline && database) {
        syncEnabled = false;
        const excuseKey = `${excuseRecord.date}_${name}_${Date.now()}`;
        
        database.ref(`${FIREBASE_PATHS.EXCUSE_DATA}/${excuseKey}`).set(excuseRecord)
            .then(() => {
                console.log('âœ… è¯·å‡è®°å½•å·²åŒæ­¥åˆ°äº‘ç«¯');
                setTimeout(() => {
                    syncEnabled = true;
                }, 1000);
            })
            .catch((error) => {
                console.error('âŒ è¯·å‡è®°å½•åŒæ­¥å¤±è´¥:', error);
                syncEnabled = true;
            });
    }
    
    logOperation('student_excuse', {
        student: name,
        reason: excuseRecord.reason,
        duration: duration,
        durationText: durationText,
        endDate: endDate,
        slotsCount: excuseRecord.slots.length,
        operationId: operationId // ğŸ”¥ æ–°å¢ï¼šè®°å½•æ“ä½œID
    });
    
    // æ¸…ç†å¼‚å¸¸æé†’éƒ¨åˆ†ä¿æŒä¸å˜
    const beforeCount = practiceOverrunReminders.length;
    practiceOverrunReminders = practiceOverrunReminders.filter(rec => {
        if (rec.student === name) {
            console.log(`ğŸ§¹ å› è¯·å‡æ¸…ç†å¼‚å¸¸æé†’ï¼š${name} - ${rec.room}`);
            return false;
        }
        return true;
    });

    if (beforeCount !== practiceOverrunReminders.length) {
        persistOverruns(true, 'excuse_cleanup', {
            student: name,
            cleaned: beforeCount - practiceOverrunReminders.length
        });
        updateOverrunPanel();
    }
    
    showToast(`å·²è®°å½•è¯·å‡ï¼ˆ${durationText}ï¼‰`);
}

// ğŸ”¥ æ–°å¢ï¼šè·å–å½“å‰å·²è¯·å‡çš„å­¦ç”Ÿé›†åˆ
function getExcusedStudents() {
    const excusedSet = new Set();
    
    // æ£€æŸ¥è€ƒå‹¤æ•°æ®ä¸­çš„è¯·å‡çŠ¶æ€
    if (attendanceData && attendanceData.students) {
        attendanceData.students.forEach(stu => {
            if (stu.finalAttendanceStatus === 'excused') {
                // æ£€æŸ¥è¯·å‡æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                if (!stu.excuseEndDate) {
                    // ä»…æœ¬æ¬¡è¯·å‡ - ä»ç„¶æœ‰æ•ˆ
                    excusedSet.add(stu.name);
                } else {
                    // æœ‰æœŸé™çš„è¯·å‡ - æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                    const endDate = new Date(stu.excuseEndDate);
                    const now = new Date();
                    if (now < endDate) {
                        excusedSet.add(stu.name);
                    }
                }
            }
        });
    }
    
    // ä¹Ÿæ£€æŸ¥å·²ç»“æŸæ—¶æ®µçš„è¯·å‡çŠ¶æ€ï¼ˆå¯èƒ½æœ‰è·¨æ—¶æ®µçš„è¯·å‡ï¼‰
    if (attendanceData && attendanceData.endedSlots) {
        attendanceData.endedSlots.forEach(stu => {
            if (stu.finalAttendanceStatus === 'excused' && stu.excuseEndDate) {
                const endDate = new Date(stu.excuseEndDate);
                const now = new Date();
                if (now < endDate) {
                    excusedSet.add(stu.name);
                }
            }
        });
    }
    
    return excusedSet;
}

// ğŸ”¥ æ–°å¢ï¼šæ£€æµ‹è¯·å‡çŠ¶æ€ä¸å®é™…ç»ƒç´çš„å†²çª
function checkExcuseConflicts() {
    const excusedStudents = getExcusedStudents();
    const conflicts = [];
    
    rooms.forEach(r => {
        if (r.student && excusedStudents.has(r.student)) {
            conflicts.push({
                student: r.student,
                room: r.name,
                registerTime: new Date(r.registerTime).toLocaleString()
            });
        }
    });
    
    if (conflicts.length > 0) {
        console.log('ğŸ” å‘ç°è¯·å‡çŠ¶æ€å†²çª:', conflicts);
        
        // å¯ä»¥é€‰æ‹©è‡ªåŠ¨å¤„ç†æˆ–æç¤ºç®¡ç†å‘˜
        conflicts.forEach(conflict => {
            showToast(`âš ï¸ ${conflict.student} å·²è¯·å‡ä½†åœ¨ ${conflict.room} ç»ƒç´`, 5000);
        });
    }
    
    return conflicts;
}

// ğŸ”¥ ä¿®å¤ï¼šå–æ¶ˆè¯·å‡æ“ä½œ - åªåŒæ­¥å–æ¶ˆè¯·å‡çŠ¶æ€
function cancelExcuse(name) {
    if (!confirm('å–æ¶ˆè¯·å‡å¹¶é‡æ–°è®¡ç®—å½“å‰æ®µçŠ¶æ€?')) return;
    
    const targets = [...attendanceData.students, ...attendanceData.endedSlots].filter(s => s.name === name);
    const cancelRecord = {
        studentName: name,
        action: 'cancel_excuse',
        timestamp: Date.now(),
        date: todayKey(),
        slots: []
    };

    targets.forEach(stu => {
        // é‡æ–°å–å®æ—¶ & ç»ƒç´æ—¶é•¿
        const practicedSec = getStudentPracticeTimeInSlot(stu.name, stu);
        const realtimeStatus = getStudentAttendanceStatus(stu.name);
        const calc = calculateAttendanceStatus(stu.name, stu, realtimeStatus, practicedSec);
        Object.assign(stu, calc, {
            practicedSec,
            practicedText: fmtPracticeSec(practicedSec)
        });
        
        // è®°å½•å–æ¶ˆè¯·å‡çš„æ—¶é—´æ®µä¿¡æ¯
        cancelRecord.slots.push({
            start: stu.start,
            end: stu.end,
            major: stu.major
        });
    });
    
    renderAttendanceList(false);
    updateAttendanceBadge();
    
    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šåªåŒæ­¥å–æ¶ˆè¯·å‡æ“ä½œ
    if (syncEnabled && isOnline && database) {
        syncEnabled = false;
        
        const cancelKey = `cancel_${cancelRecord.date}_${name}_${Date.now()}`;
        
        database.ref(`${FIREBASE_PATHS.EXCUSE_DATA}/${cancelKey}`).set(cancelRecord)
            .then(() => {
                console.log('âœ… å–æ¶ˆè¯·å‡æ“ä½œå·²åŒæ­¥');
                setTimeout(() => {
                    syncEnabled = true;
                }, 1000);
            })
            .catch((error) => {
                console.error('âŒ å–æ¶ˆè¯·å‡æ“ä½œåŒæ­¥å¤±è´¥:', error);
                syncEnabled = true;
            });
    }
    
    showToast('å·²å–æ¶ˆè¯·å‡');
    
    // ğŸ”¥ æ–°å¢ï¼šå–æ¶ˆè¯·å‡åï¼Œç«‹å³æ£€æŸ¥è¯¥å­¦ç”Ÿæ˜¯å¦éœ€è¦å¼‚å¸¸æé†’
    setTimeout(() => {
        checkPracticeAnomalies();
    }, 1000);
}

// ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥å¹¶è‡ªåŠ¨æ¢å¤è¿‡æœŸçš„è¯·å‡çŠ¶æ€
function checkExpiredExcuses() {
    if (!attendanceData.students && !attendanceData.endedSlots) return;
    
    const now = new Date();
    let hasExpiredExcuses = false;
    
    // æ£€æŸ¥å½“å‰å­¦ç”Ÿçš„è¯·å‡çŠ¶æ€
    [...(attendanceData.students || []), ...(attendanceData.endedSlots || [])].forEach(stu => {
        if (stu.finalAttendanceStatus === 'excused' && stu.excuseEndDate) {
            const endDate = new Date(stu.excuseEndDate);
            
            // å¦‚æœè¯·å‡å·²è¿‡æœŸ
            if (now >= endDate) {
                console.log(`ğŸ”„ è¯·å‡å·²è¿‡æœŸï¼Œæ¢å¤è€ƒå‹¤ï¼š${stu.name}ï¼Œè¿‡æœŸæ—¶é—´ï¼š${endDate.toLocaleString()}`);
                
                // é‡æ–°è®¡ç®—è€ƒå‹¤çŠ¶æ€
                const practicedSec = getStudentPracticeTimeInSlot(stu.name, stu);
                const realtimeStatus = getStudentAttendanceStatus(stu.name);
                const calc = calculateAttendanceStatus(stu.name, stu, realtimeStatus, practicedSec);
                
                // æ›´æ–°çŠ¶æ€
                Object.assign(stu, calc, {
                    practicedSec,
                    practicedText: fmtPracticeSec(practicedSec),
                    excuseEndDate: null // æ¸…é™¤è¿‡æœŸçš„è¯·å‡ç»“æŸæ—¥æœŸ
                });
                
                hasExpiredExcuses = true;
            }
        }
    });
    
    // å¦‚æœæœ‰è¿‡æœŸçš„è¯·å‡çŠ¶æ€è¢«æ¢å¤ï¼Œåˆ·æ–°UI
    if (hasExpiredExcuses) {
        if (isAttendanceModalOpen) {
            renderAttendanceList(false);
        }
        updateAttendanceBadge();
        
        // ğŸ”¥ åŒæ­¥æ¢å¤çŠ¶æ€åˆ°äº‘ç«¯
        if (syncEnabled && isOnline && database) {
            const recoveryRecord = {
                action: 'auto_recover_expired_excuses',
                timestamp: Date.now(),
                date: todayKey(),
                recoveredAt: now.toISOString()
            };
            
            const recoveryKey = `recovery_${recoveryRecord.date}_${Date.now()}`;
            database.ref(`${FIREBASE_PATHS.EXCUSE_DATA}/${recoveryKey}`).set(recoveryRecord)
                .catch(error => console.error('âŒ è‡ªåŠ¨æ¢å¤è®°å½•åŒæ­¥å¤±è´¥:', error));
        }
        
        console.log('âœ… å·²è‡ªåŠ¨æ¢å¤è¿‡æœŸçš„è¯·å‡çŠ¶æ€');
    }
}

/* ===== ç¼ºå¤±çš„è€ƒå‹¤å¼¹çª—å‡½æ•°è¡¥é½ ===== */
function openAttendanceModal() {
    // æ ‡è®°è€ƒå‹¤é¢æ¿æ‰“å¼€çŠ¶æ€
    isAttendanceModalOpen = true;
    
    // å¼ºåˆ¶åˆ·æ–°ä¸€æ¬¡è€ƒå‹¤ï¼ˆå« checkAttendanceï¼‰
    renderAttendanceList(true);
    if (typeof populateAttendanceMajorFilter === 'function') {
        populateAttendanceMajorFilter();
    }
    
    // ğŸ”¥ å…³é”®ï¼šå¯åŠ¨å®æ—¶æ›´æ–°å®šæ—¶å™¨ï¼ˆæ¯10ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
    if (attendanceRealTimeInterval) {
        clearInterval(attendanceRealTimeInterval);
    }
    attendanceRealTimeInterval = setInterval(() => {
        if (isAttendanceModalOpen) {
            checkAttendance(); // è¿™ä¼šè§¦å‘ renderAttendanceList(false)
        }
    }, 3000); // 10ç§’æ›´æ–°ä¸€æ¬¡ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
    
    const modal = $('attendanceModal');
    if (modal) modal.style.display = 'block';
}

function closeAttendanceModal() {
    // æ ‡è®°è€ƒå‹¤é¢æ¿å…³é—­çŠ¶æ€
    isAttendanceModalOpen = false;
    
    // ğŸ”¥ å…³é”®ï¼šæ¸…é™¤å®æ—¶æ›´æ–°å®šæ—¶å™¨
    if (attendanceRealTimeInterval) {
        clearInterval(attendanceRealTimeInterval);
        attendanceRealTimeInterval = null;
    }
    
    const modal = $('attendanceModal');
    if (modal) modal.style.display = 'none';
}

// ğŸ”¥ æ–°å¢ï¼šé¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
window.addEventListener('beforeunload', () => {
    if (attendanceRealTimeInterval) {
        clearInterval(attendanceRealTimeInterval);
    }
    // ğŸ”¥ ä¿®æ”¹ï¼šæ¸…ç†æˆ¿é—´çŠ¶æ€åŒæ­¥å®šæ—¶å™¨
    if (window.roomStatusSyncTimeout) {
        clearTimeout(window.roomStatusSyncTimeout);
    }
    // æ¸…ç†å¼‚å¸¸æ£€æŸ¥å®šæ—¶å™¨
    if (anomalyCheckInterval) {
        clearInterval(anomalyCheckInterval);
    }
    // æ¸…ç†è¯·å‡æ£€æŸ¥å®šæ—¶å™¨
    if (excuseCheckInterval) {
        clearInterval(excuseCheckInterval);
    }
    // ğŸ”¥ æ–°å¢ï¼šæ¸…ç†è‡ªåŠ¨é”å®šå®šæ—¶å™¨
    clearAutoLockTimers();
});



/**
 * ä»è€ƒå‹¤ç•Œé¢åˆ‡æ¢åˆ°è¶…æ—¶ç®¡ç†ç•Œé¢
 */
function switchToOvertimeManagement() {
    // å…³é—­è€ƒå‹¤ç•Œé¢
    closeAttendanceModal();
    
    // æ‰“å¼€è¶…æ—¶ç®¡ç†ç•Œé¢
    setTimeout(() => {
        openOvertimeModal();
    }, 100); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿è€ƒå‹¤ç•Œé¢å®Œå…¨å…³é—­
}

/* =========================================================
 *                        ç»ƒç´çŠ¶æ€å¼‚å¸¸æé†’åŠŸèƒ½
 * =======================================================*/

/**
 * ğŸ”¥ ä¿®æ”¹ï¼šç”Ÿæˆå”¯ä¸€é”®æ—¶ä½¿ç”¨åˆå¹¶åçš„æ—¶é—´æ®µ
 */
function genOverrunKey(student, slot) {
    // å¦‚æœæ˜¯åˆå¹¶æ®µï¼Œä½¿ç”¨åˆå¹¶åçš„å¼€å§‹å’Œç»“æŸæ—¶é—´
    const start = slot.start;
    const end = slot.end;
    return `${todayKey()}|${student}|${start}|${end}`;
}
// ğŸ”¥ ä¿®å¤ï¼šincOverrunCount å‡½æ•°
function incOverrunCount(student, slot){
  const d = todayKey();
  if(!overrunStats[d]) overrunStats[d] = {};
  if(!overrunStats[d][student]) overrunStats[d][student] = {count:0};
  overrunStats[d][student].count++;
  
  // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„æŒä¹…åŒ–å‡½æ•°
  persistOverruns(true, 'stats_update', { 
    student, 
    date: d, 
    newCount: overrunStats[d][student].count 
  });
}


function getTodayOverrunCount(student){
  const d = todayKey();
  return overrunStats[d]?.[student]?.count || 0;
}

function getTodayTotalOverrunCount(){
  const d = todayKey();
  if(!overrunStats[d]) return 0;
  return Object.values(overrunStats[d]).reduce((a,b)=>a + (b.count||0),0);
}
/**
 * ç®¡ç†å¼‚å¸¸æ£€æŸ¥å®šæ—¶å™¨ - åªåœ¨è®¾ç½®çš„æ—¶é—´èŒƒå›´å†…å¯åŠ¨æ£€æŸ¥
 */
function manageAnomalyCheckTimer() {
  const now = new Date();
  const currentHour = now.getHours();
  const currentMinute = now.getMinutes();
  const startHour = systemSettings.startAnomalyCheckHour || 8;
  const startMinute = systemSettings.startAnomalyCheckMinute || 0;
  const stopHour = systemSettings.stopAnomalyCheckHour || 19;
  const stopMinute = systemSettings.stopAnomalyCheckMinute || 0;
  
  const currentTotalMinutes = currentHour * 60 + currentMinute;
  const startTotalMinutes = startHour * 60 + startMinute;
  const stopTotalMinutes = stopHour * 60 + stopMinute;
  
  const shouldBeActive = currentTotalMinutes >= startTotalMinutes && currentTotalMinutes < stopTotalMinutes;
  
  if (shouldBeActive && !isAnomalyCheckActive) {
    // è¿›å…¥æ£€æŸ¥æ—¶é—´ï¼Œå¯åŠ¨å®šæ—¶å™¨
    console.log(`ğŸŸ¢ å¼‚å¸¸æ£€æŸ¥å·²å¯åŠ¨ï¼šå½“å‰æ—¶é—´ ${pad2(currentHour)}:${pad2(currentMinute)} åœ¨æ£€æŸ¥èŒƒå›´ ${pad2(startHour)}:${pad2(startMinute)} - ${pad2(stopHour)}:${pad2(stopMinute)} å†…`);
    isAnomalyCheckActive = true;
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
    checkPracticeAnomalies();
    
    // è®¾ç½®30ç§’é—´éš”çš„å®šæ—¶æ£€æŸ¥
    anomalyCheckInterval = setInterval(() => {
      if (isAnomalyCheckActive) {
        checkPracticeAnomalies();
      }
    }, 30000);
    
  } else if (!shouldBeActive && isAnomalyCheckActive) {
    // ç¦»å¼€æ£€æŸ¥æ—¶é—´ï¼Œåœæ­¢å®šæ—¶å™¨
    console.log(`ğŸ”´ å¼‚å¸¸æ£€æŸ¥å·²åœæ­¢ï¼šå½“å‰æ—¶é—´ ${pad2(currentHour)}:${pad2(currentMinute)} è¶…å‡ºæ£€æŸ¥èŒƒå›´ ${pad2(startHour)}:${pad2(startMinute)} - ${pad2(stopHour)}:${pad2(stopMinute)}`);
    isAnomalyCheckActive = false;
    
    if (anomalyCheckInterval) {
      clearInterval(anomalyCheckInterval);
      anomalyCheckInterval = null;
    }
  }
}

/**
 * æ£€æŸ¥å¼‚å¸¸ï¼šæ¯ 30 ç§’è°ƒç”¨ï¼ˆåœ¨ secondLoop èŠ‚æµï¼‰
 * æ¡ä»¶ï¼šå½“å‰å ç”¨ï¼›è¯¥æ—¶é—´æ®µç»“æŸè¶…è¿‡15åˆ†é’Ÿä»åœ¨ç»ƒï¼›ç™»è®°å®é™…ä½¿ç”¨å¼€å§‹â‰¤æ—¶é—´æ®µç»“æŸ
 * ğŸ”¥ æ–°é€»è¾‘ï¼šå¦‚æœå­¦ç”Ÿåœ¨æŸæ—¶é—´æ®µç»“æŸå15åˆ†é’Ÿå†…è¿˜æœ‰å…¶ä»–ç»ƒç´æ—¶é—´æ®µåˆ™ä¸æé†’ï¼Œ
 * ç›´åˆ°æ—¶é—´æ®µè¿‡äº†15åˆ†é’Ÿåæ²¡æœ‰å…¶ä»–ç»ƒç´æ—¶é—´æ®µä¸”è¿˜åœ¨ç™»è®°ç»ƒç´åˆ™æé†’
 */
function checkPracticeAnomalies() {
    if (isLocked) return;

    const now = new Date();
    const weekday = WEEK_MAP[now.getDay()];
    if (!weekday) return; // å‘¨æœ«ä¸æ£€æŸ¥

    // é™å®šåœ¨è®¾ç½®çš„æ—¶é—´èŒƒå›´å†…
    const curMin = now.getHours() * 60 + now.getMinutes();
    const startMin = (systemSettings.startAnomalyCheckHour   * 60) + (systemSettings.startAnomalyCheckMinute || 0);
    const stopMin  = (systemSettings.stopAnomalyCheckHour    * 60) + (systemSettings.stopAnomalyCheckMinute || 0);
    if (curMin < startMin || curMin >= stopMin) return;

    // å·²è¯·å‡å­¦ç”Ÿé›†åˆ
    const excused = getExcusedStudents();

    // å­¦ç”Ÿå½“å‰æ˜¯å¦å ç”¨æˆ¿é—´å¿«é€Ÿæ˜ å°„
    const roomByStudent = {};
    rooms.forEach(r => { if (r.student) roomByStudent[r.student] = r; });

    // é…ç½®ï¼šè¶…å‡ºæ®µå°¾ >= 15åˆ†é’Ÿè®¤å®šä¸ºå¼‚å¸¸
    const THRESHOLD_MIN = 15;

    // é¿å…åŒä¸€ key é‡å¤ pushï¼ˆä½¿ç”¨ key æŸ¥é‡ï¼‰
    const existingKeys = new Set(practiceOverrunReminders.map(r => r.key));

    let added = 0;

    Object.keys(studentTimeSlots).forEach(student => {
        if (excused.has(student)) return;
        const slots = studentTimeSlots[student]?.[weekday] || [];
        if (!slots.length) return;

        const room = roomByStudent[student];
        if (!room) return; // ä¸åœ¨æˆ¿é—´ï¼Œæ— æ³•"æŒç»­å ç”¨"

        // è®¡ç®—å®é™…ç™»è®°åˆ†é’Ÿï¼ˆç”¨äºæ’é™¤ç™»è®°åœ¨æ®µå°¾åæ‰è¿›å…¥çš„æ€ªæƒ…å†µï¼‰
        const reg = new Date(room.registerTime);
        const regMin = reg.getHours() * 60 + reg.getMinutes();

        // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šè·å–å­¦ç”Ÿçš„æ‰€æœ‰æ—¶é—´æ®µå¹¶æŒ‰æ—¶é—´æ’åº
        const sortedSlots = [...slots].sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));
        
        // ğŸ”¥ æ–°é€»è¾‘ï¼šæ£€æŸ¥æ¯ä¸ªæ—¶é—´æ®µï¼Œå¦‚æœè¯¥æ—¶é—´æ®µç»“æŸå15åˆ†é’Ÿå†…æ²¡æœ‰å…¶ä»–æ—¶é—´æ®µï¼Œåˆ™æé†’
        sortedSlots.forEach((slot, index) => {
            const endMin = timeToMinutes(slot.end);
            const diff = curMin - endMin;

            if (diff >= THRESHOLD_MIN) {
                // å¿…é¡»æ˜¯"ç™»è®°å¼€å§‹ <= æ®µç»“æŸ"æ‰ç®—åœ¨åŸæ—¶é—´æ®µä¸Šç»§ç»­å ç”¨
                if (regMin > endMin) return;

                // ğŸ”¥ å…³é”®æ£€æŸ¥ï¼šå½“å‰æ—¶é—´æ®µç»“æŸå15åˆ†é’Ÿå†…æ˜¯å¦æœ‰å…¶ä»–æ—¶é—´æ®µ
                let hasFollowingSlot = false;
                for (let j = index + 1; j < sortedSlots.length; j++) {
                    const nextSlot = sortedSlots[j];
                    const nextStartMin = timeToMinutes(nextSlot.start);
                    // å¦‚æœä¸‹ä¸€ä¸ªæ—¶é—´æ®µåœ¨å½“å‰æ—¶é—´æ®µç»“æŸå15åˆ†é’Ÿå†…ï¼Œåˆ™ä¸æé†’
                    if (nextStartMin <= endMin + 15) {
                        hasFollowingSlot = true;
                        break;
                    }
                }
                
                // ğŸ”¥ åªæœ‰åœ¨å½“å‰æ—¶é—´æ®µç»“æŸå15åˆ†é’Ÿå†…æ²¡æœ‰å…¶ä»–æ—¶é—´æ®µæ—¶æ‰æé†’
                if (!hasFollowingSlot) {
                    const key = genOverrunKey(student, slot);
                    if (overrunIgnoredKeys.has(key)) return;
                    if (existingKeys.has(key)) return; // å·²å­˜åœ¨

                    practiceOverrunReminders.push({
                        key,
                        student,
                        room: room.name,
                        slotStart: slot.start,
                        slotEnd: slot.end,
                        createdAt: Date.now()
                    });
                    existingKeys.add(key);
                    added++;
                }
            }
        });
    });

    if (added > 0) {
        // æŒä¹…åŒ– + åŒæ­¥
        persistOverruns(true, 'scan_add', { added });
        updateOverrunPanel();
        console.log(`ğŸ”” æ·»åŠ å¼‚å¸¸æé†’ ${added} æ¡`);
    }
}

/**
 * ğŸ”¥ å·²å¼ƒç”¨ï¼šåˆå¹¶é‡å æˆ–è¿ç»­çš„æ—¶é—´æ®µï¼ˆæ–°é€»è¾‘ä¸å†éœ€è¦åˆå¹¶ï¼‰
 * å¦‚æœä¸¤ä¸ªæ—¶é—´æ®µä¹‹é—´çš„é—´éš” <= 10åˆ†é’Ÿï¼Œåˆ™è®¤ä¸ºæ˜¯è¿ç»­çš„
 */
/*
function mergeOverlappingSlots(slots) {
    if (!slots.length) return [];
    
    const merged = [];
    let current = {
        start: slots[0].start,
        end: slots[0].end,
        originalSlots: [slots[0]]
    };
    
    for (let i = 1; i < slots.length; i++) {
        const slot = slots[i];
        const currentEndMin = timeToMinutes(current.end);
        const slotStartMin = timeToMinutes(slot.start);
        
        // ğŸ”¥ å…³é”®é€»è¾‘ï¼šå¦‚æœé—´éš” <= 10åˆ†é’Ÿï¼Œåˆ™åˆå¹¶
        if (slotStartMin - currentEndMin <= 10) {
            // æ‰©å±•å½“å‰åˆå¹¶æ®µçš„ç»“æŸæ—¶é—´
            const slotEndMin = timeToMinutes(slot.end);
            if (slotEndMin > currentEndMin) {
                current.end = slot.end;
            }
            current.originalSlots.push(slot);
        } else {
            // é—´éš”å¤ªå¤§ï¼Œä¿å­˜å½“å‰æ®µå¹¶å¼€å§‹æ–°æ®µ
            merged.push(current);
            current = {
                start: slot.start,
                end: slot.end,
                originalSlots: [slot]
            };
        }
    }
    
    // æ·»åŠ æœ€åä¸€ä¸ªæ®µ
    merged.push(current);
    
    return merged;
}
*/

function updateOverrunPanel(){
  const panel = $('overrunReminderPanel');
  if(!panel) return;
  const body = $('overrunPanelBody');
  const badge = $('overrunCountBadge');

  const effective = practiceOverrunReminders.filter(r=>!overrunIgnoredKeys.has(r.key));
  
  // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šæ²¡æœ‰å¼‚å¸¸æ—¶å®Œå…¨éšè—é¢æ¿
  if(!effective.length){
    badge.style.display='none';
    panel.style.display='none';
    // ğŸ”¥ æ–°å¢ï¼šæ¸…é™¤æ‰‹åŠ¨å…³é—­æ ‡è®°ï¼ˆä¸ºä¸‹æ¬¡å¼‚å¸¸åšå‡†å¤‡ï¼‰
    panel.dataset.manuallyDismissed = 'false';
    return;
  }

  // ğŸ”¥ æœ‰å¼‚å¸¸æ—¶çš„å¤„ç† - æ£€æŸ¥æ˜¯å¦è¢«ç”¨æˆ·æ‰‹åŠ¨å…³é—­
  panel.style.display='flex';
  
  // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šåªæœ‰åœ¨æœªè¢«æ‰‹åŠ¨å…³é—­æ—¶æ‰è‡ªåŠ¨å±•å¼€
  const wasManuallyDismissed = panel.dataset.manuallyDismissed === 'true';
  if(!wasManuallyDismissed) {
    panel.classList.remove('collapsed');
  }
  
  badge.style.display='inline-block';
  badge.textContent=effective.length;

  const now = new Date();
  const todayTotal = getTodayTotalOverrunCount();
  
  // ğŸ”¥ å…³é”®ï¼šç¡®ä¿ç§»é™¤ç©ºçŠ¶æ€æ˜¾ç¤º
  const emptyEl = body.querySelector('.overrun-empty');
  if(emptyEl) {
    emptyEl.remove();
  }
  
  // æ›´æ–°å¼‚å¸¸é¡¹ç›®
  updateOrCreateOverrunItems(body, effective, now, todayTotal);
}



// ğŸ”¥ æ–°å¢ï¼šå¢é‡æ›´æ–°å‡½æ•°
function updateOrCreateOverrunItems(container, items, now, todayTotal) {
  // æ›´æ–°æˆ–åˆ›å»ºé¡¶éƒ¨ç»Ÿè®¡ä¿¡æ¯
  let statsDiv = container.querySelector('.overrun-stats');
  if(todayTotal > 0) {
    const statsHTML = `ğŸ“Š ä»Šæ—¥å·²è®°å½•æœªè¿˜å¡æ•°ï¼š<strong>${todayTotal}</strong>`;
    if(!statsDiv) {
      statsDiv = document.createElement('div');
      statsDiv.className = 'overrun-stats';
      statsDiv.style.cssText = 'text-align:center;margin-bottom:12px;padding:8px;background:#e8f5e8;border-radius:8px;font-size:12px;color:#27ae60;';
      container.insertBefore(statsDiv, container.firstChild);
    }
    if(statsDiv.innerHTML !== statsHTML) {
      statsDiv.innerHTML = statsHTML;
    }
  } else if(statsDiv) {
    statsDiv.remove();
  }

  // è·å–ç°æœ‰çš„å¼‚å¸¸é¡¹ç›®
  const existingItems = container.querySelectorAll('.overrun-item');
  const existingKeys = Array.from(existingItems).map(item => item.dataset.key);
  const currentKeys = items.map(item => item.key);

  // ç§»é™¤ä¸å†å­˜åœ¨çš„é¡¹ç›®
  existingItems.forEach(item => {
    if(!currentKeys.includes(item.dataset.key)) {
      item.remove();
    }
  });

  // æ›´æ–°æˆ–åˆ›å»ºé¡¹ç›®
  items.forEach((rec, index) => {
    let itemEl = container.querySelector(`[data-key="${rec.key}"]`);
    
    if(!itemEl) {
      // åˆ›å»ºæ–°é¡¹ç›®
      itemEl = document.createElement('div');
      itemEl.className = 'overrun-item';
      itemEl.dataset.key = rec.key;
      container.appendChild(itemEl);
    }

    // ğŸ”¥ å…³é”®ï¼šåªæ›´æ–°æ—¶é—´ç›¸å…³çš„åŠ¨æ€å†…å®¹
    updateOverrunItemContent(itemEl, rec, now);
  });
}

/**
 * ğŸ”¥ ä¿®æ”¹ï¼šæ›´æ–°å¼‚å¸¸é¡¹ç›®å†…å®¹æ˜¾ç¤ºï¼Œæ”¯æŒæ˜¾ç¤ºåˆå¹¶ä¿¡æ¯
 */
function updateOverrunItemContent(itemElement, rec, now) {
    const [dateStr, stu, start, end] = rec.key.split('|');
    const slotEndM = timeToMinutes(rec.slotEnd);
    const nowM = now.getHours() * 60 + now.getMinutes();
    const overMin = Math.max(0, nowM - slotEndM);
    const overTxt = overMin >= 60
        ? `${Math.floor(overMin / 60)}å°æ—¶${overMin % 60 ? overMin % 60 + 'åˆ†é’Ÿ' : ''}`
        : `${overMin}åˆ†é’Ÿ`;

    const major = getStudentMajor(rec.student) || '';
    
    // ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºåŸå§‹æ—¶é—´æ®µä¿¡æ¯ï¼ˆå¦‚æœæ˜¯åˆå¹¶çš„ï¼‰
    let timeSlotDisplay = `${rec.slotStart} - ${rec.slotEnd}`;
    if (rec.originalSlots && rec.originalSlots.length > 1) {
        const originalTimes = rec.originalSlots.map(s => `${s.start}-${s.end}`).join('ï¼Œ');
        timeSlotDisplay += ` (åˆå¹¶: ${originalTimes})`;
    }

    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆé¿å…ä¸å¿…è¦çš„DOMæ“ä½œï¼‰
    const expectedHTML = `
        <div class="overrun-item-header">
            <div>
                ${rec.student}
                <span class="student-major">(${major})</span>
            </div>
            <div class="overrun-over">å¼‚å¸¸${overTxt}</div>
        </div>
        <div class="overrun-item-room">ç´æˆ¿ï¼š${rec.room}</div>
        <div class="overrun-slot">æ—¶é—´æ®µï¼š${timeSlotDisplay}</div>
        <div class="overrun-actions">
            <button class="overrun-btn-ignore" onclick="ignoreOverrun('${rec.key}')" title="å¿½ç•¥æ­¤å¼‚å¸¸ï¼Œä¸è®¡å…¥ç»Ÿè®¡">
                <span>ğŸ¤</span> å¿½ç•¥
            </button>
            <button class="overrun-btn-record" onclick="recordOverrun('${rec.key}')" title="è®°å½•åˆ°æ—¥å¿—å¹¶è®¡å…¥å¼‚å¸¸æ®µæ•°">
                <span>ğŸ“</span> è®°å½•
            </button>
        </div>
    `;

    // åªåœ¨å†…å®¹çœŸæ­£æ”¹å˜æ—¶æ‰æ›´æ–°DOM
    if (itemElement.innerHTML.trim() !== expectedHTML.trim()) {
        itemElement.innerHTML = expectedHTML;
    }
}

/**
 * ä¸€é”®æ¸…ç©ºæ‰€æœ‰å¼‚å¸¸æé†’
 */
function clearAllOverrunReminders() {
  if (!practiceOverrunReminders.length) {
    showToast('æš‚æ— å¼‚å¸¸æé†’éœ€è¦æ¸…ç©º', 2000);
    return;
  }
  
  const count = practiceOverrunReminders.length;
  
  if (!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${count} æ¡å¼‚å¸¸æé†’å—ï¼Ÿ\n\næ³¨æ„ï¼šæ¸…ç©ºåè¿™äº›å¼‚å¸¸å°†ä¸å†æé†’ï¼Œä½†ä¸ä¼šå½±å“å·²è®°å½•çš„å¼‚å¸¸ç»Ÿè®¡ã€‚`)) {
    return;
  }
  
  // å°†æ‰€æœ‰æé†’åŠ å…¥å¿½ç•¥åˆ—è¡¨ï¼ˆé¿å…é‡å¤å‡ºç°ï¼‰
  practiceOverrunReminders.forEach(reminder => {
    overrunIgnoredKeys.add(reminder.key);
  });
  
  // æ¸…ç©ºæé†’åˆ—è¡¨
  practiceOverrunReminders = [];
  
  // æŒä¹…åŒ–å¹¶åŒæ­¥
  persistOverruns(true, 'clear_all', { 
    clearedCount: count,
    timestamp: Date.now(),
    source: 'one_click_clear'
  });
  
  // æ›´æ–°é¢æ¿æ˜¾ç¤º
  updateOverrunPanel();
  
  // è®°å½•æ“ä½œæ—¥å¿—
  logOperation('clear_all_overrun_reminders', {
    count: count,
    timestamp: Date.now(),
    method: 'one_click_clear'
  });
  
  showToast(`å·²æ¸…ç©º ${count} æ¡å¼‚å¸¸æé†’`, 3000);
}

/**
 * å¿½ç•¥ï¼ˆä¸ç»Ÿè®¡è¶…æ—¶æ®µæ•°ï¼‰
 */
// ğŸ”¥ ä¿®å¤ï¼šå¿½ç•¥å¼‚å¸¸æé†’
/**
 * å¿½ç•¥ï¼ˆä¸ç»Ÿè®¡è¶…æ—¶æ®µæ•°ï¼‰
 */
function ignoreOverrun(key) {
  const idx = practiceOverrunReminders.findIndex(r => r.key === key);
  if (idx === -1) {
    showToast('è®°å½•ä¸å­˜åœ¨æˆ–å·²å¤„ç†'); 
    return;
  }
  const rec = practiceOverrunReminders[idx];

  console.log('ğŸ¤ å¿½ç•¥å¼‚å¸¸æé†’:', key, rec);

  // åŠ å…¥å¿½ç•¥é›†åˆå¹¶ä»æé†’åˆ—è¡¨åˆ é™¤
  overrunIgnoredKeys.add(key);
  practiceOverrunReminders.splice(idx, 1);

  // ğŸ”¥ å…³é”®ä¿®å¤ï¼šç¡®ä¿åŒæ­¥
  persistOverruns(true, 'ignore', { 
    key, 
    student: rec.student, 
    room: rec.room,
    timestamp: Date.now()
  });
  
  updateOverrunPanel();
  showToast('å·²å¿½ç•¥è¯¥å¼‚å¸¸ï¼ˆä¸è®¡å…¥ç»Ÿè®¡ï¼‰');
  logOperation('overrun_ignore', { key, student: rec.student, room: rec.room });
}

/**
 * è®°å½•ï¼ˆè®¡å…¥ç»Ÿè®¡ï¼‰
 */
function recordOverrun(key) {
  const rec = practiceOverrunReminders.find(r => r.key === key);
  if (!rec) {
    showToast('è®°å½•ä¸å­˜åœ¨æˆ–å·²å¤„ç†');
    return;
  }

  console.log('ğŸ“ è®°å½•å¼‚å¸¸æé†’:', key, rec);

  // ç»Ÿè®¡ + ç§»é™¤
  incOverrunCount(rec.student, { start: rec.slotStart, end: rec.slotEnd });
  practiceOverrunReminders = practiceOverrunReminders.filter(r => r.key !== key);

  // ğŸ”¥ å…³é”®ä¿®å¤ï¼šç¡®ä¿åŒæ­¥
  persistOverruns(true, 'record', { 
    key, 
    student: rec.student, 
    room: rec.room,
    timestamp: Date.now(),
    newCount: getTodayOverrunCount(rec.student)
  });

  updateOverrunPanel();

  const attModal = $('attendanceModal');
  if (attModal && attModal.style.display === 'block') {
    renderAttendanceList(false);
  }

  showToast('å·²è®°å½•å¼‚å¸¸å¹¶è®¡å…¥æœªè¿˜å¡æ•°');
  logOperation('overrun_record', {
    key,
    student: rec.student,
    room: rec.room,
    slotStart: rec.slotStart,
    slotEnd: rec.slotEnd,
    newCount: getTodayOverrunCount(rec.student)
  });
}



/**
 * å±•å¼€ / æ”¶èµ·é¢æ¿
 */
function toggleOverrunPanel(){
  const p=$('overrunReminderPanel');
  if(!p) return;
  
  const wasCollapsed = p.classList.contains('collapsed');
  p.classList.toggle('collapsed');
  
  // ğŸ”¥ ä¿®æ”¹ï¼šè®°å½•é¢æ¿çŠ¶æ€å’Œæ‰‹åŠ¨å…³é—­çŠ¶æ€
  if(!wasCollapsed) {
    // ç”¨æˆ·ä¸»åŠ¨æ”¶èµ·é¢æ¿
    p.dataset.userCollapsed = 'true';
    p.dataset.manuallyDismissed = 'true';
  } else {
    // ç”¨æˆ·ä¸»åŠ¨å±•å¼€é¢æ¿ - é‡ç½®æ‰‹åŠ¨å…³é—­çŠ¶æ€
    p.dataset.userCollapsed = 'false';
    p.dataset.manuallyDismissed = 'false';
  }
}


/* =============== 11.5. ç»Ÿä¸€æˆ¿é—´çŠ¶æ€ç®¡ç†ç³»ç»Ÿï¼ˆåˆå¹¶å®æ—¶çŠ¶æ€ï¼‰ =============== */

/**
 * ğŸ”¥ ä¼˜åŒ–ï¼šç»Ÿä¸€çš„æˆ¿é—´çŠ¶æ€å˜åŒ–å¤„ç†
 * æ›¿ä»£åŸæ¥çš„å®æ—¶ç»ƒç´çŠ¶æ€ç³»ç»Ÿï¼Œé¿å…é‡å¤åŒæ­¥
 */
function handleRoomStatusChange(changeType, metadata = {}) {
    // ç«‹å³æŒä¹…åŒ–æˆ¿é—´çŠ¶æ€
    persistRooms();
    
    // ğŸ”¥ å…³é”®ï¼šæ£€æµ‹æ˜¯å¦æœ‰å®è´¨æ€§å˜åŒ–
    const hasSignificantChange = detectSignificantRoomChanges();
    
    if (hasSignificantChange || ['room_assign', 'room_clear', 'force_replace'].includes(changeType)) {
        console.log('ğŸ”„ æ£€æµ‹åˆ°é‡è¦æˆ¿é—´çŠ¶æ€å˜åŒ–ï¼Œå‡†å¤‡åŒæ­¥...', changeType);
        
        // ğŸ”¥ ä¼˜åŒ–ï¼šé‡è¦å˜åŒ–ç«‹å³åŒæ­¥ï¼Œå…¶ä»–å˜åŒ–å»¶è¿Ÿåˆå¹¶
        const isImmediate = ['room_assign', 'room_clear', 'force_replace'].includes(changeType);
        const delay = isImmediate ? 200 : 1000;
        
        // æ¸…é™¤ä¹‹å‰çš„åŒæ­¥å®šæ—¶å™¨
        if (window.roomStatusSyncTimeout) {
            clearTimeout(window.roomStatusSyncTimeout);
        }
        
        window.roomStatusSyncTimeout = setTimeout(() => {
            syncToFirebase(changeType, {
                ...metadata,
                timestamp: Date.now(),
                deviceId: deviceId,
                roomCount: rooms.filter(r => r.student).length
            });
            window.roomStatusSyncTimeout = null;
        }, delay);
        
        // è§¦å‘ç›¸å…³UIæ›´æ–°
        updateRelatedComponents(changeType);
        
        return true;
    }
    
    return false;
}
function forcePushRoomsImmediately(actionTag='manual_force'){
    if(!database || !isOnline){
        console.log('[forcePushRoomsImmediately] è·³è¿‡ï¼šç¦»çº¿æˆ–æœªåˆå§‹åŒ–');
        return;
    }
    try{
        const cleanRooms = rooms
            .slice()
            .sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN',{numeric:true}))
            .map(r=>({
                ...r,
                student: r.student || null,
                registerTime: r.registerTime || null,
                lastModified: Date.now()
            }));
        const now = Date.now();
        const updatePayload = {
            [FIREBASE_PATHS.ROOMS]: cleanRooms,
            [FIREBASE_PATHS.LAST_UPDATE]: {
                timestamp: now,
                deviceId,
                action: 'force_push_'+actionTag
            }
        };
        database.ref().update(updatePayload)
          .then(()=>console.log('[forcePushRoomsImmediately] å·²æ¨é€ =>', actionTag))
          .catch(err=>console.warn('[forcePushRoomsImmediately] æ¨é€å¤±è´¥', err));
    }catch(e){
        console.warn('[forcePushRoomsImmediately] å‡ºé”™', e);
    }
}

/**
 * ğŸ”¥ æ–°å¢ï¼šæ£€æµ‹æˆ¿é—´çŠ¶æ€çš„é‡è¦å˜åŒ–
 */
function detectSignificantRoomChanges() {
    // ç”Ÿæˆå½“å‰æˆ¿é—´çŠ¶æ€çš„å…³é”®ä¿¡æ¯å“ˆå¸Œ
    const currentStateKey = rooms
        .filter(r => r.student)
        .map(r => `${r.name}:${r.student}:${r.registerTime}`)
        .sort()
        .join('|');
    
    // æ£€æŸ¥æ˜¯å¦ä¸ä¸Šæ¬¡è®°å½•çš„çŠ¶æ€ä¸åŒ
    if (window.lastRoomStateKey !== currentStateKey) {
        console.log('ğŸ” æˆ¿é—´çŠ¶æ€å˜åŒ–:', {
            old: window.lastRoomStateKey,
            new: currentStateKey
        });
        window.lastRoomStateKey = currentStateKey;
        return true;
    }
    
    return false;
}

/**
 * ğŸ”¥ æ–°å¢ï¼šæ›´æ–°ç›¸å…³ç»„ä»¶
 */
function updateRelatedComponents(changeType) {
    // æ›´æ–°éœ€æ±‚æŒ‰é’®çŠ¶æ€
    updateDemandButtonsStatus();
    
    // å¦‚æœè€ƒå‹¤é¢æ¿æ‰“å¼€ï¼Œåˆ·æ–°è€ƒå‹¤æ•°æ®
    if (isAttendanceModalOpen) {
        setTimeout(() => {
            checkAttendance();
        }, 100);
    }
    
    // å¦‚æœè¶…æ—¶ç®¡ç†é¢æ¿æ‰“å¼€ï¼Œåˆ·æ–°æ•°æ®
    const overtimeModal = document.getElementById('overtimeModal');
    if (overtimeModal && overtimeModal.style.display === 'block') {
        setTimeout(() => {
            renderOvertimeList(true);
        }, 100);
    }
    
    // åˆ·æ–°æœç´¢ç»“æœ
    refreshSearchResults();
    
    // æ›´æ–°æ—¶é—´è½´
    if (timelineVisible) {
        setTimeout(updateTimeline, 100);
    }
}

/**
 * ğŸ”¥ å…¼å®¹å‡½æ•°ï¼šè·å–å­¦ç”Ÿå®æ—¶ç»ƒç´çŠ¶æ€ï¼ˆä»æˆ¿é—´æ•°æ®è®¡ç®—ï¼‰
 */
function getStudentRealTimePracticeStatus(studentName) {
    const room = rooms.find(r => r.student === studentName);
    if (!room) return null;
    
    const now = Date.now();
    const prepEnd = room.registerTime + 60000;
    
    let status, currentDuration;
    
    if (now < prepEnd) {
        status = 'preparing';
        currentDuration = Math.floor((now - room.registerTime) / 1000);
    } else {
        status = 'practicing';
        currentDuration = Math.floor((now - prepEnd) / 1000);
    }
    
    return {
        currentDuration,
        lastUpdated: now,
        room: room.name,
        startTime: room.registerTime,
        status
    };
}

/**
 * ğŸ”¥ å…¼å®¹å‡½æ•°ï¼šç«‹å³è§¦å‘æˆ¿é—´çŠ¶æ€åŒæ­¥
 */
function triggerRealTimePracticeStatusUpdate() {
    handleRoomStatusChange('immediate_update', {
        source: 'manual_trigger',
        timestamp: Date.now()
    });
}

/* =============== 12. ç³»ç»Ÿè®¾ç½® / é‡ç½® / å¤‡ä»½ / æ—¥å¿— / å¯¼å‡ºæ—¥å¿— =============== */
/* =============== äº‘ç«¯è€ƒå‹¤æ—¥å¿—å¢å¼ºåŠŸèƒ½ =============== */

/**
 * ğŸ”¥ æ–°å¢ï¼šå°†è€ƒå‹¤æ•°æ®æŒä¹…åŒ–åˆ°äº‘ç«¯
 */
function syncAttendanceToCloud(attendanceData, dateKey = null) {
    if (!database || !isOnline || !syncEnabled) return;
    
    const key = dateKey || todayKey();
    const cloudData = {
        lastUpdated: Date.now(),  // ğŸ”¥ æ·»åŠ è¿™ä¸ªå…³é”®å­—æ®µ
        date: key,
        timestamp: Date.now(),
        deviceId: deviceId,
        checkTime: attendanceData.checkTime,
        students: attendanceData.students || [],
        endedSlots: attendanceData.endedSlots || [],
        summary: {
            totalStudents: (attendanceData.students || []).length,
            absentCount: (attendanceData.students || []).filter(s => s.finalAttendanceStatus === 'absent').length,
            presentCount: (attendanceData.students || []).filter(s => s.finalAttendanceStatus === 'present').length,
            excusedCount: (attendanceData.students || []).filter(s => s.finalAttendanceStatus === 'excused').length,
            lowEfficiencyCount: (attendanceData.students || []).filter(s => s.finalAttendanceStatus === 'low_efficiency').length,  // ğŸ”¥ å¯é€‰ï¼šæ·»åŠ ä½æ•ˆç‡ç»Ÿè®¡
            underReviewCount: (attendanceData.students || []).filter(s => s.finalAttendanceStatus === 'under_review').length     // ğŸ”¥ å¯é€‰ï¼šæ·»åŠ è§‚å¯Ÿä¸­ç»Ÿè®¡
        }
    };
    
    database.ref(`attendanceRecords/${key}`).set(cloudData)
        .then(() => {
            console.log('âœ… è€ƒå‹¤æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯:', key, 'lastUpdated:', new Date(cloudData.lastUpdated).toLocaleString());
        })
        .catch(error => {
            console.error('âŒ è€ƒå‹¤æ•°æ®åŒæ­¥å¤±è´¥:', error);
        });
}


/**
 * ğŸ”¥ æ–°å¢ï¼šä»äº‘ç«¯è·å–å†å²è€ƒå‹¤æ•°æ®
 */
async function getCloudAttendanceHistory(startDate, endDate) {
    if (!database || !isOnline) {
        throw new Error('æœªè¿æ¥åˆ°äº‘ç«¯æœåŠ¡å™¨');
    }
    
    try {
        const snapshot = await database.ref('attendanceRecords')
            .orderByKey()
            .startAt(startDate)
            .endAt(endDate)
            .once('value');
        
        const records = snapshot.val() || {};
        return Object.values(records).sort((a, b) => a.date.localeCompare(b.date));
    } catch (error) {
        console.error('âŒ è·å–äº‘ç«¯è€ƒå‹¤å†å²å¤±è´¥:', error);
        throw error;
    }
}

/**
 * ğŸ”¥ æ–°å¢ï¼šäº‘ç«¯è€ƒå‹¤æŠ¥å‘Šå¯¼å‡º
 */
/**
 * ğŸ”¥ ä¿®å¤ï¼šäº‘ç«¯è€ƒå‹¤æŠ¥å‘Šå¯¼å‡º - ä½¿ç”¨ä¸æœ¬åœ°ç›¸åŒçš„æ™ºèƒ½æ±‡æ€»ç³»ç»Ÿ
 */
async function exportCloudAttendanceReport() {
    try {
        // æ˜¾ç¤ºå¢å¼ºç‰ˆæ—¥æœŸé€‰æ‹©å™¨
        const options = await showCloudExportOptionsModal();
        if (!options) return;
        
        showToast('ğŸ“¥ æ­£åœ¨ä»äº‘ç«¯è·å–è€ƒå‹¤æ•°æ®...', 3000);
        
        // ä»äº‘ç«¯è·å–æ•°æ®
        const cloudRecords = await getCloudAttendanceHistory(options.dateRange.start, options.dateRange.end);
        
        if (!cloudRecords.length) {
            alert('é€‰æ‹©çš„æ—¥æœŸèŒƒå›´å†…æ²¡æœ‰è€ƒå‹¤è®°å½•');
            return;
        }
        
        // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ä¸æœ¬åœ°ç›¸åŒçš„æ•°æ®å¤„ç†é€»è¾‘
        const reportData = processCloudDataForSmartReport(cloudRecords, options);
        
        // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ä¸æœ¬åœ°ç›¸åŒçš„æŠ¥å‘Šç”Ÿæˆé€»è¾‘
        let csv = generateCloudReportHeader(options.dateRange, options);
        
        if (options.includeSummary) {
            csv += generateSummarySection(reportData, options.dateRange);
        }
        
        // ğŸ”¥ ä½¿ç”¨ç»Ÿä¸€çš„å­¦ç”Ÿæ±‡æ€»æŠ¥å‘Šç”Ÿæˆ
        csv += generateStudentAggregatedReport(reportData, options, options.dateRange);
        
        if (options.includeAnalysis) {
            csv += generateProblemAnalysis(reportData, options.dateRange);
        }
        
        // å¯¼å‡ºæ–‡ä»¶
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `äº‘ç«¯è€ƒå‹¤æ±‡æ€»æŠ¥å‘Š_${options.dateRange.start}_${options.dateRange.end}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`âœ… äº‘ç«¯è€ƒå‹¤æ±‡æ€»æŠ¥å‘Šå·²å¯¼å‡º (${cloudRecords.length}å¤©æ•°æ®)`, 5000);
        
    } catch (error) {
        console.error('âŒ äº‘ç«¯è€ƒå‹¤æŠ¥å‘Šå¯¼å‡ºå¤±è´¥:', error);
        alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
    }
}

/**
 * ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºäº‘ç«¯å¯¼å‡ºé€‰é¡¹æ¨¡æ€æ¡†ï¼ˆä¸æœ¬åœ°å¯¼å‡ºé€‰é¡¹ä¸€è‡´ï¼‰
 */
function showCloudExportOptionsModal() {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.id = 'cloudExportOptionsModal';
        modal.style.cssText = 'position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:3000;display:flex;align-items:center;justify-content:center;';
        
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const weekAgo = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
        const weekAgoStr = weekAgo.toISOString().split('T')[0];
        
        modal.innerHTML = `
            <div style="background:#fff;padding:30px;border-radius:16px;max-width:600px;width:95%;max-height:90vh;overflow-y:auto;">
                <h3 style="margin:0 0 20px;color:var(--primary-color);text-align:center;">â˜ï¸ äº‘ç«¯è€ƒå‹¤æ±‡æ€»å¯¼å‡º</h3>
                
                <!-- æ—¥æœŸèŒƒå›´é€‰æ‹© -->
                <div class="export-section" style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                    <h4 style="margin:0 0 10px;color:#2c3e50;">ğŸ“… æ—¥æœŸèŒƒå›´</h4>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="radio" name="cloudDateRange" value="today" checked>
                            <span>ä»…ä»Šå¤© (${todayStr})</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="radio" name="cloudDateRange" value="yesterday">
                            <span>æ˜¨å¤©</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="radio" name="cloudDateRange" value="week">
                            <span>æœ€è¿‘7å¤© (${weekAgoStr} è‡³ ${todayStr})</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="radio" name="cloudDateRange" value="custom">
                            <span>è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´</span>
                        </label>
                    </div>
                    
                    <!-- è‡ªå®šä¹‰æ—¥æœŸè¾“å…¥ -->
                    <div id="cloudCustomDateInputs" style="display:none;margin-top:10px;padding:10px;background:#fff;border-radius:6px;border:1px solid #ddd;">
                        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                            <label>å¼€å§‹æ—¥æœŸï¼š<input type="date" id="cloudStartDate" value="${weekAgoStr}" style="margin-left:5px;"></label>
                            <label>ç»“æŸæ—¥æœŸï¼š<input type="date" id="cloudEndDate" value="${todayStr}" style="margin-left:5px;"></label>
                        </div>
                    </div>
                </div>
                
                <!-- å†…å®¹ç­›é€‰ -->
                <div class="export-section" style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                    <h4 style="margin:0 0 10px;color:#2c3e50;">ğŸ” å†…å®¹ç­›é€‰</h4>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="cloudIncludeAllStudents" checked>
                            <span>åŒ…å«æ‰€æœ‰å­¦ç”Ÿæ±‡æ€»</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="cloudHighlightProblems" checked>
                            <span>çªå‡ºæ˜¾ç¤ºé—®é¢˜å­¦ç”Ÿï¼ˆç¼ºå‹¤/ä½æ•ˆï¼‰</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="cloudIncludeExcused">
                            <span>åŒ…å«è¯·å‡å­¦ç”Ÿè¯¦æƒ…</span>
                        </label>
                    </div>
                </div>
                
                <!-- æŠ¥å‘Šæ ¼å¼ -->
                <div class="export-section" style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                    <h4 style="margin:0 0 10px;color:#2c3e50;">ğŸ“‹ æŠ¥å‘Šæ ¼å¼</h4>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="cloudIncludeSummary" checked>
                            <span>åŒ…å«æ•´ä½“ç»Ÿè®¡æ±‡æ€»</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="cloudIncludeAnalysis" checked>
                            <span>åŒ…å«é—®é¢˜å­¦ç”Ÿåˆ†æ</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="cloudIncludePracticeDetails" checked>
                            <span>åŒ…å«è¯¦ç»†ç»ƒç´æ—¶é—´</span>
                        </label>
                    </div>
                </div>
                
                <!-- ä¸“ä¸šç­›é€‰ -->
                <div class="export-section" style="margin-bottom:25px;padding:15px;background:#f8f9fa;border-radius:8px;">
                    <h4 style="margin:0 0 10px;color:#2c3e50;">ğŸ“ ä¸“ä¸šç­›é€‰</h4>
                    <select id="cloudMajorFilterExport" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                        <option value="">æ‰€æœ‰ä¸“ä¸š</option>
                        ${Object.keys(studentDatabase).sort().map(major => 
                            `<option value="${major}">${major}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div style="display:flex;justify-content:flex-end;gap:12px;">
                    <button id="cancelCloudExportOptions" style="padding:10px 20px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;">å–æ¶ˆ</button>
                    <button id="generateCloudReportBtn" style="padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:6px;cursor:pointer;">ğŸ“Š ç”Ÿæˆäº‘ç«¯æ±‡æ€»æŠ¥å‘Š</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // äº‹ä»¶ç»‘å®š
        modal.addEventListener('change', (e) => {
            if (e.target.name === 'cloudDateRange') {
                const customInputs = modal.querySelector('#cloudCustomDateInputs');
                if (customInputs) {
                    customInputs.style.display = e.target.value === 'custom' ? 'block' : 'none';
                }
            }
        });
        
        const cancelBtn = modal.querySelector('#cancelCloudExportOptions');
        const generateBtn = modal.querySelector('#generateCloudReportBtn');
        
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
                resolve(null);
            });
        }
        
        if (generateBtn) {
            generateBtn.addEventListener('click', () => {
                // æ”¶é›†é€‰é¡¹
                const options = {
                    dateRange: getCloudDateRange(modal),
                    includeAllStudents: modal.querySelector('#cloudIncludeAllStudents').checked,
                    highlightProblems: modal.querySelector('#cloudHighlightProblems').checked,
                    includeExcused: modal.querySelector('#cloudIncludeExcused').checked,
                    includeSummary: modal.querySelector('#cloudIncludeSummary').checked,
                    includeAnalysis: modal.querySelector('#cloudIncludeAnalysis').checked,
                    includePracticeDetails: modal.querySelector('#cloudIncludePracticeDetails').checked,
                    majorFilter: modal.querySelector('#cloudMajorFilterExport').value
                };
                
                document.body.removeChild(modal);
                resolve(options);
            });
        }
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
                resolve(null);
            }
        });
    });
}

/**
 * ğŸ”¥ æ–°å¢ï¼šè·å–äº‘ç«¯å¯¼å‡ºçš„æ—¥æœŸèŒƒå›´
 */
function getCloudDateRange(modal) {
    const selectedRange = modal.querySelector('input[name="cloudDateRange"]:checked').value;
    const today = new Date();
    let startDate, endDate;
    
    switch (selectedRange) {
        case 'today':
            startDate = endDate = new Date(today);
            break;
        case 'yesterday':
            startDate = endDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            break;
        case 'week':
            startDate = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
            endDate = new Date(today);
            break;
        case 'custom':
            startDate = new Date(modal.querySelector('#cloudStartDate').value);
            endDate = new Date(modal.querySelector('#cloudEndDate').value);
            break;
    }
    
    return {
        start: startDate.toISOString().split('T')[0],
        end: endDate.toISOString().split('T')[0],
        startStr: startDate.toISOString().split('T')[0],
        endStr: endDate.toISOString().split('T')[0],
        days: Math.ceil((endDate - startDate) / (24 * 60 * 60 * 1000)) + 1
    };
}

/**
 * ğŸ”¥ æ–°å¢ï¼šå¤„ç†äº‘ç«¯æ•°æ®ä»¥é€‚é…æ™ºèƒ½æŠ¥å‘Šç³»ç»Ÿ
 */
function processCloudDataForSmartReport(cloudRecords, options) {
    const data = {
        studentSummaries: new Map(),
        dailyStats: {},
        problemStudents: {
            consecutive: [],
            lowEfficiency: [],
            frequent: []
        }
    };
    
    // å¤„ç†æ¯å¤©çš„è®°å½•
    cloudRecords.forEach(dayRecord => {
        const allStudents = [...(dayRecord.students || []), ...(dayRecord.endedSlots || [])];
        
        // æŒ‰ä¸“ä¸šç­›é€‰
        const filteredStudents = options.majorFilter 
            ? allStudents.filter(s => s.major === options.majorFilter)
            : allStudents;
        
        // æŒ‰å­¦ç”Ÿæ±‡æ€»æ•°æ®
        filteredStudents.forEach(record => {
            const studentName = record.name;
            let studentMajor = record.major;
            
            // ç¡®ä¿ä¸“ä¸šä¿¡æ¯æ­£ç¡®
            if (!studentMajor || studentMajor === 'æœªçŸ¥ä¸“ä¸š') {
                studentMajor = getStudentMajor(studentName);
            }
            
            if (!data.studentSummaries.has(studentName)) {
                data.studentSummaries.set(studentName, {
                    name: studentName,
                    major: studentMajor,
                    totalSlots: 0,
                    presentSlots: 0,
                    lowEfficiencySlots: 0,
                    absentSlots: 0,
                    excusedSlots: 0,
                    underReviewSlots: 0,
                    totalPracticeTime: 0,
                    totalPlannedTime: 0,
                    timeSlots: [],
                    overrunCount: 0,
                    finalStatus: 'unknown',
                    attendanceRate: 0
                });
            }
            
            const summary = data.studentSummaries.get(studentName);
            
            // ç¡®ä¿ä¸“ä¸šä¿¡æ¯ä¸€è‡´
            if (!summary.major || summary.major === 'æœªçŸ¥ä¸“ä¸š') {
                summary.major = studentMajor;
            }
            
            summary.totalSlots++;
            summary.totalPracticeTime += record.practicedSec || 0;
            summary.totalPlannedTime += (record.totalPlannedMinutes || 0) * 60;
            summary.overrunCount += record.overrunCountToday || 0;
            
            // è®°å½•æ—¶é—´æ®µè¯¦æƒ…
            summary.timeSlots.push({
                date: dayRecord.date,
                timeRange: `${record.start}-${record.end}`,
                status: record.finalAttendanceStatus,
                statusText: record.finalStatusText,
                practiceTime: record.practicedSec || 0,
                plannedTime: (record.totalPlannedMinutes || 0) * 60
            });
            
            // ç»Ÿè®¡å„çŠ¶æ€æ•°é‡
            switch (record.finalAttendanceStatus) {
                case 'present':
                    summary.presentSlots++;
                    break;
                case 'low_efficiency':
                    summary.lowEfficiencySlots++;
                    break;
                case 'absent':
                    summary.absentSlots++;
                    break;
                case 'excused':
                    summary.excusedSlots++;
                    break;
                case 'under_review':
                    summary.underReviewSlots++;
                    break;
            }
        });
    });
    
    // è®¡ç®—æœ€ç»ˆç»Ÿè®¡
    data.studentSummaries.forEach((summary, studentName) => {
        // è®¡ç®—å‡ºå‹¤ç‡ï¼ˆæ’é™¤è¯·å‡ï¼‰
        const effectiveSlots = summary.totalSlots - summary.excusedSlots;
        if (effectiveSlots > 0) {
            summary.attendanceRate = ((summary.presentSlots + summary.lowEfficiencySlots) / effectiveSlots * 100);
        }
        
        // è®¡ç®—ç»ƒç´å®Œæˆç‡
        summary.practiceCompletionRate = summary.totalPlannedTime > 0 
            ? (summary.totalPracticeTime / summary.totalPlannedTime * 100) 
            : 0;
        
        // ç»¼åˆè¯„ä¼°æœ€ç»ˆçŠ¶æ€
        if (summary.excusedSlots === summary.totalSlots) {
            summary.finalStatus = 'excused';
        } else if (summary.absentSlots >= summary.totalSlots * 0.5) {
            summary.finalStatus = 'mostly_absent';
        } else if (summary.attendanceRate >= 80) {
            summary.finalStatus = 'good';
        } else if (summary.attendanceRate >= 60) {
            summary.finalStatus = 'fair';
        } else {
            summary.finalStatus = 'poor';
        }
    });
    
    // åˆ†æé—®é¢˜å­¦ç”Ÿ
    data.problemStudents = analyzeProblemStudentsFromSummaries(data.studentSummaries, options.dateRange);
    
    return data;
}

/**
 * ğŸ”¥ æ–°å¢ï¼šç”Ÿæˆäº‘ç«¯æŠ¥å‘Šå¤´éƒ¨
 */
function generateCloudReportHeader(dateRange, options) {
    const rangeText = dateRange.days === 1 
        ? `${dateRange.startStr}` 
        : `${dateRange.startStr} è‡³ ${dateRange.endStr}`;
    
    return `äº‘ç«¯è€ƒå‹¤æ±‡æ€»æŠ¥å‘Š
æŠ¥å‘Šæ—¥æœŸèŒƒå›´: ${rangeText}
ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
æ•°æ®æ¥æº: Firebase äº‘ç«¯æ•°æ®åº“
ç­›é€‰æ¡ä»¶: ${options.majorFilter || 'æ‰€æœ‰ä¸“ä¸š'}
${options.highlightProblems ? 'âœ“ çªå‡ºé—®é¢˜å­¦ç”Ÿ' : ''}
${options.includeExcused ? 'âœ“ åŒ…å«è¯·å‡è¯¦æƒ…' : ''}

`;
}

/**
 * ğŸ”¥ æ–°å¢ï¼šæ—¥æœŸèŒƒå›´é€‰æ‹©å™¨
 */
function showDateRangeSelector() {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:3000;display:flex;align-items:center;justify-content:center;';
        
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        modal.innerHTML = `
            <div style="background:#fff;padding:30px;border-radius:16px;max-width:500px;width:95%;">
                <h3 style="margin:0 0 20px;color:var(--primary-color);text-align:center;">â˜ï¸ äº‘ç«¯è€ƒå‹¤æŠ¥å‘Šå¯¼å‡º</h3>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block;margin-bottom:8px;font-weight:600;">å¼€å§‹æ—¥æœŸï¼š</label>
                    <input type="date" id="cloudStartDate" value="${weekAgo}" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                </div>
                
                <div style="margin-bottom:25px;">
                    <label style="display:block;margin-bottom:8px;font-weight:600;">ç»“æŸæ—¥æœŸï¼š</label>
                    <input type="date" id="cloudEndDate" value="${today}" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                </div>
                
                <div style="display:flex;justify-content:flex-end;gap:12px;">
                    <button id="cancelCloudExport" style="padding:10px 20px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;">å–æ¶ˆ</button>
                    <button id="confirmCloudExport" style="padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:6px;cursor:pointer;">å¯¼å‡º</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.querySelector('#cancelCloudExport').onclick = () => {
            document.body.removeChild(modal);
            resolve(null);
        };
        
        modal.querySelector('#confirmCloudExport').onclick = () => {
            const startDate = modal.querySelector('#cloudStartDate').value;
            const endDate = modal.querySelector('#cloudEndDate').value;
            
            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å®Œæ•´çš„æ—¥æœŸèŒƒå›´');
                return;
            }
            
            if (startDate > endDate) {
                alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }
            
            document.body.removeChild(modal);
            resolve({ start: startDate, end: endDate });
        };
    });
}

/**
 * ğŸ”¥ æ–°å¢ï¼šç”Ÿæˆç»¼åˆè€ƒå‹¤æŠ¥å‘Š
 */
function generateComprehensiveAttendanceReport(cloudRecords, dateRange) {
    let report = `äº‘ç«¯è€ƒå‹¤ç»¼åˆæŠ¥å‘Š
å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}
æ•°æ®èŒƒå›´: ${dateRange.start} è‡³ ${dateRange.end}
æ•°æ®æ¥æº: Firebase äº‘ç«¯æ•°æ®åº“
è®°å½•å¤©æ•°: ${cloudRecords.length}

`;

    // æŒ‰å­¦ç”Ÿæ±‡æ€»ç»Ÿè®¡
    const studentStats = new Map();
    
    cloudRecords.forEach(dayRecord => {
        const allStudents = [...(dayRecord.students || []), ...(dayRecord.endedSlots || [])];
        
        allStudents.forEach(student => {
            if (!studentStats.has(student.name)) {
                studentStats.set(student.name, {
                    name: student.name,
                    major: student.major,
                    totalDays: 0,
                    presentDays: 0,
                    absentDays: 0,
                    excusedDays: 0,
                    lowEfficiencyDays: 0,
                    totalPracticeTime: 0,
                    details: []
                });
            }
            
            const stats = studentStats.get(student.name);
            stats.totalDays++;
            stats.totalPracticeTime += student.practicedSec || 0;
            
            switch (student.finalAttendanceStatus) {
                case 'present':
                    stats.presentDays++;
                    break;
                case 'absent':
                    stats.absentDays++;
                    break;
                case 'excused':
                    stats.excusedDays++;
                    break;
                case 'low_efficiency':
                    stats.lowEfficiencyDays++;
                    break;
            }
            
            stats.details.push({
                date: dayRecord.date,
                status: student.finalAttendanceStatus,
                statusText: student.finalStatusText,
                practiceTime: student.practicedSec || 0,
                timeSlot: `${student.start}-${student.end}`
            });
        });
    });
    
    // ç”Ÿæˆå­¦ç”Ÿæ±‡æ€»è¡¨
    report += `=== å­¦ç”Ÿè€ƒå‹¤æ±‡æ€» ===
å­¦ç”Ÿå§“å,ä¸“ä¸š,æ€»å¤©æ•°,æ­£å¸¸å‡ºå‹¤,ç¼ºå‹¤,è¯·å‡,ä½æ•ˆ,å‡ºå‹¤ç‡,æ€»ç»ƒç´æ—¶é•¿(å°æ—¶)
`;
    
    Array.from(studentStats.values())
        .sort((a, b) => a.major.localeCompare(b.major) || a.name.localeCompare(b.name))
        .forEach(stats => {
            const attendanceRate = stats.totalDays > 0 
                ? ((stats.presentDays + stats.lowEfficiencyDays) / (stats.totalDays - stats.excusedDays) * 100).toFixed(1)
                : '0.0';
            const practiceHours = (stats.totalPracticeTime / 3600).toFixed(1);
            
            report += `${escapeCSV(stats.name)},${escapeCSV(stats.major)},${stats.totalDays},${stats.presentDays},${stats.absentDays},${stats.excusedDays},${stats.lowEfficiencyDays},${attendanceRate}%,${practiceHours}\n`;
        });
    
    // ç”Ÿæˆæ¯æ—¥è¯¦ç»†è®°å½•
    report += `\n=== æ¯æ—¥è¯¦ç»†è®°å½• ===
æ—¥æœŸ,å­¦ç”Ÿå§“å,ä¸“ä¸š,æ—¶é—´æ®µ,è€ƒå‹¤çŠ¶æ€,çŠ¶æ€è¯¦æƒ…,ç»ƒç´æ—¶é•¿(åˆ†é’Ÿ)
`;
    
    cloudRecords.forEach(dayRecord => {
        const allStudents = [...(dayRecord.students || []), ...(dayRecord.endedSlots || [])];
        
        allStudents
            .sort((a, b) => a.major.localeCompare(b.major) || a.name.localeCompare(b.name))
            .forEach(student => {
                const practiceMinutes = Math.floor((student.practicedSec || 0) / 60);
                
                report += `${dayRecord.date},${escapeCSV(student.name)},${escapeCSV(student.major)},${student.start}-${student.end},${student.finalAttendanceStatus},${escapeCSV(student.finalStatusText)},${practiceMinutes}\n`;
            });
    });
    
    return report;
}

/**
 * ğŸ”¥ ä¿®æ”¹ç°æœ‰çš„è€ƒå‹¤æ£€æŸ¥å‡½æ•°ï¼Œæ·»åŠ äº‘ç«¯åŒæ­¥
 */
const originalCheckAttendance = checkAttendance;
checkAttendance = function() {
    originalCheckAttendance();
    
    // å¦‚æœæœ‰è€ƒå‹¤æ•°æ®ï¼ŒåŒæ­¥åˆ°äº‘ç«¯
    if (attendanceData && (attendanceData.students?.length > 0 || attendanceData.endedSlots?.length > 0)) {
        // å»¶è¿ŸåŒæ­¥ï¼Œé¿å…é¢‘ç¹å†™å…¥
        clearTimeout(window.attendanceSyncTimeout);
        window.attendanceSyncTimeout = setTimeout(() => {
            syncAttendanceToCloud(attendanceData);
        }, 30000); // 30ç§’ååŒæ­¥
    }
};

function updateDurationPreview(){
  const m=parseInt($('baseDurationInput').value)||120;
  const h=Math.floor(m/60),mm=m%60;
  $('durationPreview').textContent='å½“å‰è®¾ç½®ï¼š'+(h?(h+'å°æ—¶'+(mm?mm+'åˆ†é’Ÿ':'')):m+'åˆ†é’Ÿ');
}
function updateResetTimePreview(){
  const h=pad2(parseInt($('resetHourInput').value)||21);
  const m=pad2(parseInt($('resetMinuteInput').value)||45);
  $('resetTimePreview').textContent=`å½“å‰è®¾ç½®ï¼š${h}:${m}`;
}

function updateStartAnomalyPreview(){
  const h = parseInt($('startAnomalyHourInput').value) || 8;
  const m = parseInt($('startAnomalyMinuteInput').value) || 0;
  $('startAnomalyPreview').textContent = `å½“å‰è®¾ç½®ï¼š${pad2(h)}:${pad2(m)}å¼€å§‹`;
}

function updateStopAnomalyPreview(){
  const h = parseInt($('stopAnomalyHourInput').value) || 19;
  const m = parseInt($('stopAnomalyMinuteInput').value) || 0;
  $('stopAnomalyPreview').textContent = `å½“å‰è®¾ç½®ï¼š${pad2(h)}:${pad2(m)}ååœæ­¢`;
}

function openSettingsModal(){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  $('baseDurationInput').value=systemSettings.basePracticeDuration;
  $('resetHourInput').value=systemSettings.autoResetHour;
  $('resetMinuteInput').value=systemSettings.autoResetMinute;
  $('startAnomalyHourInput').value=systemSettings.startAnomalyCheckHour;
  $('startAnomalyMinuteInput').value=systemSettings.startAnomalyCheckMinute || 0;
  $('stopAnomalyHourInput').value=systemSettings.stopAnomalyCheckHour;
  $('stopAnomalyMinuteInput').value=systemSettings.stopAnomalyCheckMinute || 0;
  $('loginPasswordInput').value='';
  $('adminPasswordInput').value='';
  
  // ğŸ”¥ æ–°å¢ï¼šè‡ªåŠ¨é”å®šè®¾ç½®åˆå§‹åŒ–
  $('autoLockEnabledInput').checked = systemSettings.autoLockEnabled !== false;
  $('autoLockTimeInput').value = systemSettings.autoLockTimeMinutes || 10;
  
  // ğŸ”¥ æ–°å¢ï¼šæ•°æ®ä¿æŠ¤æ¨¡å¼è®¾ç½®
  const dataProtectionCheckbox = document.getElementById('dataProtectionMode');
  if (dataProtectionCheckbox) {
    dataProtectionCheckbox.checked = systemSettings.dataProtectionMode || false;
  }
  
  updateDurationPreview();
  updateResetTimePreview();
  updateStartAnomalyPreview();
  updateStopAnomalyPreview();
  updateAutoLockPreview(); // ğŸ”¥ æ–°å¢
  $('settingsModal').style.display='block';
}



function closeSettingsModal(){ $('settingsModal').style.display='none'; }
function togglePasswordVisibility(id){
  const inp=$(id); if(!inp)return;
  inp.type = inp.type==='password'?'text':'password';
}
// ===== æ–°å¢ï¼šåŸºç¡€ç»ƒç´æ—¶é•¿ä¿®æ”¹åçš„å³æ—¶åˆ·æ–° =====
function applyAfterBaseDurationChange(){
  // å¼ºåˆ¶é‡æ–°æ¸²æŸ“æˆ¿é—´ï¼ˆå«çŠ¶æ€ä¸æ ·å¼ï¼‰
  needsFullUpdate = true;
  updateRooms();

  // é‡æ–°è®¡ç®—é˜Ÿåˆ—ç­‰å¾…æ—¶é—´ï¼ˆupdateQueueDisplay å†…éƒ¨ä¼šé‡ç®— computeQueueWaitsï¼‰
  updateQueueDisplay();

  // æ—¶é—´è½´ / Focus
  if (timelineVisible) {
    updateTimeline();
  }

  // è‹¥è¶…æ—¶ç®¡ç†é¢æ¿æ‰“å¼€ï¼Œåˆ·æ–°
  const otModal = $('overtimeModal');
  if (otModal && otModal.style.display === 'block') {
    renderOvertimeList(true);
  }

  // åˆ·æ–°å¾½ç«  / æŒ‰é’®
  refreshOvertimeBadge();
  updateDemandButtonsStatus();

  // è‹¥è€ƒå‹¤é¢æ¿æ‰“å¼€ï¼ˆè™½ç„¶è€ƒå‹¤ä¸åŸºç¡€æ—¶é•¿å…³ç³»è¾ƒå¼±ï¼‰ï¼Œå¯é€‰æ‹©åˆ·æ–°
  const attModal = $('attendanceModal');
  if (attModal && attModal.style.display === 'block') {
    renderAttendanceList(true);
  }
}
function saveSettings(){
  const dur=parseInt($('baseDurationInput').value);
  const h=parseInt($('resetHourInput').value);
  const m=parseInt($('resetMinuteInput').value);
  const startHour=parseInt($('startAnomalyHourInput').value);
  const startMinute=parseInt($('startAnomalyMinuteInput').value);
  const stopHour=parseInt($('stopAnomalyHourInput').value);
  const stopMinute=parseInt($('stopAnomalyMinuteInput').value);
  const newPwd=$('loginPasswordInput').value.trim();
  const adminPwd=$('adminPasswordInput').value.trim();
  
  // ğŸ”¥ æ–°å¢ï¼šè‡ªåŠ¨é”å®šè®¾ç½®éªŒè¯
  const autoLockEnabled = $('autoLockEnabledInput').checked;
  const autoLockTime = parseInt($('autoLockTimeInput').value);
  
  if(isNaN(dur)||dur<1||dur>240){alert('ç»ƒç´æ—¶é•¿1-240');return;}
  if(isNaN(h)||h<0||h>23||isNaN(m)||m<0||m>59){alert('é‡ç½®æ—¶é—´ä¸åˆæ³•');return;}
  if(isNaN(startHour)||startHour<0||startHour>23||isNaN(startMinute)||startMinute<0||startMinute>59){
    alert('å¼‚å¸¸æ£€æŸ¥å¼€å§‹æ—¶é—´ä¸åˆæ³•');return;
  }
  if(isNaN(stopHour)||stopHour<0||stopHour>23||isNaN(stopMinute)||stopMinute<0||stopMinute>59){
    alert('å¼‚å¸¸æ£€æŸ¥åœæ­¢æ—¶é—´ä¸åˆæ³•');return;
  }
  
  // ğŸ”¥ æ–°å¢ï¼šè‡ªåŠ¨é”å®šæ—¶é—´éªŒè¯
  if(autoLockEnabled && (isNaN(autoLockTime)||autoLockTime<1||autoLockTime>120)){
    alert('è‡ªåŠ¨é”å®šæ—¶é—´èŒƒå›´ï¼š1-120åˆ†é’Ÿ');return;
  }
  
  let pwdChanged=false;
  if(newPwd){
    if(adminPwd!==systemSettings.adminPassword){alert('ç®¡ç†å‘˜å¯†ç é”™è¯¯');return;}
    systemSettings.loginPassword=newPwd;pwdChanged=true;
  }
  
  const oldReset=`${pad2(systemSettings.autoResetHour)}:${pad2(systemSettings.autoResetMinute)}`;
  const oldDur = systemSettings.basePracticeDuration;
  const oldAutoLockEnabled = systemSettings.autoLockEnabled;
  const oldAutoLockTime = systemSettings.autoLockTimeMinutes;

  systemSettings.basePracticeDuration=dur;
  systemSettings.autoResetHour=h;
  systemSettings.autoResetMinute=m;
  systemSettings.startAnomalyCheckHour=startHour;
  systemSettings.startAnomalyCheckMinute=startMinute;
  systemSettings.stopAnomalyCheckHour=stopHour;
  systemSettings.stopAnomalyCheckMinute=stopMinute;
  
  // ğŸ”¥ æ–°å¢ï¼šä¿å­˜è‡ªåŠ¨é”å®šè®¾ç½®
  systemSettings.autoLockEnabled = autoLockEnabled;
  systemSettings.autoLockTimeMinutes = autoLockTime;
  
  persistSettings();
  closeSettingsModal();

  const newReset=`${pad2(h)}:${pad2(m)}`;
  const startTime=`${pad2(startHour)}:${pad2(startMinute)}`;
  const stopTime=`${pad2(stopHour)}:${pad2(stopMinute)}`;
  
  // ğŸ”¥ æ–°å¢ï¼šè‡ªåŠ¨é”å®šè®¾ç½®å˜åŒ–å¤„ç†
  if(oldAutoLockEnabled !== autoLockEnabled || oldAutoLockTime !== autoLockTime) {
    if(autoLockEnabled) {
      // é‡æ–°å¯åŠ¨è‡ªåŠ¨é”å®šï¼ˆå¦‚æœç³»ç»Ÿæœªé”å®šï¼‰
      if(!isLocked) {
        disableAutoLock(); // å…ˆåœç”¨æ—§çš„
        initAutoLock();    // å†å¯ç”¨æ–°çš„
      }
      showToast(`è‡ªåŠ¨é”å®šå·²${oldAutoLockEnabled ? 'æ›´æ–°' : 'å¯ç”¨'}ï¼š${autoLockTime}åˆ†é’Ÿæ— æ“ä½œåé”å®š`);
    } else {
      // ç¦ç”¨è‡ªåŠ¨é”å®š
      disableAutoLock();
      showToast('è‡ªåŠ¨é”å®šå·²ç¦ç”¨');
    }
  }
  
  if(oldReset!==newReset){
    const d=new Date();d.setDate(d.getDate()-1);
    lastResetDate = toDateKey(d);
    persistReset();
    showToast(`é‡ç½®æ—¶é—´å·²ä¿®æ”¹ä¸º ${newReset}ï¼Œå¼‚å¸¸æ£€æŸ¥æ—¶é—´ï¼š${startTime}-${stopTime}`);
  }else{
    showToast('è®¾ç½®å·²ä¿å­˜');
  }

  logOperation('update_settings',{
    duration:dur,
    reset:newReset,
    startAnomalyTime:startTime,
    stopAnomalyTime:stopTime,
    autoLockEnabled: autoLockEnabled,      // ğŸ”¥ æ–°å¢
    autoLockTimeMinutes: autoLockTime,     // ğŸ”¥ æ–°å¢
    passwordChanged:pwdChanged
  });

  // åŸºç¡€æ—¶é•¿å˜åŒ–åç«‹å³åˆ·æ–°æ‰€æœ‰çŠ¶æ€
  if(dur !== oldDur){
    applyAfterBaseDurationChange();
  }else{
    applyAfterBaseDurationChange();
  }
}


function manualReset(){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  if(!confirm('ç¡®å®šæ‰‹åŠ¨é‡ç½®ï¼Ÿ'))return;
  
  // ğŸ”¥ æ–°å¢ï¼šæ ‡è®°ä¸ºç”¨æˆ·ä¸»åŠ¨æ“ä½œ
  lastUserDestructiveActionTs = Date.now();
  
  performAutoReset();
  cleanupEmptyMajors();
  refreshAllMajorSelectors();
  showToast('æ‰‹åŠ¨é‡ç½®å®Œæˆ');
}

function performAutoReset(){
  const now=Date.now();
  const todayStr = todayKey();
  let cleared=0,queued=queueList.grand.length+queueList.upright.length+queueList.none.length;
  
  // ğŸ”¥ æ–°å¢ï¼šæ ‡è®°ä¸ºç”¨æˆ·ä¸»åŠ¨é‡ç½®æ“ä½œ
  lastUserDestructiveActionTs = Date.now();
  
  rooms.forEach(r=>{
    if(r.student){
      addPracticeLog(r.student,r.name,r.registerTime,now,'ç³»ç»Ÿé‡ç½®');
      r.student=null;r.registerTime=null;cleared++;
    }
  });
  
  // ğŸ”¥ æ–°å¢ï¼šç»“æŸæ‰€æœ‰æ´»è·ƒçš„ç»ƒä¹ ä¼šè¯
  practiceSessionTracker.forEach((session, sessionId) => {
      if (session.isActive) {
          endPracticeSession(sessionId, now, 'ç³»ç»Ÿé‡ç½®');
      }
  });
  practiceSessionTracker.clear();

  queueList={grand:[],upright:[],none:[]};
  lastResetDate=todayKey();
  persistReset();
  persistRooms();persistQueues();
  
  // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šé‡ç½®åç«‹å³å¼ºåˆ¶åŒæ­¥åˆ°äº‘ç«¯
  if (syncEnabled && isOnline && database) {
    // ç¦ç”¨å¸¸è§„åŒæ­¥ï¼Œä½¿ç”¨å¼ºåˆ¶åŒæ­¥
    syncEnabled = false;
    
    const resetData = {
      timestamp: now,
      deviceId: deviceId,
      action: 'system_reset',
      clearedRooms: cleared,
      clearedQueues: queued,
      resetDate: todayStr
    };
    
    // ç«‹å³æ¨é€é‡ç½®çŠ¶æ€åˆ°äº‘ç«¯
    const updates = {};
    updates[FIREBASE_PATHS.ROOMS] = rooms.map(r => ({
      ...r,
      student: null,
      registerTime: null
    }));
    updates[FIREBASE_PATHS.QUEUE] = {grand:[],upright:[],none:[]};
    updates[FIREBASE_PATHS.LAST_UPDATE] = resetData;
    
    database.ref().update(updates)
      .then(() => {
        console.log('âœ… ç³»ç»Ÿé‡ç½®å·²åŒæ­¥åˆ°äº‘ç«¯');
        // å»¶è¿Ÿé‡æ–°å¯ç”¨åŒæ­¥
        setTimeout(() => {
          syncEnabled = true;
        }, 2000);
      })
      .catch(error => {
        console.error('âŒ ç³»ç»Ÿé‡ç½®åŒæ­¥å¤±è´¥:', error);
        syncEnabled = true;
      });
  }
  
  needsFullUpdate=true;updateRooms();updateQueueDisplay();
  logOperation('auto_reset',{rooms:cleared,queues:queued});
}


function checkAutoReset(){
  const now = new Date();
  const todayKeyStr = todayKey();  // ç»Ÿä¸€æ ¼å¼ YYYY-MM-DD
  const currentM = now.getHours()*60 + now.getMinutes();
  const targetM = systemSettings.autoResetHour*60 + systemSettings.autoResetMinute;
  if (currentM >= targetM && lastResetDate !== todayKeyStr){
    performAutoReset();            // å†…éƒ¨å·²è®¾ç½® lastResetDate = todayKey()
    showToast(`å·²è‡ªåŠ¨é‡ç½® (${pad2(now.getHours())}:${pad2(now.getMinutes())})`);
  }
  updateAutoResetInfo();
}
function updateAutoResetInfo(){
  const info = $('autoResetInfo');
  if(!info) return;

  const now = new Date();
  const next = new Date();
  next.setHours(systemSettings.autoResetHour, systemSettings.autoResetMinute, 0, 0);
  if(now >= next) next.setDate(next.getDate()+1);

  const diff = next - now;
  const h = Math.floor(diff/3600000);
  const m = Math.floor((diff%3600000)/60000);

  const resetStr = `${pad2(systemSettings.autoResetHour)}:${pad2(systemSettings.autoResetMinute)}`;

  // æ˜ŸæœŸæ˜ å°„
  const WEEK_CN_FULL = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

  let tail = '';
  const today = todayKey();
  if(lastResetDate){
    if(lastResetDate === today){
      tail = ' Â· ä»Šå¤©å·²é‡ç½®';
    }else{
      // æ˜¾ç¤ºæ˜ŸæœŸ
      const dParts = lastResetDate.split('-');
      const d = new Date(Number(dParts[0]), Number(dParts[1])-1, Number(dParts[2]));
      const w = WEEK_CN_FULL[d.getDay()];
      tail = ` Â· ä¸Šæ¬¡é‡ç½®ï¼š${lastResetDate}ï¼ˆå‘¨${w}ï¼‰`;
    }
  }

  info.innerHTML = `
    æ¯æ—¥ ${resetStr} è‡ªåŠ¨é‡ç½®
    <br><small>ä¸‹æ¬¡é‡ç½®å€’è®¡æ—¶ï¼š${h}å°æ—¶${m}åˆ†é’Ÿ${tail}</small>
  `;
}

/* å¤‡ä»½ä¸æ¢å¤ */
function backupSystemData() {
    try {
        // ğŸ”¥ ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½æ˜¯æœ€æ–°çš„
        const success = persistAllData();
        if (!success) {
            throw new Error('æ•°æ®æŒä¹…åŒ–å¤±è´¥ï¼Œæ— æ³•åˆ›å»ºå¯é å¤‡ä»½');
        }
        
        const backupData = {
            version: '13.1', // ğŸ”¥ æ›´æ–°ç‰ˆæœ¬å·
            timestamp: Date.now(),
            deviceId: deviceId || getDeviceId(),
            
            // ğŸ”¥ æ ¸å¿ƒæ•°æ® - ç¡®ä¿æ•°æ®å®Œæ•´æ€§
            rooms: JSON.parse(JSON.stringify(rooms)), // æ·±æ‹·è´é¿å…å¼•ç”¨é—®é¢˜
            roomDatabase: JSON.parse(JSON.stringify(roomDatabase)),
            studentDatabase: JSON.parse(JSON.stringify(studentDatabase)),
            studentTimeSlots: JSON.parse(JSON.stringify(studentTimeSlots)),
            queueList: JSON.parse(JSON.stringify(queueList)),
            
            // ğŸ”¥ æ—¥å¿—æ•°æ® - ç›´æ¥ä»localStorageè¯»å–æœ€æ–°æ•°æ®
            practiceLogs: lsGet(KEYS.PRACTICE_LOG, []),
            operationLogs: lsGet(KEYS.OPS, []),
            
            // ğŸ”¥ ç³»ç»Ÿè®¾ç½®
            systemSettings: JSON.parse(JSON.stringify(systemSettings)),
            
            // ğŸ”¥ è€ƒå‹¤æ•°æ®
            attendanceData: attendanceData ? JSON.parse(JSON.stringify(attendanceData)) : {},
            
            // ğŸ”¥ å¼‚å¸¸æé†’æ•°æ® - ç¡®ä¿Setæ­£ç¡®è½¬æ¢
            practiceOverrunReminders: JSON.parse(JSON.stringify(practiceOverrunReminders)),
            overrunIgnoredKeys: Array.from(overrunIgnoredKeys || []),
            overrunStats: JSON.parse(JSON.stringify(overrunStats)),
            
            // ğŸ”¥ UIçŠ¶æ€
            timelineVisible: timelineVisible,
            
            // ğŸ”¥ å†å²è®°å½•
            studentSlotHistory: lsGet(SLOT_HISTORY_KEY, {}),
            excuseOperationHistory: JSON.parse(JSON.stringify(excuseOperationHistory || [])),
            
            // ğŸ”¥ é‡ç½®ç›¸å…³
            lastResetDate: lastResetDate,
            lastAttendanceCheck: lastAttendanceCheck,
            
            // ğŸ”¥ ç¼“å­˜ç»Ÿè®¡ï¼ˆå¯é€‰ï¼‰
            cacheInfo: {
                totalSize: getTotalCacheSize(),
                itemCount: Object.keys(localStorage).length,
                backupSize: 0 // ç¨åè®¡ç®—
            }
        };
        
        const jsonStr = JSON.stringify(backupData, null, 2);
        
        // ğŸ”¥ æ›´æ–°å¤‡ä»½å¤§å°ä¿¡æ¯
        backupData.cacheInfo.backupSize = jsonStr.length;
        
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `ç´æˆ¿ç³»ç»Ÿå¤‡ä»½_${new Date().toISOString().slice(0,19).replace(/[:-]/g,'')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // ğŸ”¥ è®°å½•è¯¦ç»†çš„æ“ä½œæ—¥å¿—
        logOperation('ç³»ç»Ÿå¤‡ä»½', {
            version: backupData.version,
            dataSize: `${(jsonStr.length/1024).toFixed(2)}KB`,
            roomCount: Object.keys(roomDatabase).length,
            studentCount: Object.values(studentDatabase).reduce((a,b)=>a+b.length,0),
            logCount: backupData.practiceLogs.length,
            timestamp: new Date().toLocaleString()
        });
        
        showToast('âœ… ç³»ç»Ÿæ•°æ®å¤‡ä»½å®Œæˆï¼', 3000);
        
    } catch (error) {
        console.error('âŒ å¤‡ä»½å¤±è´¥:', error);
        showToast('âŒ å¤‡ä»½å¤±è´¥: ' + error.message, 5000);
    }
}

function restoreSystemData() {
    if (isLocked) {
        alert('ç³»ç»Ÿå·²é”å®šï¼Œæ— æ³•æ¢å¤æ•°æ®');
        return;
    }
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // ğŸ”¥ æ˜¾ç¤ºæ¢å¤ç¡®è®¤
        const confirmMsg = `å³å°†ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®ï¼Œè¿™å°†ï¼š
        
âš ï¸  å®Œå…¨æ›¿æ¢å½“å‰æ‰€æœ‰æ•°æ®
âš ï¸  æ¸…é™¤å½“å‰ç´æˆ¿å ç”¨çŠ¶æ€
âš ï¸  æ¸…é™¤å½“å‰æ’é˜Ÿä¿¡æ¯
âš ï¸  å¯èƒ½å½±å“æ­£åœ¨è¿›è¡Œçš„æ“ä½œ

å¤‡ä»½æ–‡ä»¶ï¼š${file.name}
æ–‡ä»¶å¤§å°ï¼š${(file.size/1024).toFixed(2)}KB

ç¡®å®šè¦ç»§ç»­æ¢å¤å—ï¼Ÿ`;
        
        if (!confirm(confirmMsg)) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const backupData = JSON.parse(e.target.result);
                
                // ğŸ”¥ éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
                if (!backupData.version || !backupData.timestamp) {
                    throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼ï¼šç¼ºå°‘ç‰ˆæœ¬ä¿¡æ¯æˆ–æ—¶é—´æˆ³');
                }
                
                if (!backupData.rooms || !backupData.roomDatabase || !backupData.studentDatabase) {
                    throw new Error('å¤‡ä»½æ–‡ä»¶ä¸å®Œæ•´ï¼šç¼ºå°‘æ ¸å¿ƒæ•°æ®');
                }
                
                // ğŸ”¥ ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
                const backupVersion = parseFloat(backupData.version) || 0;
                const currentVersion = 13.1;
                
                if (backupVersion > currentVersion) {
                    const proceed = confirm(`å¤‡ä»½æ–‡ä»¶ç‰ˆæœ¬(${backupData.version})é«˜äºå½“å‰ç³»ç»Ÿç‰ˆæœ¬(${currentVersion})ï¼Œå¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`);
                    if (!proceed) return;
                }
                
                // ğŸ”¥ æ¸…ç†å½“å‰å ç”¨çŠ¶æ€ï¼ˆè®°å½•æ—¥å¿—ï¼‰
                const now = Date.now();
                let clearedRooms = 0;
                rooms.forEach(r => {
                    if (r.student) {
                        addPracticeLog(r.student, r.name, r.registerTime, now, 'ç³»ç»Ÿæ¢å¤æ¸…ç†');
                        clearedRooms++;
                    }
                });
                
                // ğŸ”¥ æ¢å¤æ ¸å¿ƒæ•°æ®
                if (backupData.rooms) rooms = [...backupData.rooms];
                if (backupData.roomDatabase) roomDatabase = {...backupData.roomDatabase};
                if (backupData.studentDatabase) studentDatabase = {...backupData.studentDatabase};
                if (backupData.studentTimeSlots) studentTimeSlots = {...backupData.studentTimeSlots};
                if (backupData.queueList) queueList = {...backupData.queueList};
                if (backupData.systemSettings) {
                    systemSettings = {...DEFAULT_SETTINGS, ...backupData.systemSettings};
                }
                
                // ğŸ”¥ æ¢å¤æ‰©å±•æ•°æ®
                if (backupData.attendanceData) {
                    attendanceData = {...backupData.attendanceData};
                }
                
                if (backupData.practiceOverrunReminders) {
                    practiceOverrunReminders = [...backupData.practiceOverrunReminders];
                }
                
                // ğŸ”¥ ç‰¹æ®Šå¤„ç†ï¼šoverrunIgnoredKeys çš„å…¼å®¹æ€§
                if (backupData.overrunIgnoredKeys && Array.isArray(backupData.overrunIgnoredKeys)) {
                    overrunIgnoredKeys = new Set(backupData.overrunIgnoredKeys);
                } else if (backupData.overrunIgnored && Array.isArray(backupData.overrunIgnored)) {
                    // å…¼å®¹æ—§ç‰ˆæœ¬æ ¼å¼
                    overrunIgnoredKeys = new Set(backupData.overrunIgnored);
                } else {
                    overrunIgnoredKeys = new Set();
                }
                
                if (backupData.overrunStats) {
                    overrunStats = {...backupData.overrunStats};
                }
                
                if (backupData.timelineVisible !== undefined) {
                    timelineVisible = backupData.timelineVisible;
                }
                
                // ğŸ”¥ æ¢å¤è¯·å‡æ“ä½œå†å²
                if (backupData.excuseOperationHistory && Array.isArray(backupData.excuseOperationHistory)) {
                    excuseOperationHistory = [...backupData.excuseOperationHistory];
                } else {
                    excuseOperationHistory = [];
                }
                
                // ğŸ”¥ æ¢å¤å…¶ä»–çŠ¶æ€
                if (backupData.lastResetDate) {
                    lastResetDate = backupData.lastResetDate;
                }
                if (backupData.lastAttendanceCheck) {
                    lastAttendanceCheck = backupData.lastAttendanceCheck;
                }
                
                // ğŸ”¥ æ¢å¤æ—¥å¿—æ•°æ®
                if (backupData.practiceLogs && Array.isArray(backupData.practiceLogs)) {
                    lsSet(KEYS.PRACTICE_LOG, backupData.practiceLogs);
                }
                if (backupData.operationLogs && Array.isArray(backupData.operationLogs)) {
                    lsSet(KEYS.OPS, backupData.operationLogs);
                }
                if (backupData.studentSlotHistory) {
                    lsSet(SLOT_HISTORY_KEY, backupData.studentSlotHistory);
                }
                
                // ğŸ”¥ é‡æ–°åŠ è½½æ—¥å¿—åˆ°å†…å­˜
                practiceLogs = lsGet(KEYS.PRACTICE_LOG, []);
                operationLogs = lsGet(KEYS.OPS, []);
                
                // ğŸ”¥ æŒä¹…åŒ–æ‰€æœ‰æ¢å¤çš„æ•°æ®
                const persistSuccess = persistAllData();
                if (!persistSuccess) {
                    throw new Error('æ•°æ®æŒä¹…åŒ–å¤±è´¥ï¼Œæ¢å¤å¯èƒ½ä¸å®Œæ•´');
                }
                
                // ğŸ”¥ åˆ·æ–°æ‰€æœ‰ç•Œé¢
                needsFullUpdate = true;
                updateRooms();
                updateQueueDisplay();
                updateDemandButtonsStatus();
                updateAttendanceBadge();
                refreshOvertimeBadge();
                updateOverrunPanel();
                
                // ğŸ”¥ åˆ·æ–°æ—¶é—´è½´çŠ¶æ€
                if (timelineVisible) {
                    toggleTimelineIfNeeded();
                }
                
                // ğŸ”¥ åˆ·æ–°ç¼“å­˜ä¿¡æ¯
                updateCacheInfo();
                
                const backupTime = new Date(backupData.timestamp).toLocaleString();
                const backupSize = backupData.cacheInfo ? `${(backupData.cacheInfo.backupSize/1024).toFixed(2)}KB` : 'æœªçŸ¥';
                
                // ğŸ”¥ è®°å½•æ¢å¤æ“ä½œ
                logOperation('ç³»ç»Ÿæ¢å¤', {
                    backupVersion: backupData.version,
                    backupTime: backupTime,
                    backupSize: backupSize,
                    clearedRooms: clearedRooms,
                    restoredRooms: Object.keys(roomDatabase).length,
                    restoredStudents: Object.values(studentDatabase).reduce((a,b)=>a+b.length,0),
                    restoredLogs: practiceLogs.length,
                    timestamp: new Date().toLocaleString()
                });
                
                const successMsg = `âœ… ç³»ç»Ÿæ•°æ®æ¢å¤å®Œæˆï¼
                
ğŸ“Š æ¢å¤ç»Ÿè®¡ï¼š
â€¢ å¤‡ä»½æ—¶é—´: ${backupTime}
â€¢ å¤‡ä»½ç‰ˆæœ¬: ${backupData.version}
â€¢ å¤‡ä»½å¤§å°: ${backupSize}
â€¢ ç´æˆ¿æ•°é‡: ${Object.keys(roomDatabase).length}
â€¢ å­¦ç”Ÿæ•°é‡: ${Object.values(studentDatabase).reduce((a,b)=>a+b.length,0)}
â€¢ ç»ƒç´æ—¥å¿—: ${practiceLogs.length} æ¡
â€¢ æ¸…ç†å ç”¨: ${clearedRooms} é—´

ç³»ç»Ÿå·²å®Œå…¨æ¢å¤åˆ°å¤‡ä»½æ—¶çš„çŠ¶æ€ã€‚`;
                
                alert(successMsg);
                showToast('âœ… ç³»ç»Ÿæ•°æ®æ¢å¤å®Œæˆï¼', 5000);
                
            } catch (error) {
                console.error('âŒ æ¢å¤å¤±è´¥:', error);
                alert(`âŒ æ¢å¤å¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å®Œæ•´æˆ–è”ç³»ç®¡ç†å‘˜ã€‚`);
                showToast('âŒ æ¢å¤å¤±è´¥: ' + error.message, 5000);
            }
        };
        
        reader.onerror = function() {
            alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
        };
        
        reader.readAsText(file);
    };
    
    input.click();
}

/* =============== ç»Ÿä¸€æŒä¹…åŒ–å‡½æ•° =============== */
function persistAllData() {
    try {
        // æ ¸å¿ƒæ•°æ®æŒä¹…åŒ–
        persistRooms();
        persistRoomDb();
        persistStudents();
        persistStudentSlots();
        persistQueues();
        persistSettings();
        
        // æ—¥å¿—æ•°æ®æŒä¹…åŒ–
        persistLogs();
        persistOps();
        
        // ğŸ”¥ æ–°å¢ï¼šå¼‚å¸¸æé†’æ•°æ®æŒä¹…åŒ–
        persistOverruns(false); // ä¸è§¦å‘äº‘ç«¯åŒæ­¥ï¼Œé¿å…å†²çª
        
        // ğŸ”¥ æ–°å¢ï¼šè€ƒå‹¤ç›¸å…³æ•°æ®æŒä¹…åŒ–
        if (attendanceData && Object.keys(attendanceData).length > 0) {
            lsSet('attendanceData', attendanceData);
        }
        
        // ğŸ”¥ æ–°å¢ï¼šå…¶ä»–çŠ¶æ€æ•°æ®
        lsSet(KEYS.TIMELINE_VISIBLE, timelineVisible.toString());
        
        // ğŸ”¥ æ–°å¢ï¼šè¯·å‡æ“ä½œå†å²
        if (excuseOperationHistory && excuseOperationHistory.length > 0) {
            lsSet('excuseOperationHistory', excuseOperationHistory);
        }
        
        // ğŸ”¥ æ–°å¢ï¼šé‡ç½®æ—¥æœŸ
        if (lastResetDate) {
            persistReset();
        }
        
        // ğŸ”¥ åˆ é™¤ï¼šå®æ—¶ç»ƒç´çŠ¶æ€æŒä¹…åŒ–ï¼ˆå·²åˆå¹¶åˆ°æˆ¿é—´çŠ¶æ€ï¼‰
        // lsSet('realTimePracticeStatus', realTimePracticeStatus);
        
        console.log('âœ… æ‰€æœ‰æ•°æ®æŒä¹…åŒ–å®Œæˆ');
        return true;
    } catch (error) {
        console.error('âŒ æ•°æ®æŒä¹…åŒ–å¤±è´¥:', error);
        return false;
    }
}

function getTotalCacheSize() {
    let total = 0;
    try {
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                const value = localStorage.getItem(key) || '';
                total += new Blob([value]).size;
            }
        }
    } catch (error) {
        console.warn('è®¡ç®—ç¼“å­˜å¤§å°å¤±è´¥:', error);
    }
    return total;
}
function addOperationLog(type, detail) {
    const log = {
        time: new Date().toISOString(),
        type: type,
        detail: detail
    };
    
    operationLogs.push(log);
    
    // é™åˆ¶æ—¥å¿—æ•°é‡ï¼Œé¿å…è¿‡åº¦å¢é•¿
    if (operationLogs.length > 1000) {
        operationLogs = operationLogs.slice(-500); // ä¿ç•™æœ€æ–°500æ¡
    }
    
    persistOps();
}

/* =============== ç»Ÿä¸€æŒä¹…åŒ–å‡½æ•°end =============== */
function toggleTimelineIfNeeded(){
  if(timelineVisible){
    $('timelineSection').style.display='block';
    const btn=$('timelineMainControlBtn');
    btn.classList.add('active');
    btn.querySelector('.timeline-control-text').textContent='éšè—ç´æˆ¿çŠ¶æ€é¢„æµ‹';
    btn.querySelector('.timeline-control-icon').textContent='ğŸ‘ï¸';
    updateTimeline();
  }
}
function exportPracticeLogs(){
  if(!practiceLogs.length){alert('æš‚æ— æ—¥å¿—');return;}
  const choice=prompt("é€‰æ‹©å¯¼å‡ºèŒƒå›´:\n1 ä»…ä»Šå¤©\n2 æœ€è¿‘7å¤©\n3 æœ€è¿‘30å¤©\n4 å…¨éƒ¨\n5 è‡ªå®šä¹‰æ—¥æœŸ(YYYY-MM-DD,YYYY-MM-DD)");
  const today=new Date();
  let start,end;
  const norm=(d)=>{d.setHours(0,0,0,0);return d;};
  switch(choice){
    case '1':start=norm(new Date());end=new Date();break;
    case '2':start=norm(new Date(today-6*86400000));end=new Date();break;
    case '3':start=norm(new Date(today-29*86400000));end=new Date();break;
    case '4':start=new Date(0);end=new Date();break;
    case '5':
      const range=prompt('è¯·è¾“å…¥å¼€å§‹ä¸ç»“æŸæ—¥æœŸï¼Œé€—å·åˆ†éš”(YYYY-MM-DD,YYYY-MM-DD)');
      if(!range) return;
      const [s,e]=range.split(',');
      start=norm(new Date(s));end=new Date(e);end.setHours(23,59,59,999);
      if(isNaN(start)||isNaN(end)){alert('æ—¥æœŸæ— æ•ˆ');return;}
      break;
    default:return;
  }
  const filtered=practiceLogs.filter(l=>{
    const d=new Date(l.startTime);
    return d>=start&&d<=end;
  });
  if(!filtered.length){alert('èŒƒå›´å†…æ— è®°å½•');return;}
  filtered.sort((a,b)=>a.startTime-b.startTime);
  let csv='æ—¥æœŸ,å­¦ç”Ÿ,ç´æˆ¿,å¼€å§‹ç»ƒç´æ—¶é—´,ç»“æŸæ—¶é—´,ç»ƒä¹ æ—¶é•¿(å°æ—¶),ç»“æŸåŸå› \n';
  filtered.forEach(l=>{
    const dur=(l.duration/3600000).toFixed(2);
    csv+=`${escapeCSV(new Date(l.startTime).toLocaleDateString('zh-CN'))},${escapeCSV(l.student)},${escapeCSV(l.room)},${escapeCSV(new Date(l.actualStartTime||l.startTime).toLocaleString())},${escapeCSV(new Date(l.endTime).toLocaleString())},${dur},${escapeCSV(l.endReason||'')}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='ç»ƒç´æ—¥å¿—_'+new Date().toISOString().slice(0,10)+'.csv';a.click();
  showToast('æ—¥å¿—å·²å¯¼å‡º');
}

/**
 * æ¸…ç©ºé™¤ â€œç´æˆ¿åº“ / å­¦ç”Ÿåº“ / å­¦ç”Ÿæ—¶é—´æ®µ / ç³»ç»Ÿè®¾ç½®â€ ä»¥å¤–çš„æ‰€æœ‰ç¼“å­˜æ•°æ®
 * ä¿ç•™ localStorage é”®ï¼š
 *   - roomDatabase
 *   - studentDatabase
 *   - studentTimeSlots
 *   - systemSettings   (ä¿ç•™ä½ å½“å‰é…ç½®/å¯†ç )
 *
 * å…¶å®ƒå…¨éƒ¨åˆ é™¤ï¼ˆç»ƒç´æ—¥å¿—ã€æ’é˜Ÿã€æ“ä½œæ—¥å¿—ã€é‡ç½®è®°å½•ã€å¼‚å¸¸æé†’ã€ç»Ÿè®¡ã€æ—¶é—´è½´å¼€å…³ç­‰ï¼‰
 *
 * è‹¥æƒ³é¡ºä¾¿ä¿ç•™å¤‡ä»½ studentDatabaseBackupï¼Œå¯ä¼  { preserveBackup:true }
 * è‹¥æƒ³ä¿ç•™ AUTO_RESET(lastResetDate)ï¼ŒæŠŠ KEYS.AUTO_RESET åŠ å…¥ whitelistï¼ˆè§æ³¨é‡Šï¼‰ã€‚
 */
function clearLocalStorage(options = { preserveBackup: false, preserveAutoReset: false }) {
  if (isLocked) {
    alert('ç³»ç»Ÿå·²é”å®š'); return;
  }
  const whitelist = new Set([
    KEYS.ROOM_DB,        // ç´æˆ¿åº“
    KEYS.STUD_DB,        // å­¦ç”Ÿåº“
    KEYS.STUD_SLOTS,     // å­¦ç”Ÿæ—¶é—´æ®µ
    KEYS.SETTINGS        // ç³»ç»Ÿè®¾ç½®ï¼ˆä¿ç•™ï¼‰
  ]);

  // å¯é€‰ï¼šä¿ç•™å­¦ç”Ÿæ•°æ®åº“å¤‡ä»½
  if (options.preserveBackup) {
    whitelist.add('studentDatabaseBackup');
  }
  // å¯é€‰ï¼šä¿ç•™è‡ªåŠ¨é‡ç½®æ—¥æœŸï¼ˆä¸Šæ¬¡æ‰§è¡Œæ—¥æœŸï¼‰
  if (options.preserveAutoReset) {
    whitelist.add(KEYS.AUTO_RESET);
  }

  const confirmMsg =
`å°†æ¸…é™¤é™¤ä»¥ä¸‹ 4 é¡¹å¤–çš„å…¨éƒ¨æ•°æ®ï¼š
  â€¢ ç´æˆ¿åº“(roomDatabase)
  â€¢ å­¦ç”Ÿåº“(studentDatabase)
  â€¢ å­¦ç”Ÿç»ƒç´æ—¶é—´æ®µ(studentTimeSlots)
  â€¢ ç³»ç»Ÿè®¾ç½®(systemSettings)

è¢«æ¸…é™¤çš„æ•°æ®åŒ…æ‹¬ï¼š
  - å½“å‰æ‰€æœ‰ç´æˆ¿å ç”¨çŠ¶æ€ 
  - æ’é˜Ÿä¿¡æ¯ 
  - ç»ƒç´æ—¥å¿—
  - æ“ä½œæ—¥å¿— 
  - è‡ªåŠ¨é‡ç½®æ—¥æœŸ
  - å¼‚å¸¸æé†’ / è¶…æ—¶ç»Ÿè®¡
  - æ—¶é—´è½´æ˜¾ç¤ºçŠ¶æ€
  - å…¶å®ƒæ´¾ç”Ÿæ•°æ®

ç¡®å®šç»§ç»­ï¼Ÿ`;

  if (!confirm(confirmMsg)) return;

  // 1. æ”¶é›†ç°æœ‰æ‰€æœ‰é”®
  const allKeys = [];
  for (let i = 0; i < localStorage.length; i++) {
    allKeys.push(localStorage.key(i));
  }

  // ç»Ÿè®¡å¤§å°
  const sizeMap = {};
  allKeys.forEach(k => {
    try {
      const v = localStorage.getItem(k) || '';
      sizeMap[k] = new Blob([v]).size;
    } catch {
      sizeMap[k] = 0;
    }
  });

  // 2. åˆ é™¤éç™½åå•
  const removed = [];
  allKeys.forEach(k => {
    if (!whitelist.has(k)) {
      localStorage.removeItem(k);
      removed.push(k);
    }
  });

  // 3. é‡æ–°åŠ è½½ä¿ç•™çš„æ•°æ®
  roomDatabase = lsGet(KEYS.ROOM_DB, {});
  studentDatabase = lsGet(KEYS.STUD_DB, {});
  studentTimeSlots = lsGet(KEYS.STUD_SLOTS, {});
  systemSettings = { ...DEFAULT_SETTINGS, ...lsGet(KEYS.SETTINGS, {}) }; // åˆå¹¶(é˜²æ­¢ç¼ºå­—æ®µ)

  // 4. é‡ç½®è¿è¡ŒæœŸå†…å­˜ï¼ˆè¢«æ¸…é™¤çš„éƒ¨åˆ†ï¼‰
  rooms = [];
  rebuildRoomsFromDb();

  practiceLogs = [];
  queueList = { grand: [], upright: [], none: [] };
  operationLogs = [];

  attendanceData = {};
  lastAttendanceCheck = null;

  // å¦‚æœæ²¡æœ‰ä¿ç•™ autoResetï¼Œåˆ™ lastResetDate è®¾ä¸º null
  if (!options.preserveAutoReset) {
    lastResetDate = null;
  } else {
    const resetObj = lsGet(KEYS.AUTO_RESET, { lastResetDate: null });
    lastResetDate = resetObj.lastResetDate;
  }

  timelineVisible = false;
  practiceOverrunReminders = [];
  overrunIgnoredKeys = new Set();
  overrunStats = {};

  // 5. æŒä¹…åŒ–â€œç©ºå®¹å™¨â€åˆ°å­˜å‚¨ï¼ˆä¿ç•™çš„åº“ä¸åŠ¨ï¼›ç³»ç»Ÿè®¾ç½®ä¿ç•™ï¼‰
  persistRooms();
  persistQueues();      // ç©º
  persistLogs();        // ç©º
  persistOps();         // ç©º

  if (!options.preserveAutoReset) {
    persistReset();     // å†™å…¥ lastResetDate=null
  }
  persistOverruns();     // ç©º
  persistOverruns(); // ç©º

  // ä¸å†™ persistSettings()ï¼ˆsystemSettings å·²ç»å­˜åœ¨ä¸”æœªæ”¹ï¼‰ï¼Œé™¤éä½ æƒ³åŒæ­¥ç»“æ„ï¼š
  persistSettings();

  // 6. UI åˆ·æ–°
  needsFullUpdate = true;
  updateRooms();
  updateQueueDisplay();
  refreshOvertimeBadge();
  updateAttendanceBadge();
  updateDemandButtonsStatus();
  updateCacheInfo();

  // 7. ç»Ÿè®¡é‡Šæ”¾ç©ºé—´
  const savedBytes = removed.reduce((a, k) => a + (sizeMap[k] || 0), 0);
  const human = (n) => n > 1024 * 1024
    ? (n / 1024 / 1024).toFixed(1) + ' MB'
    : n > 1024
      ? (n / 1024).toFixed(1) + ' KB'
      : n + ' B';

  showToast(`è¿è¡Œæ•°æ®å·²æ¸…ç†ï¼Œç§»é™¤ ${removed.length} é¡¹ï¼Œé‡Šæ”¾ ${human(savedBytes)}ã€‚ç³»ç»Ÿè®¾ç½®å·²ä¿ç•™ã€‚`);

  logOperation('clear_cache_whitelist_keep_settings', {
    removedKeys: removed,
    keptKeys: [...whitelist],
    releasedBytes: savedBytes,
    preservedSettings: true,
    preserveBackup: !!options.preserveBackup,
    preserveAutoReset: !!options.preserveAutoReset
  });

  console.log('[æ¸…ç©ºç¼“å­˜å®Œæˆ - ä¿ç•™ç³»ç»Ÿè®¾ç½®] ä¿ç•™é”®:', [...whitelist], 'å·²åˆ é™¤:', removed);
}


/* æ“ä½œæ—¥å¿—æŸ¥çœ‹ */
function viewOperationLogs(){
  if(!operationLogs.length){alert('æš‚æ— æ—¥å¿—');return;}
  const lines=operationLogs.slice(-200).map(l=>`[${l.time}] ${l.type} ${JSON.stringify(l.detail)}`);
  const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='operation_logs.txt';a.click();
}
/* =============== æ™ºèƒ½è¾“å…¥å¤„ç†ç³»ç»Ÿï¼ˆæ”¯æŒä¸­æ–‡è¾“å…¥æ³•ï¼‰ =============== */

// è¾“å…¥çŠ¶æ€ç®¡ç†
const inputState = new Map();

/**
 * æ™ºèƒ½è¾“å…¥å¤„ç†å™¨
 * æ”¯æŒä¸­æ–‡è¾“å…¥æ³•ï¼Œå…è®¸åœ¨ä»»ä½•è¾“å…¥é˜¶æ®µç‚¹å‡»é€‰æ‹©
 */
class SmartInputHandler {
  constructor(inputId, searchCallback) {
    this.inputId = inputId;
    this.searchCallback = searchCallback;
    this.isComposing = false;
    this.lastSearchValue = '';
    this.searchTimeout = null;
    this.selectedIndex = -1; // å½“å‰é€‰ä¸­çš„å€™é€‰é¡¹ç´¢å¼•
    
    this.bindEvents();
  }
  
  bindEvents() {
    const input = $(this.inputId);
    if (!input) return;
    
    // ä¸­æ–‡è¾“å…¥æ³•å¼€å§‹
    input.addEventListener('compositionstart', () => {
      this.isComposing = true;
    });
    
    // ä¸­æ–‡è¾“å…¥æ³•ç»“æŸ
    input.addEventListener('compositionend', (e) => {
      this.isComposing = false;
      this.handleSearch(e.target.value, true);
    });
    
    // è¾“å…¥äº‹ä»¶
    input.addEventListener('input', (e) => {
      this.selectedIndex = -1; // é‡ç½®é€‰ä¸­ç´¢å¼•
      this.handleSearch(e.target.value, false);
    });
    
    // é”®ç›˜äº‹ä»¶ï¼ˆæ”¯æŒæ–¹å‘é”®é€‰æ‹©å’Œå›è½¦ç¡®è®¤ï¼‰
    input.addEventListener('keydown', (e) => {
      this.handleKeyNavigation(e);
    });
  }
  
  handleSearch(value, forceSearch = false) {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (this.searchTimeout) {
      clearTimeout(this.searchTimeout);
      this.searchTimeout = null;
    }
    
    // å¦‚æœæ­£åœ¨è¾“å…¥ä¸­æ–‡ä¸”ä¸æ˜¯å¼ºåˆ¶æœç´¢ï¼Œä½¿ç”¨è¾ƒçŸ­å»¶è¿Ÿ
    const delay = this.isComposing && !forceSearch ? 100 : 50;
    
    this.searchTimeout = setTimeout(() => {
      // é¿å…é‡å¤æœç´¢ç›¸åŒå†…å®¹
      if (this.lastSearchValue !== value) {
        this.lastSearchValue = value;
        this.searchCallback(value);
        // æœç´¢å®Œæˆåé‡ç½®é€‰ä¸­ç´¢å¼•
        this.selectedIndex = -1;
      }
    }, delay);
  }
  
  handleKeyNavigation(e) {
    const resultContainer = this.getResultContainer();
    if (!resultContainer) return;
    
    // æ ¹æ®ä¸åŒè¾“å…¥æ¡†ç±»å‹è·å–ä¸åŒçš„é€‰æ‹©å™¨
    let selectableItems;
    if (this.inputId === 'globalSearch') {
      // å…¨å±€æœç´¢ä½¿ç”¨ä¸åŒçš„ç»“æ„ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©è·³è¿‡é”®ç›˜å¯¼èˆª
      return;
    } else {
      // å­¦ç”Ÿé€‰æ‹©ç›¸å…³çš„æœç´¢
      selectableItems = resultContainer.querySelectorAll('.student-item:not(.disabled-student)');
    }
    
    if (selectableItems.length === 0) return;
    
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        this.selectedIndex = Math.min(this.selectedIndex + 1, selectableItems.length - 1);
        this.updateSelection(selectableItems);
        break;
        
      case 'ArrowUp':
        e.preventDefault();
        this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
        this.updateSelection(selectableItems);
        break;
        
      case 'Enter':
        e.preventDefault();
        if (this.selectedIndex >= 0 && this.selectedIndex < selectableItems.length) {
          this.selectCurrentItem(selectableItems[this.selectedIndex]);
        }
        break;
        
      case 'Escape':
        e.preventDefault();
        this.selectedIndex = -1;
        this.updateSelection(selectableItems);
        break;
    }
  }
  
  selectCurrentItem(selectedItem) {
    const studentName = selectedItem.querySelector('.student-name-text')?.textContent;
    if (!studentName) return;
    
    // æ ¹æ®ä¸åŒçš„è¾“å…¥æ¡†æ‰§è¡Œä¸åŒçš„é€‰æ‹©æ“ä½œ
    switch (this.inputId) {
      case 'modalStudentSearch':
        selectStudent(studentName);
        break;
      case 'queueStudentSearch':
        attemptQueueAdd(studentName);
        break;
      case 'studentDbSearch':
        // å­¦ç”Ÿæ•°æ®åº“å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œæš‚æ—¶è·³è¿‡
        break;
      default:
        console.log('æœªå¤„ç†çš„è¾“å…¥æ¡†ç±»å‹:', this.inputId);
    }
  }
  
  updateSelection(selectableItems) {
    // æ¸…é™¤æ‰€æœ‰é«˜äº®
    selectableItems.forEach((item, index) => {
      if (index === this.selectedIndex) {
        item.classList.add('keyboard-selected');
      } else {
        item.classList.remove('keyboard-selected');
      }
    });
    
    // æ»šåŠ¨åˆ°é€‰ä¸­é¡¹
    if (this.selectedIndex >= 0 && this.selectedIndex < selectableItems.length) {
      selectableItems[this.selectedIndex].scrollIntoView({
        block: 'nearest',
        behavior: 'smooth'
      });
    }
    
    // æ˜¾ç¤ºé€‰æ‹©çŠ¶æ€æç¤ºï¼ˆå¯é€‰ï¼‰
    this.updateSelectionHint(selectableItems.length);
  }
  
  updateSelectionHint(totalCount) {
    // å¯é€‰ï¼šæ˜¾ç¤ºé€‰æ‹©çŠ¶æ€æç¤º
    if (this.selectedIndex >= 0 && totalCount > 0) {
      const hint = `${this.selectedIndex + 1}/${totalCount}`;
      // è¿™é‡Œå¯ä»¥åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæç¤ºï¼Œæš‚æ—¶åœ¨æ§åˆ¶å°è¾“å‡º
      // console.log('å½“å‰é€‰æ‹©:', hint);
    }
  }
  
  getResultContainer() {
    // æ ¹æ®ä¸åŒçš„è¾“å…¥æ¡†IDè¿”å›å¯¹åº”çš„ç»“æœå®¹å™¨
    switch (this.inputId) {
      case 'modalStudentSearch':
        return $('modalStudentList');
      case 'queueStudentSearch':
        return $('queueStudentList');
      case 'globalSearch':
        return $('searchResults');
      case 'studentDbSearch':
        return $('studentDbContent');
      default:
        return null;
    }
  }
  
  // è·å–å½“å‰å®é™…è¾“å…¥å€¼ï¼ˆåŒ…æ‹¬åˆæˆä¸­çš„å€¼ï¼‰
  getCurrentValue() {
    const input = $(this.inputId);
    return input ? input.value : '';
  }
  
  // å¼ºåˆ¶æ‰§è¡Œæœç´¢
  forceSearch() {
    const value = this.getCurrentValue();
    this.searchCallback(value);
  }
}

// è¾“å…¥å¤„ç†å™¨å®ä¾‹å­˜å‚¨
const inputHandlers = new Map();

/**
 * åˆå§‹åŒ–æ™ºèƒ½è¾“å…¥å¤„ç†
 */
function initSmartInputHandlers() {
  // é…ç½®å„ä¸ªæœç´¢è¾“å…¥æ¡†
  const configs = [
    { id: 'modalStudentSearch', callback: searchStudentsModal },
    { id: 'queueStudentSearch', callback: searchQueueStudents },
    { id: 'globalSearch', callback: performGlobalSearch },
    { id: 'studentDbSearch', callback: searchStudentDatabase }
  ];
  
  configs.forEach(config => {
    // ç­‰å¾…DOMå…ƒç´ å¯ç”¨åå†åˆå§‹åŒ–
    const initHandler = () => {
      const input = $(config.id);
      if (input && !inputHandlers.has(config.id)) {
        const handler = new SmartInputHandler(config.id, config.callback);
        inputHandlers.set(config.id, handler);
      }
    };
    
    // ç«‹å³å°è¯•åˆå§‹åŒ–
    initHandler();
    
    // å¦‚æœå…ƒç´ è¿˜ä¸å­˜åœ¨ï¼Œå»¶è¿Ÿåˆå§‹åŒ–
    if (!$(config.id)) {
      setTimeout(initHandler, 100);
    }
  });
}

/**
 * è·å–è¾“å…¥å¤„ç†å™¨çš„å½“å‰å€¼
 */
function getInputValue(inputId) {
  const handler = inputHandlers.get(inputId);
  return handler ? handler.getCurrentValue() : '';
}

/**
 * å¼ºåˆ¶æ‰§è¡Œæœç´¢ï¼ˆç”¨äºæ¨¡æ€æ¡†æ‰“å¼€æ—¶ï¼‰
 */
function forceInputSearch(inputId) {
  const handler = inputHandlers.get(inputId);
  if (handler) {
    handler.forceSearch();
  }
}

/* =============== 13. æœç´¢åŠŸèƒ½ =============== */
/**
 * åˆ·æ–°æœç´¢ç»“æœæ˜¾ç¤º
 * å¦‚æœå½“å‰æœ‰æœç´¢å†…å®¹ï¼Œé‡æ–°æ‰§è¡Œæœç´¢ä»¥æ›´æ–°ç»“æœ
 */
// åœ¨å…¨å±€å˜é‡åŒºåŸŸæ·»åŠ 
let searchRefreshTimeout = null;

/**
 * é˜²æŠ–ç‰ˆæœ¬çš„æœç´¢ç»“æœåˆ·æ–°
 */
function refreshSearchResults() {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (searchRefreshTimeout) {
        clearTimeout(searchRefreshTimeout);
    }
    
    // å»¶è¿Ÿåˆ·æ–°ï¼Œé¿å…é¢‘ç¹æ›´æ–°
    searchRefreshTimeout = setTimeout(() => {
        const searchInput = $('globalSearch');
        const searchResults = $('searchResults');
        
        if (searchInput && searchResults && searchResults.style.display === 'block') {
            const currentQuery = searchInput.value.trim();
            if (currentQuery) {
                performGlobalSearch(currentQuery);
                console.log('ğŸ”„ æœç´¢ç»“æœå·²åˆ·æ–°');
            }
        }
        searchRefreshTimeout = null;
    }, 200); // 200ms å»¶è¿Ÿ
}


function performGlobalSearch(q){
  const resBox=$('searchResults');
  const clearBtn=$('clearSearchBtn');
  q=q.trim();
  if(!q){resBox.style.display='none';clearBtn.style.display='none';return;}
  clearBtn.style.display='block';
// æœå­¦ç”Ÿ
  const students=[];
  for(const [m,arr] of Object.entries(studentDatabase)){
    arr.forEach(s=>{
      const studentName = getStudentName(s); // ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®è·å–å­¦ç”Ÿå§“å
      if(matchPinyin(studentName,q)){
        students.push({...getStudentDetailedStatus(studentName),major:m});
      }
    });
  }

  // æœç´æˆ¿
  const roomRes=[];
  rooms.forEach(r=>{
    if(matchPinyin(r.name,q)||matchPinyin(r.location||'',q)||matchPinyin(r.pianoKind||'',q)){
      roomRes.push(getRoomDetailedStatus(r));
    }
  });
  let html='';
  if(students.length){
    html+='<div class="search-category">å­¦ç”Ÿ ('+students.length+')</div>'+
      students.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN')).map(st=>`
        <div class="search-item">
          <div class="search-item-info">
            <div class="search-item-name">${st.name}</div>
            <div class="search-item-status">
              <span class="${st.statusClass}">${st.statusText}</span>
              <span style="color:#999;margin-left:8px;">${st.major}</span>
            </div>
          </div>
          <div class="search-item-actions">
            ${st.actions.includes('clear')?`<button class="search-action-btn search-clear-btn" onclick="clearRoomWithConfirm('${st.roomName}')">æ¸…ç©º</button>`:''}
          </div>
        </div>`).join('');
  }
  if(roomRes.length){
    html+='<div class="search-category">ç´æˆ¿ ('+roomRes.length+')</div>'+
      roomRes.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN')).map(r=>`
        <div class="search-item">
          <div class="search-item-info">
            <div class="search-item-name">${r.name}</div>
            <div class="search-item-status">
              <span class="${r.statusClass}">${r.statusText}</span>
              <span style="color:#999;margin-left:8px;">${r.location} Â· ${r.pianoKind}</span>
            </div>
          </div>
          <div class="search-item-actions">
            ${r.actions.includes('clear')?`<button class="search-action-btn search-clear-btn" onclick="clearRoomWithConfirm('${r.name}')">æ¸…ç©º</button>`:''}
            ${r.actions.includes('assign')?`<button class="search-action-btn search-assign-btn" onclick="assignRoomFromSearch('${r.name}')">åˆ†é…å­¦ç”Ÿ</button>`:''}
          </div>
        </div>`).join('');
  }
  if(!html) html='<div class="search-no-results">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
  resBox.innerHTML=html;
  resBox.style.display='block';
}
function getStudentDetailedStatus(name){
  const now=Date.now();
  const occ=rooms.find(r=>r.student===name);
  if(occ){
    const prepEnd=occ.registerTime+60000;
    if(now<prepEnd) return {name,status:'preparing',statusText:`åœ¨ ${occ.name} å‡†å¤‡ä¸­`,statusClass:'status-preparing',roomName:occ.name,actions:['clear']};
    const used=Math.floor((now-prepEnd)/1000);
    const limit=systemSettings.basePracticeDuration*60;
    if(used<=limit) return {name,status:'practicing',statusText:`åœ¨ ${occ.name} ç»ƒç´ (${formatHMS(used)})`,statusClass:'status-practicing',roomName:occ.name,actions:['clear']};
    return {name,status:'overtime',statusText:`åœ¨ ${occ.name} è¶…æ—¶ (${formatHMS(used)})`,statusClass:'status-overtime',roomName:occ.name,actions:['clear']};
  }
  if(queueList.grand.includes(name)){
    const p=queueList.grand.indexOf(name)+1;
    return {name,status:'queuing',statusText:`ä¸‰è§’æ’é˜Ÿç¬¬${p}ä½`,statusClass:'status-queuing',actions:[]};
  }
  if(queueList.upright.includes(name)){
    const p=queueList.upright.indexOf(name)+1;
    return {name,status:'queuing',statusText:`ç«‹å¼æ’é˜Ÿç¬¬${p}ä½`,statusClass:'status-queuing',actions:[]};
  }
  if(queueList.none.includes(name)){
    const p=queueList.none.indexOf(name)+1;
    return {name,status:'queuing',statusText:`æ™®é€šæ’é˜Ÿç¬¬${p}ä½`,statusClass:'status-queuing',actions:[]};
  }
  return {name,status:'free',statusText:'ä¸åœ¨ç´æˆ¿',statusClass:'status-free',actions:[]};
}

function getRoomDetailedStatus(r){
  const now=Date.now();
  if(!r.student){
    return {
      name:r.name,
      location:r.location||'',
      pianoKind:r.pianoKind||'',
      status:'available',
      statusText:'ç©ºé—²',
      statusClass:'status-available',   // ä¿®æ”¹
      actions:['assign']
    };
  }
  const prepEnd=r.registerTime+60000;
  if(now<prepEnd){
    return {
      name:r.name,
      location:r.location||'',
      pianoKind:r.pianoKind||'',
      status:'preparing',
      statusText:`${r.student} å‡†å¤‡ä¸­`,
      statusClass:'status-preparing',   // ä¿®æ”¹
      actions:['clear']
    };
  }
  const used=Math.floor((now-prepEnd)/1000);
  const limit=systemSettings.basePracticeDuration*60;
  if(used<=limit){
    return {
      name:r.name,
      location:r.location||'',
      pianoKind:r.pianoKind||'',
      status:'practicing',
      statusText:`${r.student} ä½¿ç”¨ä¸­ (${formatHMS(used)})`,
      statusClass:'status-practicing',  // ä¿®æ”¹
      actions:['clear']
    };
  }
  return {
    name:r.name,
    location:r.location||'',
    pianoKind:r.pianoKind||'',
    status:'overtime',
    statusText:`${r.student} è¶…æ—¶ (${formatHMS(used)})`,
    statusClass:'status-overtime',       // ä¿®æ”¹
    actions:['clear']
  };
}

function assignRoomFromSearch(name){
  currentRoom = name;  // ç¡®ä¿è®¾ç½®äº†æˆ¿é—´å
  const room = rooms.find(r => r.name === name);
  
  if (!room) {
    showToast('é”™è¯¯ï¼šç´æˆ¿ä¸å­˜åœ¨');
    return;
  }
  
  console.log('ğŸ” ä»æœç´¢åˆ†é…æˆ¿é—´:', name, 'currentRoomå·²è®¾ç½®ä¸º:', currentRoom);
  
  openStudentSelectModal(room);
  
  // ç›‘å¬æ¨¡æ€æ¡†å…³é—­äº‹ä»¶ï¼Œå…³é—­ååˆ·æ–°æœç´¢
  const modal = $('studentListModal');
  if(modal) {
    modal.removeEventListener('modalClosed', refreshSearchResults);
    modal.addEventListener('modalClosed', refreshSearchResults, { once: true });
  }
}


function clearSearch(){
  $('globalSearch').value='';
  $('searchResults').style.display='none';
  $('clearSearchBtn').style.display='none';
}

/* =============== 14. ç¼“å­˜ç›‘æ§ =============== */
function initCacheMonitor(){
  updateCacheInfo();
  setInterval(updateCacheInfo, 30000);
  
  // æ·»åŠ ç‚¹å‡»ç¼“å­˜ä¿¡æ¯åŒºåŸŸæ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½
  const info = $('cacheInfo');
  if(info) {
    info.addEventListener('click', () => {
      updateCacheInfo();
      showToast('ç¼“å­˜ä¿¡æ¯å·²åˆ·æ–°', 1500);
    });
    info.style.cursor = 'pointer';
    info.title = 'ç‚¹å‡»åˆ·æ–°ç¼“å­˜ä¿¡æ¯';
  }
}

function updateCacheInfo(){
  // ç§»é™¤ isLocked æ£€æŸ¥ï¼Œè®©ç¼“å­˜ç›‘æ§å§‹ç»ˆå·¥ä½œ
  const info=$('cacheInfo');
  if(!info) return;
  
  const data=calcCacheSize();
  info.style.display='block';
  $('cacheSize').textContent=data.human;
  $('cachePercentage').textContent=`${data.percent}% / 5MB`;
  
  const cs=$('cacheSize');
  cs.className='cache-size';
  if(data.percent>80) cs.classList.add('danger');
  else if(data.percent>60) cs.classList.add('warning');
  
  $('cacheDetails').innerHTML=`ç´æˆ¿:${data.roomsHuman}<br>å­¦ç”Ÿ:${data.studentHuman}<br>æ—¥å¿—:${data.logsHuman}<br>å…¶ä»–:${data.otherHuman}`;
}

function calcCacheSize(){
  let total=0,roomsB=0,studB=0,logsB=0,otherB=0;
  
  function sizeOf(k){
    try {
      const v=localStorage.getItem(k)||'';
      return new Blob([v]).size;
    } catch {
      return 0;
    }
  }
  
  // æˆ¿é—´ç›¸å…³
  roomsB += sizeOf(KEYS.ROOMS) + sizeOf(KEYS.ROOM_DB);
  
  // å­¦ç”Ÿç›¸å…³
  studB += sizeOf(KEYS.STUD_DB) + sizeOf(KEYS.STUD_SLOTS);
  
  // æ—¥å¿—ç›¸å…³
  logsB += sizeOf(KEYS.PRACTICE_LOG) + sizeOf(KEYS.OPS);
  
  // å…¶ä»–æ•°æ®
  [KEYS.SETTINGS, KEYS.AUTO_RESET, KEYS.TIMELINE_VISIBLE, KEYS.QUEUE].forEach(k => {
    otherB += sizeOf(k);
  });
  
  // è®¡ç®—æ€»å¤§å°
  total = roomsB + studB + logsB + otherB;
  const MB = 5*1024*1024;
  
  const human = (n) => {
    if(n > 1024*1024) return (n/1024/1024).toFixed(1) + ' MB';
    if(n > 1024) return (n/1024).toFixed(1) + ' KB';
    return n + ' B';
  };
  
  return {
    total,
    percent: Math.min(100, (total/MB*100)).toFixed(1), // é™åˆ¶æœ€å¤§100%
    human: human(total),
    roomsHuman: human(roomsB),
    studentHuman: human(studB),
    logsHuman: human(logsB),
    otherHuman: human(otherB)
  };
}
/* =============== 14.5. è‡ªåŠ¨é”å®šåŠŸèƒ½ =============== */

/**
 * é‡ç½®è‡ªåŠ¨é”å®šè®¡æ—¶å™¨
 */
function resetAutoLockTimer() {
    // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨é”å®š
    if (isLocked || !systemSettings.autoLockEnabled) return;
    
    lastActivityTime = Date.now();
    autoLockWarningShown = false;
    
    // æ¸…é™¤ç°æœ‰è®¡æ—¶å™¨
    if (autoLockTimer) {
        clearTimeout(autoLockTimer);
    }
    if (autoLockWarningTimer) {
        clearTimeout(autoLockWarningTimer);
    }
    
    // å…³é—­è­¦å‘Šå¼¹çª—
    hideAutoLockWarning();
    
    // ğŸ”¥ ä¿®æ”¹ï¼šä½¿ç”¨åŠ¨æ€è¶…æ—¶æ—¶é—´
    const autoLockTimeout = getAutoLockTimeout();
    
    // è®¾ç½®è­¦å‘Šè®¡æ—¶å™¨ï¼ˆæå‰30ç§’è­¦å‘Šï¼‰
    autoLockWarningTimer = setTimeout(() => {
        if (!isLocked && systemSettings.autoLockEnabled) {
            showAutoLockWarning();
        }
    }, autoLockTimeout - AUTO_LOCK_WARNING_TIME);
    
    // è®¾ç½®è‡ªåŠ¨é”å®šè®¡æ—¶å™¨
    autoLockTimer = setTimeout(() => {
        if (!isLocked && systemSettings.autoLockEnabled) {
            performAutoLock();
        }
    }, autoLockTimeout);
}

/**
 * æ˜¾ç¤ºè‡ªåŠ¨é”å®šè­¦å‘Š
 */
/**
 * æ˜¾ç¤ºè‡ªåŠ¨é”å®šè­¦å‘Š
 */
function showAutoLockWarning() {
    if (isLocked || autoLockWarningShown || !systemSettings.autoLockEnabled) return;
    
    autoLockWarningShown = true;
    
    const warningDiv = document.createElement('div');
    warningDiv.id = 'autoLockWarning';
    warningDiv.className = 'auto-lock-warning';
    
    let countdown = Math.ceil(AUTO_LOCK_WARNING_TIME / 1000);
    
    // ğŸ”¥ ä¿®æ”¹ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰çš„é”å®šæ—¶é—´
    const lockTimeMinutes = systemSettings.autoLockTimeMinutes || 10;
    
    warningDiv.innerHTML = `
        <h3>â° ç³»ç»Ÿå³å°†è‡ªåŠ¨é”å®š</h3>
        <p>æ£€æµ‹åˆ°æ‚¨å·²æœ‰ ${lockTimeMinutes} åˆ†é’Ÿæœªæ“ä½œç³»ç»Ÿ</p>
        <div class="auto-lock-countdown" id="autoLockCountdown">${countdown} ç§’</div>
        <p>ç³»ç»Ÿå°†åœ¨å€’è®¡æ—¶ç»“æŸåè‡ªåŠ¨é”å®šä»¥ä¿æŠ¤æ•°æ®å®‰å…¨</p>
        <p style="font-size: 14px; color: rgba(255,255,255,0.8); margin-top: 15px;">
            ğŸ’¡ ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®æˆ–æŒ‰ä»»æ„é”®å¯å–æ¶ˆé”å®š
        </p>
    `;
    
    document.body.appendChild(warningDiv);
    
    // å€’è®¡æ—¶æ›´æ–°
    const countdownInterval = setInterval(() => {
        countdown--;
        const countdownEl = document.getElementById('autoLockCountdown');
        if (countdownEl) {
            countdownEl.textContent = countdown + ' ç§’';
        }
        
        if (countdown <= 0 || isLocked) {
            clearInterval(countdownInterval);
        }
    }, 1000);
    
    // ğŸ”¥ æ–°å¢ï¼šç‚¹å‡»å¼¹çª—ä»»æ„ä½ç½®å–æ¶ˆé”å®š
    warningDiv.addEventListener('click', () => {
        hideAutoLockWarning();
        resetAutoLockTimer();
        const lockTimeMinutes = systemSettings.autoLockTimeMinutes || 10;
        showToast(`ä¼šè¯å·²å»¶ç»­ï¼Œå°†åœ¨${lockTimeMinutes}åˆ†é’Ÿåå†æ¬¡æ£€æŸ¥`, 2000);
    });
    
    // æ’­æ”¾æç¤ºéŸ³ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        // é™é»˜å¤±è´¥ï¼Œä¸å½±å“åŠŸèƒ½
        console.log('æç¤ºéŸ³æ’­æ”¾å¤±è´¥ï¼Œä½†ä¸å½±å“åŠŸèƒ½');
    }
}

/**
 * éšè—è‡ªåŠ¨é”å®šè­¦å‘Š
 */
function hideAutoLockWarning() {
    const warning = document.getElementById('autoLockWarning');
    if (warning) {
        document.body.removeChild(warning);
    }
    autoLockWarningShown = false;
}


function continueSession() {
    hideAutoLockWarning();
    resetAutoLockTimer();
    // ğŸ”¥ ä¿®æ”¹ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰æ—¶é—´
    const lockTimeMinutes = systemSettings.autoLockTimeMinutes || 10;
    showToast(`ä¼šè¯å·²å»¶ç»­ï¼Œå°†åœ¨${lockTimeMinutes}åˆ†é’Ÿåå†æ¬¡æ£€æŸ¥`, 2000);
}

/**
 * ç«‹å³é”å®šç³»ç»Ÿ
 */
function lockNow() {
    hideAutoLockWarning();
    clearAutoLockTimers();
    lockSystem();
}

/**
 * æ‰§è¡Œè‡ªåŠ¨é”å®š
 */
function performAutoLock() {
    if (isLocked || !systemSettings.autoLockEnabled) return;
    
    hideAutoLockWarning();
    clearAutoLockTimers();
    
    // ä¿å­˜å½“å‰æ•°æ®
    persistAllData();
    
    // é”å®šç³»ç»Ÿ
    isLocked = true;
    $('systemContent').style.display = 'none';
    $('cacheInfo').style.display = 'none';
    
    showUnlockModal();
    
    // ğŸ”¥ ä¿®æ”¹ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰é”å®šæ—¶é—´
    const lockTimeMinutes = systemSettings.autoLockTimeMinutes || 10;
    showToast(`ç³»ç»Ÿå·²è‡ªåŠ¨é”å®šï¼ˆ${lockTimeMinutes}åˆ†é’Ÿæ— æ“ä½œï¼‰`, 5000);
    
    // è®°å½•è‡ªåŠ¨é”å®šæ—¥å¿—
    logOperation('auto_lock', {
        reason: 'inactivity_timeout',
        timeoutMinutes: lockTimeMinutes,
        lastActivity: new Date(lastActivityTime).toLocaleString(),
        inactiveMinutes: Math.round((Date.now() - lastActivityTime) / 60000)
    });
}

/**
 * æ¸…é™¤æ‰€æœ‰è‡ªåŠ¨é”å®šè®¡æ—¶å™¨
 */
function clearAutoLockTimers() {
    if (autoLockTimer) {
        clearTimeout(autoLockTimer);
        autoLockTimer = null;
    }
    if (autoLockWarningTimer) {
        clearTimeout(autoLockWarningTimer);
        autoLockWarningTimer = null;
    }
}

/**
 * åˆå§‹åŒ–è‡ªåŠ¨é”å®šåŠŸèƒ½
 */
function initAutoLock() {
    // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨é”å®š
    if (isLocked || !systemSettings.autoLockEnabled) {
        console.log('ğŸ”’ è‡ªåŠ¨é”å®šåŠŸèƒ½å·²ç¦ç”¨');
        return;
    }
    
    // ç›‘å¬ç”¨æˆ·æ´»åŠ¨äº‹ä»¶
    const events = ['click', 'keydown', 'mousemove', 'scroll', 'touchstart'];
    
    events.forEach(event => {
        document.addEventListener(event, resetAutoLockTimer, { passive: true });
    });
    
    // å¯åŠ¨åˆå§‹è®¡æ—¶å™¨
    resetAutoLockTimer();
    
    // ğŸ”¥ ä¿®æ”¹ï¼šæ˜¾ç¤ºè‡ªå®šä¹‰æ—¶é—´
    const lockTimeMinutes = systemSettings.autoLockTimeMinutes || 10;
    console.log(`ğŸ”’ è‡ªåŠ¨é”å®šåŠŸèƒ½å·²å¯ç”¨ï¼ˆ${lockTimeMinutes}åˆ†é’Ÿæ— æ“ä½œåé”å®šï¼‰`);
}

/**
 * åœç”¨è‡ªåŠ¨é”å®šåŠŸèƒ½
 */
function disableAutoLock() {
    clearAutoLockTimers();
    hideAutoLockWarning();
    
    const events = ['click', 'keydown', 'mousemove', 'scroll', 'touchstart'];
    events.forEach(event => {
        document.removeEventListener(event, resetAutoLockTimer);
    });
    
    console.log('ğŸ”“ è‡ªåŠ¨é”å®šåŠŸèƒ½å·²åœç”¨');
}



/* =============== 15. è§£é”ä¸åˆå§‹åŒ– =============== */
function showUnlockModal(){
  const modal=document.createElement('div');
  modal.id='unlockModal';
  modal.style.cssText='position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:10000;';
    modal.innerHTML=`<div style="background:#fff;padding:40px 35px;border-radius:22px;max-width:420px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,.3);text-align:center;">
    <h2 style="margin:0 0 18px;color:var(--primary-color);">ğŸ¹ è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ç´æˆ¿ç®¡ç†ç³»ç»Ÿ</h2>
    <p style="margin:0 0 20px;color:#555;">è¯·è¾“å…¥è§£é”å¯†ç </p>
    <input type="password" id="unlockPassword" style="width:100%;padding:14px 16px;font-size:16px;border:2px solid var(--border-color);border-radius:10px;text-align:left;margin-bottom:18px;" placeholder="è¯·è¾“å…¥å¯†ç ">

    <div style="margin-bottom:15px;">
      <button id="unlockConfirm" style="width:100%;padding:14px;font-size:16px;font-weight:600;">è§£é”ç³»ç»Ÿ</button>
    </div>
    <p style="font-size:12px;color:#999;margin:0;">æŒ‰å›è½¦é”®å¿«é€Ÿç¡®è®¤</p>
  </div>`;
  document.body.appendChild(modal);
  const pwd=$('unlockPassword');
  pwd.focus();
  
  function doUnlock(){
    const v=pwd.value.trim();
    if(v===systemSettings.loginPassword){
      isLocked=false;
      document.body.removeChild(modal);
      $('systemContent').style.display='block';
      $('cacheInfo').style.display='block';
      showToast('è§£é”æˆåŠŸ');
      updateCacheInfo();
      // ğŸ”¥ æ–°å¢ï¼šè§£é”åå¯åŠ¨è‡ªåŠ¨é”å®š
      initAutoLock();
    }else{
      pwd.value='';
      pwd.placeholder='å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥';
      pwd.style.borderColor='var(--danger-color)';
      modal.querySelector('div').style.animation='shake .5s';
      setTimeout(()=>{
        modal.querySelector('div').style.animation='';
        pwd.style.borderColor='var(--border-color)';
        pwd.placeholder='è¯·è¾“å…¥å¯†ç ';
      }, 1500);
    }
  }
  
  $('unlockConfirm').onclick=doUnlock;
  pwd.addEventListener('keydown',e=>{if(e.key==='Enter')doUnlock();});
  
  // é˜²æ­¢ç”¨æˆ·é€šè¿‡ESCé”®æˆ–ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
  modal.addEventListener('click', e => {
    if(e.target === modal) {
      // ç‚¹å‡»èƒŒæ™¯æ—¶ç»™å‡ºæç¤º
      pwd.focus();
      modal.querySelector('div').style.animation='pulse .3s';
      setTimeout(()=>modal.querySelector('div').style.animation='', 300);
    }
  });
}

function lockSystem(){
  isLocked=true;
  $('systemContent').style.display='none';
  $('cacheInfo').style.display='none';
  // ğŸ”¥ æ–°å¢ï¼šé”å®šæ—¶åœç”¨è‡ªåŠ¨é”å®š
  disableAutoLock();
  showUnlockModal();
  showToast('ç³»ç»Ÿå·²é”å®šï¼Œè¯·è¾“å…¥å¯†ç è§£é”', 3000);
}
// ğŸ”¥ æ–°å¢ï¼šæ£€æµ‹å’Œä¿®å¤é‡å¤åˆ†é…
function detectAndFixDuplicateAssignments() {
    const studentRoomMap = new Map();
    const duplicates = [];
    
    // æ£€æµ‹é‡å¤åˆ†é…
    rooms.forEach(room => {
        if (room.student) {
            if (studentRoomMap.has(room.student)) {
                duplicates.push({
                    student: room.student,
                    rooms: [studentRoomMap.get(room.student), room.name],
                    times: [
                        rooms.find(r => r.name === studentRoomMap.get(room.student))?.registerTime,
                        room.registerTime
                    ]
                });
            } else {
                studentRoomMap.set(room.student, room.name);
            }
        }
    });
    
    // ä¿®å¤é‡å¤åˆ†é…
    if (duplicates.length > 0) {
        console.warn('ğŸš¨ æ£€æµ‹åˆ°é‡å¤åˆ†é…:', duplicates);
        
        duplicates.forEach(dup => {
            const [room1, room2] = dup.rooms;
            const [time1, time2] = dup.times;
            
            // ä¿ç•™æ—¶é—´æˆ³è¾ƒæ–°çš„åˆ†é…
            const keepRoom = (time2 || 0) > (time1 || 0) ? room2 : room1;
            const removeRoom = keepRoom === room1 ? room2 : room1;
            const removeTime = keepRoom === room1 ? time1 : time2;
            
            // æ¸…ç©ºè¾ƒæ—§çš„åˆ†é…
            const roomToUpdate = rooms.find(r => r.name === removeRoom);
            if (roomToUpdate) {
                addPracticeLog(
                    dup.student,
                    removeRoom,
                    removeTime,
                    Date.now(),
                    'é‡å¤åˆ†é…æ¸…ç†'
                );
                roomToUpdate.student = null;
                roomToUpdate.registerTime = null;
            }
            
            console.log(`ğŸ”§ ä¿®å¤é‡å¤åˆ†é…: ${dup.student} ä¿ç•™åœ¨ ${keepRoom}ï¼Œæ¸…ç©º ${removeRoom}`);
        });
        
        persistRooms();
        needsFullUpdate = true;
        updateRooms();
        showToast(`ğŸ”§ æ£€æµ‹å¹¶ä¿®å¤äº† ${duplicates.length} ä¸ªé‡å¤åˆ†é…`, 3000);
    }
}
// ğŸ”¥ æ–°å¢ï¼šå®šæœŸæ£€æµ‹é‡å¤åˆ†é…ï¼ˆæ¯30ç§’ï¼‰
function periodicDuplicateCheck() {
    if (isLocked) return;
    detectAndFixDuplicateAssignments();
}
/* =============== 16. è‡ªåŠ¨åˆ·æ–°å¾ªç¯ =============== */
function mainLoop(){
  updateClock();
}
function secondLoop(){
  updateRooms();
  // è‡ªåŠ¨é‡ç½®æ£€æŸ¥
  checkAutoReset();
  // ç®¡ç†å¼‚å¸¸æ£€æŸ¥å®šæ—¶å™¨
  manageAnomalyCheckTimer();
  // æ¯ç§’åˆ·æ–°é¢æ¿æ—¶é•¿å±•ç¤º
  updateOverrunPanel();
  // ğŸ”¥ æ–°å¢ï¼šæ¯åˆ†é’Ÿæ›´æ–°ç»ƒä¹ ä¼šè¯ï¼ˆåªåœ¨æ¯åˆ†é’Ÿçš„ç¬¬0ç§’æ‰§è¡Œï¼‰
  const now = new Date();
  if (now.getSeconds() === 0) {
      updatePracticeSessions();
}


}


/* =============== ç¡çœ çŠ¶æ€æ£€æµ‹ä¸æ•°æ®ä¿æŠ¤ =============== */

function initSleepProtection() {
    // æ£€æµ‹é¡µé¢å¯è§æ€§å˜åŒ–
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // é¡µé¢è¿›å…¥åå°/ç¡çœ å‰ä¿å­˜çŠ¶æ€
            console.log('ğŸ“± è®¾å¤‡è¿›å…¥ç¡çœ ï¼Œä¿å­˜å½“å‰çŠ¶æ€...');
            deviceSleepTime = Date.now();
            localStorage.setItem('deviceSleepTime', deviceSleepTime);
            
            // å¼ºåˆ¶ä¿å­˜æ‰€æœ‰æ•°æ®
            persistAllData();
            
            // å¦‚æœæœ‰å ç”¨çŠ¶æ€ï¼Œç«‹å³æ¨é€åˆ°äº‘ç«¯
            const occupiedRooms = rooms.filter(r => r.student);
            if (occupiedRooms.length > 0) {
                console.log('ğŸ’¾ ç¡çœ å‰æ¨é€å ç”¨çŠ¶æ€åˆ°äº‘ç«¯:', occupiedRooms.map(r => `${r.name}:${r.student}`));
                if (isOnline && syncEnabled) {
                    pushDataToCloud();
                }
            }
            
        } else {
            // é¡µé¢é‡æ–°æ¿€æ´»
            console.log('ğŸ“± è®¾å¤‡å”¤é†’ï¼Œæ£€æŸ¥æ•°æ®å®Œæ•´æ€§...');
            const sleepTime = localStorage.getItem('deviceSleepTime');
            lastWakeupTime = Date.now();
            
            if (sleepTime) {
                const sleepDuration = Date.now() - parseInt(sleepTime);
                console.log(`ç¡çœ æ—¶é•¿: ${Math.round(sleepDuration/1000)}ç§’`);
                
                // å¦‚æœç¡çœ æ—¶é—´è¾ƒé•¿ï¼Œå¯ç”¨ä¿æŠ¤æ¨¡å¼
                if (sleepDuration > 30000) { // 30ç§’ä»¥ä¸Š
                    handleWakeUpSync(sleepDuration);
                }
                
                // æ¸…é™¤ç¡çœ æ—¶é—´è®°å½•
                localStorage.removeItem('deviceSleepTime');
                deviceSleepTime = null;
            }
        }
    });
    
    // æ£€æµ‹çª—å£ç„¦ç‚¹å˜åŒ–ï¼ˆè¡¥å……ä¿æŠ¤ï¼‰
    window.addEventListener('focus', function() {
        console.log('ğŸ” çª—å£è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥æ•°æ®çŠ¶æ€...');
        setTimeout(checkDataIntegrity, 500);
    });
    
    window.addEventListener('blur', function() {
        console.log('ğŸ’¾ çª—å£å¤±å»ç„¦ç‚¹ï¼Œä¿å­˜æ•°æ®...');
        persistAllData();
    });
}

function handleWakeUpSync(sleepDuration) {
    console.log('ğŸ›¡ï¸ å¯åŠ¨å”¤é†’ä¿æŠ¤æ¨¡å¼...');
    
    // æ£€æŸ¥æœ¬åœ°å ç”¨çŠ¶æ€
    const localOccupiedRooms = rooms.filter(r => r.student && r.registerTime);
    
    if (localOccupiedRooms.length > 0) {
        console.log('ğŸ”’ æœ¬åœ°æœ‰å ç”¨æ•°æ®ï¼Œä¼˜å…ˆä¿æŠ¤æœ¬åœ°çŠ¶æ€');
        console.log('å ç”¨æˆ¿é—´:', localOccupiedRooms.map(r => `${r.name}:${r.student}`));
        
        // æš‚æ—¶ç¦ç”¨äº‘ç«¯æ•°æ®æ‹‰å–
        const originalSyncEnabled = syncEnabled;
        syncEnabled = false;
        
        // å»¶è¿Ÿæ¨é€æœ¬åœ°çŠ¶æ€åˆ°äº‘ç«¯
        setTimeout(() => {
            console.log('ğŸ”„ æ¨é€æœ¬åœ°å ç”¨çŠ¶æ€åˆ°äº‘ç«¯...');
            syncEnabled = originalSyncEnabled;
            if (isOnline) {
                pushDataToCloud();
            }
        }, 2000);
        
        showToast(`ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤ï¼šå·²ä¿æŠ¤ ${localOccupiedRooms.length} ä¸ªå ç”¨çŠ¶æ€`, 4000);
        
        // å»¶è¿Ÿæ¢å¤æ­£å¸¸åŒæ­¥
        setTimeout(() => {
            syncEnabled = originalSyncEnabled;
            console.log('ğŸ”„ æ¢å¤æ­£å¸¸åŒæ­¥æ¨¡å¼');
        }, 10000); // 10ç§’åæ¢å¤
        
    } else {
        console.log('ğŸ“¥ æœ¬åœ°æ— å ç”¨æ•°æ®ï¼Œå¯ä»¥å®‰å…¨æ‹‰å–äº‘ç«¯æ•°æ®');
        // å»¶è¿Ÿæ‹‰å–ï¼Œç»™å…¶ä»–è®¾å¤‡æ—¶é—´
        setTimeout(() => {
            if (isOnline) {
                pullDataFromCloud();
            }
        }, 1000);
    }
}

function checkDataIntegrity() {
    const occupiedCount = rooms.filter(r => r.student).length;
    const queueCount = queueList.grand.length + queueList.upright.length + queueList.none.length;
    
    console.log('ğŸ” æ•°æ®å®Œæ•´æ€§æ£€æŸ¥:', {
        å ç”¨æˆ¿é—´: occupiedCount,
        æ’é˜Ÿäººæ•°: queueCount,
        æ•°æ®ä¿æŠ¤æ¨¡å¼: systemSettings.dataProtectionMode
    });
    
    // å¦‚æœæ£€æµ‹åˆ°å¼‚å¸¸ï¼ˆæ¯”å¦‚æ•°æ®çªç„¶æ¸…ç©ºï¼‰ï¼Œå¯ä»¥å°è¯•æ¢å¤
    if (occupiedCount === 0 && queueCount === 0) {
        const lastBackupTime = localStorage.getItem('lastDataBackupTime');
        if (lastBackupTime && Date.now() - parseInt(lastBackupTime) < 300000) { // 5åˆ†é’Ÿå†…
            console.warn('âš ï¸ æ£€æµ‹åˆ°æ•°æ®å¯èƒ½å¼‚å¸¸æ¸…ç©ºï¼Œè€ƒè™‘æ¢å¤æœºåˆ¶');
            // è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨æ¢å¤é€»è¾‘
        }
    }
}


/* =============== 17. åˆå§‹åŒ–å…¥å£ =============== */
// åœ¨ init å‡½æ•°ä¸­æ·»åŠ æ£€æµ‹
function init(){
    loadAll();
    // ğŸ”¥ æ–°å¢ï¼šå¯åŠ¨æ—¶è¿›è¡Œæ•°æ®åº“å¥åº·æ£€æŸ¥
    setTimeout(() => {
        performDatabaseHealthCheck();
    }, 1000);
    initFirebase();
    showUnlockModal();
    updateClock();
    initAttendanceCheck();
    initCacheMonitor();
    updateDemandButtonsStatus();
    if(timelineVisible) toggleTimelineIfNeeded();
    
    // ğŸ”¥ æ–°å¢ï¼šå¯åŠ¨æ—¶æ£€æµ‹é‡å¤åˆ†é…
    setTimeout(detectAndFixDuplicateAssignments, 2000);
    
    setInterval(mainLoop,1000);
    setInterval(secondLoop,1000);
    updateQueueDisplay();
    updateOverrunPanel();
    setTimeout(initSmartInputHandlers, 100);
    // ğŸ”¥ æ–°å¢ï¼šæ¯30ç§’æ£€æµ‹ä¸€æ¬¡é‡å¤åˆ†é…
    setInterval(periodicDuplicateCheck, 30000);
    // ğŸ”¥ æ–°å¢ï¼šå¯åŠ¨è¯·å‡çŠ¶æ€å®šæœŸæ£€æŸ¥ï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
    excuseCheckInterval = setInterval(checkExpiredExcuses, 60000);
    
    // ğŸ”¥ æ–°å¢ï¼šåˆå§‹åŒ–ç¡çœ ä¿æŠ¤
    initSleepProtection();
    
    // ğŸ”¥ æ–°å¢ï¼šå¯åŠ¨åæ•°æ®å®Œæ•´æ€§æ£€æŸ¥
    setTimeout(checkDataIntegrity, 3000);
    
    // ğŸ”¥ æ–°å¢ï¼šæ“ä½œé”å®šæœŸæ¸…ç†ï¼ˆæ¯30ç§’æ¸…ç†ä¸€æ¬¡è¶…æ—¶é”ï¼‰
    setInterval(cleanupExpiredOperationLocks, 30000);
}

/* =============== æ—¶é—´æ®µé¢„è§ˆåŠŸèƒ½ =============== */
function showStudentSlotsPreview(studentName) {
  const slots = studentTimeSlots[studentName];
  if(!slots) {
    alert('è¯¥å­¦ç”Ÿæœªè®¾ç½®æ—¶é—´æ®µ');
    return;
  }
  
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:2000;display:flex;align-items:center;justify-content:center;';
  
  let totalSlots = 0;
  let previewHTML = '';
  
  ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].forEach(day => {
    const daySlots = slots[day] || [];
    if(daySlots.length > 0) {
      totalSlots += daySlots.length;
      previewHTML += `
        <div style="margin-bottom:15px;">
          <h4 style="margin:0 0 8px;color:#2c3e50;">${WEEK_CN[day]} (${daySlots.length}æ®µ)</h4>
          <div style="display:flex;flex-wrap:wrap;gap:8px;">
            ${daySlots.map(slot => 
              `<span style="background:#e3f2fd;color:#1976d2;padding:4px 8px;border-radius:12px;font-size:12px;">
                ${slot.start}-${slot.end} <small>(${slot.duration})</small>
              </span>`
            ).join('')}
          </div>
        </div>
      `;
    }
  });
  
  modal.innerHTML = `
    <div style="background:#fff;padding:25px;border-radius:16px;max-width:600px;width:95%;max-height:80vh;overflow-y:auto;">
      <h3 style="margin:0 0 20px;color:#3498db;text-align:center;">${studentName} çš„ç»ƒç´æ—¶é—´å®‰æ’</h3>
      <div style="text-align:center;margin-bottom:20px;color:#666;">
        å…± ${totalSlots} ä¸ªæ—¶é—´æ®µï¼Œè¦†ç›– ${Object.keys(slots).filter(day => slots[day] && slots[day].length > 0).length} å¤©
      </div>
      ${previewHTML || '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— æ—¶é—´æ®µè®¾ç½®</div>'}
      <div style="text-align:center;margin-top:20px;">
        <button onclick="this.closest('div[style*=\"position:fixed\"]').remove()" style="background:#3498db;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">å…³é—­</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  modal.addEventListener('click', (e) => {
    if(e.target === modal) {
      document.body.removeChild(modal);
    }
  });
}

/* =============== 18. éœ€æ±‚æŒ‰é’®çŠ¶æ€ =============== */
function updateDemandButtonsStatus(){
  ['grand','upright','none'].forEach(type=>{
    const el=$(type==='grand'?'grandStatus':type==='upright'?'uprightStatus':'noneStatus');
    if(!el) return;
    el.className='';
    if(queueList[type].length){
      el.textContent=`ğŸ‘¥ ${queueList[type].length} äººæ’é˜Ÿä¸­`;
      el.className='status-queue';
      return;
    }
    const res=analyzeDemandAvailability(type);
    if(res.available.length){
      el.textContent=`âœ… ${res.available.length} é—´ç©ºé—²`;
      el.className='status-available';
    }else if(res.overtime.length){
      el.textContent=`âš ï¸ ${res.overtime.length} é—´è¶…æ—¶å¯æ›¿æ¢`;
      el.className='status-overtime';
    }else{
      el.textContent='ğŸš« éœ€è¦æ’é˜Ÿ';
      el.className='status-queue';
    }
  });
}

/* =============== 19. å…¼å®¹æ—§å‡½æ•°åæ˜ å°„ (ä¿æŒ HTML on* è°ƒç”¨ä¸æŠ¥é”™) =============== */
window.handleRoomClick=handleRoomClick;
window.clearRoomWithConfirm=clearRoomWithConfirm;
window.manualReset=manualReset;
window.lockSystem=lockSystem;
window.registerStudent=()=>{};
window.registerGrandPianoStudent=()=>{};
window.searchStudentsModal=searchStudentsModal;
window.closeModal=closeModal;
window.showMajorStudents=showMajorStudents;
window.selectStudent=selectStudent;
window.addNewStudent=addNewStudent;
window.manageStudentDatabase=manageStudentDatabase;
window.closeStudentDatabaseModal=closeStudentDatabaseModal;
window.addNewStudentToDatabase=addNewStudentToDatabase;
window.editStudent=editStudent;
window.saveStudentChanges=saveStudentChanges;
window.closeEditStudentModal=closeEditStudentModal;
window.deleteStudent=deleteStudent;
window.manageRoomDatabase=()=>{$('roomDatabaseModal').style.display='block';displayRoomDatabase();};
window.closeRoomDatabaseModal=()=>{$('roomDatabaseModal').style.display='none';};
window.clearLocalStorage=clearLocalStorage;
window.exportPracticeLogs=exportPracticeLogs;
window.backupSystemData=backupSystemData;
window.restoreSystemData=restoreSystemData;
window.viewOperationLogs=viewOperationLogs;
window.openSettingsModal=openSettingsModal;
window.closeSettingsModal=closeSettingsModal;
window.saveSettings=saveSettings;
window.togglePasswordVisibility=togglePasswordVisibility;
window.openOvertimeModal=openOvertimeModal;
window.closeOvertimeModal=closeOvertimeModal;
window.clearQueue=clearQueue;
window.clearAllQueues=clearAllQueues;
window.showQueueStudentModal=showQueueStudentModal;
window.closeQueueStudentModal=closeQueueStudentModal;
window.searchQueueStudents=searchQueueStudents;
window.addNewQueueStudent=addNewQueueStudent;
window.attemptQueueAdd=attemptQueueAdd;
window.moveQueueItem=moveQueueItem;
window.removeFromQueue=removeFromQueue;
window.handleDemandRequest=handleDemandRequest;
window.closeAvailableRoomsModal=closeAvailableRoomsModal;
window.selectDemandRoom=selectDemandRoom;
window.showReplaceableRoomsModal=showReplaceableRoomsModal;
window.closeReplaceableRoomsModal=closeReplaceableRoomsModal;
window.replaceWithQueueStudent=replaceWithQueueStudent;
window.toggleTimeline=toggleTimeline;
window.openAttendanceModal=openAttendanceModal;
window.closeAttendanceModal=closeAttendanceModal;
window.renderAttendanceList=renderAttendanceList;
window.excuseStudent=excuseStudent;
window.cancelExcuse=cancelExcuse;
window.exportAttendanceReport=exportAttendanceReport;
window.performGlobalSearch=performGlobalSearch;
window.clearSearch=clearSearch;
window.assignRoomFromSearch=assignRoomFromSearch;
window.manageStudentTimeSlots=manageStudentTimeSlots;
window.selectWeekday=selectWeekday;
window.addTimeSlot=addTimeSlot;
window.deleteTimeSlot=deleteTimeSlot;
window.clearAllTimeSlots=clearAllTimeSlots;
window.closeTimeSlotModal=closeTimeSlotModal;
window.toggleOverrunPanel = toggleOverrunPanel;
window.ignoreOverrun = ignoreOverrun;
window.recordOverrun = recordOverrun;
window.toggleMajorCollapse = toggleMajorCollapse;
window.switchToOvertimeManagement = switchToOvertimeManagement;
window.updateStartAnomalyPreview=updateStartAnomalyPreview;
window.updateStopAnomalyPreview=updateStopAnomalyPreview;
window.showStudentSlotsPreview = showStudentSlotsPreview;
// ğŸ”¥ æ–°å¢ï¼šæ“ä½œé”ç®¡ç†å‡½æ•°
window.clearAllOperationLocks = clearAllOperationLocks;
window.cleanupExpiredOperationLocks = cleanupExpiredOperationLocks;

// ğŸ”¥ æ–°å¢ï¼šå¹´çº§ç›¸å…³å‡½æ•°æ˜ å°„
window.filterByGrade = filterByGrade;
window.populateGradeFilter = populateGradeFilter;
window.parseGradeInput = parseGradeInput;
window.formatGradeDisplay = formatGradeDisplay;
window.getStudentGrade = getStudentGrade;
window.getStudentInfo = getStudentInfo;
window.getStudentName = getStudentName;
window.upgradeStudentDatabaseStructure = upgradeStudentDatabaseStructure;
window.getStudentRealTimePracticeStatus = getStudentRealTimePracticeStatus;
window.triggerRealTimePracticeStatusUpdate = triggerRealTimePracticeStatusUpdate;
// ğŸ”¥ æ–°å¢ï¼šç»ƒä¹ æ—¶é•¿ç›¸å…³å‡½æ•°æ˜ å°„
window.exportStudentPracticeReport = exportStudentPracticeReport;
window.getStudentPracticeRecord = getStudentPracticeRecord;
window.getStudentPracticeStats = getStudentPracticeStats;
window.formatPracticeTime = formatPracticeTime;
// ğŸ”¥ æ–°å¢ï¼šè‡ªåŠ¨é”å®šç›¸å…³å‡½æ•°æ˜ å°„
window.resetAutoLockTimer = resetAutoLockTimer;
window.initAutoLock = initAutoLock;
window.disableAutoLock = disableAutoLock;

// ğŸ”¥ æ–°å¢ï¼šè‡ªåŠ¨é”å®šè®¾ç½®ç›¸å…³å‡½æ•°æ˜ å°„
window.updateAutoLockPreview = updateAutoLockPreview;
window.getAutoLockTimeout = getAutoLockTimeout;
window.clearAllOverrunReminders = clearAllOverrunReminders;



/* ======== æˆ¿é—´æ•°æ®åº“å¢å¼ºå—ï¼ˆæ–°å¢ / ç¼–è¾‘ / å¯¼å…¥ / å¯¼å‡ºï¼‰ ======== */

/**
 * æ•°æ®ç»“æ„è¯´æ˜
 * roomDatabase: { [name]: { name, location, pianoType, remark } }
 * rooms[]: è¿è¡Œæ€å¯¹è±¡ (åŒ…å«å ç”¨çŠ¶æ€ student, registerTime)
 * æœ¬æ¨¡å—æ‰€æœ‰æ”¹åŠ¨ -> å…ˆæ”¹ roomDatabase -> åŒæ­¥ rooms -> persist
 */

/* ---------- å·¥å…· ---------- */
const ROOM_TYPE_ALIASES = {
  'ä¸‰è§’é’¢ç´': [
    'ä¸‰è§’','ä¸‰è§’ç´','ä¸‰è§’é’¢ç´','ä¸‰è§’é’¢ç´æˆ¿','grand','grandpiano','grand-piano',
    'gp','concert','concertgrand','concertpiano','triangle'  // triangle ä¹Ÿå…¼å®¹
  ],
  'ç«‹å¼é’¢ç´': [
    'ç«‹å¼','ç«‹å¼ç´','ç«‹å¼é’¢ç´','ç«‹å¼é’¢ç´æˆ¿','upright','uprightpiano','upright-piano',
    'upr','up','upright'
  ],
  'æ— é’¢ç´': [
    'æ— é’¢ç´','æ— ','none','no','nopiano','æ™®é€š','æ™®é€šç´æˆ¿','ç©º','other','å…¶å®ƒ','å…¶ä»–','null',
    'room','practice','ç»ƒåŠŸæˆ¿','ç»ƒä¹ æˆ¿'
  ]
};

// å½’ä¸€ï¼šå»æ‰ç©ºç™½ / ç ´æŠ˜å· / ä¸‹åˆ’çº¿ / å…¨è§’ç©ºæ ¼ï¼Œè½¬å°å†™
function roomDbNormalizeType(raw, warnCollector){
  if(!raw) return 'æ— é’¢ç´';
  let s = String(raw)
    .replace(/\u3000/g,' ')       // å…¨è§’ç©ºæ ¼
    .trim()
    .toLowerCase();
  // å»æ‰å†…éƒ¨ç©ºç™½ã€æ¨ªæ ã€ä¸‹åˆ’çº¿
  const key = s.replace(/[\s\-_]/g,'');
  for(const std in ROOM_TYPE_ALIASES){
    if(ROOM_TYPE_ALIASES[std].some(a=>key===a.replace(/[\s\-_]/g,'').toLowerCase())){
      return std;
    }
  }
  // å…œåº•ï¼šå°è¯•åŒ…å«å…³é”®å­—ï¼ˆé¿å…â€œè¿™æ˜¯ä¸€ä¸ªä¸‰è§’ç´æˆ¿Aâ€ä»è¯†åˆ«ï¼‰
  if(/ä¸‰è§’/.test(s)) return 'ä¸‰è§’é’¢ç´';
  if(/ç«‹å¼/.test(s)) return 'ç«‹å¼é’¢ç´';

  // æœªè¯†åˆ«
  if(Array.isArray(warnCollector)){
    warnCollector.push(raw);
  }
  return 'æ— é’¢ç´';
}

function roomDbSyncRoomsFromDatabase(){
  // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¸ä»…è¦æ·»åŠ æ–°æˆ¿é—´ï¼Œè¿˜è¦åˆ é™¤ä¸åœ¨æ•°æ®åº“ä¸­çš„æˆ¿é—´
  
  // è·å–æ•°æ®åº“ä¸­çš„æˆ¿é—´åç§°é›†åˆ
  const dbRoomNames = new Set(Object.keys(roomDatabase));
  
  // ğŸ”¥ æ–°å¢ï¼šåˆ é™¤ä¸åœ¨æ•°æ®åº“ä¸­çš„æˆ¿é—´
  for(let i = rooms.length - 1; i >= 0; i--) {
    const room = rooms[i];
    if(room && room.name && !dbRoomNames.has(room.name)) {
      console.log(`ğŸ—‘ï¸ åˆ é™¤ä¸åœ¨æ•°æ®åº“ä¸­çš„æˆ¿é—´: ${room.name}`);
      
      // å¦‚æœæˆ¿é—´è¢«å ç”¨ï¼Œè®°å½•æ—¥å¿—
      if(room.student) {
        addPracticeLog(room.student, room.name, room.registerTime, Date.now(), 'æˆ¿é—´æ•°æ®åº“åŒæ­¥åˆ é™¤');
      }
      
      rooms.splice(i, 1);
    }
  }
  
  // ç°æœ‰åå­—é›†åˆï¼ˆæ›´æ–°åçš„ï¼‰
  const existingNames = new Set(rooms.map(r=>r.name));
  
  // æ›´æ–°å·²æœ‰æˆ¿é—´çš„å…ƒæ•°æ®
  rooms.forEach(r=>{
    const meta = roomDatabase[r.name];
    if(meta){
      r.location = meta.location || '';
      r.pianoKind = meta.pianoType;
      r.type = (meta.pianoType === 'ä¸‰è§’é’¢ç´') ? 'grand' : 'other';
      r.remark = meta.remark || '';
    }
  });
  
  // æ·»åŠ æ–°å¢æˆ¿é—´
  Object.values(roomDatabase).forEach(meta=>{
    if(!existingNames.has(meta.name)){
      console.log(`â• æ·»åŠ æ–°æˆ¿é—´: ${meta.name}`);
      rooms.push({
        name: meta.name,
        type: meta.pianoType === 'ä¸‰è§’é’¢ç´' ? 'grand':'other',
        pianoKind: meta.pianoType,
        location: meta.location || '',
        remark: meta.remark || '',
        student: null,
        registerTime: null,
      });
    }
  });
  
  // ğŸ”¥ ä¿æŒï¼šå¯¹ rooms æ•°ç»„æŒ‰åç§°è¿›è¡Œè‡ªç„¶æ’åº
  rooms.sort((a, b) => {
    return a.name.localeCompare(b.name, 'zh-Hans-CN', {
      numeric: true,
      sensitivity: 'base'
    });
  });
  
  persistRoomDb();
  persistRooms();
  needsFullUpdate = true;
  updateRooms();
}

function roomDbCollectLocations(){
  const set = new Set();
  Object.values(roomDatabase).forEach(r=>{
    if(r.location && r.location.trim()) set.add(r.location.trim());
  });
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));
}

function roomDbRefreshLocationFilter(){
  const sel = $('roomLocationFilter');
  if(!sel) return;
  const current = sel.value;
  const locs = roomDbCollectLocations();
  sel.innerHTML = '<option value="">æ‰€æœ‰ä½ç½®</option>' +
    locs.map(l=>`<option value="${l}">${l}</option>`).join('');
  if(locs.includes(current)) sel.value = current;
}

function roomDbValidateName(name){
  if(!name) return 'åç§°ä¸èƒ½ä¸ºç©º';
  if(/[,\r\n]/.test(name)) return 'åç§°ä¸èƒ½åŒ…å«é€—å·æˆ–æ¢è¡Œ';
  if(name.length > 40) return 'åç§°è¿‡é•¿';
  return null;
}

/* ---------- æ–°å¢ ---------- */
function roomDbAddRoom(){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}

  // å…³é”®ï¼šå…ˆæ­£ç¡®è¯»å–åç§°ï¼Œé¿å…ä½¿ç”¨åˆ° window.name
  const name  = $('newRoomNameInput').value.trim();
  const loc   = $('newRoomLocationInput').value.trim();
  const type  = $('newRoomTypeSelect').value;
  const remark= $('newRoomRemarkInput').value.trim();

  const err = roomDbValidateName(name);
  if(err){
    alert(err);
    $('newRoomNameInput').focus();
    return;
  }

  if(roomDatabase[name]){
    alert('å·²å­˜åœ¨åŒåç´æˆ¿');
    $('newRoomNameInput').focus();
    return;
  }

  roomDatabase[name] = {
    name,
    location: loc || '',
    pianoType: roomDbNormalizeType(type),
    remark
  };

  persistRoomDb();
  roomDbSyncRoomsFromDatabase();   // åŒæ­¥åˆ°è¿è¡Œæ€ rooms
  roomDbClearQuickAddInputs();
  logOperation('room_add',{
    name,
    location: loc,
    rawType: type,
    typeNormalized: roomDatabase[name].pianoType
  });
  showToast('æ–°å¢ç´æˆ¿æˆåŠŸ');
  roomDbRenderList();
  
  // ğŸ”¥ æ–°å¢ï¼šåˆ·æ–°æˆ¿é—´å¸ƒå±€æ˜¾ç¤ºï¼Œç¡®ä¿æ–°æ¥¼å±‚å‡ºç°åœ¨åˆ‡æ¢æŒ‰é’®ä¸­
  needsFullUpdate = true;
  updateRooms();
}


function roomDbClearQuickAddInputs(){
  $('newRoomNameInput').value='';
  $('newRoomLocationInput').value='';
  $('newRoomTypeSelect').value='ä¸‰è§’é’¢ç´';
  $('newRoomRemarkInput').value='';
}

/* ---------- åˆ—è¡¨æ¸²æŸ“ä¸çŠ¶æ€ ---------- */
let roomDbEditingName = null; // å½“å‰å¤„äºç¼–è¾‘çŠ¶æ€çš„åŸå§‹åç§°

function roomDbRenderList(){
  const list = $('roomDatabaseList');
  if(!list) return;
  roomDbRefreshLocationFilter();

  const search = ($('roomSearchInput')?.value||'').trim().toLowerCase();
  const locF = $('roomLocationFilter')?.value || '';
  const typeF = $('roomTypeFilter')?.value || '';

  const all = Object.values(roomDatabase)
    .sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN'));

  let html =
    '<div class="room-db-item header">'+
    '<div>åç§°</div><div>ä½ç½®</div><div>ç±»å‹</div><div>å¤‡æ³¨</div><div>æ“ä½œ</div></div>';

  let total=0, grand=0, upright=0, none=0;

  all.forEach(meta=>{
    if(locF && meta.location !== locF) return;
    if(typeF && meta.pianoType !== typeF) return;
    const keyword = (meta.name+' '+(meta.location||'')+' '+meta.pianoType+' '+(meta.remark||'')).toLowerCase();
    if(search && !keyword.includes(search)) return;
    total++;
    if(meta.pianoType==='ä¸‰è§’é’¢ç´') grand++;
    else if(meta.pianoType==='ç«‹å¼é’¢ç´') upright++;
    else none++;

    const occupied = rooms.some(r=>r.name===meta.name && r.student);
    const editing = roomDbEditingName === meta.name;
    if(editing){
      html += `
        <div class="room-db-item" data-room="${meta.name}">
          <div>${occupied? meta.name : `<input class="room-inline-input" id="editRoomName" value="${meta.name}" style="width:100%;box-sizing:border-box;">`}</div>
          <div><input class="room-inline-input" id="editRoomLocation" value="${meta.location||''}"></div>
          <div>
            <select class="room-inline-select" id="editRoomType">
              <option value="ä¸‰è§’é’¢ç´" ${meta.pianoType==='ä¸‰è§’é’¢ç´'?'selected':''}>ä¸‰è§’é’¢ç´</option>
              <option value="ç«‹å¼é’¢ç´" ${meta.pianoType==='ç«‹å¼é’¢ç´'?'selected':''}>ç«‹å¼é’¢ç´</option>
              <option value="æ— é’¢ç´" ${meta.pianoType==='æ— é’¢ç´'?'selected':''}>æ— é’¢ç´</option>
            </select>
          </div>
            <div><input class="room-inline-input" id="editRoomRemark" value="${meta.remark||''}"></div>
          <div>
            <button class="room-save-btn" onclick="roomDbSaveEdit('${meta.name}',${occupied})">ä¿å­˜</button>
            <button class="room-cancel-btn" onclick="roomDbCancelEdit()">å–æ¶ˆ</button>
          </div>
        </div>
      `;
    }else{
      html += `
        <div class="room-db-item" data-room="${meta.name}">
          <div>${meta.name}</div>
          <div>${meta.location||''}</div>
          <div><span class="room-tag ${meta.pianoType==='ä¸‰è§’é’¢ç´'?'tag-grand':meta.pianoType==='ç«‹å¼é’¢ç´'?'tag-upright':'tag-none'}">${meta.pianoType}</span></div>
          <div title="${meta.remark||''}">${meta.remark||''}</div>
          <div>
            <button class="room-edit-btn" onclick="roomDbStartEdit('${meta.name}')">ç¼–è¾‘</button>
            <button class="room-del-btn" onclick="roomDbDeleteRoom('${meta.name}')">åˆ é™¤</button>
          </div>
        </div>
      `;
    }
  });

  list.innerHTML = html;
  $('roomDbStats').innerHTML =
    `å…± ${total} é—´ï¼›ä¸‰è§’ ${grand}ï¼Œç«‹å¼ ${upright}ï¼Œæ— é’¢ç´/å…¶ä»– ${none}`;
}

function roomDbStartEdit(name){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  if(roomDbEditingName && roomDbEditingName !== name){
    if(!confirm('å·²æœ‰æ­£åœ¨ç¼–è¾‘çš„è¡Œï¼Œæ”¾å¼ƒå¹¶åˆ‡æ¢ï¼Ÿ')) return;
  }
  roomDbEditingName = name;
  roomDbRenderList();
}

function roomDbCancelEdit(){
  roomDbEditingName = null;
  roomDbRenderList();
}

function roomDbSaveEdit(originalName, occupied){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  const meta = roomDatabase[originalName];
  if(!meta){showToast('è®°å½•ä¸å­˜åœ¨');roomDbCancelEdit();return;}

  const newName = occupied ? originalName : $('editRoomName').value.trim();
  const location = $('editRoomLocation').value.trim();
  const type = $('editRoomType').value;
  const remark = $('editRoomRemark').value.trim();

  if(!occupied){
    const err = roomDbValidateName(newName);
    if(err){alert(err);return;}
    if(newName !== originalName && roomDatabase[newName]){
      alert('å­˜åœ¨åŒåç´æˆ¿');return;
    }
  }

  // å¦‚æœæ”¹åï¼ˆéå ç”¨ï¼‰
  if(!occupied && newName !== originalName){
    // æ›´æ–° roomDatabase é”®
    delete roomDatabase[originalName];
    roomDatabase[newName] = {
      name: newName,
      location,
      pianoType: roomDbNormalizeType(type),
      remark
    };
    // æ›´æ–° rooms[] ä¸­å¯¹åº”é¡¹åç§°
    rooms.forEach(r=>{
      if(r.name === originalName){
        r.name = newName;
      }
    });
  }else{
    // ä¸æ”¹å
    meta.location = location;
    meta.pianoType = roomDbNormalizeType(type);
    meta.remark = remark;
  }

  persistRoomDb();
  roomDbSyncRoomsFromDatabase();
  logOperation('room_edit',{
    original: originalName,
    newName,
    location,
    pianoType: type,
    normalized: roomDbNormalizeType(type),
    remark,
    renamed: (!occupied && newName!==originalName)
  });

  showToast('ä¿å­˜æˆåŠŸ');
  roomDbEditingName = null;
  roomDbRenderList();
}

function roomDbDeleteRoom(name){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  if(!roomDatabase[name]) return;
  
  const roomObj = rooms.find(r=>r.name===name);
  const occupied = roomObj && roomObj.student;

  if(occupied){
    if(!confirm(`ç´æˆ¿ ${name} æ­£åœ¨è¢« ${roomObj.student} ä½¿ç”¨ï¼Œåˆ é™¤å°†æ¸…é™¤å ç”¨å¹¶è®°å½•æ—¥å¿—ã€‚ç»§ç»­ï¼Ÿ`)) return;
    addPracticeLog(roomObj.student, roomObj.name, roomObj.registerTime, Date.now(),'æˆ¿é—´åˆ é™¤');
  }else{
    if(!confirm(`ç¡®å®šåˆ é™¤ç´æˆ¿ ${name} ?`)) return;
  }

  // ğŸ”¥ å¼ºåˆ¶æ¸…ç†ï¼šå¤šé‡æ£€æŸ¥ç¡®ä¿å®Œå…¨ç§»é™¤
  // 1. ä» rooms æ•°ç»„ä¸­ç§»é™¤æ‰€æœ‰åŒ¹é…çš„æˆ¿é—´
  let removedCount = 0;
  for(let i = rooms.length - 1; i >= 0; i--) {
    if(rooms[i] && rooms[i].name === name) {
      rooms.splice(i, 1);
      removedCount++;
    }
  }
  
  // 2. åˆ é™¤æ•°æ®åº“è®°å½•
  delete roomDatabase[name];
  
  // 3. ç«‹å³æŒä¹…åŒ–
  persistRoomDb();
  persistRooms();
  
  // 4. ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶æ¸…ç†DOMä¸­å¯èƒ½æ®‹ç•™çš„å¡ç‰‡
  const roomCard = document.querySelector(`[data-room-name="${name}"]`);
  if(roomCard) {
    roomCard.remove();
    console.log(`ğŸ—‘ï¸ å¼ºåˆ¶æ¸…ç†DOMä¸­çš„æˆ¿é—´å¡ç‰‡: ${name}`);
  }
  
  // 5. ğŸ”¥ æ–°å¢ï¼šéªŒè¯æ¸…ç†ç»“æœ
  const stillExists = rooms.find(r => r.name === name);
  if(stillExists) {
    console.error(`âŒ æˆ¿é—´åˆ é™¤å¤±è´¥ï¼Œä»å­˜åœ¨: ${name}`, stillExists);
    // å†æ¬¡å°è¯•æ¸…ç†
    rooms = rooms.filter(r => !r || r.name !== name);
    persistRooms();
  }
  
  // 6. åŒæ­¥åˆ°äº‘ç«¯
  if (syncEnabled && isOnline && database) {
    const updates = {};
    updates[FIREBASE_PATHS.ROOM_DB] = roomDatabase;
    updates[FIREBASE_PATHS.ROOMS] = rooms.map(r => ({
      ...r,
      student: r.student || null,
      registerTime: r.registerTime || null
    }));
    
    database.ref().update(updates)
      .then(() => {
        console.log('âœ… æˆ¿é—´åˆ é™¤å·²åŒæ­¥åˆ°äº‘ç«¯');
      })
      .catch(error => {
        console.error('âŒ æˆ¿é—´åˆ é™¤åŒæ­¥å¤±è´¥:', error);
      });
  }
  
  // 7. æ¸…ç†ç›¸å…³å¼•ç”¨
  if(currentRoom === name) {
    currentRoom = null;
  }
  
  // 8. å¼ºåˆ¶åˆ·æ–°UI
  needsFullUpdate = true;
  updateRooms();
  roomDbRenderList();
  
  logOperation('room_delete',{
    name, 
    occupied, 
    removedCount,
    finalRoomCount: rooms.length
  });
  
  showToast(`å·²åˆ é™¤ç´æˆ¿ ${name}${removedCount > 1 ? ` (æ¸…ç†äº†${removedCount}ä¸ªé‡å¤é¡¹)` : ''}`);
}



/* ---------- å¯¼å‡º ---------- */
function exportRoomDatabase(){
  if(!Object.keys(roomDatabase).length){
    alert('æ— æˆ¿é—´å¯å¯¼å‡º');return;
  }
  const choice = prompt('é€‰æ‹©å¯¼å‡ºæ ¼å¼:\n1 CSV (é»˜è®¤)\n2 JSON','1') || '1';
  if(choice==='2'){
    roomDbExportJSON();
  }else{
    roomDbExportCSV();
  }
}

function roomDbExportCSV(){
  const lines = [];
  lines.push('åç§°,ä½ç½®,ç±»å‹,å¤‡æ³¨');
  Object.values(roomDatabase)
    .sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN'))
    .forEach(r=>{
      const esc = v=>{
        if(v==null) return '';
        const s=String(v);
        return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;
      };
      lines.push([esc(r.name),esc(r.location||''),esc(r.pianoType),esc(r.remark||'')].join(','));
    });
  const csv = '\uFEFF'+lines.join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='ç´æˆ¿åº“_'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
  showToast('æˆ¿é—´ CSV å·²å¯¼å‡º');
  logOperation('room_export',{format:'csv',count:Object.keys(roomDatabase).length});
}

function roomDbExportJSON(){
  const payload = {
    version: 'room-db-v1',
    exportedAt: new Date().toISOString(),
    rooms: Object.values(roomDatabase)
  };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json;charset=utf-8;'});
  const a = document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='ç´æˆ¿åº“_'+new Date().toISOString().replace(/[:T]/g,'-').split('.')[0]+'.json';
  a.click();
  showToast('æˆ¿é—´ JSON å·²å¯¼å‡º');
  logOperation('room_export',{format:'json',count:Object.keys(roomDatabase).length});
}

/* ---------- å¯¼å…¥ ---------- */
function importRoomDatabase(){
  if(isLocked){alert('ç³»ç»Ÿå·²é”å®š');return;}
  const input=document.createElement('input');
  input.type='file';
  input.accept='.csv,.json';
  input.onchange=e=>{
    const file=e.target.files[0];
    if(!file) return;
    const isCSV = /\.csv$/i.test(file.name);
    const reader=new FileReader();
    reader.onload = ev=>{
      try{
        const text=ev.target.result;
        if(isCSV){
          roomDbHandleCSVImport(text);
        }else{
          roomDbHandleJSONImport(text);
        }
      }catch(err){
        console.error(err);
        alert('å¯¼å…¥å¤±è´¥: '+err.message);
      }
    };
    reader.readAsText(file,'utf-8');
  };
  input.click();
}

function roomDbHandleJSONImport(text){
  let data = JSON.parse(text);
  if(data.version && Array.isArray(data.rooms)){
    data = data.rooms;
  }else if(!Array.isArray(data)){
    throw new Error('JSON ç»“æ„æ—  rooms æ•°ç»„');
  }
  const warnings = [];
  const records = data.map(r=>{
    const normType = roomDbNormalizeType(r.pianoType || r.type || r.roomType, warnings);
    return {
      name: (r.name||'').trim(),
      location: (r.location||'').trim(),
      pianoType: normType,
      remark: (r.remark||'').trim()
    };
  }).filter(r=>r.name);
  roomDbProceedImport(records,'json',warnings);
}


function roomDbHandleCSVImport(csv){
  if(csv.charCodeAt(0)===0xFEFF) csv=csv.slice(1);
  csv = csv.replace(/\r/g,'');
  const lines = csv.split('\n').map(l=>l.trim()).filter(l=>l);
  if(!lines.length) throw new Error('ç©ºæ–‡ä»¶');
  const header = lines[0].split(/[,ï¼Œ]/).map(h=>h.trim().toLowerCase());
  const idx = {
    name: header.findIndex(h=>/^(åç§°|æˆ¿é—´|name)$/.test(h)),
    location: header.findIndex(h=>/^(ä½ç½®|loc|location)$/.test(h)),
    type: header.findIndex(h=>/^(ç±»å‹|type|æˆ¿å‹)$/.test(h)),
    remark: header.findIndex(h=>/^(å¤‡æ³¨|remark|note)$/.test(h))
  };
  if(idx.name===-1) throw new Error('ç¼ºå°‘â€œåç§°â€åˆ—');

  const warnings = [];
  const records=[];
  for(let i=1;i<lines.length;i++){
    const cols = parseCSVLine(lines[i], header.length);
    const name = (cols[idx.name]||'').trim();
    if(!name) continue;
    const location = idx.location>-1 ? (cols[idx.location]||'').trim() : '';
    const rawType  = idx.type>-1 ? (cols[idx.type]||'').trim() : 'æ— é’¢ç´';
    const normType = roomDbNormalizeType(rawType, warnings);
    const remark = idx.remark>-1 ? (cols[idx.remark]||'').trim() : '';
    records.push({
      name,
      location,
      pianoType: normType,
      remark
    });
  }
  roomDbProceedImport(records,'csv',warnings);
}


function parseCSVLine(line, expected){
  const out=[];
  let cur='',inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){cur+='"';i++;}
      else inQ = !inQ;
    }else if(ch === ',' && !inQ){
      out.push(cur);cur='';
    }else{
      cur+=ch;
    }
  }
  out.push(cur);
  while(out.length<expected) out.push('');
  return out;
}

function roomDbProceedImport(records, source, warnings=[]){
  if(!records.length){
    alert('æ— æœ‰æ•ˆæ•°æ®');return;
  }
  const strategy = prompt('é€‰æ‹©å¯¼å…¥ç­–ç•¥:\n1 åˆå¹¶æ›´æ–°(é»˜è®¤)\n2 ä»…æ–°å¢\n3 è¦†ç›–(æ›´æ–°å·²æœ‰+æ–°å¢)\n4 å…¨é‡é‡ç½®','1') || '1';
  if(!/^[1-4]$/.test(strategy)){alert('å–æ¶ˆ');return;}

  const summary = {
    source,
    strategy,
    input: records.length,
    added:0,
    updated:0,
    skipped:0,
    reset:false,
    unknownTypes: warnings.length ? Array.from(new Set(warnings)) : []
  };

  if(strategy==='4'){
    rooms.forEach(r=>{
      if(r.student){
        addPracticeLog(r.student,r.name,r.registerTime,Date.now(),'æˆ¿é—´å…¨é‡é‡ç½®');
      }
    });
    rooms=[];
    roomDatabase={};
    summary.reset=true;
  }

  records.forEach(rec=>{
    const exist = roomDatabase[rec.name];
    if(!exist){
      if(strategy==='2'){ // ä»…æ–°å¢
        roomDatabase[rec.name]=rec;
        summary.added++;
      }else{
        roomDatabase[rec.name]=rec;
        summary.added++;
      }
    }else{
      if(strategy==='2'){
        summary.skipped++;
      }else if(strategy==='1' || strategy==='3'){
        exist.location = rec.location;
        exist.pianoType = rec.pianoType;
        exist.remark = rec.remark;
        summary.updated++;
      }
    }
  });

  persistRoomDb();
  roomDbSyncRoomsFromDatabase();
  roomDbRenderList();
  logOperation('room_import',summary);

  const warnText = summary.unknownTypes.length
    ? `\næœªè¯†åˆ«ç±»å‹(å·²æŒ‰â€œæ— é’¢ç´â€å¤„ç†): ${summary.unknownTypes.join(' / ')}`
    : '';
  alert(
    `å¯¼å…¥å®Œæˆ:
æ¥æº: ${source}
ç­–ç•¥: ${({'1':'åˆå¹¶æ›´æ–°','2':'ä»…æ–°å¢','3':'è¦†ç›–','4':'å…¨é‡é‡ç½®'})[strategy]}
è¾“å…¥è®°å½•: ${summary.input}
æ–°å¢: ${summary.added}
æ›´æ–°: ${summary.updated}
è·³è¿‡: ${summary.skipped}
${summary.reset?'å·²æ‰§è¡Œå…¨é‡é‡ç½®':''}${warnText}`
  );
  showToast('æˆ¿é—´å¯¼å…¥å®Œæˆ');
}


/* ---------- å¯¹å¤–æ˜ å°„ ---------- */
function displayRoomDatabase(){
  roomDbRenderList();
}

window.displayRoomDatabase = displayRoomDatabase;
window.importRoomDatabase = importRoomDatabase;
window.exportRoomDatabase = exportRoomDatabase;
window.roomDbAddRoom = roomDbAddRoom;


/* =============== å¯åŠ¨ =============== */
document.addEventListener('click',e=>{
  // ç‚¹å‡»æ¨¡æ€å¤–å›´å…³é—­
  ['studentListModal','queueStudentModal','queueModal','availableRoomsModal','replaceableRoomsModal','timeSlotModal','settingsModal','attendanceModal','overtimeModal','studentDatabaseModal','roomDatabaseModal','majorSelectionModal']
    .forEach(id=>{
      const m=$(id);
      if(m && e.target===m) m.style.display='none';
    });
  // ğŸ”¥ ä¿®æ”¹ï¼šå¼‚å¸¸æé†’é¢æ¿ç‚¹å‡»å¤–éƒ¨å…³é—­è¡Œä¸º - åªæ”¶èµ·ï¼Œä¸è‡ªåŠ¨é‡æ–°å¼¹å‡º
  const overrunPanel = $('overrunReminderPanel');
  if(overrunPanel && overrunPanel.style.display !== 'none' && !overrunPanel.classList.contains('collapsed')){
    // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨é¢æ¿å¤–éƒ¨
    if(!overrunPanel.contains(e.target)){
      // ç‚¹å‡»åœ¨é¢æ¿å¤–éƒ¨ï¼Œæ”¶èµ·é¢æ¿å¹¶æ ‡è®°ä¸ºç”¨æˆ·ä¸»åŠ¨å…³é—­
      overrunPanel.classList.add('collapsed');
      overrunPanel.dataset.userCollapsed = 'true';
      overrunPanel.dataset.manuallyDismissed = 'true'; // ğŸ”¥ æ–°å¢ï¼šæ ‡è®°ä¸ºæ‰‹åŠ¨å…³é—­
      
      showToast('å¼‚å¸¸æé†’é¢æ¿å·²æ”¶èµ·', 1500);
    }
  }
});

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    ['studentListModal','queueStudentModal','queueModal','availableRoomsModal','replaceableRoomsModal','timeSlotModal','settingsModal','attendanceModal','overtimeModal','studentDatabaseModal','roomDatabaseModal','majorSelectionModal']
      .forEach(id=>{const m=$(id);if(m) m.style.display='none';});
    currentRoom=null;currentQueueType=null;
  }
});
// ğŸ”¥ æ–°å¢ï¼šæ™ºèƒ½åŒæ­¥è§¦å‘å™¨ï¼ˆåªåœ¨çœŸæ­£éœ€è¦æ—¶åŒæ­¥ï¼‰
function triggerSmartSync(changeType, data = {}) {
    // æ ¹æ®å˜åŒ–ç±»å‹å†³å®šæ˜¯å¦éœ€è¦ç«‹å³åŒæ­¥
    const immediateSync = [
        'room_assign',
        'room_clear', 
        'queue_add',
        'queue_remove',
        'student_assign',
        'force_replace'
    ];
    
    const delayedSync = [
        'room_update',
        'queue_update',
        'status_update'
    ];
    
    if (immediateSync.includes(changeType)) {
        // ç«‹å³åŒæ­¥ï¼Œä½†ä»ä½¿ç”¨é˜²æŠ–
        syncToFirebase(changeType, data);
    } else if (delayedSync.includes(changeType)) {
        // å»¶è¿ŸåŒæ­¥ï¼Œç»™æ›´å¤šæ—¶é—´è®©å¤šä¸ªå˜åŒ–åˆå¹¶
        clearTimeout(window.delayedSyncTimeout);
        window.delayedSyncTimeout = setTimeout(() => {
            syncToFirebase(changeType, data);
        }, 2000);
    }
}

// ğŸ”¥ æ–°å¢ï¼šåŒæ­¥çŠ¶æ€ç›‘æ§
function monitorSyncHealth() {
    setInterval(() => {
        if (!isOnline) return;
        
        const now = Date.now();
        const timeSinceLastSync = now - (lastSyncTime || 0);
        
        // å¦‚æœè¶…è¿‡5åˆ†é’Ÿæ²¡æœ‰åŒæ­¥ï¼Œå¯èƒ½æœ‰é—®é¢˜
        if (timeSinceLastSync > 5 * 60 * 1000) {
            console.warn('âš ï¸ é•¿æ—¶é—´æœªåŒæ­¥ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€...');
            
            // å°è¯•ä¸€æ¬¡å¿ƒè·³æ£€æµ‹
            database.ref('.info/connected').once('value')
                .then(snapshot => {
                    if (snapshot.val() === true) {
                        console.log('ğŸ”„ è¿æ¥æ­£å¸¸ï¼Œæ‰§è¡Œå¥åº·æ£€æŸ¥åŒæ­¥...');
                        syncToFirebase('health_check', { 
                            lastSyncTime, 
                            timeSinceLastSync 
                        });
                    }
                })
                .catch(error => {
                    console.error('âŒ å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                });
        }
    }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
}
// ç»Ÿä¸€æ ¼å¼ï¼š'08:00' => '8:00'
function BTM_normalizeTime(t){
  if(!t) return t;
  const [H,M] = t.split(':');
  return parseInt(H,10)+':'+M;
}

// æ—¶é—´æ®µå­—ç¬¦ä¸² -> å½’ä¸€ï¼š'08:00-08:50' => '8:00-8:50'
function BTM_normRange(r){
  if(!r) return r;
  const [s,e]=r.split('-');
  return BTM_normalizeTime(s)+'-'+BTM_normalizeTime(e);
}

// æ¯”è¾ƒä¸¤ä¸ªæ—¶é—´æ®µæ˜¯å¦â€œå®Œå…¨åŒä¸€èŒƒå›´â€ï¼ˆç”¨åˆ†é’Ÿæ•°ï¼‰
function BTM_rangeEqual(a,b){
  if(!a||!b) return false;
  const toMin = r=>{
    const [s,e]=r.split('-');
    const sm = s.split(':').map(Number);
    const em = e.split(':').map(Number);
    return [sm[0]*60+sm[1], em[0]*60+em[1]];
  };
  const [as,ae]=toMin(a);
  const [bs,be]=toMin(b);
  return as===bs && ae===be;
}

/* ================= æ‰¹é‡æ—¶é—´ç®¡ç†ç³»ç»Ÿæ•´åˆï¼ˆBTM Namespaceï¼‰ ================= */
(function(){
  if(window.BTM){return;} // é˜²é‡å¤æ³¨å…¥

  const BTM = {
    /* ================== ç°æœ‰å±æ€§ï¼ˆéƒ¨åˆ†ä¿ç•™ / æ‰©å±•ï¼‰ ================== */
    timeSlots:[
      '8:00-8:50',
      '9:00-9:50',
      '9:40-10:00',
      '10:00-10:50',
      '11:00-11:50',
      '11:50-13:00',
      '13:00-13:50',
      '14:00-14:50',
      '14:50-15:10',
      '15:10-16:00',
      '16:10-17:00',
      '17:10-18:00'
    ],
    wednesdaySlots:[
      '8:00-8:50',
      '9:00-9:50',
      '9:40-10:00',
      '10:00-10:50',
      '11:00-11:50',
      ['11:50-12:50','åˆé—´éŸ³ä¹ä¼š'],
      ['13:30-14:20'],
      ['14:30-15:20'],
      '15:20-15:40',
      ['15:40-16:30'],
      ['16:40-17:30'],
      ['17:40-18:30']
    ],
    breakIdx:[2,8],
    lunchIdx:[5],
    students:[],           // å…¨é‡å­¦ç”Ÿï¼ˆæŒ‰å§“åæ’åºï¼‰
    filteredStudents:[],   // ç­›é€‰åçš„å­é›†
    selectionMap:{},       // { studentName:Set(keys) }
    currentIndex:-1,       // åœ¨ filteredStudents ä¸­çš„ç´¢å¼•
    filters:{              // å½“å‰ç­›é€‰æ¡ä»¶
      search:'',
      major:'',
      grade:''
    },
    majors:[],             // å»é‡åçš„ä¸“ä¸š
    grades:[],             // å»é‡åçš„å¹´çº§ï¼ˆä»…éç©ºï¼‰
    dom:{
      modal: document.getElementById('bulkTimeManagerModal'),
      studentSelect: null,
      tbody: null,
      selectedList: null,
      stuInfo: null,
      searchInput: null,
      majorFilter: null,
      gradeFilter: null,
      resetBtn: null
    },

    /* ================== åˆå§‹åŒ– / æ‰“å¼€å…³é—­ ================== */
    initDom(){
      this.dom.studentSelect = document.getElementById('btmStudentSelect');
      this.dom.tbody = document.getElementById('btmTbody');
      this.dom.selectedList = document.getElementById('btmSelectedList');
      this.dom.stuInfo = document.getElementById('btmStudentInfo');
      this.dom.searchInput = document.getElementById('btmSearchInput');
      this.dom.majorFilter = document.getElementById('btmMajorFilter');
      this.dom.gradeFilter = document.getElementById('btmGradeFilter');
      this.dom.resetBtn = document.getElementById('btmFilterResetBtn');
    },
    open(){
      this.buildStudentsFromDB();
      this.buildSelectionsFromTimeSlots();
      this.initFiltersUI();          // åˆå§‹åŒ–ç­›é€‰ä¸‹æ‹‰
      this.applyFilters();           // ç”Ÿæˆ filteredStudents
      this.renderTable();
      if(this.filteredStudents.length){
        this.currentIndex=0;
        this.dom.studentSelect.value='0';
        this.updateStudentInfo();
        this.refreshSelectedList();
        this.highlightStudentSelections();
      }else{
        this.currentIndex=-1;
        this.renderEmptyStudentSelect();
        this.dom.stuInfo.innerHTML='<span style="color:#999;">æ— åŒ¹é…å­¦ç”Ÿ</span>';
        this.dom.selectedList.innerHTML='<div class="btm-filter-empty">ç­›é€‰ç»“æœä¸ºç©º</div>';
      }
      this.dom.modal.style.display='block';
    },
    close(){
      this.dom.modal.style.display='none';
    },

    /* ================== æ•°æ®æ„å»º ================== */
    buildStudentsFromDB(){
      this.students=[];
      Object.entries(studentDatabase).forEach(([major,arr])=>{
        arr.forEach(s=>{
          const name=typeof s==='string'?s:(s.name||'');
          if(!name) return;
            const grade=(typeof s==='object' && s.grade)? s.grade : '';
          this.students.push({name,major,grade});
        });
      });
      this.students.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN'));
      // ç»Ÿè®¡ä¸“ä¸š & å¹´çº§
      const majorSet=new Set(), gradeSet=new Set();
      this.students.forEach(s=>{
        if(s.major) majorSet.add(s.major);
        if(s.grade) gradeSet.add(s.grade);
      });
      this.majors=Array.from(majorSet).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN'));
      this.grades=Array.from(gradeSet).sort((a,b)=>{
        // å°è¯• G+æ•°å­— æ’åº
        const gm=a.match(/^G(\d{1,2})$/i);
        const gn=b.match(/^G(\d{1,2})$/i);
        if(gm && gn){
          return parseInt(gm[1])-parseInt(gn[1]);
        }
        return a.localeCompare(b,'zh-Hans-CN');
      });
    },
    buildSelectionsFromTimeSlots(){
      this.selectionMap={};
      this.students.forEach(st=>{
        this.selectionMap[st.name]=new Set();
        const weekly=studentTimeSlots[st.name];
        if(!weekly) return;
        ['monday','tuesday','wednesday','thursday','friday'].forEach((dayKey,dayIndex)=>{
          const daySlots=weekly[dayKey]||[];
          daySlots.forEach(slot=>{
            const rawRange = slot.start + '-' + slot.end;
            const key = this.matchSlotToFixedKey(dayIndex, rawRange);
            if(key) this.selectionMap[st.name].add(key);
          });
        });
      });
    },

    /* ================== ç­›é€‰ç›¸å…³ ================== */
    initFiltersUI(){
      // ä¸‹æ‹‰å¡«å……
      const majorSel=this.dom.majorFilter;
      const gradeSel=this.dom.gradeFilter;
      if(majorSel){
        majorSel.innerHTML='<option value="">æ‰€æœ‰ä¸“ä¸š</option>'+this.majors.map(m=>`<option value="${m}">${m}</option>`).join('');
      }
      if(gradeSel){
        gradeSel.innerHTML='<option value="">æ‰€æœ‰å¹´çº§</option><option value="_no_grade">æœªè®¾ç½®å¹´çº§</option>'+
          this.grades.map(g=>`<option value="${g}">${g}</option>`).join('');
      }
      // äº‹ä»¶
      if(this.dom.searchInput){
        this.dom.searchInput.oninput=()=>{
          this.filters.search=this.dom.searchInput.value.trim();
          this.applyFilters();
        };
      }
      if(majorSel){
        majorSel.onchange=()=>{
          this.filters.major=majorSel.value;
          this.applyFilters();
        };
      }
      if(gradeSel){
        gradeSel.onchange=()=>{
          this.filters.grade=gradeSel.value;
          this.applyFilters();
        };
      }
    },
    resetFilters(){
      this.filters={search:'',major:'',grade:''};
      if(this.dom.searchInput) this.dom.searchInput.value='';
      if(this.dom.majorFilter) this.dom.majorFilter.value='';
      if(this.dom.gradeFilter) this.dom.gradeFilter.value='';
      this.applyFilters();
    },
    applyFilters(){
      const {search,major,grade}=this.filters;
      const keyword=search.toLowerCase();
      this.filteredStudents=this.students.filter(st=>{
        if(major && st.major!==major) return false;
        if(grade){
          if(grade==='_no_grade'){
            if(st.grade) return false;
          }else{
            if(st.grade!==grade) return false;
          }
        }
        if(keyword){
          // æ”¯æŒä¸­æ–‡æ¨¡ç³Š + é¦–å­—æ¯ï¼ˆåˆ©ç”¨å·²æœ‰ matchPinyinï¼‰
          if(!matchPinyin(st.name,keyword)) return false;
        }
        return true;
      });
      // é‡æ–°æ¸²æŸ“å­¦ç”Ÿä¸‹æ‹‰
      this.renderStudentSelect();
      // ä¿æŒæˆ–é‡ç½® currentIndex
      if(!this.filteredStudents.length){
        this.currentIndex=-1;
        this.renderEmptyStudentSelect();
        this.dom.stuInfo.innerHTML='<span style="color:#999;">æ— åŒ¹é…å­¦ç”Ÿ</span>';
        this.dom.selectedList.innerHTML='<div class="btm-filter-empty">ç­›é€‰ç»“æœä¸ºç©º</div>';
        this.clearTableSelectionHighlight();
        return;
      }
      if(this.currentIndex<0) this.currentIndex=0;
      if(this.currentIndex>=this.filteredStudents.length) this.currentIndex=this.filteredStudents.length-1;
      this.dom.studentSelect.value=this.currentIndex.toString();
      this.updateStudentInfo();
      this.refreshSelectedList();
      this.highlightStudentSelections();
    },

    /* ================== æ¸²æŸ“ï¼ˆå­¦ç”Ÿ / è¡¨ / é€‰ä¸­ï¼‰ ================== */
    renderEmptyStudentSelect(){
      if(!this.dom.studentSelect) return;
      this.dom.studentSelect.innerHTML='<option value="">(æ— )</option>';
    },
    renderStudentSelect(){
      const sel=this.dom.studentSelect;
      if(!sel) return;
      sel.innerHTML='';
      this.filteredStudents.forEach((st,i)=>{
        const opt=document.createElement('option');
        const g=st.grade?`[${st.grade}] `:'';
        opt.value=i;
        opt.textContent=`${g}${st.name} - ${st.major}`;
        sel.appendChild(opt);
      });
    },
    renderTable(){
      const tbody=this.dom.tbody;
      tbody.innerHTML='';
      for(let i=0;i<this.timeSlots.length;i++){
        const tr=document.createElement('tr');
        const timeTd=document.createElement('td');
        timeTd.className='btm-cell btm-time-col';
        timeTd.textContent=this.timeSlots[i];
        tr.appendChild(timeTd);
        for(let d=0;d<5;d++){
          const td=document.createElement('td');
          if(d===2){
            const w=this.wednesdaySlots[i];
            if(typeof w==='string'){
              if(this.isRestCell(i,d,true)){
                td.className='btm-cell-rest';
                td.textContent=this.isBreak(i)?'ä¼‘æ¯':'åˆé¤';
              }else{
                td.className='btm-cell';
                td.dataset.key=`wed-${i}-0-2`;
                td.textContent=w;
                td.onclick=()=>this.toggleCell(td.dataset.key);
              }
            }else{
              const subWrap=document.createElement('div');
              subWrap.className='btm-wed-subwrap';
              w.forEach((subStr,idx)=>{
                const sub=document.createElement('div');
                let key=`wed-${i}-${idx}-2`;
                sub.dataset.key=key;
                if(this.isSubRest(i,idx)){
                  sub.className='btm-wed-sub rest';
                  sub.textContent=subStr==='11:50-12:50'||subStr==='11:50-13:00'?'åˆé¤':subStr;
                }else{
                  sub.className='btm-wed-sub';
                  sub.textContent=subStr;
                  sub.onclick=()=>this.toggleCell(key,true);
                }
                subWrap.appendChild(sub);
              });
              td.appendChild(subWrap);
            }
          }else{
            if(this.isRestCell(i,d,false)){
              td.className='btm-cell-rest';
              td.textContent=this.isBreak(i)?'ä¼‘æ¯':'åˆé¤';
            }else{
              td.className='btm-cell btm-cell-normal';
              td.dataset.key=`${i}-${d}`;
              td.textContent=this.timeSlots[i];
              td.onclick=()=>this.toggleCell(td.dataset.key);
            }
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    },
    clearTableSelectionHighlight(){
      const all=this.dom.tbody.querySelectorAll('.btm-cell-selected');
      all.forEach(c=>c.classList.remove('btm-cell-selected'));
      const subs=this.dom.tbody.querySelectorAll('.btm-wed-sub.selected');
      subs.forEach(s=>s.classList.remove('selected'));
    },
    highlightStudentSelections(){
      if(this.currentIndex<0){this.clearTableSelectionHighlight();return;}
      const st=this.filteredStudents[this.currentIndex];
      const set=this.selectionMap[st.name] || new Set();
      const cells=this.dom.tbody.querySelectorAll('.btm-cell');
      cells.forEach(c=>{
        const k=c.dataset.key;
        if(!k) return;
        c.classList.toggle('btm-cell-selected',set.has(k));
      });
      const subs=this.dom.tbody.querySelectorAll('.btm-wed-sub:not(.rest)');
      subs.forEach(s=>{
        const k=s.dataset.key;
        if(!k) return;
        s.classList.toggle('selected',set.has(k));
      });
    },
    refreshSelectedList(){
      if(this.currentIndex<0){
        this.dom.selectedList.innerHTML='<div class="btm-filter-empty">æ— å­¦ç”Ÿ</div>';
        return;
      }
      const st=this.filteredStudents[this.currentIndex];
      const set=this.selectionMap[st.name];
      if(!set || !set.size){
        this.dom.selectedList.innerHTML='<div style="color:#999;font-style:italic;">æš‚æ— é€‰æ‹©</div>';
        return;
      }
      const groups={0:[],1:[],2:[],3:[],4:[]};
      set.forEach(k=>{
        if(k.startsWith('wed-')){
          const parts=k.split('-');
          const di=parseInt(parts[3]);
          groups[di].push(k);
        }else{
          const [ti,di]=k.split('-').map(Number);
          groups[di].push(k);
        }
      });
      let html='';
      Object.entries(groups).forEach(([d,arr])=>{
        if(!arr.length) return;
        arr.sort();
        html+=`<div style="margin-bottom:6px;"><b>${['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”'][d]}:</b><br>`;
        arr.forEach(k=>{
          if(k.startsWith('wed-')){
            const p=k.split('-');
            const ti=parseInt(p[1]);
            const si=parseInt(p[2]);
            const slot=this.wednesdaySlots[ti];
            const txt=Array.isArray(slot)?slot[si]:slot;
            html+=`<span class="btm-chip wed">${txt}</span>`;
          }else{
            const [ti]=k.split('-');
            html+=`<span class="btm-chip">${this.timeSlots[ti]}</span>`;
          }
        });
        html+='</div>';
      });
      this.dom.selectedList.innerHTML=html;
    },

    /* ================== äº¤äº’ï¼ˆé€‰æ‹© / å¯¼èˆªï¼‰ ================== */
    selectStudent(){
      const idx=parseInt(this.dom.studentSelect.value);
      if(isNaN(idx)){this.currentIndex=-1;return;}
      this.currentIndex=idx;
      this.updateStudentInfo();
      this.highlightStudentSelections();
      this.refreshSelectedList();
    },
    prevStudent(){
      if(!this.filteredStudents.length) return;
      this.currentIndex = (this.currentIndex<=0?this.filteredStudents.length-1:this.currentIndex-1);
      this.dom.studentSelect.value=this.currentIndex;
      this.updateStudentInfo();
      this.highlightStudentSelections();
      this.refreshSelectedList();
    },
    nextStudent(){
      if(!this.filteredStudents.length) return;
      this.currentIndex = (this.currentIndex>=this.filteredStudents.length-1?0:this.currentIndex+1);
      this.dom.studentSelect.value=this.currentIndex;
      this.updateStudentInfo();
      this.highlightStudentSelections();
      this.refreshSelectedList();
    },
    updateStudentInfo(){
      if(this.currentIndex<0){
        this.dom.stuInfo.innerHTML='';
        return;
      }
      const st=this.filteredStudents[this.currentIndex];
      const g=st.grade||'æœªæŒ‡å®š';
      this.dom.stuInfo.innerHTML=`<b>å­¦ç”Ÿï¼š</b>${st.name}ã€€<b>ä¸“ä¸šï¼š</b>${st.major}ã€€<b>å¹´çº§ï¼š</b>${g}`;
    },

    /* ================== é€‰æ‹©æ ¼å­ / Key å¯¹åº” ================== */
    toggleCell(key){
      if(this.currentIndex<0) return;
      const st=this.filteredStudents[this.currentIndex];
      const set=this.selectionMap[st.name];
      if(set.has(key)) set.delete(key); else set.add(key);
      this.highlightStudentSelections();
      this.refreshSelectedList();
    },
    matchSlotToFixedKey(dayIndex,timeRange){
        // å½’ä¸€åŒ–æ¥è§„é¿å‰å¯¼ 0
        const normInput = BTM_normRange(timeRange); // ä¾‹å¦‚ '08:00-08:50' -> '8:00-8:50'

        if(dayIndex===2){ // å‘¨ä¸‰
            for(let t=0;t<this.wednesdaySlots.length;t++){
                const w=this.wednesdaySlots[t];
                if(Array.isArray(w)){
                    for(let s=0;s<w.length;s++){
                        const wItem=w[s];
                        // åªå¤„ç†å½¢å¦‚ HH:MM-HH:MM çš„å­æ®µ
                        if(/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(wItem)){
                            if(BTM_rangeEqual(BTM_normRange(wItem), normInput)){
                                return `wed-${t}-${s}-2`;
                            }
                        }
                    }
                }else{
                    if(/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(w)){
                        if(BTM_rangeEqual(BTM_normRange(w), normInput)){
                            return `wed-${t}-0-2`;
                        }
                    }
                }
            }
            return null;
        }else{
            // æ™®é€šå·¥ä½œæ—¥
            for(let i=0;i<this.timeSlots.length;i++){
                const fixed = this.timeSlots[i];      // å¦‚ '8:00-8:50'
                if(BTM_rangeEqual(BTM_normRange(fixed), normInput)){
                    return `${i}-${dayIndex}`;
                }
            }
            return null;
        }
    },

    isBreak(i){return this.breakIdx.includes(i);},
    isLunch(i){return this.lunchIdx.includes(i);},
    isRestCell(i,day,isWed){
      if(isWed){
        if(i===2||i===8) return true;
        if(i===5) return true;
      }else{
        if(this.breakIdx.includes(i)) return true;
        if(this.lunchIdx.includes(i)) return true;
      }
      return false;
    },
    isSubRest(i,subIdx){
      if(i===2||i===8) return true;
      if(i===5) return true;
      return false;
    },

    /* ================== æ¸…ç©º / ä¿å­˜ ================== */
    clearAllSelections(){
      if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿå½“å‰çš„æ‰¹é‡é€‰æ‹©ï¼Ÿ(ä»…æœ¬ç•Œé¢ç¼“å­˜)')) return;
      Object.values(this.selectionMap).forEach(set=>set.clear());
      this.highlightStudentSelections();
      this.refreshSelectedList();
      showToast('å·²æ¸…ç©ºå…¨éƒ¨é€‰æ‹©');
    },
    applyAndSave(){
      let changedStudents=0;
      this.students.forEach(st=>{
        const set=this.selectionMap[st.name];
        if(!set) return;
        const before=JSON.stringify(studentTimeSlots[st.name]||{});
        const original=studentTimeSlots[st.name]||{monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]};
        const fixedSet=new Set();
        const newStruct={monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]};
        set.forEach(k=>{
          if(k.startsWith('wed-')){
            const p=k.split('-');
            const ti=parseInt(p[1]);
            const si=parseInt(p[2]);
            const slot=this.wednesdaySlots[ti];
            let timeStr=Array.isArray(slot)?slot[si]:slot;
            if(timeStr){
              const [s,e]=timeStr.split('-');
              // æ ‡å‡†åŒ–æ—¶é—´æ ¼å¼
              const normalizedStart = normalizeTimeFormat(s);
              const normalizedEnd = normalizeTimeFormat(e);
              newStruct.wednesday.push({start:normalizedStart,end:normalizedEnd,duration:calcDurationText(normalizedStart,normalizedEnd)});
              fixedSet.add('wednesday_'+normalizedStart+'-'+normalizedEnd);
            }
          }else{
            const [ti,di]=k.split('-').map(Number);
            const ts=this.timeSlots[ti];
            const [s,e]=ts.split('-');
            // æ ‡å‡†åŒ–æ—¶é—´æ ¼å¼
            const normalizedStart = normalizeTimeFormat(s);
            const normalizedEnd = normalizeTimeFormat(e);
            const dayKey=['monday','tuesday','wednesday','thursday','friday'][di];
            newStruct[dayKey].push({start:normalizedStart,end:normalizedEnd,duration:calcDurationText(normalizedStart,normalizedEnd)});
            fixedSet.add(dayKey+'_'+normalizedStart+'-'+normalizedEnd);
          }
        });
        Object.keys(newStruct).forEach(day=>{
          newStruct[day].sort((a,b)=>a.start.localeCompare(b.start));
          const uniq=[];
          newStruct[day].forEach(sl=>{
            if(!uniq.some(u=>u.start===sl.start && u.end===sl.end)) uniq.push(sl);
          });
          newStruct[day]=uniq;
        });
        const keeper={monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]};
        Object.entries(original).forEach(([day,arr])=>{
          arr.forEach(sl=>{
            // æ ‡å‡†åŒ–æ—¶é—´æ ¼å¼è¿›è¡Œæ¯”è¾ƒ
            const normalizedStart = normalizeTimeFormat(sl.start);
            const normalizedEnd = normalizeTimeFormat(sl.end);
            const key=day+'_'+normalizedStart+'-'+normalizedEnd;
            if(!fixedSet.has(key) && !this.isFixedSlot(day,normalizedStart+'-'+normalizedEnd)){
              // ä¿å­˜æ—¶ä¹Ÿä½¿ç”¨æ ‡å‡†åŒ–æ ¼å¼
              keeper[day].push({
                start: normalizedStart,
                end: normalizedEnd,
                duration: sl.duration || calcDurationText(normalizedStart, normalizedEnd)
              });
            }
          });
        });
        const merged={monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]};
        Object.keys(merged).forEach(day=>{
          merged[day]=[...newStruct[day],...keeper[day]];
          merged[day].sort((a,b)=>a.start.localeCompare(b.start));
        });
        studentTimeSlots[st.name]=merged;
        const after=JSON.stringify(studentTimeSlots[st.name]);
        if(after!==before) changedStudents++;
      });
      persistStudentSlots();
      if($('studentDatabaseModal').style.display==='block'){
        renderStudentDatabaseList();
      }
      if(syncEnabled && isOnline && database){
        try{database.ref(FIREBASE_PATHS.STUDENT_SLOTS).set(studentTimeSlots);}catch(e){}
      }
      showToast(`å·²ä¿å­˜ ${changedStudents} åå­¦ç”Ÿçš„èŠ‚æ¬¡`);
    },
    isFixedSlot(day,timeRange){
      // æ ‡å‡†åŒ–è¾“å…¥çš„æ—¶é—´æ ¼å¼
      const normalizedTimeRange = timeRange.split('-').map(t => normalizeTimeFormat(t)).join('-');
      
      if(day==='wednesday'){
        for(let i=0;i<this.wednesdaySlots.length;i++){
          const w=this.wednesdaySlots[i];
          if(Array.isArray(w)){
            // æ ‡å‡†åŒ–æ•°ç»„ä¸­çš„æ—¶é—´æ ¼å¼è¿›è¡Œæ¯”è¾ƒ
            const normalizedW = w.map(t => t.split('-').map(tt => normalizeTimeFormat(tt)).join('-'));
            if(normalizedW.includes(normalizedTimeRange)) return true;
          }else{
            // æ ‡å‡†åŒ–å•ä¸ªæ—¶é—´æ ¼å¼è¿›è¡Œæ¯”è¾ƒ
            const normalizedW = w.split('-').map(t => normalizeTimeFormat(t)).join('-');
            if(normalizedW === normalizedTimeRange) return true;
          }
        }
        return false;
      }
      // æ ‡å‡†åŒ–timeSlotsä¸­çš„æ—¶é—´æ ¼å¼è¿›è¡Œæ¯”è¾ƒ
      const normalizedTimeSlots = this.timeSlots.map(t => t.split('-').map(tt => normalizeTimeFormat(tt)).join('-'));
      return normalizedTimeSlots.includes(normalizedTimeRange);
    }
  };


  window.BTM=BTM;

  window.openBulkTimeManager=function(){
    BTM.initDom();
    BTM.open();
  };
  window.closeBulkTimeManager=function(){
    BTM.close();
  };

})();

window.addEventListener('load',init);
</script>
</body>
</html>

