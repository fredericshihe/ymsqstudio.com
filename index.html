<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0" />
	<title>ÈùíÂ≤õËÄ∂ËÉ°Ëø™Ê¢ÖÁ∫ΩÂõ†Â≠¶Ê†° Áê¥ÊàøÁÆ°ÁêÜÁ≥ªÁªü ¬∑ ÂÖ®Êñ∞</title>
	<style>
		:root {
			--bg:#0e1116; --bg-alt:#161b22; --surface:#1f252d; --surface-alt:#242b35; --outline:#2f3844; --outline-hover:#3d4957; --divider:#212a33;
			--accent:#4c8dff; --accent-hover:#6aa1ff; --danger:#ff5f56; --warn:#ffb347; --ok:#3fbf6b; --text:#e6ecf3; --text-dim:#9aa7b4; --focus:0 0 0 2px rgba(76,141,255,.45);
			--radius-sm:6px; --radius:12px; --radius-lg:18px; --transition:.18s cubic-bezier(.4,0,.2,1);
			--card-min-h:150px; --grid-gap:16px; --shadow:0 4px 14px -6px rgba(0,0,0,.55);
			font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif; color:var(--text);
		}
		* {box-sizing:border-box;}
		body {margin:0; background:linear-gradient(180deg,#0d1014,#11161d); min-height:100vh; display:flex; flex-direction:column;}
		header {padding:18px 26px 10px; display:flex; flex-wrap:wrap; align-items:flex-start; gap:16px;}
		header h1 {margin:0;font-size:20px;font-weight:600;letter-spacing:.5px;background:linear-gradient(90deg,#91bdff,#c3daff);-webkit-background-clip:text;color:transparent;}
		header .subtitle {margin:0 0 0 4px;font-size:14px;font-weight:400;color:var(--text-dim);letter-spacing:.3px;align-self:flex-end;padding-bottom:2px;}
		.toolbar {display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-left:auto;}
		.sync-status {display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-dim);padding:6px 10px;border-radius:var(--radius-sm);background:var(--surface-alt);}
		.sync-dot {width:8px;height:8px;border-radius:50%;background:var(--text-dim);transition:var(--transition);}
		.sync-dot.connected {background:var(--ok);box-shadow:0 0 0 2px rgba(34,197,94,.3);}
		.sync-dot.error {background:var(--danger);box-shadow:0 0 0 2px rgba(239,68,68,.3);}
		.sync-dot.connecting {background:var(--warn);animation:pulse 1.5s infinite;}
		@keyframes pulse {0%,100%{opacity:1}50%{opacity:.5}}
		button {cursor:pointer; border:1px solid var(--outline); background:var(--surface-alt); color:var(--text-dim); padding:8px 14px; font-size:13px; border-radius:var(--radius-sm); display:inline-flex; gap:6px; align-items:center; line-height:1; transition:var(--transition);}
		button:hover {border-color:var(--outline-hover); color:var(--text);} button.primary {background:var(--accent); border-color:var(--accent); color:#fff;} button.primary:hover{background:var(--accent-hover);} button.danger{background:var(--danger);border-color:var(--danger);color:#fff;} button.danger:hover{filter:brightness(1.08);} button.ghost{background:transparent;}
		input[type=text],input[type=search]{background:var(--surface);border:1px solid var(--outline);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);font-size:13px;min-width:200px;}
		input:focus{outline:none; box-shadow:var(--focus); border-color:var(--accent);} select {background:var(--surface); border:1px solid var(--outline); color:var(--text); padding:7px 10px; border-radius:var(--radius-sm); font-size:13px;} select:focus{outline:none; box-shadow:var(--focus); border-color:var(--accent);} 
		main {flex:1; display:flex; padding:0 26px 36px; gap:26px; align-items:flex-start;}
		.panel {background:var(--surface); border:1px solid var(--outline); border-radius:var(--radius-lg); padding:18px 18px 20px; width:100%; display:flex; flex-direction:column; gap:18px; box-shadow:var(--shadow); position:relative;}
		/* ÊóßÊµÆÂä®ÁºñËæëÊåâÈíÆÊ†∑ÂºèÂ∑≤ÁßªÈô§ÔºõÁºñËæëÊåâÈíÆÁé∞Âú®‰∏éÊ•ºÂ±ÇËøáÊª§ÂêåË°åÊòæÁ§∫ */
		.panel-header {display:flex; align-items:center; gap:14px;}
		.panel-header h2 {margin:0;font-size:16px;font-weight:600;letter-spacing:.5px;color:var(--text);} .panel-header .badge{background:var(--surface-alt);padding:4px 8px;font-size:11px;border-radius:var(--radius-sm);color:var(--text-dim);} 
		.divider{height:1px;background:var(--divider);margin:0;}
		.filters {display:flex;flex-wrap:wrap;gap:8px;}
		.filters button {padding:6px 12px;font-size:12px;border-radius:999px;background:var(--surface-alt);} .filters button[data-active='1']{background:var(--accent);color:#fff;border-color:var(--accent);} .filters button:hover{border-color:var(--outline-hover);} 
		.grid {display:grid; gap:var(--grid-gap); grid-template-columns:repeat(auto-fill,minmax(180px,1fr));}
		@media (min-width:1250px){ .grid{grid-template-columns:repeat(5,1fr);} }
		.room-card {position:relative; background:linear-gradient(150deg,#232b35,#1b2129); border:1px solid var(--outline); border-radius:var(--radius); padding:12px 12px 10px; display:flex; flex-direction:column; gap:6px; min-height:var(--card-min-h); cursor:pointer; transition:var(--transition); overflow:hidden;}
		.room-card:hover {border-color:var(--outline-hover); transform:translateY(-3px);} 
		.room-card[data-status='occupied']{
			background:linear-gradient(135deg,#2a4158 0%,#1d3245 40%,#16252f 100%); 
			border:1px solid #4a90e2; 
			box-shadow:
				0 0 0 1px rgba(74,144,226,0.4),
				0 2px 12px rgba(74,144,226,0.15),
				0 6px 25px rgba(74,144,226,0.08),
				inset 0 1px 0 rgba(255,255,255,0.05);
			position:relative;
		}
		.room-card[data-status='occupied']:hover{
			border-color:#5fa3ff;
			box-shadow:
				0 0 0 1px rgba(95,163,255,0.5),
				0 3px 16px rgba(74,144,226,0.25),
				0 8px 35px rgba(74,144,226,0.12),
				inset 0 1px 0 rgba(255,255,255,0.08);
			transform:translateY(-4px);
		}

		.room-card[data-status='preparing']{background:linear-gradient(160deg,#3d2a19,#2a1e0f); border:2px solid #f39c12; box-shadow:0 0 15px rgba(243,156,18,0.3); animation:preparing-pulse 2s infinite;} 
		.room-card[data-status='overtime']{
			background:linear-gradient(135deg,#4a2728 0%,#3d1f20 40%,#2a1415 100%); 
			border:1px solid #ff4757; 
			box-shadow:
				0 0 0 1px rgba(255,71,87,0.4),
				0 2px 12px rgba(255,71,87,0.15),
				0 6px 25px rgba(255,71,87,0.08),
				inset 0 1px 0 rgba(255,255,255,0.05);
		}
		.room-card[data-status='overtime']:hover{
			border-color:#ff6b7a;
			box-shadow:
				0 0 0 1px rgba(255,107,122,0.5),
				0 3px 16px rgba(255,71,87,0.25),
				0 8px 35px rgba(255,71,87,0.12),
				inset 0 1px 0 rgba(255,255,255,0.08);
			transform:translateY(-4px);
		}
		.room-card[data-status='empty']{background:linear-gradient(160deg,#1e242c,#181d23);} 
		.room-card[data-status='syncing']{background:linear-gradient(160deg,#1f2a3d,#1a2234); border-color:#4a90e2;} 
		.room-card.pending-operation{position:relative; pointer-events:none;} 
		.room-card.pending-operation::before{content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(74,144,226,0.1); border:2px solid #4a90e2; border-radius:var(--radius); z-index:10; animation:pulse-border 1.5s infinite;}
		
		/* ÁºñËæëÊ®°ÂºèÊ†∑Âºè */
		.edit-mode-btn{padding:6px 12px;font-size:12px;background:var(--accent);color:#fff;border-color:var(--accent);}
		.edit-mode-btn.active{background:var(--ok);border-color:var(--ok);}
		.room-card.edit-mode{position:relative;pointer-events:auto;overflow:visible;}
		.room-card.edit-mode .delete-btn{
			position:absolute;top:-8px;right:-8px;width:20px;height:20px;
			border-radius:50%;background:#ff4757;border:2px solid #fff;
			color:#fff;font-size:14px;font-weight:bold;cursor:pointer;
			display:flex;align-items:center;justify-content:center;
			z-index:15;transition:var(--transition);
		}
		.room-card.edit-mode .delete-btn:hover{background:#ff3742;transform:scale(1.1);}
		.room-card.edit-mode .edit-row{
			display:flex;align-items:center;gap:8px;margin-bottom:6px;
		}
		.room-card.edit-mode .room-name.compact{
			flex:1;min-width:0;border:1px dashed var(--outline);
			padding:4px 6px;border-radius:4px;cursor:text;
		}
		.room-card.edit-mode .piano-type-selector{
			flex-shrink:0;min-width:80px;padding:4px 6px;
			background:var(--surface);border:1px solid var(--outline);
			border-radius:4px;font-size:12px;color:var(--text);
			cursor:pointer;outline:none;transition:var(--transition);
		}
		.room-card.edit-mode .piano-type-selector:hover,
		.room-card.edit-mode .piano-type-selector:focus{
			border-color:var(--accent);background:rgba(76,141,255,0.05);
		}
		.room-card.edit-mode .room-name{border:1px dashed var(--outline);padding:4px 6px;border-radius:4px;cursor:text;}
		.room-card.edit-mode .remark{border:1px dashed var(--outline);padding:4px 6px;border-radius:4px;cursor:text;min-height:24px;}
		.room-card.edit-mode .room-name:hover,.room-card.edit-mode .remark:hover{border-color:var(--accent);background:rgba(76,141,255,0.05);}
		.room-card.edit-mode .room-name.compact:hover{border-color:var(--accent);background:rgba(76,141,255,0.05);}
		.add-room-btn{
			background: linear-gradient(135deg, var(--ok) 0%, #2ecc71 100%);
			color: #fff;
			border: 1px solid var(--ok);
			margin-left: 8px;
			font-size: 12px;
			padding: 6px 12px;
			border-radius: 6px;
			font-weight: 600;
			display: inline-flex;
			align-items: center;
			gap: 4px;
			box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
			transition: all 0.2s ease;
		}
		.add-room-btn:hover{
			background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
			border-color: #2ecc71;
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
		}
		.add-room-btn:active {
			transform: translateY(0);
			box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
		}
		
		/* === Êñ∞Â¢ûÁê¥ÊàøÊ®°ÊÄÅÊ°Ü‰∏ìÁî®Ê†∑Âºè === */
		.add-room-modal .modal-header {
			background: linear-gradient(135deg, var(--surface-alt) 0%, #2c3e50 100%);
			border-bottom: 1px solid var(--outline);
		}
		.add-room-modal .modal-header h3 {
			color: var(--text);
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.add-room-modal .modal-header h3::before {
			content: "üéπ";
			font-size: 18px;
		}
		.add-room-modal .form-grid {
			display: grid;
			gap: 18px;
		}
		.add-room-modal .form-field {
			display: flex;
			flex-direction: column;
			gap: 6px;
		}
		.add-room-modal .form-field label {
			font-size: 13px;
			font-weight: 600;
			color: var(--text);
			display: flex;
			align-items: center;
			gap: 6px;
		}
		.add-room-modal .form-field label .required {
			color: var(--danger);
			font-weight: bold;
		}
		.add-room-modal .form-field label .icon {
			font-size: 14px;
			opacity: 0.7;
		}
		.add-room-modal input,
		.add-room-modal select,
		.add-room-modal textarea {
			font-size: 14px;
			padding: 10px 12px;
			border: 1px solid var(--outline);
			border-radius: 8px;
			background: var(--surface);
			color: var(--text);
			transition: all 0.2s ease;
		}
		.add-room-modal input:focus,
		.add-room-modal select:focus,
		.add-room-modal textarea:focus {
			outline: none;
			border-color: var(--accent);
			box-shadow: 0 0 0 3px rgba(76, 141, 255, 0.1);
			background: var(--surface-alt);
		}
		.add-room-modal textarea {
			resize: vertical;
			min-height: 60px;
			font-family: inherit;
			line-height: 1.4;
		}
		.add-room-modal .piano-type-display {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 8px;
			margin-top: 4px;
		}
		.add-room-modal .piano-type-option {
			padding: 8px 12px;
			border: 1px solid var(--outline);
			border-radius: 6px;
			background: var(--surface-alt);
			color: var(--text-dim);
			text-align: center;
			font-size: 12px;
			cursor: pointer;
			transition: all 0.2s ease;
		}
		.add-room-modal .piano-type-option:hover {
			border-color: var(--accent);
			background: var(--accent-fade, rgba(76, 141, 255, 0.1));
		}
		.add-room-modal .piano-type-option.selected {
			background: var(--accent);
			color: #fff;
			border-color: var(--accent);
			font-weight: 600;
		}
		.add-room-modal .modal-footer {
			background: var(--surface-alt);
			border-top: 1px solid var(--outline);
			padding: 16px 20px;
		}
		.add-room-modal .modal-footer button {
			padding: 10px 20px;
			font-size: 14px;
			font-weight: 600;
			border-radius: 8px;
			transition: all 0.2s ease;
		}
		.add-room-modal .form-field.error input,
		.add-room-modal .form-field.error select,
		.add-room-modal .form-field.error textarea {
			border-color: var(--danger);
			background: rgba(255, 77, 77, 0.05);
		}
		.add-room-modal .form-field.error label {
			color: var(--danger);
		}
		.add-room-modal .error-message {
			color: var(--danger);
			font-size: 12px;
			margin-top: 4px;
			display: flex;
			align-items: center;
			gap: 4px;
		}
		.add-room-modal .error-message::before {
			content: "‚ö†Ô∏è";
			font-size: 10px;
		}
		.floor-filter-edit{position:relative;}
		.floor-filter-edit .add-floor-btn{
			position:absolute;right:-30px;top:50%;transform:translateY(-50%);
			width:24px;height:24px;border-radius:50%;background:var(--ok);
			color:#fff;font-size:16px;cursor:pointer;border:none;
			display:flex;align-items:center;justify-content:center;
		}
		.editable-input{
			background:var(--surface);border:1px solid var(--accent);
			border-radius:4px;padding:4px 6px;font-size:inherit;
			color:var(--text);width:100%;outline:none;
		}

		/* ===== ÈÄöÁü•Èù¢ÊùøÊ†∑Âºè ===== */
		.notification-section{display:flex;flex-direction:column;gap:10px;}
		.notification-section .section-title{margin-top:12px;}
		.notification-panel{background:var(--surface);border:1px solid var(--outline);border-radius:var(--radius);padding:10px 10px 12px;display:flex;flex-direction:column;gap:10px;max-height:340px;min-height:200px;}
		.notification-tabs{display:flex;gap:6px;}
		.notification-tabs button{flex:1;padding:6px 10px;font-size:12px;border-radius:10px;background:var(--surface-alt);border:1px solid var(--outline);color:var(--text-dim);cursor:pointer;letter-spacing:.5px;}
		.notification-tabs button[data-active='1']{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:600;box-shadow:0 2px 10px -4px rgba(0,120,255,.5);}
		.notification-list{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:4px;}
		.notification-empty{font-size:12px;color:var(--text-dim);text-align:center;padding:24px 6px;line-height:1.6;}
		.notify-item{position:relative;display:flex;flex-direction:column;gap:6px;padding:10px 12px 10px;border:1px solid var(--outline);background:linear-gradient(135deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-radius:12px;font-size:12px;line-height:1.4;backdrop-filter:blur(4px);}
		.notify-item.type-absence{border-color:#7c5e1f;background:linear-gradient(130deg,rgba(255,184,76,.08),rgba(255,184,76,.03));}
		.notify-item.type-abnormal{border-color:#7a1f28;background:linear-gradient(130deg,rgba(255,90,90,.08),rgba(255,90,90,.03));}
		.notify-header{display:flex;align-items:center;gap:8px;font-weight:600;font-size:12px;}
		.notify-header .badge{padding:2px 8px;font-size:10px;border-radius:14px;letter-spacing:.5px;font-weight:600;display:inline-flex;align-items:center;gap:4px;}
		.badge-absence{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#2a1c00;}
		.badge-abnormal{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;}
		.notify-body{display:flex;flex-wrap:wrap;gap:10px;color:var(--text-dim);}
		.notify-footer{display:flex;align-items:center;justify-content:space-between;margin-top:2px;}
		.notify-footer .time{font-size:11px;color:var(--text-dim);}
		.notify-ignore{background:transparent;border:1px solid var(--outline);color:var(--text-dim);padding:3px 8px;font-size:11px;border-radius:8px;cursor:pointer;}
		.notify-ignore:hover{border-color:var(--accent);color:var(--text);} 
		.notify-item.resolved{opacity:.55;}
		.notification-sync-hint{font-size:10px;text-align:right;color:var(--text-dim);opacity:.7;letter-spacing:.5px;}
		
		@keyframes pulse-border { 0%, 100% { border-color: #4a90e2; opacity: 0.8; } 50% { border-color: #7fb1ff; opacity: 1; } }
		@keyframes preparing-pulse { 0%, 100% { border-color: #f39c12; box-shadow: 0 0 15px rgba(243,156,18,0.3); } 50% { border-color: #e67e22; box-shadow: 0 0 25px rgba(243,156,18,0.5), 0 0 35px rgba(243,156,18,0.2); } } 
		.room-name {font-size:15px;font-weight:600;letter-spacing:.5px; display:flex;align-items:center; gap:6px; color:var(--text);} .pill {font-size:10px;padding:2px 6px;border-radius:6px;background:var(--surface-alt);color:var(--text-dim); font-weight:500; letter-spacing:.3px;transition:var(--transition);}
		.pill-grand {background:linear-gradient(135deg,#3b82f6,#1e40af);color:#fff;box-shadow:0 1px 3px rgba(59,130,246,0.3);}
		.pill-upright {background:linear-gradient(135deg,#10b981,#059669);color:#fff;box-shadow:0 1px 3px rgba(16,185,129,0.3);}
		.pill-other {background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;box-shadow:0 1px 3px rgba(139,92,246,0.3);}
		.room-card:hover .pill-grand {box-shadow:0 2px 6px rgba(59,130,246,0.5);}
		.room-card:hover .pill-upright {box-shadow:0 2px 6px rgba(16,185,129,0.5);}
		.room-card:hover .pill-other {box-shadow:0 2px 6px rgba(139,92,246,0.5);}
		.remark {font-size:11px;color:var(--text-dim); line-height:1.3; max-height:30px; overflow:hidden;text-overflow:ellipsis;}
		.occupant-line {display:flex;align-items:center; gap:6px; font-size:13px; font-weight:500; color:#fff; margin-top:2px; white-space:nowrap;overflow:hidden;}
		.dot {width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 3px rgba(76,141,255,.25);} 
		.status-row {margin-top:auto; display:flex; align-items:center; justify-content:space-between; gap:8px;}
		.chip {font-size:11px; padding:3px 8px; border-radius:8px; background:var(--surface-alt); color:var(--text-dim); font-weight:500; letter-spacing:.3px; line-height:1;}
		.chip.accent{color:var(--accent);} .chip.warn{color:var(--warn);} .chip.good{color:var(--ok);} .chip.danger{color:var(--danger);} 
		.chip.preparing{background:linear-gradient(135deg,#f39c12,#e67e22); color:#fff; font-weight:600; text-shadow:0 1px 2px rgba(0,0,0,0.3); box-shadow:0 2px 8px rgba(243,156,18,0.4); animation:chip-glow 2s infinite; position:relative;}
		.chip.preparing::before{content:'‚ö°'; margin-right:3px; animation:preparing-icon 1.5s infinite;}
		@keyframes chip-glow { 0%, 100% { box-shadow: 0 2px 8px rgba(243,156,18,0.4); } 50% { box-shadow: 0 2px 15px rgba(243,156,18,0.7), 0 0 20px rgba(243,156,18,0.3); } }
		@keyframes preparing-icon { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } } 
		.actions {display:flex;gap:4px;} .actions button {padding:4px 7px; font-size:11px; background:var(--surface-alt);} .actions button.primary{background:var(--accent);color:#fff;border-color:var(--accent);} .actions button.primary:hover{background:var(--accent-hover);} .actions button.danger{background:var(--danger);border-color:var(--danger);} 
		/* === ÂèØËØªÊÄßÂ¢ûÂº∫Ë¶ÜÁõñÊ†∑Âºè === */
		.room-card{color:#dbe5ef;}
		.room-card .room-name{font-weight:600; letter-spacing:.5px; color:#ffffff; text-shadow:0 1px 2px rgba(0,0,0,.4);} 
		.room-card .occupant-line span:last-child{font-weight:600; color:#fff;}
		
		/* === Á©∫Èó≤Áä∂ÊÄÅÈáçÊñ∞ËÆæËÆ° === */
		.room-card.empty{
			background:radial-gradient(circle at 22% 18%, #253a32 0%, #1c2d27 55%, #13211d 100%);
			border:1px solid #2f5f4b; 
			box-shadow:
				0 0 0 1px rgba(60,130,100,0.25),
				0 2px 10px -2px rgba(0,0,0,0.55),
				0 6px 22px -8px rgba(0,0,0,0.6),
				inset 0 0 0 1px rgba(255,255,255,0.03),
				inset 0 4px 18px -6px rgba(90,160,120,0.08);
			filter:saturate(.85) brightness(.92);
		} 
		.room-card.empty:hover{
			border-color:#3d7a60;
			background:radial-gradient(circle at 25% 20%, #29453b 0%, #203831 55%, #152723 100%);
			box-shadow:
				0 0 0 1px rgba(70,150,115,0.4),
				0 6px 18px -6px rgba(0,0,0,0.65),
				0 10px 38px -12px rgba(0,0,0,0.55),
				inset 0 1px 0 rgba(255,255,255,0.05),
				inset 0 4px 22px -8px rgba(90,160,120,0.14);
			transform:translateY(-3px);
		} 
		/* Á©∫Èó≤ÁÜÑÁÅ≠ chip Ê†∑Âºè */
		.chip-dim[data-empty="1"]{
			background:linear-gradient(135deg,rgba(70,90,80,0.25),rgba(40,55,48,0.18));
			color:#d9e7dd; 
			font-weight:500;
			letter-spacing:.4px;
			border:1px solid rgba(120,170,150,0.25);
			box-shadow:0 1px 2px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.02);
			text-shadow:0 1px 2px rgba(0,0,0,0.45);
			filter:brightness(.95) saturate(.9);
		}
		.room-card.empty .status-row .chip-dim[data-empty="1"]:hover{background:linear-gradient(135deg,rgba(90,115,100,0.3),rgba(50,70,60,0.25));}
		/* Á©∫Èó≤Áä∂ÊÄÅÊñáÂ≠óÂ¢ûÂº∫ */
		.room-card.empty .room-name{
			color:#f2f7f5; 
			text-shadow:0 1px 3px rgba(0,0,0,0.55);
			font-weight:650;
			letter-spacing:.6px;
		}
		.room-card.empty .remark{
			color:#b7c9c0; 
			opacity:.85;
		} 
		.room-card.empty .occupant-line{display:none;}
		/* ‰∏éÂç†Áî®‰∫ÆËµ∑ÂØπÂ∫îÔºöÂç†Áî®Êàø‰øùÊåÅÈ≤úËâ≥ÔºõÁ©∫Èó≤Èôç‰ΩéÈ•±ÂíåÂ∫¶ */
		.room-card[data-status='occupied']{filter:saturate(1.05) brightness(1.03);} 
		.room-card[data-status='empty']{filter:saturate(.85) brightness(.95);} 
		.room-card[data-status='empty']:hover{filter:saturate(.95) brightness(1);} 
		.room-card .status-row .chip{filter:brightness(1.05);} 
		.room-card[data-status='overtime'] .chip.danger{background:rgba(255,77,77,0.18); box-shadow:0 0 0 1px rgba(255,77,77,0.35);} 
		.room-card[data-status='preparing'] .chip.preparing{background:rgba(243,156,18,0.15); color:#ffb347;} 
		.room-card .actions button{filter:brightness(1.1);} 
		.room-card:hover .actions button.primary{box-shadow:0 0 0 1px rgba(0,140,255,0.4);} 
		/* Êõ¥‰∫ÆÁöÑÊñáÊú¨‰∏éËæÖÂä©ËØ¥Êòé */
		body{--text:#d9e2ec; --text-dim:#90a4b8;}
		.empty {opacity:.55;}
		.meta-bar {display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
		.meta-stat {font-size:12px; color:var(--text-dim); display:flex; gap:4px; align-items:center;}
		.searchbox {position:relative;}
		.searchbox input {min-width:260px; padding-left:34px;}
		.searchbox svg {position:absolute; top:50%; left:10px; width:16px; height:16px; transform:translateY(-50%); stroke:var(--text-dim);} 
		.inline-search-results{position:absolute; top:100%; left:0; margin-top:6px; width:480px; max-width:70vw; background:var(--surface); border:1px solid var(--outline); border-radius:14px; box-shadow:0 8px 28px -10px rgba(0,0,0,.4); padding:10px 0; display:flex; flex-direction:column; max-height:420px; overflow:auto; z-index:60; backdrop-filter:blur(6px);} 
		.inline-search-results .group-title{font-size:11px; font-weight:600; color:var(--text-dim); padding:4px 14px 6px; letter-spacing:.5px;}
		.inline-search-results .result-item{padding:8px 14px; display:flex; justify-content:space-between; gap:12px; line-height:1.2; cursor:pointer; font-size:13px; border-left:3px solid transparent; transition:var(--transition);} 
		.inline-search-results .result-item:hover{background:var(--surface-alt); border-left-color:var(--accent);}
		.inline-search-results .result-item .meta{font-size:11px; color:var(--text-dim);} 
		.inline-search-results .result-item .occ-info{margin-left:6px; font-size:11px; padding:2px 6px; border-radius:10px; background:var(--surface-alt); display:inline-flex; align-items:center; gap:4px; font-weight:500;}
		.inline-search-results .result-item .occ-info .icon{font-size:12px;}
		.inline-search-results .result-item .occ-info.preparing{background:#ffe9c8;color:#a45b00;}
		.inline-search-results .result-item .occ-info.occupied{background:#d8eefc;color:#0a5b85;}
		.inline-search-results .result-item .occ-info.overtime{background:#ffe0e0;color:#b40000;}
		.inline-search-results .result-item .occ-info .dur{opacity:.8;}
		.inline-search-results .empty{padding:20px 16px; text-align:center; font-size:12px; color:var(--text-dim);} 
		.inline-search-results .result-item.room{--icon:"üéπ";} 
		.inline-search-results .highlight{color:var(--accent); font-weight:600;}
		/* ==== Á±ªÂûãÂàÜÈöîÁ∫ø ==== */
		.room-type-separator{grid-column:1/-1;display:flex;align-items:center;gap:14px;margin:14px 2px 6px;position:relative;}
		.room-type-separator .line{flex:1;height:1px;background:linear-gradient(90deg,transparent,var(--outline),transparent);}
		.room-type-separator .label{font-size:11px;letter-spacing:1px;font-weight:600;color:var(--text-dim);text-transform:uppercase;padding:4px 10px;border:1px solid var(--outline);border-radius:30px;background:var(--surface-alt);backdrop-filter:blur(4px);}
		.room-type-separator.grand .label{color:#60a5ff;border-color:#3d5e82;background:linear-gradient(120deg,rgba(30,50,70,.35),rgba(20,30,40,.4));}
		.room-type-separator.upright .label{color:#34d399;border-color:#245f45;background:linear-gradient(120deg,rgba(24,60,48,.35),rgba(18,32,26,.4));}
		.room-type-separator.other .label{color:#c084fc;border-color:#553a7a;background:linear-gradient(120deg,rgba(55,35,80,.35),rgba(35,25,50,.4));}
		/* ===== Ê†áÈ¢ò‰ΩìÁ≥ª ===== */
		.app-title{display:flex;flex-direction:column;gap:6px;margin-bottom:8px;}
		.title-line{display:flex;align-items:baseline;flex-wrap:wrap;gap:10px;}
		.title-line.main{font-size:22px;font-weight:600;letter-spacing:.5px;}
		.title-line.main .brand{background:linear-gradient(120deg,#cfd9e5,#ffffff);background-clip:text;-webkit-background-clip:text;color:transparent;font-weight:700;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));}
		.title-line.main .divider{color:var(--text-dim);font-weight:400;opacity:.6;}
		.title-line.main .module{color:var(--accent);font-weight:600;position:relative;}
		.title-line.main .module:after{content:"";position:absolute;left:0;bottom:-4px;width:100%;height:2px;background:linear-gradient(90deg,var(--accent),transparent);opacity:.5;border-radius:2px;}
		.title-line.sub{font-size:11px;font-weight:500;letter-spacing:.8px;color:var(--text-dim);text-transform:uppercase;gap:6px;}
		.tag{padding:2px 8px;border-radius:20px;display:inline-flex;align-items:center;gap:4px;font-size:10px;line-height:1.2;letter-spacing:.5px;font-weight:600;position:relative;}
		.tag.beta{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;box-shadow:0 2px 8px -2px rgba(99,102,241,.5);}
		.tag.env{background:linear-gradient(135deg,#0ea5e9,#3b82f6);color:#fff;}
		@media (max-width:720px){
			.title-line.main{font-size:18px;}
			.title-line.sub{font-size:10px;}
		}
		header h1, header h2.subtitle{display:none !important;}
		.side {width:340px; display:flex; flex-direction:column; gap:24px;}
		.section-title {font-size:13px;font-weight:600;color:var(--text-dim);letter-spacing:.5px;margin:0 0 8px;}
		.import-box {background:var(--surface);border:1px dashed var(--outline); border-radius:var(--radius); padding:14px; display:flex; flex-direction:column; gap:10px;}
		.import-box input {width:100%;}
		.list-small {max-height:220px; overflow:auto; font-size:12px; line-height:1.4; background:var(--surface-alt); padding:8px 10px; border:1px solid var(--outline); border-radius:var(--radius-sm);} .list-small code{font-size:11px;}
		.toast {position:fixed; bottom:24px; right:24px; background:#222c36; color:#fff; padding:10px 16px; border-radius:10px; font-size:13px; box-shadow:0 6px 18px -8px #000; display:flex; gap:10px; align-items:center; animation:fadeIn .3s;} @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
		.modal-backdrop {position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:100;}
		.modal {background:var(--surface); border:1px solid var(--outline); width:480px; max-width:92%; border-radius:18px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 12px 40px -16px rgba(0,0,0,.7);} .modal-header{padding:16px 20px; display:flex; align-items:center; justify-content:space-between; background:var(--surface-alt);} .modal-header h3{margin:0;font-size:15px;font-weight:600;} .modal-body{padding:16px 20px; display:flex; flex-direction:column; gap:14px; max-height:60vh; overflow:auto;} .modal-footer{padding:14px 20px; display:flex; gap:10px; justify-content:flex-end; background:var(--surface-alt);} 
		/* ÊîæÂ§ßÂ≠¶ÁîüÈÄâÊã©ÂºπÁ™óÔºöÂú®ÁâπÂÆö backdrop ‰∏ã‰ΩúÁî®ÔºåÈÅøÂÖçÂΩ±ÂìçÊñ∞Â¢ûÊàøÈó¥ÂºπÁ™ó */
		#studentModalBackdrop .modal { width:760px; max-width:94%; border-radius:22px; }
		#studentModalBackdrop .modal-header{ padding:22px 28px 18px; }
		#studentModalBackdrop .modal-header h3{ font-size:19px; letter-spacing:.6px; font-weight:650; }
		#studentModalBackdrop .modal-body{ padding:10px 28px 24px; gap:18px; max-height:68vh; }
		#studentModalBackdrop .modal-footer{ padding:18px 28px 22px; }
		#studentModalBackdrop input#studentSearch{ font-size:16px; padding:14px 16px; border-radius:14px; }
		#studentModalBackdrop .student-list{ --item-gap:10px; display:flex; flex-direction:column; gap:var(--item-gap); font-size:15px; line-height:1.5; }
		#studentModalBackdrop .student-list .stu-item{ padding:10px 14px 11px; font-size:15px; border-radius:12px; }
		#studentModalBackdrop .student-list .stu-item strong{ font-size:15px; font-weight:600; }
		#studentModalBackdrop .student-list .stu-item small{ font-size:12px; opacity:.85; }
		#studentModalBackdrop button{ font-size:14px; }
		#studentModalBackdrop .ghost{ font-size:14px; }
		/* ==== Â≠¶ÁîüÂç†Áî®ÊòæÁ§∫Â¢ûÂº∫ ==== */
		#studentModalBackdrop .student-list .student-item{display:flex; align-items:center; flex-wrap:wrap; gap:14px; background:linear-gradient(145deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.05);} 
		#studentModalBackdrop .student-list .student-item{justify-content:space-between;}
		#studentModalBackdrop .student-list .student-item .stu-name{flex:0 0 auto; min-width:100px; font-weight:600; letter-spacing:.4px;}
		#studentModalBackdrop .student-list .student-item .col-left{display:flex; align-items:center; gap:12px; flex:1 1 auto; min-width:320px;}
		#studentModalBackdrop .student-list .student-item .col-right{display:flex; align-items:center; gap:14px; justify-content:flex-end; flex:0 0 auto; min-width:240px;}
		#studentModalBackdrop .student-list .student-item .col-right .state-tag{margin-left:2px;}
		/* Á¶ÅÁî®Êóß info-col Â∏ÉÂ±ÄÔºàËã•ÊÆãÁïôÔºâ */
		#studentModalBackdrop .student-list .student-item .info-col{display:none !important;}
		/* Á¥ßÂáëÊ®°ÂºèÔºöÂú®ËæÉÁ™ÑÂ±èÂπïËá™Âä®ÂõûÈÄÄ‰∏∫Ê®™ÂêëÂçïË°å */
		@media (max-width:900px){
			#studentModalBackdrop .student-list .student-item{flex-direction:column; align-items:flex-start; gap:10px;}
			#studentModalBackdrop .student-list .student-item .col-left{flex-wrap:wrap; min-width:auto;}
			#studentModalBackdrop .student-list .student-item .col-right{width:100%; justify-content:flex-start; flex-wrap:wrap;}
		}
		#studentModalBackdrop .student-list .student-item:hover{background:linear-gradient(145deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03)); border-color:rgba(255,255,255,0.15);} 
		#studentModalBackdrop .student-list .student-item.kb-selected{border-color:var(--accent); box-shadow:0 0 0 1px var(--accent), 0 4px 14px -4px rgba(0,123,255,0.35);} 
		/* Â∑≤ÁßªÈô§Á∫µÂêëÁªìÊûÑÔºå‰øùÊåÅÂÖºÂÆπ */
		#studentModalBackdrop .student-list .student-item .stu-line-main{display:contents;}
		#studentModalBackdrop .student-list .student-item .stu-name{font-weight:600; letter-spacing:.4px;}
		#studentModalBackdrop .student-list .student-item .stu-line-sub{display:contents;}
		#studentModalBackdrop .student-list .student-item .tag.major{background:rgba(59,130,246,0.12); color:#7fb3ff;}
		#studentModalBackdrop .student-list .student-item .tag.grade{background:rgba(120,160,255,0.12); color:#b0c8ff;}
		#studentModalBackdrop .student-list .student-item .room-tag{padding:2px 8px; font-size:11px; border-radius:20px; background:linear-gradient(135deg,#2d3e52,#1e2a38); color:#aad4ff; letter-spacing:.4px; position:relative; top:-1px; box-shadow:0 1px 3px rgba(0,0,0,.4), inset 0 0 0 1px rgba(255,255,255,0.05);} 
		#studentModalBackdrop .student-list .student-item .room-tag::before{content:'Êàø'; font-size:10px; margin-right:4px; opacity:.8;}
		#studentModalBackdrop .student-list .student-item .state-tag{padding:2px 8px; font-size:11px; border-radius:16px; background:rgba(255,255,255,0.07); color:#d2dee8; letter-spacing:.4px; font-weight:500; box-shadow:0 1px 2px rgba(0,0,0,.4);}
		#studentModalBackdrop .student-list .student-item .state-tag.st-preparing{background:linear-gradient(135deg,#f39c12,#e67e22); color:#fff; font-weight:600;}
		#studentModalBackdrop .student-list .student-item .state-tag.st-occupied{background:linear-gradient(135deg,#0052d4,#4364f7); color:#fff; font-weight:600;}
		#studentModalBackdrop .student-list .student-item .state-tag.st-overtime{background:linear-gradient(135deg,#ff4d4d,#c62828); color:#fff; font-weight:600;}
		#studentModalBackdrop .student-list .student-item .state-tag.st-empty{background:rgba(255,255,255,0.12); color:#bcd;}
		/* ÈîÆÁõòÈ´ò‰∫Æ/hover ÊèêÂçáÂ±ÇÊ¨° */
		#studentModalBackdrop .student-list .stu-item.hover, 
		#studentModalBackdrop .student-list .stu-item:focus-visible{ outline:2px solid var(--accent); outline-offset:1px; }
		/* ÂìçÂ∫îÂºè‰øùÊä§ */
		@media (max-width:900px){
			#studentModalBackdrop .modal{ width:94%; }
			#studentModalBackdrop .modal-body{ max-height:70vh; }
		}
		.student-list {display:flex; flex-direction:column; gap:6px;} .student-item{background:var(--surface-alt); padding:6px 10px; border:1px solid var(--outline); border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-size:13px; transition:var(--transition);} .student-item:hover{border-color:var(--accent); color:var(--text);} .student-item .tag{font-size:11px; color:var(--text-dim);} .student-item.disabled{opacity:.45;pointer-events:none;} .student-item.kb-selected{border-color:var(--accent); background:var(--accent-fade,#2d6cdf22);} .student-item.kb-selected span:first-child{font-weight:600;}
		.muted{color:var(--text-dim);} .danger{color:var(--danger);} .warn{color:var(--warn);} .accent{color:var(--accent);} 
		footer {padding:18px 26px 34px; font-size:11px; text-align:center; color:var(--text-dim);} a{color:var(--accent); text-decoration:none;} a:hover{text-decoration:underline;}
	</style>
</head>
<body>
	<header>
		<div class="app-title">
			<div class="title-line main" aria-label="ÈùíÂ≤õËÄ∂ËÉ°Ëø™Ê¢ÖÁ∫ΩÂõ†Â≠¶Ê†° Áê¥ÊàøÁÆ°ÁêÜÁ≥ªÁªü">
				<span class="brand">ÈùíÂ≤õËÄ∂ËÉ°Ëø™Ê¢ÖÁ∫ΩÂõ†Â≠¶Ê†°</span>
				<span class="divider">¬∑</span>
				<span class="module">Áê¥ÊàøÁÆ°ÁêÜÁ≥ªÁªü</span>
			</div>
			<div class="title-line sub">
				<span class="tag beta">v2</span>
				<span class="tag env">ÂÆûÊó∂ÂêåÊ≠•ÂêØÁî®</span>
			</div>
		</div>
		<div class="searchbox">
			<svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>
			<input id="globalSearch" type="search" placeholder="ÊêúÁ¥¢Â≠¶Áîü / Áê¥Êàø (ÊîØÊåÅÊãºÈü≥È¶ñÂ≠óÊØç)" />
			<div id="inlineSearchResults" class="inline-search-results" style="display:none;"></div>
		</div>
		<div class="toolbar">
			<div class="sync-status" id="syncStatus">
				<div class="sync-dot" id="syncDot"></div>
				<span id="syncText">Á¶ªÁ∫ø</span>
			</div>
			<button id="btnImportStudents" class="ghost">ÂØºÂÖ•Â≠¶Áîü</button>
			<button id="btnSyncToCloud" class="ghost">ÂêåÊ≠•Âà∞‰∫ëÁ´Ø</button>
			<button id="btnReconnect" class="ghost" style="display: none;">ÈáçÊñ∞ËøûÊé•</button>
			<button id="btnRefresh" class="ghost">Âà∑Êñ∞</button>
		</div>
	</header>
	<main>
		<div class="panel" id="panelRooms">
			<div class="panel-header">
				<h2>Áê¥ÊàøÂàóË°®</h2>
				<div class="badge" id="statUsage">Âä†ËΩΩ‰∏≠...</div>
			</div>
			<div class="meta-bar">
				<div class="filters" id="floorFilters"></div>
				<div class="filters" id="typeFilters"></div>
				<div style="margin-left:auto;display:flex;align-items:center;gap:10px;">
					<button id="btnEditRooms" class="edit-mode-btn" title="ÁºñËæëÁê¥Êàø" style="padding:6px 14px;">ÁºñËæë</button>
				</div>
				<div class="meta-stat" id="metaCounts"></div>
			</div>
			<hr class="divider"/>
			<div class="grid" id="roomGrid"></div>
		</div>
		<div class="side">

			<div>
				<p class="section-title">ËøêË°åÁä∂ÊÄÅ</p>
				<div class="list-small" id="runtimeInfo"></div>
			</div>
			<div class="notification-section">
				<p class="section-title">ÈÄöÁü•ÊèêÈÜí</p>
				<div class="notification-panel" id="notificationPanel">
					<div class="notification-tabs">
						<button id="tabAbsence" data-type="absence" data-active="1">Áº∫Âã§</button>
						<button id="tabAbnormal" data-type="abnormal" data-active="0">ÂºÇÂ∏∏</button>
					</div>
					<div class="notification-list" id="notificationList"></div>
					<div class="notification-sync-hint" id="notificationSyncHint">ÂÆûÊó∂ÂêåÊ≠•ÂºÄÂêØ</div>
				</div>
			</div>
		</div>
	</main>
	<footer>¬© 2025 ÈùíÂ≤õËÄ∂ËÉ°Ëø™Ê¢ÖÁ∫ΩÂõ†Â≠¶Ê†° Áê¥ÊàøÁÆ°ÁêÜÁ≥ªÁªü ¬∑ Demo ÁâàÊú¨ ¬∑ <a href="https://supabase.com" target="_blank" rel="noopener">Supabase</a></footer>

	<!-- Â≠¶ÁîüÈÄâÊã© Modal -->
	<div class="modal-backdrop" id="studentModalBackdrop" style="display:none;">
		<div class="modal" role="dialog" aria-modal="true" aria-labelledby="studentModalTitle">
			<div class="modal-header">
				<h3 id="studentModalTitle">ÈÄâÊã©Â≠¶Áîü</h3>
				<button id="btnCloseStudentModal" class="ghost" style="padding:4px 8px;">‚úï</button>
			</div>
			<div class="modal-body">
				<input id="studentSearch" type="text" placeholder="ÊåâÂßìÂêç / ÊãºÈü≥È¶ñÂ≠óÊØç / ‰∏ì‰∏öËøáÊª§" />
				<div class="student-list" id="studentList"></div>
			</div>
			<div class="modal-footer">
				<button id="btnStudentModalCancel" class="ghost">ÂèñÊ∂à</button>
			</div>
		</div>
	</div>

	<!-- Êñ∞Â¢ûÊàøÈó¥ Modal -->
	<div class="modal-backdrop" id="addRoomModalBackdrop" style="display:none;">
		<div class="modal add-room-modal" role="dialog" aria-modal="true" aria-labelledby="addRoomModalTitle">
			<div class="modal-header">
				<h3 id="addRoomModalTitle">Êñ∞Â¢ûÁê¥Êàø</h3>
				<button id="btnCloseAddRoomModal" class="ghost" style="padding:4px 8px;">‚úï</button>
			</div>
			<div class="modal-body">
				<div class="form-grid">
					<div class="form-field">
						<label>
							<span class="icon">üè∑Ô∏è</span>
							ÊàøÈó¥ÂêçÁß∞
							<span class="required">*</span>
						</label>
						<input id="addRoomName" type="text" placeholder="‰æãÂ¶ÇÔºö101„ÄÅÁê¥ÊàøA" />
					</div>
					<div class="form-field">
						<label>
							<span class="icon">üìç</span>
							‰ΩçÁΩÆ
						</label>
						<input id="addRoomLocation" type="text" placeholder="‰æãÂ¶ÇÔºö1Ê•º„ÄÅÈü≥‰πêÊ•º‰∫åÂ±Ç" />
					</div>
					<div class="form-field">
						<label>
							<span class="icon">üéº</span>
							Èí¢Áê¥Á±ªÂûã
						</label>
						<div class="piano-type-display">
							<div class="piano-type-option" data-type="Á´ãÂºè">Á´ãÂºèÈí¢Áê¥</div>
							<div class="piano-type-option selected" data-type="‰∏âËßí">‰∏âËßíÈí¢Áê¥</div>
							<div class="piano-type-option" data-type="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</div>
						</div>
						<select id="addRoomPianoType" style="display:none;">
							<option value="Á´ãÂºè">Á´ãÂºè</option>
							<option value="‰∏âËßí">‰∏âËßí</option>
							<option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
						</select>
					</div>
					<div class="form-field">
						<label>
							<span class="icon">üìù</span>
							Â§áÊ≥®
						</label>
						<textarea id="addRoomRemark" placeholder="ÂèØÈÄâÔºöËÆæÂ§áËØ¥Êòé„ÄÅ‰ΩøÁî®Ê≥®ÊÑè‰∫ãÈ°πÁ≠â"></textarea>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button id="btnAddRoomCancel" class="ghost">ÂèñÊ∂à</button>
				<button id="btnAddRoomConfirm" class="primary">ÂàõÂª∫Áê¥Êàø</button>
			</div>
		</div>
	</div>

	<!-- Toast ÂÆπÂô® -->
	<div id="toastContainer" style="position:fixed;pointer-events:none;bottom:0;left:0;right:0;display:flex;flex-direction:column;align-items:flex-end;gap:10px;padding:0 24px 24px;z-index:500;"></div>

	<script>
	/*************************************************
	 * Êï∞ÊçÆÂ±Ç & Áä∂ÊÄÅÊ®°Âûã
	 *************************************************/
	const SUPABASE_URL = 'https://waesizzoqodntrlvrwhw.supabase.co';
	const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhZXNpenpvcW9kbnRybHZyd2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjIyOTYsImV4cCI6MjA3MzM5ODI5Nn0.kE5gSV68q1nLo4z2IqgwqfTBVqNOJw5qs08f6r0SQH0';
	let supabaseClient = null;
	let supabaseReady = false;
	let realtimeChannel = null;

	// Áªü‰∏ÄÊàøÈó¥Ê®°Âûã: { name, pianoType, location, remark, occupant, registerTime, version, heartbeatAt }
	const Store = {
		rooms: [], // Ê¥ªÂä®Áä∂ÊÄÅ (rooms Ë°®)
		roomMeta: {}, // ÈùôÊÄÅÔºàroom_databaseÔºâ name->meta
		students: [], // {id,name,major,grade}
		byName: new Map(),
		studentIndex: new Map(),
		floorSet: new Set(),
		filters: { floor:'ALL', type:'ALL' },
		settings: { basePracticeDuration:120 }, // Êîπ‰∏∫2Â∞èÊó∂
		timer: null,
		lastStats:{},
		pendingAssign:new Map(), // roomName -> {occupant,version,ts}
		localPracticeLogs: [], // Êú¨Âú∞ÁªÉ‰π†ËÆ∞ÂΩïÁºìÂ≠ò
		editMode: false, // ÁºñËæëÊ®°ÂºèÁä∂ÊÄÅ
		notifications: [], // {id,type:'absence'|'abnormal',student,room?,startAt,detail,state:'open'|'ignored'|'resolved',updatedAt,version}
		activeNotificationTab: 'absence',
		notificationSeq: 0
	};

	/* ÊãºÈü≥Êò†Â∞Ñ */
	const pinyinMap={'Èù≥':'jin','Ëìù':'lan','ÁÜô':'xi','ÈÇì':'deng','Ê∂µ':'han','Âë®':'zhou','Èùô':'jing','Ëøú':'yuan','ÂÜØ':'feng','Áëû':'rui','Â§ï':'xi','Âêï':'lv','Èáë':'jin','ÊòÇ':'ang','Âæê':'xu','Ê∂¨':'shuang','ÂÆ∏':'chen','Á™¶':'dou','Áíü':'jing','Âçé':'hua','Êûó':'lin','Êôè':'yan','ÁÜπ':'xi','ÊÆµ':'duan','Èâ¥':'jian','Âè∂':'ye','Ëîö':'wei','Âàò':'liu','Ê≥Ω':'ze','Êñá':'wen','ÊΩò':'pan','Áëæ':'jin','ÁÜ†':'yi','Êùé':'li','Âçö':'bo','ÊÅ©':'en','Áéã':'wang','Â•ï':'yi','ÁÑ∂':'ran','Èü©':'han','ÊòÄ':'yun','Ê°¶':'hua','Â≠î':'kong','Áíá':'xuan','Ëáß':'zang','Êò±':'yu','Ê£ã':'qi','Ëî∫':'lin','ËΩ©':'xuan','ÂÆã':'song','Ê¢ì':'zi','ÊöÑ':'xuan','Áî∞':'tian','Â≠ê':'zi','Ëê±':'xuan','Âº†':'zhang','‰æù':'yi','Èôà':'chen','ÊÄù':'si','ÂΩ§':'tong','Êù®':'yang','Èõ®':'yu','Ê°ê':'tong','Ëµµ':'zhao','Ê¨£':'xin','ÊÄ°':'yi','È©¨':'ma','Êô®':'chen','Êõ¶':'xi','È´ò':'gao','Ê¢¶':'meng','Áê™':'qi','ÈÉë':'zheng','ËØó':'shi','Âê¥':'wu','‰Ω≥':'jia','‰Ωï':'he','Êú±':'zhu','ÂøÉ':'xin','ËØ≠':'yu','ËÉ°':'hu','Ëã•':'ruo','Ê±ê':'xi','ËÆ∏':'xu','Áë∂':'yao','ÁΩó':'luo','ÈõÖ':'ya','Èíü':'zhong','Â´£':'yan','Ë∞¢':'xie','Ëãè':'su','Áê≥':'lin','Ê±ü':'jiang','Â≠ô':'sun','Ë¢Å':'yuan','Ê±™':'wang','Êõπ':'cao','Âßö':'yao','Ê≤à':'shen','Âç¢':'lu','Èü¶':'wei','Ëë£':'dong','ÂÇÖ':'fu','Á®ã':'cheng','‰∏Å':'ding','Áü≥':'shi','‰ªª':'ren','ÈÇπ':'zou','Èæô':'long','Âè≤':'shi','Êñπ':'fang','Â§è':'xia','‰æØ':'hou','ÈÇ±':'qiu','Â∞π':'yin','Èªé':'li','Ê±§':'tang','Êòì':'yi','Â∏∏':'chang','Ê≠¶':'wu','‰πî':'qiao','Ë¥∫':'he','Ëµñ':'lai','Èæö':'gong','Â∫û':'pang','Ê®ä':'fan','ÂÖ∞':'lan','ÊÆ∑':'yin','ÊñΩ':'shi','Èô∂':'tao','ÁøÅ':'weng','ÂÆâ':'an','ÂÄ™':'ni','‰∏•':'yan','Áâõ':'niu','Ê∏©':'wen','Ëä¶':'lu','Â≠£':'ji','‰øû':'yu','Á´†':'zhang','È≤Å':'lu','Ëëõ':'ge','‰ºç':'wu','Áî≥':'shen','Â∞§':'you','ÊØï':'bi','ËÅÇ':'nie','‰∏õ':'cong','ÁÑ¶':'jiao','Âêë':'xiang','ÊüØ':'ke','Â≤≥':'yue','Êπò':'xiang','ÊÇ¶':'yue','ÁéÆ':'wei','ÁÆ°':'guan','Âì≤':'zhe','Â©∑':'ting','Èáä':'shi','Ë®Ä':'yan','Á•ù':'zhu','ÂÆù':'bao','ÂΩ≠':'peng','Áæé':'mei','Ê∑á':'qi','Â∫∑':'kang','Áæ§':'qun','ËÄø':'geng','ÂπÑ':'wo','ÂçÉ':'qian','Áëú':'yu','Âèà':'you','ÈõØ':'wen','‰øä':'jun','Êù∞':'jie','Âä≤':'jin','Ë±™':'hao','Á¨ô':'sheng','ÊùÉ':'quan','Ëñõ':'xue','ÂÆú':'yi','ÈôÜ':'lu','Êõú':'yao','Â∂ô':'lin','È¶®':'xin','Ë£ï':'yu','Êòï':'xin','Ê≤ê':'mu','Âîê':'tang','Âêõ':'jun','Áõõ':'sheng','Á°ï':'shuo','Êôó':'han','Â¶Ç':'ru','Áâß':'mu','È£é':'feng','Êôû':'xi','‰ºä':'yi','Ê∏Ö':'qing','Â¶É':'fei','Êúà':'yue','Á•∫':'qi','Ëí≤':'pu','Êüè':'bai','ÁæΩ':'yu','ÂÜ†':'guan','Êàê':'cheng','È¢ú':'yan','‰∫¶':'yi','Ê≤Ö':'yuan','Êâø':'cheng','Áß¶':'qin','ÈìÇ':'bo','Á≠µ':'yan','ÊÖß':'hui','‰Ωú':'zuo','Áø∞':'han','‰∏ä':'shang','‰πã':'zhi','Ë∑Ø':'lu','Áìí':'zan','Ëëó':'zhu','Áùø':'rui','Á±Ω':'zi','‰∏û':'cheng','Â¶ç':'yan','Ê†©':'xu','‰πê':'le','ÈÄ∏':'yi','ËØö':'cheng','Èí∞':'yu','Ê¥Å':'jie','Â™õ':'yuan','ÈãÜ':'yun','Ë∞®':'jin','ÁïÖ':'chang','Ëåπ':'ru','Ê≤Ç':'yi','Â©â':'wan','Ëç∑':'he','Ê¥ã':'yang','Êòé':'ming','Â§ö':'duo','ÈÉó':'xi','‰º†':'chuan','Âπ≥':'ping','‰∏ñ':'shi','ÂÖÉ':'yuan','Ê±á':'hui','Ê≤ô':'sha','Áöì':'hao','ÂÆ∂':'jia','Ê•†':'nan','ÂÆò':'guan','Êüò':'zhe','Â∏å':'xi','Ê∫•':'pu','Â∞ö':'shang','Âáå':'ling','Áøæ':'xuan','Âßú':'jiang','ÁÖä':'xuan','Áê¨':'wan','Ëø™':'di','Êòç':'xuan','Ê≤Å':'qin','Á•é':'yi','Áèà':'jia','Êîø':'zheng','Èò≥':'yang','‰ª•':'yi','È™û':'qian','‰πô':'yi','ÈìÆ':'zheng','ÂïÜ':'shang','Â§©':'tian','Ëµê':'ci','Êôü':'sheng','Â≥∞':'feng','ÈÇµ':'shao','È¢¢':'hao','Êµ©':'hao','‰Ωô':'yu','Êµ°':'bo','ÁÄö':'han','Â≥ª':'jun','‰∫é':'yu','Èí≤':'zheng','Âüº':'qi','Ëãè':'su','ÂΩ¶':'yan','ÁÇ≥':'bing','Â≤ê':'qi','Áí†':'fan','ÁôΩ':'bai','Âíè':'yong','Áéé':'ding','Â∫Ñ':'zhuang','Á¨õ':'di','Ëñ™':'xin','Á±≥':'mi','Áê™':'qi','Â≠ò':'cun','Âíå':'he','Á¨ë':'xiao','Ê¨ß':'ou','Áø∞':'han','ÂñÜ':'zhe','Â∫≠':'ting','ÂΩ∞':'zhang','ÈÇ∞':'tai','Ëî°':'cai','Â±π':'yi','ÊΩÜ':'ying','ÊΩû':'lu','‰øÆ':'xiu','ÂÜâ':'ran','ÂÖâ':'guang','Áøº':'yi','Áè∫':'jun','Èóª':'wen','Ê≤ª':'zhi','Áé•':'yue','Â©ß':'jing','Â©ç':'qi','Ê§ç':'zhi','ÂØÖ':'yin','‰∫ï':'jing','Ê∫™':'xi','Á¥´':'zi','Ëà™':'hang','Êòæ':'xian','Áøî':'xiang','ÊôØ':'jing','Âõ≠':'yuan','Áæø':'yi','Ëææ':'da','Ê≠£':'zheng','ÊΩº':'tong','Âòâ':'jia','Â¥ö':'ling','Ê±â':'han','ÂÜº':'xian','Êòä':'hao','Êï¨':'jing','Â∞î':'er','Âçì':'zhuo','Â∏Ö':'shuai','Âøó':'zhi','ÂèØ':'ke','Èíß':'jun','Èâ¥':'jian','Á¨ô':'sheng','ÊùÉ':'quan','Êòæ':'xian','Áøî':'xiang','Êôè':'yan','ÁÜπ':'xi','Èáä':'shi','Ë®Ä':'yan','Ê£Æ':'sen','Ë¥§':'xian','Êü≥':'liu','ÊÅ©':'en','Â•ï':'yi','ÊΩº':'tong','Âòâ':'jia','ÊÄ°':'yi','Èáë':'jin','ÊòÇ':'ang','Áëæ':'jin','ÁÜ†':'yi','Áæé':'mei','Ê∑á':'qi','ÂçÉ':'qian','Áëú':'yu','Â≠ê':'zi','ËΩ©':'xuan','Âøó':'zhi','Êòä':'hao','Ëê±':'xuan','Áî≥':'shen','Â¥ö':'ling','Ê¢ì':'zi','Â∫∑':'kang','Â≤≥':'yue','Ê±â':'han','Êòä':'hao','ÁÜπ':'xi','Âèà':'you','ÂÆâ':'an','Ê∂¨':'shuang','ÂÆ∏':'chen','ÂÆú':'yi','Ëâ∫':'yi','Âçì':'zhuo','ÁÑ∂':'ran','Ëîö':'wei','Ëìù':'lan','Êï¨':'jing','ËΩ©':'xuan','Êò±':'yu','Ê£ã':'qi','Â∞î':'er','Ê∂µ':'han','ÈõØ':'wen','Â©∑':'ting','Âçì':'zhuo','Áæ§':'qun','Â≠ê':'zi','Â∏Ö':'shuai','Â≠ê':'zi','‰æù':'yi','Âçö':'bo','ÁéÆ':'wei','Ê¨£':'xin','ÊÄ°':'yi','Èùô':'jing','Ëøú':'yuan','ÂÆù':'bao','ÊÄ°':'yi','Â∏∏':'chang','Ê¨£':'xin','Ê¥ã':'yang','Â©â':'wan','Ëåπ':'ru','Êòé':'ming','Â§ö':'duo','Êù∞':'jie','Ê¨£':'xin','Ëç∑':'he','ÂçÉ':'qian','Áöì':'hao','Ê±á':'hui','Ê≥Ω':'ze','‰º†':'chuan','Âπ≥':'ping','‰∏ñ':'shi','ÂÖÉ':'yuan','ÂÜ†':'guan','Ê∫ê':'yuan','Á±≥':'mi','Áê™':'qi','Âçï':'dan','Ëã•':'ruo','Ê∫™':'xi','ÊÅ©':'en','Âíå':'he','Èáë':'jin','ÈªÑ':'huang','ÂèØ':'ke','Ê¨£':'xin','Â≠î':'kong','Ê¢ì':'zi','ËØ≠':'yu','Â≠ò':'cun','Êµ©':'hao','Âòâ':'jia','Ëç∑':'he','Èõ®':'yu','Á¨õ':'di','Â≠ê':'zi','ËΩ©':'xuan','Ëñ™':'xin','Áëú':'yu','Ê¢ì':'zi','ÂÆ∏':'chen','Êâø':'cheng','ÁÜπ':'xi','Â≠ê':'zi','Â¢®':'mo','Â°ò':'tang','Ê¨£':'xin','Â¶ç':'yan','Á¨ë':'xiao','Ê¨ß':'ou','Á•é':'yi','Áé•':'yue','Â©ß':'jing','Â©ç':'qi','Ê§ç':'zhi','ÂÖÉ':'yuan','Êµ©':'hao','ÂÖÉ':'yuan','Ê¢ì':'zi','ÂØÖ':'yin','‰æù':'yi','ËØ∫':'nuo','Èíß':'jun','Â±π':'yi','Âçö':'bo','Èóª':'wen','Â∫≠':'ting','ÂΩ∞':'zhang','ÊΩÜ':'ying','ÊΩû':'lu','ÁÜ†':'yi','ÂÆ∏':'chen','Â§©':'tian','Áøº':'yi','Ê≤ª':'zhi','Èíß':'jun','Êûó':'lin','ÁÜ†':'yi','Ê¢ì':'zi','Â≥∞':'feng','‰øÆ':'xiu','ÂÜâ':'ran','Áè∫':'jun','Áø∞':'han','ÂñÜ':'zhe','Á±≥':'mi','Èò≥':'yang','ÂÖâ':'guang','Ê†©':'xu','‰πê':'le','ÂÆâ':'an','ÊÖß':'hui','ÂÜ†':'guan','Âçé':'hua','Ëã•':'ruo','Êòï':'xin','Èõ®':'yu','ÁÜô':'xi','Èáë':'jin','Ê≤Ç':'yi','‰ª•':'yi','ËØ∫':'nuo','Èí∞':'yu','Ê≤ê':'mu','Êõ¶':'xi','Áâß':'mu','È£é':'feng','Ê¨£':'xin','Â¶ç':'yan','Ê≤Ö':'yuan','Êâø':'cheng','Á±Ω':'zi','‰∏û':'cheng','Ë∞®':'jin','ÁïÖ':'chang','‰Ωú':'zuo','Áø∞':'han','Êñá':'wen','Áõõ':'sheng','Ë∑Ø':'lu','Èõ®':'yu','Áìí':'zan','‰∫¶':'yi','ÂÆ∏':'chen','ÈÄ∏':'yi','ËØö':'cheng','Â≠ê':'zi','Ê∏Ö':'qing','Êüè':'bai','ÁæΩ':'yu','ÈìÇ':'bo','Á≠µ':'yan','Êõú':'yao','Â∂ô':'lin','ËΩ©':'xuan','Â≠ê':'zi','Ëåπ':'ru','Âòâ':'jia','Âêõ':'jun','Ê¥Å':'jie','Â™õ':'yuan','Êúà':'yue','Á•∫':'qi','Ê∑á':'qi','Êôó':'han','Â¶Ç':'ru','‰∏ä':'shang','ÊÅ©':'en','ÈõÖ':'ya','Êôû':'xi','‰∏Ä':'yi','Â¶É':'fei','ÊÄ°':'yi','Êñá':'wen','È≠è':'wei','‰ºä':'yi','Ëê±':'xuan','Êòì':'yi','Êàê':'cheng','Êôü':'sheng','Âòâ':'jia','ÂÆ∂':'jia','Á°ï':'shuo','‰Ω≥':'jia','È¶®':'xin','ËØ≠':'yu','Ëëó':'zhu','Áùø':'rui','ËØó':'shi','ÊÇ¶':'yue','‰æù':'yi','ÂÆ∏':'chen','Â≠ê':'zi','ÈãÜ':'yun','Ê∂µ':'han','‰πã':'zhi','Ë£ï':'yu','Ëææ':'da'};

	function matchPinyin(name, searchTerm) {
		if (!searchTerm) return true;
		const searchLower = searchTerm.toLowerCase().trim();
		const nameLower = name.toLowerCase();
		
		// Áõ¥Êé•ÂåπÈÖç‰∏≠Êñá
		if (nameLower.includes(searchLower)) return true;
		
		// Â§ÑÁêÜÁ©∫Ê†ºÂàÜÈöîÁöÑÂ§öÂÖ≥ÈîÆËØçÊêúÁ¥¢
		const keywords = searchLower.split(/\s+/).filter(k => k.length > 0);
		if (keywords.length > 1) {
			return matchMultipleKeywords(name, keywords);
		}
		
		// ÂçïÂÖ≥ÈîÆËØçÁöÑÊãºÈü≥ÂåπÈÖçÈÄªËæë
		const nameChars = name.split('');
		const firstLetters = nameChars.map(char => {
			const py = pinyinMap[char];
			return py ? py.charAt(0) : char.toLowerCase();
		});
		
		// Â¶ÇÊûúÊêúÁ¥¢ËØçÂè™Êúâ‰∏Ä‰∏™Â≠óÊØçÔºåÂè™ÂåπÈÖçÁ¨¨‰∏Ä‰∏™Â≠óÁöÑÈ¶ñÂ≠óÊØç
		if (searchLower.length === 1) {
			return firstLetters[0] === searchLower;
		}
		
		// Â§öÂ≠óÊØçÊêúÁ¥¢Êó∂ÁöÑËøûÁª≠È¶ñÂ≠óÊØçÂåπÈÖç
		const firstLettersStr = firstLetters.join('');
		
		// ÂÆåÊï¥ÁöÑÈ¶ñÂ≠óÊØçÂåπÈÖçÔºàÂ¶Ç "ÂΩ≠ÁæéÂ≤ê" -> "pmq"Ôºâ
		if (firstLettersStr === searchLower) return true;
		
		// ‰ªéÂºÄÂ§¥ÂºÄÂßãÁöÑÈÉ®ÂàÜÂåπÈÖçÔºàÂ¶Ç "ÂΩ≠ÁæéÂ≤ê" -> "pm"Ôºâ
		if (firstLettersStr.startsWith(searchLower)) return true;
		
		// ËøûÁª≠Â≠ê‰∏≤ÂåπÈÖçÔºàÂ¶Ç "ÂΩ≠ÁæéÂ≤ê" -> "mq" ÂåπÈÖç "ÁæéÂ≤ê"Ôºâ
		if (searchLower.length >= 2 && firstLettersStr.includes(searchLower)) return true;
		
		return false;
	}

	// Â§öÂÖ≥ÈîÆËØçÂåπÈÖçÂáΩÊï∞
	function matchMultipleKeywords(name, keywords) {
		const nameLower = name.toLowerCase();
		const nameChars = name.split('');
		const firstLetters = nameChars.map(char => {
			const py = pinyinMap[char];
			return py ? py.charAt(0) : char.toLowerCase();
		});
		const firstLettersStr = firstLetters.join('');
		
		// ÊØè‰∏™ÂÖ≥ÈîÆËØçÈÉΩÂøÖÈ°ªÂçïÁã¨ÂåπÈÖçÔºàAND ÈÄªËæëÔºâ
		const allMatch = keywords.every(keyword => {
			// Áõ¥Êé•‰∏≠ÊñáÂåπÈÖç
			if (nameLower.includes(keyword)) return true;
			
			// ÂçïÂ≠óÊØçÈ¶ñÂ≠óÊØçÂåπÈÖç
			if (keyword.length === 1) {
				return firstLetters.includes(keyword);
			}
			
			// Â§öÂ≠óÊØçËøûÁª≠ÂåπÈÖç
			if (keyword.length >= 2) {
				return firstLettersStr.includes(keyword);
			}
			
			return false;
		});
		
		if (allMatch) return true;
		
		// Êô∫ËÉΩÈ¶ñÂ≠óÊØçÁªÑÂêàÂåπÈÖç
		const isAllSingleLetters = keywords.every(k => k.length === 1);
		if (isAllSingleLetters) {
			return matchSmartKeywords(name, keywords);
		}
		
		// ÁªÑÂêàÂÖ≥ÈîÆËØçÂåπÈÖç
		return matchCombinedKeywords(name, keywords, firstLetters, nameLower);
	}

	// ÁªÑÂêàÂÖ≥ÈîÆËØçÂåπÈÖç
	function matchCombinedKeywords(name, keywords, firstLetters, nameLower) {
		for (let i = 0; i < keywords.length; i++) {
			const keyword = keywords[i];
			let matched = false;
			
			if (keyword.length === 1) {
				// ÂçïÂ≠óÊØçÔºöÊ£ÄÊü•È¶ñÂ≠óÊØç
				matched = firstLetters.includes(keyword);
			} else {
				// Â§öÂ≠óÊØçÔºöÊ£ÄÊü•‰∏≠ÊñáÊàñÊãºÈü≥
				matched = nameLower.includes(keyword) || 
						  firstLetters.join('').includes(keyword);
			}
			
			if (!matched) return false;
		}
		
		return true;
	}

	// Êô∫ËÉΩÂÖ≥ÈîÆËØçÂåπÈÖçÔºàÊîØÊåÅÈ¶ñÂ≠óÊØçÁªÑÂêàÔºâ
	function matchSmartKeywords(name, keywords) {
		const nameChars = name.split('');
		const firstLetters = nameChars.map(char => {
			const py = pinyinMap[char];
			return py ? py.charAt(0) : char.toLowerCase();
		});
		
		// Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®ËøûÁª≠ÁöÑÈ¶ñÂ≠óÊØçÂåπÈÖç
		if (keywords.length <= nameChars.length) {
			for (let i = 0; i <= firstLetters.length - keywords.length; i++) {
				let match = true;
				for (let j = 0; j < keywords.length; j++) {
					if (firstLetters[i + j] !== keywords[j]) {
						match = false;
						break;
					}
				}
				if (match) return true;
			}
			
			// ÊîØÊåÅÈùûËøûÁª≠‰ΩÜÊåâÈ°∫Â∫èÁöÑÈ¶ñÂ≠óÊØçÂåπÈÖç
			let keywordIndex = 0;
			for (let i = 0; i < firstLetters.length && keywordIndex < keywords.length; i++) {
				if (firstLetters[i] === keywords[keywordIndex]) {
					keywordIndex++;
				}
			}
			if (keywordIndex === keywords.length) return true;
		}
		
		return false;
	}

	function canonicalizeRoom(r){
		if(!r) return null;
		return {
			name: r.name,
			pianoType: r.piano_type || r.pianoType || r.pianoKind || 'Êó†Èí¢Áê¥',
			location: (r.location||'').trim(),
			remark: r.remark || '',
			occupant: r.occupant_student_name || r.occupant || r.student || null,
			registerTime: r.register_time ? toMs(r.register_time) : (r.registerTime||null),
			version: r.version || 0,
			heartbeatAt: r.heartbeat_at ? toMs(r.heartbeat_at) : null
		};
	}
	function toMs(v){ if(!v) return null; if(typeof v==='number') return v* (v<2e12?1000:1); return new Date(v).getTime(); }

	/*************************************************
	 * Supabase ÈÄÇÈÖçÂô®
	 *************************************************/
	async function initSupabase(){
		updateSyncStatus('connecting', 'ËøûÊé•‰∏≠...');
		let retryCount = 0;
		const maxRetries = 3;
		
		while (retryCount < maxRetries) {
			try {
				logInfo(`Â∞ùËØïËøûÊé• Supabase (Á¨¨ ${retryCount + 1} Ê¨°)`);
				
				// Ê£ÄÊü• Supabase ÂÆ¢Êà∑Á´ØÊòØÂê¶Â∑≤Âä†ËΩΩ
				if(typeof window.supabase !== 'undefined' && window.supabase.createClient){ 
					logInfo('‰ΩøÁî®ÂÖ®Â±Ä supabase ÂØπË±°');
					supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); 
				} else if(typeof window.createClient==='function'){ 
					logInfo('‰ΩøÁî®ÂÖ®Â±Ä createClient ÂáΩÊï∞');
					supabaseClient = window.createClient(SUPABASE_URL, SUPABASE_KEY); 
				} else { 
					logInfo('Âä®ÊÄÅÂä†ËΩΩ Supabase ËÑöÊú¨');
					await loadSupabaseScript(); 
					if (!window.supabase || !window.supabase.createClient) {
						throw new Error('Supabase ËÑöÊú¨Âä†ËΩΩÂ§±Ë¥•ÔºåÂÖ®Â±ÄÂØπË±°‰∏çÂèØÁî®');
					}
					supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); 
				}
				
				// È™åËØÅÂÆ¢Êà∑Á´ØÂØπË±°
				if (!supabaseClient) {
					throw new Error('Supabase ÂÆ¢Êà∑Á´ØÂàõÂª∫Â§±Ë¥•');
				}
				
				// ÊµãËØïËøûÊé•
				logInfo('ÊµãËØï Supabase ËøûÊé•...');
				updateSyncStatus('connecting', 'ÊµãËØïËøûÊé•...');
				const { data, error } = await supabaseClient.from('rooms').select('count').limit(1);
				if (error) {
					logWarn('Supabase ËøûÊé•ÊµãËØïÂ§±Ë¥•:', error.message);
					throw error;
				} else {
					logInfo('Supabase ËøûÊé•ÊµãËØïÊàêÂäü');
				}
				
				supabaseReady = true; 
				logInfo('Supabase ÂàùÂßãÂåñÂÆåÊàê');
				updateSyncStatus('connected', 'Supabase Â∞±Áª™');
				return; // ÊàêÂäüÔºåÈÄÄÂá∫ÈáçËØïÂæ™ÁéØ
				
			} catch (error) {
				retryCount++;
				logErr(`Supabase ÂàùÂßãÂåñÂ§±Ë¥• (Á¨¨ ${retryCount} Ê¨°):`, error.message);
				
				if (retryCount >= maxRetries) {
					updateSyncStatus('error', `ÂàùÂßãÂåñÂ§±Ë¥• (${error.message})`);
					// ‰∏çÊäõÂá∫ÈîôËØØÔºåÊîπ‰∏∫‰ºòÈõÖÈôçÁ∫ß
					logWarn('‰ΩøÁî®Á¶ªÁ∫øÊ®°Âºè');
					return;
				}
				
				// Á≠âÂæÖÂêéÈáçËØï
				await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
			}
		}
	}
	function loadSupabaseScript(){
		return new Promise((res,rej)=>{
			// Ê£ÄÊü•ÊòØÂê¶Â∑≤Âä†ËΩΩ
			if(window.supabase && window.supabase.createClient){
				logInfo('Supabase ËÑöÊú¨Â∑≤Â≠òÂú®');
				return res();
			}
			
			const s=document.createElement('script'); 
			s.src='https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js';
			s.crossOrigin = 'anonymous'; 
			s.onload=()=>{
				logInfo('Supabase ËÑöÊú¨Âä†ËΩΩÊàêÂäü');
				// Á≠âÂæÖÂá†ÊØ´ÁßíÁ°Æ‰øùÂÖ®Â±ÄÂØπË±°ÂèØÁî®
				setTimeout(res, 100);
			}; 
			s.onerror=(e)=>{
				logErr('Âä†ËΩΩ supabase ËÑöÊú¨Â§±Ë¥•:', e);
				rej(new Error('Âä†ËΩΩ supabase Â§±Ë¥•'));
			}; 
			document.head.appendChild(s);
		});
	}
	async function fetchRooms(){
		if(!supabaseReady) return [];
		const { data, error } = await supabaseClient.from('rooms').select('*');
		if(error){ logWarn('Âä†ËΩΩ rooms Â§±Ë¥•', error.message); return []; }
		return data.map(canonicalizeRoom);
	}
	async function fetchRoomMeta(){
		if(!supabaseReady) return {};
		const { data, error } = await supabaseClient.from('room_database').select('*');
		if(error){ logWarn('Âä†ËΩΩ room_database Â§±Ë¥•', error.message); return {}; }
		
		const map={}; 
		const cloudRooms = [];
		
		(data||[]).forEach(r=>{ 
			map[r.name]=r; 
			// ËΩ¨Êç¢‰∏∫Ê†áÂáÜÊ†ºÂºèÂπ∂Âä†ÂÖ•Áê¥ÊàøÂàóË°®
			cloudRooms.push({
				name: r.name,
				pianoType: r.piano_type || '',
				location: r.location || '',
				remark: r.remark || ''
			});
		}); 
		
		// Ëá™Âä®ÂêàÂπ∂‰∫ëÁ´ØÁê¥ÊàøÊï∞ÊçÆÂà∞Êú¨Âú∞ÔºàË∑≥Ëøá‰∫ëÁ´ØÂêåÊ≠•ÈÅøÂÖçÈÄíÂΩíÔºâ
		if (cloudRooms.length > 0) {
			logInfo(`‰ªé‰∫ëÁ´ØËé∑ÂèñÂà∞ ${cloudRooms.length} ‰∏™Áê¥ÊàøÔºåËá™Âä®ÂêàÂπ∂Âà∞Êú¨Âú∞`);
			await mergeRooms(cloudRooms, true); // skipCloudSync = true
		}
		
		return map;
	}
	
	async function fetchStudents(){
		if(!supabaseReady) return [];
		const { data, error } = await supabaseClient.from('student_database').select('id,name,major,grade');
		if(error){ logWarn('Âä†ËΩΩÂ≠¶ÁîüÂ§±Ë¥•', error.message); return []; }
		
		const students = data || [];
		
		// Ëá™Âä®ÂêàÂπ∂‰∫ëÁ´ØÂ≠¶ÁîüÊï∞ÊçÆÂà∞Êú¨Âú∞ÔºàË∑≥Ëøá‰∫ëÁ´ØÂêåÊ≠•ÈÅøÂÖçÈÄíÂΩíÔºâ
		if (students.length > 0) {
			logInfo(`‰ªé‰∫ëÁ´ØËé∑ÂèñÂà∞ ${students.length} ‰∏™Â≠¶ÁîüÔºåËá™Âä®ÂêàÂπ∂Âà∞Êú¨Âú∞`);
			await mergeStudents(students, true); // skipCloudSync = true
		}
		
		return students;
	}
	async function assignRoom(roomName, student, expectedVersion){
		// Ê£ÄÊü•Êìç‰ΩúÈîÅÔºåÈò≤Ê≠¢ÈáçÂ§çÊìç‰Ωú
		const lockKey = `assign_${roomName}`;
		if (Store.operationLocks?.has(lockKey)) {
			logWarn(`ÊàøÈó¥ ${roomName} Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂÄô`);
			toast(`ÊàøÈó¥ ${roomName} Ê≠£Âú®Â§ÑÁêÜ‰∏≠...`, 'warn');
			return { ok: false, error: 'Êìç‰ΩúËøõË°å‰∏≠' };
		}
		
		// ËÆæÁΩÆÊìç‰ΩúÈîÅ
		if (!Store.operationLocks) Store.operationLocks = new Set();
		Store.operationLocks.add(lockKey);
		
		try {
			// ‰πêËßÇÊõ¥Êñ∞ÔºàÁ´ãÂç≥ÊòæÁ§∫ÊïàÊûúÔºâ
			const optimisticResult = optimisticAssign(roomName, student);
			if (!optimisticResult) {
				return { ok: false, error: '‰πêËßÇÊõ¥Êñ∞Â§±Ë¥•' };
			}
			
			// ÂêéÁ´ØÂêåÊ≠•
			if(!supabaseReady){ 
				logWarn('Á¶ªÁ∫øÊ®°Âºè - ‰ªÖÊú¨Âú∞Êõ¥Êñ∞');
				return {ok:true, offline:true}; 
			}
			
			const nowIso = new Date().toISOString();
			const row = Store.rooms.find(r=>r.name===roomName);
			const nextVersion = (row? row.version:0)+1;
			
			// Ê†áËÆ∞‰∏∫ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅ
			Store.pendingAssign.set(roomName, { 
				student, 
				version: nextVersion, 
				timestamp: Date.now() 
			});
			
			const { data, error } = await supabaseClient.from('rooms').upsert({
				name: roomName,
				occupant_student_name: student,
				register_time: nowIso,
				heartbeat_at: nowIso,
				version: nextVersion,
				updated_at: nowIso
			}, {
				onConflict: 'name'
			});
			
			if(error){ 
				logErr('ÁôªËÆ∞Â§±Ë¥•', error.message);
				// ÂõûÊªö‰πêËßÇÊõ¥Êñ∞
				rollbackOptimisticAssign(roomName);
				return {ok:false,error}; 
			}
			
			// ÂÜôÂÖ•ÁªÉ‰π†ËÆ∞ÂΩï
			await writePracticeLog(roomName, student, 'assign');
			
			logInfo(`ÊàêÂäüÁôªËÆ∞ ${student} -> ${roomName} (v${nextVersion})`);
			return {ok:true, data};
			
		} finally {
			// Ê∏ÖÈô§Êìç‰ΩúÈîÅ
			Store.operationLocks.delete(lockKey);
			// Ê∏ÖÈô§ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅ
			Store.pendingAssign.delete(roomName);
			// Ê∏ÖÈô§ËßÜËßâÊåáÁ§∫
			clearOperationIndicator(roomName);
		}
	}
	async function clearRoom(roomName){
		// Ê£ÄÊü•Êìç‰ΩúÈîÅÔºåÈò≤Ê≠¢ÈáçÂ§çÊìç‰Ωú
		const lockKey = `clear_${roomName}`;
		if (Store.operationLocks?.has(lockKey)) {
			logWarn(`ÊàøÈó¥ ${roomName} Ê≠£Âú®Ê∏ÖÁ©∫‰∏≠ÔºåËØ∑Á®çÂÄô`);
			toast(`ÊàøÈó¥ ${roomName} Ê≠£Âú®Ê∏ÖÁ©∫‰∏≠...`, 'warn');
			return { ok: false, error: 'Êìç‰ΩúËøõË°å‰∏≠' };
		}
		
		const row = Store.rooms.find(r=>r.name===roomName);
		if(!row || !row.occupant) {
			toast('ÊàøÈó¥Â∑≤‰∏∫Á©∫');
			return {ok:true};
		}
		
		// ËÆæÁΩÆÊìç‰ΩúÈîÅ
		if (!Store.operationLocks) Store.operationLocks = new Set();
		Store.operationLocks.add(lockKey);
		
		try {
			// ÂÜôÂÖ•ÁªÉ‰π†ÁªìÊùüËÆ∞ÂΩï
			await writePracticeLog(roomName, row.occupant, 'clear');
			
			// ‰πêËßÇÊõ¥Êñ∞ÔºàÁ´ãÂç≥ÊòæÁ§∫ÊïàÊûúÔºâ
			optimisticClear(roomName);
			
			if(!supabaseReady){ 
				logWarn('Á¶ªÁ∫øÊ®°Âºè - ‰ªÖÊú¨Âú∞Ê∏ÖÁ©∫');
				return {ok:true, offline:true}; 
			}
			
			const nextVersion = (row.version || 0) + 1;
			
			// Ê†áËÆ∞‰∏∫ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅ
			Store.pendingAssign.set(roomName, { 
				student: null, 
				version: nextVersion, 
				timestamp: Date.now() 
			});
			
			const { data, error } = await supabaseClient.from('rooms').upsert({
				name: roomName, 
				occupant_student_name: null, 
				register_time: null,
				heartbeat_at: new Date().toISOString(),
				version: nextVersion,
				updated_at: new Date().toISOString()
			}, {
				onConflict: 'name'
			});
			
			if(error){ 
				logErr('Ê∏ÖÁ©∫Â§±Ë¥•', error.message);
				// Â¶ÇÊûúÊ∏ÖÁ©∫Â§±Ë¥•ÔºåËÄÉËôëÂõûÊªöÊú¨Âú∞Áä∂ÊÄÅ
				logWarn('Ê∏ÖÁ©∫Â§±Ë¥•Ôºå‰ΩÜÊú¨Âú∞Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞');
				return {ok:false,error}; 
			}
			
			logInfo(`ÊàêÂäüÊ∏ÖÁ©∫ ${roomName} (v${nextVersion})`);
			return {ok:true, data};
			
		} finally {
			// Ê∏ÖÈô§Êìç‰ΩúÈîÅ
			Store.operationLocks.delete(lockKey);
			// Ê∏ÖÈô§ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅ
			Store.pendingAssign.delete(roomName);
			// Ê∏ÖÈô§ËßÜËßâÊåáÁ§∫
			clearOperationIndicator(roomName);
		}
	}

	/*************************************************
	 * ‰πêËßÇÊõ¥Êñ∞ & ÂÆûÊó∂ËÆ¢ÈòÖ
	 *************************************************/
	function optimisticAssign(roomName, student, version){
		let r=Store.rooms.find(r=>r.name===roomName); 
		if(!r){ 
			r=canonicalizeRoom({name:roomName}); 
			Store.rooms.push(r); 
		}
		
		// ‰øùÂ≠òÂéüÂßãÁä∂ÊÄÅÁî®‰∫éÂèØËÉΩÁöÑÂõûÊªö
		if (!Store.rollbackStates) Store.rollbackStates = new Map();
		Store.rollbackStates.set(roomName, {
			occupant: r.occupant,
			registerTime: r.registerTime,
			version: r.version
		});
		
		r.occupant=student; 
		r.registerTime=Date.now(); 
		r.version=version||r.version+1; 
		Store.pendingAssign.set(roomName,{occupant:student,version:r.version,ts:Date.now()});
		
		// Ê∑ªÂä†ËßÜËßâÊåáÁ§∫
		const card = document.querySelector(`[data-room="${roomName}"]`);
		if (card) {
			card.classList.add('pending-operation');
			card.dataset.status = 'syncing';
		}
		
		renderRoomCard(roomName); 
		updateUsageStats(); 
		toast(`‚úÖ Â∑≤ÁôªËÆ∞ ${student} -> ${roomName}`, 'success');

		// Ëã•ÊúâËØ•Â≠¶ÁîüÁöÑÁº∫Âã§ÈÄöÁü•ÂàôÊ†áËÆ∞ resolved
		resolveAbsenceNotification(student);
		// ÂºÇÂ∏∏ÔºöÁôªËÆ∞Êó∂‰∏çÂ§ÑÁêÜÔºåÂºÇÂ∏∏Ê£ÄÊµãÂú®ÂÆöÊó∂Âô®
		
		return true;
	}
	
	function rollbackOptimisticAssign(roomName) {
		if (!Store.rollbackStates) return;
		
		const originalState = Store.rollbackStates.get(roomName);
		if (!originalState) return;
		
		const r = Store.rooms.find(r => r.name === roomName);
		if (r) {
			r.occupant = originalState.occupant;
			r.registerTime = originalState.registerTime;
			r.version = originalState.version;
			
			// ÁßªÈô§ËßÜËßâÊåáÁ§∫
			const card = document.querySelector(`[data-room="${roomName}"]`);
			if (card) {
				card.classList.remove('pending-operation');
			}
			
			renderRoomCard(roomName);
			updateUsageStats();
			toast(`‚ùå ÁôªËÆ∞Â§±Ë¥•ÔºåÂ∑≤ÂõûÊªö ${roomName}`, 'error');
		}
		
		Store.rollbackStates.delete(roomName);
		Store.pendingAssign.delete(roomName);
	}
	
	function optimisticClear(roomName, version){
		const r=Store.rooms.find(r=>r.name===roomName); 
		if(!r) return;
		
		// ‰øùÂ≠òÂéüÂßãÁä∂ÊÄÅÁî®‰∫éÂèØËÉΩÁöÑÂõûÊªö
		if (!Store.rollbackStates) Store.rollbackStates = new Map();
		Store.rollbackStates.set(roomName, {
			occupant: r.occupant,
			registerTime: r.registerTime,
			version: r.version
		});
		
		if(r.occupant){ 
			writePracticeLogLocal(r); 
		}
		
		r.occupant=null; 
		r.registerTime=null; 
		r.version=version||r.version+1; 
		
		// Ê∑ªÂä†ËßÜËßâÊåáÁ§∫
		const card = document.querySelector(`[data-room="${roomName}"]`);
		if (card) {
			card.classList.add('pending-operation');
			card.dataset.status = 'syncing';
		}
		
		renderRoomCard(roomName); 
		updateUsageStats(); 
		toast(`‚úÖ Â∑≤Ê∏ÖÁ©∫ ${roomName}`, 'success');

		// Ê∏ÖÁ©∫ÊàøÈó¥ÂêéÔºåËã•ËØ•Â≠¶ÁîüÊúâÂºÇÂ∏∏ÈÄöÁü•ÂàôÊ†áËÆ∞ resolved
		resolveAbnormalForRoom(roomName);
		
		return true;
	}
	
	// ÁßªÈô§Êìç‰ΩúËøõË°å‰∏≠ÁöÑËßÜËßâÊåáÁ§∫
	function clearOperationIndicator(roomName) {
		const card = document.querySelector(`[data-room="${roomName}"]`);
		if (card) {
			card.classList.remove('pending-operation');
		}
	}
	
	// ÂΩªÂ∫ïÊ∏ÖÁêÜÊàøÈó¥ÁöÑÊâÄÊúâÁä∂ÊÄÅ
	function cleanupRoomState(roomName) {
		// Ê∏ÖÁêÜÂæÖÂ§ÑÁêÜÊìç‰Ωú
		Store.pendingAssign.delete(roomName);
		
		// Ê∏ÖÁêÜÂõûÊªöÁä∂ÊÄÅ
		if (Store.rollbackStates) {
			Store.rollbackStates.delete(roomName);
		}
		
		// Ê∏ÖÁêÜÊìç‰ΩúÈîÅ
		if (Store.operationLocks) {
			Store.operationLocks.delete(`assign_${roomName}`);
			Store.operationLocks.delete(`clear_${roomName}`);
			Store.operationLocks.delete(`renew_${roomName}`);
		}
		
		// Ê∏ÖÁêÜDOMÂÖÉÁ¥†
		const card = document.querySelector(`[data-room="${CSS.escape(roomName)}"]`);
		if (card) {
			card.remove();
		}
		
		logInfo(`Â∑≤Ê∏ÖÁêÜÊàøÈó¥ ${roomName} ÁöÑÊâÄÊúâÁä∂ÊÄÅ`);
	}
	async function setupRealtime(){
		if(!supabaseReady) {
			logWarn('Supabase Êú™Â∞±Áª™ÔºåË∑≥ËøáÂÆûÊó∂ËÆ¢ÈòÖ');
			updateSyncStatus('error', 'Êú™ËøûÊé•');
			return;
		}
		
		updateSyncStatus('connecting', 'ËÆ¢ÈòÖ‰∏≠...');
		
		// Ê∏ÖÁêÜÊóßËøûÊé•
		if(realtimeChannel){ 
			try{ 
				supabaseClient.removeChannel(realtimeChannel);
				logInfo('Â∑≤ÁßªÈô§ÊóßÁöÑÂÆûÊó∂È¢ëÈÅì');
			}catch(e){
				logWarn('ÁßªÈô§ÊóßÈ¢ëÈÅìÂ§±Ë¥•', e.message);
			} 
		}
		
		// ÂàõÂª∫Êñ∞ÁöÑÂÆûÊó∂È¢ëÈÅì
		realtimeChannel = supabaseClient.channel('realtime-rooms')
			.on('postgres_changes', {
				event: '*',
				schema: 'public',
				table: 'rooms'
			}, (payload) => {
				logInfo('Êî∂Âà∞ÂÆûÊó∂Êõ¥Êñ∞:', payload.eventType, payload.new?.name || payload.old?.name);
				handleRealtimeRoom(payload);
			})
			.subscribe((status) => {
				if (status === 'SUBSCRIBED') {
					logInfo('‚úÖ ÂÆûÊó∂ÂêåÊ≠•Â∑≤ËøûÊé•');
					updateSyncStatus('connected', 'ÂÆûÊó∂ÂêåÊ≠•');
					toast('ÂÆûÊó∂ÂêåÊ≠•Â∑≤ÂêØÁî®');
				} else if (status === 'CHANNEL_ERROR') {
					logErr('‚ùå ÂÆûÊó∂ÂêåÊ≠•ËøûÊé•Â§±Ë¥•');
					updateSyncStatus('error', 'ËøûÊé•Â§±Ë¥•');
					toast('ÂÆûÊó∂ÂêåÊ≠•ËøûÊé•Â§±Ë¥•', 'error');
				} else if (status === 'TIMED_OUT') {
					logWarn('‚è∞ ÂÆûÊó∂ÂêåÊ≠•ËøûÊé•Ë∂ÖÊó∂');
					updateSyncStatus('error', 'ËøûÊé•Ë∂ÖÊó∂');
					toast('ÂÆûÊó∂ÂêåÊ≠•ËøûÊé•Ë∂ÖÊó∂', 'warn');
				} else if (status === 'CLOSED') {
					logWarn('üîå ÂÆûÊó∂ÂêåÊ≠•ËøûÊé•Â∑≤ÂÖ≥Èó≠');
					updateSyncStatus('error', 'ËøûÊé•Êñ≠ÂºÄ');
				} else {
					logInfo('ÂÆûÊó∂ÂêåÊ≠•Áä∂ÊÄÅ:', status);
					updateSyncStatus('connecting', 'ËøûÊé•‰∏≠...');
				}
			});
		
		// ËÆæÁΩÆÂøÉË∑≥Ê£ÄÊµã
		setInterval(async () => {
			try {
				const occupiedRooms = Store.rooms.filter(r => r.occupant);
				for (const room of occupiedRooms) {
					await supabaseClient.from('rooms').update({
						heartbeat_at: new Date().toISOString()
					}).eq('name', room.name);
				}
			} catch (error) {
				logWarn('ÂøÉË∑≥Êõ¥Êñ∞Â§±Ë¥•:', error.message);
			}
		}, 30000); // ÊØè30ÁßíÂøÉË∑≥‰∏ÄÊ¨°
	}
	
	function handleRealtimeRoom(payload){
		const row = payload.new || payload.old; 
		if(!row) return;
		
		const data = canonicalizeRoom(row); 
		const idx = Store.rooms.findIndex(r => r.name === data.name);
		
		// Èò≤ÈáçÂ§çÂ§ÑÁêÜÔºöÁîüÊàêÂîØ‰∏ÄÊ†áËØÜÁ¨¶
		const updateKey = `${data.name}_${payload.eventType}_${data.version}_${Date.now()}`;
		const recentUpdatesKey = 'recentUpdates';
		if (!Store[recentUpdatesKey]) Store[recentUpdatesKey] = new Map();
		
		// Ê£ÄÊü•ÊòØÂê¶Âú®Áü≠Êó∂Èó¥ÂÜÖÂ§ÑÁêÜËøáÁõ∏ÂêåÁöÑÊõ¥Êñ∞
		const recentUpdateTime = Store[recentUpdatesKey].get(`${data.name}_${payload.eventType}_${data.version}`);
		if (recentUpdateTime && Date.now() - recentUpdateTime < 1000) { // 1ÁßíÂÜÖÁöÑÈáçÂ§çÊõ¥Êñ∞
			logInfo(`ÂøΩÁï•ÈáçÂ§çÁöÑÂÆûÊó∂Êõ¥Êñ∞ ${data.name} v${data.version} (${payload.eventType})`);
			return;
		}
		
		// ËÆ∞ÂΩïÊ≠§Ê¨°Êõ¥Êñ∞
		Store[recentUpdatesKey].set(`${data.name}_${payload.eventType}_${data.version}`, Date.now());
		
		// Ê∏ÖÁêÜËøáÊúüÁöÑÊõ¥Êñ∞ËÆ∞ÂΩïÔºà‰øùÁïôÊúÄËøë5ÁßíÁöÑËÆ∞ÂΩïÔºâ
		setTimeout(() => {
			const expireTime = Date.now() - 5000;
			for (const [key, time] of Store[recentUpdatesKey].entries()) {
				if (time < expireTime) {
					Store[recentUpdatesKey].delete(key);
				}
			}
		}, 5000);
		
		// Ê£ÄÊü•ÊòØÂê¶‰∏∫Êú¨Âú∞ÂæÖÂ§ÑÁêÜÁöÑÊõ¥Êñ∞ÔºàÈÅøÂÖçÈáçÂ§çÂ§ÑÁêÜÔºâ
		const pending = Store.pendingAssign.get(data.name);
		if(pending && pending.version >= data.version){ 
			logInfo(`ÂøΩÁï•Êú¨Âú∞ÂæÖÂ§ÑÁêÜÊõ¥Êñ∞ ${data.name} v${data.version}`);
			return; 
		}
		
		// ÂÜ≤Á™ÅÊ£ÄÊµãÔºöÂ¶ÇÊûúÊú¨Âú∞Ê≠£Âú®Êìç‰ΩúËøô‰∏™ÊàøÈó¥
		const lockKey = `assign_${data.name}`;
		const clearLockKey = `clear_${data.name}`;
		const deleteLockKey = `delete_${data.name}`;
		const isLocked = Store.operationLocks?.has(lockKey) || Store.operationLocks?.has(clearLockKey) || Store.operationLocks?.has(deleteLockKey);
		
		if (isLocked) {
			if (Store.operationLocks?.has(deleteLockKey)) {
				logInfo(`ÊàøÈó¥ ${data.name} Ê≠£Âú®Âà†Èô§‰∏≠ÔºåÂøΩÁï•ÂÆûÊó∂Êõ¥Êñ∞`);
				return; // Âà†Èô§Êó∂ÂÆåÂÖ®ÂøΩÁï•ÊâÄÊúâÂÆûÊó∂Êõ¥Êñ∞
			}
			logWarn(`ÊàøÈó¥ ${data.name} Êú¨Âú∞Êìç‰Ωú‰∏≠ÔºåÂª∂ËøüÂ§ÑÁêÜËøúÁ®ãÊõ¥Êñ∞`);
			// Âª∂Ëøü3ÁßíÈáçËØï
			setTimeout(() => handleRealtimeRoom(payload), 3000);
			return;
		}
		
		// Á´ãÂç≥Êõ¥Êñ∞UI‰ª•ÂáèÂ∞ëÂª∂ËøüÊÑüÁü•
		let shouldRerender = false;
		let conflictDetected = false;
		
		// Â§ÑÁêÜ‰∏çÂêåÁ±ªÂûãÁöÑÊõ¥Êñ∞
		if (payload.eventType === 'DELETE') {
			if (idx >= 0) {
				Store.rooms.splice(idx, 1);
				logInfo(`ËøúÁ®ãÂà†Èô§ÊàøÈó¥: ${data.name}`);
				
				// ÂΩªÂ∫ïÊ∏ÖÁêÜÊàøÈó¥Áä∂ÊÄÅ
				cleanupRoomState(data.name);
				
				// ÈáçÂª∫Á¥¢ÂºïÂíåÁªüËÆ°
				rebuildIndexes();
				updateUsageStats();
				shouldRerender = false; // Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÊ∏≤Êüì
				
				toast(`üóëÔ∏è ÊàøÈó¥ ${data.name} Â∑≤Ë¢´Âà†Èô§`, 'info');
			}
		} else if (payload.eventType === 'INSERT') {
			if (idx < 0) {
				Store.rooms.push(data);
				logInfo(`ËøúÁ®ãÊñ∞Â¢ûÊàøÈó¥: ${data.name}`);
				shouldRerender = true;
			}
		} else if (payload.eventType === 'UPDATE') {
			// ========= ÂÆåÊï¥ÈáçÊ∏≤ÊüìÂ¢ûÂº∫ÈÄªËæë =========
			let prevOcc = null;
			if (idx >= 0) {
				const oldRoom = Store.rooms[idx];
				prevOcc = oldRoom.occupant;
				// ÂÜ≤Á™ÅÊ£ÄÊµãÔºàÂèåÊñπÈÉΩÊúâ‰∏çÂêåÂç†Áî®ËÄÖÔºâ
				if (oldRoom.occupant && data.occupant && oldRoom.occupant !== data.occupant) {
					conflictDetected = true;
					logWarn(`Ê£ÄÊµãÂà∞ÊàøÈó¥ ${data.name} ÂÜ≤Á™Å: Êú¨Âú∞(${oldRoom.occupant}) vs ËøúÁ®ã(${data.occupant})`);
					toast(`‚ö†Ô∏è ÊàøÈó¥ ${data.name} Â≠òÂú®ÂÜ≤Á™ÅÔºåËØ∑Ê£ÄÊü•`, 'warn');
				}
				// ÊòæÂºèÂ≠óÊÆµË¶ÜÁõñÔºå‰øùËØÅ null ‰∏ç‰∏¢
				const prevRegisterTime = oldRoom.registerTime;
				oldRoom.occupant = (data.occupant === null ? null : data.occupant);
				oldRoom.registerTime = data.registerTime || null;
				oldRoom.version = data.version;
				oldRoom.heartbeatAt = data.heartbeatAt;
				logInfo(`ËøúÁ®ãÊõ¥Êñ∞ÊàøÈó¥: ${data.name} v${data.version} (occupant: ${oldRoom.occupant || 'null'})`);
				
				// Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆûË¥®ÊÄßÂèòÂåñÔºàÂΩ±ÂìçUIÊòæÁ§∫ÁöÑÂ≠óÊÆµÔºâ
				const hasOccupantChange = prevOcc !== oldRoom.occupant;
				const hasRegisterTimeChange = prevRegisterTime !== oldRoom.registerTime;
				const hasSignificantChange = hasOccupantChange || (oldRoom.occupant && hasRegisterTimeChange);
				
				// ÂèòÂåñÊèêÁ§∫
				if (hasOccupantChange && !conflictDetected) {
					if (oldRoom.occupant) toast(`üéµ ${oldRoom.occupant} ÂºÄÂßã‰ΩøÁî® ${data.name}`, 'success'); else toast(`‚úÖ ${data.name} Â∑≤ÈáäÊîæ`, 'success');
				}
				
				// Âç†Áî® -> Á©∫ÔºöÂÆåÊï¥ÈáçÊ∏≤Êüì
				if (prevOcc && !oldRoom.occupant) {
					logInfo(`[FULL-RERENDER] ${data.name} cleared v${data.version} (${prevOcc} -> null)`);
					fullReRenderRoom(oldRoom);
					shouldRerender = false; // Â∑≤Âú® fullReRenderRoom ÂÜÖÂ§ÑÁêÜ
				} else if (hasSignificantChange) {
					logInfo(`[NORMAL-RERENDER] ${data.name} v${data.version} (${prevOcc || 'null'} -> ${oldRoom.occupant || 'null'})`);
					shouldRerender = true;
				} else {
					logInfo(`[SKIP-RERENDER] ${data.name} v${data.version} (Êó†UIÂèòÂåñÔºå‰ªÖÁâàÊú¨/ÂøÉË∑≥Êõ¥Êñ∞)`);
					shouldRerender = false;
				}
			} else {
				Store.rooms.push(data);
				logInfo(`ËøúÁ®ãÊèíÂÖ•ÊàøÈó¥(Ë°•ÂΩï): ${data.name}`);
				shouldRerender = true;
			}
		}
		
		// Ê∏ÖÁêÜÂæÖÂ§ÑÁêÜÁä∂ÊÄÅ
		Store.pendingAssign.delete(data.name);
		
		// Ê∏ÖÁêÜÂõûÊªöÁä∂ÊÄÅÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
		if (Store.rollbackStates) {
			Store.rollbackStates.delete(data.name);
		}
		
		// Ê∏ÖÈô§Êìç‰ΩúËßÜËßâÊåáÁ§∫
		clearOperationIndicator(data.name);
		
		// Á´ãÂç≥ÈáçÊñ∞Ê∏≤Êüì‰ª•ÂáèÂ∞ëÂª∂Ëøü
		if (shouldRerender) {
			renderRoomCard(data.name); 
			updateUsageStats();
			rebuildIndexes();
		}
		
		// Â¶ÇÊûúÊ£ÄÊµãÂà∞ÂÜ≤Á™ÅÔºåËß¶ÂèëÂÖ®ÈáèÂêåÊ≠•
		if (conflictDetected) {
			setTimeout(() => {
				logInfo('ÂÜ≤Á™ÅÂêéËß¶ÂèëÂÖ®ÈáèÊï∞ÊçÆÂêåÊ≠•');
				fetchRoomMeta();
			}, 2000);
		}
	}

	/*************************************************
	 * ‰∫ëÁ´ØÊï∞ÊçÆÂ∫ìÂêåÊ≠•
	 *************************************************/
	async function syncRoomDatabaseToCloud(rooms) {
		if (!supabaseReady) {
			logWarn('Supabase Êú™ËøûÊé•ÔºåË∑≥ËøáÁê¥ÊàøÊï∞ÊçÆÂ∫ìÂêåÊ≠•');
			return;
		}
		
		try {
			const roomData = rooms.map(room => ({
				name: room.name,
				piano_type: room.pianoType || '',
				location: room.location || '',
				remark: room.remark || '',
				updated_at: new Date().toISOString()
			}));
			
			// ‰ΩøÁî® upsert ÊâπÈáèÊèíÂÖ•/Êõ¥Êñ∞Áê¥ÊàøÂü∫Á°ÄÊï∞ÊçÆ
			const { data, error } = await supabaseClient
				.from('room_database')
				.upsert(roomData, { 
					onConflict: 'name',
					ignoreDuplicates: false 
				});
			
			if (error) {
				logErr('ÂêåÊ≠•Áê¥ÊàøÊï∞ÊçÆÂ∫ìÂ§±Ë¥•:', error.message);
				toast('Áê¥ÊàøÊï∞ÊçÆÂ∫ìÂêåÊ≠•Â§±Ë¥•', 'error');
			} else {
				logInfo(`‚úÖ ÊàêÂäüÂêåÊ≠• ${roomData.length} ‰∏™Áê¥ÊàøÂà∞‰∫ëÁ´ØÊï∞ÊçÆÂ∫ì`);
				toast(`Â∑≤ÂêåÊ≠• ${roomData.length} ‰∏™Áê¥ÊàøÂà∞‰∫ëÁ´Ø`);
			}
		} catch (err) {
			logErr('Áê¥ÊàøÊï∞ÊçÆÂ∫ìÂêåÊ≠•ÂºÇÂ∏∏:', err.message);
		}
	}
	
	async function syncStudentDatabaseToCloud(students) {
		if (!supabaseReady) {
			logWarn('Supabase Êú™ËøûÊé•ÔºåË∑≥ËøáÂ≠¶ÁîüÊï∞ÊçÆÂ∫ìÂêåÊ≠•');
			return;
		}
		
		try {
			const studentData = students.map(student => ({
				name: student.name,
				major: student.major || '',
				grade: student.grade || '',
				// Â¶ÇÊûúÊúâ id Âàô‰øùÁïôÔºåÂê¶ÂàôËÆ©Êï∞ÊçÆÂ∫ìËá™Âä®ÁîüÊàê
				...(student.id && { id: student.id })
			}));
			
			// ‰ΩøÁî® upsert ÊâπÈáèÊèíÂÖ•/Êõ¥Êñ∞Â≠¶ÁîüÊï∞ÊçÆ
			const { data, error } = await supabaseClient
				.from('student_database')
				.upsert(studentData, { 
					onConflict: 'name',
					ignoreDuplicates: false 
				});
			
			if (error) {
				logErr('ÂêåÊ≠•Â≠¶ÁîüÊï∞ÊçÆÂ∫ìÂ§±Ë¥•:', error.message);
				toast('Â≠¶ÁîüÊï∞ÊçÆÂ∫ìÂêåÊ≠•Â§±Ë¥•', 'error');
			} else {
				logInfo(`‚úÖ ÊàêÂäüÂêåÊ≠• ${studentData.length} ‰∏™Â≠¶ÁîüÂà∞‰∫ëÁ´ØÊï∞ÊçÆÂ∫ì`);
				toast(`Â∑≤ÂêåÊ≠• ${studentData.length} ‰∏™Â≠¶ÁîüÂà∞‰∫ëÁ´Ø`);
			}
		} catch (err) {
			logErr('Â≠¶ÁîüÊï∞ÊçÆÂ∫ìÂêåÊ≠•ÂºÇÂ∏∏:', err.message);
		}
	}
	
	async function manualSyncToCloud() {
		if (!supabaseReady) {
			toast('Supabase Êú™ËøûÊé•ÔºåÊó†Ê≥ïÂêåÊ≠•', 'error');
			return;
		}
		
		try {
			toast('Ê≠£Âú®ÂêåÊ≠•Âà∞‰∫ëÁ´Ø...', 'info');
			
			// ÂêåÊ≠•Áê¥ÊàøÊï∞ÊçÆÂ∫ì
			if (Store.rooms.length > 0) {
				await syncRoomDatabaseToCloud(Store.rooms);
			}
			
			// ÂêåÊ≠•Â≠¶ÁîüÊï∞ÊçÆÂ∫ì  
			if (Store.students.length > 0) {
				await syncStudentDatabaseToCloud(Store.students);
			}
			
			// ÂêåÊ≠•ÊàøÈó¥ÂÆûÊó∂Áä∂ÊÄÅ
			if (Store.rooms.length > 0) {
				await syncRoomStatusToCloud(Store.rooms);
			}
			
			// ÂêåÊ≠•ÁªÉ‰π†ËÆ∞ÂΩïÔºàÂ¶ÇÊûúÊúâÊú¨Âú∞ËÆ∞ÂΩïÔºâ
			await syncPracticeLogsToCloud();
			
			// Êõ¥Êñ∞‰∫ëÁ´ØÊï∞ÈáèÊòæÁ§∫
			const cloudRoomCountEl = document.getElementById('cloudRoomCount');
			const cloudStudentCountEl = document.getElementById('cloudStudentCount');
			if (cloudRoomCountEl) cloudRoomCountEl.textContent = Store.rooms.length;
			if (cloudStudentCountEl) cloudStudentCountEl.textContent = Store.students.length;
			
			// Êõ¥Êñ∞ÂêåÊ≠•Êó∂Èó¥
			updateCloudSyncInfo();
			
			toast('‚úÖ ÊâÄÊúâÊï∞ÊçÆÂ∑≤ÂêåÊ≠•Âà∞‰∫ëÁ´ØÔºàÂê´ÂÆûÊó∂Áä∂ÊÄÅ‰∏éÁªÉ‰π†ËÆ∞ÂΩïÔºâ');
			logInfo('ÊâãÂä®ÂêåÊ≠•ÂÆåÊàêÔºöÂü∫Á°ÄÊï∞ÊçÆ + ÂÆûÊó∂Áä∂ÊÄÅ + ÁªÉ‰π†ËÆ∞ÂΩï');
		} catch (error) {
			toast('ÂêåÊ≠•Â§±Ë¥•', 'error');
			logErr('ÊâãÂä®ÂêåÊ≠•Â§±Ë¥•:', error.message);
		}
	}

	// ÂêåÊ≠•ÊàøÈó¥ÂÆûÊó∂Áä∂ÊÄÅÂà∞ rooms Ë°®
	async function syncRoomStatusToCloud(rooms) {
		if (!supabaseReady) {
			logWarn('Supabase Êú™ËøûÊé•ÔºåË∑≥ËøáÊàøÈó¥Áä∂ÊÄÅÂêåÊ≠•');
			return;
		}
		
		try {
			const statusData = rooms.map(room => ({
				name: room.name,
				occupant_student_name: room.occupant || null,
				register_time: room.registerTime ? new Date(room.registerTime).toISOString() : null,
				heartbeat_at: new Date().toISOString(),
				version: room.version || 1,
				updated_at: new Date().toISOString()
			}));
			
			// ‰ΩøÁî® upsert ÊâπÈáèÊõ¥Êñ∞ÊàøÈó¥ÂÆûÊó∂Áä∂ÊÄÅ
			const { data, error } = await supabaseClient
				.from('rooms')
				.upsert(statusData, { 
					onConflict: 'name',
					ignoreDuplicates: false 
				});
			
			if (error) {
				logErr('ÂêåÊ≠•ÊàøÈó¥Áä∂ÊÄÅÂ§±Ë¥•:', error.message);
				toast('ÊàøÈó¥Áä∂ÊÄÅÂêåÊ≠•Â§±Ë¥•', 'error');
			} else {
				logInfo(`‚úÖ ÊàêÂäüÂêåÊ≠• ${statusData.length} ‰∏™ÊàøÈó¥Áä∂ÊÄÅÂà∞‰∫ëÁ´Ø`);
			}
		} catch (err) {
			logErr('ÊàøÈó¥Áä∂ÊÄÅÂêåÊ≠•ÂºÇÂ∏∏:', err.message);
		}
	}

	// ÂêåÊ≠•ÁªÉ‰π†ËÆ∞ÂΩïÂà∞ practice_logs Ë°®
	async function syncPracticeLogsToCloud() {
		if (!supabaseReady) {
			logWarn('Supabase Êú™ËøûÊé•ÔºåË∑≥ËøáÁªÉ‰π†ËÆ∞ÂΩïÂêåÊ≠•');
			return;
		}
		
		// Ê£ÄÊü•ÊòØÂê¶ÊúâÊú¨Âú∞ÁªÉ‰π†ËÆ∞ÂΩïÂ≠òÂÇ®
		if (!Store.localPracticeLogs || Store.localPracticeLogs.length === 0) {
			logInfo('Êó†Êú¨Âú∞ÁªÉ‰π†ËÆ∞ÂΩïÈúÄË¶ÅÂêåÊ≠•');
			return;
		}
		
		try {
			// ËøáÊª§Âá∫Â∞öÊú™ÂêåÊ≠•ÁöÑËÆ∞ÂΩï
			const unsyncedLogs = Store.localPracticeLogs.filter(log => !log.synced);
			
			if (unsyncedLogs.length === 0) {
				logInfo('ÊâÄÊúâÁªÉ‰π†ËÆ∞ÂΩïÂ∑≤ÂêåÊ≠•');
				return;
			}
			
			// ÊâπÈáèÊèíÂÖ•ÁªÉ‰π†ËÆ∞ÂΩï
			const { data, error } = await supabaseClient
				.from('practice_logs')
				.insert(unsyncedLogs);
			
			if (error) {
				logErr('ÂêåÊ≠•ÁªÉ‰π†ËÆ∞ÂΩïÂ§±Ë¥•:', error.message);
				toast('ÁªÉ‰π†ËÆ∞ÂΩïÂêåÊ≠•Â§±Ë¥•', 'error');
			} else {
				// Ê†áËÆ∞‰∏∫Â∑≤ÂêåÊ≠•
				unsyncedLogs.forEach(log => log.synced = true);
				logInfo(`‚úÖ ÊàêÂäüÂêåÊ≠• ${unsyncedLogs.length} Êù°ÁªÉ‰π†ËÆ∞ÂΩïÂà∞‰∫ëÁ´Ø`);
			}
		} catch (err) {
			logErr('ÁªÉ‰π†ËÆ∞ÂΩïÂêåÊ≠•ÂºÇÂ∏∏:', err.message);
		}
	}
	async function importJson(obj){
		if(Array.isArray(obj)){
			// ÁåúÊµãÊòØÊàøÈó¥Êï∞ÁªÑÊàñÂ≠¶ÁîüÊï∞ÁªÑ
			if(obj.length && obj[0].pianoType || obj[0].piano_type || obj[0].location){
				await mergeRooms(obj.map(canonicalizeRoom));
				toast('ÂØºÂÖ•ÊàøÈó¥ '+obj.length+' Êù°');
			}else if(obj.length && (obj[0].major || obj[0].grade || obj[0].name)){
				await mergeStudents(obj);
				toast('ÂØºÂÖ•Â≠¶Áîü '+obj.length+' Êù°');
			}else{
				toast('Êú™Áü•Êï∞ÁªÑÁªìÊûÑÔºåÂ∑≤ÂøΩÁï•');
			}
		} else if(obj && obj.rooms && obj.students){
			if(Array.isArray(obj.rooms)) await mergeRooms(obj.rooms.map(canonicalizeRoom));
			if(Array.isArray(obj.students)) await mergeStudents(obj.students);
			toast('ÂØºÂÖ•ÈõÜÂêàÂÆåÊàê');
		} else {
			toast('‰∏çÊîØÊåÅÁöÑ JSON ÁªìÊûÑ');
		}
		renderRooms(); updateUsageStats(); refreshStudentModalCache();
	}
	async function mergeRooms(list, skipCloudSync = false){
		let added=0, updated=0;
		const newRooms = [];
		
		list.forEach(r=>{ 
			if(!r||!r.name) return; 
			// Áªü‰∏ÄËßÑËåÉÂπ∂Á°Æ‰øù version Êï∞Â≠ó
			if(r.version==null || isNaN(r.version)) r.version=0; 
			const norm = canonicalizeRoom(r);
			let existing=Store.rooms.find(x=>x.name===norm.name); 
			if(existing){ 
				Object.assign(existing,norm); 
				updated++; 
			} else { 
				Store.rooms.push(norm); 
				newRooms.push(norm);
				added++; 
			}
		});
		
		rebuildIndexes();
		// Â¶ÇÊûúÂΩìÂâçÊ•ºÂ±ÇËøáÊª§Â∑≤‰∏çÂú®ÈõÜÂêà‰∏≠ÂàôÈáçÁΩÆ
		if(Store.filters.floor!=='ALL' && !Store.floorSet.has(Store.filters.floor)) { Store.filters.floor='ALL'; }
		// Ëã•ÂΩìÂâçËøáÊª§ÂØºËá¥Êó†ÁªìÊûúÂàôÂ∞ùËØïËá™Âä®ÂõûÈÄÄ
		const visible=Store.rooms.filter(roomFilter).length;
		if(!visible){ Store.filters.floor='ALL'; Store.filters.type='ALL'; }
		logInfo(`ÂêàÂπ∂ÊàøÈó¥: Êñ∞Â¢û ${added} Êõ¥Êñ∞ ${updated} ÊÄªÊï∞ ${Store.rooms.length}`);
		
		// Ëá™Âä®ÂêåÊ≠•Âà∞‰∫ëÁ´ØÊï∞ÊçÆÂ∫ìÔºàÈô§ÈùûË∑≥ËøáÔºâ
		if (!skipCloudSync && list.length > 0) {
			await syncRoomDatabaseToCloud(list);
		}
	}
	
	async function mergeStudents(list, skipCloudSync = false){
		const newStudents = [];
		
		list.forEach(s=>{ 
			if(!s||!s.name) return; 
			let ex=Store.students.find(x=>x.name===s.name); 
			if(ex){ 
				Object.assign(ex,s); 
			} else { 
				Store.students.push(s);
				newStudents.push(s);
			} 
		});
		
		rebuildStudentIndex();
		
		// Ëá™Âä®ÂêåÊ≠•Âà∞‰∫ëÁ´ØÊï∞ÊçÆÂ∫ìÔºàÈô§ÈùûË∑≥ËøáÔºâ
		if (!skipCloudSync && list.length > 0) {
			await syncStudentDatabaseToCloud(list);
		}
	}
	function exportRooms(){
		downloadJson(Store.rooms,'rooms_export.json');
	}
	function exportStudents(){ downloadJson(Store.students,'students_export.json'); }
	function downloadJson(data, file){ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=file; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }

	// Êñ∞Â¢û: ÈÄöÁî® CSV Ëß£ÊûêÔºàÊîØÊåÅÂºïÂè∑„ÄÅËΩ¨‰πâÂèåÂºïÂè∑„ÄÅBOM„ÄÅCRLFÔºâ
	function parseCSV(raw){
		if(!raw) return {header:[], rows:[]};
		// ÂéªÈô§ BOM
		if(raw.charCodeAt(0)===0xFEFF) raw=raw.slice(1);
		raw = raw.replace(/\r\n?/g,'\n');
		const rows=[]; let cur=[]; let field=''; let inQuotes=false; let i=0;
		function pushField(){ cur.push(field); field=''; }
		function pushRow(){ rows.push(cur); cur=[]; }
		while(i<raw.length){ const ch=raw[i];
			if(inQuotes){
				if(ch==='"'){
					if(raw[i+1]==='"'){ field+='"'; i++; }
					else { inQuotes=false; }
				}else{ field+=ch; }
			}else{
				if(ch==='"'){ inQuotes=true; }
				else if(ch===','){ pushField(); }
				else if(ch==='\n'){ pushField(); pushRow(); }
				else { field+=ch; }
			}
			i++;
		}
		if(field.length>0 || cur.length>0){ pushField(); pushRow(); }
		if(!rows.length) return {header:[], rows:[]};
		const header = rows.shift().map(h=>h.trim());
		return { header, rows: rows.filter(r=> r.some(c=>c.trim()!=='')) };
	}
	function normalizeHeaderKey(k){ return k.replace(/\s+/g,'').replace(/[ _-]/g,'').toLowerCase(); }
	function detectCSVType(header){
		const keys = header.map(normalizeHeaderKey);
		const roomHits = ['ÂêçÁß∞','‰ΩçÁΩÆ','Á±ªÂûã','Â§áÊ≥®'].map(normalizeHeaderKey).every(h=>keys.includes(h));
		const studentHits = (keys.includes('ÂßìÂêç')||keys.includes('name')) && keys.includes('‰∏ì‰∏ö');
		if(roomHits) return 'rooms'; if(studentHits) return 'students'; return 'unknown';
	}
	async function importCsvRooms(header, rows){
		const idx = Object.create(null); header.forEach((h,i)=>{ idx[normalizeHeaderKey(h)]=i; });
		const out=[]; rows.forEach(r=>{
			const name=r[idx['ÂêçÁß∞']??idx['mingcheng']??idx['name']]; if(!name) return;
			const location=r[idx['‰ΩçÁΩÆ']]; const pianoType=r[idx['Á±ªÂûã']]||'Êó†Èí¢Áê¥'; const remark=r[idx['Â§áÊ≥®']]||'';
			out.push({ name: name.trim(), location: (location||'').trim(), pianoType: pianoType.trim(), remark: remark.trim() });
		});
		await mergeRooms(out.map(o=>({name:o.name, location:o.location, pianoType:o.pianoType, remark:o.remark})));
		toast('CSV ÂØºÂÖ•Áê¥Êàø '+out.length+' Êù°');
		renderRooms(); updateUsageStats();
	}
	async function importCsvStudents(header, rows){
		const idx = Object.create(null); header.forEach((h,i)=>{ idx[normalizeHeaderKey(h)]=i; });
		const out=[]; rows.forEach(r=>{
			const name=r[idx['ÂßìÂêç']??idx['name']]; if(!name) return;
			const major=r[idx['‰∏ì‰∏ö']??idx['major']]||''; const grade=r[idx['Âπ¥Á∫ß']??idx['grade']]||''; const idRaw=r[idx['id']]||r[idx['ÁºñÂè∑']]||'';
			out.push({ id: idRaw||undefined, name: name.trim(), major: major.trim(), grade: grade.trim() });
		});
		await mergeStudents(out);
		toast('CSV ÂØºÂÖ•Â≠¶Áîü '+out.length+' Êù°');
	}

	// ÁªëÂÆöÈ°∂ÈÉ®ÊåâÈíÆ
	function bind(id, handler){
		const el = document.getElementById(id);
		if(el){ el.onclick = handler; }
		else { /* ‰ªÖË∞ÉËØïËæìÂá∫Ôºå‰∏çÊäõÈîôÈòªÊñ≠ÂàùÂßãÂåñ */ console.warn('[WARN] ÊåâÈíÆÁº∫Â§±:', id); }
	}
	// Â∑≤ÁßªÈô§ÂØºÂÖ•Áê¥ÊàøÊåâÈíÆÔºàÈ°∂Ê†è‰∏éÈù¢ÊùøÂÜÖÔºâÔºå‰øùÁïôÂ≠¶ÁîüÂØºÂÖ•
	bind('btnImportStudents', ()=>{ document.getElementById('hiddenFileImport')?.click(); });
	bind('btnSyncToCloud', manualSyncToCloud);
	bind('btnReconnect', async function(){
		logInfo('Áî®Êà∑ÊâãÂä®ÈáçËøû');
		supabaseReady = false;
		await initSupabase();
		if (supabaseReady) {
			await setupRealtime();
			await fetchRoomMeta();
			await fetchStudents();
			updateCloudSyncInfo();
		}
	});
	bind('btnRefresh', ()=>bootstrap());
	bind('btnEditRooms', toggleEditMode);
	
	// ÁºñËæëÊ®°ÂºèÂàáÊç¢
	function toggleEditMode() {
		Store.editMode = !Store.editMode;
		const btn = document.getElementById('btnEditRooms');
		if (Store.editMode) {
			btn.textContent = '‰øùÂ≠ò';
			btn.classList.add('active');
		} else {
			btn.textContent = 'ÁºñËæë';
			btn.classList.remove('active');
			// ‰øùÂ≠òÊ®°ÂºèÔºöÂêåÊ≠•ÊâÄÊúâ‰øÆÊîπÂà∞‰∫ëÁ´Ø
			saveAllRoomChanges();
		}
		renderRooms();
		ensureFilters();
	}
	
	// ‰øùÂ≠òÊâÄÊúâÊàøÈó¥‰øÆÊîπ
	async function saveAllRoomChanges() {
		try {
			toast('Ê≠£Âú®‰øùÂ≠ò‰øÆÊîπ...', 'info');
			// ÂêåÊ≠•Âà∞‰∫ëÁ´Ø
			if (Store.rooms.length > 0) {
				await syncRoomDatabaseToCloud(Store.rooms);
			}
			toast('‚úÖ ÊâÄÊúâ‰øÆÊîπÂ∑≤‰øùÂ≠òÂà∞‰∫ëÁ´Ø');
		} catch (error) {
			toast('‰øùÂ≠òÂ§±Ë¥•', 'error');
			logErr('‰øùÂ≠òÊàøÈó¥‰øÆÊîπÂ§±Ë¥•:', error.message);
		}
	}
	
	// Âà†Èô§Áê¥Êàø
	async function deleteRoom(roomName) {
		try {
			const room = Store.byName.get(roomName);
			if (!room) {
				toast('ÊàøÈó¥‰∏çÂ≠òÂú®', 'warn');
				return;
			}
			
			// ËÆæÁΩÆÂà†Èô§Êìç‰ΩúÈîÅÔºåÈò≤Ê≠¢ÂÆûÊó∂Êõ¥Êñ∞Âπ≤Êâ∞
			const deleteLockKey = `delete_${roomName}`;
			if (!Store.operationLocks) Store.operationLocks = new Set();
			Store.operationLocks.add(deleteLockKey);
			
			try {
				// Â¶ÇÊûúÊàøÈó¥ÊúâÂç†Áî®ËÄÖÔºåÂÖàÊ∏ÖÁ©∫
				if (room.occupant) {
					toast('ÊàøÈó¥ÊúâÂç†Áî®ËÄÖÔºåÂ∞ÜÂÖàÊ∏ÖÁ©∫...', 'info');
					await clearRoom(roomName);
				}
				
				// ‰ªéÊú¨Âú∞Êï∞ÊçÆ‰∏≠ÁßªÈô§
				const index = Store.rooms.findIndex(r => r.name === roomName);
				if (index !== -1) {
					Store.rooms.splice(index, 1);
					Store.byName.delete(roomName);
				}
				
				// Ê∏ÖÁêÜÊâÄÊúâÁõ∏ÂÖ≥Áä∂ÊÄÅ
				cleanupRoomState(roomName);
				
				// ‰ªé‰∫ëÁ´ØÂà†Èô§
				if (!Store.settings.offlineMode) {
					await supabaseClient.from('room_database').delete().eq('name', roomName);
					await supabaseClient.from('rooms').delete().eq('name', roomName);
				}
				
				// ÈáçÊñ∞Ê∏≤Êüì
				rebuildIndexes(); // ÈáçÂª∫Á¥¢ÂºïÔºåÊõ¥Êñ∞Ê•ºÂ±ÇÈõÜÂêà
				renderRooms();
				ensureFilters();
				
				toast(`‚úÖ Â∑≤Âà†Èô§Áê¥ÊàøÔºö${roomName}`);
				logInfo(`Âà†Èô§Áê¥ÊàøÔºö${roomName}`);
			} finally {
				// Âª∂ËøüÊ∏ÖÈô§Âà†Èô§ÈîÅÔºåÁ°Æ‰øùÂÆûÊó∂Êõ¥Êñ∞‰∏ç‰ºöÂú®Âà†Èô§ËøáÁ®ã‰∏≠Âπ≤Êâ∞
				setTimeout(() => {
					Store.operationLocks.delete(deleteLockKey);
				}, 2000);
			}
		} catch (error) {
			toast('Âà†Èô§Â§±Ë¥•', 'error');
			logErr('Âà†Èô§Áê¥ÊàøÂ§±Ë¥•:', error.message);
		}
	}
	
	// ÁªëÂÆöÂÜÖËÅîÁºñËæë‰∫ã‰ª∂
	function bindInlineEditEvents() {
		const grid = document.getElementById('roomGrid');
		
		// ÁõëÂê¨ÂèØÁºñËæëÂÖÉÁ¥†ÁöÑËæìÂÖ•‰∫ã‰ª∂
		grid.addEventListener('blur', e => {
			if (!e.target.hasAttribute('contenteditable')) return;
			saveInlineEdit(e.target);
		}, true);
		
		// ÁõëÂê¨ÂõûËΩ¶ÈîÆ‰øùÂ≠ò
		grid.addEventListener('keydown', e => {
			if (!e.target.hasAttribute('contenteditable')) return;
			if (e.key === 'Enter') {
				e.preventDefault();
				e.target.blur(); // Ëß¶Âèëblur‰∫ã‰ª∂‰øùÂ≠ò
			}
		});
		
		// ÁõëÂê¨Áê¥ÊàøÁ±ªÂûãÈÄâÊã©Âô®ÂèòÂåñ
		grid.addEventListener('change', e => {
			if (!e.target.classList.contains('piano-type-selector')) return;
			savePianoTypeChange(e.target);
		});
		
		// ‰∏∫Á©∫ÁöÑÂ§áÊ≥®Êèê‰æõÂç†‰ΩçÊèêÁ§∫ÔºåÊàøÈó¥ÂêçÁß∞Ëé∑ÂæóÁÑ¶ÁÇπÊó∂‰øùÊåÅÁ∫ØÊñáÊú¨
		grid.addEventListener('focus', e => {
			if (!e.target.hasAttribute('contenteditable')) return;
			
			if (e.target.dataset.field === 'remark' && e.target.textContent === 'ÁÇπÂáªÊ∑ªÂä†Â§áÊ≥®...') {
				e.target.textContent = '';
			} else if (e.target.dataset.field === 'name') {
				// ÊàøÈó¥ÂêçÁß∞Ëé∑ÂæóÁÑ¶ÁÇπÊó∂ÔºåÁßªÈô§ÂèØËÉΩÁöÑHTMLÊ†áÁ≠æÔºåÂè™‰øùÁïôÁ∫ØÊñáÊú¨ÂêçÁß∞
				const card = e.target.closest('.room-card');
				if (card) {
					const roomName = card.dataset.room;
					e.target.textContent = roomName;
				}
			}
		}, true);
	}
	
	// ‰øùÂ≠òÁê¥ÊàøÁ±ªÂûãÂèòÂåñ
	function savePianoTypeChange(selectElement) {
		const roomName = selectElement.dataset.room;
		const newType = selectElement.value;
		
		const room = Store.byName.get(roomName);
		if (!room) return;
		
		// Êò†Â∞ÑÈÄâÊã©Âô®ÂÄºÂà∞Êï∞ÊçÆÂ∫ìÊ†ºÂºè
		let pianoType = '';
		switch(newType) {
			case '‰∏âËßí':
				pianoType = '‰∏âËßíÈí¢Áê¥';
				break;
			case 'Á´ãÂºè':
				pianoType = 'Á´ãÂºèÈí¢Áê¥';
				break;
			case 'ÂÖ∂‰ªñ':
			default:
				pianoType = 'ÂÖ∂‰ªñ';
				break;
		}
		
		// Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
		room.pianoType = pianoType;
		
		// Êõ¥Êñ∞Âç°ÁâáÁöÑ data-grand Â±ûÊÄß
		const card = selectElement.closest('.room-card');
		if (card) {
			const isGrand = /‰∏âËßí/.test(pianoType);
			card.dataset.grand = isGrand ? '1' : '0';
		}
		
		logInfo(`Êõ¥Êñ∞ÊàøÈó¥Á±ªÂûãÔºö${roomName} -> ${pianoType}`);
		
		// ÈáçÊñ∞Ê∏≤ÊüìÂç°Áâá‰ª•Êõ¥Êñ∞ËøáÊª§Áä∂ÊÄÅ
		setTimeout(() => {
			renderRoomCard(roomName);
		}, 0);
	}
	
	// ‰øùÂ≠òÂÜÖËÅîÁºñËæë
	function saveInlineEdit(element) {
		const card = element.closest('.room-card');
		if (!card) return;
		
		const roomName = card.dataset.room;
		const field = element.dataset.field;
		const value = element.textContent.trim();
		
		const room = Store.byName.get(roomName);
		if (!room) return;
		
		// Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
		if (field === 'name') {
			// ÊàøÈó¥ÂêçÁß∞‰øÆÊîπÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
			if (value && value !== room.name) {
				if (Store.byName.has(value)) {
					toast('ÊàøÈó¥ÂêçÁß∞Â∑≤Â≠òÂú®', 'warn');
					element.textContent = room.name; // ÊÅ¢Â§çÂéüÂÄº
					return;
				}
				
				// Êõ¥Êñ∞Á¥¢Âºï
				Store.byName.delete(room.name);
				room.name = value;
				Store.byName.set(value, room);
				card.dataset.room = value;
				
				logInfo(`ÊàøÈó¥ÈáçÂëΩÂêçÔºö${roomName} -> ${value}`);
				
				// ÈáçÊñ∞Ê∏≤ÊüìËøô‰∏™Âç°Áâá‰ª•ÊòæÁ§∫Ê≠£Á°ÆÁöÑÊ†áÁ≠æ
				setTimeout(() => {
					renderRoomCard(value);
				}, 0);
			}
		} else if (field === 'remark') {
			room.remark = value || '';
			logInfo(`Êõ¥Êñ∞ÊàøÈó¥Â§áÊ≥®Ôºö${roomName} -> ${value}`);
			
			// ÊÅ¢Â§çÂç†‰ΩçÊñáÂ≠ó
			if (!value) {
				element.textContent = 'ÁÇπÂáªÊ∑ªÂä†Â§áÊ≥®...';
			}
		}
	}
	
	// Â∑≤ÁßªÈô§ÁöÑÊåâÈíÆÔºà‰∏ªÈ¢ò / ÈáçÁΩÆËøáÊª§ / ÁªüËÆ°Ôºâ‰∏çÂÜçÁ°¨ÁªëÂÆöÔºåÈÅøÂÖçÂõ†‰∏çÂ≠òÂú®ÂØºËá¥ËÑöÊú¨ÂÅúÊ≠¢
	// Â¶ÇÊûú‰ªçÈúÄÈáçÁΩÆËøáÊª§ÔºåÂèØÂú®ÂÖ∂ÂÆÉÂÖ•Âè£Ë∞ÉÁî®ËØ•ÂáΩÊï∞
	function resetFilters(){ Store.filters.floor='ALL'; Store.filters.type='ALL'; renderRooms(); }
	// Â∑≤ÁßªÈô§‰æßÊ†èÂø´ÈÄüÂØºÂÖ•/ÂØºÂá∫Âå∫ÂùóÔºå‰ª•‰∏ãÈÄªËæëÁÆÄÂåñÔºöÊèê‰æõ‰∏Ä‰∏™ÈöêËóè input Â§çÁî®
	let hiddenInput=document.getElementById('hiddenFileImport');
	if(!hiddenInput){ hiddenInput=document.createElement('input'); hiddenInput.type='file'; hiddenInput.id='hiddenFileImport'; hiddenInput.accept='.json,.csv'; hiddenInput.style.display='none'; document.body.appendChild(hiddenInput); }
	hiddenInput.addEventListener('change', e=>{ 
		const f=e.target.files[0]; if(!f) return; const name=f.name.toLowerCase(); const reader=new FileReader(); 
		reader.onload = async () => {
			try{
				const text=reader.result;
				if(name.endsWith('.csv')){
					const {header, rows}=parseCSV(text);
					if(!header.length){ toast('Á©∫ CSV'); return; }
					const type=detectCSVType(header);
					
					if(type==='rooms') {
						toast('Ê≠£Âú®ÂØºÂÖ•Áê¥ÊàøÊï∞ÊçÆ...', 'info');
						await importCsvRooms(header, rows);
					} else if(type==='students') {
						toast('Ê≠£Âú®ÂØºÂÖ•Â≠¶ÁîüÊï∞ÊçÆ...', 'info');
						await importCsvStudents(header, rows);
					} else {
						toast('Êó†Ê≥ïËØÜÂà´ÁöÑ CSV Ë°®Â§¥');
					}
				} else { 
					await importJson(JSON.parse(text)); 
				}
			}catch(err){ 
				toast('Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•'); 
				logErr('Ëß£ÊûêÂ§±Ë¥•', err.message); 
			}
		}; 
		reader.readAsText(f,'utf-8'); 
		e.target.value=''; 
	});

	window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeStudentModal(); }});

	/*************************************************
	 * Ê∏≤Êüì & ËøáÊª§
	 *************************************************/
	function rebuildIndexes(){
		Store.byName.clear(); Store.floorSet.clear();
		Store.rooms.forEach(r=>{ Store.byName.set(r.name,r); const floor=deriveFloor(r.location); if(floor) Store.floorSet.add(floor); });
	}
	function rebuildStudentIndex(){ Store.studentIndex.clear(); Store.students.forEach(s=>Store.studentIndex.set(s.name,s)); }
	function deriveFloor(location){ if(!location) return 'Êú™Áü•'; const m=location.match(/[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πù0-9]+/); if(!m) return location; const map={‰∏Ä:1,‰∫å:2,‰∏â:3,Âõõ:4,‰∫î:5,ÂÖ≠:6,‰∏É:7,ÂÖ´:8,‰πù:9}; const raw=m[0]; return String(map[raw]||raw); }
	function ensureFilters(){
		const floorWrap=document.getElementById('floorFilters');
		const typeWrap=document.getElementById('typeFilters');
		
		// Ëé∑ÂèñÂΩìÂâçËøáÊª§Êù°‰ª∂‰∏ãÊúâÊàøÈó¥ÁöÑÊ•ºÂ±Ç
		const currentTypeFilter = Store.filters.type;
		const availableRooms = Store.rooms.filter(r => {
			// Â∫îÁî®Á±ªÂûãËøáÊª§Âô®ÔºåÊ£ÄÊü•Âì™‰∫õÊàøÈó¥Âú®ÂΩìÂâçÁ±ªÂûãËøáÊª§‰∏ãÂèØËßÅ
			if (currentTypeFilter === 'ALL') return true;
			const isGrand = /‰∏âËßí/.test(r.pianoType);
			if (currentTypeFilter === 'GRAND') return isGrand;
			if (currentTypeFilter === 'UPRIGHT') return !isGrand && !/Êó†|ÁîµÂ≠ê/i.test(r.pianoType);
			if (currentTypeFilter === 'NONE') return !isGrand && !/Á´ã|upright|‰∏âËßí/.test(r.pianoType);
			return true;
		});
		
		// ÊûÑÂª∫ÂΩìÂâçÂèØËßÅÊàøÈó¥ÁöÑÊ•ºÂ±ÇÈõÜÂêà
		const activeFloorSet = new Set();
		availableRooms.forEach(r => {
			const floor = deriveFloor(r.location);
			if (floor) activeFloorSet.add(floor);
		});
		
		const floors=['ALL',...Array.from(activeFloorSet).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN',{numeric:true}))];
		logInfo(`Ê•ºÂ±ÇËøáÊª§Âô®Êõ¥Êñ∞: ÊòæÁ§∫ ${floors.length-1} ‰∏™ÊúâÊàøÈó¥ÁöÑÊ•ºÂ±Ç`);
		
		// Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ•ºÂ±ÇÂú®Êñ∞ÁöÑÊ•ºÂ±ÇÂàóË°®‰∏≠‰∏çÂ≠òÂú®ÔºåÈáçÁΩÆ‰∏∫ALL
		if (Store.filters.floor !== 'ALL' && !activeFloorSet.has(Store.filters.floor)) {
			logInfo(`ÂΩìÂâçÊ•ºÂ±Ç ${Store.filters.floor} Êó†ÊàøÈó¥ÔºåÈáçÁΩÆ‰∏∫ÂÖ®ÈÉ®`);
			Store.filters.floor = 'ALL';
		}
		let floorHTML = floors.map(f=>`<button data-floor="${f}" data-active="${Store.filters.floor===f?1:0}">${f==='ALL'?'ÂÖ®ÈÉ®Ê•ºÂ±Ç':f+'Ê•º'}</button>`).join('');
		
		// ÁºñËæëÊ®°Âºè‰∏ãÊ∑ªÂä†Êñ∞Â¢ûÊàøÈó¥ÊåâÈíÆ
		if (Store.editMode) {
			floorHTML += `<button id="btnAddRoom" class="add-room-btn" title="Êñ∞Â¢ûÁê¥Êàø">üéπ Êñ∞Â¢ûÁê¥Êàø</button>`;
		}
		
		floorWrap.innerHTML = floorHTML;
		typeWrap.innerHTML = ['ALL','GRAND','UPRIGHT','NONE'].map(t=>`<button data-type="${t}" data-active="${Store.filters.type===t?1:0}">${labelType(t)}</button>`).join('');
		
		floorWrap.querySelectorAll('button').forEach(b=>{
			if(b.dataset.floor) {
				b.onclick=()=>{Store.filters.floor=b.dataset.floor; renderRooms();};
			}
		});
		typeWrap.querySelectorAll('button').forEach(b=>b.onclick=()=>{Store.filters.type=b.dataset.type; renderRooms();});
		
		// ÁªëÂÆöÊñ∞Â¢ûÊàøÈó¥ÊåâÈíÆ
		if (Store.editMode) {
			bind('btnAddRoom', showAddRoomModal);
		}
	}
	function labelType(t){ if(t==='ALL') return 'ÂÖ®ÈÉ®Á±ªÂûã'; if(t==='GRAND') return '‰∏âËßí'; if(t==='UPRIGHT') return 'Á´ãÂºè'; return 'ÂÖ∂ÂÆÉ'; }
	function roomFilter(r){
		const floor=deriveFloor(r.location);
		if(Store.filters.floor!=='ALL' && floor!==Store.filters.floor) return false;
		const isGrand = /‰∏âËßí/.test(r.pianoType);
		if(Store.filters.type==='GRAND' && !isGrand) return false;
		if(Store.filters.type==='UPRIGHT' && (isGrand || /Êó†|ÁîµÂ≠ê/i.test(r.pianoType))) return false;
		if(Store.filters.type==='NONE' && (isGrand || /Á´ã|upright|‰∏âËßí/.test(r.pianoType))) return false;
		return true;
	}
	function renderRooms(){
		ensureFilters();
		const grid=document.getElementById('roomGrid');
		// Ëá™ÂÆö‰πâÊéíÂ∫èÔºöÂÖàÊåâÁê¥ÊàøÁ±ªÂûã(‰∏âËßí > Á´ãÂºè > ÂÖ∂ÂÆÉ)ÔºåÂÜçÊåâÂêçÁß∞‰∏≠ÁöÑÊï∞Â≠ó / Ëá™ÁÑ∂Â∫è
		const typeRank = r => {
			if(/‰∏âËßí/.test(r.pianoType)) return 0; // GRAND
			if(/Á´ãÂºè|upright/i.test(r.pianoType)) return 1; // UPRIGHT
			return 2; // OTHER
		};
		const extractNum = name => {
			const m = name.match(/(\d+)/);
			return m? parseInt(m[1],10) : Infinity;
		};
		const list=Store.rooms
			.filter(roomFilter)
			.slice() // Èò≤Ê≠¢ÂéüÊï∞ÁªÑË¢´ÊÑèÂ§ñÊéíÂ∫è
			.sort((a,b)=>{
				const ta=typeRank(a), tb=typeRank(b);
				if(ta!==tb) return ta-tb;
				// ÂêåÁ±ªÂûãÔºöÂ∞ùËØïÊï∞Â≠ó‰ºòÂÖàÔºåÂÜçËá™ÁÑ∂ÊØîËæÉ
				const na=extractNum(a.name), nb=extractNum(b.name);
				if(na!==nb) return na-nb;
				return a.name.localeCompare(b.name,'zh-Hans-CN',{numeric:true});
			});
		logInfo(`Â∑≤ÊåâÁ±ªÂûã‰∏éÊï∞Â≠óÊéíÂ∫è: total ${list.length}`);
		// ÊûÑÂª∫Â∏¶ÂàÜÈöîÁ∫øÁöÑHTML
		let htmlParts=[];
		let lastType=-1;
		const typeLabelMap={0:'‰∏âËßíÈí¢Áê¥',1:'Á´ãÂºèÈí¢Áê¥',2:'ÂÖ∂‰ªñÁ±ªÂûã'};
		const typeClassMap={0:'grand',1:'upright',2:'other'};
		for(const r of list){
			const t=typeRank(r);
			if(t!==lastType){
				if(lastType!==-1) htmlParts.push(''); // ÂàÜÁªÑËá™ÁÑ∂Êç¢Ë°å
				// Â¶ÇÊûúËøáÊª§ÂêéÂè™Êúâ‰∏ÄÁßçÁ±ªÂûãÂàô‰∏çÊòæÁ§∫ÂàÜÈöîÁ∫øÔºöÂª∂ÂêéÂà§Êñ≠
				htmlParts.push(`<div class="room-type-separator ${typeClassMap[t]}" data-type-sep="${t}"><div class="line"></div><div class="label">${typeLabelMap[t]}</div><div class="line"></div></div>`);
				lastType=t;
			}
			htmlParts.push(roomCardHTML(r));
		}
		// Â¶ÇÊûúÊúÄÁªàÂè™Êúâ‰∏Ä‰∏™ÂàÜÈöîÁ∫ø‰∏îÂÖ∂ÂêéÂè™ÊúâÊàøÈó¥Ôºå‰∏îÊ≤°ÊúâÂá∫Áé∞Á¨¨‰∫åÁßçÁ±ªÂûãÔºåÂàôÁßªÈô§ËØ•ÂàÜÈöîÁ∫øÔºàÂçï‰∏ÄÁ±ªÂûã‰∏çÈúÄË¶ÅÔºâ
		const sepCount=htmlParts.filter(h=>/room-type-separator/.test(h)).length;
		if(sepCount===1){
			htmlParts=htmlParts.filter(h=>!/room-type-separator/.test(h));
		}
		grid.innerHTML=htmlParts.join('');
		
		// Ê∑ªÂä†ÂÜÖËÅîÁºñËæë‰∫ã‰ª∂ÁõëÂê¨
		if (Store.editMode) {
			bindInlineEditEvents();
		}
	}
	function renderRoomCard(name){ 
		const r=Store.byName.get(name); 
		const grid=document.getElementById('roomGrid'); 
		const el=grid.querySelector(`[data-room='${CSS.escape(name)}']`); 
		
		if(!r) {
			// ÊàøÈó¥Êï∞ÊçÆ‰∏çÂ≠òÂú®ÔºåÁßªÈô§DOMÂÖÉÁ¥†
			if(el) {
				logInfo(`ÁßªÈô§Â∑≤Âà†Èô§ÊàøÈó¥ÁöÑÂç°Áâá: ${name}`);
				el.remove();
			}
			return; 
		}
		
		if(!roomFilter(r)) {
			// ÊàøÈó¥Ë¢´ËøáÊª§ÔºåÁßªÈô§DOMÂÖÉÁ¥†
			if(el) {
				el.remove();
			}
			return; 
		}
		
		// Èò≤ÈáçÂ§çÊ∏≤ÊüìÔºöÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÈáçÊñ∞Ê∏≤Êüì
		const currentHTML = el ? el.outerHTML : '';
		const newHTML = roomCardHTML(r);
		
		if (currentHTML === newHTML) {
			logInfo(`Ë∑≥ËøáÈáçÂ§çÊ∏≤Êüì: ${name} (ÂÜÖÂÆπÊú™ÂèòÂåñ)`);
			return;
		}
		
		logInfo(`ÈáçÊñ∞Ê∏≤ÊüìÊàøÈó¥Âç°Áâá: ${name}, occupant: ${r.occupant || 'null'}, version: ${r.version || 'unknown'}`);
		
		if(el){ 
			el.outerHTML=newHTML; 
		} else { 
			renderRooms(); 
		} 
		
		// Âº∫Âà∂ÈáçÊñ∞Â∫îÁî®Áä∂ÊÄÅ + ÂπÇÁ≠âÊ†°È™å
		setTimeout(() => {
			const newEl = grid.querySelector(`[data-room='${CSS.escape(name)}']`);
			if (newEl && r) {
				const st = statusInfo(r);
				newEl.dataset.status = st.state;
				const chip = newEl.querySelector('.chip');
				if (chip) {
					chip.textContent = st.chip;
					chip.className = `chip ${st.class}`;
				}
				// ÂπÇÁ≠âÊ†°È™åÔºöoccupant ‰∏∫Á©∫Êó∂Ê∏ÖÁêÜÊÆãÁïô
				if(!r.occupant){
					const occLine = newEl.querySelector('.occupant-line');
					if(occLine) occLine.remove();
					const actions = newEl.querySelector('.actions');
					if(actions){
						const strayClear = actions.querySelector('[data-act="clear"]');
						if(strayClear){
							actions.innerHTML = '';
							logInfo(`[RECONCILE] Ê∏ÖÁêÜÊÆãÁïôÊìç‰ΩúÊåâÈíÆ ${name}`);
						}
					}
					newEl.classList.remove('pending-operation');
				}
			}
		}, 10);
	}

	// === ÂÆåÊï¥ÈáçÊ∏≤ÊüìËæÖÂä©ÂáΩÊï∞ ===
	function fullReRenderRoom(room){
		const grid=document.getElementById('roomGrid');
		if(!grid) return;
		const old = grid.querySelector(`[data-room='${CSS.escape(room.name)}']`);
		if(old) old.remove();
		// Ë∞ÉÁî®Ê†áÂáÜÊ∏≤Êüì
		renderRoomCard(room.name);
	}
	function statusInfo(r){ if(!r.occupant) return {state:'empty',chip:'Á©∫Èó≤',class:'good'}; if(!r.registerTime) return {state:'occupied',chip:'Âç†Áî®',class:'accent'}; const now=Date.now(); const prepEnd=r.registerTime+60000; if(now<prepEnd) return {state:'preparing',chip:'ÂáÜÂ§á‰∏≠',class:'preparing'}; const used=Math.floor((now-prepEnd)/1000); const limit = (Store.settings.basePracticeDuration||120)*60; if(used<=limit) return {state:'occupied',chip:formatHMS(used),class:'accent'}; return {state:'overtime',chip:'Ë∂ÖÊó∂ '+formatDuration(used-limit),class:'danger'}; }
	function roomCardHTML(r){ 
		const st=statusInfo(r); 
		const isGrand=/‰∏âËßí/.test(r.pianoType);
		const isUpright=/Á´ãÂºè/.test(r.pianoType);
		const editModeClass = Store.editMode ? 'edit-mode' : '';
		const deleteBtn = Store.editMode ? `<div class="delete-btn" data-room="${r.name}" title="Âà†Èô§Áê¥Êàø">‚úï</div>` : '';
		
		// Á°ÆÂÆöÁê¥ÊàøÁ±ªÂûãÊ†áÁ≠æ
		let typePill = '';
		if (!Store.editMode) {
			if (isGrand) {
				typePill = '<span class="pill pill-grand">‰∏âËßí</span>';
			} else if (isUpright) {
				typePill = '<span class="pill pill-upright">Á´ãÂºè</span>';
			} else {
				typePill = '<span class="pill pill-other">ÂÖ∂‰ªñ</span>';
			}
		}
		
		// Â§ÑÁêÜÂèØÁºñËæëÂå∫ÂüüÁöÑÊòæÁ§∫ÂÜÖÂÆπ
		const roomNameContent = Store.editMode ? r.name : `${r.name} ${typePill}`;
		const remarkContent = Store.editMode ? 
			(r.remark ? escapeHtml(r.remark) : 'ÁÇπÂáªÊ∑ªÂä†Â§áÊ≥®...') : 
			(r.remark ? escapeHtml(r.remark) : '');
		
		// ÁºñËæëÊ®°Âºè‰∏ãÁöÑÁê¥ÊàøÁ±ªÂûãÈÄâÊã©Âô®
		let pianoTypeSelector = '';
		if (Store.editMode) {
			// Êò†Â∞ÑÈí¢Áê¥Á±ªÂûãÂà∞ÈÄâÊã©Âô®ÈÄâÈ°π
			const currentType = r.pianoType || 'ÂÖ∂‰ªñ';
			let selectedType = 'ÂÖ∂‰ªñ'; // ÈªòËÆ§ÈÄâÊã©
			if (/‰∏âËßí/.test(currentType)) {
				selectedType = '‰∏âËßí';
			} else if (/Á´ãÂºè/.test(currentType)) {
				selectedType = 'Á´ãÂºè';
			}
			
			pianoTypeSelector = `<select class="piano-type-selector" data-room="${r.name}">
				<option value="Á´ãÂºè" ${selectedType === 'Á´ãÂºè' ? 'selected' : ''}>Á´ãÂºè</option>
				<option value="‰∏âËßí" ${selectedType === '‰∏âËßí' ? 'selected' : ''}>‰∏âËßí</option>
				<option value="ÂÖ∂‰ªñ" ${selectedType === 'ÂÖ∂‰ªñ' ? 'selected' : ''}>ÂÖ∂‰ªñ</option>
			</select>`;
		}
		
		return `<div class="room-card ${!r.occupant?'empty':''} ${editModeClass}" data-room="${r.name}" data-grand="${isGrand?1:0}" data-status="${st.state}" tabindex="0" title="${r.name}\n${r.location||''}\n${r.pianoType}">
			${deleteBtn}
			${Store.editMode ? `<div class="edit-row">
				<div class="room-name compact" contenteditable="true" data-field="name">${roomNameContent}</div>
				${pianoTypeSelector}
			</div>` : `<div class="room-name" ${Store.editMode ? 'contenteditable="true" data-field="name"' : ''}>${roomNameContent}</div>`}
			<div class="remark" ${Store.editMode ? 'contenteditable="true" data-field="remark"' : ''}>${remarkContent}</div>
			${r.occupant && !Store.editMode ?`<div class="occupant-line"><span class="dot"></span><span>${escapeHtml(r.occupant)}</span></div>`:''}
			${!Store.editMode ? `<div class="status-row">
				${r.occupant ? `<span class="chip ${st.class}">${st.chip}</span>` : `<span class="chip chip-dim" data-empty="1">Á©∫Èó≤</span>`}
				<div class="actions">${r.occupant?`<button class="danger" data-act="clear" title="Ê∏ÖÁ©∫">‚úï</button><button class="renew-btn" data-act="renew" title="Áª≠Êúü">‚ü≥</button>`:``}</div>
			</div>` : ''}
		</div>`; 
	}

	/*************************************************
	 * ‰∫§‰∫íÈÄªËæë
	 *************************************************/
	function bindRoomEvents(){
		// Èò≤ÊäñÊú∫Âà∂ÁöÑÁª≠ÊúüÂ§ÑÁêÜ
		let lastRenewClick = {};
		
		document.getElementById('roomGrid').addEventListener('click', e=>{
			const card=e.target.closest('.room-card'); if(!card) return; const name=card.dataset.room; const room=Store.byName.get(name); if(!room) return;
			
			// ÁºñËæëÊ®°Âºè‰∏ãÁ¶ÅÁî®Áê¥ÊàøÁÇπÂáªÂäüËÉΩÔºåÈô§‰∫ÜÁâπÂÆöÊåâÈíÆ
			if (Store.editMode) {
				// Âà†Èô§ÊåâÈíÆÂ§ÑÁêÜ
				if(e.target.closest('.delete-btn')){
					if(confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Áê¥Êàø "${name}" ÂêóÔºü`)){
						deleteRoom(name);
					}
					return;
				}
				
				// Áê¥ÊàøÁ±ªÂûãÈÄâÊã©Âô®Â§ÑÁêÜ
				if(e.target.closest('.piano-type-selector')){
					// Á±ªÂûãÈÄâÊã©Âô®Áî±change‰∫ã‰ª∂Â§ÑÁêÜÔºåËøôÈáå‰∏çÂÅöÈ¢ùÂ§ñÂ§ÑÁêÜ
					return;
				}
				
				// ÂÖ∂‰ªñÁÇπÂáª‰∫ã‰ª∂Âú®ÁºñËæëÊ®°Âºè‰∏ãË¢´ÂøΩÁï•
				return;
			}
			
			// ÈùûÁºñËæëÊ®°Âºè‰∏ãÁöÑÊ≠£Â∏∏ÁÇπÂáªÈÄªËæë
			if(e.target.closest('button[data-act=clear]')){ clearRoom(name); return; }
			if(e.target.closest('button[data-act=renew]')){ 
				const now = Date.now();
				// Èò≤ÊäñÔºöÂêå‰∏ÄÊàøÈó¥500msÂÜÖÂè™ËÉΩËß¶Âèë‰∏ÄÊ¨°Áª≠Êúü
				if (lastRenewClick[name] && (now - lastRenewClick[name]) < 500) {
					logInfo(`ÊàøÈó¥ ${name} Áª≠ÊúüÊìç‰ΩúË¢´Èò≤ÊäñÈôêÂà∂`);
					return;
				}
				lastRenewClick[name] = now;
				
				// Ê£ÄÊü•Êìç‰ΩúÈîÅ
				const lockKey = `renew_${name}`;
				if (Store.operationLocks?.has(lockKey)) {
					toast(`ÊàøÈó¥ ${name} Ê≠£Âú®Â§ÑÁêÜ‰∏≠...`, 'warn');
					return;
				}
				
				renewRoom(name); 
				return; 
			}
			if(!room.occupant) openStudentModal(name);
		});
		// Èò≤ÊäñÊú∫Âà∂ÁöÑÂèåÂáªÊ∏ÖÁ©∫Â§ÑÁêÜ
		let lastClearClick = {};
		document.getElementById('roomGrid').addEventListener('dblclick', e=>{
			// ÁºñËæëÊ®°Âºè‰∏ãÁ¶ÅÁî®ÂèåÂáªÊ∏ÖÁ©∫
			if (Store.editMode) return;
			
			const card=e.target.closest('.room-card'); 
			if(!card) return; 
			
			const roomName = card.dataset.room;
			const now = Date.now();
			
			// Èò≤ÊäñÔºöÂêå‰∏ÄÊàøÈó¥500msÂÜÖÂè™ËÉΩËß¶Âèë‰∏ÄÊ¨°Ê∏ÖÁ©∫
			if (lastClearClick[roomName] && (now - lastClearClick[roomName]) < 500) {
				logInfo(`ÊàøÈó¥ ${roomName} Ê∏ÖÁ©∫Êìç‰ΩúË¢´Èò≤ÊäñÈôêÂà∂`);
				return;
			}
			lastClearClick[roomName] = now;
			
			const r=Store.byName.get(roomName); 
			if(r && r.occupant) {
				// Ê£ÄÊü•ÊòØÂê¶ÊúâÊìç‰ΩúÈîÅ
				const lockKey = `clear_${roomName}`;
				if (Store.operationLocks?.has(lockKey)) {
					toast(`ÊàøÈó¥ ${roomName} Ê≠£Âú®Â§ÑÁêÜ‰∏≠...`, 'warn');
					return;
				}
				
				clearRoom(r.name);
			} else if (r && !r.occupant) {
				toast(`ÊàøÈó¥ ${roomName} Â∑≤‰∏∫Á©∫`, 'info');
			}
		});
	}
	async function renewRoom(roomName){ 
		// Ê£ÄÊü•Êìç‰ΩúÈîÅÔºåÈò≤Ê≠¢ÈáçÂ§çÊìç‰Ωú
		const lockKey = `renew_${roomName}`;
		if (Store.operationLocks?.has(lockKey)) {
			logWarn(`ÊàøÈó¥ ${roomName} Ê≠£Âú®Áª≠Êúü‰∏≠ÔºåËØ∑Á®çÂÄô`);
			toast(`ÊàøÈó¥ ${roomName} Ê≠£Âú®Áª≠Êúü‰∏≠...`, 'warn');
			return { ok: false, error: 'Êìç‰ΩúËøõË°å‰∏≠' };
		}
		
		const r=Store.byName.get(roomName); 
		if(!r||!r.occupant){ 
			toast('ÊàøÈó¥‰∏∫Á©∫'); 
			return {ok:false, error:'ÊàøÈó¥‰∏∫Á©∫'}; 
		}
		
		// ËÆæÁΩÆÊìç‰ΩúÈîÅ
		if (!Store.operationLocks) Store.operationLocks = new Set();
		Store.operationLocks.add(lockKey);
		
		try {
			// ‰πêËßÇÊõ¥Êñ∞ÔºàÁ´ãÂç≥ÊòæÁ§∫ÊïàÊûúÔºâ
			const originalTime = r.registerTime;
			r.registerTime = Date.now(); 
			
			// Ê∑ªÂä†ËßÜËßâÊåáÁ§∫
			const card = document.querySelector(`[data-room="${roomName}"]`);
			if (card) {
				card.classList.add('pending-operation');
				card.dataset.status = 'syncing';
			}
			
			renderRoomCard(roomName); 
			toast(`‚úÖ Â∑≤Áª≠Êúü ${roomName}`, 'success');
			
			// ÂêéÁ´ØÂêåÊ≠•
			if(!supabaseReady){ 
				logWarn('Á¶ªÁ∫øÊ®°Âºè - ‰ªÖÊú¨Âú∞Áª≠Êúü');
				return {ok:true, offline:true}; 
			}
			
			const nowIso = new Date().toISOString();
			const nextVersion = (r.version || 0) + 1;
			
			// Ê†áËÆ∞‰∏∫ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅ
			Store.pendingAssign.set(roomName, { 
				student: r.occupant, 
				version: nextVersion, 
				timestamp: Date.now(),
				action: 'renew'
			});
			
			const { data, error } = await supabaseClient.from('rooms').upsert({
				name: roomName,
				occupant_student_name: r.occupant,
				register_time: nowIso,  // Êõ¥Êñ∞‰∏∫Êñ∞ÁöÑÊ≥®ÂÜåÊó∂Èó¥
				heartbeat_at: nowIso,
				version: nextVersion,
				updated_at: nowIso
			}, {
				onConflict: 'name'
			});
			
			if(error){ 
				logErr('Áª≠ÊúüÂ§±Ë¥•', error.message);
				// ÂõûÊªö‰πêËßÇÊõ¥Êñ∞
				r.registerTime = originalTime;
				renderRoomCard(roomName);
				toast(`‚ùå Áª≠ÊúüÂ§±Ë¥• ${roomName}`, 'error');
				return {ok:false,error}; 
			}
			
			// ÂÜôÂÖ•ÁªÉ‰π†ËÆ∞ÂΩï
			await writePracticeLog(roomName, r.occupant, 'renew');
			
			logInfo(`ÊàêÂäüÁª≠Êúü ${roomName} (v${nextVersion})`);
			return {ok:true, data};
			
		} finally {
			// Ê∏ÖÈô§Êìç‰ΩúÈîÅ
			Store.operationLocks.delete(lockKey);
			// Ê∏ÖÈô§ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅ
			Store.pendingAssign.delete(roomName);
			// Ê∏ÖÈô§ËßÜËßâÊåáÁ§∫
			clearOperationIndicator(roomName);
		}
	}
	function openStudentModal(roomName){
		const modal=document.getElementById('studentModalBackdrop'); 
		modal.style.display='flex'; 
		modal.dataset.room=roomName; 
		const input=document.getElementById('studentSearch');
		input.value='';
		// ÂàùÂßãÂåñÈîÆÁõòÈÄâÊã©Áä∂ÊÄÅ
		studentListKB.index=0; studentListKB.active=true; 
		renderStudentList();
		// ËÅöÁÑ¶ËæìÂÖ•Ê°ÜÊñπ‰æøÁõ¥Êé•ÊâìÂ≠ó
		setTimeout(()=>input.focus(), 0);
	}
	function closeStudentModal(){ document.getElementById('studentModalBackdrop').style.display='none'; }
	function renderStudentList(){
		const box=document.getElementById('studentList'); 
		const q=document.getElementById('studentSearch').value.trim().toLowerCase(); 
		const roomName=document.getElementById('studentModalBackdrop').dataset.room; 
		const isGrand=/‰∏âËßí/.test((Store.byName.get(roomName)||{}).pianoType||'');
		
		let arr=Store.students.slice(); 
		if(q) arr=arr.filter(s=> matchPinyin(s.name, q) || (s.major||'').toLowerCase().includes(q));
		
		// ÂØπ‰∫é‰∏âËßíÈí¢Áê¥ÔºåÂÆåÂÖ®ËøáÊª§ÊéâÈùûÈí¢Áê¥ÊïôÁ†îÂÆ§ÁöÑÂ≠¶Áîü
		if(isGrand) {
			arr = arr.filter(s => s.major === 'Èí¢Áê¥ÊïôÁ†îÂÆ§');
		}
		
		arr.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN'));
		
		// Âª∫Á´ãÂç†Áî®Á¥¢ÂºïÔºåÊèêÈ´òÊü•ÊâæÈÄüÂ∫¶
		const occupancyMap = new Map();
		for(const r of Store.rooms){ if(r.occupant){ occupancyMap.set(r.occupant, r); } }

		box.innerHTML = arr.map((s,i)=>{ 
			const occRoom = occupancyMap.get(s.name);
			const isOccupied = !!occRoom && occRoom.name !== roomName; // Â∑≤Âú®ÂÖ∂ÂÆÉÊàøÈó¥
			let titleText = `${s.major||''} ${s.grade||''}`.trim();
			if(isOccupied){ titleText += ` (Âç†Áî® ${occRoom.name})`; }

			// ËÆ°ÁÆóÂç†Áî®Áä∂ÊÄÅÊ†áÁ≠æÔºàÂáÜÂ§á‰∏≠/ËÆ°Êó∂/Ë∂ÖÊó∂Ôºâ
			let stateTag = '';
			if(isOccupied){
				const st = statusInfo(occRoom);
				let label = '';
				switch(st.state){
					case 'preparing': label='ÂáÜÂ§á‰∏≠'; break;
					case 'occupied': label='Âç†Áî®‰∏≠'; break;
					case 'overtime': label='Ë∂ÖÊó∂'; break;
					default: label='Âç†Áî®';
				}
				// Âä®ÊÄÅÊó∂ÈïøÔºàÂç†Áî®ËÆ°Êó∂Ôºâ
				if(st.state==='occupied' && /:\d{2}$/.test(st.chip)){
					label += ` ${st.chip}`; // Â∑≤Êúâ mm:ss Êàñ hh:mm:ss
				}
				stateTag = `<span class="state-tag st-${st.state}">${label}</span>`;
			}

			const kbCls = (i===studentListKB.index)?' kb-selected':'';
			return `<div class="student-item${kbCls}" data-name="${s.name}" title="${titleText}">
				<div class="col-left">
					<span class="stu-name">${escapeHtml(s.name)}</span>
					<span class="tag major">${s.major||''}</span>
					${s.grade?`<span class=\"tag grade\">${s.grade}</span>`:''}
				</div>
				<div class="col-right">
					${isOccupied?`<span class=\"room-tag\" title=\"ÂΩìÂâçÂç†Áî®ÊàøÈó¥\">${occRoom.name}</span>`:''}
					${stateTag}
				</div>
			</div>`; 
		}).join('');
		// Ë∂äÁïå‰øùÊä§ & ÈáçÊñ∞È´ò‰∫Æ
		const items = box.querySelectorAll('.student-item');
		if(items.length===0){ studentListKB.index=-1; return; }
		if(studentListKB.index>=items.length) studentListKB.index=items.length-1; 
		if(studentListKB.index<0) studentListKB.index=0;
		items.forEach((el,i)=> el.classList.toggle('kb-selected', i===studentListKB.index));
		// Á°Æ‰øùÈÄâ‰∏≠È°πÂèØËßÅ
		const active=items[studentListKB.index];
		if(active){ const rect=active.getBoundingClientRect(); const parent=box.getBoundingClientRect(); if(rect.top<parent.top||rect.bottom>parent.bottom){ active.scrollIntoView({block:'nearest'}); } }
	}
	function bindStudentModal(){
		// ÈîÆÁõòÂØºËà™Áä∂ÊÄÅ
		if(!window.studentListKB){
			window.studentListKB={ index:0, active:false };
		}
		function moveSelection(delta){
			const box=document.getElementById('studentList');
			const items=box.querySelectorAll('.student-item');
			if(items.length===0) return; 
			studentListKB.index=Math.min(items.length-1, Math.max(0, studentListKB.index+delta));
			items.forEach((el,i)=> el.classList.toggle('kb-selected', i===studentListKB.index));
			const active=items[studentListKB.index];
			if(active){ const rect=active.getBoundingClientRect(); const parent=box.getBoundingClientRect(); if(rect.top<parent.top||rect.bottom>parent.bottom){ active.scrollIntoView({block:'nearest'}); } }
		}
		function triggerSelect(){
			const box=document.getElementById('studentList');
			const items=box.querySelectorAll('.student-item');
			if(items.length===0) return;
			const target=items[studentListKB.index];
			if(target){ target.click(); }
		}
		// ÁõëÂê¨ÈîÆÁõò
		document.addEventListener('keydown', function studentModalKeyHandler(e){
			const modal=document.getElementById('studentModalBackdrop');
			if(modal.style.display!=='flex') return; // Âè™Âú®Ê®°ÊÄÅÊâìÂºÄÊó∂
			// ÂΩìÁÑ¶ÁÇπÂú®ËæìÂÖ•Ê°ÜÊàñ body ÂùáÂèØÂìçÂ∫îÔºå‰∏ä‰∏ãÈîÆ & ÂõûËΩ¶
			if(['ArrowDown','ArrowUp','Enter','Escape'].includes(e.key)){
				// ÈÅøÂÖçÈ°µÈù¢Êï¥‰ΩìÊªöÂä®
				e.preventDefault();
				studentListKB.active=true;
				if(e.key==='ArrowDown') moveSelection(1); else if(e.key==='ArrowUp') moveSelection(-1); else if(e.key==='Enter') triggerSelect(); else if(e.key==='Escape') closeStudentModal();
			}
		}, {passive:false});
		document.getElementById('studentSearch').addEventListener('input', renderStudentList);
		// Èò≤ÊäñÊú∫Âà∂ÁöÑÂ≠¶ÁîüÈÄâÊã©Â§ÑÁêÜ
		let lastAssignClick = {};
		document.getElementById('studentList').addEventListener('click', e=>{ 
			const item=e.target.closest('.student-item'); 
			if(!item) return; 
			
			const name=item.dataset.name; 
			const room=document.getElementById('studentModalBackdrop').dataset.room;
			const now = Date.now();
			const clickKey = `${room}_${name}`;
			
			// Èò≤ÊäñÔºöÂêå‰∏ÄÊàøÈó¥ÂíåÂ≠¶ÁîüÁªÑÂêà500msÂÜÖÂè™ËÉΩËß¶Âèë‰∏ÄÊ¨°ÂàÜÈÖç
			if (lastAssignClick[clickKey] && (now - lastAssignClick[clickKey]) < 500) {
				logInfo(`ÊàøÈó¥ ${room} ÂàÜÈÖçÁªô ${name} ÁöÑÊìç‰ΩúË¢´Èò≤ÊäñÈôêÂà∂`);
				return;
			}
			lastAssignClick[clickKey] = now;
			
			// Ê£ÄÊü•Êìç‰ΩúÈîÅ
			const lockKey = `assign_${room}`;
			if (Store.operationLocks?.has(lockKey)) {
				toast(`ÊàøÈó¥ ${room} Ê≠£Âú®Â§ÑÁêÜ‰∏≠...`, 'warn');
				return;
			}
			
			// Ê£ÄÊü•Â≠¶ÁîüÊòØÂê¶Â∑≤ÁªèÂç†Áî®ÂÖ∂‰ªñÁê¥ÊàøÔºåÂ¶ÇÊûúÊòØÂàôÂÖàÊ∏ÖÁ©∫ÂéüÁê¥Êàø
			const occupiedRoom = Store.rooms.find(r => r.occupant === name);
			if (occupiedRoom && occupiedRoom.name !== room) {
				logInfo(`Â≠¶Áîü ${name} ‰ªé ${occupiedRoom.name} ËΩ¨ÁßªÂà∞ ${room}`);
				toast(`Ê≠£Âú®Â∞Ü ${name} ‰ªé ${occupiedRoom.name} ËΩ¨ÁßªÂà∞ ${room}...`, 'info');
				// ÂÖàÊ∏ÖÁ©∫ÂéüÁê¥Êàø
				clearRoom(occupiedRoom.name).then(() => {
					// ÁÑ∂ÂêéÂàÜÈÖçÂà∞Êñ∞Áê¥Êàø
					assignRoom(room, name);
				});
			} else {
				// Áõ¥Êé•ÂàÜÈÖç
				assignRoom(room, name);
			}
			
			closeStudentModal(); 
		});
		document.getElementById('btnStudentModalCancel').onclick=closeStudentModal; document.getElementById('btnCloseStudentModal').onclick=closeStudentModal; }

	/*************************************************
	 * Êñ∞Â¢ûÊàøÈó¥Ê®°ÊÄÅÊ°Ü
	 *************************************************/
	function showAddRoomModal(){
		const modal = document.getElementById('addRoomModalBackdrop');
		modal.style.display = 'flex';
		
		// Ê∏ÖÁ©∫Ë°®Âçï
		document.getElementById('addRoomName').value = '';
		document.getElementById('addRoomLocation').value = '';
		document.getElementById('addRoomPianoType').value = 'Á´ãÂºè';
		document.getElementById('addRoomRemark').value = '';
		
		// ÈáçÁΩÆÈí¢Áê¥Á±ªÂûãÈÄâÊã©Âô®
		document.querySelectorAll('.piano-type-option').forEach(option => {
			option.classList.remove('selected');
		});
		document.querySelector('.piano-type-option[data-type="Á´ãÂºè"]').classList.add('selected');
		
		// ËÅöÁÑ¶ÊàøÈó¥ÂêçÁß∞ËæìÂÖ•Ê°Ü
		setTimeout(() => document.getElementById('addRoomName').focus(), 0);
		
		// ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
		modal.addEventListener('click', function handleBackdropClick(e) {
			if (e.target === modal) {
				closeAddRoomModal();
				modal.removeEventListener('click', handleBackdropClick);
			}
		});
	}
	
	function closeAddRoomModal(){
		document.getElementById('addRoomModalBackdrop').style.display = 'none';
	}
	
	function bindAddRoomModal(){
		document.getElementById('btnCloseAddRoomModal').onclick = closeAddRoomModal;
		document.getElementById('btnAddRoomCancel').onclick = closeAddRoomModal;
		document.getElementById('btnAddRoomConfirm').onclick = createNewRoom;
		
		// Èí¢Áê¥Á±ªÂûãÈÄâÊã©Âô®‰∫ã‰ª∂
		document.querySelectorAll('.piano-type-option').forEach(option => {
			option.addEventListener('click', function() {
				// ÁßªÈô§ÂÖ∂‰ªñÈÄâ‰∏≠Áä∂ÊÄÅ
				document.querySelectorAll('.piano-type-option').forEach(opt => opt.classList.remove('selected'));
				// Ê∑ªÂä†ÂΩìÂâçÈÄâ‰∏≠Áä∂ÊÄÅ
				this.classList.add('selected');
				// ÂêåÊ≠•Âà∞ÈöêËóèÁöÑselectÂÖÉÁ¥†
				document.getElementById('addRoomPianoType').value = this.dataset.type;
			});
		});
		
		// ÂõûËΩ¶ÈîÆÊèê‰∫§
		document.getElementById('addRoomName').addEventListener('keydown', e => {
			if (e.key === 'Enter') {
				e.preventDefault();
				createNewRoom();
			}
		});
		
		// ESCÈîÆÂÖ≥Èó≠
		document.addEventListener('keydown', function addRoomModalKeyHandler(e) {
			const modal = document.getElementById('addRoomModalBackdrop');
			if (modal.style.display === 'flex' && e.key === 'Escape') {
				closeAddRoomModal();
			}
		});
	}
	
	async function createNewRoom(){
		// Ê∏ÖÈô§‰πãÂâçÁöÑÈîôËØØÁä∂ÊÄÅ
		document.querySelectorAll('.form-field').forEach(field => {
			field.classList.remove('error');
			const errorMsg = field.querySelector('.error-message');
			if (errorMsg) errorMsg.remove();
		});
		
		const name = document.getElementById('addRoomName').value.trim();
		const location = document.getElementById('addRoomLocation').value.trim();
		const pianoType = document.getElementById('addRoomPianoType').value;
		const remark = document.getElementById('addRoomRemark').value.trim();
		
		let hasError = false;
		
		// È™åËØÅÊàøÈó¥ÂêçÁß∞
		if (!name) {
			const nameField = document.getElementById('addRoomName').closest('.form-field');
			nameField.classList.add('error');
			const errorDiv = document.createElement('div');
			errorDiv.className = 'error-message';
			errorDiv.textContent = 'ÊàøÈó¥ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫';
			nameField.appendChild(errorDiv);
			hasError = true;
		}
		
		// Ê£ÄÊü•ÊàøÈó¥ÂêçÁß∞ÊòØÂê¶Â∑≤Â≠òÂú®
		if (name && Store.byName.has(name)) {
			const nameField = document.getElementById('addRoomName').closest('.form-field');
			nameField.classList.add('error');
			const errorDiv = document.createElement('div');
			errorDiv.className = 'error-message';
			errorDiv.textContent = 'ÊàøÈó¥ÂêçÁß∞Â∑≤Â≠òÂú®';
			nameField.appendChild(errorDiv);
			hasError = true;
		}
		
		if (hasError) {
			document.getElementById('addRoomName').focus();
			return;
		}
		
		try {
			// Êò†Â∞ÑÈÄâÊã©Âô®ÂÄºÂà∞Êï∞ÊçÆÂ∫ìÊ†ºÂºè
			let mappedPianoType = '';
			switch(pianoType) {
				case '‰∏âËßí':
					mappedPianoType = '‰∏âËßíÈí¢Áê¥';
					break;
				case 'Á´ãÂºè':
					mappedPianoType = 'Á´ãÂºèÈí¢Áê¥';
					break;
				case 'ÂÖ∂‰ªñ':
				default:
					mappedPianoType = 'ÂÖ∂‰ªñ';
					break;
			}
			
			const newRoom = {
				name: name,
				location: location || '',
				pianoType: mappedPianoType,
				remark: remark || '',
				occupant: null,
				registerTime: null,
				version: 1,
				heartbeatAt: null
			};
			
			// Ê∑ªÂä†Âà∞Êú¨Âú∞Êï∞ÊçÆ
			Store.rooms.push(newRoom);
			Store.byName.set(name, newRoom);
			
			// Êõ¥Êñ∞Ê•ºÂ±ÇÈõÜÂêà
			const floor = deriveFloor(location);
			if (floor) Store.floorSet.add(floor);
			
			// ÂêåÊ≠•Âà∞‰∫ëÁ´Ø
			if (!Store.settings.offlineMode) {
				await supabaseClient.from('room_database').upsert({
					name: name,
					location: location || null,
					piano_type: mappedPianoType,
					remark: remark || null
				});
			}
			
			// ÈáçÊñ∞Ê∏≤Êüì
			renderRooms();
			ensureFilters();
			
			toast(`‚úÖ Â∑≤Ê∑ªÂä†Áê¥ÊàøÔºö${name}`);
			logInfo(`Êñ∞Â¢ûÁê¥ÊàøÔºö${name}, ‰ΩçÁΩÆÔºö${location}, Á±ªÂûãÔºö${pianoType}`);
			
			closeAddRoomModal();
		} catch (error) {
			toast('Ê∑ªÂä†Â§±Ë¥•', 'error');
			logErr('Êñ∞Â¢ûÁê¥ÊàøÂ§±Ë¥•:', error.message);
		}
	}

	/*************************************************
	 * ÊêúÁ¥¢
	 *************************************************/
	function initSearch(){ document.getElementById('globalSearch').addEventListener('input', ()=>{ runGlobalSearch(); }); }
	function runGlobalSearch(){ 
		const q=document.getElementById('globalSearch').value.trim().toLowerCase(); 
		const box=document.getElementById('inlineSearchResults'); 
		if(!q){ box.style.display='none'; box.innerHTML=''; return; }
		const students=Store.students.filter(s=> matchPinyin(s.name, q) || (s.major||'').toLowerCase().includes(q));
		const rooms=Store.rooms.filter(r=> r.name.toLowerCase().includes(q) || (r.location||'').toLowerCase().includes(q) || (r.pianoType||'').toLowerCase().includes(q));
		const highlight=(txt)=>{ if(!q) return escapeHtml(txt); const low=txt.toLowerCase(); const idx=low.indexOf(q); if(idx===-1) return escapeHtml(txt); return escapeHtml(txt.slice(0,idx))+`<span class="highlight">${escapeHtml(txt.slice(idx,idx+q.length))}</span>`+escapeHtml(txt.slice(idx+q.length)); };
		let html='';
		if(students.length){ 
			html+=`<div><div class="group-title">Â≠¶Áîü (${students.length})</div>`+students.slice(0,30).map(s=>{
				const room = Store.rooms.find(r=>r.occupant===s.name);
				let occupyMeta='';
				if(room){
					const st=statusInfo(room);
					const icon = st.state==='preparing' ? '‚è≥' : (st.state==='overtime' ? '‚ö†Ô∏è' : 'üéπ');
					occupyMeta = `<span class="occ-info ${st.state}"><span class="icon">${icon}</span><span>${room.name}</span></span>`;
				}
				return `<div class="result-item student" data-type="student" data-name="${s.name}"><span>${highlight(s.name)}</span><span class="meta">${s.major||''} ${s.grade||''} ${occupyMeta}</span></div>`; 
			}).join('')+`</div>`; 
		}
		if(rooms.length){ html+=`<div><div class="group-title">Áê¥Êàø (${rooms.length})</div>`+rooms.slice(0,30).map(r=>{ const st=statusInfo(r); return `<div class="result-item room" data-type="room" data-room="${r.name}"><span>${highlight(r.name)}</span><span class="meta">${r.location||''} ${r.pianoType||''} ${st.chip}</span></div>`; }).join('')+`</div>`; }
		if(!html) html='<div class="empty">Êó†ÂåπÈÖçÁªìÊûú</div>';
		box.innerHTML=html; box.style.display='block';
		box.querySelectorAll('.result-item').forEach(el=>{
			el.onclick=()=>{ const type=el.dataset.type; if(type==='room'){ scrollToRoom(el.dataset.room); } else if(type==='student'){ focusStudent(el.dataset.name); } hideInlineSearch(); };
		});
	}
	function hideInlineSearch(){ const box=document.getElementById('inlineSearchResults'); if(box){ box.style.display='none'; } }
	// ÁÇπÂáªÈ°µÈù¢Á©∫ÁôΩÊàñÊåâ ESC ÂÖ≥Èó≠ÂÜÖËÅîÊêúÁ¥¢
	document.addEventListener('click', e=>{
		const box=document.getElementById('inlineSearchResults'); const input=document.getElementById('globalSearch');
		if(!box||box.style.display==='none') return; 
		if(!box.contains(e.target) && e.target!==input){ hideInlineSearch(); }
	});
	document.addEventListener('keydown', e=>{ if(e.key==='Escape') hideInlineSearch(); });

	/*************************************************
	 * ÁªüËÆ°‰∏éÂøÉË∑≥Âà∑Êñ∞
	 *************************************************/
	/*************************************************
	 * UI Áä∂ÊÄÅÊõ¥Êñ∞
	 *************************************************/
	function updateSyncStatus(state, text) {
		const dot = document.getElementById('syncDot');
		const textEl = document.getElementById('syncText');
		const reconnectBtn = document.getElementById('btnReconnect');
		
		if (dot) {
			dot.className = `sync-dot ${state}`;
		}
		if (textEl) {
			textEl.textContent = text;
		}
		
		// Ê†πÊçÆÁä∂ÊÄÅÊòæÁ§∫/ÈöêËóèÈáçËøûÊåâÈíÆ
		if (reconnectBtn) {
			reconnectBtn.style.display = (state === 'error' || state === 'offline') ? 'inline-block' : 'none';
		}
	}
	
	function updateCloudSyncInfo() {
		const localRoomCountEl = document.getElementById('localRoomCount');
		const localStudentCountEl = document.getElementById('localStudentCount');
		const lastSyncTimeEl = document.getElementById('lastSyncTime');
		
		if (localRoomCountEl) {
			localRoomCountEl.textContent = Store.rooms.length;
		}
		if (localStudentCountEl) {
			localStudentCountEl.textContent = Store.students.length;
		}
		if (lastSyncTimeEl && supabaseReady) {
			lastSyncTimeEl.textContent = new Date().toLocaleTimeString();
		}
	}
	
	function updateUsageStats(){ 
		const total=Store.rooms.length; 
		const occ=Store.rooms.filter(r=>r.occupant).length; 
		const rate= total? ((occ/total)*100).toFixed(1):'0.0'; 
		const statEl = document.getElementById('statUsage');
		if (statEl) {
			statEl.textContent=`‰ΩøÁî®Áéá ${rate}%`;
		}
		const metaEl = document.getElementById('metaCounts');
		if (metaEl) {
			metaEl.textContent = `ÂÖ± ${total} Èó¥ ‚Ä¢ Âç†Áî® ${occ}`;
		}
		
		// ÂêåÊó∂Êõ¥Êñ∞‰∫ëÁ´ØÂêåÊ≠•‰ø°ÊÅØ
		updateCloudSyncInfo();
	}
	function startStatusTicker(){ if(Store.timer) clearInterval(Store.timer); Store.timer = setInterval(()=>{ const els=document.querySelectorAll('.room-card'); els.forEach(el=>{ const name=el.dataset.room; const r=Store.byName.get(name); if(!r) return; const st=statusInfo(r); const chip=el.querySelector('.chip'); if(chip) { chip.textContent=st.chip; chip.className=`chip ${st.class}`; } el.dataset.status=st.state; }); }, 1000); }

	/*************************************************
	 * ÈÄöÁü•Á≥ªÁªü
	 *************************************************/
	function addNotification(n){
		const id = 'N'+ (++Store.notificationSeq)+'_'+Date.now();
		Store.notifications.push({...n,id,updatedAt:Date.now(),state:n.state||'open',version:1});
		renderNotifications();
		syncNotificationsDebounced();
	}
	function renderNotifications(){
		const listEl=document.getElementById('notificationList'); if(!listEl) return;
		const tab=Store.activeNotificationTab;
		const items=Store.notifications.filter(n=>n.type===tab && n.state==='open');
		if(!items.length){ listEl.innerHTML=`<div class="notification-empty">ÊöÇÊó†${tab==='absence'?'Áº∫Âã§':'ÂºÇÂ∏∏'}ÊèêÈÜí</div>`; return; }
		listEl.innerHTML=items.map(n=>notificationItemHTML(n)).join('');
		// ÁªëÂÆöÂøΩÁï•ÊåâÈíÆ
		listEl.querySelectorAll('[data-ignore]').forEach(btn=>{
			btn.addEventListener('click',e=>{ e.stopPropagation(); ignoreNotification(btn.dataset.id); });
		});
	}
	function notificationItemHTML(n){
		const start=new Date(n.startAt).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
		return `<div class="notify-item type-${n.type}" data-id="${n.id}">
			<div class="notify-header"><span class="badge ${n.type==='absence'?'badge-absence':'badge-abnormal'}">${n.type==='absence'?'Áº∫Âã§':'ÂºÇÂ∏∏'}</span><span>${escapeHtml(n.student)}${n.room? ' ¬∑ '+escapeHtml(n.room):''}</span></div>
			<div class="notify-body">${escapeHtml(n.detail||'')}</div>
			<div class="notify-footer"><span class="time">ÂºÄÂßã ${start}</span><button class="notify-ignore" data-ignore="1" data-id="${n.id}">ÂøΩÁï•</button></div>
		</div>`;
	}
	function ignoreNotification(id){ const n=Store.notifications.find(x=>x.id===id); if(!n||n.state!=='open') return; n.state='ignored'; n.updatedAt=Date.now(); renderNotifications(); syncNotificationsDebounced(); }
	function resolveAbsenceNotification(student){ let changed=false; Store.notifications.forEach(n=>{ if(n.type==='absence' && n.student===student && n.state==='open'){ n.state='resolved'; n.updatedAt=Date.now(); changed=true; } }); if(changed){ renderNotifications(); syncNotificationsDebounced(); }}
	function resolveAbnormalForRoom(roomName){ let changed=false; Store.notifications.forEach(n=>{ if(n.type==='abnormal' && n.room===roomName && n.state==='open'){ n.state='resolved'; n.updatedAt=Date.now(); changed=true; } }); if(changed){ renderNotifications(); syncNotificationsDebounced(); }}

	// Áº∫Âã§Ê£ÄÊµãÔºöÂÅáËÆæÊúâÂ≠¶ÁîüÊéíÁªÉËÆ°ÂàíÔºå‰∏¥Êó∂Áî®ÂÅáËÆæÔºöÊâÄÊúâÂ≠¶ÁîüÊØèÂ§© 08:00-22:00 ‰ªª‰∏Ä‰∏§Â∞èÊó∂Êï¥ÁÇπÊÆµÔºå‰ª•ÁôªËÆ∞Êó∂Èó¥Âª∂Âêé 5 ÂàÜÈíüÂà§Êñ≠ÔºõËøôÈáåÁÆÄÂåñ‰∏∫ÔºöËã•‰ªé 08:00 Ëµ∑ÊØè2Â∞èÊó∂ÊÆµÂºÄÂßãÂêéÁöÑÁ¨¨5ÂàÜÈíü‰ªçÊú™ÁôªËÆ∞ÂΩìÊó•‰ªéÊú™ÁªÉÁê¥ÂàôÊèêÁ§∫„ÄÇ
	// Áî®Êà∑Êú™Êèê‰æõËÆ°ÂàíÊï∞ÊçÆ => ÈááÁî®Âç†‰ΩçÈÄªËæëÔºåÂêéÁª≠ÂèØÊé•ÂÖ•ÁúüÂÆû schedule Ë°®„ÄÇ
	function checkAbsence(){
		const now=new Date(); const mins=now.getHours()*60+now.getMinutes();
		// ÈÅçÂéÜÊâÄÊúâÂ≠¶ÁîüÔºåÂ¶ÇÊûúÂΩìÂ§©Â∞öÊú™Âá∫Áé∞Ëøá occupancy ‰∏î ÂΩìÂâçÂàÜÈíüËêΩÂú®Êüê‰∏™Êï¥ÁÇπÊÆµÂºÄÂßã+5ÔºåÂàôÂèëÈÄöÁü•ÔºàÈÅøÂÖçÈáçÂ§çÔºâ„ÄÇ
		Store.students.forEach(s=>{
			if(!s||!s.name) return;
			const existingOpen=Store.notifications.some(n=>n.type==='absence'&&n.student===s.name&&n.state==='open');
			if(existingOpen) return;
			// Â∑≤ÁªèÊúâÁªÉÁê¥ËÆ∞ÂΩï(Âç†Áî®)ÂàôÂøΩÁï•
			const practicing=Store.rooms.some(r=>r.occupant===s.name);
			if(practicing) return;
			// Á≤óÁï•ÔºöÊØè120ÂàÜÈíü‰∏Ä‰∏™ÊÆµÔºå‰ªé 8:00 ÂºÄÂßã
			if(mins>=8*60 && mins<=22*60){
				const segment=Math.floor((mins-8*60)/120); const segStart=8*60+segment*120; if(mins===segStart+5){
					addNotification({type:'absence',student:s.name,startAt:Date.now(),detail:`Êú¨Êó∂ÊÆµÂºÄÂßã5ÂàÜÈíü‰ªçÊú™ÁôªËÆ∞ÁªÉÁê¥`});
				}
			}
		});
	}
	function checkAbnormal(){
		// ÂºÇÂ∏∏ÂÆö‰πâÔºöÂ≠¶ÁîüÂú®ÁªÉÁê¥ÂÆûÈôÖÊÆµÁªìÊùüÔºàÂÅáËÆæ 120 ÂàÜÈíüÔºâÂêé‰ªçË∂Ö 15 ÂàÜÈíüÊú™Ê∏ÖÁ©∫‰∏î‰∏çÂ§Ñ‰∫éÊñ∞Êó∂ÊÆµ
		const now=Date.now();
		Store.rooms.forEach(r=>{
			if(!r.occupant||!r.registerTime) return;
			const prepEnd=r.registerTime+60000; // ÂáÜÂ§áÈò∂ÊÆµÁªìÊùü
			const practiceDuration=Store.settings.basePracticeDuration*60*1000; // 120m
			const endTime=prepEnd+practiceDuration;
			if(now>endTime+15*60*1000){
				// ÊòØÂê¶Â∑≤ÊúâÂºÇÂ∏∏ÈÄöÁü•
				const exists=Store.notifications.some(n=>n.type==='abnormal'&&n.room===r.name&&n.state==='open');
				if(!exists){
					// ‰∏çÂú®Êñ∞ÁöÑÁªÉÁê¥Êó∂ÊÆµÔºàÁÆÄÂåñÔºöÁôªËÆ∞Êó∂Èó¥ÂÜ≥ÂÆöÊÆµÔºåÁªìÊùüÂêéÁõ¥Êé•Âà§Êñ≠Ôºâ
					addNotification({type:'abnormal',student:r.occupant,room:r.name,startAt:endTime,detail:`Â∑≤Ë∂ÖÊó∂ 15 ÂàÜÈíü‰ªçÊú™Ê∏ÖÁ©∫`});
				}
			}
		});
	}
	function notificationTicker(){
		checkAbsence();
		checkAbnormal();
		setTimeout(notificationTicker,60*1000); // ÊØèÂàÜÈíüÊ£ÄÊµã
	}
	function initNotificationUI(){
		const absBtn=document.getElementById('tabAbsence'); const abnBtn=document.getElementById('tabAbnormal');
		if(absBtn) absBtn.onclick=()=>{ if(Store.activeNotificationTab==='absence')return; absBtn.dataset.active='1'; abnBtn.dataset.active='0'; Store.activeNotificationTab='absence'; renderNotifications(); };
		if(abnBtn) abnBtn.onclick=()=>{ if(Store.activeNotificationTab==='abnormal')return; abnBtn.dataset.active='1'; absBtn.dataset.active='0'; Store.activeNotificationTab='abnormal'; renderNotifications(); };
		renderNotifications();
		setTimeout(notificationTicker,5000); // Âª∂Ëøü5ÁßíÂºÄÂßãÊ£ÄÊµãÔºåÁ≠âÂæÖÊï∞ÊçÆÂä†ËΩΩ
	}

	// ===== ‰∫ëÂêåÊ≠•Âç†‰Ωç ===== //
	async function syncNotificationsDebounced(){ if(!syncNotificationsDebounced._t){ syncNotificationsDebounced._t=setTimeout(()=>{ syncNotificationsDebounced._t=null; syncNotifications(); },1500);} }
	async function syncNotifications(){ if(!supabaseReady) return; /* ÈúÄË¶ÅÂú®Êï∞ÊçÆÂ∫ìÂàõÂª∫ notifications Ë°®: {id, type, student, room, start_at, detail, state, updated_at, version} */ try{ if(!Store.notifications.length) return; const rows=Store.notifications.map(n=>({ id:n.id, type:n.type, student:n.student, room:n.room||null, start_at:new Date(n.startAt||Date.now()).toISOString(), detail:n.detail||'', state:n.state, updated_at:new Date(n.updatedAt).toISOString(), version:n.version||1 })); await supabaseClient.from('notifications').upsert(rows,{onConflict:'id'}); }catch(e){ logWarn('ÂêåÊ≠•ÈÄöÁü•Â§±Ë¥•',e.message); } }


	/*************************************************
	 * ÁªÉ‰π†ËÆ∞ÂΩï (Êú¨Âú∞ / ÊúçÂä°Âô®)
	 *************************************************/
	async function writePracticeLog(roomName, studentName, action) {
		// ÂÖàÁºìÂ≠òÂà∞Êú¨Âú∞
		const logEntry = createPracticeLogEntry(roomName, studentName, action);
		Store.localPracticeLogs.push(logEntry);
		
		if (!supabaseReady) {
			logInfo(`Êú¨Âú∞ËÆ∞ÂΩï: ${action} ${studentName} @ ${roomName}`);
			return;
		}
		
		try {
			let attempt = 0;
			let removed = [];
			let lastError = null;
			// ÂàõÂª∫Êï∞ÊçÆÂ∫ìÊï∞ÊçÆÂâØÊú¨ÔºåÁßªÈô§Êú¨Âú∞Â≠óÊÆµ
			let currentData = { ...logEntry };
			delete currentData.synced; // ÁßªÈô§Êú¨Âú∞Ê†áËÆ∞Â≠óÊÆµ
			let summarized = false; // ÊòØÂê¶Â∑≤ËæìÂá∫Áº∫ÂàóÊ±áÊÄª

			while (attempt < 5) { // ÊúÄÂ§ö 5 Ê¨°ÈÄêÂàóÂâîÈô§ÈáçËØï
				const { error } = await supabaseClient
					.from('practice_logs')
					.insert(currentData);

				if (!error) {
					// Ê†áËÆ∞‰∏∫Â∑≤ÂêåÊ≠•
					logEntry.synced = true;
					const removedInfo = removed.length ? ` (Â∑≤ÂâîÈô§Âàó: ${removed.join(',')})` : '';
					logInfo(`‚úÖ ÁªÉ‰π†ËÆ∞ÂΩïÂ∑≤ÂÜôÂÖ•: ${action} ${studentName} @ ${roomName}${removedInfo}`);
					return;
				}

				lastError = error;
				// ‰ªÖÂ§ÑÁêÜÁº∫ÂàóÈîôËØØ (Postgres 42703 Êàñ message ÂåÖÂê´ Could not find the 'xxx' column)
				const msg = (error.message||'').toLowerCase();
				if (error.code === '42703' || msg.includes("could not find the '") ) {
					// Ëß£ÊûêÁº∫Â§±ÂàóÂêç
					let missing = '';
					const m = error.message.match(/'([^']+)' column/);
					if (m) missing = m[1];
					if (missing && currentData.hasOwnProperty(missing)) {
						delete currentData[missing];
						removed.push(missing);
						// ÂΩìÁº∫Â§±ËøáÂ§öÂÖ≥ÈîÆÂàóÊó∂ÔºåÁõ¥Êé•ÈôçÁ∫ß‰∏∫ÊúÄÂ∞èÂ≠óÊÆµÈõÜÂêàÔºöaction, student_name, timestamp
						if (!summarized && removed.length >= 2) {
							// Ëã•Âü∫Á°Ä room_name ÈÉΩÁº∫‰∫ÜÔºåËØ¥ÊòéË°®ÁªìÊûÑ‰∏é‰Ω†ÁöÑÈ¢ÑÊúüÂ∑ÆÂºÇÂæàÂ§ßÔºåËæìÂá∫‰∏ÄÊ¨°Ê±áÊÄªÁÑ∂ÂêéÈôçÁ∫ß
							if (!currentData.room_name && !removed.includes('room_name')) {
								// do nothing; room_name ÂéüÊú¨‰∏çÂú® currentData Êó∂‰∏çÂ§ÑÁêÜ
							}
							logWarn(`practice_logs Â§öÂàóÁº∫Â§±: ${removed.join(',')}„ÄÇÂ∞ÜÈôçÁ∫ß‰ªÖÂÜôÂÖ•Âü∫Á°Ä: action, student_name, timestamp`);
							// ÊûÑÈÄ†ÊúÄÂ∞èÈõÜ
							currentData = {
								action: action,
								student_name: studentName,
								timestamp: now
							};
							summarized = true;
						}
						else {
							logWarn(`practice_logs Áº∫Â∞ëÂàó ${missing}ÔºåÂ∑≤ÂâîÈô§ÂêéÈáçËØï (Á¨¨ ${attempt+1} Ê¨°)`);
						}
						attempt++;
						continue;
					}
				}
				// ÂÖ∂ÂÆÉÈîôËØØÊàñÊó†Ê≥ïËß£ÊûêÂàóÂêçÔºåÁªìÊùüÂæ™ÁéØ
				break;
			}

			// Â¶ÇÊûúÈÄÄÂá∫Âæ™ÁéØ‰ªçÂ§±Ë¥•
			if (lastError) {
				logErr('ÂÜôÂÖ•ÁªÉ‰π†ËÆ∞ÂΩïÂ§±Ë¥•:', lastError.message + (removed.length?` (ÂâîÈô§Âàó: ${removed.join(',')})`:''));
			}
		} catch (err) {
			logErr('ÁªÉ‰π†ËÆ∞ÂΩïÂºÇÂ∏∏:', err.message);
		}
	}

	// ÂàõÂª∫ÁªÉ‰π†ËÆ∞ÂΩïÊù°ÁõÆ
	function createPracticeLogEntry(roomName, studentName, action) {
		const room = Store.rooms.find(r => r.name === roomName);
		const student = Store.studentIndex.get(studentName);
		const now = new Date().toISOString();

		let logEntry = {
			room_name: roomName,
			student_name: studentName,
			action: action,
			timestamp: now,
			piano_type: room?.pianoType || '',
			location: room?.location || '',
			student_major: student?.major || '',
			student_grade: student?.grade || '',
			synced: false // Êú¨Âú∞Ê†áËÆ∞
		};

		if (action === 'assign') {
			logEntry.session_start = now;
		} else if (action === 'clear' && room?.registerTime) {
			logEntry.session_start = new Date(room.registerTime).toISOString();
			logEntry.session_end = now;
			const durationMs = Date.now() - room.registerTime - 60000; // ÂáèÂéªÂáÜÂ§áÊó∂Èó¥
			logEntry.practice_duration = Math.max(0, Math.floor(durationMs / 1000));
		}

		return logEntry;
	}
	
	function writePracticeLogLocal(r){ 
		if(!r||!r.occupant||!r.registerTime) return; 
		const prepEnd=r.registerTime+60000; 
		const now=Date.now(); 
		const used = Math.max(0, now - prepEnd); 
		logInfo(`Êú¨Âú∞LOG ${r.occupant} @${r.name} ${formatDuration(Math.floor(used/1000))}`); 
	}

	/*************************************************
	 * Â∑•ÂÖ∑ & UI ËæÖÂä©
	 *************************************************/
	function formatHMS(sec){ const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); const s=sec%60; return (h>0?h+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
	function formatDuration(sec){ if(sec<60) return sec+'s'; const m=Math.floor(sec/60); const s=sec%60; if(m<60) return m+'m'+(s? s+'s':''); const h=Math.floor(m/60); const mm=m%60; return h+'h'+(mm?mm+'m':''); }
	function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
	function toast(msg, type){ const box=document.getElementById('toastContainer'); const el=document.createElement('div'); el.className='toast'; el.innerHTML=`<span>${escapeHtml(msg)}</span>`; box.appendChild(el); setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),320); }, 2800); }
	function logInfo(...a){ console.log('[INFO]',...a); appendRuntime('INFO', a.join(' ')); }
	function logWarn(...a){ console.warn('[WARN]',...a); appendRuntime('WARN', a.join(' ')); }
	function logErr(...a){ console.error('[ERR]',...a); appendRuntime('ERR', a.join(' ')); }
	function appendRuntime(level,msg){ const box=document.getElementById('runtimeInfo'); const line=document.createElement('div'); line.style.whiteSpace='pre-wrap'; line.innerHTML=`<span class="muted">${new Date().toLocaleTimeString()}</span> <span class="${level==='ERR'?'danger':level==='WARN'?'warn':'accent'}">${level}</span> <span>${escapeHtml(msg)}</span>`; box.prepend(line); const max=120; while(box.children.length>max) box.removeChild(box.lastChild); }
	function refreshStudentModalCache(){ /* È¢ÑÁïôÔºöÂèØÂª∫Á´ãÊãºÈü≥Á¥¢Âºï */ }

	/*************************************************
	 * ÂàùÂßãÂåñÊµÅÁ®ã
	 *************************************************/
	async function bootstrap(){
		try{ 
			await initSupabase(); 
		}catch(e){ 
			logWarn('Supabase ÂàùÂßãÂåñÂ§±Ë¥• (Á¶ªÁ∫øÊ®°Âºè)', e.message); 
			updateSyncStatus('error', 'Á¶ªÁ∫øÊ®°Âºè');
		}
		
		const [rooms, roomMeta, students] = await Promise.all([
			fetchRooms(), 
			fetchRoomMeta(), 
			fetchStudents()
		]);
		
		Store.rooms = rooms; 
		Store.roomMeta = roomMeta; 
		Store.students = students; 
		
		rebuildIndexes(); 
		rebuildStudentIndex(); 
		renderRooms(); 
		updateUsageStats(); 
		bindRoomEvents(); 
		bindStudentModal(); 
		bindAddRoomModal();
		initSearch(); 
		startStatusTicker(); 
		
		// Âè™Âú®SupabaseÂ∞±Áª™Êó∂ËÆæÁΩÆÂÆûÊó∂ÂêåÊ≠•
		if (supabaseReady) {
			await setupRealtime();
		}
		
		logInfo('ÂàùÂßãÂåñÂÆåÊàê: rooms='+rooms.length+' students='+students.length);
		// ÂàùÂßãÂåñÈÄöÁü•Á≥ªÁªü UI ‰∏éÊ£ÄÊµã
		initNotificationUI();
	}

	// ÂÖ®Â±ÄÊö¥Èú≤Ôºà‰æø‰∫éË∞ÉËØïÔºâ
	window.RoomStore=Store; window.assignRoom=assignRoom; window.clearRoom=clearRoom; window.renewRoom=renewRoom;

	bootstrap();
	</script>

<!-- unified final contrast & empty-room enhancement (moved inside body) -->
<style id="room-card-contrast-final">
/* ÊèêÂçáÊï¥‰ΩìÊñáÊú¨‰∏éÁ©∫Èó≤ÊàøÂç°ÂèØËßÅÂ∫¶ÔºõÈõÜ‰∏≠ÂîØ‰∏ÄË¶ÜÁõñÔºåÈÅøÂÖçÂ§öÂ±ÇÂÜ≤Á™Å */
body{--text:#e2ebf3; --text-dim:#a5b6c6;}
.room-card{color:#eef5fa !important;}
.room-card .room-name{color:#ffffff !important; text-shadow:0 1px 3px rgba(0,0,0,.55) !important; font-weight:700 !important;}
.room-card .occupant-line span:last-child{color:#fff !important; font-weight:600 !important;}

/* ‰ΩøÁî®‰∏≠ÊàøÈó¥ÔºöËìùËâ≤Âº∫Ë∞ÉËæπÊ°Ü‰∏éÂ§öÂ±ÇÂèëÂÖâ */
.room-card[data-status="occupied"]{
	background:linear-gradient(135deg,#2a4158 0%,#1d3245 40%,#16252f 100%) !important;
	border:1px solid #4a90e2 !important;
	box-shadow:
		0 0 0 1px rgba(74,144,226,0.4),
		0 2px 12px rgba(74,144,226,0.15),
		0 6px 25px rgba(74,144,226,0.08),
		inset 0 1px 0 rgba(255,255,255,0.05) !important;
}
.room-card[data-status="occupied"]:hover{
	border-color:#5fa3ff !important;
	box-shadow:
		0 0 0 1px rgba(95,163,255,0.5),
		0 3px 16px rgba(74,144,226,0.25),
		0 8px 35px rgba(74,144,226,0.12),
		inset 0 1px 0 rgba(255,255,255,0.08) !important;
	transform:translateY(-4px) !important;
}
.room-card[data-status="occupied"] .chip{
	background:rgba(74,144,226,0.15) !important;
	color:#7fb1ff !important;
	border:1px solid rgba(74,144,226,0.3) !important;
	font-weight:600 !important;
}

/* Ë∂ÖÊó∂ÊàøÈó¥ÔºöÁ∫¢Ëâ≤Ë≠¶ÂëäËæπÊ°Ü‰∏éÂèëÂÖâ */
.room-card[data-status="overtime"]{
	background:linear-gradient(135deg,#4a2728 0%,#3d1f20 40%,#2a1415 100%) !important;
	border:1px solid #ff4757 !important;
	box-shadow:
		0 0 0 1px rgba(255,71,87,0.4),
		0 2px 12px rgba(255,71,87,0.15),
		0 6px 25px rgba(255,71,87,0.08),
		inset 0 1px 0 rgba(255,255,255,0.05) !important;
}
.room-card[data-status="overtime"]:hover{
	border-color:#ff6b7a !important;
	box-shadow:
		0 0 0 1px rgba(255,107,122,0.5),
		0 3px 16px rgba(255,71,87,0.25),
		0 8px 35px rgba(255,71,87,0.12),
		inset 0 1px 0 rgba(255,255,255,0.08) !important;
	transform:translateY(-4px) !important;
}
.room-card[data-status="overtime"] .chip{
	background:rgba(255,71,87,0.15) !important;
	color:#ff7373 !important;
	border:1px solid rgba(255,71,87,0.3) !important;
	font-weight:600 !important;
}

/* Á©∫Èó≤ÊàøÔºö‰ΩøÁî® data-status Âèä .empty ÂèåÈÄâÊã©Âô®Á°Æ‰øùÂÖºÂÆπ */
.room-card[data-status="empty"],
.room-card.empty{
	background:linear-gradient(135deg,#273341 0%,#1e2730 55%,#192127 100%) !important;
	border:1px dashed rgba(255,255,255,0.28) !important;
	box-shadow:
		inset 0 0 0 1px rgba(255,255,255,0.05),
		0 2px 4px -2px rgba(0,0,0,0.6),
		0 4px 18px -4px rgba(0,0,0,0.55);
	transition:background .35s ease, box-shadow .35s ease, transform .25s ease;
}
.room-card[data-status="empty"]:hover,
.room-card.empty:hover{
	background:linear-gradient(135deg,#314155 0%,#25313d 55%,#1f2931 100%) !important;
	box-shadow:
		inset 0 0 0 1px rgba(255,255,255,0.07),
		0 4px 10px -2px rgba(0,0,0,0.65),
		0 6px 28px -6px rgba(0,0,0,0.6);
	transform:translateY(-2px);
}
.room-card[data-status="empty"] .status-chip,
.room-card.empty .status-chip{
	background:rgba(255,255,255,0.08) !important;
	color:#dfe8f1 !important;
	border:1px solid rgba(255,255,255,0.18) !important;
	text-shadow:0 1px 1px rgba(0,0,0,0.7);
}

/* Áä∂ÊÄÅËâ≤ÂæÆË∞É */
.chip{color:#cfd8e2 !important;}
.chip.accent{color:#7fbaff !important;}
.chip.danger{color:#ff7373 !important;}
.chip.good{color:#5edc7a !important;}
.chip.warn{color:#ffbc55 !important;}
</style>

</body>
</html>
