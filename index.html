<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0" />
	<title>é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ ç´æˆ¿ç®¡ç†ç³»ç»Ÿ Â· å…¨æ–°</title>
	<style>
		:root {
			--bg:#0e1116; --bg-alt:#161b22; --surface:#1f252d; --surface-alt:#242b35; --outline:#2f3844; --outline-hover:#3d4957; --divider:#212a33;
			--accent:#4c8dff; --accent-hover:#6aa1ff; --danger:#ff5f56; --warn:#ffb347; --ok:#3fbf6b; --text:#e6ecf3; --text-dim:#9aa7b4; --focus:0 0 0 2px rgba(76,141,255,.45);
			--radius-sm:6px; --radius:12px; --radius-lg:18px; --transition:.18s cubic-bezier(.4,0,.2,1);
			--card-min-h:150px; --grid-gap:16px; --shadow:0 4px 14px -6px rgba(0,0,0,.55);
			font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif; color:var(--text);
		}
		* {box-sizing:border-box;}
		body {margin:0; background:linear-gradient(180deg,#0d1014,#11161d); min-height:100vh; display:flex; flex-direction:column;}
		header {padding:18px 26px 10px; display:flex; flex-wrap:wrap; align-items:flex-start; gap:16px;}
		header h1 {margin:0;font-size:20px;font-weight:600;letter-spacing:.5px;background:linear-gradient(90deg,#91bdff,#c3daff);background-clip:text;-webkit-background-clip:text;color:transparent;}
		header .subtitle {margin:0 0 0 4px;font-size:14px;font-weight:400;color:var(--text-dim);letter-spacing:.3px;align-self:flex-end;padding-bottom:2px;}
		.toolbar {display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-left:auto;}
		.sync-status {display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-dim);padding:6px 10px;border-radius:var(--radius-sm);background:var(--surface-alt);}
		.sync-dot {width:8px;height:8px;border-radius:50%;background:var(--text-dim);transition:var(--transition);}
		.sync-dot.connected {background:var(--ok);box-shadow:0 0 0 2px rgba(34,197,94,.3);}
		.sync-dot.error {background:var(--danger);box-shadow:0 0 0 2px rgba(239,68,68,.3);}
		.sync-dot.connecting {background:var(--warn);animation:pulse 1.5s infinite;}
		@keyframes pulse {0%,100%{opacity:1}50%{opacity:.5}}
		button {cursor:pointer; border:1px solid var(--outline); background:var(--surface-alt); color:var(--text-dim); padding:8px 14px; font-size:13px; border-radius:var(--radius-sm); display:inline-flex; gap:6px; align-items:center; line-height:1; transition:var(--transition);}
		button:hover {border-color:var(--outline-hover); color:var(--text);} button.primary {background:var(--accent); border-color:var(--accent); color:#fff;} button.primary:hover{background:var(--accent-hover);} button.danger{background:var(--danger);border-color:var(--danger);color:#fff;} button.danger:hover{filter:brightness(1.08);} button.ghost{background:transparent;}
		input[type=text],input[type=search]{background:var(--surface);border:1px solid var(--outline);border-radius:var(--radius-sm);padding:8px 12px;color:var(--text);font-size:13px;min-width:200px;}
		input:focus{outline:none; box-shadow:var(--focus); border-color:var(--accent);} select {background:var(--surface); border:1px solid var(--outline); color:var(--text); padding:7px 10px; border-radius:var(--radius-sm); font-size:13px;} select:focus{outline:none; box-shadow:var(--focus); border-color:var(--accent);} 
		main {flex:1; display:flex; padding:0 26px 36px; gap:26px; align-items:flex-start;}
		.panel {background:var(--surface); border:1px solid var(--outline); border-radius:var(--radius-lg); padding:18px 18px 20px; width:100%; display:flex; flex-direction:column; gap:18px; box-shadow:var(--shadow); position:relative;}
		/* æ—§æµ®åŠ¨ç¼–è¾‘æŒ‰é’®æ ·å¼å·²ç§»é™¤ï¼›ç¼–è¾‘æŒ‰é’®ç°åœ¨ä¸æ¥¼å±‚è¿‡æ»¤åŒè¡Œæ˜¾ç¤º */
		.panel-header {display:flex; align-items:center; gap:14px;}
		.panel-header h2 {margin:0;font-size:16px;font-weight:600;letter-spacing:.5px;color:var(--text);} .panel-header .badge{background:var(--surface-alt);padding:4px 8px;font-size:11px;border-radius:var(--radius-sm);color:var(--text-dim);} 
		.divider{height:1px;background:var(--divider);margin:0;}
		.filters {display:flex;flex-wrap:wrap;gap:8px;}
		.filters button {padding:6px 12px;font-size:12px;border-radius:999px;background:var(--surface-alt);} .filters button[data-active='1']{background:var(--accent);color:#fff;border-color:var(--accent);} .filters button:hover{border-color:var(--outline-hover);} 
		.grid {display:grid; gap:var(--grid-gap); grid-template-columns:repeat(auto-fill,minmax(180px,1fr));}
		@media (min-width:1250px){ .grid{grid-template-columns:repeat(5,1fr);} }
		.room-card {position:relative; background:linear-gradient(150deg,#232b35,#1b2129); border:1px solid var(--outline); border-radius:var(--radius); padding:12px 12px 10px; display:flex; flex-direction:column; gap:6px; min-height:var(--card-min-h); cursor:pointer; transition:var(--transition); overflow:hidden;}
		.room-card:hover {border-color:var(--outline-hover); transform:translateY(-3px);} 
		.room-card[data-status='occupied']{
			background:linear-gradient(135deg,#2a4158 0%,#1d3245 40%,#16252f 100%); 
			border:1px solid #4a90e2; 
			box-shadow:
				0 0 0 1px rgba(74,144,226,0.4),
				0 2px 12px rgba(74,144,226,0.15),
				0 6px 25px rgba(74,144,226,0.08),
				inset 0 1px 0 rgba(255,255,255,0.05);
			position:relative;
		}
		.room-card[data-status='occupied']:hover{
			border-color:#5fa3ff;
			box-shadow:
				0 0 0 1px rgba(95,163,255,0.5),
				0 3px 16px rgba(74,144,226,0.25),
				0 8px 35px rgba(74,144,226,0.12),
				inset 0 1px 0 rgba(255,255,255,0.08);
			transform:translateY(-4px);
		}

		.room-card[data-status='preparing']{background:linear-gradient(160deg,#3d2a19,#2a1e0f); border:2px solid #f39c12; box-shadow:0 0 15px rgba(243,156,18,0.3); animation:preparing-pulse 2s infinite;} 
		.room-card[data-status='overtime']{
			background:linear-gradient(135deg,#4a2728 0%,#3d1f20 40%,#2a1415 100%); 
			border:1px solid #ff4757; 
			box-shadow:
				0 0 0 1px rgba(255,71,87,0.4),
				0 2px 12px rgba(255,71,87,0.15),
				0 6px 25px rgba(255,71,87,0.08),
				inset 0 1px 0 rgba(255,255,255,0.05);
		}
		.room-card[data-status='overtime']:hover{
			border-color:#ff6b7a;
			box-shadow:
				0 0 0 1px rgba(255,107,122,0.5),
				0 3px 16px rgba(255,71,87,0.25),
				0 8px 35px rgba(255,71,87,0.12),
				inset 0 1px 0 rgba(255,255,255,0.08);
			transform:translateY(-4px);
		}
		.room-card[data-status='empty']{background:linear-gradient(160deg,#1e242c,#181d23);} 
		.room-card[data-status='syncing']{background:linear-gradient(160deg,#1f2a3d,#1a2234); border-color:#4a90e2;} 
		.room-card.pending-operation{position:relative; pointer-events:none;} 
		.room-card.pending-operation::before{content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(74,144,226,0.1); border:2px solid #4a90e2; border-radius:var(--radius); z-index:10; animation:pulse-border 1.5s infinite;}
		
		/* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
		.edit-mode-btn{padding:6px 12px;font-size:12px;background:var(--accent);color:#fff;border-color:var(--accent);}
		.edit-mode-btn.active{background:var(--ok);border-color:var(--ok);}
		.room-card.edit-mode{position:relative;pointer-events:auto;overflow:visible;}
		.room-card.edit-mode .delete-btn{
			position:absolute;top:-8px;right:-8px;width:20px;height:20px;
			border-radius:50%;background:#ff4757;border:2px solid #fff;
			color:#fff;font-size:14px;font-weight:bold;cursor:pointer;
			display:flex;align-items:center;justify-content:center;
			z-index:15;transition:var(--transition);
		}
		.room-card.edit-mode .delete-btn:hover{background:#ff3742;transform:scale(1.1);}
		.room-card.edit-mode .edit-row{
			display:flex;align-items:center;gap:8px;margin-bottom:6px;
		}
		.room-card.edit-mode .room-name.compact{
			flex:1;min-width:0;border:1px dashed var(--outline);
			padding:4px 6px;border-radius:4px;cursor:text;
		}
		.room-card.edit-mode .piano-type-selector{
			flex-shrink:0;min-width:80px;padding:4px 6px;
			background:var(--surface);border:1px solid var(--outline);
			border-radius:4px;font-size:12px;color:var(--text);
			cursor:pointer;outline:none;transition:var(--transition);
		}
		.room-card.edit-mode .piano-type-selector:hover,
		.room-card.edit-mode .piano-type-selector:focus{
			border-color:var(--accent);background:rgba(76,141,255,0.05);
		}
		.room-card.edit-mode .room-name{border:1px dashed var(--outline);padding:4px 6px;border-radius:4px;cursor:text;}
		.room-card.edit-mode .remark{border:1px dashed var(--outline);padding:4px 6px;border-radius:4px;cursor:text;min-height:24px;}
		.room-card.edit-mode .room-name:hover,.room-card.edit-mode .remark:hover{border-color:var(--accent);background:rgba(76,141,255,0.05);}
		.room-card.edit-mode .room-name.compact:hover{border-color:var(--accent);background:rgba(76,141,255,0.05);}
		.add-room-btn{
			background: linear-gradient(135deg, var(--ok) 0%, #2ecc71 100%);
			color: #fff;
			border: 1px solid var(--ok);
			margin-left: 8px;
			font-size: 12px;
			padding: 6px 12px;
			border-radius: 6px;
			font-weight: 600;
			display: inline-flex;
			align-items: center;
			gap: 4px;
			box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
			transition: all 0.2s ease;
		}
		.add-room-btn:hover{
			background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
			border-color: #2ecc71;
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
		}
		.add-room-btn:active {
			transform: translateY(0);
			box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
		}
		
		/* === æ–°å¢ç´æˆ¿æ¨¡æ€æ¡†ä¸“ç”¨æ ·å¼ === */
		.add-room-modal .modal-header {
			background: linear-gradient(135deg, var(--surface-alt) 0%, #2c3e50 100%);
			border-bottom: 1px solid var(--outline);
		}
		.add-room-modal .modal-header h3 {
			color: var(--text);
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.add-room-modal .modal-header h3::before {
			content: "ğŸ¹";
			font-size: 18px;
		}
		.add-room-modal .form-grid {
			display: grid;
			gap: 18px;
		}
		.add-room-modal .form-field {
			display: flex;
			flex-direction: column;
			gap: 6px;
		}
		.add-room-modal .form-field label {
			font-size: 13px;
			font-weight: 600;
			color: var(--text);
			display: flex;
			align-items: center;
			gap: 6px;
		}
		.add-room-modal .form-field label .required {
			color: var(--danger);
			font-weight: bold;
		}
		.add-room-modal .form-field label .icon {
			font-size: 14px;
			opacity: 0.7;
		}
		.add-room-modal input,
		.add-room-modal select,
		.add-room-modal textarea {
			font-size: 14px;
			padding: 10px 12px;
			border: 1px solid var(--outline);
			border-radius: 8px;
			background: var(--surface);
			color: var(--text);
			transition: all 0.2s ease;
		}
		.add-room-modal input:focus,
		.add-room-modal select:focus,
		.add-room-modal textarea:focus {
			outline: none;
			border-color: var(--accent);
			box-shadow: 0 0 0 3px rgba(76, 141, 255, 0.1);
			background: var(--surface-alt);
		}
		.add-room-modal textarea {
			resize: vertical;
			min-height: 60px;
			font-family: inherit;
			line-height: 1.4;
		}
		.add-room-modal .piano-type-display {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 8px;
			margin-top: 4px;
		}
		.add-room-modal .piano-type-option {
			padding: 8px 12px;
			border: 1px solid var(--outline);
			border-radius: 6px;
			background: var(--surface-alt);
			color: var(--text-dim);
			text-align: center;
			font-size: 12px;
			cursor: pointer;
			transition: all 0.2s ease;
		}
		.add-room-modal .piano-type-option:hover {
			border-color: var(--accent);
			background: var(--accent-fade, rgba(76, 141, 255, 0.1));
		}
		.add-room-modal .piano-type-option.selected {
			background: var(--accent);
			color: #fff;
			border-color: var(--accent);
			font-weight: 600;
		}
		.add-room-modal .modal-footer {
			background: var(--surface-alt);
			border-top: 1px solid var(--outline);
			padding: 16px 20px;
		}
		.add-room-modal .modal-footer button {
			padding: 10px 20px;
			font-size: 14px;
			font-weight: 600;
			border-radius: 8px;
			transition: all 0.2s ease;
		}
		.add-room-modal .form-field.error input,
		.add-room-modal .form-field.error select,
		.add-room-modal .form-field.error textarea {
			border-color: var(--danger);
			background: rgba(255, 77, 77, 0.05);
		}
		.add-room-modal .form-field.error label {
			color: var(--danger);
		}
		.add-room-modal .error-message {
			color: var(--danger);
			font-size: 12px;
			margin-top: 4px;
			display: flex;
			align-items: center;
			gap: 4px;
		}
		.add-room-modal .error-message::before {
			content: "âš ï¸";
			font-size: 10px;
		}
		.floor-filter-edit{position:relative;}
		.floor-filter-edit .add-floor-btn{
			position:absolute;right:-30px;top:50%;transform:translateY(-50%);
			width:24px;height:24px;border-radius:50%;background:var(--ok);
			color:#fff;font-size:16px;cursor:pointer;border:none;
			display:flex;align-items:center;justify-content:center;
		}
		.editable-input{
			background:var(--surface);border:1px solid var(--accent);
			border-radius:4px;padding:4px 6px;font-size:inherit;
			color:var(--text);width:100%;outline:none;
		}
		
		@keyframes pulse-border { 0%, 100% { border-color: #4a90e2; opacity: 0.8; } 50% { border-color: #7fb1ff; opacity: 1; } }
		@keyframes preparing-pulse { 0%, 100% { border-color: #f39c12; box-shadow: 0 0 15px rgba(243,156,18,0.3); } 50% { border-color: #e67e22; box-shadow: 0 0 25px rgba(243,156,18,0.5), 0 0 35px rgba(243,156,18,0.2); } } 
		.room-name {font-size:15px;font-weight:600;letter-spacing:.5px; display:flex;align-items:center; gap:6px; color:var(--text);} .pill {font-size:10px;padding:2px 6px;border-radius:6px;background:var(--surface-alt);color:var(--text-dim); font-weight:500; letter-spacing:.3px;transition:var(--transition);}
		.pill-grand {background:linear-gradient(135deg,#3b82f6,#1e40af);color:#fff;box-shadow:0 1px 3px rgba(59,130,246,0.3);}
		.pill-upright {background:linear-gradient(135deg,#10b981,#059669);color:#fff;box-shadow:0 1px 3px rgba(16,185,129,0.3);}
		.pill-other {background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;box-shadow:0 1px 3px rgba(139,92,246,0.3);}
		.room-card:hover .pill-grand {box-shadow:0 2px 6px rgba(59,130,246,0.5);}
		.room-card:hover .pill-upright {box-shadow:0 2px 6px rgba(16,185,129,0.5);}
		.room-card:hover .pill-other {box-shadow:0 2px 6px rgba(139,92,246,0.5);}
		.remark {font-size:11px;color:var(--text-dim); line-height:1.3; max-height:30px; overflow:hidden;text-overflow:ellipsis;}
		.occupant-line {display:flex;align-items:center; gap:6px; font-size:13px; font-weight:500; color:#fff; margin-top:2px; white-space:nowrap;overflow:hidden;}
		.dot {width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 3px rgba(76,141,255,.25);} 
		.status-row {margin-top:auto; display:flex; align-items:center; justify-content:space-between; gap:8px;}
		.chip {font-size:11px; padding:3px 8px; border-radius:8px; background:var(--surface-alt); color:var(--text-dim); font-weight:500; letter-spacing:.3px; line-height:1;}
		.chip.accent{color:var(--accent);} .chip.warn{color:var(--warn);} .chip.good{color:var(--ok);} .chip.danger{color:var(--danger);} 
		.chip.preparing{background:linear-gradient(135deg,#f39c12,#e67e22); color:#fff; font-weight:600; text-shadow:0 1px 2px rgba(0,0,0,0.3); box-shadow:0 2px 8px rgba(243,156,18,0.4); animation:chip-glow 2s infinite; position:relative;}
		.chip.preparing::before{content:'âš¡'; margin-right:3px; animation:preparing-icon 1.5s infinite;}
		@keyframes chip-glow { 0%, 100% { box-shadow: 0 2px 8px rgba(243,156,18,0.4); } 50% { box-shadow: 0 2px 15px rgba(243,156,18,0.7), 0 0 20px rgba(243,156,18,0.3); } }
		@keyframes preparing-icon { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } } 
		.actions {display:flex;gap:4px;} .actions button {padding:4px 7px; font-size:11px; background:var(--surface-alt);} .actions button.primary{background:var(--accent);color:#fff;border-color:var(--accent);} .actions button.primary:hover{background:var(--accent-hover);} .actions button.danger{background:var(--danger);border-color:var(--danger);} 
		/* === å¯è¯»æ€§å¢å¼ºè¦†ç›–æ ·å¼ === */
		.room-card{color:#dbe5ef;}
		.room-card .room-name{font-weight:600; letter-spacing:.5px; color:#ffffff; text-shadow:0 1px 2px rgba(0,0,0,.4);} 
		.room-card .occupant-line span:last-child{font-weight:600; color:#fff;}
		
		/* === ç©ºé—²çŠ¶æ€é‡æ–°è®¾è®¡ - æ ¹æ®é’¢ç´ç±»å‹æ˜¾ç¤ºä¸åŒé¢œè‰² === */
		/* é»˜è®¤ç©ºé—²çŠ¶æ€ï¼ˆå…¶ä»–ç±»å‹ï¼‰ - ç´«è‰²ï¼Œä¸åˆ†å‰²çº¿ä¿æŒä¸€è‡´ */
		.room-card.empty{
			background:linear-gradient(135deg, #241530 0%, #322038 35%, #1c1625 100%);
			border:1px solid #604d85; 
			box-shadow:
				0 0 0 1px rgba(120,50,160,0.25),
				0 2px 12px -2px rgba(0,0,0,0.65),
				0 6px 22px -8px rgba(0,0,0,0.7),
				inset 0 0 0 1px rgba(255,255,255,0.03),
				inset 0 4px 18px -6px rgba(130,70,180,0.08);
			filter:saturate(.88) brightness(.85);
		}
		.room-card.empty:hover{
			border-color:#7a65a8;
			background:linear-gradient(135deg, #322038 0%, #3d2a45 35%, #241a30 100%);
			box-shadow:
				0 0 0 1px rgba(140,60,180,0.35),
				0 6px 18px -6px rgba(0,0,0,0.7),
				0 10px 38px -12px rgba(0,0,0,0.65),
				inset 0 1px 0 rgba(255,255,255,0.06),
				inset 0 4px 22px -8px rgba(130,70,180,0.12);
			transform:translateY(-3px);
		}
		
		/* ä¸‰è§’é’¢ç´ç©ºé—²çŠ¶æ€ - è“è‰² */
		.room-card.empty[data-grand="1"]{
			background:linear-gradient(135deg, #152030 0%, #202f38 35%, #141c25 100%);
			border:1px solid #4d6085;
			box-shadow:
				0 0 0 1px rgba(76,135,215,0.25),
				0 2px 12px -2px rgba(0,0,0,0.65),
				0 6px 22px -8px rgba(0,0,0,0.7),
				inset 0 0 0 1px rgba(255,255,255,0.03),
				inset 0 4px 18px -6px rgba(76,135,215,0.08);
		}
		.room-card.empty[data-grand="1"]:hover{
			border-color:#6078c8;
			background:linear-gradient(135deg, #202f38 0%, #2a3845 35%, #181f30 100%);
			box-shadow:
				0 0 0 1px rgba(76,135,215,0.35),
				0 6px 18px -6px rgba(0,0,0,0.7),
				0 10px 38px -12px rgba(0,0,0,0.65),
				inset 0 1px 0 rgba(255,255,255,0.06),
				inset 0 4px 22px -8px rgba(76,135,215,0.12);
		}
		
		/* ç«‹å¼é’¢ç´ç©ºé—²çŠ¶æ€ - ç»¿è‰² */
		.room-card.empty[data-grand="0"]{
			background:linear-gradient(135deg, #153025 0%, #203830 35%, #141c1a 100%);
			border:1px solid #2aa876;
			box-shadow:
				0 0 0 1px rgba(42,168,118,0.25),
				0 2px 12px -2px rgba(0,0,0,0.65),
				0 6px 22px -8px rgba(0,0,0,0.7),
				inset 0 0 0 1px rgba(255,255,255,0.03),
				inset 0 4px 18px -6px rgba(42,168,118,0.08);
		}
		.room-card.empty[data-grand="0"]:hover{
			border-color:#3ec490;
			background:linear-gradient(135deg, #203830 0%, #2a4538 35%, #181f25 100%);
			box-shadow:
				0 0 0 1px rgba(42,168,118,0.35),
				0 6px 18px -6px rgba(0,0,0,0.7),
				0 10px 38px -12px rgba(0,0,0,0.65),
				inset 0 1px 0 rgba(255,255,255,0.06),
				inset 0 4px 22px -8px rgba(42,168,118,0.12);
		} 
		/* ç©ºé—²ç†„ç­ chip æ ·å¼ */
		.chip-dim[data-empty="1"]{
			background:linear-gradient(135deg,rgba(70,90,80,0.25),rgba(40,55,48,0.18));
			color:#d9e7dd; 
			font-weight:500;
			letter-spacing:.4px;
			border:1px solid rgba(120,170,150,0.25);
			box-shadow:0 1px 2px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.02);
			text-shadow:0 1px 2px rgba(0,0,0,0.45);
			filter:brightness(.95) saturate(.9);
		}
		.room-card.empty .status-row .chip-dim[data-empty="1"]:hover{background:linear-gradient(135deg,rgba(90,115,100,0.3),rgba(50,70,60,0.25));}
		/* ç©ºé—²çŠ¶æ€æ–‡å­—å¢å¼º */
		.room-card.empty .room-name{
			color:#f2f7f5; 
			text-shadow:0 1px 3px rgba(0,0,0,0.55);
			font-weight:650;
			letter-spacing:.6px;
		}
		.room-card.empty .remark{
			color:#b7c9c0; 
			opacity:.85;
		} 
		.room-card.empty .occupant-line{display:none;}
		/* ä¸å ç”¨äº®èµ·å¯¹åº”ï¼šå ç”¨æˆ¿ä¿æŒé²œè‰³ï¼›ç©ºé—²æå‡äº®åº¦ */
		.room-card[data-status='occupied']{filter:saturate(1.05) brightness(1.03);} 
		.room-card[data-status='empty']{filter:saturate(1.1) brightness(1.1);} 
		.room-card[data-status='empty']:hover{filter:saturate(1.15) brightness(1.15);} 
		.room-card .status-row .chip{filter:brightness(1.05);} 
		.room-card[data-status='overtime'] .chip.danger{background:rgba(255,77,77,0.18); box-shadow:0 0 0 1px rgba(255,77,77,0.35);} 
		.room-card[data-status='preparing'] .chip.preparing{background:rgba(243,156,18,0.15); color:#ffb347;} 
		.room-card .actions button{filter:brightness(1.1);} 
		.room-card:hover .actions button.primary{box-shadow:0 0 0 1px rgba(0,140,255,0.4);} 
		/* æ›´äº®çš„æ–‡æœ¬ä¸è¾…åŠ©è¯´æ˜ */
		body{--text:#d9e2ec; --text-dim:#90a4b8;}
		/* ç§»é™¤ç©ºé—²å¡ç‰‡çš„é€æ˜åº¦è®¾ç½®ï¼Œè®©å…¶ä¿æŒæ­£å¸¸å¯è§åº¦ */
		.meta-bar {display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
		.meta-stat {font-size:12px; color:var(--text-dim); display:flex; gap:4px; align-items:center;}
		.searchbox {position:relative;}
		.searchbox input {min-width:260px; padding-left:34px;}
		.searchbox svg {position:absolute; top:50%; left:10px; width:16px; height:16px; transform:translateY(-50%); stroke:var(--text-dim);} 
		.inline-search-results{position:absolute; top:100%; left:0; margin-top:6px; width:480px; max-width:70vw; background:var(--surface); border:1px solid var(--outline); border-radius:14px; box-shadow:0 8px 28px -10px rgba(0,0,0,.4); padding:10px 0; display:flex; flex-direction:column; max-height:420px; overflow:auto; z-index:60; backdrop-filter:blur(6px);} 
		.inline-search-results .group-title{font-size:11px; font-weight:600; color:var(--text-dim); padding:4px 14px 6px; letter-spacing:.5px;}
		.inline-search-results .result-item{padding:8px 14px; display:flex; justify-content:space-between; gap:12px; line-height:1.2; cursor:pointer; font-size:13px; border-left:3px solid transparent; transition:var(--transition);} 
		.inline-search-results .result-item:hover{background:var(--surface-alt); border-left-color:var(--accent);}
		.inline-search-results .result-item .meta{font-size:11px; color:var(--text-dim);} 
		.inline-search-results .result-item .occ-info{margin-left:6px; font-size:11px; padding:2px 6px; border-radius:10px; background:var(--surface-alt); display:inline-flex; align-items:center; gap:4px; font-weight:500;}
		.inline-search-results .result-item .occ-info .icon{font-size:12px;}
		.inline-search-results .result-item .occ-info.preparing{background:#ffe9c8;color:#a45b00;}
		.inline-search-results .result-item .occ-info.occupied{background:#d8eefc;color:#0a5b85;}
		.inline-search-results .result-item .occ-info.overtime{background:#ffe0e0;color:#b40000;}
		.inline-search-results .result-item .occ-info .dur{opacity:.8;}
		.inline-search-results .empty{padding:20px 16px; text-align:center; font-size:12px; color:var(--text-dim);} 
		.inline-search-results .result-item.room{--icon:"ğŸ¹";} 
		.inline-search-results .highlight{color:var(--accent); font-weight:600;}
		/* ==== ç±»å‹åˆ†éš”çº¿ ==== */
		.room-type-separator{grid-column:1/-1;display:flex;align-items:center;gap:14px;margin:14px 2px 6px;position:relative;}
		.room-type-separator .line{flex:1;height:1px;background:linear-gradient(90deg,transparent,var(--outline),transparent);}
		.room-type-separator .label{font-size:11px;letter-spacing:1px;font-weight:600;color:var(--text-dim);text-transform:uppercase;padding:4px 10px;border:1px solid var(--outline);border-radius:30px;background:var(--surface-alt);backdrop-filter:blur(4px);}
		.room-type-separator.grand .label{color:#60a5ff;border-color:#3d5e82;background:linear-gradient(120deg,rgba(30,50,70,.35),rgba(20,30,40,.4));}
		.room-type-separator.upright .label{color:#34d399;border-color:#245f45;background:linear-gradient(120deg,rgba(24,60,48,.35),rgba(18,32,26,.4));}
		.room-type-separator.other .label{color:#c084fc;border-color:#553a7a;background:linear-gradient(120deg,rgba(55,35,80,.35),rgba(35,25,50,.4));}
		/* ===== æ ‡é¢˜ä½“ç³» ===== */
		.app-title{display:flex;flex-direction:column;gap:6px;margin-bottom:8px;}
		.title-line{display:flex;align-items:baseline;flex-wrap:wrap;gap:10px;}
		.title-line.main{font-size:22px;font-weight:600;letter-spacing:.5px;}
		.title-line.main .brand{background:linear-gradient(120deg,#cfd9e5,#ffffff);background-clip:text;-webkit-background-clip:text;color:transparent;font-weight:700;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));}
		.title-line.main .divider{color:var(--text-dim);font-weight:400;opacity:.6;}
		.title-line.main .module{color:var(--accent);font-weight:600;position:relative;}
		.title-line.main .module:after{content:"";position:absolute;left:0;bottom:-4px;width:100%;height:2px;background:linear-gradient(90deg,var(--accent),transparent);opacity:.5;border-radius:2px;}
		.title-line.sub{font-size:11px;font-weight:500;letter-spacing:.8px;color:var(--text-dim);text-transform:uppercase;gap:6px;}
		.tag{padding:2px 8px;border-radius:20px;display:inline-flex;align-items:center;gap:4px;font-size:10px;line-height:1.2;letter-spacing:.5px;font-weight:600;position:relative;}
		.tag.beta{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;box-shadow:0 2px 8px -2px rgba(99,102,241,.5);}
		.tag.env{background:linear-gradient(135deg,#0ea5e9,#3b82f6);color:#fff;}
		@media (max-width:720px){
			.title-line.main{font-size:18px;}
			.title-line.sub{font-size:10px;}
		}
		header h1, header h2.subtitle{display:none !important;}
		.side {width:340px; display:flex; flex-direction:column; gap:24px;}
		.section-title {font-size:13px;font-weight:600;color:var(--text-dim);letter-spacing:.5px;margin:0 0 8px;}
		.import-box {background:var(--surface);border:1px dashed var(--outline); border-radius:var(--radius); padding:14px; display:flex; flex-direction:column; gap:10px;}
		.import-box input {width:100%;}
		.list-small {max-height:220px; overflow:auto; font-size:12px; line-height:1.4; background:var(--surface-alt); padding:8px 10px; border:1px solid var(--outline); border-radius:var(--radius-sm);} .list-small code{font-size:11px;}
		.toast {position:fixed; bottom:24px; right:24px; background:#222c36; color:#fff; padding:10px 16px; border-radius:10px; font-size:13px; box-shadow:0 6px 18px -8px #000; display:flex; gap:10px; align-items:center; animation:fadeIn .3s;} @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
		.modal-backdrop {position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:100;}
		.modal {background:var(--surface); border:1px solid var(--outline); width:480px; max-width:92%; border-radius:18px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 12px 40px -16px rgba(0,0,0,.7);} .modal-header{padding:16px 20px; display:flex; align-items:center; justify-content:space-between; background:var(--surface-alt);} .modal-header h3{margin:0;font-size:15px;font-weight:600;} .modal-body{padding:16px 20px; display:flex; flex-direction:column; gap:14px; max-height:60vh; overflow:auto;} .modal-footer{padding:14px 20px; display:flex; gap:10px; justify-content:flex-end; background:var(--surface-alt);} 
		/* æ”¾å¤§å­¦ç”Ÿé€‰æ‹©å¼¹çª—ï¼šåœ¨ç‰¹å®š backdrop ä¸‹ä½œç”¨ï¼Œé¿å…å½±å“æ–°å¢æˆ¿é—´å¼¹çª— */
		#studentModalBackdrop .modal { width:760px; max-width:94%; border-radius:22px; }
		#studentModalBackdrop .modal-header{ padding:22px 28px 18px; }
		#studentModalBackdrop .modal-header h3{ font-size:19px; letter-spacing:.6px; font-weight:650; }
		#studentModalBackdrop .modal-body{ padding:10px 28px 24px; gap:18px; max-height:68vh; }
		#studentModalBackdrop .modal-footer{ padding:18px 28px 22px; }
		#studentModalBackdrop input#studentSearch{ font-size:16px; padding:14px 16px; border-radius:14px; }
		#studentModalBackdrop .student-list{ --item-gap:10px; display:flex; flex-direction:column; gap:var(--item-gap); font-size:15px; line-height:1.5; }
		#studentModalBackdrop .student-list .stu-item{ padding:10px 14px 11px; font-size:15px; border-radius:12px; }
		#studentModalBackdrop .student-list .stu-item strong{ font-size:15px; font-weight:600; }
		#studentModalBackdrop .student-list .stu-item small{ font-size:12px; opacity:.85; }
		#studentModalBackdrop button{ font-size:14px; }
		#studentModalBackdrop .ghost{ font-size:14px; }
		/* ==== å­¦ç”Ÿå ç”¨æ˜¾ç¤ºå¢å¼º ==== */
		#studentModalBackdrop .student-list .student-item{display:flex; align-items:center; flex-wrap:wrap; gap:14px; background:linear-gradient(145deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.05);} 
		#studentModalBackdrop .student-list .student-item{justify-content:space-between;}
		#studentModalBackdrop .student-list .student-item .stu-name{flex:0 0 auto; min-width:100px; font-weight:600; letter-spacing:.4px;}
		#studentModalBackdrop .student-list .student-item .col-left{display:flex; align-items:center; gap:12px; flex:1 1 auto; min-width:320px;}
		#studentModalBackdrop .student-list .student-item .col-right{display:flex; align-items:center; gap:14px; justify-content:flex-end; flex:0 0 auto; min-width:240px;}
		#studentModalBackdrop .student-list .student-item .col-right .state-tag{margin-left:2px;}
		/* ç¦ç”¨æ—§ info-col å¸ƒå±€ï¼ˆè‹¥æ®‹ç•™ï¼‰ */
		#studentModalBackdrop .student-list .student-item .info-col{display:none !important;}
		/* ç´§å‡‘æ¨¡å¼ï¼šåœ¨è¾ƒçª„å±å¹•è‡ªåŠ¨å›é€€ä¸ºæ¨ªå‘å•è¡Œ */
		@media (max-width:900px){
			#studentModalBackdrop .student-list .student-item{flex-direction:column; align-items:flex-start; gap:10px;}
			#studentModalBackdrop .student-list .student-item .col-left{flex-wrap:wrap; min-width:auto;}
			#studentModalBackdrop .student-list .student-item .col-right{width:100%; justify-content:flex-start; flex-wrap:wrap;}
		}
		#studentModalBackdrop .student-list .student-item:hover{background:linear-gradient(145deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03)); border-color:rgba(255,255,255,0.15);} 
		#studentModalBackdrop .student-list .student-item.kb-selected{border-color:var(--accent); box-shadow:0 0 0 1px var(--accent), 0 4px 14px -4px rgba(0,123,255,0.35);} 
		/* å·²ç§»é™¤çºµå‘ç»“æ„ï¼Œä¿æŒå…¼å®¹ */
		#studentModalBackdrop .student-list .student-item .stu-line-main{display:contents;}
		#studentModalBackdrop .student-list .student-item .stu-name{font-weight:600; letter-spacing:.4px;}
		#studentModalBackdrop .student-list .student-item .stu-line-sub{display:contents;}
		#studentModalBackdrop .student-list .student-item .tag.major{background:rgba(59,130,246,0.12); color:#7fb3ff;}
		#studentModalBackdrop .student-list .student-item .tag.grade{background:rgba(120,160,255,0.12); color:#b0c8ff;}
		#studentModalBackdrop .student-list .student-item .room-tag{padding:2px 8px; font-size:11px; border-radius:20px; background:linear-gradient(135deg,#2d3e52,#1e2a38); color:#aad4ff; letter-spacing:.4px; position:relative; top:-1px; box-shadow:0 1px 3px rgba(0,0,0,.4), inset 0 0 0 1px rgba(255,255,255,0.05);} 
		#studentModalBackdrop .student-list .student-item .room-tag::before{content:'æˆ¿'; font-size:10px; margin-right:4px; opacity:.8;}
		#studentModalBackdrop .student-list .student-item .state-tag{padding:2px 8px; font-size:11px; border-radius:16px; background:rgba(255,255,255,0.07); color:#d2dee8; letter-spacing:.4px; font-weight:500; box-shadow:0 1px 2px rgba(0,0,0,.4);}
		#studentModalBackdrop .student-list .student-item .state-tag.st-preparing{background:linear-gradient(135deg,#f39c12,#e67e22); color:#fff; font-weight:600;}
		#studentModalBackdrop .student-list .student-item .state-tag.st-occupied{background:linear-gradient(135deg,#0052d4,#4364f7); color:#fff; font-weight:600;}
		#studentModalBackdrop .student-list .student-item .state-tag.st-overtime{background:linear-gradient(135deg,#ff4d4d,#c62828); color:#fff; font-weight:600;}
		#studentModalBackdrop .student-list .student-item .state-tag.st-empty{background:rgba(255,255,255,0.12); color:#bcd;}
		/* é”®ç›˜é«˜äº®/hover æå‡å±‚æ¬¡ */
		#studentModalBackdrop .student-list .stu-item.hover, 
		#studentModalBackdrop .student-list .stu-item:focus-visible{ outline:2px solid var(--accent); outline-offset:1px; }
		/* å“åº”å¼ä¿æŠ¤ */
		@media (max-width:900px){
			#studentModalBackdrop .modal{ width:94%; }
			#studentModalBackdrop .modal-body{ max-height:70vh; }
		}
		.student-list {display:flex; flex-direction:column; gap:6px;} .student-item{background:var(--surface-alt); padding:6px 10px; border:1px solid var(--outline); border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-size:13px; transition:var(--transition);} .student-item:hover{border-color:var(--accent); color:var(--text);} .student-item .tag{font-size:11px; color:var(--text-dim);} .student-item.disabled{opacity:.45;pointer-events:none;} .student-item.kb-selected{border-color:var(--accent); background:var(--accent-fade,#2d6cdf22);} .student-item.kb-selected span:first-child{font-weight:600;}
		.muted{color:var(--text-dim);} .danger{color:var(--danger);} .warn{color:var(--warn);} .accent{color:var(--accent);} 
		footer {padding:18px 26px 34px; font-size:11px; text-align:center; color:var(--text-dim);} a{color:var(--accent); text-decoration:none;} a:hover{text-decoration:underline;}
	</style>
</head>
<body>
<div id="topLogout" style="position:fixed;top:10px;right:14px;z-index:1500;display:none;">
	<button id="logoutBtn" style="background:rgba(40,50,60,.55);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);color:#d8e2ea;font-size:12px;padding:6px 14px;border-radius:8px;cursor:pointer;letter-spacing:.5px;">é€€å‡º</button>
</div>
	<header>
		<div class="app-title">
			<div class="title-line main" aria-label="é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ ç´æˆ¿ç®¡ç†ç³»ç»Ÿ">
				<span class="brand">é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡</span>
				<span class="divider">Â·</span>
				<span class="module">ç´æˆ¿ç®¡ç†ç³»ç»Ÿ</span>
			</div>
			<div class="title-line sub">
				<span class="tag beta">v2</span>
				<span class="tag env">å®æ—¶åŒæ­¥å¯ç”¨</span>
			</div>
		</div>
		<div class="searchbox">
			<svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>
			<input id="globalSearch" type="search" placeholder="æœç´¢å­¦ç”Ÿ / ç´æˆ¿ (æ”¯æŒæ‹¼éŸ³é¦–å­—æ¯)" />
			<div id="inlineSearchResults" class="inline-search-results" style="display:none;"></div>
		</div>
		<div class="toolbar">
			<div class="sync-status" id="syncStatus">
				<div class="sync-dot" id="syncDot"></div>
				<span id="syncText">ç¦»çº¿</span>
			</div>
			<button id="btnImportStudents" class="ghost">å¯¼å…¥å­¦ç”Ÿ</button>
			<button id="btnSyncToCloud" class="ghost">åŒæ­¥åˆ°äº‘ç«¯</button>
			<button id="btnReconnect" class="ghost" style="display: none;">é‡æ–°è¿æ¥</button>
			<button id="btnRefresh" class="ghost">åˆ·æ–°</button>
			<button id="btnBulkTime" class="ghost">è€ƒå‹¤æ—¶é—´æ®µ</button>
		</div>
	</header>
	<main>
		<div class="panel" id="panelRooms">
			<div class="panel-header">
				<h2>ç´æˆ¿åˆ—è¡¨</h2>
				<div class="badge" id="statUsage">åŠ è½½ä¸­...</div>
			</div>
			<div class="meta-bar">
				<div class="filters" id="floorFilters"></div>
				<div class="filters" id="typeFilters"></div>
				<div style="margin-left:auto;display:flex;align-items:center;gap:10px;">
					<button id="btnEditRooms" class="edit-mode-btn" title="ç¼–è¾‘ç´æˆ¿" style="padding:6px 14px;">ç¼–è¾‘</button>
				</div>
				<div class="meta-stat" id="metaCounts"></div>
			</div>
			<hr class="divider"/>
			<div class="grid" id="roomGrid"></div>
		</div>
		<div class="side">

			<div>
				<p class="section-title">è¿è¡ŒçŠ¶æ€</p>
				<div class="list-small" id="runtimeInfo"></div>
			</div>
			<div style="margin-top:22px;">
				<p class="section-title" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
					<span>é‡è¦æé†’</span>
					<span class="alert-filters" style="display:flex;gap:6px;flex-wrap:wrap;">
						<button class="alert-filter-btn act" data-filter="all">å…¨éƒ¨</button>
						<button class="alert-filter-btn" data-filter="absent">ç¼ºå‹¤</button>
						<button class="alert-filter-btn" data-filter="anomaly">å¼‚å¸¸</button>
					</span>
				</p>
				<div id="alertList" class="list-small alert-empty" style="max-height:680px;overflow:auto;display:flex;flex-direction:column;gap:10px;"></div>
			</div>
		</div>
	</main>
	<footer>Â© 2025 é’å²›è€¶èƒ¡è¿ªæ¢…çº½å› å­¦æ ¡ ç´æˆ¿ç®¡ç†ç³»ç»Ÿ Â· Demo ç‰ˆæœ¬ Â· <a href="https://supabase.com" target="_blank" rel="noopener">Supabase</a></footer>

	<!-- æ‰¹é‡æ—¶é—´æ®µç®¡ç† Modal -->
	<div id="bulkTimeManagerModal" style="display:none;position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);">
		<div class="btm-wrapper">
			<div class="btm-header">
				<div class="btm-title">æ‰¹é‡æ—¶é—´æ®µç®¡ç†</div>
				<div class="btm-actions">
					<button class="btm-btn btm-secondary" id="btmPrevBtn">ä¸Šä¸€ä½</button>
					<button class="btm-btn btm-secondary" id="btmNextBtn">ä¸‹ä¸€ä½</button>
					<button class="btm-btn btm-danger" id="btmClearAllBtn">æ¸…ç©ºå…¨éƒ¨</button>
					<button class="btm-btn btm-primary" id="btmSaveBtn">ä¿å­˜</button>
					<button class="btm-btn btm-secondary" id="btmCloseBtn">å…³é—­</button>
				</div>
			</div>
			<div class="btm-body">
				<div class="btm-left">
					<div class="btm-student-bar" style="display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
						<select id="btmStudentSelect" class="btm-select" style="min-width:220px;"></select>
						<input id="btmSearchInput" placeholder="æœç´¢å§“å / æ‹¼éŸ³" class="btm-select" style="flex:1;min-width:180px;" />
					</div>
					<div id="btmStudentInfo" class="btm-stu-info"></div>
					<div class="btm-legend">
						<span>å•å‡»é€‰æ‹©/å–æ¶ˆ</span>
						<span>ç°è‰² = ä¼‘æ¯/åˆé¤</span>
						<span>ä¿å­˜å†™å…¥ student_time_slots</span>
					</div>
					<div class="btm-table-wrap">
						<table class="btm-table">
							<thead>
								<tr><th class="btm-time-col">æ—¶é—´</th><th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th></tr>
							</thead>
							<tbody id="btmTbody"></tbody>
						</table>
					</div>
				</div>
				<div class="btm-right">
					<div class="btm-summary-title">å½“å‰å­¦ç”Ÿé€‰ä¸­èŠ‚æ¬¡</div>
					<div id="btmSelectedList" class="btm-selected-list"></div>
					<div class="btm-note">è¯´æ˜ï¼šä¿å­˜è¦†ç›–è¯¥å­¦ç”Ÿæœ¬å‘¨(å‘¨ä¸€-å‘¨äº”)æ—¢æœ‰æ—¶é—´æ®µã€‚</div>
				</div>
			</div>
		</div>
	</div>

	<!-- å­¦ç”Ÿé€‰æ‹© Modal -->
	<div class="modal-backdrop" id="studentModalBackdrop" style="display:none;">
		<div class="modal" role="dialog" aria-modal="true" aria-labelledby="studentModalTitle">
			<div class="modal-header">
				<h3 id="studentModalTitle">é€‰æ‹©å­¦ç”Ÿ</h3>
				<button id="btnCloseStudentModal" class="ghost" style="padding:4px 8px;">âœ•</button>
			</div>
			<div class="modal-body">
				<input id="studentSearch" type="text" placeholder="æŒ‰å§“å / æ‹¼éŸ³é¦–å­—æ¯ / ä¸“ä¸šè¿‡æ»¤" />
				<div class="student-list" id="studentList"></div>
			</div>
			<div class="modal-footer">
				<button id="btnStudentModalCancel" class="ghost">å–æ¶ˆ</button>
			</div>
		</div>
	</div>

	<!-- æ–°å¢æˆ¿é—´ Modal -->
	<div class="modal-backdrop" id="addRoomModalBackdrop" style="display:none;">
		<div class="modal add-room-modal" role="dialog" aria-modal="true" aria-labelledby="addRoomModalTitle">
			<div class="modal-header">
				<h3 id="addRoomModalTitle">æ–°å¢ç´æˆ¿</h3>
				<button id="btnCloseAddRoomModal" class="ghost" style="padding:4px 8px;">âœ•</button>
			</div>
			<div class="modal-body">
				<div class="form-grid">
					<div class="form-field">
						<label>
							<span class="icon">ğŸ·ï¸</span>
							æˆ¿é—´åç§°
							<span class="required">*</span>
						</label>
						<input id="addRoomName" type="text" placeholder="ä¾‹å¦‚ï¼š101ã€ç´æˆ¿A" />
					</div>
					<div class="form-field">
						<label>
							<span class="icon">ğŸ“</span>
							ä½ç½®
						</label>
						<input id="addRoomLocation" type="text" placeholder="ä¾‹å¦‚ï¼š1æ¥¼ã€éŸ³ä¹æ¥¼äºŒå±‚" />
					</div>
					<div class="form-field">
						<label>
							<span class="icon">ğŸ¼</span>
							é’¢ç´ç±»å‹
						</label>
						<div class="piano-type-display">
							<div class="piano-type-option" data-type="ç«‹å¼">ç«‹å¼é’¢ç´</div>
							<div class="piano-type-option selected" data-type="ä¸‰è§’">ä¸‰è§’é’¢ç´</div>
							<div class="piano-type-option" data-type="å…¶ä»–">å…¶ä»–</div>
						</div>
						<select id="addRoomPianoType" style="display:none;">
							<option value="ç«‹å¼">ç«‹å¼</option>
							<option value="ä¸‰è§’">ä¸‰è§’</option>
							<option value="å…¶ä»–">å…¶ä»–</option>
						</select>
					</div>
					<div class="form-field">
						<label>
							<span class="icon">ğŸ“</span>
							å¤‡æ³¨
						</label>
						<textarea id="addRoomRemark" placeholder="å¯é€‰ï¼šè®¾å¤‡è¯´æ˜ã€ä½¿ç”¨æ³¨æ„äº‹é¡¹ç­‰"></textarea>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button id="btnAddRoomCancel" class="ghost">å–æ¶ˆ</button>
				<button id="btnAddRoomConfirm" class="primary">åˆ›å»ºç´æˆ¿</button>
			</div>
		</div>
	</div>

	<!-- Toast å®¹å™¨ -->
	<div id="toastContainer" style="position:fixed;pointer-events:none;bottom:0;left:0;right:0;display:flex;flex-direction:column;align-items:flex-end;gap:10px;padding:0 24px 24px;z-index:500;"></div>

	<script>
	/*************************************************
	 * æ•°æ®å±‚ & çŠ¶æ€æ¨¡å‹
	 *************************************************/
	const SUPABASE_URL = 'https://waesizzoqodntrlvrwhw.supabase.co';
	const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhZXNpenpvcW9kbnRybHZyd2h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjIyOTYsImV4cCI6MjA3MzM5ODI5Nn0.kE5gSV68q1nLo4z2IqgwqfTBVqNOJw5qs08f6r0SQH0';
	let supabaseClient = null;
	let supabaseReady = false;
	let realtimeChannel = null;

	// ç»Ÿä¸€æˆ¿é—´æ¨¡å‹: { name, pianoType, location, remark, occupant, registerTime, version, heartbeatAt }
	const Store = {
		rooms: [], // æ´»åŠ¨çŠ¶æ€ (rooms è¡¨)
		roomMeta: {}, // é™æ€ï¼ˆroom_databaseï¼‰ name->meta
		students: [], // {id,name,major,grade}
		byName: new Map(),
		studentIndex: new Map(),
		floorSet: new Set(),
		filters: { floor:'ALL', type:'ALL' },
		settings: { basePracticeDuration:120 }, // æ”¹ä¸º2å°æ—¶
		timer: null,
		lastStats:{},
		pendingAssign:new Map(), // roomName -> {occupant,version,ts}
		localPracticeLogs: [], // æœ¬åœ°ç»ƒä¹ è®°å½•ç¼“å­˜
		editMode: false // ç¼–è¾‘æ¨¡å¼çŠ¶æ€
	};

	/* æ‹¼éŸ³æ˜ å°„ */
	const pinyinMap={'é³':'jin','è“':'lan','ç†™':'xi','é‚“':'deng','æ¶µ':'han','å‘¨':'zhou','é™':'jing','è¿œ':'yuan','å†¯':'feng','ç‘':'rui','å¤•':'xi','å•':'lv','é‡‘':'jin','æ˜‚':'ang','å¾':'xu','æ¶¬':'shuang','å®¸':'chen','çª¦':'dou','ç’Ÿ':'jing','å':'hua','æ—':'lin','æ™':'yan','ç†¹':'xi','æ®µ':'duan','é‰´':'jian','å¶':'ye','è”š':'wei','åˆ˜':'liu','æ³½':'ze','æ–‡':'wen','æ½˜':'pan','ç‘¾':'jin','ç† ':'yi','æ':'li','åš':'bo','æ©':'en','ç‹':'wang','å¥•':'yi','ç„¶':'ran','éŸ©':'han','æ˜€':'yun','æ¡¦':'hua','å­”':'kong','ç’‡':'xuan','è‡§':'zang','æ˜±':'yu','æ£‹':'qi','è”º':'lin','è½©':'xuan','å®‹':'song','æ¢“':'zi','æš„':'xuan','ç”°':'tian','å­':'zi','è±':'xuan','å¼ ':'zhang','ä¾':'yi','é™ˆ':'chen','æ€':'si','å½¤':'tong','æ¨':'yang','é›¨':'yu','æ¡':'tong','èµµ':'zhao','æ¬£':'xin','æ€¡':'yi','é©¬':'ma','æ™¨':'chen','æ›¦':'xi','é«˜':'gao','æ¢¦':'meng','çª':'qi','éƒ‘':'zheng','è¯—':'shi','å´':'wu','ä½³':'jia','ä½•':'he','æœ±':'zhu','å¿ƒ':'xin','è¯­':'yu','èƒ¡':'hu','è‹¥':'ruo','æ±':'xi','è®¸':'xu','ç‘¶':'yao','ç½—':'luo','é›…':'ya','é’Ÿ':'zhong','å«£':'yan','è°¢':'xie','è‹':'su','ç³':'lin','æ±Ÿ':'jiang','å­™':'sun','è¢':'yuan','æ±ª':'wang','æ›¹':'cao','å§š':'yao','æ²ˆ':'shen','å¢':'lu','éŸ¦':'wei','è‘£':'dong','å‚…':'fu','ç¨‹':'cheng','ä¸':'ding','çŸ³':'shi','ä»»':'ren','é‚¹':'zou','é¾™':'long','å²':'shi','æ–¹':'fang','å¤':'xia','ä¾¯':'hou','é‚±':'qiu','å°¹':'yin','é»':'li','æ±¤':'tang','æ˜“':'yi','å¸¸':'chang','æ­¦':'wu','ä¹”':'qiao','è´º':'he','èµ–':'lai','é¾š':'gong','åº':'pang','æ¨Š':'fan','å…°':'lan','æ®·':'yin','æ–½':'shi','é™¶':'tao','ç¿':'weng','å®‰':'an','å€ª':'ni','ä¸¥':'yan','ç‰›':'niu','æ¸©':'wen','èŠ¦':'lu','å­£':'ji','ä¿':'yu','ç« ':'zhang','é²':'lu','è‘›':'ge','ä¼':'wu','ç”³':'shen','å°¤':'you','æ¯•':'bi','è‚':'nie','ä¸›':'cong','ç„¦':'jiao','å‘':'xiang','æŸ¯':'ke','å²³':'yue','æ¹˜':'xiang','æ‚¦':'yue','ç®':'wei','ç®¡':'guan','å“²':'zhe','å©·':'ting','é‡Š':'shi','è¨€':'yan','ç¥':'zhu','å®':'bao','å½­':'peng','ç¾':'mei','æ·‡':'qi','åº·':'kang','ç¾¤':'qun','è€¿':'geng','å¹„':'wo','åƒ':'qian','ç‘œ':'yu','åˆ':'you','é›¯':'wen','ä¿Š':'jun','æ°':'jie','åŠ²':'jin','è±ª':'hao','ç¬™':'sheng','æƒ':'quan','è–›':'xue','å®œ':'yi','é™†':'lu','æ›œ':'yao','å¶™':'lin','é¦¨':'xin','è£•':'yu','æ˜•':'xin','æ²':'mu','å”':'tang','å›':'jun','ç››':'sheng','ç¡•':'shuo','æ™—':'han','å¦‚':'ru','ç‰§':'mu','é£':'feng','æ™':'xi','ä¼Š':'yi','æ¸…':'qing','å¦ƒ':'fei','æœˆ':'yue','ç¥º':'qi','è’²':'pu','æŸ':'bai','ç¾½':'yu','å† ':'guan','æˆ':'cheng','é¢œ':'yan','äº¦':'yi','æ²…':'yuan','æ‰¿':'cheng','ç§¦':'qin','é“‚':'bo','ç­µ':'yan','æ…§':'hui','ä½œ':'zuo','ç¿°':'han','ä¸Š':'shang','ä¹‹':'zhi','è·¯':'lu','ç“’':'zan','è‘—':'zhu','ç¿':'rui','ç±½':'zi','ä¸':'cheng','å¦':'yan','æ ©':'xu','ä¹':'le','é€¸':'yi','è¯š':'cheng','é’°':'yu','æ´':'jie','åª›':'yuan','é‹†':'yun','è°¨':'jin','ç•…':'chang','èŒ¹':'ru','æ²‚':'yi','å©‰':'wan','è·':'he','æ´‹':'yang','æ˜':'ming','å¤š':'duo','éƒ—':'xi','ä¼ ':'chuan','å¹³':'ping','ä¸–':'shi','å…ƒ':'yuan','æ±‡':'hui','æ²™':'sha','çš“':'hao','å®¶':'jia','æ¥ ':'nan','å®˜':'guan','æŸ˜':'zhe','å¸Œ':'xi','æº¥':'pu','å°š':'shang','å‡Œ':'ling','ç¿¾':'xuan','å§œ':'jiang','ç…Š':'xuan','ç¬':'wan','è¿ª':'di','æ˜':'xuan','æ²':'qin','ç¥':'yi','çˆ':'jia','æ”¿':'zheng','é˜³':'yang','ä»¥':'yi','éª':'qian','ä¹™':'yi','é“®':'zheng','å•†':'shang','å¤©':'tian','èµ':'ci','æ™Ÿ':'sheng','å³°':'feng','é‚µ':'shao','é¢¢':'hao','æµ©':'hao','ä½™':'yu','æµ¡':'bo','ç€š':'han','å³»':'jun','äº':'yu','é’²':'zheng','åŸ¼':'qi','è‹':'su','å½¦':'yan','ç‚³':'bing','å²':'qi','ç’ ':'fan','ç™½':'bai','å’':'yong','ç':'ding','åº„':'zhuang','ç¬›':'di','è–ª':'xin','ç±³':'mi','çª':'qi','å­˜':'cun','å’Œ':'he','ç¬‘':'xiao','æ¬§':'ou','ç¿°':'han','å–†':'zhe','åº­':'ting','å½°':'zhang','é‚°':'tai','è”¡':'cai','å±¹':'yi','æ½†':'ying','æ½':'lu','ä¿®':'xiu','å†‰':'ran','å…‰':'guang','ç¿¼':'yi','çº':'jun','é—»':'wen','æ²»':'zhi','ç¥':'yue','å©§':'jing','å©':'qi','æ¤':'zhi','å¯…':'yin','äº•':'jing','æºª':'xi','ç´«':'zi','èˆª':'hang','æ˜¾':'xian','ç¿”':'xiang','æ™¯':'jing','å›­':'yuan','ç¾¿':'yi','è¾¾':'da','æ­£':'zheng','æ½¼':'tong','å˜‰':'jia','å´š':'ling','æ±‰':'han','å†¼':'xian','æ˜Š':'hao','æ•¬':'jing','å°”':'er','å“':'zhuo','å¸…':'shuai','å¿—':'zhi','å¯':'ke','é’§':'jun','é‰´':'jian','ç¬™':'sheng','æƒ':'quan','æ˜¾':'xian','ç¿”':'xiang','æ™':'yan','ç†¹':'xi','é‡Š':'shi','è¨€':'yan','æ£®':'sen','è´¤':'xian','æŸ³':'liu','æ©':'en','å¥•':'yi','æ½¼':'tong','å˜‰':'jia','æ€¡':'yi','é‡‘':'jin','æ˜‚':'ang','ç‘¾':'jin','ç† ':'yi','ç¾':'mei','æ·‡':'qi','åƒ':'qian','ç‘œ':'yu','å­':'zi','è½©':'xuan','å¿—':'zhi','æ˜Š':'hao','è±':'xuan','ç”³':'shen','å´š':'ling','æ¢“':'zi','åº·':'kang','å²³':'yue','æ±‰':'han','æ˜Š':'hao','ç†¹':'xi','åˆ':'you','å®‰':'an','æ¶¬':'shuang','å®¸':'chen','å®œ':'yi','è‰º':'yi','å“':'zhuo','ç„¶':'ran','è”š':'wei','è“':'lan','æ•¬':'jing','è½©':'xuan','æ˜±':'yu','æ£‹':'qi','å°”':'er','æ¶µ':'han','é›¯':'wen','å©·':'ting','å“':'zhuo','ç¾¤':'qun','å­':'zi','å¸…':'shuai','å­':'zi','ä¾':'yi','åš':'bo','ç®':'wei','æ¬£':'xin','æ€¡':'yi','é™':'jing','è¿œ':'yuan','å®':'bao','æ€¡':'yi','å¸¸':'chang','æ¬£':'xin','æ´‹':'yang','å©‰':'wan','èŒ¹':'ru','æ˜':'ming','å¤š':'duo','æ°':'jie','æ¬£':'xin','è·':'he','åƒ':'qian','çš“':'hao','æ±‡':'hui','æ³½':'ze','ä¼ ':'chuan','å¹³':'ping','ä¸–':'shi','å…ƒ':'yuan','å† ':'guan','æº':'yuan','ç±³':'mi','çª':'qi','å•':'dan','è‹¥':'ruo','æºª':'xi','æ©':'en','å’Œ':'he','é‡‘':'jin','é»„':'huang','å¯':'ke','æ¬£':'xin','å­”':'kong','æ¢“':'zi','è¯­':'yu','å­˜':'cun','æµ©':'hao','å˜‰':'jia','è·':'he','é›¨':'yu','ç¬›':'di','å­':'zi','è½©':'xuan','è–ª':'xin','ç‘œ':'yu','æ¢“':'zi','å®¸':'chen','æ‰¿':'cheng','ç†¹':'xi','å­':'zi','å¢¨':'mo','å¡˜':'tang','æ¬£':'xin','å¦':'yan','ç¬‘':'xiao','æ¬§':'ou','ç¥':'yi','ç¥':'yue','å©§':'jing','å©':'qi','æ¤':'zhi','å…ƒ':'yuan','æµ©':'hao','å…ƒ':'yuan','æ¢“':'zi','å¯…':'yin','ä¾':'yi','è¯º':'nuo','é’§':'jun','å±¹':'yi','åš':'bo','é—»':'wen','åº­':'ting','å½°':'zhang','æ½†':'ying','æ½':'lu','ç† ':'yi','å®¸':'chen','å¤©':'tian','ç¿¼':'yi','æ²»':'zhi','é’§':'jun','æ—':'lin','ç† ':'yi','æ¢“':'zi','å³°':'feng','ä¿®':'xiu','å†‰':'ran','çº':'jun','ç¿°':'han','å–†':'zhe','ç±³':'mi','é˜³':'yang','å…‰':'guang','æ ©':'xu','ä¹':'le','å®‰':'an','æ…§':'hui','å† ':'guan','å':'hua','è‹¥':'ruo','æ˜•':'xin','é›¨':'yu','ç†™':'xi','é‡‘':'jin','æ²‚':'yi','ä»¥':'yi','è¯º':'nuo','é’°':'yu','æ²':'mu','æ›¦':'xi','ç‰§':'mu','é£':'feng','æ¬£':'xin','å¦':'yan','æ²…':'yuan','æ‰¿':'cheng','ç±½':'zi','ä¸':'cheng','è°¨':'jin','ç•…':'chang','ä½œ':'zuo','ç¿°':'han','æ–‡':'wen','ç››':'sheng','è·¯':'lu','é›¨':'yu','ç“’':'zan','äº¦':'yi','å®¸':'chen','é€¸':'yi','è¯š':'cheng','å­':'zi','æ¸…':'qing','æŸ':'bai','ç¾½':'yu','é“‚':'bo','ç­µ':'yan','æ›œ':'yao','å¶™':'lin','è½©':'xuan','å­':'zi','èŒ¹':'ru','å˜‰':'jia','å›':'jun','æ´':'jie','åª›':'yuan','æœˆ':'yue','ç¥º':'qi','æ·‡':'qi','æ™—':'han','å¦‚':'ru','ä¸Š':'shang','æ©':'en','é›…':'ya','æ™':'xi','ä¸€':'yi','å¦ƒ':'fei','æ€¡':'yi','æ–‡':'wen','é­':'wei','ä¼Š':'yi','è±':'xuan','æ˜“':'yi','æˆ':'cheng','æ™Ÿ':'sheng','å˜‰':'jia','å®¶':'jia','ç¡•':'shuo','ä½³':'jia','é¦¨':'xin','è¯­':'yu','è‘—':'zhu','ç¿':'rui','è¯—':'shi','æ‚¦':'yue','ä¾':'yi','å®¸':'chen','å­':'zi','é‹†':'yun','æ¶µ':'han','ä¹‹':'zhi','è£•':'yu','è¾¾':'da'};

	function matchPinyin(name, searchTerm) {
		if (!searchTerm) return true;
		const searchLower = searchTerm.toLowerCase().trim();
		const nameLower = name.toLowerCase();
		
		// ç›´æ¥åŒ¹é…ä¸­æ–‡
		if (nameLower.includes(searchLower)) return true;
		
		// å¤„ç†ç©ºæ ¼åˆ†éš”çš„å¤šå…³é”®è¯æœç´¢
		const keywords = searchLower.split(/\s+/).filter(k => k.length > 0);
		if (keywords.length > 1) {
			return matchMultipleKeywords(name, keywords);
		}
		
		// å•å…³é”®è¯çš„æ‹¼éŸ³åŒ¹é…é€»è¾‘
		const nameChars = name.split('');
		const firstLetters = nameChars.map(char => {
			const py = pinyinMap[char];
			return py ? py.charAt(0) : char.toLowerCase();
		});
		
		// å¦‚æœæœç´¢è¯åªæœ‰ä¸€ä¸ªå­—æ¯ï¼ŒåªåŒ¹é…ç¬¬ä¸€ä¸ªå­—çš„é¦–å­—æ¯
		if (searchLower.length === 1) {
			return firstLetters[0] === searchLower;
		}
		
		// å¤šå­—æ¯æœç´¢æ—¶çš„è¿ç»­é¦–å­—æ¯åŒ¹é…
		const firstLettersStr = firstLetters.join('');
		
		// å®Œæ•´çš„é¦–å­—æ¯åŒ¹é…ï¼ˆå¦‚ "å½­ç¾å²" -> "pmq"ï¼‰
		if (firstLettersStr === searchLower) return true;
		
		// ä»å¼€å¤´å¼€å§‹çš„éƒ¨åˆ†åŒ¹é…ï¼ˆå¦‚ "å½­ç¾å²" -> "pm"ï¼‰
		if (firstLettersStr.startsWith(searchLower)) return true;
		
		// è¿ç»­å­ä¸²åŒ¹é…ï¼ˆå¦‚ "å½­ç¾å²" -> "mq" åŒ¹é… "ç¾å²"ï¼‰
		if (searchLower.length >= 2 && firstLettersStr.includes(searchLower)) return true;
		
		return false;
	}

	// å¤šå…³é”®è¯åŒ¹é…å‡½æ•°
	function matchMultipleKeywords(name, keywords) {
		const nameLower = name.toLowerCase();
		const nameChars = name.split('');
		const firstLetters = nameChars.map(char => {
			const py = pinyinMap[char];
			return py ? py.charAt(0) : char.toLowerCase();
		});
		const firstLettersStr = firstLetters.join('');
		
		// æ¯ä¸ªå…³é”®è¯éƒ½å¿…é¡»å•ç‹¬åŒ¹é…ï¼ˆAND é€»è¾‘ï¼‰
		const allMatch = keywords.every(keyword => {
			// ç›´æ¥ä¸­æ–‡åŒ¹é…
			if (nameLower.includes(keyword)) return true;
			
			// å•å­—æ¯é¦–å­—æ¯åŒ¹é…
			if (keyword.length === 1) {
				return firstLetters.includes(keyword);
			}
			
			// å¤šå­—æ¯è¿ç»­åŒ¹é…
			if (keyword.length >= 2) {
				return firstLettersStr.includes(keyword);
			}
			
			return false;
		});
		
		if (allMatch) return true;
		
		// æ™ºèƒ½é¦–å­—æ¯ç»„åˆåŒ¹é…
		const isAllSingleLetters = keywords.every(k => k.length === 1);
		if (isAllSingleLetters) {
			return matchSmartKeywords(name, keywords);
		}
		
		// ç»„åˆå…³é”®è¯åŒ¹é…
		return matchCombinedKeywords(name, keywords, firstLetters, nameLower);
	}

	// ç»„åˆå…³é”®è¯åŒ¹é…
	function matchCombinedKeywords(name, keywords, firstLetters, nameLower) {
		for (let i = 0; i < keywords.length; i++) {
			const keyword = keywords[i];
			let matched = false;
			
			if (keyword.length === 1) {
				// å•å­—æ¯ï¼šæ£€æŸ¥é¦–å­—æ¯
				matched = firstLetters.includes(keyword);
			} else {
				// å¤šå­—æ¯ï¼šæ£€æŸ¥ä¸­æ–‡æˆ–æ‹¼éŸ³
				matched = nameLower.includes(keyword) || 
						  firstLetters.join('').includes(keyword);
			}
			
			if (!matched) return false;
		}
		
		return true;
	}

	// æ™ºèƒ½å…³é”®è¯åŒ¹é…ï¼ˆæ”¯æŒé¦–å­—æ¯ç»„åˆï¼‰
	function matchSmartKeywords(name, keywords) {
		const nameChars = name.split('');
		const firstLetters = nameChars.map(char => {
			const py = pinyinMap[char];
			return py ? py.charAt(0) : char.toLowerCase();
		});
		
		// æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¿ç»­çš„é¦–å­—æ¯åŒ¹é…
		if (keywords.length <= nameChars.length) {
			for (let i = 0; i <= firstLetters.length - keywords.length; i++) {
				let match = true;
				for (let j = 0; j < keywords.length; j++) {
					if (firstLetters[i + j] !== keywords[j]) {
						match = false;
						break;
					}
				}
				if (match) return true;
			}
			
			// æ”¯æŒéè¿ç»­ä½†æŒ‰é¡ºåºçš„é¦–å­—æ¯åŒ¹é…
			let keywordIndex = 0;
			for (let i = 0; i < firstLetters.length && keywordIndex < keywords.length; i++) {
				if (firstLetters[i] === keywords[keywordIndex]) {
					keywordIndex++;
				}
			}
			if (keywordIndex === keywords.length) return true;
		}
		
		return false;
	}

	function canonicalizeRoom(r){
		if(!r) return null;
		// ä»…å½“æºå¯¹è±¡æ˜¾å¼åŒ…å«æŸå­—æ®µæ—¶æ‰å¸¦å‡ºåŠ¨æ€å±æ€§ï¼Œé˜²æ­¢ç”¨â€œé™æ€å…ƒæ•°æ®â€è¦†ç›–å®æ—¶çŠ¶æ€
		const out = {
			name: r.name,
			pianoType: r.piano_type || r.pianoType || r.pianoKind || 'æ— é’¢ç´',
			location: (r.location||'').trim(),
			remark: r.remark || ''
		};
		// occupantï¼šåªæœ‰å½“æºå¯¹è±¡åŒ…å« occupant/occupant_student_name/student å­—æ®µä¹‹ä¸€æ—¶ï¼Œæ‰è®¾ç½®ï¼ˆå…è®¸ä¸º null è¡¨ç¤ºæ˜ç¡®æ¸…ç©ºï¼‰
		if ('occupant_student_name' in r || 'occupant' in r || 'student' in r) {
			out.occupant = r.occupant_student_name || r.occupant || r.student || null;
		}
		// registerTime
		if ('register_time' in r || 'registerTime' in r) {
			out.registerTime = r.register_time ? toMs(r.register_time) : (r.registerTime||null);
		}
		// version
		if ('version' in r) {
			out.version = r.version || 0;
		}
		// heartbeatAt
		if ('heartbeat_at' in r || 'heartbeatAt' in r) {
			out.heartbeatAt = r.heartbeat_at ? toMs(r.heartbeat_at) : (r.heartbeatAt||null);
		}
		return out;
	}
	function toMs(v){ if(!v) return null; if(typeof v==='number') return v* (v<2e12?1000:1); return new Date(v).getTime(); }

	/*************************************************
	 * Supabase é€‚é…å™¨
	 *************************************************/
	async function initSupabase(){
		updateSyncStatus('connecting', 'è¿æ¥ä¸­...');
		let retryCount = 0;
		const maxRetries = 3;
		
		while (retryCount < maxRetries) {
			try {
				logInfo(`å°è¯•è¿æ¥ Supabase (ç¬¬ ${retryCount + 1} æ¬¡)`);
				
				// æ£€æŸ¥ Supabase å®¢æˆ·ç«¯æ˜¯å¦å·²åŠ è½½
				if(typeof window.supabase !== 'undefined' && window.supabase.createClient){ 
					logInfo('ä½¿ç”¨å…¨å±€ supabase å¯¹è±¡');
					supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); 
				} else if(typeof window.createClient==='function'){ 
					logInfo('ä½¿ç”¨å…¨å±€ createClient å‡½æ•°');
					supabaseClient = window.createClient(SUPABASE_URL, SUPABASE_KEY); 
				} else { 
					logInfo('åŠ¨æ€åŠ è½½ Supabase è„šæœ¬');
					await loadSupabaseScript(); 
					if (!window.supabase || !window.supabase.createClient) {
						throw new Error('Supabase è„šæœ¬åŠ è½½å¤±è´¥ï¼Œå…¨å±€å¯¹è±¡ä¸å¯ç”¨');
					}
					supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); 
				}
				// æŒ‚è½½åˆ°å…¨å±€ï¼Œä¾› BTM ç­‰æ¨¡å—ä½¿ç”¨
				window.supabaseClient = supabaseClient;
				
				// éªŒè¯å®¢æˆ·ç«¯å¯¹è±¡
				if (!supabaseClient) {
					throw new Error('Supabase å®¢æˆ·ç«¯åˆ›å»ºå¤±è´¥');
				}
				
				// æµ‹è¯•è¿æ¥
				logInfo('æµ‹è¯• Supabase è¿æ¥...');
				updateSyncStatus('connecting', 'æµ‹è¯•è¿æ¥...');
				const { data, error } = await supabaseClient.from('rooms').select('count').limit(1);
				if (error) {
					logWarn('Supabase è¿æ¥æµ‹è¯•å¤±è´¥:', error.message);
					throw error;
				} else {
					logInfo('Supabase è¿æ¥æµ‹è¯•æˆåŠŸ');
				}
				
				supabaseReady = true; 
				logInfo('Supabase åˆå§‹åŒ–å®Œæˆ');
				updateSyncStatus('connected', 'Supabase å°±ç»ª');
				return; // æˆåŠŸï¼Œé€€å‡ºé‡è¯•å¾ªç¯
				
			} catch (error) {
				retryCount++;
				logErr(`Supabase åˆå§‹åŒ–å¤±è´¥ (ç¬¬ ${retryCount} æ¬¡):`, error.message);
				
				if (retryCount >= maxRetries) {
					updateSyncStatus('error', `åˆå§‹åŒ–å¤±è´¥ (${error.message})`);
					// ä¸æŠ›å‡ºé”™è¯¯ï¼Œæ”¹ä¸ºä¼˜é›…é™çº§
					logWarn('ä½¿ç”¨ç¦»çº¿æ¨¡å¼');
					return;
				}
				
				// ç­‰å¾…åé‡è¯•
				await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
			}
		}
	}
	function loadSupabaseScript(){
		return new Promise((res,rej)=>{
			// æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
			if(window.supabase && window.supabase.createClient){
				logInfo('Supabase è„šæœ¬å·²å­˜åœ¨');
				return res();
			}
			
			const s=document.createElement('script'); 
			s.src='https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js';
			s.crossOrigin = 'anonymous'; 
			s.onload=()=>{
				logInfo('Supabase è„šæœ¬åŠ è½½æˆåŠŸ');
				// ç­‰å¾…å‡ æ¯«ç§’ç¡®ä¿å…¨å±€å¯¹è±¡å¯ç”¨
				setTimeout(res, 100);
			}; 
			s.onerror=(e)=>{
				logErr('åŠ è½½ supabase è„šæœ¬å¤±è´¥:', e);
				rej(new Error('åŠ è½½ supabase å¤±è´¥'));
			}; 
			document.head.appendChild(s);
		});
	}
	async function fetchRooms(){
		if(!supabaseReady) return [];
		const { data, error } = await supabaseClient.from('rooms').select('*');
		if(error){ logWarn('åŠ è½½ rooms å¤±è´¥', error.message); return []; }
		return data.map(canonicalizeRoom);
	}
	async function fetchRoomMeta(){
		if(!supabaseReady) return {};
		const { data, error } = await supabaseClient.from('room_database').select('*');
		if(error){ logWarn('åŠ è½½ room_database å¤±è´¥', error.message); return {}; }
		
		const map={}; 
		const cloudRooms = [];
		
		(data||[]).forEach(r=>{ 
			map[r.name]=r; 
			// è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼å¹¶åŠ å…¥ç´æˆ¿åˆ—è¡¨
			cloudRooms.push({
				name: r.name,
				pianoType: r.piano_type || '',
				location: r.location || '',
				remark: r.remark || ''
			});
		}); 
		
		// è‡ªåŠ¨åˆå¹¶äº‘ç«¯ç´æˆ¿æ•°æ®åˆ°æœ¬åœ°ï¼ˆè·³è¿‡äº‘ç«¯åŒæ­¥é¿å…é€’å½’ï¼‰
		if (cloudRooms.length > 0) {
			logInfo(`ä»äº‘ç«¯è·å–åˆ° ${cloudRooms.length} ä¸ªç´æˆ¿ï¼Œè‡ªåŠ¨åˆå¹¶åˆ°æœ¬åœ°`);
			await mergeRooms(cloudRooms, { skipCloudSync: true, metaOnly: true });
		}
		
		return map;
	}

	// æŒ‰æˆ¿é—´åæ‹‰å–å•ä¸ªé™æ€å…ƒæ•°æ®å¹¶åˆå¹¶ï¼ˆä»…å…ƒæ•°æ®ï¼Œä¸è§¦åŠ¨å ç”¨çŠ¶æ€ï¼‰
	async function fetchRoomMetaByName(name){
		if(!supabaseReady || !name) return;
		try{
			const { data, error } = await supabaseClient.from('room_database').select('*').eq('name', name).limit(1);
			if(error){ logWarn(`åŠ è½½ room_meta(${name}) å¤±è´¥`, error.message); return; }
			const r = Array.isArray(data) ? data[0] : data;
			if(!r) return;
			await mergeRooms([{ name: r.name, pianoType: r.piano_type || '', location: r.location || '', remark: r.remark || '' }], { skipCloudSync: true, metaOnly: true });
			logInfo(`å·²è¡¥å……æˆ¿é—´å…ƒæ•°æ®: ${name}`);
		}catch(e){ logWarn(`åŠ è½½æˆ¿é—´å…ƒæ•°æ®å¼‚å¸¸(${name})`, e.message); }
	}
	
	async function fetchStudents(){
		if(!supabaseReady) return [];
		const { data, error } = await supabaseClient.from('student_database').select('id,name,major,grade');
		if(error){ logWarn('åŠ è½½å­¦ç”Ÿå¤±è´¥', error.message); return []; }
		
		const students = data || [];
		
		// è‡ªåŠ¨åˆå¹¶äº‘ç«¯å­¦ç”Ÿæ•°æ®åˆ°æœ¬åœ°ï¼ˆè·³è¿‡äº‘ç«¯åŒæ­¥é¿å…é€’å½’ï¼‰
		if (students.length > 0) {
			logInfo(`ä»äº‘ç«¯è·å–åˆ° ${students.length} ä¸ªå­¦ç”Ÿï¼Œè‡ªåŠ¨åˆå¹¶åˆ°æœ¬åœ°`);
			await mergeStudents(students, true); // skipCloudSync = true
		}
		
		return students;
	}
	async function assignRoom(roomName, student, expectedVersion){
		// æ£€æŸ¥æ“ä½œé”ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
		const lockKey = `assign_${roomName}`;
		if (Store.operationLocks?.has(lockKey)) {
			logWarn(`æˆ¿é—´ ${roomName} æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™`);
			toast(`æˆ¿é—´ ${roomName} æ­£åœ¨å¤„ç†ä¸­...`, 'warn');
			return { ok: false, error: 'æ“ä½œè¿›è¡Œä¸­' };
		}
		
		// è®¾ç½®æ“ä½œé”
		if (!Store.operationLocks) Store.operationLocks = new Set();
		Store.operationLocks.add(lockKey);
		
		try {
			// ä¹è§‚æ›´æ–°ï¼ˆç«‹å³æ˜¾ç¤ºæ•ˆæœï¼‰
			const optimisticResult = optimisticAssign(roomName, student);
			if (!optimisticResult) {
				return { ok: false, error: 'ä¹è§‚æ›´æ–°å¤±è´¥' };
			}
			
			// åç«¯åŒæ­¥
			if(!supabaseReady){ 
				logWarn('ç¦»çº¿æ¨¡å¼ - ä»…æœ¬åœ°æ›´æ–°');
				return {ok:true, offline:true}; 
			}
			
			const nowIso = new Date().toISOString();
			const row = Store.rooms.find(r=>r.name===roomName);
			const nextVersion = (row? row.version:0)+1;
			
			// æ ‡è®°ä¸ºå¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.set(roomName, { 
				student, 
				version: nextVersion, 
				timestamp: Date.now() 
			});
			
			const { data, error } = await supabaseClient.from('rooms').upsert({
				name: roomName,
				occupant_student_name: student,
				register_time: nowIso,
				heartbeat_at: nowIso,
				version: nextVersion,
				updated_at: nowIso
			}, {
				onConflict: 'name'
			});
			
			if(error){ 
				logErr('ç™»è®°å¤±è´¥', error.message);
				// å›æ»šä¹è§‚æ›´æ–°
				rollbackOptimisticAssign(roomName);
				return {ok:false,error}; 
			}
			
			// å†™å…¥ç»ƒä¹ è®°å½•
			await writePracticeLog(roomName, student, 'assign');
			
			logInfo(`æˆåŠŸç™»è®° ${student} -> ${roomName} (v${nextVersion})`);
			return {ok:true, data};
			
		} finally {
			// æ¸…é™¤æ“ä½œé”
			Store.operationLocks.delete(lockKey);
			// æ¸…é™¤å¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.delete(roomName);
			// æ¸…é™¤è§†è§‰æŒ‡ç¤º
			clearOperationIndicator(roomName);
		}
	}
	async function clearRoom(roomName){
		// æ£€æŸ¥æ“ä½œé”ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
		const lockKey = `clear_${roomName}`;
		if (Store.operationLocks?.has(lockKey)) {
			logWarn(`æˆ¿é—´ ${roomName} æ­£åœ¨æ¸…ç©ºä¸­ï¼Œè¯·ç¨å€™`);
			toast(`æˆ¿é—´ ${roomName} æ­£åœ¨æ¸…ç©ºä¸­...`, 'warn');
			return { ok: false, error: 'æ“ä½œè¿›è¡Œä¸­' };
		}
		
		const row = Store.rooms.find(r=>r.name===roomName);
		if(!row || !row.occupant) {
			toast('æˆ¿é—´å·²ä¸ºç©º');
			return {ok:true};
		}
		
		// è®¾ç½®æ“ä½œé”
		if (!Store.operationLocks) Store.operationLocks = new Set();
		Store.operationLocks.add(lockKey);
		
		try {
			// å†™å…¥ç»ƒä¹ ç»“æŸè®°å½•
			await writePracticeLog(roomName, row.occupant, 'clear');
			
			// ä¹è§‚æ›´æ–°ï¼ˆç«‹å³æ˜¾ç¤ºæ•ˆæœï¼‰
			optimisticClear(roomName);
			
			if(!supabaseReady){ 
				logWarn('ç¦»çº¿æ¨¡å¼ - ä»…æœ¬åœ°æ¸…ç©º');
				return {ok:true, offline:true}; 
			}
			
			const nextVersion = (row.version || 0) + 1;
			
			// æ ‡è®°ä¸ºå¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.set(roomName, { 
				student: null, 
				version: nextVersion, 
				timestamp: Date.now() 
			});
			
			const { data, error } = await supabaseClient.from('rooms').upsert({
				name: roomName, 
				occupant_student_name: null, 
				register_time: null,
				heartbeat_at: new Date().toISOString(),
				version: nextVersion,
				updated_at: new Date().toISOString()
			}, {
				onConflict: 'name'
			});
			
			if(error){ 
				logErr('æ¸…ç©ºå¤±è´¥', error.message);
				// å¦‚æœæ¸…ç©ºå¤±è´¥ï¼Œè€ƒè™‘å›æ»šæœ¬åœ°çŠ¶æ€
				logWarn('æ¸…ç©ºå¤±è´¥ï¼Œä½†æœ¬åœ°çŠ¶æ€å·²æ›´æ–°');
				return {ok:false,error}; 
			}
			
			logInfo(`æˆåŠŸæ¸…ç©º ${roomName} (v${nextVersion})`);
			return {ok:true, data};
			
		} finally {
			// æ¸…é™¤æ“ä½œé”
			Store.operationLocks.delete(lockKey);
			// æ¸…é™¤å¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.delete(roomName);
			// æ¸…é™¤è§†è§‰æŒ‡ç¤º
			clearOperationIndicator(roomName);
		}
	}

	/*************************************************
	 * ä¹è§‚æ›´æ–° & å®æ—¶è®¢é˜…
	 *************************************************/
	function optimisticAssign(roomName, student, version){
		let r=Store.rooms.find(r=>r.name===roomName); 
		if(!r){ 
			r=canonicalizeRoom({name:roomName}); 
			Store.rooms.push(r); 
		}
		
		// ä¿å­˜åŸå§‹çŠ¶æ€ç”¨äºå¯èƒ½çš„å›æ»š
		if (!Store.rollbackStates) Store.rollbackStates = new Map();
		Store.rollbackStates.set(roomName, {
			occupant: r.occupant,
			registerTime: r.registerTime,
			version: r.version
		});
		
		r.occupant=student; 
		r.registerTime=Date.now(); 
		r.version=version||r.version+1; 
		Store.pendingAssign.set(roomName,{occupant:student,version:r.version,ts:Date.now()});
		
		// æ·»åŠ è§†è§‰æŒ‡ç¤º
		const card = document.querySelector(`[data-room="${roomName}"]`);
		if (card) {
			card.classList.add('pending-operation');
			card.dataset.status = 'syncing';
		}
		
		renderRoomCard(roomName); 
		updateUsageStats(); 
		toast(`âœ… å·²ç™»è®° ${student} -> ${roomName}`, 'success');
		
		return true;
	}
	
	function rollbackOptimisticAssign(roomName) {
		if (!Store.rollbackStates) return;
		
		const originalState = Store.rollbackStates.get(roomName);
		if (!originalState) return;
		
		const r = Store.rooms.find(r => r.name === roomName);
		if (r) {
			r.occupant = originalState.occupant;
			r.registerTime = originalState.registerTime;
			r.version = originalState.version;
			
			// ç§»é™¤è§†è§‰æŒ‡ç¤º
			const card = document.querySelector(`[data-room="${roomName}"]`);
			if (card) {
				card.classList.remove('pending-operation');
			}
			
			renderRoomCard(roomName);
			updateUsageStats();
			toast(`âŒ ç™»è®°å¤±è´¥ï¼Œå·²å›æ»š ${roomName}`, 'error');
		}
		
		Store.rollbackStates.delete(roomName);
		Store.pendingAssign.delete(roomName);
	}
	
	function optimisticClear(roomName, version){
		const r=Store.rooms.find(r=>r.name===roomName); 
		if(!r) return;
		
		// ä¿å­˜åŸå§‹çŠ¶æ€ç”¨äºå¯èƒ½çš„å›æ»š
		if (!Store.rollbackStates) Store.rollbackStates = new Map();
		Store.rollbackStates.set(roomName, {
			occupant: r.occupant,
			registerTime: r.registerTime,
			version: r.version
		});
		
		if(r.occupant){ 
			writePracticeLogLocal(r); 
		}
		
		r.occupant=null; 
		r.registerTime=null; 
		r.version=version||r.version+1; 
		
		// æ·»åŠ è§†è§‰æŒ‡ç¤º
		const card = document.querySelector(`[data-room="${roomName}"]`);
		if (card) {
			card.classList.add('pending-operation');
			card.dataset.status = 'syncing';
		}
		
		renderRoomCard(roomName); 
		updateUsageStats(); 
		toast(`âœ… å·²æ¸…ç©º ${roomName}`, 'success');
		
		return true;
	}
	
	// ç§»é™¤æ“ä½œè¿›è¡Œä¸­çš„è§†è§‰æŒ‡ç¤º
	function clearOperationIndicator(roomName) {
		const card = document.querySelector(`[data-room="${roomName}"]`);
		if (card) {
			card.classList.remove('pending-operation');
		}
	}
	
	// å½»åº•æ¸…ç†æˆ¿é—´çš„æ‰€æœ‰çŠ¶æ€
	function cleanupRoomState(roomName) {
		// æ¸…ç†å¾…å¤„ç†æ“ä½œ
		Store.pendingAssign.delete(roomName);
		
		// æ¸…ç†å›æ»šçŠ¶æ€
		if (Store.rollbackStates) {
			Store.rollbackStates.delete(roomName);
		}
		
		// æ¸…ç†æ“ä½œé”
		if (Store.operationLocks) {
			Store.operationLocks.delete(`assign_${roomName}`);
			Store.operationLocks.delete(`clear_${roomName}`);
			Store.operationLocks.delete(`renew_${roomName}`);
		}
		
		// æ¸…ç†DOMå…ƒç´ 
		const card = document.querySelector(`[data-room="${CSS.escape(roomName)}"]`);
		if (card) {
			card.remove();
		}
		
		logInfo(`å·²æ¸…ç†æˆ¿é—´ ${roomName} çš„æ‰€æœ‰çŠ¶æ€`);
	}
	async function setupRealtime(){
		if(!supabaseReady) {
			logWarn('Supabase æœªå°±ç»ªï¼Œè·³è¿‡å®æ—¶è®¢é˜…');
			updateSyncStatus('error', 'æœªè¿æ¥');
			return;
		}
		
		updateSyncStatus('connecting', 'è®¢é˜…ä¸­...');
		
		// æ¸…ç†æ—§è¿æ¥
		if(realtimeChannel){ 
			try{ 
				supabaseClient.removeChannel(realtimeChannel);
				logInfo('å·²ç§»é™¤æ—§çš„å®æ—¶é¢‘é“');
			}catch(e){
				logWarn('ç§»é™¤æ—§é¢‘é“å¤±è´¥', e.message);
			} 
		}
		
		// åˆ›å»ºæ–°çš„å®æ—¶é¢‘é“
		realtimeChannel = supabaseClient.channel('realtime-rooms')
			.on('postgres_changes', {
				event: '*',
				schema: 'public',
				table: 'rooms'
			}, (payload) => {
				logInfo('æ”¶åˆ°å®æ—¶æ›´æ–°:', payload.eventType, payload.new?.name || payload.old?.name);
				handleRealtimeRoom(payload);
			})
			.subscribe((status) => {
				if (status === 'SUBSCRIBED') {
					logInfo('âœ… å®æ—¶åŒæ­¥å·²è¿æ¥');
					updateSyncStatus('connected', 'å®æ—¶åŒæ­¥');
					toast('å®æ—¶åŒæ­¥å·²å¯ç”¨');
				} else if (status === 'CHANNEL_ERROR') {
					logErr('âŒ å®æ—¶åŒæ­¥è¿æ¥å¤±è´¥');
					updateSyncStatus('error', 'è¿æ¥å¤±è´¥');
					toast('å®æ—¶åŒæ­¥è¿æ¥å¤±è´¥', 'error');
				} else if (status === 'TIMED_OUT') {
					logWarn('â° å®æ—¶åŒæ­¥è¿æ¥è¶…æ—¶');
					updateSyncStatus('error', 'è¿æ¥è¶…æ—¶');
					toast('å®æ—¶åŒæ­¥è¿æ¥è¶…æ—¶', 'warn');
				} else if (status === 'CLOSED') {
					logWarn('ğŸ”Œ å®æ—¶åŒæ­¥è¿æ¥å·²å…³é—­');
					updateSyncStatus('error', 'è¿æ¥æ–­å¼€');
				} else {
					logInfo('å®æ—¶åŒæ­¥çŠ¶æ€:', status);
					updateSyncStatus('connecting', 'è¿æ¥ä¸­...');
				}
			});
		
		// è®¾ç½®å¿ƒè·³æ£€æµ‹
		setInterval(async () => {
			try {
				const occupiedRooms = Store.rooms.filter(r => r.occupant);
				for (const room of occupiedRooms) {
					await supabaseClient.from('rooms').update({
						heartbeat_at: new Date().toISOString()
					}).eq('name', room.name);
				}
			} catch (error) {
				logWarn('å¿ƒè·³æ›´æ–°å¤±è´¥:', error.message);
			}
		}, 30000); // æ¯30ç§’å¿ƒè·³ä¸€æ¬¡
	}
	
	function handleRealtimeRoom(payload){
		const row = payload.new || payload.old; 
		if(!row) return;
		
		const data = canonicalizeRoom(row); 
		const idx = Store.rooms.findIndex(r => r.name === data.name);
		
		// é˜²é‡å¤å¤„ç†ï¼šç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
		const updateKey = `${data.name}_${payload.eventType}_${data.version}_${Date.now()}`;
		const recentUpdatesKey = 'recentUpdates';
		if (!Store[recentUpdatesKey]) Store[recentUpdatesKey] = new Map();
		
		// æ£€æŸ¥æ˜¯å¦åœ¨çŸ­æ—¶é—´å†…å¤„ç†è¿‡ç›¸åŒçš„æ›´æ–°
		const recentUpdateTime = Store[recentUpdatesKey].get(`${data.name}_${payload.eventType}_${data.version}`);
		if (recentUpdateTime && Date.now() - recentUpdateTime < 1000) { // 1ç§’å†…çš„é‡å¤æ›´æ–°
			logInfo(`å¿½ç•¥é‡å¤çš„å®æ—¶æ›´æ–° ${data.name} v${data.version} (${payload.eventType})`);
			return;
		}
		
		// è®°å½•æ­¤æ¬¡æ›´æ–°
		Store[recentUpdatesKey].set(`${data.name}_${payload.eventType}_${data.version}`, Date.now());
		
		// æ¸…ç†è¿‡æœŸçš„æ›´æ–°è®°å½•ï¼ˆä¿ç•™æœ€è¿‘5ç§’çš„è®°å½•ï¼‰
		setTimeout(() => {
			const expireTime = Date.now() - 5000;
			for (const [key, time] of Store[recentUpdatesKey].entries()) {
				if (time < expireTime) {
					Store[recentUpdatesKey].delete(key);
				}
			}
		}, 5000);
		
		// æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬åœ°å¾…å¤„ç†çš„æ›´æ–°ï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰
		const pending = Store.pendingAssign.get(data.name);
		if(pending && pending.version >= data.version){ 
			logInfo(`å¿½ç•¥æœ¬åœ°å¾…å¤„ç†æ›´æ–° ${data.name} v${data.version}`);
			return; 
		}
		
		// å†²çªæ£€æµ‹ï¼šå¦‚æœæœ¬åœ°æ­£åœ¨æ“ä½œè¿™ä¸ªæˆ¿é—´
		const lockKey = `assign_${data.name}`;
		const clearLockKey = `clear_${data.name}`;
		const deleteLockKey = `delete_${data.name}`;
		const isLocked = Store.operationLocks?.has(lockKey) || Store.operationLocks?.has(clearLockKey) || Store.operationLocks?.has(deleteLockKey);
		
		if (isLocked) {
			if (Store.operationLocks?.has(deleteLockKey)) {
				logInfo(`æˆ¿é—´ ${data.name} æ­£åœ¨åˆ é™¤ä¸­ï¼Œå¿½ç•¥å®æ—¶æ›´æ–°`);
				return; // åˆ é™¤æ—¶å®Œå…¨å¿½ç•¥æ‰€æœ‰å®æ—¶æ›´æ–°
			}
			logWarn(`æˆ¿é—´ ${data.name} æœ¬åœ°æ“ä½œä¸­ï¼Œå»¶è¿Ÿå¤„ç†è¿œç¨‹æ›´æ–°`);
			// å»¶è¿Ÿ3ç§’é‡è¯•
			setTimeout(() => handleRealtimeRoom(payload), 3000);
			return;
		}
		
		// ç«‹å³æ›´æ–°UIä»¥å‡å°‘å»¶è¿Ÿæ„ŸçŸ¥
		let shouldRerender = false;
		let conflictDetected = false;
		
		// å¤„ç†ä¸åŒç±»å‹çš„æ›´æ–°
		if (payload.eventType === 'DELETE') {
			if (idx >= 0) {
				Store.rooms.splice(idx, 1);
				logInfo(`è¿œç¨‹åˆ é™¤æˆ¿é—´: ${data.name}`);
				
				// å½»åº•æ¸…ç†æˆ¿é—´çŠ¶æ€
				cleanupRoomState(data.name);
				
				// é‡å»ºç´¢å¼•å’Œç»Ÿè®¡
				rebuildIndexes();
				updateUsageStats();
				shouldRerender = false; // å·²ç»å¤„ç†äº†æ¸²æŸ“
				
				toast(`ğŸ—‘ï¸ æˆ¿é—´ ${data.name} å·²è¢«åˆ é™¤`, 'info');
			}
		} else if (payload.eventType === 'INSERT') {
			if (idx < 0) {
				Store.rooms.push(data);
				logInfo(`è¿œç¨‹æ–°å¢æˆ¿é—´: ${data.name}`);
				// è¡¥å……è¯¥æˆ¿é—´çš„é™æ€å…ƒæ•°æ®ï¼Œé¿å…åç§°å¤–ä¿¡æ¯ç¼ºå¤±
				fetchRoomMetaByName(data.name);
				shouldRerender = true;
			}
		} else if (payload.eventType === 'UPDATE') {
			// ========= å®Œæ•´é‡æ¸²æŸ“å¢å¼ºé€»è¾‘ =========
			let prevOcc = null;
			if (idx >= 0) {
				const oldRoom = Store.rooms[idx];
				prevOcc = oldRoom.occupant;
				// å†²çªæ£€æµ‹ï¼ˆåŒæ–¹éƒ½æœ‰ä¸åŒå ç”¨è€…ï¼‰
				if (oldRoom.occupant && data.occupant && oldRoom.occupant !== data.occupant) {
					conflictDetected = true;
					logWarn(`æ£€æµ‹åˆ°æˆ¿é—´ ${data.name} å†²çª: æœ¬åœ°(${oldRoom.occupant}) vs è¿œç¨‹(${data.occupant})`);
					toast(`âš ï¸ æˆ¿é—´ ${data.name} å­˜åœ¨å†²çªï¼Œè¯·æ£€æŸ¥`, 'warn');
				}
				// æ˜¾å¼å­—æ®µè¦†ç›–ï¼Œä¿è¯ null ä¸ä¸¢
				const prevRegisterTime = oldRoom.registerTime;
				oldRoom.occupant = (data.occupant === null ? null : data.occupant);
				oldRoom.registerTime = data.registerTime || null;
				oldRoom.version = data.version;
				oldRoom.heartbeatAt = data.heartbeatAt;
				logInfo(`è¿œç¨‹æ›´æ–°æˆ¿é—´: ${data.name} v${data.version} (occupant: ${oldRoom.occupant || 'null'})`);
				
				// æ£€æŸ¥æ˜¯å¦æœ‰å®è´¨æ€§å˜åŒ–ï¼ˆå½±å“UIæ˜¾ç¤ºçš„å­—æ®µï¼‰
				const hasOccupantChange = prevOcc !== oldRoom.occupant;
				const hasRegisterTimeChange = prevRegisterTime !== oldRoom.registerTime;
				const hasSignificantChange = hasOccupantChange || (oldRoom.occupant && hasRegisterTimeChange);
				
				// å˜åŒ–æç¤º
				if (hasOccupantChange && !conflictDetected) {
					if (oldRoom.occupant) toast(`ğŸµ ${oldRoom.occupant} å¼€å§‹ä½¿ç”¨ ${data.name}`, 'success'); else toast(`âœ… ${data.name} å·²é‡Šæ”¾`, 'success');
				}
				
				// å ç”¨ -> ç©ºï¼šå®Œæ•´é‡æ¸²æŸ“
				if (prevOcc && !oldRoom.occupant) {
					logInfo(`[FULL-RERENDER] ${data.name} cleared v${data.version} (${prevOcc} -> null)`);
					fullReRenderRoom(oldRoom);
					shouldRerender = false; // å·²åœ¨ fullReRenderRoom å†…å¤„ç†
				} else if (hasSignificantChange) {
					logInfo(`[NORMAL-RERENDER] ${data.name} v${data.version} (${prevOcc || 'null'} -> ${oldRoom.occupant || 'null'})`);
					shouldRerender = true;
				} else {
					logInfo(`[SKIP-RERENDER] ${data.name} v${data.version} (æ— UIå˜åŒ–ï¼Œä»…ç‰ˆæœ¬/å¿ƒè·³æ›´æ–°)`);
					shouldRerender = false;
				}
			} else {
				Store.rooms.push(data);
				logInfo(`è¿œç¨‹æ’å…¥æˆ¿é—´(è¡¥å½•): ${data.name}`);
				// åŒæ­¥è¡¥å……å…ƒæ•°æ®
				fetchRoomMetaByName(data.name);
				shouldRerender = true;
			}
		}
		
		// æ¸…ç†å¾…å¤„ç†çŠ¶æ€
		Store.pendingAssign.delete(data.name);
		
		// æ¸…ç†å›æ»šçŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
		if (Store.rollbackStates) {
			Store.rollbackStates.delete(data.name);
		}
		
		// æ¸…é™¤æ“ä½œè§†è§‰æŒ‡ç¤º
		clearOperationIndicator(data.name);
		
		// ç«‹å³é‡æ–°æ¸²æŸ“ä»¥å‡å°‘å»¶è¿Ÿ
		if (shouldRerender) {
			renderRoomCard(data.name); 
			updateUsageStats();
			rebuildIndexes();
		}
		
		// å¦‚æœæ£€æµ‹åˆ°å†²çªï¼Œè§¦å‘å…¨é‡åŒæ­¥
		if (conflictDetected) {
			setTimeout(() => {
				logInfo('å†²çªåè§¦å‘å…¨é‡æ•°æ®åŒæ­¥');
				fetchRoomMeta();
			}, 2000);
		}
	}

	/*************************************************
	 * äº‘ç«¯æ•°æ®åº“åŒæ­¥
	 *************************************************/
	async function syncRoomDatabaseToCloud(rooms) {
		if (!supabaseReady) {
			logWarn('Supabase æœªè¿æ¥ï¼Œè·³è¿‡ç´æˆ¿æ•°æ®åº“åŒæ­¥');
			return;
		}
		
		try {
			const roomData = rooms.map(room => ({
				name: room.name,
				piano_type: room.pianoType || '',
				location: room.location || '',
				remark: room.remark || '',
				updated_at: new Date().toISOString()
			}));
			
			// ä½¿ç”¨ upsert æ‰¹é‡æ’å…¥/æ›´æ–°ç´æˆ¿åŸºç¡€æ•°æ®
			const { data, error } = await supabaseClient
				.from('room_database')
				.upsert(roomData, { 
					onConflict: 'name',
					ignoreDuplicates: false 
				});
			
			if (error) {
				logErr('åŒæ­¥ç´æˆ¿æ•°æ®åº“å¤±è´¥:', error.message);
				toast('ç´æˆ¿æ•°æ®åº“åŒæ­¥å¤±è´¥', 'error');
			} else {
				logInfo(`âœ… æˆåŠŸåŒæ­¥ ${roomData.length} ä¸ªç´æˆ¿åˆ°äº‘ç«¯æ•°æ®åº“`);
				toast(`å·²åŒæ­¥ ${roomData.length} ä¸ªç´æˆ¿åˆ°äº‘ç«¯`);
			}
		} catch (err) {
			logErr('ç´æˆ¿æ•°æ®åº“åŒæ­¥å¼‚å¸¸:', err.message);
		}
	}
	
	async function syncStudentDatabaseToCloud(students) {
		if (!supabaseReady) {
			logWarn('Supabase æœªè¿æ¥ï¼Œè·³è¿‡å­¦ç”Ÿæ•°æ®åº“åŒæ­¥');
			return;
		}
		
		try {
			const studentData = students.map(student => ({
				name: student.name,
				major: student.major || '',
				grade: student.grade || '',
				// å¦‚æœæœ‰ id åˆ™ä¿ç•™ï¼Œå¦åˆ™è®©æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆ
				...(student.id && { id: student.id })
			}));
			
			// ä½¿ç”¨ upsert æ‰¹é‡æ’å…¥/æ›´æ–°å­¦ç”Ÿæ•°æ®
			const { data, error } = await supabaseClient
				.from('student_database')
				.upsert(studentData, { 
					onConflict: 'name',
					ignoreDuplicates: false 
				});
			
			if (error) {
				logErr('åŒæ­¥å­¦ç”Ÿæ•°æ®åº“å¤±è´¥:', error.message);
				toast('å­¦ç”Ÿæ•°æ®åº“åŒæ­¥å¤±è´¥', 'error');
			} else {
				logInfo(`âœ… æˆåŠŸåŒæ­¥ ${studentData.length} ä¸ªå­¦ç”Ÿåˆ°äº‘ç«¯æ•°æ®åº“`);
				toast(`å·²åŒæ­¥ ${studentData.length} ä¸ªå­¦ç”Ÿåˆ°äº‘ç«¯`);
			}
		} catch (err) {
			logErr('å­¦ç”Ÿæ•°æ®åº“åŒæ­¥å¼‚å¸¸:', err.message);
		}
	}
	
	async function manualSyncToCloud() {
		if (!supabaseReady) {
			toast('Supabase æœªè¿æ¥ï¼Œæ— æ³•åŒæ­¥', 'error');
			return;
		}
		
		try {
			toast('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...', 'info');
			
			// åŒæ­¥ç´æˆ¿æ•°æ®åº“
			if (Store.rooms.length > 0) {
				await syncRoomDatabaseToCloud(Store.rooms);
			}
			
			// åŒæ­¥å­¦ç”Ÿæ•°æ®åº“  
			if (Store.students.length > 0) {
				await syncStudentDatabaseToCloud(Store.students);
			}
			
			// åŒæ­¥æˆ¿é—´å®æ—¶çŠ¶æ€
			if (Store.rooms.length > 0) {
				await syncRoomStatusToCloud(Store.rooms);
			}
			
			// åŒæ­¥ç»ƒä¹ è®°å½•ï¼ˆå¦‚æœæœ‰æœ¬åœ°è®°å½•ï¼‰
			await syncPracticeLogsToCloud();

			// æé†’æ•°æ®ï¼špractice_alerts å·²ç›´æ¥å†™äº‘ï¼Œæ— éœ€ä¸Šè¡Œï¼›æ­¤å¤„åˆ·æ–°ä¸€æ¬¡ä»¥ç¡®ä¿ UI æœ€æ–°
			if(window.PracticeAlerts){ await PracticeAlerts.initAlerts?.(); }

			// è‹¥éœ€è¦å°†ä»Šæ—¥ slots ç¼“å­˜åˆ·æ–°ï¼ˆå¯é€‰ï¼‰
			if(window.PracticeAlerts && window.PracticeAlerts.detectionTick){ await PracticeAlerts.detectionTick(); }
			
			// æ›´æ–°äº‘ç«¯æ•°é‡æ˜¾ç¤º
			const cloudRoomCountEl = document.getElementById('cloudRoomCount');
			const cloudStudentCountEl = document.getElementById('cloudStudentCount');
			if (cloudRoomCountEl) cloudRoomCountEl.textContent = Store.rooms.length;
			if (cloudStudentCountEl) cloudStudentCountEl.textContent = Store.students.length;
			
			// æ›´æ–°åŒæ­¥æ—¶é—´
			updateCloudSyncInfo();
			
			toast('âœ… æ‰€æœ‰æ•°æ®å·²åŒæ­¥ï¼ˆå«æé†’åˆ·æ–°ï¼‰');
			logInfo('æ‰‹åŠ¨åŒæ­¥å®Œæˆï¼šåŸºç¡€æ•°æ® + å®æ—¶çŠ¶æ€ + ç»ƒä¹ è®°å½• + æé†’åˆ·æ–°');
		} catch (error) {
			toast('åŒæ­¥å¤±è´¥', 'error');
			logErr('æ‰‹åŠ¨åŒæ­¥å¤±è´¥:', error.message);
		}
	}

	// åŒæ­¥æˆ¿é—´å®æ—¶çŠ¶æ€åˆ° rooms è¡¨
	async function syncRoomStatusToCloud(rooms) {
		if (!supabaseReady) {
			logWarn('Supabase æœªè¿æ¥ï¼Œè·³è¿‡æˆ¿é—´çŠ¶æ€åŒæ­¥');
			return;
		}
		
		try {
			const statusData = rooms.map(room => ({
				name: room.name,
				occupant_student_name: room.occupant || null,
				register_time: room.registerTime ? new Date(room.registerTime).toISOString() : null,
				heartbeat_at: new Date().toISOString(),
				version: room.version || 1,
				updated_at: new Date().toISOString()
			}));
			
			// ä½¿ç”¨ upsert æ‰¹é‡æ›´æ–°æˆ¿é—´å®æ—¶çŠ¶æ€
			const { data, error } = await supabaseClient
				.from('rooms')
				.upsert(statusData, { 
					onConflict: 'name',
					ignoreDuplicates: false 
				});
			
			if (error) {
				logErr('åŒæ­¥æˆ¿é—´çŠ¶æ€å¤±è´¥:', error.message);
				toast('æˆ¿é—´çŠ¶æ€åŒæ­¥å¤±è´¥', 'error');
			} else {
				logInfo(`âœ… æˆåŠŸåŒæ­¥ ${statusData.length} ä¸ªæˆ¿é—´çŠ¶æ€åˆ°äº‘ç«¯`);
			}
		} catch (err) {
			logErr('æˆ¿é—´çŠ¶æ€åŒæ­¥å¼‚å¸¸:', err.message);
		}
	}

	// åŒæ­¥ç»ƒä¹ è®°å½•åˆ° practice_logs è¡¨
	async function syncPracticeLogsToCloud() {
		if (!supabaseReady) {
			logWarn('Supabase æœªè¿æ¥ï¼Œè·³è¿‡ç»ƒä¹ è®°å½•åŒæ­¥');
			return;
		}
		
		// æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°ç»ƒä¹ è®°å½•å­˜å‚¨
		if (!Store.localPracticeLogs || Store.localPracticeLogs.length === 0) {
			logInfo('æ— æœ¬åœ°ç»ƒä¹ è®°å½•éœ€è¦åŒæ­¥');
			return;
		}
		
		try {
			// è¿‡æ»¤å‡ºå°šæœªåŒæ­¥çš„è®°å½•
			const unsyncedLogs = Store.localPracticeLogs.filter(log => !log.synced);
			
			if (unsyncedLogs.length === 0) {
				logInfo('æ‰€æœ‰ç»ƒä¹ è®°å½•å·²åŒæ­¥');
				return;
			}
			
			// æ‰¹é‡æ’å…¥ç»ƒä¹ è®°å½•
			const { data, error } = await supabaseClient
				.from('practice_logs')
				.insert(unsyncedLogs);
			
			if (error) {
				logErr('åŒæ­¥ç»ƒä¹ è®°å½•å¤±è´¥:', error.message);
				toast('ç»ƒä¹ è®°å½•åŒæ­¥å¤±è´¥', 'error');
			} else {
				// æ ‡è®°ä¸ºå·²åŒæ­¥
				unsyncedLogs.forEach(log => log.synced = true);
				logInfo(`âœ… æˆåŠŸåŒæ­¥ ${unsyncedLogs.length} æ¡ç»ƒä¹ è®°å½•åˆ°äº‘ç«¯`);
			}
		} catch (err) {
			logErr('ç»ƒä¹ è®°å½•åŒæ­¥å¼‚å¸¸:', err.message);
		}
	}
	async function importJson(obj){
		if(Array.isArray(obj)){
			// çŒœæµ‹æ˜¯æˆ¿é—´æ•°ç»„æˆ–å­¦ç”Ÿæ•°ç»„
			if(obj.length && obj[0].pianoType || obj[0].piano_type || obj[0].location){
				await mergeRooms(obj.map(canonicalizeRoom), { metaOnly: true });
				toast('å¯¼å…¥æˆ¿é—´ '+obj.length+' æ¡');
			}else if(obj.length && (obj[0].major || obj[0].grade || obj[0].name)){
				await mergeStudents(obj);
				toast('å¯¼å…¥å­¦ç”Ÿ '+obj.length+' æ¡');
			}else{
				toast('æœªçŸ¥æ•°ç»„ç»“æ„ï¼Œå·²å¿½ç•¥');
			}
		} else if(obj && obj.rooms && obj.students){
			if(Array.isArray(obj.rooms)) await mergeRooms(obj.rooms.map(canonicalizeRoom), { metaOnly: true });
			if(Array.isArray(obj.students)) await mergeStudents(obj.students);
			toast('å¯¼å…¥é›†åˆå®Œæˆ');
		} else {
			toast('ä¸æ”¯æŒçš„ JSON ç»“æ„');
		}
		renderRooms(); updateUsageStats(); refreshStudentModalCache();
	}
	// mergeRooms(list, options)
	// options:
	//  - skipCloudSync: è·³è¿‡äº‘ç«¯åŒæ­¥ï¼ˆç”¨äºä»äº‘ç«¯æ‹‰å–å›å†™æœ¬åœ°æ—¶ï¼Œé˜²é€’å½’ï¼‰
	//  - metaOnly: ä»…æ›´æ–°é™æ€å…ƒæ•°æ®ï¼ˆname/pianoType/location/remarkï¼‰ï¼Œä¸è§¦ç¢° occupant/registerTime/version/heartbeatAt
	async function mergeRooms(list, options = { skipCloudSync: false, metaOnly: false }){
		let added=0, updated=0;
		const newRooms = [];
		
		list.forEach(r=>{ 
			if(!r||!r.name) return; 
			const norm = canonicalizeRoom(r);
			let existing=Store.rooms.find(x=>x.name===norm.name); 
			if(existing){ 
				if(options.metaOnly){
					// ä»…æ›´æ–°é™æ€å­—æ®µ
					existing.name = norm.name;
					existing.pianoType = norm.pianoType;
					existing.location = norm.location;
					existing.remark = norm.remark;
				} else {
					// å…¨é‡åˆå¹¶ï¼ˆå«å¯èƒ½çš„åŠ¨æ€å­—æ®µï¼‰
					Object.assign(existing,norm);
					// ç»Ÿä¸€è§„èŒƒå¹¶ç¡®ä¿ version æ•°å­—ï¼ˆä»…å½“æ­¤æ¬¡åˆå¹¶åŒ…å« version å­—æ®µæ—¶ï¼‰
					if('version' in norm && (existing.version==null || isNaN(existing.version))) existing.version=0;
				}
				updated++; 
			} else { 
				// æ–°å¢ï¼šè‹¥ metaOnlyï¼Œè¡¥é½åŠ¨æ€å­—æ®µé»˜è®¤å€¼ï¼Œé¿å…åç»­ä½¿ç”¨æ—¶æŠ¥ undefined
				if(options.metaOnly){
					norm.occupant = norm.occupant ?? null;
					norm.registerTime = norm.registerTime ?? null;
					norm.version = norm.version ?? 0;
					norm.heartbeatAt = norm.heartbeatAt ?? null;
				}
				Store.rooms.push(norm); 
				newRooms.push(norm);
				added++; 
			}
		});
		
		rebuildIndexes();
		// å¦‚æœå½“å‰æ¥¼å±‚è¿‡æ»¤å·²ä¸åœ¨é›†åˆä¸­åˆ™é‡ç½®
		if(Store.filters.floor!=='ALL' && !Store.floorSet.has(Store.filters.floor)) { Store.filters.floor='ALL'; }
		// è‹¥å½“å‰è¿‡æ»¤å¯¼è‡´æ— ç»“æœåˆ™å°è¯•è‡ªåŠ¨å›é€€
		const visible=Store.rooms.filter(roomFilter).length;
		if(!visible){ Store.filters.floor='ALL'; Store.filters.type='ALL'; }
		logInfo(`åˆå¹¶æˆ¿é—´: æ–°å¢ ${added} æ›´æ–° ${updated} æ€»æ•° ${Store.rooms.length}`);
		
		// è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯æ•°æ®åº“ï¼ˆé™¤éè·³è¿‡ï¼‰
		if (!options.skipCloudSync && list.length > 0) {
			await syncRoomDatabaseToCloud(list);
		}
	}
	
	async function mergeStudents(list, skipCloudSync = false){
		const newStudents = [];
		
		list.forEach(s=>{ 
			if(!s||!s.name) return; 
			let ex=Store.students.find(x=>x.name===s.name); 
			if(ex){ 
				Object.assign(ex,s); 
			} else { 
				Store.students.push(s);
				newStudents.push(s);
			} 
		});
		
		rebuildStudentIndex();
		
		// è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯æ•°æ®åº“ï¼ˆé™¤éè·³è¿‡ï¼‰
		if (!skipCloudSync && list.length > 0) {
			await syncStudentDatabaseToCloud(list);
		}
	}
	function exportRooms(){
		downloadJson(Store.rooms,'rooms_export.json');
	}
	function exportStudents(){ downloadJson(Store.students,'students_export.json'); }
	function downloadJson(data, file){ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=file; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }

	// æ–°å¢: é€šç”¨ CSV è§£æï¼ˆæ”¯æŒå¼•å·ã€è½¬ä¹‰åŒå¼•å·ã€BOMã€CRLFï¼‰
	function parseCSV(raw){
		if(!raw) return {header:[], rows:[]};
		// å»é™¤ BOM
		if(raw.charCodeAt(0)===0xFEFF) raw=raw.slice(1);
		raw = raw.replace(/\r\n?/g,'\n');
		const rows=[]; let cur=[]; let field=''; let inQuotes=false; let i=0;
		function pushField(){ cur.push(field); field=''; }
		function pushRow(){ rows.push(cur); cur=[]; }
		while(i<raw.length){ const ch=raw[i];
			if(inQuotes){
				if(ch==='"'){
					if(raw[i+1]==='"'){ field+='"'; i++; }
					else { inQuotes=false; }
				}else{ field+=ch; }
			}else{
				if(ch==='"'){ inQuotes=true; }
				else if(ch===','){ pushField(); }
				else if(ch==='\n'){ pushField(); pushRow(); }
				else { field+=ch; }
			}
			i++;
		}
		if(field.length>0 || cur.length>0){ pushField(); pushRow(); }
		if(!rows.length) return {header:[], rows:[]};
		const header = rows.shift().map(h=>h.trim());
		return { header, rows: rows.filter(r=> r.some(c=>c.trim()!=='')) };
	}
	function normalizeHeaderKey(k){ return k.replace(/\s+/g,'').replace(/[ _-]/g,'').toLowerCase(); }
	function detectCSVType(header){
		const keys = header.map(normalizeHeaderKey);
		const roomHits = ['åç§°','ä½ç½®','ç±»å‹','å¤‡æ³¨'].map(normalizeHeaderKey).every(h=>keys.includes(h));
		const studentHits = (keys.includes('å§“å')||keys.includes('name')) && keys.includes('ä¸“ä¸š');
		if(roomHits) return 'rooms'; if(studentHits) return 'students'; return 'unknown';
	}
	async function importCsvRooms(header, rows){
		const idx = Object.create(null); header.forEach((h,i)=>{ idx[normalizeHeaderKey(h)]=i; });
		const out=[]; rows.forEach(r=>{
			const name=r[idx['åç§°']??idx['mingcheng']??idx['name']]; if(!name) return;
			const location=r[idx['ä½ç½®']]; const pianoType=r[idx['ç±»å‹']]||'æ— é’¢ç´'; const remark=r[idx['å¤‡æ³¨']]||'';
			out.push({ name: name.trim(), location: (location||'').trim(), pianoType: pianoType.trim(), remark: remark.trim() });
		});
		await mergeRooms(out.map(o=>({name:o.name, location:o.location, pianoType:o.pianoType, remark:o.remark})), { metaOnly: true });
		toast('CSV å¯¼å…¥ç´æˆ¿ '+out.length+' æ¡');
		renderRooms(); updateUsageStats();
	}
	async function importCsvStudents(header, rows){
		const idx = Object.create(null); header.forEach((h,i)=>{ idx[normalizeHeaderKey(h)]=i; });
		const out=[]; rows.forEach(r=>{
			const name=r[idx['å§“å']??idx['name']]; if(!name) return;
			const major=r[idx['ä¸“ä¸š']??idx['major']]||''; const grade=r[idx['å¹´çº§']??idx['grade']]||''; const idRaw=r[idx['id']]||r[idx['ç¼–å·']]||'';
			out.push({ id: idRaw||undefined, name: name.trim(), major: major.trim(), grade: grade.trim() });
		});
		await mergeStudents(out);
		toast('CSV å¯¼å…¥å­¦ç”Ÿ '+out.length+' æ¡');
	}

	// ç»‘å®šé¡¶éƒ¨æŒ‰é’®
	function bind(id, handler){
		const el = document.getElementById(id);
		if(el){ el.onclick = handler; }
		else { /* ä»…è°ƒè¯•è¾“å‡ºï¼Œä¸æŠ›é”™é˜»æ–­åˆå§‹åŒ– */ console.warn('[WARN] æŒ‰é’®ç¼ºå¤±:', id); }
	}
	// å·²ç§»é™¤å¯¼å…¥ç´æˆ¿æŒ‰é’®ï¼ˆé¡¶æ ä¸é¢æ¿å†…ï¼‰ï¼Œä¿ç•™å­¦ç”Ÿå¯¼å…¥
	bind('btnImportStudents', ()=>{ document.getElementById('hiddenFileImport')?.click(); });
	bind('btnSyncToCloud', manualSyncToCloud);
	bind('btnReconnect', async function(){
		logInfo('ç”¨æˆ·æ‰‹åŠ¨é‡è¿');
		supabaseReady = false;
		await initSupabase();
		if (supabaseReady) {
			await setupRealtime();
			await fetchRoomMeta();
			await fetchStudents();
			updateCloudSyncInfo();
		}
	});
	bind('btnRefresh', ()=>bootstrap());
	bind('btnEditRooms', toggleEditMode);
	
	// ç¼–è¾‘æ¨¡å¼åˆ‡æ¢
	function toggleEditMode() {
		Store.editMode = !Store.editMode;
		const btn = document.getElementById('btnEditRooms');
		if (Store.editMode) {
			btn.textContent = 'ä¿å­˜';
			btn.classList.add('active');
		} else {
			btn.textContent = 'ç¼–è¾‘';
			btn.classList.remove('active');
			// ä¿å­˜æ¨¡å¼ï¼šåŒæ­¥æ‰€æœ‰ä¿®æ”¹åˆ°äº‘ç«¯
			saveAllRoomChanges();
		}
		renderRooms();
		ensureFilters();
	}
	
	// ä¿å­˜æ‰€æœ‰æˆ¿é—´ä¿®æ”¹
	async function saveAllRoomChanges() {
		try {
			toast('æ­£åœ¨ä¿å­˜ä¿®æ”¹...', 'info');
			// åŒæ­¥åˆ°äº‘ç«¯
			if (Store.rooms.length > 0) {
				await syncRoomDatabaseToCloud(Store.rooms);
			}
			toast('âœ… æ‰€æœ‰ä¿®æ”¹å·²ä¿å­˜åˆ°äº‘ç«¯');
		} catch (error) {
			toast('ä¿å­˜å¤±è´¥', 'error');
			logErr('ä¿å­˜æˆ¿é—´ä¿®æ”¹å¤±è´¥:', error.message);
		}
	}
	
	// åˆ é™¤ç´æˆ¿
	async function deleteRoom(roomName) {
		try {
			const room = Store.byName.get(roomName);
			if (!room) {
				toast('æˆ¿é—´ä¸å­˜åœ¨', 'warn');
				return;
			}
			
			// è®¾ç½®åˆ é™¤æ“ä½œé”ï¼Œé˜²æ­¢å®æ—¶æ›´æ–°å¹²æ‰°
			const deleteLockKey = `delete_${roomName}`;
			if (!Store.operationLocks) Store.operationLocks = new Set();
			Store.operationLocks.add(deleteLockKey);
			
			try {
				// å¦‚æœæˆ¿é—´æœ‰å ç”¨è€…ï¼Œå…ˆæ¸…ç©º
				if (room.occupant) {
					toast('æˆ¿é—´æœ‰å ç”¨è€…ï¼Œå°†å…ˆæ¸…ç©º...', 'info');
					await clearRoom(roomName);
				}
				
				// ä»æœ¬åœ°æ•°æ®ä¸­ç§»é™¤
				const index = Store.rooms.findIndex(r => r.name === roomName);
				if (index !== -1) {
					Store.rooms.splice(index, 1);
					Store.byName.delete(roomName);
				}
				
				// æ¸…ç†æ‰€æœ‰ç›¸å…³çŠ¶æ€
				cleanupRoomState(roomName);
				
				// ä»äº‘ç«¯åˆ é™¤
				if (!Store.settings.offlineMode) {
					await supabaseClient.from('room_database').delete().eq('name', roomName);
					await supabaseClient.from('rooms').delete().eq('name', roomName);
				}
				
				// é‡æ–°æ¸²æŸ“
				rebuildIndexes(); // é‡å»ºç´¢å¼•ï¼Œæ›´æ–°æ¥¼å±‚é›†åˆ
				renderRooms();
				ensureFilters();
				
				toast(`âœ… å·²åˆ é™¤ç´æˆ¿ï¼š${roomName}`);
				logInfo(`åˆ é™¤ç´æˆ¿ï¼š${roomName}`);
			} finally {
				// å»¶è¿Ÿæ¸…é™¤åˆ é™¤é”ï¼Œç¡®ä¿å®æ—¶æ›´æ–°ä¸ä¼šåœ¨åˆ é™¤è¿‡ç¨‹ä¸­å¹²æ‰°
				setTimeout(() => {
					Store.operationLocks.delete(deleteLockKey);
				}, 2000);
			}
		} catch (error) {
			toast('åˆ é™¤å¤±è´¥', 'error');
			logErr('åˆ é™¤ç´æˆ¿å¤±è´¥:', error.message);
		}
	}
	
	// ç»‘å®šå†…è”ç¼–è¾‘äº‹ä»¶
	function bindInlineEditEvents() {
		const grid = document.getElementById('roomGrid');
		
		// ç›‘å¬å¯ç¼–è¾‘å…ƒç´ çš„è¾“å…¥äº‹ä»¶
		grid.addEventListener('blur', e => {
			if (!e.target.hasAttribute('contenteditable')) return;
			saveInlineEdit(e.target);
		}, true);
		
		// ç›‘å¬å›è½¦é”®ä¿å­˜
		grid.addEventListener('keydown', e => {
			if (!e.target.hasAttribute('contenteditable')) return;
			if (e.key === 'Enter') {
				e.preventDefault();
				e.target.blur(); // è§¦å‘bluräº‹ä»¶ä¿å­˜
			}
		});
		
		// ç›‘å¬ç´æˆ¿ç±»å‹é€‰æ‹©å™¨å˜åŒ–
		grid.addEventListener('change', e => {
			if (!e.target.classList.contains('piano-type-selector')) return;
			savePianoTypeChange(e.target);
		});
		
		// ä¸ºç©ºçš„å¤‡æ³¨æä¾›å ä½æç¤ºï¼Œæˆ¿é—´åç§°è·å¾—ç„¦ç‚¹æ—¶ä¿æŒçº¯æ–‡æœ¬
		grid.addEventListener('focus', e => {
			if (!e.target.hasAttribute('contenteditable')) return;
			
			if (e.target.dataset.field === 'remark' && e.target.textContent === 'ç‚¹å‡»æ·»åŠ å¤‡æ³¨...') {
				e.target.textContent = '';
			} else if (e.target.dataset.field === 'name') {
				// æˆ¿é—´åç§°è·å¾—ç„¦ç‚¹æ—¶ï¼Œç§»é™¤å¯èƒ½çš„HTMLæ ‡ç­¾ï¼Œåªä¿ç•™çº¯æ–‡æœ¬åç§°
				const card = e.target.closest('.room-card');
				if (card) {
					const roomName = card.dataset.room;
					e.target.textContent = roomName;
				}
			}
		}, true);
	}
	
	// ä¿å­˜ç´æˆ¿ç±»å‹å˜åŒ–
	function savePianoTypeChange(selectElement) {
		const roomName = selectElement.dataset.room;
		const newType = selectElement.value;
		
		const room = Store.byName.get(roomName);
		if (!room) return;
		
		// æ˜ å°„é€‰æ‹©å™¨å€¼åˆ°æ•°æ®åº“æ ¼å¼
		let pianoType = '';
		switch(newType) {
			case 'ä¸‰è§’':
				pianoType = 'ä¸‰è§’é’¢ç´';
				break;
			case 'ç«‹å¼':
				pianoType = 'ç«‹å¼é’¢ç´';
				break;
			case 'å…¶ä»–':
			default:
				pianoType = 'å…¶ä»–';
				break;
		}
		
		// æ›´æ–°æœ¬åœ°æ•°æ®
		room.pianoType = pianoType;
		
		// æ›´æ–°å¡ç‰‡çš„ data-grand å±æ€§
		const card = selectElement.closest('.room-card');
		if (card) {
			const isGrand = /ä¸‰è§’/.test(pianoType);
			card.dataset.grand = isGrand ? '1' : '0';
		}
		
		logInfo(`æ›´æ–°æˆ¿é—´ç±»å‹ï¼š${roomName} -> ${pianoType}`);
		
		// é‡æ–°æ¸²æŸ“å¡ç‰‡ä»¥æ›´æ–°è¿‡æ»¤çŠ¶æ€
		setTimeout(() => {
			renderRoomCard(roomName);
		}, 0);
	}
	
	// ä¿å­˜å†…è”ç¼–è¾‘
	function saveInlineEdit(element) {
		const card = element.closest('.room-card');
		if (!card) return;
		
		const roomName = card.dataset.room;
		const field = element.dataset.field;
		const value = element.textContent.trim();
		
		const room = Store.byName.get(roomName);
		if (!room) return;
		
		// æ›´æ–°æœ¬åœ°æ•°æ®
		if (field === 'name') {
			// æˆ¿é—´åç§°ä¿®æ”¹éœ€è¦ç‰¹æ®Šå¤„ç†
			if (value && value !== room.name) {
				if (Store.byName.has(value)) {
					toast('æˆ¿é—´åç§°å·²å­˜åœ¨', 'warn');
					element.textContent = room.name; // æ¢å¤åŸå€¼
					return;
				}
				
				// æ›´æ–°ç´¢å¼•
				Store.byName.delete(room.name);
				room.name = value;
				Store.byName.set(value, room);
				card.dataset.room = value;
				
				logInfo(`æˆ¿é—´é‡å‘½åï¼š${roomName} -> ${value}`);
				
				// é‡æ–°æ¸²æŸ“è¿™ä¸ªå¡ç‰‡ä»¥æ˜¾ç¤ºæ­£ç¡®çš„æ ‡ç­¾
				setTimeout(() => {
					renderRoomCard(value);
				}, 0);
			}
		} else if (field === 'remark') {
			room.remark = value || '';
			logInfo(`æ›´æ–°æˆ¿é—´å¤‡æ³¨ï¼š${roomName} -> ${value}`);
			
			// æ¢å¤å ä½æ–‡å­—
			if (!value) {
				element.textContent = 'ç‚¹å‡»æ·»åŠ å¤‡æ³¨...';
			}
		}
	}
	
	// å·²ç§»é™¤çš„æŒ‰é’®ï¼ˆä¸»é¢˜ / é‡ç½®è¿‡æ»¤ / ç»Ÿè®¡ï¼‰ä¸å†ç¡¬ç»‘å®šï¼Œé¿å…å› ä¸å­˜åœ¨å¯¼è‡´è„šæœ¬åœæ­¢
	// å¦‚æœä»éœ€é‡ç½®è¿‡æ»¤ï¼Œå¯åœ¨å…¶å®ƒå…¥å£è°ƒç”¨è¯¥å‡½æ•°
	function resetFilters(){ Store.filters.floor='ALL'; Store.filters.type='ALL'; renderRooms(); }
	// å·²ç§»é™¤ä¾§æ å¿«é€Ÿå¯¼å…¥/å¯¼å‡ºåŒºå—ï¼Œä»¥ä¸‹é€»è¾‘ç®€åŒ–ï¼šæä¾›ä¸€ä¸ªéšè— input å¤ç”¨
	let hiddenInput=document.getElementById('hiddenFileImport');
	if(!hiddenInput){ hiddenInput=document.createElement('input'); hiddenInput.type='file'; hiddenInput.id='hiddenFileImport'; hiddenInput.accept='.json,.csv'; hiddenInput.style.display='none'; document.body.appendChild(hiddenInput); }
	hiddenInput.addEventListener('change', e=>{ 
		const f=e.target.files[0]; if(!f) return; const name=f.name.toLowerCase(); const reader=new FileReader(); 
		reader.onload = async () => {
			try{
				const text=reader.result;
				if(name.endsWith('.csv')){
					const {header, rows}=parseCSV(text);
					if(!header.length){ toast('ç©º CSV'); return; }
					const type=detectCSVType(header);
					
					if(type==='rooms') {
						toast('æ­£åœ¨å¯¼å…¥ç´æˆ¿æ•°æ®...', 'info');
						await importCsvRooms(header, rows);
					} else if(type==='students') {
						toast('æ­£åœ¨å¯¼å…¥å­¦ç”Ÿæ•°æ®...', 'info');
						await importCsvStudents(header, rows);
					} else {
						toast('æ— æ³•è¯†åˆ«çš„ CSV è¡¨å¤´');
					}
				} else { 
					await importJson(JSON.parse(text)); 
				}
			}catch(err){ 
				toast('æ–‡ä»¶è§£æå¤±è´¥'); 
				logErr('è§£æå¤±è´¥', err.message); 
			}
		}; 
		reader.readAsText(f,'utf-8'); 
		e.target.value=''; 
	});

	window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeStudentModal(); }});

	/*************************************************
	 * æ¸²æŸ“ & è¿‡æ»¤
	 *************************************************/
	function rebuildIndexes(){
		Store.byName.clear(); Store.floorSet.clear();
		Store.rooms.forEach(r=>{ Store.byName.set(r.name,r); const floor=deriveFloor(r.location); if(floor) Store.floorSet.add(floor); });
	}
	function rebuildStudentIndex(){ Store.studentIndex.clear(); Store.students.forEach(s=>Store.studentIndex.set(s.name,s)); }
	function deriveFloor(location){ if(!location) return 'æœªçŸ¥'; const m=location.match(/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹0-9]+/); if(!m) return location; const map={ä¸€:1,äºŒ:2,ä¸‰:3,å››:4,äº”:5,å…­:6,ä¸ƒ:7,å…«:8,ä¹:9}; const raw=m[0]; return String(map[raw]||raw); }
	function ensureFilters(){
		const floorWrap=document.getElementById('floorFilters');
		const typeWrap=document.getElementById('typeFilters');
		
		// è·å–å½“å‰è¿‡æ»¤æ¡ä»¶ä¸‹æœ‰æˆ¿é—´çš„æ¥¼å±‚
		const currentTypeFilter = Store.filters.type;
		const availableRooms = Store.rooms.filter(r => {
			// åº”ç”¨ç±»å‹è¿‡æ»¤å™¨ï¼Œæ£€æŸ¥å“ªäº›æˆ¿é—´åœ¨å½“å‰ç±»å‹è¿‡æ»¤ä¸‹å¯è§
			if (currentTypeFilter === 'ALL') return true;
			const isGrand = /ä¸‰è§’/.test(r.pianoType);
			if (currentTypeFilter === 'GRAND') return isGrand;
			if (currentTypeFilter === 'UPRIGHT') return !isGrand && !/æ— |ç”µå­/i.test(r.pianoType);
			if (currentTypeFilter === 'NONE') return !isGrand && !/ç«‹|upright|ä¸‰è§’/.test(r.pianoType);
			return true;
		});
		
		// æ„å»ºå½“å‰å¯è§æˆ¿é—´çš„æ¥¼å±‚é›†åˆ
		const activeFloorSet = new Set();
		availableRooms.forEach(r => {
			const floor = deriveFloor(r.location);
			if (floor) activeFloorSet.add(floor);
		});
		
		const floors=['ALL',...Array.from(activeFloorSet).sort((a,b)=>a.localeCompare(b,'zh-Hans-CN',{numeric:true}))];
		logInfo(`æ¥¼å±‚è¿‡æ»¤å™¨æ›´æ–°: æ˜¾ç¤º ${floors.length-1} ä¸ªæœ‰æˆ¿é—´çš„æ¥¼å±‚`);
		
		// å¦‚æœå½“å‰é€‰ä¸­çš„æ¥¼å±‚åœ¨æ–°çš„æ¥¼å±‚åˆ—è¡¨ä¸­ä¸å­˜åœ¨ï¼Œé‡ç½®ä¸ºALL
		if (Store.filters.floor !== 'ALL' && !activeFloorSet.has(Store.filters.floor)) {
			logInfo(`å½“å‰æ¥¼å±‚ ${Store.filters.floor} æ— æˆ¿é—´ï¼Œé‡ç½®ä¸ºå…¨éƒ¨`);
			Store.filters.floor = 'ALL';
		}
		let floorHTML = floors.map(f=>`<button data-floor="${f}" data-active="${Store.filters.floor===f?1:0}">${f==='ALL'?'å…¨éƒ¨æ¥¼å±‚':f+'æ¥¼'}</button>`).join('');
		
		// ç¼–è¾‘æ¨¡å¼ä¸‹æ·»åŠ æ–°å¢æˆ¿é—´æŒ‰é’®
		if (Store.editMode) {
			floorHTML += `<button id="btnAddRoom" class="add-room-btn" title="æ–°å¢ç´æˆ¿">ğŸ¹ æ–°å¢ç´æˆ¿</button>`;
		}
		
		floorWrap.innerHTML = floorHTML;
		typeWrap.innerHTML = ['ALL','GRAND','UPRIGHT','NONE'].map(t=>`<button data-type="${t}" data-active="${Store.filters.type===t?1:0}">${labelType(t)}</button>`).join('');
		
		floorWrap.querySelectorAll('button').forEach(b=>{
			if(b.dataset.floor) {
				b.onclick=()=>{Store.filters.floor=b.dataset.floor; renderRooms();};
			}
		});
		typeWrap.querySelectorAll('button').forEach(b=>b.onclick=()=>{Store.filters.type=b.dataset.type; renderRooms();});
		
		// ç»‘å®šæ–°å¢æˆ¿é—´æŒ‰é’®
		if (Store.editMode) {
			bind('btnAddRoom', showAddRoomModal);
		}
	}
	function labelType(t){ if(t==='ALL') return 'å…¨éƒ¨ç±»å‹'; if(t==='GRAND') return 'ä¸‰è§’'; if(t==='UPRIGHT') return 'ç«‹å¼'; return 'å…¶å®ƒ'; }
	function roomFilter(r){
		const floor=deriveFloor(r.location);
		if(Store.filters.floor!=='ALL' && floor!==Store.filters.floor) return false;
		const isGrand = /ä¸‰è§’/.test(r.pianoType);
		if(Store.filters.type==='GRAND' && !isGrand) return false;
		if(Store.filters.type==='UPRIGHT' && (isGrand || /æ— |ç”µå­/i.test(r.pianoType))) return false;
		if(Store.filters.type==='NONE' && (isGrand || /ç«‹|upright|ä¸‰è§’/.test(r.pianoType))) return false;
		return true;
	}
	function renderRooms(){
		ensureFilters();
		const grid=document.getElementById('roomGrid');
		// è‡ªå®šä¹‰æ’åºï¼šå…ˆæŒ‰ç´æˆ¿ç±»å‹(ä¸‰è§’ > ç«‹å¼ > å…¶å®ƒ)ï¼Œå†æŒ‰åç§°â€œå­—æ¯ä¼˜å…ˆã€æ•°å­—å…¶æ¬¡â€
		const typeRank = r => {
			if(/ä¸‰è§’/.test(r.pianoType)) return 0; // GRAND
			if(/ç«‹å¼|upright/i.test(r.pianoType)) return 1; // UPRIGHT
			return 2; // OTHER
		};
		// è§£æåç§°ï¼šæå–å¼€å¤´çš„å­—æ¯å‰ç¼€ä¸å…¶åçš„æ•°å­—ï¼Œä¾‹å¦‚ A12 -> {alpha:'A', num:12}
		const parseAlphaNum = (name) => {
			const s = String(name||'').trim();
			// æ¨¡å¼1ï¼šå­—æ¯ + å¯é€‰åˆ†éš”ç¬¦ + æ•°å­—
			let m = s.match(/^\s*([A-Za-z]+)\s*[-_ ]*\s*(\d+)/);
			if(m) return { alpha: m[1].toUpperCase(), num: parseInt(m[2],10), hasAlpha: true, hasNum: true };
			// æ¨¡å¼2ï¼šä»…å­—æ¯å‰ç¼€
			m = s.match(/^\s*([A-Za-z]+)/);
			if(m) return { alpha: m[1].toUpperCase(), num: null, hasAlpha: true, hasNum: false };
			return { alpha: '', num: null, hasAlpha: false, hasNum: false };
		};
		const list=Store.rooms
			.filter(roomFilter)
			.slice() // é˜²æ­¢åŸæ•°ç»„è¢«æ„å¤–æ’åº
			.sort((a,b)=>{
				const ta=typeRank(a), tb=typeRank(b);
				if(ta!==tb) return ta-tb;
				// åŒç±»å‹ï¼šå…ˆæ¯”è¾ƒå­—æ¯å‰ç¼€ï¼Œå†æ¯”è¾ƒæ•°å­—ï¼›éƒ½æ— è§„åˆ™æ—¶å›é€€è‡ªç„¶æ¯”è¾ƒ
				const pa = parseAlphaNum(a.name);
				const pb = parseAlphaNum(b.name);
				if(pa.alpha !== pb.alpha){
					// å­—æ¯å‰ç¼€ä¸åŒï¼šæŒ‰å­—æ¯åºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
					return pa.alpha.localeCompare(pb.alpha, 'en', { sensitivity: 'base' });
				}
				// å­—æ¯å‰ç¼€ç›¸åŒï¼šè‹¥éƒ½æœ‰æ•°å­—åˆ™æ¯”è¾ƒæ•°å­—
				if(pa.hasNum && pb.hasNum && pa.num !== pb.num) return pa.num - pb.num;
				// ä»…ä¸€æ–¹æœ‰æ•°å­—ï¼šæ— æ•°å­—çš„åœ¨å‰
				if(pa.hasNum !== pb.hasNum) return pa.hasNum ? 1 : -1;
				// å›é€€ï¼šä¸­æ–‡/å…¶å®ƒæƒ…å†µä½¿ç”¨è‡ªç„¶æ¯”è¾ƒï¼ˆå«æ•°å­—è¯†åˆ«ï¼‰
				return a.name.localeCompare(b.name,'zh-Hans-CN',{numeric:true});
			});
		logInfo(`å·²æŒ‰ç±»å‹ä¸å­—æ¯+æ•°å­—æ’åº: total ${list.length}`);
		// æ„å»ºå¸¦åˆ†éš”çº¿çš„HTML
		let htmlParts=[];
		let lastType=-1;
		const typeLabelMap={0:'ä¸‰è§’é’¢ç´',1:'ç«‹å¼é’¢ç´',2:'å…¶ä»–ç±»å‹'};
		const typeClassMap={0:'grand',1:'upright',2:'other'};
		for(const r of list){
			const t=typeRank(r);
			if(t!==lastType){
				if(lastType!==-1) htmlParts.push(''); // åˆ†ç»„è‡ªç„¶æ¢è¡Œ
				// å¦‚æœè¿‡æ»¤ååªæœ‰ä¸€ç§ç±»å‹åˆ™ä¸æ˜¾ç¤ºåˆ†éš”çº¿ï¼šå»¶ååˆ¤æ–­
				htmlParts.push(`<div class="room-type-separator ${typeClassMap[t]}" data-type-sep="${t}"><div class="line"></div><div class="label">${typeLabelMap[t]}</div><div class="line"></div></div>`);
				lastType=t;
			}
			htmlParts.push(roomCardHTML(r));
		}
		// å¦‚æœæœ€ç»ˆåªæœ‰ä¸€ä¸ªåˆ†éš”çº¿ä¸”å…¶ååªæœ‰æˆ¿é—´ï¼Œä¸”æ²¡æœ‰å‡ºç°ç¬¬äºŒç§ç±»å‹ï¼Œåˆ™ç§»é™¤è¯¥åˆ†éš”çº¿ï¼ˆå•ä¸€ç±»å‹ä¸éœ€è¦ï¼‰
		const sepCount=htmlParts.filter(h=>/room-type-separator/.test(h)).length;
		if(sepCount===1){
			htmlParts=htmlParts.filter(h=>!/room-type-separator/.test(h));
		}
		grid.innerHTML=htmlParts.join('');
		
		// æ·»åŠ å†…è”ç¼–è¾‘äº‹ä»¶ç›‘å¬
		if (Store.editMode) {
			bindInlineEditEvents();
		}
	}
	function renderRoomCard(name){ 
		const r=Store.byName.get(name); 
		const grid=document.getElementById('roomGrid'); 
		const el=grid.querySelector(`[data-room='${CSS.escape(name)}']`); 
		
		if(!r) {
			// æˆ¿é—´æ•°æ®ä¸å­˜åœ¨ï¼Œç§»é™¤DOMå…ƒç´ 
			if(el) {
				logInfo(`ç§»é™¤å·²åˆ é™¤æˆ¿é—´çš„å¡ç‰‡: ${name}`);
				el.remove();
			}
			return; 
		}
		
		if(!roomFilter(r)) {
			// æˆ¿é—´è¢«è¿‡æ»¤ï¼Œç§»é™¤DOMå…ƒç´ 
			if(el) {
				el.remove();
			}
			return; 
		}
		
		// é˜²é‡å¤æ¸²æŸ“ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“
		const currentHTML = el ? el.outerHTML : '';
		const newHTML = roomCardHTML(r);
		
		if (currentHTML === newHTML) {
			logInfo(`è·³è¿‡é‡å¤æ¸²æŸ“: ${name} (å†…å®¹æœªå˜åŒ–)`);
			return;
		}
		
		logInfo(`é‡æ–°æ¸²æŸ“æˆ¿é—´å¡ç‰‡: ${name}, occupant: ${r.occupant || 'null'}, version: ${r.version || 'unknown'}`);
		
		if(el){ 
			el.outerHTML=newHTML; 
		} else { 
			renderRooms(); 
		} 
		
		// å¼ºåˆ¶é‡æ–°åº”ç”¨çŠ¶æ€ + å¹‚ç­‰æ ¡éªŒ
		setTimeout(() => {
			const newEl = grid.querySelector(`[data-room='${CSS.escape(name)}']`);
			if (newEl && r) {
				const st = statusInfo(r);
				newEl.dataset.status = st.state;
				const chip = newEl.querySelector('.chip');
				if (chip) {
					chip.textContent = st.chip;
					chip.className = `chip ${st.class}`;
				}
				// å¹‚ç­‰æ ¡éªŒï¼šoccupant ä¸ºç©ºæ—¶æ¸…ç†æ®‹ç•™
				if(!r.occupant){
					const occLine = newEl.querySelector('.occupant-line');
					if(occLine) occLine.remove();
					const actions = newEl.querySelector('.actions');
					if(actions){
						const strayClear = actions.querySelector('[data-act="clear"]');
						if(strayClear){
							actions.innerHTML = '';
							logInfo(`[RECONCILE] æ¸…ç†æ®‹ç•™æ“ä½œæŒ‰é’® ${name}`);
						}
					}
					newEl.classList.remove('pending-operation');
				}
			}
		}, 10);
	}

	// === å®Œæ•´é‡æ¸²æŸ“è¾…åŠ©å‡½æ•° ===
	function fullReRenderRoom(room){
		const grid=document.getElementById('roomGrid');
		if(!grid) return;
		const old = grid.querySelector(`[data-room='${CSS.escape(room.name)}']`);
		if(old) old.remove();
		// è°ƒç”¨æ ‡å‡†æ¸²æŸ“
		renderRoomCard(room.name);
	}
	function statusInfo(r){ if(!r.occupant) return {state:'empty',chip:'ç©ºé—²',class:'good'}; if(!r.registerTime) return {state:'occupied',chip:'å ç”¨',class:'accent'}; const now=Date.now(); const prepEnd=r.registerTime+60000; if(now<prepEnd) return {state:'preparing',chip:'å‡†å¤‡ä¸­',class:'preparing'}; const used=Math.floor((now-prepEnd)/1000); const limit = (Store.settings.basePracticeDuration||120)*60; if(used<=limit) return {state:'occupied',chip:formatHMS(used),class:'accent'}; return {state:'overtime',chip:'è¶…æ—¶ '+formatDuration(used-limit),class:'danger'}; }
	function roomCardHTML(r){ 
		const st=statusInfo(r); 
		const isGrand=/ä¸‰è§’/.test(r.pianoType);
		const isUpright=/ç«‹å¼/.test(r.pianoType);
		const typeStr = isGrand ? 'grand' : (isUpright ? 'upright' : 'other');
		const editModeClass = Store.editMode ? 'edit-mode' : '';
		const deleteBtn = Store.editMode ? `<div class="delete-btn" data-room="${r.name}" title="åˆ é™¤ç´æˆ¿">âœ•</div>` : '';
		
		// ç¡®å®šç´æˆ¿ç±»å‹æ ‡ç­¾
		let typePill = '';
		if (!Store.editMode) {
			if (isGrand) {
				typePill = '<span class="pill pill-grand">ä¸‰è§’</span>';
			} else if (isUpright) {
				typePill = '<span class="pill pill-upright">ç«‹å¼</span>';
			} else {
				typePill = '<span class="pill pill-other">å…¶ä»–</span>';
			}
		}
		
		// å¤„ç†å¯ç¼–è¾‘åŒºåŸŸçš„æ˜¾ç¤ºå†…å®¹
		const roomNameContent = Store.editMode ? r.name : `${r.name} ${typePill}`;
		const remarkContent = Store.editMode ? 
			(r.remark ? escapeHtml(r.remark) : 'ç‚¹å‡»æ·»åŠ å¤‡æ³¨...') : 
			(r.remark ? escapeHtml(r.remark) : '');
		
		// ç¼–è¾‘æ¨¡å¼ä¸‹çš„ç´æˆ¿ç±»å‹é€‰æ‹©å™¨
		let pianoTypeSelector = '';
		if (Store.editMode) {
			// æ˜ å°„é’¢ç´ç±»å‹åˆ°é€‰æ‹©å™¨é€‰é¡¹
			const currentType = r.pianoType || 'å…¶ä»–';
			let selectedType = 'å…¶ä»–'; // é»˜è®¤é€‰æ‹©
			if (/ä¸‰è§’/.test(currentType)) {
				selectedType = 'ä¸‰è§’';
			} else if (/ç«‹å¼/.test(currentType)) {
				selectedType = 'ç«‹å¼';
			}
			
			pianoTypeSelector = `<select class="piano-type-selector" data-room="${r.name}">
				<option value="ç«‹å¼" ${selectedType === 'ç«‹å¼' ? 'selected' : ''}>ç«‹å¼</option>
				<option value="ä¸‰è§’" ${selectedType === 'ä¸‰è§’' ? 'selected' : ''}>ä¸‰è§’</option>
				<option value="å…¶ä»–" ${selectedType === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
			</select>`;
		}
		
		return `<div class="room-card ${!r.occupant?'empty':''} ${editModeClass}" data-room="${r.name}" data-grand="${isGrand?1:0}" data-type="${typeStr}" data-status="${st.state}" tabindex="0" title="${r.name}\n${r.location||''}\n${r.pianoType}">
			${deleteBtn}
			${Store.editMode ? `<div class="edit-row">
				<div class="room-name compact" contenteditable="true" data-field="name">${roomNameContent}</div>
				${pianoTypeSelector}
			</div>` : `<div class="room-name" ${Store.editMode ? 'contenteditable="true" data-field="name"' : ''}>${roomNameContent}</div>`}
			<div class="remark" ${Store.editMode ? 'contenteditable="true" data-field="remark"' : ''}>${remarkContent}</div>
			${r.occupant && !Store.editMode ?`<div class="occupant-line"><span class="dot"></span><span>${escapeHtml(r.occupant)}</span></div>`:''}
			${!Store.editMode ? `<div class="status-row">
				${r.occupant ? `<span class="chip ${st.class}">${st.chip}</span>` : `<span class="chip chip-dim" data-empty="1">ç©ºé—²</span>`}
				<div class="actions">${r.occupant?`<button class="danger" data-act="clear" title="æ¸…ç©º">âœ•</button><button class="renew-btn" data-act="renew" title="ç»­æœŸ">âŸ³</button>`:``}</div>
			</div>` : ''}
		</div>`; 
	}

	/*************************************************
	 * äº¤äº’é€»è¾‘
	 *************************************************/
	function bindRoomEvents(){
		// é˜²æŠ–æœºåˆ¶çš„ç»­æœŸå¤„ç†
		let lastRenewClick = {};
		
		document.getElementById('roomGrid').addEventListener('click', e=>{
			const card=e.target.closest('.room-card'); if(!card) return; const name=card.dataset.room; const room=Store.byName.get(name); if(!room) return;
			
			// ç¼–è¾‘æ¨¡å¼ä¸‹ç¦ç”¨ç´æˆ¿ç‚¹å‡»åŠŸèƒ½ï¼Œé™¤äº†ç‰¹å®šæŒ‰é’®
			if (Store.editMode) {
				// åˆ é™¤æŒ‰é’®å¤„ç†
				if(e.target.closest('.delete-btn')){
					if(confirm(`ç¡®å®šè¦åˆ é™¤ç´æˆ¿ "${name}" å—ï¼Ÿ`)){
						deleteRoom(name);
					}
					return;
				}
				
				// ç´æˆ¿ç±»å‹é€‰æ‹©å™¨å¤„ç†
				if(e.target.closest('.piano-type-selector')){
					// ç±»å‹é€‰æ‹©å™¨ç”±changeäº‹ä»¶å¤„ç†ï¼Œè¿™é‡Œä¸åšé¢å¤–å¤„ç†
					return;
				}
				
				// å…¶ä»–ç‚¹å‡»äº‹ä»¶åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹è¢«å¿½ç•¥
				return;
			}
			
			// éç¼–è¾‘æ¨¡å¼ä¸‹çš„æ­£å¸¸ç‚¹å‡»é€»è¾‘
			if(e.target.closest('button[data-act=clear]')){ clearRoom(name); return; }
			if(e.target.closest('button[data-act=renew]')){ 
				const now = Date.now();
				// é˜²æŠ–ï¼šåŒä¸€æˆ¿é—´500mså†…åªèƒ½è§¦å‘ä¸€æ¬¡ç»­æœŸ
				if (lastRenewClick[name] && (now - lastRenewClick[name]) < 500) {
					logInfo(`æˆ¿é—´ ${name} ç»­æœŸæ“ä½œè¢«é˜²æŠ–é™åˆ¶`);
					return;
				}
				lastRenewClick[name] = now;
				
				// æ£€æŸ¥æ“ä½œé”
				const lockKey = `renew_${name}`;
				if (Store.operationLocks?.has(lockKey)) {
					toast(`æˆ¿é—´ ${name} æ­£åœ¨å¤„ç†ä¸­...`, 'warn');
					return;
				}
				
				renewRoom(name); 
				return; 
			}
			if(!room.occupant) openStudentModal(name);
		});
		// é˜²æŠ–æœºåˆ¶çš„åŒå‡»æ¸…ç©ºå¤„ç†
		let lastClearClick = {};
		document.getElementById('roomGrid').addEventListener('dblclick', e=>{
			// ç¼–è¾‘æ¨¡å¼ä¸‹ç¦ç”¨åŒå‡»æ¸…ç©º
			if (Store.editMode) return;
			
			const card=e.target.closest('.room-card'); 
			if(!card) return; 
			
			const roomName = card.dataset.room;
			const now = Date.now();
			
			// é˜²æŠ–ï¼šåŒä¸€æˆ¿é—´500mså†…åªèƒ½è§¦å‘ä¸€æ¬¡æ¸…ç©º
			if (lastClearClick[roomName] && (now - lastClearClick[roomName]) < 500) {
				logInfo(`æˆ¿é—´ ${roomName} æ¸…ç©ºæ“ä½œè¢«é˜²æŠ–é™åˆ¶`);
				return;
			}
			lastClearClick[roomName] = now;
			
			const r=Store.byName.get(roomName); 
			if(r && r.occupant) {
				// æ£€æŸ¥æ˜¯å¦æœ‰æ“ä½œé”
				const lockKey = `clear_${roomName}`;
				if (Store.operationLocks?.has(lockKey)) {
					toast(`æˆ¿é—´ ${roomName} æ­£åœ¨å¤„ç†ä¸­...`, 'warn');
					return;
				}
				
				clearRoom(r.name);
			} else if (r && !r.occupant) {
				toast(`æˆ¿é—´ ${roomName} å·²ä¸ºç©º`, 'info');
			}
		});
	}
	async function renewRoom(roomName){ 
		// æ£€æŸ¥æ“ä½œé”ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
		const lockKey = `renew_${roomName}`;
		if (Store.operationLocks?.has(lockKey)) {
			logWarn(`æˆ¿é—´ ${roomName} æ­£åœ¨ç»­æœŸä¸­ï¼Œè¯·ç¨å€™`);
			toast(`æˆ¿é—´ ${roomName} æ­£åœ¨ç»­æœŸä¸­...`, 'warn');
			return { ok: false, error: 'æ“ä½œè¿›è¡Œä¸­' };
		}
		
		const r=Store.byName.get(roomName); 
		if(!r||!r.occupant){ 
			toast('æˆ¿é—´ä¸ºç©º'); 
			return {ok:false, error:'æˆ¿é—´ä¸ºç©º'}; 
		}
		
		// è®¾ç½®æ“ä½œé”
		if (!Store.operationLocks) Store.operationLocks = new Set();
		Store.operationLocks.add(lockKey);
		
		try {
			// ä¹è§‚æ›´æ–°ï¼ˆç«‹å³æ˜¾ç¤ºæ•ˆæœï¼‰
			const originalTime = r.registerTime;
			r.registerTime = Date.now(); 
			
			// æ·»åŠ è§†è§‰æŒ‡ç¤º
			const card = document.querySelector(`[data-room="${roomName}"]`);
			if (card) {
				card.classList.add('pending-operation');
				card.dataset.status = 'syncing';
			}
			
			renderRoomCard(roomName); 
			toast(`âœ… å·²ç»­æœŸ ${roomName}`, 'success');
			
			// åç«¯åŒæ­¥
			if(!supabaseReady){ 
				logWarn('ç¦»çº¿æ¨¡å¼ - ä»…æœ¬åœ°ç»­æœŸ');
				return {ok:true, offline:true}; 
			}
			
			const nowIso = new Date().toISOString();
			const nextVersion = (r.version || 0) + 1;
			
			// æ ‡è®°ä¸ºå¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.set(roomName, { 
				student: r.occupant, 
				version: nextVersion, 
				timestamp: Date.now(),
				action: 'renew'
			});
			
			const { data, error } = await supabaseClient.from('rooms').upsert({
				name: roomName,
				occupant_student_name: r.occupant,
				register_time: nowIso,  // æ›´æ–°ä¸ºæ–°çš„æ³¨å†Œæ—¶é—´
				heartbeat_at: nowIso,
				version: nextVersion,
				updated_at: nowIso
			}, {
				onConflict: 'name'
			});
			
			if(error){ 
				logErr('ç»­æœŸå¤±è´¥', error.message);
				// å›æ»šä¹è§‚æ›´æ–°
				r.registerTime = originalTime;
				renderRoomCard(roomName);
				toast(`âŒ ç»­æœŸå¤±è´¥ ${roomName}`, 'error');
				return {ok:false,error}; 
			}
			
			// å†™å…¥ç»ƒä¹ è®°å½•
			await writePracticeLog(roomName, r.occupant, 'renew');
			
			logInfo(`æˆåŠŸç»­æœŸ ${roomName} (v${nextVersion})`);
			return {ok:true, data};
			
		} finally {
			// æ¸…é™¤æ“ä½œé”
			Store.operationLocks.delete(lockKey);
			// æ¸…é™¤å¾…å¤„ç†çŠ¶æ€
			Store.pendingAssign.delete(roomName);
			// æ¸…é™¤è§†è§‰æŒ‡ç¤º
			clearOperationIndicator(roomName);
		}
	}
	function openStudentModal(roomName){
		const modal=document.getElementById('studentModalBackdrop'); 
		modal.style.display='flex'; 
		modal.dataset.room=roomName; 
		const input=document.getElementById('studentSearch');
		input.value='';
		// åˆå§‹åŒ–é”®ç›˜é€‰æ‹©çŠ¶æ€
		studentListKB.index=0; studentListKB.active=true; 
		renderStudentList();
		// èšç„¦è¾“å…¥æ¡†æ–¹ä¾¿ç›´æ¥æ‰“å­—
		setTimeout(()=>input.focus(), 0);
	}
	function closeStudentModal(){ document.getElementById('studentModalBackdrop').style.display='none'; }
	function renderStudentList(){
		const box=document.getElementById('studentList'); 
		const q=document.getElementById('studentSearch').value.trim().toLowerCase(); 
		const roomName=document.getElementById('studentModalBackdrop').dataset.room; 
		const isGrand=/ä¸‰è§’/.test((Store.byName.get(roomName)||{}).pianoType||'');
		
		let arr=Store.students.slice(); 
		if(q) arr=arr.filter(s=> matchPinyin(s.name, q) || (s.major||'').toLowerCase().includes(q));
		
		// å¯¹äºä¸‰è§’é’¢ç´ï¼Œå®Œå…¨è¿‡æ»¤æ‰éé’¢ç´æ•™ç ”å®¤çš„å­¦ç”Ÿ
		if(isGrand) {
			arr = arr.filter(s => s.major === 'é’¢ç´æ•™ç ”å®¤');
		}
		
		arr.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN'));
		
		// å»ºç«‹å ç”¨ç´¢å¼•ï¼Œæé«˜æŸ¥æ‰¾é€Ÿåº¦
		const occupancyMap = new Map();
		for(const r of Store.rooms){ if(r.occupant){ occupancyMap.set(r.occupant, r); } }

		box.innerHTML = arr.map((s,i)=>{ 
			const occRoom = occupancyMap.get(s.name);
			const isOccupied = !!occRoom && occRoom.name !== roomName; // å·²åœ¨å…¶å®ƒæˆ¿é—´
			let titleText = `${s.major||''} ${s.grade||''}`.trim();
			if(isOccupied){ titleText += ` (å ç”¨ ${occRoom.name})`; }

			// è®¡ç®—å ç”¨çŠ¶æ€æ ‡ç­¾ï¼ˆå‡†å¤‡ä¸­/è®¡æ—¶/è¶…æ—¶ï¼‰
			let stateTag = '';
			if(isOccupied){
				const st = statusInfo(occRoom);
				let label = '';
				switch(st.state){
					case 'preparing': label='å‡†å¤‡ä¸­'; break;
					case 'occupied': label='å ç”¨ä¸­'; break;
					case 'overtime': label='è¶…æ—¶'; break;
					default: label='å ç”¨';
				}
				// åŠ¨æ€æ—¶é•¿ï¼ˆå ç”¨è®¡æ—¶ï¼‰
				if(st.state==='occupied' && /:\d{2}$/.test(st.chip)){
					label += ` ${st.chip}`; // å·²æœ‰ mm:ss æˆ– hh:mm:ss
				}
				stateTag = `<span class="state-tag st-${st.state}">${label}</span>`;
			}

			const kbCls = (i===studentListKB.index)?' kb-selected':'';
			return `<div class="student-item${kbCls}" data-name="${s.name}" title="${titleText}">
				<div class="col-left">
					<span class="stu-name">${escapeHtml(s.name)}</span>
					<span class="tag major">${s.major||''}</span>
					${s.grade?`<span class=\"tag grade\">${s.grade}</span>`:''}
				</div>
				<div class="col-right">
					${isOccupied?`<span class=\"room-tag\" title=\"å½“å‰å ç”¨æˆ¿é—´\">${occRoom.name}</span>`:''}
					${stateTag}
				</div>
			</div>`; 
		}).join('');
		// è¶Šç•Œä¿æŠ¤ & é‡æ–°é«˜äº®
		const items = box.querySelectorAll('.student-item');
		if(items.length===0){ studentListKB.index=-1; return; }
		if(studentListKB.index>=items.length) studentListKB.index=items.length-1; 
		if(studentListKB.index<0) studentListKB.index=0;
		items.forEach((el,i)=> el.classList.toggle('kb-selected', i===studentListKB.index));
		// ç¡®ä¿é€‰ä¸­é¡¹å¯è§
		const active=items[studentListKB.index];
		if(active){ const rect=active.getBoundingClientRect(); const parent=box.getBoundingClientRect(); if(rect.top<parent.top||rect.bottom>parent.bottom){ active.scrollIntoView({block:'nearest'}); } }
	}
	function bindStudentModal(){
		// é”®ç›˜å¯¼èˆªçŠ¶æ€
		if(!window.studentListKB){
			window.studentListKB={ index:0, active:false };
		}
		function moveSelection(delta){
			const box=document.getElementById('studentList');
			const items=box.querySelectorAll('.student-item');
			if(items.length===0) return; 
			studentListKB.index=Math.min(items.length-1, Math.max(0, studentListKB.index+delta));
			items.forEach((el,i)=> el.classList.toggle('kb-selected', i===studentListKB.index));
			const active=items[studentListKB.index];
			if(active){ const rect=active.getBoundingClientRect(); const parent=box.getBoundingClientRect(); if(rect.top<parent.top||rect.bottom>parent.bottom){ active.scrollIntoView({block:'nearest'}); } }
		}
		function triggerSelect(){
			const box=document.getElementById('studentList');
			const items=box.querySelectorAll('.student-item');
			if(items.length===0) return;
			const target=items[studentListKB.index];
			if(target){ target.click(); }
		}
		// ç›‘å¬é”®ç›˜
		document.addEventListener('keydown', function studentModalKeyHandler(e){
			const modal=document.getElementById('studentModalBackdrop');
			if(modal.style.display!=='flex') return; // åªåœ¨æ¨¡æ€æ‰“å¼€æ—¶
			// å½“ç„¦ç‚¹åœ¨è¾“å…¥æ¡†æˆ– body å‡å¯å“åº”ï¼Œä¸Šä¸‹é”® & å›è½¦
			if(['ArrowDown','ArrowUp','Enter','Escape'].includes(e.key)){
				// é¿å…é¡µé¢æ•´ä½“æ»šåŠ¨
				e.preventDefault();
				studentListKB.active=true;
				if(e.key==='ArrowDown') moveSelection(1); else if(e.key==='ArrowUp') moveSelection(-1); else if(e.key==='Enter') triggerSelect(); else if(e.key==='Escape') closeStudentModal();
			}
		}, {passive:false});
		document.getElementById('studentSearch').addEventListener('input', renderStudentList);
		// é˜²æŠ–æœºåˆ¶çš„å­¦ç”Ÿé€‰æ‹©å¤„ç†
		let lastAssignClick = {};
		document.getElementById('studentList').addEventListener('click', e=>{ 
			const item=e.target.closest('.student-item'); 
			if(!item) return; 
			
			const name=item.dataset.name; 
			const room=document.getElementById('studentModalBackdrop').dataset.room;
			const now = Date.now();
			const clickKey = `${room}_${name}`;
			
			// é˜²æŠ–ï¼šåŒä¸€æˆ¿é—´å’Œå­¦ç”Ÿç»„åˆ500mså†…åªèƒ½è§¦å‘ä¸€æ¬¡åˆ†é…
			if (lastAssignClick[clickKey] && (now - lastAssignClick[clickKey]) < 500) {
				logInfo(`æˆ¿é—´ ${room} åˆ†é…ç»™ ${name} çš„æ“ä½œè¢«é˜²æŠ–é™åˆ¶`);
				return;
			}
			lastAssignClick[clickKey] = now;
			
			// æ£€æŸ¥æ“ä½œé”
			const lockKey = `assign_${room}`;
			if (Store.operationLocks?.has(lockKey)) {
				toast(`æˆ¿é—´ ${room} æ­£åœ¨å¤„ç†ä¸­...`, 'warn');
				return;
			}
			
			// æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å·²ç»å ç”¨å…¶ä»–ç´æˆ¿ï¼Œå¦‚æœæ˜¯åˆ™å…ˆæ¸…ç©ºåŸç´æˆ¿
			const occupiedRoom = Store.rooms.find(r => r.occupant === name);
			if (occupiedRoom && occupiedRoom.name !== room) {
				logInfo(`å­¦ç”Ÿ ${name} ä» ${occupiedRoom.name} è½¬ç§»åˆ° ${room}`);
				toast(`æ­£åœ¨å°† ${name} ä» ${occupiedRoom.name} è½¬ç§»åˆ° ${room}...`, 'info');
				// å…ˆæ¸…ç©ºåŸç´æˆ¿
				clearRoom(occupiedRoom.name).then(() => {
					// ç„¶ååˆ†é…åˆ°æ–°ç´æˆ¿
					assignRoom(room, name);
				});
			} else {
				// ç›´æ¥åˆ†é…
				assignRoom(room, name);
			}
			
			closeStudentModal(); 
		});
		document.getElementById('btnStudentModalCancel').onclick=closeStudentModal; document.getElementById('btnCloseStudentModal').onclick=closeStudentModal; }

	/*************************************************
	 * æ–°å¢æˆ¿é—´æ¨¡æ€æ¡†
	 *************************************************/
	function showAddRoomModal(){
		const modal = document.getElementById('addRoomModalBackdrop');
		modal.style.display = 'flex';
		
		// æ¸…ç©ºè¡¨å•
		document.getElementById('addRoomName').value = '';
		document.getElementById('addRoomLocation').value = '';
		document.getElementById('addRoomPianoType').value = 'ç«‹å¼';
		document.getElementById('addRoomRemark').value = '';
		
		// é‡ç½®é’¢ç´ç±»å‹é€‰æ‹©å™¨
		document.querySelectorAll('.piano-type-option').forEach(option => {
			option.classList.remove('selected');
		});
		document.querySelector('.piano-type-option[data-type="ç«‹å¼"]').classList.add('selected');
		
		// èšç„¦æˆ¿é—´åç§°è¾“å…¥æ¡†
		setTimeout(() => document.getElementById('addRoomName').focus(), 0);
		
		// ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
		modal.addEventListener('click', function handleBackdropClick(e) {
			if (e.target === modal) {
				closeAddRoomModal();
				modal.removeEventListener('click', handleBackdropClick);
			}
		});
	}
	
	function closeAddRoomModal(){
		document.getElementById('addRoomModalBackdrop').style.display = 'none';
	}
	
	function bindAddRoomModal(){
		document.getElementById('btnCloseAddRoomModal').onclick = closeAddRoomModal;
		document.getElementById('btnAddRoomCancel').onclick = closeAddRoomModal;
		document.getElementById('btnAddRoomConfirm').onclick = createNewRoom;
		
		// é’¢ç´ç±»å‹é€‰æ‹©å™¨äº‹ä»¶
		document.querySelectorAll('.piano-type-option').forEach(option => {
			option.addEventListener('click', function() {
				// ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
				document.querySelectorAll('.piano-type-option').forEach(opt => opt.classList.remove('selected'));
				// æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
				this.classList.add('selected');
				// åŒæ­¥åˆ°éšè—çš„selectå…ƒç´ 
				document.getElementById('addRoomPianoType').value = this.dataset.type;
			});
		});
		
		// å›è½¦é”®æäº¤
		document.getElementById('addRoomName').addEventListener('keydown', e => {
			if (e.key === 'Enter') {
				e.preventDefault();
				createNewRoom();
			}
		});
		
		// ESCé”®å…³é—­
		document.addEventListener('keydown', function addRoomModalKeyHandler(e) {
			const modal = document.getElementById('addRoomModalBackdrop');
			if (modal.style.display === 'flex' && e.key === 'Escape') {
				closeAddRoomModal();
			}
		});
	}
	
	async function createNewRoom(){
		// æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
		document.querySelectorAll('.form-field').forEach(field => {
			field.classList.remove('error');
			const errorMsg = field.querySelector('.error-message');
			if (errorMsg) errorMsg.remove();
		});
		
		const name = document.getElementById('addRoomName').value.trim();
		const location = document.getElementById('addRoomLocation').value.trim();
		const pianoType = document.getElementById('addRoomPianoType').value;
		const remark = document.getElementById('addRoomRemark').value.trim();
		
		let hasError = false;
		
		// éªŒè¯æˆ¿é—´åç§°
		if (!name) {
			const nameField = document.getElementById('addRoomName').closest('.form-field');
			nameField.classList.add('error');
			const errorDiv = document.createElement('div');
			errorDiv.className = 'error-message';
			errorDiv.textContent = 'æˆ¿é—´åç§°ä¸èƒ½ä¸ºç©º';
			nameField.appendChild(errorDiv);
			hasError = true;
		}
		
		// æ£€æŸ¥æˆ¿é—´åç§°æ˜¯å¦å·²å­˜åœ¨
		if (name && Store.byName.has(name)) {
			const nameField = document.getElementById('addRoomName').closest('.form-field');
			nameField.classList.add('error');
			const errorDiv = document.createElement('div');
			errorDiv.className = 'error-message';
			errorDiv.textContent = 'æˆ¿é—´åç§°å·²å­˜åœ¨';
			nameField.appendChild(errorDiv);
			hasError = true;
		}
		
		if (hasError) {
			document.getElementById('addRoomName').focus();
			return;
		}
		
		try {
			// æ˜ å°„é€‰æ‹©å™¨å€¼åˆ°æ•°æ®åº“æ ¼å¼
			let mappedPianoType = '';
			switch(pianoType) {
				case 'ä¸‰è§’':
					mappedPianoType = 'ä¸‰è§’é’¢ç´';
					break;
				case 'ç«‹å¼':
					mappedPianoType = 'ç«‹å¼é’¢ç´';
					break;
				case 'å…¶ä»–':
				default:
					mappedPianoType = 'å…¶ä»–';
					break;
			}
			
			const newRoom = {
				name: name,
				location: location || '',
				pianoType: mappedPianoType,
				remark: remark || '',
				occupant: null,
				registerTime: null,
				version: 1,
				heartbeatAt: null
			};
			
			// æ·»åŠ åˆ°æœ¬åœ°æ•°æ®
			Store.rooms.push(newRoom);
			Store.byName.set(name, newRoom);
			
			// æ›´æ–°æ¥¼å±‚é›†åˆ
			const floor = deriveFloor(location);
			if (floor) Store.floorSet.add(floor);
			
			// åŒæ­¥åˆ°äº‘ç«¯ï¼šå†™å…¥é™æ€è¡¨ï¼Œå¹¶æ’å…¥/æ›´æ–°åŠ¨æ€è¡¨ä»¥è§¦å‘ä»–ç«¯å®æ—¶è®¢é˜…
			if (!Store.settings.offlineMode) {
				await supabaseClient.from('room_database').upsert({
					name: name,
					location: location || null,
					piano_type: mappedPianoType,
					remark: remark || null
				});
				// è§¦å‘ rooms å®æ—¶é€šé“ï¼Œè®©ä»–ç«¯æ— éœ€åˆ·æ–°å³å¯çœ‹åˆ°æ–°æˆ¿é—´
				await supabaseClient.from('rooms').upsert({
					name: name,
					occupant_student_name: null,
					register_time: null,
					heartbeat_at: new Date().toISOString(),
					version: 1,
					updated_at: new Date().toISOString()
				});
			}
			
			// é‡æ–°æ¸²æŸ“
			renderRooms();
			ensureFilters();
			
			toast(`âœ… å·²æ·»åŠ ç´æˆ¿ï¼š${name}`);
			logInfo(`æ–°å¢ç´æˆ¿ï¼š${name}, ä½ç½®ï¼š${location}, ç±»å‹ï¼š${pianoType}`);
			
			closeAddRoomModal();
		} catch (error) {
			toast('æ·»åŠ å¤±è´¥', 'error');
			logErr('æ–°å¢ç´æˆ¿å¤±è´¥:', error.message);
		}
	}

	/*************************************************
	 * æœç´¢
	 *************************************************/
	function initSearch(){ document.getElementById('globalSearch').addEventListener('input', ()=>{ runGlobalSearch(); }); }
	function runGlobalSearch(){ 
		const q=document.getElementById('globalSearch').value.trim().toLowerCase(); 
		const box=document.getElementById('inlineSearchResults'); 
		if(!q){ box.style.display='none'; box.innerHTML=''; return; }
		const students=Store.students.filter(s=> matchPinyin(s.name, q) || (s.major||'').toLowerCase().includes(q));
		const rooms=Store.rooms.filter(r=> r.name.toLowerCase().includes(q) || (r.location||'').toLowerCase().includes(q) || (r.pianoType||'').toLowerCase().includes(q));
		const highlight=(txt)=>{ if(!q) return escapeHtml(txt); const low=txt.toLowerCase(); const idx=low.indexOf(q); if(idx===-1) return escapeHtml(txt); return escapeHtml(txt.slice(0,idx))+`<span class="highlight">${escapeHtml(txt.slice(idx,idx+q.length))}</span>`+escapeHtml(txt.slice(idx+q.length)); };
		let html='';
		if(students.length){ 
			html+=`<div><div class="group-title">å­¦ç”Ÿ (${students.length})</div>`+students.slice(0,30).map(s=>{
				const room = Store.rooms.find(r=>r.occupant===s.name);
				let occupyMeta='';
				if(room){
					const st=statusInfo(room);
					const icon = st.state==='preparing' ? 'â³' : (st.state==='overtime' ? 'âš ï¸' : 'ğŸ¹');
					occupyMeta = `<span class="occ-info ${st.state}"><span class="icon">${icon}</span><span>${room.name}</span></span>`;
				}
				return `<div class="result-item student" data-type="student" data-name="${s.name}"><span>${highlight(s.name)}</span><span class="meta">${s.major||''} ${s.grade||''} ${occupyMeta}</span></div>`; 
			}).join('')+`</div>`; 
		}
		if(rooms.length){ html+=`<div><div class="group-title">ç´æˆ¿ (${rooms.length})</div>`+rooms.slice(0,30).map(r=>{ const st=statusInfo(r); return `<div class="result-item room" data-type="room" data-room="${r.name}"><span>${highlight(r.name)}</span><span class="meta">${r.location||''} ${r.pianoType||''} ${st.chip}</span></div>`; }).join('')+`</div>`; }
		if(!html) html='<div class="empty">æ— åŒ¹é…ç»“æœ</div>';
		box.innerHTML=html; box.style.display='block';
		box.querySelectorAll('.result-item').forEach(el=>{
			el.onclick=()=>{ const type=el.dataset.type; if(type==='room'){ scrollToRoom(el.dataset.room); } else if(type==='student'){ focusStudent(el.dataset.name); } hideInlineSearch(); };
		});
	}
	function hideInlineSearch(){ const box=document.getElementById('inlineSearchResults'); if(box){ box.style.display='none'; } }
	// ç‚¹å‡»é¡µé¢ç©ºç™½æˆ–æŒ‰ ESC å…³é—­å†…è”æœç´¢
	document.addEventListener('click', e=>{
		const box=document.getElementById('inlineSearchResults'); const input=document.getElementById('globalSearch');
		if(!box||box.style.display==='none') return; 
		if(!box.contains(e.target) && e.target!==input){ hideInlineSearch(); }
	});
	document.addEventListener('keydown', e=>{ if(e.key==='Escape') hideInlineSearch(); });

	/*************************************************
	 * ç»Ÿè®¡ä¸å¿ƒè·³åˆ·æ–°
	 *************************************************/
	/*************************************************
	 * UI çŠ¶æ€æ›´æ–°
	 *************************************************/
	function updateSyncStatus(state, text) {
		const dot = document.getElementById('syncDot');
		const textEl = document.getElementById('syncText');
		const reconnectBtn = document.getElementById('btnReconnect');
		
		if (dot) {
			dot.className = `sync-dot ${state}`;
		}
		if (textEl) {
			textEl.textContent = text;
		}
		
		// æ ¹æ®çŠ¶æ€æ˜¾ç¤º/éšè—é‡è¿æŒ‰é’®
		if (reconnectBtn) {
			reconnectBtn.style.display = (state === 'error' || state === 'offline') ? 'inline-block' : 'none';
		}
	}
	
	function updateCloudSyncInfo() {
		const localRoomCountEl = document.getElementById('localRoomCount');
		const localStudentCountEl = document.getElementById('localStudentCount');
		const lastSyncTimeEl = document.getElementById('lastSyncTime');
		
		if (localRoomCountEl) {
			localRoomCountEl.textContent = Store.rooms.length;
		}
		if (localStudentCountEl) {
			localStudentCountEl.textContent = Store.students.length;
		}
		if (lastSyncTimeEl && supabaseReady) {
			lastSyncTimeEl.textContent = new Date().toLocaleTimeString();
		}
	}
	
	function updateUsageStats(){ 
		const total=Store.rooms.length; 
		const occ=Store.rooms.filter(r=>r.occupant).length; 
		const rate= total? ((occ/total)*100).toFixed(1):'0.0'; 
		const statEl = document.getElementById('statUsage');
		if (statEl) {
			statEl.textContent=`ä½¿ç”¨ç‡ ${rate}%`;
		}
		const metaEl = document.getElementById('metaCounts');
		if (metaEl) {
			metaEl.textContent = `å…± ${total} é—´ â€¢ å ç”¨ ${occ}`;
		}
		
		// åŒæ—¶æ›´æ–°äº‘ç«¯åŒæ­¥ä¿¡æ¯
		updateCloudSyncInfo();
	}
	function startStatusTicker(){ if(Store.timer) clearInterval(Store.timer); Store.timer = setInterval(()=>{ const els=document.querySelectorAll('.room-card'); els.forEach(el=>{ const name=el.dataset.room; const r=Store.byName.get(name); if(!r) return; const st=statusInfo(r); const chip=el.querySelector('.chip'); if(chip) { chip.textContent=st.chip; chip.className=`chip ${st.class}`; } el.dataset.status=st.state; }); }, 1000); }

	/*************************************************
	 * ç»ƒä¹ è®°å½• (æœ¬åœ° / æœåŠ¡å™¨)
	 *************************************************/
	async function writePracticeLog(roomName, studentName, action) {
		// å…ˆç¼“å­˜åˆ°æœ¬åœ°
		const logEntry = createPracticeLogEntry(roomName, studentName, action);
		Store.localPracticeLogs.push(logEntry);
		
		if (!supabaseReady) {
			logInfo(`æœ¬åœ°è®°å½•: ${action} ${studentName} @ ${roomName}`);
			return;
		}
		
		try {
			let attempt = 0;
			let removed = [];
			let lastError = null;
			// åˆ›å»ºæ•°æ®åº“æ•°æ®å‰¯æœ¬ï¼Œç§»é™¤æœ¬åœ°å­—æ®µ
			let currentData = { ...logEntry };
			delete currentData.synced; // ç§»é™¤æœ¬åœ°æ ‡è®°å­—æ®µ
			let summarized = false; // æ˜¯å¦å·²è¾“å‡ºç¼ºåˆ—æ±‡æ€»

			while (attempt < 5) { // æœ€å¤š 5 æ¬¡é€åˆ—å‰”é™¤é‡è¯•
				const { error } = await supabaseClient
					.from('practice_logs')
					.insert(currentData);

				if (!error) {
					// æ ‡è®°ä¸ºå·²åŒæ­¥
					logEntry.synced = true;
					const removedInfo = removed.length ? ` (å·²å‰”é™¤åˆ—: ${removed.join(',')})` : '';
					logInfo(`âœ… ç»ƒä¹ è®°å½•å·²å†™å…¥: ${action} ${studentName} @ ${roomName}${removedInfo}`);
					return;
				}

				lastError = error;
				// ä»…å¤„ç†ç¼ºåˆ—é”™è¯¯ (Postgres 42703 æˆ– message åŒ…å« Could not find the 'xxx' column)
				const msg = (error.message||'').toLowerCase();
				if (error.code === '42703' || msg.includes("could not find the '") ) {
					// è§£æç¼ºå¤±åˆ—å
					let missing = '';
					const m = error.message.match(/'([^']+)' column/);
					if (m) missing = m[1];
					if (missing && currentData.hasOwnProperty(missing)) {
						delete currentData[missing];
						removed.push(missing);
						// å½“ç¼ºå¤±è¿‡å¤šå…³é”®åˆ—æ—¶ï¼Œç›´æ¥é™çº§ä¸ºæœ€å°å­—æ®µé›†åˆï¼šaction, student_name, timestamp
						if (!summarized && removed.length >= 2) {
							// è‹¥åŸºç¡€ room_name éƒ½ç¼ºäº†ï¼Œè¯´æ˜è¡¨ç»“æ„ä¸ä½ çš„é¢„æœŸå·®å¼‚å¾ˆå¤§ï¼Œè¾“å‡ºä¸€æ¬¡æ±‡æ€»ç„¶åé™çº§
							if (!currentData.room_name && !removed.includes('room_name')) {
								// do nothing; room_name åŸæœ¬ä¸åœ¨ currentData æ—¶ä¸å¤„ç†
							}
							logWarn(`practice_logs å¤šåˆ—ç¼ºå¤±: ${removed.join(',')}ã€‚å°†é™çº§ä»…å†™å…¥åŸºç¡€: action, student_name, timestamp`);
							// æ„é€ æœ€å°é›†
							currentData = {
								action: action,
								student_name: studentName,
								timestamp: now
							};
							summarized = true;
						}
						else {
							logWarn(`practice_logs ç¼ºå°‘åˆ— ${missing}ï¼Œå·²å‰”é™¤åé‡è¯• (ç¬¬ ${attempt+1} æ¬¡)`);
						}
						attempt++;
						continue;
					}
				}
				// å…¶å®ƒé”™è¯¯æˆ–æ— æ³•è§£æåˆ—åï¼Œç»“æŸå¾ªç¯
				break;
			}

			// å¦‚æœé€€å‡ºå¾ªç¯ä»å¤±è´¥
			if (lastError) {
				logErr('å†™å…¥ç»ƒä¹ è®°å½•å¤±è´¥:', lastError.message + (removed.length?` (å‰”é™¤åˆ—: ${removed.join(',')})`:''));
			}
		} catch (err) {
			logErr('ç»ƒä¹ è®°å½•å¼‚å¸¸:', err.message);
		}
	}

	// åˆ›å»ºç»ƒä¹ è®°å½•æ¡ç›®
	function createPracticeLogEntry(roomName, studentName, action) {
		const room = Store.rooms.find(r => r.name === roomName);
		const student = Store.studentIndex.get(studentName);
		const now = new Date().toISOString();

		let logEntry = {
			room_name: roomName,
			student_name: studentName,
			action: action,
			timestamp: now,
			piano_type: room?.pianoType || '',
			location: room?.location || '',
			student_major: student?.major || '',
			student_grade: student?.grade || '',
			synced: false // æœ¬åœ°æ ‡è®°
		};

		if (action === 'assign') {
			logEntry.session_start = now;
		} else if (action === 'clear' && room?.registerTime) {
			logEntry.session_start = new Date(room.registerTime).toISOString();
			logEntry.session_end = now;
			const durationMs = Date.now() - room.registerTime - 60000; // å‡å»å‡†å¤‡æ—¶é—´
			logEntry.practice_duration = Math.max(0, Math.floor(durationMs / 1000));
		}

		return logEntry;
	}
	
	function writePracticeLogLocal(r){ 
		if(!r||!r.occupant||!r.registerTime) return; 
		const prepEnd=r.registerTime+60000; 
		const now=Date.now(); 
		const used = Math.max(0, now - prepEnd); 
		logInfo(`æœ¬åœ°LOG ${r.occupant} @${r.name} ${formatDuration(Math.floor(used/1000))}`); 
	}

	/*************************************************
	 * å·¥å…· & UI è¾…åŠ©
	 *************************************************/
	function formatHMS(sec){ const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); const s=sec%60; return (h>0?h+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
	function formatDuration(sec){ if(sec<60) return sec+'s'; const m=Math.floor(sec/60); const s=sec%60; if(m<60) return m+'m'+(s? s+'s':''); const h=Math.floor(m/60); const mm=m%60; return h+'h'+(mm?mm+'m':''); }
	function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
	function toast(msg, type){ const box=document.getElementById('toastContainer'); const el=document.createElement('div'); el.className='toast'; el.innerHTML=`<span>${escapeHtml(msg)}</span>`; box.appendChild(el); setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),320); }, 2800); }
	function logInfo(...a){ console.log('[INFO]',...a); appendRuntime('INFO', a.join(' ')); }
	function logWarn(...a){ console.warn('[WARN]',...a); appendRuntime('WARN', a.join(' ')); }
	function logErr(...a){ console.error('[ERR]',...a); appendRuntime('ERR', a.join(' ')); }
	function appendRuntime(level,msg){ const box=document.getElementById('runtimeInfo'); const line=document.createElement('div'); line.style.whiteSpace='pre-wrap'; line.innerHTML=`<span class="muted">${new Date().toLocaleTimeString()}</span> <span class="${level==='ERR'?'danger':level==='WARN'?'warn':'accent'}">${level}</span> <span>${escapeHtml(msg)}</span>`; box.prepend(line); const max=120; while(box.children.length>max) box.removeChild(box.lastChild); }
	function refreshStudentModalCache(){ /* é¢„ç•™ï¼šå¯å»ºç«‹æ‹¼éŸ³ç´¢å¼• */ }

	/*************************************************
	 * åˆå§‹åŒ–æµç¨‹
	 *************************************************/
	async function bootstrap(){
		try{ 
			await initSupabase(); 
		}catch(e){ 
			logWarn('Supabase åˆå§‹åŒ–å¤±è´¥ (ç¦»çº¿æ¨¡å¼)', e.message); 
			updateSyncStatus('error', 'ç¦»çº¿æ¨¡å¼');
		}
		
		const [rooms, roomMeta, students] = await Promise.all([
			fetchRooms(), 
			fetchRoomMeta(), 
			fetchStudents()
		]);
		
		Store.rooms = rooms; 
		Store.roomMeta = roomMeta; 
		Store.students = students; 

		// å…³é”®ä¿®å¤ï¼šç¡®ä¿äº‘ç«¯ room_database çš„é™æ€æˆ¿é—´èƒ½å¹¶å…¥ rooms åˆ—è¡¨
		// ä¹‹å‰ fetchRoomMeta å†…éƒ¨åˆå¹¶ä¼šè¢« Promise.all ç»“æŸåçš„èµ‹å€¼è¦†ç›–ï¼Œ
		// è¿™é‡Œåœ¨å®Œæˆèµ‹å€¼åå†æ¬¡åšä¸€æ¬¡ metaOnly åˆå¹¶ï¼Œä¿è¯â€œæ–°å¢ä½†å°šæ— çŠ¶æ€â€çš„æˆ¿é—´ä¹Ÿèƒ½æ˜¾ç¤º/åŒæ­¥åˆ°ä»–ç«¯ã€‚
		if (Store.roomMeta && Object.keys(Store.roomMeta).length > 0) {
			const metaList = Object.values(Store.roomMeta).map(r => ({
				name: r.name,
				pianoType: r.piano_type || '',
				location: r.location || '',
				remark: r.remark || ''
			}));
			await mergeRooms(metaList, { skipCloudSync: true, metaOnly: true });
		}
		
		rebuildIndexes(); 
		rebuildStudentIndex(); 
		renderRooms(); 
		updateUsageStats(); 
		bindRoomEvents(); 
		bindStudentModal(); 
		bindAddRoomModal();
		initSearch(); 
		startStatusTicker(); 
		
		// åªåœ¨Supabaseå°±ç»ªæ—¶è®¾ç½®å®æ—¶åŒæ­¥
		if (supabaseReady) {
			await setupRealtime();
		}
		
		logInfo('åˆå§‹åŒ–å®Œæˆ: rooms='+rooms.length+' students='+students.length);
		// å…œåº•ï¼šå¦‚æœå·²ç™»å½•ä½†æŒ‰é’®è¢«å…¶å®ƒé€»è¾‘è¦†ç›–éšè—ï¼Œå†æ¬¡æ˜¾ç¤º
		showBulkTimeButton();
	}

	// å…¨å±€æš´éœ²ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
	window.RoomStore=Store; window.assignRoom=assignRoom; window.clearRoom=clearRoom; window.renewRoom=renewRoom;

	// ç›´æ¥è°ƒç”¨ bootstrap æ”¹ä¸ºå—ç™»å½•æ§åˆ¶
	// bootstrap();
	// ç™»å½•é—¨æ§é€»è¾‘ï¼ˆçº¯å‰ç«¯å›ºå®šå¯†ç ï¼‰æ”¹ä¸ºï¼šAPP_PASS_HASH = SHA256(æ˜æ–‡å¯†ç ) æ— ç›
	const PLAIN_PASS = 'ymsq2022';
	let APP_PASS_HASH = '';
	let appBooted = false;
	function sha256Hex(str){
		return crypto.subtle.digest('SHA-256', new TextEncoder().encode(str)).then(buf=>{
			return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
		});
	}
	function showLogin(){ document.getElementById('authOverlay').style.display='flex'; }
	function hideLogin(){ document.getElementById('authOverlay').style.display='none'; }
	function showLogoutBtn(){ const box=document.getElementById('topLogout'); if(box){ box.style.display='block'; const btn=document.getElementById('logoutBtn'); if(btn && !btn.dataset.bound){ btn.dataset.bound='1'; btn.addEventListener('click', logout); } } }
// ä¿®æ”¹: ç™»å½•åæ˜¾ç¤ºè€ƒå‹¤æ—¶é—´æ®µæŒ‰é’®
function showBulkTimeButton(){
	const bulk=document.getElementById('btnBulkTime');
	if(bulk){ bulk.style.display='inline-block'; bulk.disabled=false; }
}
const _origShowLogoutBtn = showLogoutBtn; showLogoutBtn = function(){ _origShowLogoutBtn && _origShowLogoutBtn(); showBulkTimeButton(); };
	async function tryAuto(){
		if(localStorage.getItem('yms_auth')==='1'){
			hideLogin(); showLogoutBtn(); if(!appBooted){ appBooted=true; bootstrap(); }
		}else{
			showLogin();
		}
	}
	async function handleLogin(e){
		e.preventDefault();
		const pwd=document.getElementById('loginPassword').value.trim();
		const btn=document.getElementById('loginBtn');
		const msg=document.getElementById('loginMsg');
		btn.disabled=true; msg.textContent='éªŒè¯ä¸­...';
		try{
			const ok = await verifyPassword(pwd);
			if(ok){
				localStorage.setItem('yms_auth','1');
				hideLogin(); showLogoutBtn(); if(!appBooted){ appBooted=true; bootstrap(); }
				msg.textContent='';
			}else{
				msg.textContent='å¯†ç é”™è¯¯';
			}
		}finally{
			btn.disabled=false;
		}
	}
	function logout(){ localStorage.removeItem('yms_auth'); appBooted=false; const box=document.getElementById('topLogout'); if(box) box.style.display='none'; showLogin(); }
	async function verifyPassword(pwd){
		if(!pwd) return false;
		// è‹¥ hash è¿˜æœªå‡†å¤‡ï¼Œç­‰å¾…
		let waitCount=0; while(!APP_PASS_HASH && waitCount<100){ await new Promise(r=>setTimeout(r,30)); waitCount++; }
		const h = await sha256Hex(pwd);
		return h===APP_PASS_HASH;
	}
	// é¢„è®¡ç®—æ— ç›å“ˆå¸Œ
	sha256Hex(PLAIN_PASS).then(h=>{ APP_PASS_HASH=h; console.log('APP_PASS_HASH(unsalted)=',h); });
	// å»¶è¿Ÿåˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œç¡®ä¿ DOM å·²æœ‰é®ç½©
	setTimeout(tryAuto,0);
	document.addEventListener('DOMContentLoaded', ()=>{
		const f=document.getElementById('loginForm');
		if(f && !f.dataset.bound){ f.dataset.bound='1'; f.addEventListener('submit', handleLogin); }
	});

	</script>

	<!-- ç™»å½•é®ç½© -->
	<div id="authOverlay" style="display:none;position:fixed;inset:0;z-index:9999;font-family:inherit;background:radial-gradient(circle at 30% 35%,#1d2530 0%,#0a0f14 70%);backdrop-filter:blur(14px);">
		<div class="login-shell">
			<div class="login-panel">
				<div class="brand-line">
					<div class="logo-mark">ğŸ¹</div>
					<div class="brand-text">
						<h1>ç´æˆ¿ç®¡ç†ç³»ç»Ÿ</h1>
						<span class="sub">Yehudi Menuhin School</span>
					</div>
				</div>
				<form id="loginForm" autocomplete="off" onsubmit="handleLogin(event)">
					<label class="field">
						<span class="label">å¯†ç </span>
						<input id="loginPassword" type="password" inputmode="text" autocomplete="new-password" placeholder="è¾“å…¥è®¿é—®å¯†ç " required />
					</label>
					<button id="loginBtn" type="submit" class="login-btn">è¿›å…¥ç³»ç»Ÿ</button>
					<div id="loginMsg" class="login-msg" aria-live="polite"></div>
					<div class="hint">å†…éƒ¨ä¸“ç”¨å¹³å° â€¢ æœªæˆæƒè¯·å‹¿ä¼ æ’­</div>
				</form>
			</div>
			<div class="login-footer">Â© <span id="yearNow"></span> YMS Practice Rooms</div>
		</div>
	</div>

	<style>
	/* ç™»å½•ç•Œé¢ä¸“ä¸šç®€çº¦é£æ ¼ */
	#authOverlay{color:#d8e1e9;}
	#authOverlay .login-shell{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;}
	#authOverlay .login-panel{width:360px;max-width:92vw;padding:42px 40px 38px;background:linear-gradient(145deg,rgba(34,44,56,0.85),rgba(20,26,34,0.9));border:1px solid rgba(255,255,255,0.06);border-radius:22px;box-shadow:0 8px 42px -12px rgba(0,0,0,0.55),0 18px 80px -30px rgba(0,0,0,0.6);backdrop-filter:blur(10px);}
	#authOverlay .brand-line{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;margin-bottom:28px;text-align:center;}
	#authOverlay .logo-mark{width:54px;height:54px;border-radius:16px;background:linear-gradient(135deg,#2d72c4,#38518a 60%,#1c2d44);display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 4px 18px -6px rgba(45,114,196,.55),0 2px 6px -2px rgba(0,0,0,.55);margin:0 auto;}
	#authOverlay .brand-text{text-align:center;}
	#authOverlay .brand-text h1{margin:0;font-size:22px;font-weight:600;letter-spacing:.5px;background:linear-gradient(90deg,#c5d9f2,#ffffff);background-clip:text;-webkit-background-clip:text;color:transparent;}
	#authOverlay .brand-text .sub{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:#7f8c98;display:inline-block;margin-top:4px;}
	#authOverlay form{display:flex;flex-direction:column;gap:20px;}
	#authOverlay .field{display:flex;flex-direction:column;gap:8px;}
	#authOverlay .field .label{font-size:13px;letter-spacing:.5px;color:#9fb1c0;font-weight:500;}
	#authOverlay .field, #authOverlay .field .label, #authOverlay .login-msg{ text-align:center; }
	#authOverlay input{background:#12181f;border:1px solid #2a3945;border-radius:14px;padding:14px 16px;font-size:15px;color:#e6edf3;outline:none;transition:.25s;font-family:inherit;}
	#authOverlay input:focus{border-color:#3d7bdc;box-shadow:0 0 0 1px #3d7bdc40,0 4px 18px -6px rgba(61,123,220,.35);}
	#authOverlay input::placeholder{color:#5b6a75;}
	#authOverlay .login-btn{background:linear-gradient(90deg,#2d72c4,#3f85e1);border:1px solid #3778d6;border-radius:14px;padding:14px 0;font-size:15px;font-weight:600;color:#fff;cursor:pointer;transition:.28s;box-shadow:0 6px 20px -8px rgba(47,118,195,.55);display:flex;align-items:center;justify-content:center;letter-spacing:.5px;}
	#authOverlay .login-btn:hover{filter:brightness(1.07);transform:translateY(-2px);box-shadow:0 10px 26px -10px rgba(47,118,195,.65);}
	#authOverlay .login-btn:active{transform:translateY(0);}
	#authOverlay .login-btn:disabled{opacity:.55;cursor:not-allowed;}
	#authOverlay .login-msg{min-height:18px;font-size:13px;color:#ff7a7a;font-weight:500;}
	#authOverlay .hint{margin-top:-6px;font-size:11px;letter-spacing:.5px;color:#667582;text-align:center;}
	#authOverlay .login-footer{margin-top:40px;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:#46515a;}
	@media (max-width:520px){#authOverlay .login-panel{padding:34px 30px 30px;width:330px;border-radius:20px;}#authOverlay .logo-mark{width:50px;height:50px;font-size:24px;}#authOverlay .brand-text h1{font-size:20px;}}
	</style>

	<script>
	// ç™»å½•ç•Œé¢å¹´ä»½è‡ªåŠ¨
	document.addEventListener('DOMContentLoaded',()=>{ const y=document.getElementById('yearNow'); if(y) y.textContent=new Date().getFullYear(); });
	// ç»‘å®šç™»å½• + å›è½¦
	document.addEventListener('DOMContentLoaded',()=>{
		const f=document.getElementById('loginForm');
		if(!f) return;
		f.addEventListener('submit', handleLogin);
		document.getElementById('loginPassword').addEventListener('keydown',e=>{ if(e.key==='Enter'){ f.requestSubmit(); }});
	});
	</script>

<!-- unified final contrast & empty-room enhancement (moved inside body) -->
<style id="room-card-contrast-final">
/* æå‡æ•´ä½“æ–‡æœ¬ä¸ç©ºé—²æˆ¿å¡å¯è§åº¦ï¼›é›†ä¸­å”¯ä¸€è¦†ç›–ï¼Œé¿å…å¤šå±‚å†²çª */
body{--text:#e2ebf3; --text-dim:#a5b6c6;}
.room-card{color:#eef5fa !important;}
.room-card .room-name{color:#ffffff !important; text-shadow:0 1px 3px rgba(0,0,0,.55) !important; font-weight:700 !important;}
.room-card .occupant-line span:last-child{color:#fff !important; font-weight:600 !important;}

/* ä½¿ç”¨ä¸­æˆ¿é—´ï¼šæŒ‰ç±»å‹ç€è‰²å¹¶å¢åŠ æ›´æ·±å±‚æ¬¡å…‰å½± */
.room-card[data-status="occupied"]{position:relative;transition:transform .28s ease, box-shadow .35s ease, border-color .35s ease;}
/* grand (è“) */
.room-card[data-status="occupied"][data-type="grand"]{
	background:linear-gradient(145deg,#1b2937 0%,#152534 42%,#0e1823 100%) !important;
	border:1px solid #4a90e2 !important;
	box-shadow:
		0 0 0 1px rgba(74,144,226,0.35),
		0 4px 14px -3px rgba(0,0,0,0.65),
		0 8px 32px -6px rgba(30,80,130,0.45),
		0 14px 54px -10px rgba(30,80,130,0.38),
		inset 0 1px 0 rgba(255,255,255,0.05),
		inset 0 0 0 1px rgba(74,144,226,0.18) !important;
}
.room-card[data-status="occupied"][data-type="grand"]:hover{
	border-color:#5fa3ff !important;
	box-shadow:
		0 0 0 1px rgba(95,163,255,0.5),
		0 6px 20px -4px rgba(0,0,0,0.7),
		0 10px 40px -8px rgba(60,120,190,0.55),
		0 18px 70px -12px rgba(60,120,190,0.45),
		inset 0 1px 0 rgba(255,255,255,0.07),
		inset 0 0 0 1px rgba(95,163,255,0.25) !important;
	transform:translateY(-5px) !important;
}
.room-card[data-status="occupied"][data-type="grand"] .chip{background:rgba(74,144,226,0.18) !important; color:#87bfff !important; border:1px solid rgba(74,144,226,0.45) !important; font-weight:600 !important;}
/* upright (ç»¿) */
.room-card[data-status="occupied"][data-type="upright"]{
	background:linear-gradient(145deg,#163b2d 0%,#123126 42%,#0c2219 100%) !important;
	border:1px solid #2aa876 !important;
	box-shadow:
		0 0 0 1px rgba(42,168,118,0.35),
		0 4px 14px -3px rgba(0,0,0,0.65),
		0 8px 30px -6px rgba(24,110,80,0.45),
		0 14px 52px -10px rgba(24,110,80,0.38),
		inset 0 1px 0 rgba(255,255,255,0.05),
		inset 0 0 0 1px rgba(42,168,118,0.18) !important;
}
.room-card[data-status="occupied"][data-type="upright"]:hover{
	border-color:#37c28e !important;
	box-shadow:
		0 0 0 1px rgba(55,194,142,0.5),
		0 6px 20px -4px rgba(0,0,0,0.7),
		0 10px 40px -8px rgba(40,150,110,0.55),
		0 18px 70px -12px rgba(40,150,110,0.45),
		inset 0 1px 0 rgba(255,255,255,0.07),
		inset 0 0 0 1px rgba(55,194,142,0.25) !important;
	transform:translateY(-5px) !important;
}
.room-card[data-status="occupied"][data-type="upright"] .chip{background:rgba(42,168,118,0.20) !important; color:#49d69b !important; border:1px solid rgba(42,168,118,0.45) !important; font-weight:600 !important;}
/* other (ç´«) */
.room-card[data-status="occupied"][data-type="other"]{
	background:linear-gradient(145deg,#3a244d 0%,#301d43 42%,#211430 100%) !important;
	border:1px solid #8a63d8 !important;
	box-shadow:
		0 0 0 1px rgba(138,99,216,0.36),
		0 4px 14px -3px rgba(0,0,0,0.65),
		0 8px 32px -6px rgba(90,50,160,0.48),
		0 14px 56px -10px rgba(90,50,160,0.40),
		inset 0 1px 0 rgba(255,255,255,0.05),
		inset 0 0 0 1px rgba(138,99,216,0.20) !important;
}
.room-card[data-status="occupied"][data-type="other"]:hover{
	border-color:#a37dff !important;
	box-shadow:
		0 0 0 1px rgba(163,125,255,0.55),
		0 6px 20px -4px rgba(0,0,0,0.7),
		0 10px 42px -8px rgba(125,80,220,0.55),
		0 18px 70px -12px rgba(125,80,220,0.45),
		inset 0 1px 0 rgba(255,255,255,0.07),
		inset 0 0 0 1px rgba(163,125,255,0.28) !important;
	transform:translateY(-5px) !important;
}
.room-card[data-status="occupied"][data-type="other"] .chip{background:rgba(138,99,216,0.20) !important; color:#c3a4ff !important; border:1px solid rgba(138,99,216,0.48) !important; font-weight:600 !important;}

/* è¶…æ—¶æˆ¿é—´ï¼šçº¢è‰²è­¦å‘Šè¾¹æ¡†ä¸å‘å…‰ */
.room-card[data-status="overtime"]{
	background:linear-gradient(135deg,#4a2728 0%,#3d1f20 40%,#2a1415 100%) !important;
	border:1px solid #ff4757 !important;
	box-shadow:
		0 0 0 1px rgba(255,71,87,0.4),
		0 2px 12px rgba(255,71,87,0.15),
		0 6px 25px rgba(255,71,87,0.08),
		inset 0 1px 0 rgba(255,255,255,0.05) !important;
}
.room-card[data-status="overtime"]:hover{
	border-color:#ff6b7a !important;
	box-shadow:
		0 0 0 1px rgba(255,107,122,0.5),
		0 3px 16px rgba(255,71,87,0.25),
		0 8px 35px rgba(255,71,87,0.12),
		inset 0 1px 0 rgba(255,255,255,0.08) !important;
	transform:translateY(-4px) !important;
}
.room-card[data-status="overtime"] .chip{
	background:rgba(255,71,87,0.15) !important;
	color:#ff7373 !important;
	border:1px solid rgba(255,71,87,0.3) !important;
	font-weight:600 !important;
}

/* ç©ºé—²æˆ¿ï¼šå»é™¤äº®è¾¹ç¼˜/å‘å…‰ï¼Œä¿æŒç±»å‹åŒºåˆ†ï¼Œæ•´ä½“æ›´æš—æ›´å¹³ */
.room-card[data-status="empty"], .room-card.empty{
	/* æ›´é€æ˜ã€é™ä½é¥±å’Œåº¦ï¼šç»Ÿä¸€ææµ…åº•ï¼Œå¸¦è½»å¾®è‰²è°ƒ */
	background:linear-gradient(135deg, rgba(255,255,255,0.015) 0%, rgba(255,255,255,0.03) 60%, rgba(255,255,255,0.02) 100%) !important;
	border:1px solid rgba(160,170,190,0.15) !important;
	box-shadow:none !important;
}
/* æŒ‰ç±»å‹æä¾›æè½»çš„è‰²å½©å€¾å‘ï¼ˆalpha å¾ˆä½ï¼‰ */
.room-card[data-status="empty"][data-type="grand"], .room-card.empty[data-type="grand"]{
	background:linear-gradient(135deg, rgba(60,110,170,0.10) 0%, rgba(40,70,110,0.08) 55%, rgba(25,45,70,0.10) 100%) !important;
	border-color:rgba(90,140,200,0.28) !important;
}
.room-card[data-status="empty"][data-type="upright"], .room-card.empty[data-type="upright"]{
	background:linear-gradient(135deg, rgba(40,140,100,0.10) 0%, rgba(30,90,70,0.08) 55%, rgba(20,60,45,0.10) 100%) !important;
	border-color:rgba(60,170,125,0.28) !important;
}
.room-card[data-status="empty"][data-type="other"], .room-card.empty[data-type="other"]{
	background:linear-gradient(135deg, rgba(120,70,180,0.11) 0%, rgba(90,50,140,0.08) 55%, rgba(65,40,110,0.10) 100%) !important;
	border-color:rgba(130,90,190,0.30) !important;
}
.room-card[data-status="empty"]:hover{transform:translateY(-2px) !important;}
.room-card[data-status="empty"] .chip{background:rgba(255,255,255,0.05) !important; border:1px solid rgba(255,255,255,0.12) !important; color:#d0d9e2 !important;}

/* çŠ¶æ€è‰²å¾®è°ƒ */
.chip{color:#cfd8e2 !important;}
.chip.accent{color:#7fbaff !important;}
.chip.danger{color:#ff7373 !important;}
.chip.good{color:#5edc7a !important;}
.chip.warn{color:#ffbc55 !important;}
</style>

<!-- æ‰¹é‡æ—¶é—´æ®µç®¡ç†æ ·å¼ -->
<style>
#bulkTimeManagerModal .btm-wrapper{width:90%;height:90%;margin:auto;background:#fff;border-radius:16px;display:flex;flex-direction:column;box-shadow:0 6px 30px rgba(0,0,0,.25);overflow:hidden;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
#bulkTimeManagerModal .btm-header{flex:0 0 auto;padding:14px 20px;background:linear-gradient(135deg,#007AFF,#5856D6);color:#fff;display:flex;justify-content:space-between;align-items:center;}
#bulkTimeManagerModal .btm-title{font-size:18px;font-weight:700;letter-spacing:.5px;}
#bulkTimeManagerModal .btm-actions{display:flex;gap:10px;flex-wrap:wrap;}
#bulkTimeManagerModal .btm-btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;letter-spacing:.5px;transition:.25s;color:#fff;}
#bulkTimeManagerModal .btm-primary{background:#007AFF;}
#bulkTimeManagerModal .btm-secondary{background:#4e5d78;}
#bulkTimeManagerModal .btm-danger{background:#e74c3c;}
#bulkTimeManagerModal .btm-btn:hover{opacity:.9;transform:translateY(-2px);}
#bulkTimeManagerModal .btm-body{flex:1;display:flex;overflow:hidden;background:#f2f5f9;}
#bulkTimeManagerModal .btm-left{flex:1;display:flex;flex-direction:column;padding:16px;overflow:hidden;}
#bulkTimeManagerModal .btm-right{width:320px;border-left:1px solid #eee;padding:16px;display:flex;flex-direction:column;gap:12px;background:#f8f9fb;}
#bulkTimeManagerModal .btm-stu-info{font-size:13px;color:#555;margin-bottom:10px;line-height:1.5;min-height:32px;}
#bulkTimeManagerModal .btm-legend{display:flex;gap:18px;flex-wrap:wrap;font-size:12px;color:#333;padding:8px 10px;background:#f2f5f9;border:1px solid #e0e4ea;border-radius:8px;margin-bottom:10px;}
#bulkTimeManagerModal .btm-table-wrap{flex:1;overflow:auto;border:1px solid #e0e4ea;border-radius:10px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05) inset;}
#bulkTimeManagerModal .btm-table{width:100%;border-collapse:separate;border-spacing:0;min-width:900px;font-size:12px;user-select:none;}
#bulkTimeManagerModal .btm-table thead th{background:#f0f3f7;position:sticky;top:0;z-index:2;padding:10px 8px;font-weight:700;border-bottom:1px solid #d6dae2;color:#2c3e50;}
#bulkTimeManagerModal .btm-time-col{width:120px;}
#bulkTimeManagerModal .btm-table tbody td{text-align:center;padding:8px 6px;border-bottom:1px solid #eef1f5;border-right:1px solid #eef1f5;position:relative;line-height:1.3;transition:all .25s ease;cursor:pointer;font-weight:500;color:#2f4150;}
#bulkTimeManagerModal .btm-table tbody td:last-child{border-right:none;}
#bulkTimeManagerModal .btm-table tbody tr:last-child td{border-bottom:none;}
#bulkTimeManagerModal .btm-cell:not(.btm-cell-selected):not(.btm-cell-rest){background:#fff;color:#2f4150;border-color:#eef1f5;}
#bulkTimeManagerModal .btm-cell:hover:not(.btm-cell-rest):not(.btm-cell-selected){background:#e6f1ff;border-color:#b1d3ff;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,122,255,.15);z-index:1;}
#bulkTimeManagerModal .btm-cell-selected{background:linear-gradient(135deg,#007AFF,#5856D6);color:#fff;font-weight:700;border-color:#3366cc;box-shadow:0 2px 6px rgba(0,0,0,.15) inset;}
#bulkTimeManagerModal .btm-cell-rest{background:linear-gradient(135deg,#6C757D,#495057);color:#fff;cursor:not-allowed;font-weight:600;border-color:#495057;}
#bulkTimeManagerModal .btm-cell-selected:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 3px 10px rgba(0,122,255,0.25);}
#bulkTimeManagerModal .btm-cell-rest:hover{transform:none;box-shadow:none;opacity:.8;}
#bulkTimeManagerModal .btm-wed-subwrap{display:flex;flex-direction:column;gap:2px;}
#bulkTimeManagerModal .btm-wed-sub{flex:1;padding:4px 2px;border:1px solid #eef1f5;border-radius:4px;transition:all .25s ease;cursor:pointer;font-weight:500;background:#fff;color:#2f4150;text-align:center;display:flex;align-items:center;justify-content:center;min-height:20px;}
#bulkTimeManagerModal .btm-wed-sub:hover:not(.rest):not(.selected){background:#e6f1ff;border-color:#b1d3ff;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,122,255,.15);}
#bulkTimeManagerModal .btm-wed-sub.selected{background:linear-gradient(135deg,#007AFF,#5856D6);color:#fff;font-weight:700;border-color:#3366cc;box-shadow:0 2px 6px rgba(0,0,0,.15) inset;}
#bulkTimeManagerModal .btm-wed-sub.rest{background:linear-gradient(135deg,#6C757D,#495057);color:#fff;cursor:not-allowed;font-weight:600;border-color:#495057;}
#bulkTimeManagerModal .btm-selected-list{flex:1;overflow:auto;background:#fff;border:1px solid #e0e4ea;border-radius:10px;padding:10px;font-size:12px;line-height:1.5;display:flex;flex-direction:column;gap:6px;}
#bulkTimeManagerModal .btm-chip{display:inline-block;background:#007aff22;border:1px solid #007aff88;color:#007AFF;padding:3px 8px;border-radius:14px;font-size:11px;margin:2px;font-weight:600;cursor:default;}
#bulkTimeManagerModal .btm-chip.wed{background:#5856d622;border-color:#5856d6aa;color:#4b49c8;}
#bulkTimeManagerModal .btm-note{font-size:11px;line-height:1.6;background:#fff9e6;border:1px solid #ffe3a3;padding:10px 12px;border-radius:8px;color:#8a6113;}
@media (max-width:1200px){#bulkTimeManagerModal .btm-right{width:280px;}}
@media (max-width:960px){#bulkTimeManagerModal .btm-wrapper{width:96%;height:94%;}#bulkTimeManagerModal .btm-right{display:none;}#bulkTimeManagerModal .btm-left{padding:10px;}}
</style>
<style>
.alert-filter-btn{border:1px solid #d0d7e2;background:#f5f8fc;color:#2e3b48;font-size:12px;padding:5px 12px;border-radius:18px;cursor:pointer;letter-spacing:.5px;font-weight:600;transition:.18s;line-height:1;}
.alert-filter-btn:hover{background:#e1eaf3;color:#1d2730;border-color:#c2ccd8;}
.alert-filter-btn:active{transform:translateY(1px);}
.alert-filter-btn.act{background:#007aff;color:#fff;border-color:#007aff;box-shadow:0 0 0 1px #007aff55 inset;}
.alert-filter-btn.act:hover{background:#0062d1;color:#fff;border-color:#0057bb;}
.alert-filter-btn:focus-visible{outline:2px solid #4d90fe;outline-offset:1px;}

/* ä¼˜åŒ–æé†’æ ·å¼ */
.alert-item {
	border-radius: 8px;
	padding: 8px 12px;
	margin-bottom: 4px;
	position: relative;
	transition: all 0.2s ease;
	border-left: 4px solid transparent;
	background: #fff;
	box-shadow: 0 1px 3px rgba(0,0,0,0.05);
	display: flex;
	align-items: center;
	justify-content: space-between;
	min-height: 36px;
}

/* ç¼ºå‹¤æé†’ - æ©™çº¢è‰² */
.alert-item.absent {
	background: #fff8f8;
	border-left-color: #f56565;
}

.alert-item.absent[data-severity="2"] {
	border-left-color: #e53e3e;
	background: #fef1f1;
}

/* å¼‚å¸¸æé†’ - é»„æ©™è‰² */
.alert-item.anomaly {
	background: #fffcf8;
	border-left-color: #ed8936;
}

.alert-item.anomaly[data-severity="1"] {
	border-left-color: #dd6b20;
	background: #fff9f3;
}

/* æ‚¬åœæ•ˆæœ */
.alert-item:hover {
	box-shadow: 0 2px 6px rgba(0,0,0,0.1);
	background-color: #f8f9fa;
}

.alert-item.absent:hover {
	background: #fff6f6;
}

.alert-item.anomaly:hover {
	background: #fffdf8;
}

/* å†…å®¹å¸ƒå±€ */
.alert-content {
	display: flex;
	align-items: center;
	gap: 12px;
	flex: 1;
}

.alert-student {
	font-weight: 600;
	font-size: 14px;
	color: #2d3748;
	min-width: 60px;
}

.alert-info {
	display: flex;
	align-items: center;
	gap: 8px;
	font-size: 12px;
	color: #718096;
}

.alert-time {
	font-size: 11px;
	color: #a0aec0;
}

/* æ ‡ç­¾æ ·å¼ */
.alert-tag {
	padding: 2px 6px;
	border-radius: 8px;
	font-size: 11px;
	font-weight: 500;
	letter-spacing: 0.3px;
}

.alert-tag.type-absent {
	background: #fed7d7;
	color: #c53030;
}

.alert-tag.type-anomaly {
	background: #feebc8;
	color: #c05621;
}

.alert-tag.slot-time {
	background: #e6fffa;
	color: #285e61;
	font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
}

/* æ“ä½œæŒ‰é’® */
.alert-actions {
	display: flex;
	gap: 4px;
}

.alert-btn {
	padding: 4px 8px;
	border: none;
	border-radius: 4px;
	font-size: 11px;
	font-weight: 500;
	cursor: pointer;
	transition: all 0.15s ease;
}

.alert-btn.ignore {
	background: #edf2f7;
	color: #4a5568;
	border: 1px solid #cbd5e0;
}

.alert-btn.ignore:hover {
	background: #e2e8f0;
	color: #2d3748;
}

/* å·²å¿½ç•¥çŠ¶æ€ */
.alert-item.ignored {
	opacity: 0.7;
	filter: grayscale(0.2);
}

.alert-ignored-flag {
	font-size: 10px;
	color: #a0aec0;
	margin-left: 8px;
}

/* ç©ºçŠ¶æ€ */
.alert-empty {
	text-align: center;
	color: #a0aec0;
	font-style: italic;
	padding: 40px 20px;
	font-size: 14px;
}
</style>

<script>
// ================= æ‰¹é‡æ—¶é—´æ®µç®¡ç† (BTM) =================
(function(){
	if(window.BTM) return;
	function toastLite(m){ if(window.toast) toast(m); else console.log('[BTM]',m); }
	const WEEKDAY_NAMES=['monday','tuesday','wednesday','thursday','friday'];
	const CHINESE_DAY=['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”'];
	function pad2(n){return String(n).padStart(2,'0');}
	function normTime(t){const m=t.match(/^(\d{1,2}):(\d{2})$/); if(!m) return t; return pad2(+m[1])+':'+m[2];}
	function rangeNorm(r){const [a,b]=r.split('-'); return normTime(a)+'-'+normTime(b);}  
	function sameRange(a,b){return rangeNorm(a)===rangeNorm(b);}  
	function minutesDiff(s,e){const [sh,sm]=s.split(':').map(Number); const [eh,em]=e.split(':').map(Number); return (eh*60+em)-(sh*60+sm);}  
	const BTM={
		timeSlots:['8:00-8:50','9:00-9:50','9:40-10:00','10:00-10:50','11:00-11:50','11:50-13:00','13:00-13:50','14:00-14:50','14:50-15:10','15:10-16:00','16:10-17:00','17:10-18:00'],
		wednesdaySlots:['8:00-8:50','9:00-9:50','9:40-10:00','10:00-10:50','11:00-11:50',['11:50-12:50','åˆé—´éŸ³ä¹ä¼š'],['13:30-14:20'],['14:30-15:20'],'15:20-15:40',['15:40-16:30'],['16:40-17:30'],['17:40-18:30']],
		breakIdx:[2,8], lunchIdx:[5],
		students:[], filteredStudents:[], currentIndex:-1, selectionMap:{}, remoteSlots:{},
		dom:{},
		initDom(){this.dom.modal=document.getElementById('bulkTimeManagerModal'); this.dom.tbody=document.getElementById('btmTbody'); this.dom.studentSelect=document.getElementById('btmStudentSelect'); this.dom.selectedList=document.getElementById('btmSelectedList'); this.dom.info=document.getElementById('btmStudentInfo'); this.dom.search=document.getElementById('btmSearchInput');},
		async open(){ if(!window.supabaseClient || (typeof window.supabaseReady!=='undefined' && !window.supabaseReady)){ toastLite('Supabase æœªå°±ç»ª'); return; } this.initDom(); await this.loadRemote(); this.buildStudents(); this.buildSelections(); this.renderTable(); this.applyFilter(); if(this.filteredStudents.length){ this.currentIndex=0; this.dom.studentSelect.value='0'; this.updateInfo(); this.highlight(); this.refreshSelectedList(); } this.dom.modal.style.display='block'; },
		close(){ if(this.dom.modal) this.dom.modal.style.display='none'; },
		async loadRemote(){ this.remoteSlots={}; const {data,error}=await supabaseClient.from('student_time_slots').select('*'); if(error){ console.error(error); if(error.status===401){ toastLite('æœªæˆæƒè®¿é—® student_time_slots (401)ï¼Œè¯·æ£€æŸ¥ Supabase Key / RLS ç­–ç•¥'); } else if(error.code==='42P01'){ toastLite('è¡¨ student_time_slots ä¸å­˜åœ¨'); } else { toastLite('åŠ è½½æ—¶é—´æ®µå¤±è´¥: '+error.message); } return;} (data||[]).forEach(r=>{ const name=r.student_name; if(!this.remoteSlots[name]) this.remoteSlots[name]={monday:[],tuesday:[],wednesday:[],thursday:[],friday:[]}; const day=WEEKDAY_NAMES[r.weekday-1]; if(!day) return; this.remoteSlots[name][day].push({start:normTime(r.start_time), end:normTime(r.end_time)}); }); Object.values(this.remoteSlots).forEach(week=>{ Object.values(week).forEach(arr=>arr.sort((a,b)=>a.start.localeCompare(b.start))); }); },
		buildStudents(){ this.students = (window.RoomStore?.students||[]).map(s=>({name:s.name,major:s.major||'',grade:s.grade||''})).sort((a,b)=>a.name.localeCompare(b.name,'zh-Hans-CN')); },
		buildSelections(){
			this.selectionMap={}; this.originalSelectionMap={};
			this.students.forEach(st=>{ 
				const cur=new Set(); this.selectionMap[st.name]=cur; 
				const week=this.remoteSlots[st.name]; if(!week){ this.originalSelectionMap[st.name]=new Set(); return; }
				WEEKDAY_NAMES.forEach((day,di)=>{ (week[day]||[]).forEach(sl=>{ const key=this.matchSlot(di, sl.start+'-'+sl.end); if(key) cur.add(key); }); });
				// åŸå§‹å¿«ç…§
				this.originalSelectionMap[st.name]=new Set(cur);
			});
		},
		isStudentChanged(name){
			const a=this.selectionMap?.[name]; const b=this.originalSelectionMap?.[name];
			if(!a && !b) return false; if(!a||!b) return true; if(a.size!==b.size) return true; for(const k of a){ if(!b.has(k)) return true; } return false;
		},
		applyFilter(){ const kw=(this.dom.search?.value||'').trim().toLowerCase(); this.filteredStudents=this.students.filter(s=> !kw || (window.matchPinyin?matchPinyin(s.name,kw):s.name.includes(kw))); this.renderStudentSelect(); },
		renderStudentSelect(){ const sel=this.dom.studentSelect; if(!sel) return; sel.innerHTML=this.filteredStudents.map((s,i)=>`<option value="${i}">${s.name} - ${s.major||''}</option>`).join(''); },
		renderTable(){ const tb=this.dom.tbody; if(!tb) return; tb.innerHTML=''; for(let i=0;i<this.timeSlots.length;i++){ const tr=document.createElement('tr'); const timeTd=document.createElement('td'); timeTd.className='btm-cell btm-time-col'; timeTd.textContent=this.timeSlots[i]; tr.appendChild(timeTd); for(let d=0;d<5;d++){ const td=document.createElement('td'); if(d===2){ const w=this.wednesdaySlots[i]; if(typeof w==='string'){ if(this.isRest(i,d,true)){ td.className='btm-cell-rest'; td.textContent=this.breakIdx.includes(i)?'ä¼‘æ¯':'åˆé¤'; } else { td.className='btm-cell'; td.dataset.key=`wed-${i}-0-2`; td.textContent=w; td.onclick=()=>this.toggle(td.dataset.key); } } else { const wrap=document.createElement('div'); wrap.className='btm-wed-subwrap'; w.forEach((sub,si)=>{ const div=document.createElement('div'); const key=`wed-${i}-${si}-2`; div.dataset.key=key; if(this.isSubRest(i,si) || !/\d{1,2}:\d{2}-\d{1,2}:\d{2}/.test(sub)){ div.className='btm-wed-sub rest'; div.textContent=sub==='11:50-12:50'?'åˆé¤':sub; } else { div.className='btm-wed-sub'; div.textContent=sub; div.onclick=()=>this.toggle(key,true); } wrap.appendChild(div); }); td.appendChild(wrap); } } else { if(this.isRest(i,d,false)){ td.className='btm-cell-rest'; td.textContent=this.breakIdx.includes(i)?'ä¼‘æ¯':'åˆé¤'; } else { td.className='btm-cell'; td.dataset.key=`${i}-${d}`; td.textContent=this.timeSlots[i]; td.onclick=()=>this.toggle(td.dataset.key); } } tr.appendChild(td);} tb.appendChild(tr);} },
		isRest(i,day,isWed){ if(isWed){ if(i===2||i===8) return true; if(i===5) return true; } else { if(this.breakIdx.includes(i)) return true; if(this.lunchIdx.includes(i)) return true; } return false; },
		isSubRest(i){ return i===2||i===8||i===5; },
		selectStudent(){ const idx=parseInt(this.dom.studentSelect.value); if(isNaN(idx)) { this.currentIndex=-1; return;} this.currentIndex=idx; this.updateInfo(); this.highlight(); this.refreshSelectedList(); },
		updateInfo(){ if(this.currentIndex<0){ this.dom.info.innerHTML=''; return;} const st=this.filteredStudents[this.currentIndex]; this.dom.info.innerHTML=`<b>å­¦ç”Ÿï¼š</b>${st.name}ã€€<b>ä¸“ä¸šï¼š</b>${st.major||''}ã€€<b>å¹´çº§ï¼š</b>${st.grade||'æœªæŒ‡å®š'}`; },
		toggle(key){ if(this.currentIndex<0) return; const st=this.filteredStudents[this.currentIndex]; const set=this.selectionMap[st.name]; if(set.has(key)) set.delete(key); else set.add(key); this.highlight(); this.refreshSelectedList(); },
		highlight(){ if(this.currentIndex<0) return; const st=this.filteredStudents[this.currentIndex]; const set=this.selectionMap[st.name]; this.dom.tbody.querySelectorAll('.btm-cell').forEach(c=>{ const k=c.dataset.key; if(!k) return; c.classList.toggle('btm-cell-selected', set.has(k)); }); this.dom.tbody.querySelectorAll('.btm-wed-sub:not(.rest)').forEach(s=>{ const k=s.dataset.key; if(!k) return; s.classList.toggle('selected', set.has(k)); }); },
		refreshSelectedList(){ if(!this.dom.selectedList) return; if(this.currentIndex<0){ this.dom.selectedList.innerHTML=''; return;} const st=this.filteredStudents[this.currentIndex]; const set=this.selectionMap[st.name]; if(!set.size){ this.dom.selectedList.innerHTML='<div style="color:#999;font-style:italic;">æš‚æ— é€‰æ‹©</div>'; return;} const groups={0:[],1:[],2:[],3:[],4:[]}; set.forEach(k=>{ if(k.startsWith('wed-')){ const p=k.split('-'); groups[2].push(k); } else { const [ti,di]=k.split('-').map(Number); groups[di].push(k);} }); let html=''; Object.entries(groups).forEach(([d,arr])=>{ if(!arr.length) return; arr.sort(); html+=`<div style="margin-bottom:6px;"><b>${CHINESE_DAY[d]}:</b><br>`; arr.forEach(k=>{ if(k.startsWith('wed-')){ const p=k.split('-'); const ti=parseInt(p[1]); const si=parseInt(p[2]); const slot=this.wednesdaySlots[ti]; const txt=Array.isArray(slot)?slot[si]:slot; if(/\d{1,2}:\d{2}-\d{1,2}:\d{2}/.test(txt)) html+=`<span class="btm-chip wed">${txt}</span>`; } else { const [ti]=k.split('-'); html+=`<span class="btm-chip">${this.timeSlots[ti]}</span>`; } }); html+='</div>'; }); this.dom.selectedList.innerHTML=html; },
		matchSlot(dayIndex,range){ const norm=rangeNorm(range); if(dayIndex===2){ for(let t=0;t<this.wednesdaySlots.length;t++){ const w=this.wednesdaySlots[t]; if(Array.isArray(w)){ for(let s=0;s<w.length;s++){ const seg=w[s]; if(/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(seg) && sameRange(seg,norm)) return `wed-${t}-${s}-2`; } } else { if(/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(w) && sameRange(w,norm)) return `wed-${t}-0-2`; } } return null;} else { for(let i=0;i<this.timeSlots.length;i++){ if(sameRange(this.timeSlots[i],norm)) return `${i}-${dayIndex}`; } return null; } },
		clearAll(){ if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿå½“å‰é€‰æ‹©ï¼Ÿ')) return; Object.values(this.selectionMap).forEach(set=>set.clear()); this.highlight(); this.refreshSelectedList(); toastLite('å·²æ¸…ç©º'); },
		async save(){ if(!supabaseClient){ toastLite('æœªè¿æ¥'); return;} if(!confirm('ä¿å­˜å°†è¦†ç›–æ‰€é€‰å­¦ç”Ÿå‘¨ä¸€åˆ°å‘¨äº”çš„å…¨éƒ¨æ—¶é—´æ®µï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ')) return; const btn=document.getElementById('btmSaveBtn'); if(btn){ btn.disabled=true; btn.textContent='ä¿å­˜ä¸­...'; }
			// åªæ”¶é›†æœ‰å˜æ›´çš„å­¦ç”Ÿ
			const changedStudents = this.students.filter(st=> this.isStudentChanged(st.name));
			if(!changedStudents.length){ if(btn){ btn.disabled=false; btn.textContent='ä¿å­˜'; } toastLite('æ²¡æœ‰å˜æ›´ï¼Œæ— éœ€ä¿å­˜'); return; }
			let changed=0; const errors=[]; const startTs=Date.now(); const total=changedStudents.length;
			try {
				let idx=0;
				for(const st of changedStudents){
					idx++;
					// è¿›åº¦æç¤ºï¼ˆé¿å…è¿‡äºé¢‘ç¹ DOM å†™ï¼Œå¯æ¯1äººæ›´æ–°ï¼‰
					if(btn) btn.textContent=`ä¿å­˜ä¸­... (${idx}/${total})`;
					try {
						const set=this.selectionMap[st.name]; if(!set) continue; // ç©ºé›†åˆä¹Ÿä»£è¡¨æ¸…ç©º
						const delRes=await supabaseClient.from('student_time_slots').delete().eq('student_name', st.name).in('weekday',[1,2,3,4,5]);
						if(delRes.error){
							if(delRes.error.status===401) errors.push(`${st.name} åˆ é™¤æœªæˆæƒ(401)`); else errors.push(`${st.name} åˆ é™¤å¤±è´¥:${delRes.error.message}`);
							continue;
						}
						const rows=[]; set.forEach(k=>{ if(k.startsWith('wed-')){ const p=k.split('-'); const ti=+p[1]; const si=+p[2]; const slot=this.wednesdaySlots[ti]; const txt=Array.isArray(slot)?slot[si]:slot; if(!/^\d{1,2}:\d{2}-\d{1,2}:\d{2}$/.test(txt)) return; const [s,e]=txt.split('-'); rows.push({student_name:st.name, weekday:3, start_time:normTime(s), end_time:normTime(e), duration_minutes:minutesDiff(s,e)}); } else { const [ti,di]=k.split('-').map(Number); const txt=this.timeSlots[ti]; const [s,e]=txt.split('-'); rows.push({student_name:st.name, weekday:di+1, start_time:normTime(s), end_time:normTime(e), duration_minutes:minutesDiff(s,e)}); } });
						if(rows.length){ const insRes=await supabaseClient.from('student_time_slots').insert(rows); if(insRes.error){ if(insRes.error.status===401) errors.push(`${st.name} æ’å…¥æœªæˆæƒ(401)`); else errors.push(`${st.name} æ’å…¥å¤±è´¥:${insRes.error.message}`); } else { changed++; } }
						else { changed++; }
					} catch(loopErr){ errors.push(`${st.name} å¼‚å¸¸:${loopErr.message||loopErr}`); }
				}
				// éªŒè¯
				let verifyCount='?'; try{ const {data,error}=await supabaseClient.from('student_time_slots').select('id',{count:'exact'}); if(!error){ verifyCount=data.length; } else if(error.status===401){ verifyCount='æœªæˆæƒ'; } }catch(_e){}
				const dur=Date.now()-startTs;
				if(errors.length){ console.error('[BTM Save Errors]', errors); toastLite(`éƒ¨åˆ†å¤±è´¥: ${errors.length} æ¡ï¼›æˆåŠŸ ${changed} äººï¼Œç”¨æ—¶ ${dur}ms`); alert(errors.slice(0,6).join('\n') + (errors.length>6?'\n...':'') ); }
				else if(changed===0){ toastLite('æ²¡æœ‰å¯ä¿å­˜çš„æ›´æ”¹'); }
				else { toastLite(`ä¿å­˜æˆåŠŸï¼š${changed} äººï¼Œè®°å½•â‰ˆ${verifyCount} (${dur}ms)`); if(btn) btn.textContent='ä¿å­˜æˆåŠŸ'; }
				// åˆ·æ–°æœ¬åœ°æ˜ å°„
				await this.loadRemote(); this.buildSelections(); this.highlight(); this.refreshSelectedList();
				// æ›´æ–°åŸºçº¿ä»¥é¿å…ç«‹å³å†æ¬¡æç¤ºå˜æ›´
				// buildSelections å·²åˆ·æ–° originalSelectionMap
				if(window.PracticeAlerts && PracticeAlerts.refreshSlots){ PracticeAlerts.refreshSlots(true); }
			} catch(fatal){
				console.error('[BTM Save Fatal]', fatal); toastLite('ä¿å­˜è¿‡ç¨‹å‡ºç°å¼‚å¸¸:'+ (fatal.message||fatal));
			} finally {
				if(btn){
					btn.disabled=false;
					// è‹¥ä¸æ˜¯æ˜¾ç¤ºâ€œä¿å­˜æˆåŠŸâ€åˆ™å›é€€åˆ°â€œä¿å­˜â€
					if(btn.textContent!=='ä¿å­˜æˆåŠŸ') btn.textContent='ä¿å­˜'; else setTimeout(()=>{ if(btn.textContent==='ä¿å­˜æˆåŠŸ') btn.textContent='ä¿å­˜'; }, 1500);
				}
			}
		},
		debugAuth: async function(){ if(!supabaseClient){ console.log('æ—  supabaseClient'); return;} const {data,error}=await supabaseClient.from('student_time_slots').select('*').limit(1); console.log('debugAuth select result:', data, error); if(error){ alert('è°ƒè¯•: '+ (error.status||'')+' '+error.message); } else { alert('è°ƒè¯•æˆåŠŸï¼Œè¿”å› '+data.length+' æ¡'); } },
		prevStudent(){ if(this.filteredStudents.length===0) return; this.currentIndex=(this.currentIndex<=0?this.filteredStudents.length-1:this.currentIndex-1); this.dom.studentSelect.value=String(this.currentIndex); this.updateInfo(); this.highlight(); this.refreshSelectedList(); },
		nextStudent(){ if(this.filteredStudents.length===0) return; this.currentIndex=(this.currentIndex>=this.filteredStudents.length-1?0:this.currentIndex+1); this.dom.studentSelect.value=String(this.currentIndex); this.updateInfo(); this.highlight(); this.refreshSelectedList(); }
	};
	window.BTM=BTM; window.openBulkTimeManager=()=>{ BTM.open(); };
	window.closeBulkTimeManager=()=>{ BTM.close(); };
	document.addEventListener('DOMContentLoaded',()=>{
		const btn=document.getElementById('btnBulkTime'); if(btn && !btn.dataset.bound){ btn.dataset.bound='1'; btn.addEventListener('click', ()=>openBulkTimeManager()); }
		const bind=(id,fn)=>{ const el=document.getElementById(id); if(el) el.onclick=fn; };
		bind('btmCloseBtn', ()=>closeBulkTimeManager());
		bind('btmPrevBtn', ()=>{BTM.prevStudent&&BTM.prevStudent();});
		bind('btmNextBtn', ()=>{BTM.nextStudent&&BTM.nextStudent();});
		bind('btmClearAllBtn', ()=>BTM.clearAll());
		bind('btmSaveBtn', ()=>BTM.save());
		const sel=document.getElementById('btmStudentSelect'); if(sel) sel.onchange=()=>BTM.selectStudent();
		const search=document.getElementById('btmSearchInput'); if(search) search.oninput=()=>{BTM.applyFilter(); if(BTM.filteredStudents.length){BTM.currentIndex=0; BTM.dom.studentSelect.value='0'; BTM.updateInfo(); BTM.highlight(); BTM.refreshSelectedList();}};
	});
})();
</script>

<script>
// ======= Practice Alerts (ç¼ºå‹¤ / å¼‚å¸¸) =======
(function(){
	console.log('[PracticeAlerts] IIFE å¼€å§‹æ‰§è¡Œ');
	// --- Practice Alerts ç›¸å…³ SQL ç»´æŠ¤æŒ‡å¼•ï¼ˆå¤åˆ¶åˆ° Supabase SQL Editor æ‰§è¡Œï¼ŒåŒ¿å key ä¸èƒ½ç›´æ¥è·‘ DDLï¼‰ ---
	/*
	-- 1. å­—æ®µä¸æ™®é€šç´¢å¼•ï¼ˆå¹‚ç­‰ï¼‰
	ALTER TABLE public.practice_alerts ADD COLUMN IF NOT EXISTS severity integer;
	CREATE INDEX IF NOT EXISTS idx_practice_alerts_created_at ON public.practice_alerts(created_at DESC);
	CREATE INDEX IF NOT EXISTS idx_practice_alerts_student_type ON public.practice_alerts(student_name, type);

	-- 2. æ—§å”¯ä¸€ç´¢å¼•ï¼ˆè‹¥å·²å­˜åœ¨éœ€åˆ é™¤ï¼Œå…è®¸è¢«å¿½ç•¥åé‡æ–°ç”Ÿæˆæé†’ï¼‰
	DROP INDEX IF EXISTS uniq_practice_alerts_day; -- æ—§ï¼šä¸åŒºåˆ† ignored

	-- 3. æ–°æ¡ä»¶å”¯ä¸€ç´¢å¼•ï¼šåªé™åˆ¶æœªå¿½ç•¥è®°å½•ï¼Œignored=true åå¯å†ç”ŸæˆåŒç»„åˆæ–°æé†’
	CREATE UNIQUE INDEX IF NOT EXISTS uniq_practice_alerts_day_active
	ON public.practice_alerts (student_name, type, slot_start, slot_end, (date(created_at)))
	WHERE ignored = false;

	-- å›æ»šæ–¹å¼ï¼ˆè‹¥æƒ³æ¢å¤â€œå¿½ç•¥åä¸å†å‡ºç°â€è¡Œä¸ºï¼‰
	-- DROP INDEX IF EXISTS uniq_practice_alerts_day_active;
	-- CREATE UNIQUE INDEX IF NOT EXISTS uniq_practice_alerts_day
	-- ON public.practice_alerts (student_name, type, slot_start, slot_end, (date(created_at)));
	*/

	// åœ¨ç•Œé¢æä¾›å¤åˆ¶ SQL çš„è¾…åŠ©ï¼ˆåªç”Ÿæˆä¸€æ¬¡æŒ‰é’®ï¼‰
	if(!document.getElementById('alertSqlCopyBtn')){
		const btn=document.createElement('button');
		btn.id='alertSqlCopyBtn';
		btn.textContent='å¤åˆ¶æé†’ç´¢å¼•SQL';
		btn.style.cssText='position:fixed;bottom:12px;left:12px;z-index:3200;font-size:12px;padding:6px 10px;border-radius:6px;background:#2d3748;color:#fff;border:1px solid #415065;cursor:pointer;opacity:.65;';
		btn.onmouseenter=()=>btn.style.opacity='1';
		btn.onmouseleave=()=>btn.style.opacity='.65';
		btn.onclick=()=>{
			const sql=`-- Practice Alerts ç»“æ„åŒ–ç´¢å¼•ç»´æŠ¤\nALTER TABLE public.practice_alerts ADD COLUMN IF NOT EXISTS severity integer;\nCREATE INDEX IF NOT EXISTS idx_practice_alerts_created_at ON public.practice_alerts(created_at DESC);\nCREATE INDEX IF NOT EXISTS idx_practice_alerts_student_type ON public.practice_alerts(student_name, type);\nDROP INDEX IF EXISTS uniq_practice_alerts_day;\nCREATE UNIQUE INDEX IF NOT EXISTS uniq_practice_alerts_day_active ON public.practice_alerts (student_name, type, slot_start, slot_end, (date(created_at))) WHERE ignored = false;`;
			navigator.clipboard.writeText(sql).then(()=>{ console.log('[PracticeAlerts] å·²å¤åˆ¶ SQL'); toast('å·²å¤åˆ¶æé†’ç´¢å¼•SQL'); }).catch(e=>{ console.warn(e); });
		};
		document.body.appendChild(btn);
	}
	if(window.PracticeAlerts) {
		console.log('[PracticeAlerts] å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
		return;
	}
		const AlertStore={ list:[], byId:new Map(), slotsToday:null, timer:null, lastSlotLoadDay:null, _lastPeriodicReload:0, dedupe:new Set() };
		const ALERT_TYPES={ ABSENT:'absent', ANOMALY:'anomaly' };
		// é˜ˆå€¼å¯è°ƒï¼ˆåˆ†é’Ÿï¼‰
		const THRESHOLDS={ ABSENT_WINDOW_START:5, ABSENT_WINDOW_END:15, ANOMALY_OVERRUN:15, ENDED_OVERRUN:30, ABSENT_PAST_GRACE:10 }; // ABSENT_PAST_GRACE: è¿‡å» slot ç»“æŸåå¤šå°‘åˆ†é’Ÿä»å…è®¸è¡¥å‘ç¼ºå‹¤
	function now(){ return Date.now(); }
	function fmt(ts){ const d=new Date(ts); return d.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); }
	function ensureSlotsLoaded(){ const todayKey=new Date().toDateString(); if(AlertStore.lastSlotLoadDay===todayKey && AlertStore.slotsToday) return Promise.resolve(); return loadTodaySlots(); }
	async function loadTodaySlots(){ if(!window.supabaseClient) return; const weekday=(new Date().getDay()+6)%7 +1; // 1-7; we only use 1-5
		try{ const {data,error}=await supabaseClient.from('student_time_slots').select('*').eq('weekday', weekday).order('start_time'); if(error){ console.warn('loadTodaySlots error', error); return; } const map={}; (data||[]).forEach(r=>{ if(!map[r.student_name]) map[r.student_name]=[]; map[r.student_name].push(r); }); AlertStore.slotsToday=map; AlertStore.lastSlotLoadDay=new Date().toDateString(); }catch(e){ console.error(e); }
	}
		function forceReloadSlots(){ AlertStore.lastSlotLoadDay=null; return ensureSlotsLoaded(); }
	function currentFilter(){ return AlertStore.filter||'all'; }
	function applyFilter(list){ const f=currentFilter(); if(f==='all') return list; if(f==='absent') return list.filter(a=>a.type==='absent'); if(f==='anomaly') return list.filter(a=>a.type==='anomaly'); return list; }
	function updateFilterButtons(){ document.querySelectorAll('.alert-filter-btn').forEach(b=>{ b.classList.toggle('act', b.dataset.filter===currentFilter()); }); }
	function renderAlerts(){ 
		console.log('[PracticeAlerts] renderAlerts å¼€å§‹ï¼ŒAlertStore.list:', AlertStore.list.length);
		const box=document.getElementById('alertList'); 
		if(!box) {
			console.error('[PracticeAlerts] alertList å…ƒç´ ä¸å­˜åœ¨ï¼');
			return;
		}
		// æ’åºï¼šæœ€è¿‘æ—¶é—´æ®µ -> æœ€è¿œã€‚ä¼˜å…ˆä½¿ç”¨ slot ç»“æŸæ—¶é—´ï¼ˆè‹¥æ— ç»“æŸç”¨å¼€å§‹ï¼‰ï¼Œç¼ºå°‘ slot ç”¨ created_atã€‚
		const sorted=[...AlertStore.list].sort((a,b)=>{
			function slotKey(x){
				if(x.slot){
					// ç»“æŸæ—¶é—´ä¼˜å…ˆï¼Œè½¬æ¢ä¸ºä»Šå¤©åˆ†é’Ÿæ•°ï¼›è‹¥åªæœ‰ start_time ä¹Ÿç”¨ start
					const et=x.slot.end_time||x.slot.start_time; 
					return timeStrToMinutes(et);
				}
				// æ²¡æœ‰ slotï¼šè‹¥æœ‰ created_at ç”¨å…¶æ—¶é—´æˆ³ï¼›å¦åˆ™ç½®æå°
				return (x.created_at? new Date(x.created_at).getTime()/60000 : -1);
			}
			const ka=slotKey(a); const kb=slotKey(b);
			// æ›´å¤§çš„(æ›´æ™šçš„)æ’åœ¨å‰é¢ => é™åº
			if(kb!==ka) return kb-ka;
			// æ¬¡çº§ï¼šåŒä¸€æ—¶é—´æ®µæŒ‰ id é™åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
			return (b.id||0)-(a.id||0);
		});
		const filtered=applyFilter(sorted); 
		console.log('[PracticeAlerts] è¿‡æ»¤åæé†’æ•°é‡:', filtered.length);
		if(!filtered.length){ 
			box.classList.add('alert-empty'); 
			box.innerHTML='æš‚æ— æé†’'; 
			console.log('[PracticeAlerts] æ˜¾ç¤ºï¼šæš‚æ— æé†’');
		} else { 
			box.classList.remove('alert-empty'); 
			box.innerHTML=filtered.map(a=>alertHtml(a)).join(''); 
			box.querySelectorAll('[data-act="ignore"]').forEach(btn=>{ btn.onclick=()=>ignoreAlert(btn.dataset.id); }); 
			console.log('[PracticeAlerts] æ¸²æŸ“äº†', filtered.length, 'æ¡æé†’');
		} 
		updateFilterButtons(); 
	}
		function alertHtml(a){ 
			const tags=[`<span class="alert-tag type-${a.type}">${a.type==='absent'?'ç¼ºå‹¤':'å¼‚å¸¸'}</span>`]; 
			if(a.slot){ tags.push(`<span class="alert-tag slot-time">${a.slot.start_time}-${a.slot.end_time}</span>`); } 
			// ç´§å‡‘å•è¡Œå¸ƒå±€
			const msg = a._msg || buildAlertMessage(a) || '';
			return `<div class="alert-item ${a.type}${a.ignored?' ignored':''}" data-id="${a.id}" data-severity="${a.severity||0}" title="${escapeHtml(msg)}">
			<div class="alert-content">
				<div class="alert-student">${a.student_name||''}</div>
				<div class="alert-info">
					${tags.join('')}
					<span class="alert-time">${fmt(a.created_at||a.createdAt||Date.now())}</span>
				</div>
			</div>
			<div class="alert-actions">
				<button class="alert-btn ignore" data-act="ignore" data-id="${a.id}">${a.ignored?'å·²å¿½ç•¥':'å¿½ç•¥'}</button>
				${a.ignored?'<span class="alert-ignored-flag">å·²å¿½ç•¥</span>':''}
			</div>
		</div>`; 
		}
		async function ignoreAlert(id){ const a=AlertStore.byId.get(id); if(!a) return; if(a.ignored) return; a.ignored=true; // æœ¬åœ°å…ˆç½®ä½
			removeAlertLocal(id); renderAlerts();
			// ç§»é™¤å»é‡ key (å…è®¸å¿½ç•¥åå†äº§ç”Ÿæ–°æé†’)
			try{ if(a.slot){ const k=`${a.student_name}|${a.type}|${a.slot.start_time}-${a.slot.end_time}|${(new Date()).toISOString().slice(0,10)}`; AlertStore.dedupe.delete(k); } }catch(_e){}
			// æœ¬åœ°å¹¿æ’­ï¼ˆåŒæµè§ˆå™¨å…¶å®ƒæ ‡ç­¾é¡µï¼‰
			try{ localStorage.setItem('practice_alerts_ignore_ping', JSON.stringify({id, t:Date.now()})); }catch(_e){}
			if(!window.supabaseClient) return; 
			try{ 
				console.log('[PracticeAlerts] æ ‡è®° ignored=true id=', id);
				const {data, error}=await supabaseClient.from('practice_alerts').update({ignored:true}).eq('id', id).select('id');
				if(error){ console.warn('ignore(update) fail', error); // å›æ»šæ¢å¤
					AlertStore.byId.set(String(id),a); AlertStore.list.unshift(a); renderAlerts(); 
				}else{
					console.log('[PracticeAlerts] æ ‡è®°æˆåŠŸ rows=', data?.length||0);
					// æˆåŠŸåé€šè¿‡ realtime UPDATE å…¶ä»–ç«¯ä¼šè‡ªåŠ¨ç§»é™¤ï¼›åŒæ—¶å¹¿æ’­å…œåº•
					try{ if(AlertStore._rtChannel){ AlertStore._rtChannel.send({type:'broadcast', event:'ignore', payload:{id}}); console.log('[PracticeAlerts][BC][ignore-update] å·²å‘é€å¹¿æ’­ id=', id); } }catch(e){ console.warn('[PracticeAlerts][BC] send update å¹¿æ’­å¤±è´¥', e); }
				}
			}catch(e){ console.error(e); AlertStore.byId.set(String(id),a); AlertStore.list.unshift(a); renderAlerts(); }
	}
		// ===== å¯¹è´¦ï¼šåŸºäºå­˜åœ¨æ€§ï¼ˆè®°å½•å·² delete å³æœ¬åœ°ç§»é™¤ï¼‰======
		async function reconcileIgnored(){
			if(!window.supabaseClient) return; 
			if(!AlertStore.list.length) return; 
			try{
				const ids=AlertStore.list.map(a=>a.id);
				const {data,error}=await supabaseClient.from('practice_alerts').select('id').in('id', ids);
				if(error){ console.warn('[PracticeAlerts] reconcile query error', error); return; }
				const existSet=new Set((data||[]).map(r=>String(r.id)));
				const before=AlertStore.list.length;
				AlertStore.list=AlertStore.list.filter(a=> existSet.has(String(a.id)) );
				let removed=0; AlertStore.byId.forEach((_,k)=>{ if(!existSet.has(k)){ AlertStore.byId.delete(k); removed++; }});
				if(removed>0 || before!==AlertStore.list.length){ console.log('[PracticeAlerts] reconcileIgnored ä¿®æ­£æœ¬åœ°ç¼ºå¤±', removed, 'æ¡'); renderAlerts(); }
			}catch(e){ console.error('[PracticeAlerts] reconcileIgnored å¼‚å¸¸', e); }
		}
		let _reconcileTimer=null; function scheduleReconcile(delay=0){ if(_reconcileTimer) clearTimeout(_reconcileTimer); _reconcileTimer=setTimeout(()=>{ reconcileIgnored(); }, delay); }
		// æœ¬åœ°å­˜å‚¨å¹¿æ’­ç›‘å¬ï¼ˆåŒæºå¤šæ ‡ç­¾é¡µï¼‰
		window.addEventListener('storage', e=>{ if(e.key==='practice_alerts_ignore_ping'){ scheduleReconcile(500); } });
	async function fetchExistingAlerts(){ 
		console.log('[PracticeAlerts] fetchExistingAlerts å¼€å§‹');
		if(!window.supabaseClient) {
			console.warn('[PracticeAlerts] supabaseClient ä¸å­˜åœ¨');
			return;
		}
		try{ 
				const since=new Date(); since.setHours(0,0,0,0); 
				console.log('[PracticeAlerts] æŸ¥è¯¢ä»Šæ—¥æé†’ï¼Œsince:', since.toISOString());
				// æ‹‰å–å½“å¤©æœªå¿½ç•¥æé†’
				const {data,error}=await supabaseClient.from('practice_alerts')
					.select('*')
					.gte('created_at', since.toISOString())
					.eq('ignored', false)
					.order('created_at',{ascending:false})
					.limit(200); 
			if(error){ 
				console.warn('[PracticeAlerts] fetch alerts error', error); 
				if(error.code === '42P01') {
					console.error('[PracticeAlerts] practice_alerts è¡¨ä¸å­˜åœ¨ï¼');
				}
				return;
			} 
			console.log('[PracticeAlerts] è·å–åˆ°æé†’æ•°æ®:', data?.length || 0, 'æ¡');
			AlertStore.list=(data||[]).map(a => {
				// ä¿®å¤å­—æ®µæ˜ å°„ï¼šæ•°æ®åº“çš„ slot_start/slot_end â†’ å‰ç«¯çš„ start_time/end_time
				a.slot = a.slot_start && a.slot_end ? {
					start_time: a.slot_start,
					end_time: a.slot_end
				} : null;
				return a;
			}); 
			AlertStore.byId.clear(); 
			AlertStore.list.forEach(a=>AlertStore.byId.set(String(a.id),a)); 
			console.log('[PracticeAlerts] AlertStore.list é•¿åº¦:', AlertStore.list.length);
			AlertStore._lastFullReload = Date.now();
			renderAlerts(); 
		}catch(e){ 
			console.error('[PracticeAlerts] fetchExistingAlerts å¼‚å¸¸:', e); 
		}
	}
		function getActivePractice(student){ // approximate current ongoing log
				// ä¼˜å…ˆä½¿ç”¨ practiceLogsï¼ˆå¦‚æœæœ‰åå°å†™å…¥ï¼‰
				if(window.practiceLogs){
					const nowTs=Date.now();
					const found=(practiceLogs[student]||[]).find(l=>!l.end_time && nowTs - (new Date(l.start_time).getTime()) < 6*60*60*1000);
					if(found) return found;
				}
				// å›é€€ï¼šæ ¹æ®å½“å‰æˆ¿é—´å ç”¨æ¨æ–­ï¼ˆæ— æ—¥å¿—æƒ…å†µä¸‹ï¼‰
				for(const r of Store.rooms){ if(r.occupant===student && r.registerTime){
					return { start_time:new Date(r.registerTime).toISOString(), room:r.name, pseudo:true };
				} }
				return null;
			}
		function anyPracticeLogs(student){ if(!window.practiceLogs) return []; return practiceLogs[student]||[]; }
		function timeStrToMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
		function minutesNow(){ const d=new Date(); return d.getHours()*60 + d.getMinutes(); }
		// åˆ¤æ–­æ˜¯å¦æœ‰ä»»æ„ç»ƒç´æ—¥å¿—ä¸ slot æ—¶é—´æ®µé‡å ï¼ˆå¼€å§‹æ—©äº slot ç»“æŸï¼Œç»“æŸæ™šäº slot å¼€å§‹ï¼‰
		function hasPracticeOverlap(student, slot){
			const slotStart=toMinutes(slot.start_time); const slotEnd=toMinutes(slot.end_time);
			// 1) å…ˆçœ‹å·²çŸ¥ç»ƒç´æ—¥å¿—
			const logs=anyPracticeLogs(student) || []; 
			const logOverlap = logs.some(l=>{
				const startMs=new Date(l.start_time).getTime();
				const endMs = l.end_time ? new Date(l.end_time).getTime() : Date.now();
				const sMin = new Date(startMs).getHours()*60 + new Date(startMs).getMinutes();
				const eMin = new Date(endMs).getHours()*60 + new Date(endMs).getMinutes();
				return sMin < slotEnd && eMin >= slotStart; // åŒ…å«å¼åˆ¤å®šï¼Œä¿®æ­£è¾¹ç•Œ
			});
			if(logOverlap) return true;
			// 2) æ— æ—¥å¿—æ—¶ï¼Œå…¼å®¹å®æ—¶å ç”¨ï¼šå°†â€œå½“å‰å ç”¨â€è§†ä½œä¸€æ¡ [registerTime, now] çš„ä¸´æ—¶ä¼šè¯
			const active = getActivePractice(student);
			if(active){
				const startMs=new Date(active.start_time).getTime();
				const endMs = Date.now();
				const sMin = new Date(startMs).getHours()*60 + new Date(startMs).getMinutes();
				const eMin = new Date(endMs).getHours()*60 + new Date(endMs).getMinutes();
				if(sMin < slotEnd && eMin >= slotStart) return true;
			}
			return false;
			function toMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
		}
		function slotAt(student){ const arr=AlertStore.slotsToday?.[student]; if(!arr) return null; const nowMin=minutesNow(); return arr.find(s=>{ const st=timeStrToMinutes(s.start_time); const et=timeStrToMinutes(s.end_time); return nowMin>=st && nowMin<=et; }); }
		function nextSlot(student){ const arr=AlertStore.slotsToday?.[student]; if(!arr) return null; const nowMin=minutesNow(); return arr.find(s=> timeStrToMinutes(s.start_time) > nowMin ); }
		function findSlotByStart(student, activeLog){ // æ ¹æ®æ´»åŠ¨æ—¥å¿—å¼€å§‹æ—¶é—´æ‰€å± slot
			if(!activeLog) return null; const arr=AlertStore.slotsToday?.[student]; if(!arr) return null; const stTime=new Date(activeLog.start_time); const stMin=stTime.getHours()*60+stTime.getMinutes(); return arr.find(s=>{ const sMin=timeStrToMinutes(s.start_time); const eMin=timeStrToMinutes(s.end_time); return stMin>=sMin && stMin<=eMin; })||null; }
		function anomalyShouldTrigger(student, activeLog){ // é€»è¾‘ï¼šè‹¥å½“å‰ä»å ç”¨ä¸”è¶…è¿‡æ‰€å± slot ç»“æŸ + é˜ˆå€¼ï¼Œä¸”â€œå½“å‰ä¸åœ¨è¯¥å­¦ç”Ÿä»»æ„ä¸€ä¸ªæ—¶æ®µå†…â€
				if(!activeLog) return false; 
				const slot=findSlotByStart(student, activeLog); 
				if(!slot){
					// æ²¡æ‰¾åˆ° slotï¼šå¯èƒ½ç»ƒç´è·¨æ®µæˆ–æ— æ’ç¨‹ï¼Œå¿½ç•¥
					return false;
				}
				const nowMin=minutesNow(); 
				const eMin=timeStrToMinutes(slot.end_time); 
				if(nowMin <= eMin + THRESHOLDS.ANOMALY_OVERRUN){
					return false; // æœªè¶…è¿‡è¶…æ—¶é˜ˆå€¼
				}
				const arr=AlertStore.slotsToday?.[student]||[]; 
				if(arr.length===0){
					// ä¿å®ˆå¤„ç†ï¼šæœªåŠ è½½åˆ°æ—¶æ®µæ—¶ä¸è§¦å‘ï¼Œå¾…ä¸‹æ¬¡ tick æœ‰æ—¶æ®µåå†åˆ¤æ–­
					return false;
				}
				// æ›´ç¨³å¥ï¼šåªè¦å½“å‰æ—¶é—´å¤„äºè¯¥å­¦ç”Ÿâ€œä»»ä¸€åˆæ³•æ—¶æ®µâ€ï¼Œå°±ä¸è§†ä¸ºå¼‚å¸¸ï¼ˆé¿å…è·¨æ®µè¿ç»­ç»ƒç´è¯¯åˆ¤ï¼‰
				const inAnySlot = arr.some(s=>{ const sMin=timeStrToMinutes(s.start_time); const e2=timeStrToMinutes(s.end_time); return nowMin>=sMin && nowMin<=e2; });
				if(inAnySlot) return false; 
				return true; 
		}
		let _lastDetectionDate=(new Date()).toDateString();
		async function detectionTick(){ // é¡ºåº: è·¨æ—¥é‡ç½® -> ç¡®ä¿slots -> å‘¨æœŸåˆ·æ–° -> ç¼ºå‹¤ -> æ´»åŠ¨è¶…æ—¶ -> ç»“æŸè¶…æ—¶
			if(AlertStore.recalcLock){
				return; // é‡ç®—æœŸé—´æš‚åœæ£€æµ‹
			}
			if(!window.supabaseClient) return; const todayStr=(new Date()).toDateString(); if(todayStr!==_lastDetectionDate){ // è·¨æ—¥ï¼šé‡ç½®slotsä¸å½“æ—¥alertsç¼“å­˜
			_lastDetectionDate=todayStr; AlertStore.slotsToday=null; AlertStore.lastSlotLoadDay=null; await fetchExistingAlerts(); }
				// è¡¥å¿ï¼šæ¯5åˆ†é’Ÿå¼ºåˆ¶åˆ·æ–°æœªå¿½ç•¥æé†’ï¼Œé˜²æ­¢é”™è¿‡ UPDATE äº‹ä»¶å¯¼è‡´å¦ä¸€ç«¯å·²å¿½ç•¥å´ä»æ˜¾ç¤º
				if(!AlertStore._lastFullReload || (Date.now()-AlertStore._lastFullReload) > 5*60*1000){
					console.log('[PracticeAlerts] è§¦å‘å‘¨æœŸæ€§å…¨é‡åˆ·æ–° (5min)');
					await fetchExistingAlerts();
				}
				// å°é¢‘ç‡å¯¹è´¦ï¼šæ¯æ¬¡ tick åæ’ä¸€ä¸ªå»¶è¿Ÿå¯¹è´¦ï¼ˆé¿å…é«˜å¹¶å‘ç«‹åˆ»å¤šæ¬¡è¯·æ±‚ï¼‰
				scheduleReconcile(4000);
			await ensureSlotsLoaded(); const nowMin=minutesNow(); const students=Object.keys(AlertStore.slotsToday||{});
			// å‘¨æœŸåˆ·æ–°ï¼šæ¯10åˆ†é’Ÿå¼ºåˆ¶ (åˆ†é’Ÿæ•° %10 ==0) ä¸”è·ç¦»ä¸Šæ¬¡>2åˆ†é’Ÿï¼Œé¿å…åŒä¸€åˆ†é’Ÿå¤šæ¬¡
			const minute=new Date().getMinutes(); if(minute%10===0 && (now()-AlertStore._lastPeriodicReload)>120000){ forceReloadSlots().then(()=>{ AlertStore._lastPeriodicReload=now(); }); }
			for(const name of students){ 
				const arr=AlertStore.slotsToday[name]; 
				if(!arr||!arr.length) continue; 
				// ç¼ºå‹¤ï¼šæ—¶æ®µå¼€å§‹çª—å£ + è¿‡å»è¡¥å‘
				for(const slot of arr){ 
					const st=timeStrToMinutes(slot.start_time); 
					const et=timeStrToMinutes(slot.end_time);
					if(nowMin>=st+THRESHOLDS.ABSENT_WINDOW_START && nowMin<=st+THRESHOLDS.ABSENT_WINDOW_END){ 
						// è‹¥å­¦ç”Ÿå½“å‰æ­£å¤„äºæœ¬æ—¶æ®µå¹¶åœ¨ç»ƒç´ï¼ˆè·¨æ®µè¿ç»­ç»ƒç´åœºæ™¯ï¼‰ï¼Œä¸åº”åˆ¤ä¸ºç¼ºå‹¤
						const activeNow = getActivePractice(name);
						if(!(activeNow && nowMin>=st && nowMin<=et)){
							if(!hasAlert(name,'absent',slot) && !hasPracticeOverlap(name,slot)){
								await createAlert({type:ALERT_TYPES.ABSENT, student_name:name, slot, message:`${slot.start_time} æ—¶æ®µæœªç™»è®°`, severity:2}); 
							}
						}
					}else if(nowMin>et && nowMin<=et+THRESHOLDS.ABSENT_PAST_GRACE){
						if(!hasAlert(name,'absent',slot) && !hasPracticeOverlap(name,slot)){
							await createAlert({type:ALERT_TYPES.ABSENT, student_name:name, slot, message:`${slot.start_time}-${slot.end_time} æ—¶æ®µç¼ºå‹¤`, severity:2});
						}
					}
				}
				// è‡ªåŠ¨æ¶ˆå¤±ï¼šå¦‚æœå·²æœ‰ç¼ºå‹¤æé†’ä½†ç°åœ¨æ—¶æ®µå†…æœ‰ç»ƒç´ï¼Œåˆ™åˆ é™¤ç¼ºå‹¤æé†’
				const existingAbsentAlerts = AlertStore.list.filter(a => a.student_name === name && a.type === 'absent');
				for(const alert of existingAbsentAlerts) {
					if(alert.slot && hasPracticeOverlap(name, alert.slot)) {
						await autoResolveAlert(alert.id, `${alert.slot.start_time} æ—¶æ®µå·²å¼€å§‹ç»ƒç´`);
					}
				}
				// å¼‚å¸¸ï¼šæ´»åŠ¨ä»åœ¨
				const active=getActivePractice(name); 
				if(active){
					if(anomalyShouldTrigger(name, active)){
						const slot=findSlotByStart(name, active); 
						if(slot && !hasAlert(name,'anomaly',slot)){
							console.log('[PracticeAlerts] è§¦å‘å¼‚å¸¸æé†’', name, slot.start_time, slot.end_time);
							await createAlert({type:ALERT_TYPES.ANOMALY, student_name:name, slot, message:`ç»ƒç´å·²è¶…è¿‡è¯¥æ—¶æ®µ (${slot.end_time}) ${THRESHOLDS.ANOMALY_OVERRUN} åˆ†é’Ÿ`, severity:1}); 
						}
					}
					if(active.pseudo && !window.practiceLogs){
						window.practiceLogs = window.practiceLogs || {}; 
						const arr2 = window.practiceLogs[name] || (window.practiceLogs[name]=[]);
						if(!arr2.some(l=>l.pseudo && !l.end_time)){
							arr2.push({start_time:active.start_time, room:active.room, pseudo:true});
						}
					}
				}
			} // end students loop
		} // end detectionTick

		// ==== ä»Šæ—¥é‡ç®—å¹¶è¦†ç›–äº‘ç«¯ practice_alerts ====
		async function recalcToday(full=false){
			if(!window.supabaseClient){ console.warn('[PracticeAlerts][Recalc] no supabaseClient'); return; }
			if(AlertStore.recalcLock){ console.warn('[PracticeAlerts][Recalc] already running'); return; }
			AlertStore.recalcLock = true;
			console.log('[PracticeAlerts][Recalc] å¼€å§‹');
			const startedAt = Date.now();
			try{
				// 1. å‡†å¤‡æ•°æ®
				const today = new Date(); today.setHours(0,0,0,0); const todayIso = today.toISOString();
				const weekday=(new Date().getDay()+6)%7 +1; // 1-7
				const {data:slotRows, error:slotErr}=await supabaseClient.from('student_time_slots').select('*').eq('weekday', weekday);
				if(slotErr){ console.error('[PracticeAlerts][Recalc] slot fetch error', slotErr); return; }
				const slotsMap={}; (slotRows||[]).forEach(s=>{ (slotsMap[s.student_name] ||= []).push(s); });
				Object.values(slotsMap).forEach(arr=>arr.sort((a,b)=>a.start_time.localeCompare(b.start_time)));
				// ---- è·å–ç»ƒç´æ—¥å¿—ï¼šå…¼å®¹å¤šç‰ˆæœ¬åˆ—å (start_time/end_time æˆ– session_start/session_end) ----
				let logRows=[]; let logErr=null; let variantUsed=null;
				const variants=[
					{start:'start_time', end:'end_time'},
					{start:'session_start', end:'session_end'}
				];
				for(const v of variants){
					try{
						let q=supabaseClient.from('practice_logs').select(`student_name,${v.start},${v.end}`);
						q=q.gte(v.start, todayIso);
						const {data:eRows, error:eErr}=await q;
						if(eErr){ logErr=eErr; continue; }
						if(eRows && eRows.length){ logRows=eRows; variantUsed=v; break; }
						// è‹¥æ— æ•°æ®å°è¯•ä¸‹ä¸€ä¸ªå˜ä½“
					}catch(e){ logErr=e; }
				}
				if(!variantUsed){
					console.warn('[PracticeAlerts][Recalc] æœªåŒ¹é…åˆ°å«æ•°æ®çš„åˆ—åå˜ä½“ï¼Œæœ€åé”™è¯¯=', logErr); 
				}else{
					console.log('[PracticeAlerts][Recalc] ä½¿ç”¨æ—¥å¿—åˆ—å˜ä½“', variantUsed);
				}
				// å½’ä¸€åŒ–æ—¥å¿— -> {student_name, start_time, end_time}
				const logsByStu={};
				for(const raw of (logRows||[])){
					const stu=(raw.student_name||'').trim();
					const sCol=variantUsed? variantUsed.start : 'start_time';
					const eCol=variantUsed? variantUsed.end : 'end_time';
					const sVal=raw[sCol]; const eVal=raw[eCol];
					if(!sVal) continue; // æ²¡æœ‰å¼€å§‹æ—¶é—´æ— æ³•å‚ä¸é‡å 
					(constArr => { constArr.push({student_name:stu,start_time:sVal,end_time:eVal}); })( (logsByStu[stu] ||= []) );
				}
				// åˆå¹¶ï¼šåŒä¸€ start_time è‹¥åŒæ—¶å­˜åœ¨å·²ç»“æŸä¸æœªç»“æŸï¼Œä¼šä¼˜å…ˆä¿ç•™å·²ç»“æŸï¼ˆé¿å…â€œå¹½çµæœªç»“æŸâ€å¯¼è‡´æ•´ä¸Šåˆè¢«è§†ä¸ºä»åœ¨ç»ƒç´ï¼‰
				for(const stu of Object.keys(logsByStu)){
					const grouped = new Map();
					for(const l of logsByStu[stu]){
						const key=l.start_time; const prev=grouped.get(key);
						if(!prev) grouped.set(key,l);
						else{
							// é€‰æ‹©ç­–ç•¥ï¼šä¼˜å…ˆ end_time å­˜åœ¨çš„ï¼›è‹¥éƒ½æ—  end_time å–æœ€æ—©ï¼ˆä¿æŒåŸï¼‰
							if(prev.end_time) continue; // å·²æœ‰ç»“æŸçš„ï¼Œä¸æ›¿æ¢
							if(l.end_time){ grouped.set(key,l); }
						}
					}
					logsByStu[stu] = Array.from(grouped.values());
				}
				console.log('[PracticeAlerts][Recalc] slots å­¦ç”Ÿæ•°=', Object.keys(slotsMap).length, 'logs æ¡æ•°(è§„èŒƒåŒ–)=', logRows?.length||0);
				// 2. ç”Ÿæˆå€™é€‰
				const now=new Date(); const nowMin=now.getHours()*60+now.getMinutes();
				const alerts=[]; const dedupe=new Set();
				function toMin(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
				// å¤ç”¨é¡µé¢å®æ—¶é€»è¾‘ï¼šé‡å æ¡ä»¶ä¸ hasPracticeOverlap ä¿æŒä¸€è‡´ (sMin < slotEnd && eMin >= slotStart)
				function overlap(slot,log){
					const sS=toMin(slot.start_time), sE=toMin(slot.end_time);
					const stDate=new Date(log.start_time); const enDate = log.end_time? new Date(log.end_time): now;
					const sM=stDate.getHours()*60+stDate.getMinutes();
					const eM=enDate.getHours()*60+enDate.getMinutes();
					return sM < sE && eM >= sS; // ä¿®æ­£ >= è¾¹ç•Œ
				}
				const T=THRESHOLDS || {ABSENT_WINDOW_START:5,ABSENT_WINDOW_END:15,ABSENT_PAST_GRACE:25, ANOMALY_OVERRUN:15};
				let absentCount=0, anomalyCount=0;
				for(const student of Object.keys(slotsMap)){
					const slots=slotsMap[student]; const logs=logsByStu[student]||[];
					for(let i=0;i<slots.length;i++){
						const slot=slots[i]; const st=toMin(slot.start_time), et=toMin(slot.end_time);
						const hasOverlap = logs.some(l=>overlap(slot,l));
						// è°ƒè¯•ï¼šæ‰“å°è·¨æ®µé•¿ä¼šè¯ä¸è¯¥ slot çš„åˆ¤æ–­ï¼ˆä»…åœ¨éœ€è¦æ—¶å¯æ³¨é‡Šï¼‰
						// console.debug('[Recalc][OverlapDebug]', student, slot.start_time, slot.end_time, 'hasOverlap=', hasOverlap);
						if(!hasOverlap){
							const inStartWindow = nowMin>=st+T.ABSENT_WINDOW_START && nowMin<=st+T.ABSENT_WINDOW_END;
							// full=false: ç»“æŸååªè¦æ— é‡å éƒ½è§†ä¸ºç¼ºå‹¤ï¼ˆæ”¾å®½ï¼‰ï¼Œfull=true ä¿ç•™æ—§ grace
							const endedAndNoOverlap = nowMin>et && (!full ? true : nowMin<=et+T.ABSENT_PAST_GRACE);
							if(inStartWindow || endedAndNoOverlap){
								const key=`${student}|absent|${slot.start_time}-${slot.end_time}`;
								if(!dedupe.has(key)){
									dedupe.add(key);
									alerts.push({student_name:student,type:'absent',slot_start:slot.start_time,slot_end:slot.end_time});
									absentCount++;
								}
							}
						}else{
							// å¼‚å¸¸ï¼šä»…è€ƒè™‘â€œèµ·å§‹åœ¨è¯¥ slot å†…çš„è¿›è¡Œä¸­â€æ—¥å¿—ï¼ˆä¸å®æ—¶é€»è¾‘ä¿æŒä¸€è‡´ï¼‰ï¼Œé¿å…è·¨æ®µé•¿ä¼šè¯åœ¨å¤šä¸ªå†å² slot ä¸Šé‡å¤ç”Ÿæˆå¼‚å¸¸
							const active = logs.find(l=>!l.end_time && (()=>{ const stL=new Date(l.start_time); const stM=stL.getHours()*60+stL.getMinutes(); return stM>=st && stM<=et; })());
							if(active && nowMin > et + T.ANOMALY_OVERRUN){
								// åªè¦å½“å‰æ—¶é—´åœ¨è¯¥å­¦ç”Ÿä»»æ„åˆæ³•æ—¶æ®µå†…ï¼Œå°±ä¸ç®—å¼‚å¸¸
								const inAnySlot = slots.some(s=>{ const sM=toMin(s.start_time), eM=toMin(s.end_time); return nowMin>=sM && nowMin<=eM; });
								if(!inAnySlot){
									const key=`${student}|anomaly|${slot.start_time}-${slot.end_time}`;
									if(!dedupe.has(key)){
										dedupe.add(key);
										alerts.push({student_name:student,type:'anomaly',slot_start:slot.start_time,slot_end:slot.end_time});
										anomalyCount++;
									}
								}
							}
						}
					}
				}
				console.log('[PracticeAlerts][Recalc] ç”Ÿæˆå€™é€‰', alerts.length, 'ç¼ºå‹¤=', absentCount, 'å¼‚å¸¸=', anomalyCount, 'full=', full);
				// 3. è¦†ç›–ï¼šåˆ é™¤ä»Šæ—¥æ—§æ•°æ®
				const {error:delErr}=await supabaseClient.from('practice_alerts').delete().gte('created_at', todayIso);
				if(delErr){ console.error('[PracticeAlerts][Recalc] åˆ é™¤æ—§æé†’å¤±è´¥', delErr); return; }
				// 4. æ‰¹é‡æ’å…¥
				const batch=120; for(let i=0;i<alerts.length;i+=batch){ const slice=alerts.slice(i,i+batch); const {error:insErr}=await supabaseClient.from('practice_alerts').insert(slice); if(insErr){ console.error('[PracticeAlerts][Recalc] æ’å…¥å¤±è´¥ batch', i, insErr); return; } }
				console.log('[PracticeAlerts][Recalc] å†™å…¥å®Œæˆ ç”¨æ—¶(ms)=', Date.now()-startedAt);
				// 5. é‡æ–°æ‹‰å–æ¸²æŸ“
				await fetchExistingAlerts();
			}finally{
				AlertStore.recalcLock=false;
			}
		}
	function hasAlert(student,type,slot){ return AlertStore.list.some(a=> a.student_name===student && a.type===type && a.slot && slot && a.slot.start_time===slot.start_time && !a.resolved ); }
	async function autoResolveAlert(id, reason) {
		const a = AlertStore.byId.get(String(id));
		if (!a) return;
		// æœ¬åœ°ç§»é™¤
		removeAlertLocal(id);
		renderAlerts();
		// æœåŠ¡ç«¯æ ‡è®°ä¸º resolved æˆ–åˆ é™¤
		if (!window.supabaseClient) return;
		try {
			const {error} = await supabaseClient.from('practice_alerts').delete().eq('id', id);
			if (error) {
				console.warn('auto resolve alert delete fail', error);
				// å›æ»š
				AlertStore.byId.set(String(id), a);
				AlertStore.list.unshift(a);
				renderAlerts();
			}
		} catch(e) {
			console.error(e);
			AlertStore.byId.set(String(id), a);
			AlertStore.list.unshift(a);
			renderAlerts();
		}
	}
		function dedupeKey(raw){ const dKey=(new Date()).toISOString().slice(0,10); const slotPart=raw.slot?`${raw.slot.start_time}-${raw.slot.end_time}`:'none'; return `${raw.student_name}|${raw.type}|${slotPart}|${dKey}`; }
		function markDedupe(key){ AlertStore.dedupe.add(key); setTimeout(()=>AlertStore.dedupe.delete(key), 60*60*1000); }
		async function createAlert(raw){ 
				const key=dedupeKey(raw); if(AlertStore.dedupe.has(key)) return; 
				// æœåŠ¡å™¨è¡¨æ—  message å­—æ®µï¼šä»…å­˜ç»“æ„åŒ–å­—æ®µ
				const payload={ 
					student_name:raw.student_name, 
					type:raw.type, 
					slot_start:raw.slot?raw.slot.start_time:null, 
					slot_end:raw.slot?raw.slot.end_time:null, 
					ignored:false, 
					severity:typeof raw.severity==='number'?raw.severity:null 
				};
				if(!supabaseClient) return; 
				// å…ˆåšåŒæ—¥å­˜åœ¨æ€§æ£€æŸ¥ï¼Œé¿å…è·¨ç«¯åˆšå¿½ç•¥ååˆå› æœ¬ç«¯ tick ç«‹å³æ’å…¥
				try{
					const since=new Date(); since.setHours(0,0,0,0);
					let qry=supabaseClient.from('practice_alerts')
						.select('id')
						.gte('created_at', since.toISOString())
						.eq('student_name', payload.student_name)
						.eq('type', payload.type)
						.eq('ignored', false);
					if(payload.slot_start!=null) qry = qry.eq('slot_start', payload.slot_start);
					if(payload.slot_end!=null) qry = qry.eq('slot_end', payload.slot_end);
					const {data:exists, error:exErr} = await qry.limit(1);
					if(!exErr && exists && exists.length){ markDedupe(key); return; }
				}catch(ex){ console.warn('[PracticeAlerts] existence check fail, continue insert', ex); }
				try{ 
					const {data,error}=await supabaseClient.from('practice_alerts').insert(payload).select(); 
					if(error){ 
						if(error.code==='23505'){ // å”¯ä¸€çº¦æŸå†²çªï¼Œé™é»˜å¿½ç•¥
							markDedupe(key); return; 
						}
						console.warn('create alert fail', error); return;
					}
					if(!data || !Array.isArray(data) || data.length===0){
						console.debug('[PracticeAlerts] insert returned no row; will rely on realtime INSERT');
						markDedupe(key); return;
					}
					const rec=data[0]; 
					if(!rec){
						console.warn('[PracticeAlerts] insert returned undefined row; skip local add');
						markDedupe(key); return;
					}
					rec.slot={start_time:payload.slot_start,end_time:payload.slot_end}; 
					if(typeof payload.severity!=='undefined') rec.severity=payload.severity; 
					// å‰ç«¯åŠ¨æ€ç”Ÿæˆ message æ–‡æ¡ˆ
					rec._msg = raw.message || buildAlertMessage(rec);
					AlertStore.list.unshift(rec); 
					AlertStore.byId.set(String(rec.id),rec); 
					markDedupe(key); trimAlerts(); renderAlerts(); 
				}catch(e){ console.error(e); }
	}
	function trimAlerts(){ if(AlertStore.list.length>300){ AlertStore.list.length=300; } }
	function startTimer(){ if(AlertStore.timer) return; AlertStore.timer=setInterval(detectionTick, 60*1000); }
		function removeAlertLocal(id){ const idx=AlertStore.list.findIndex(i=>String(i.id)===String(id)); if(idx>=0) AlertStore.list.splice(idx,1); AlertStore.byId.delete(String(id)); }
		function buildAlertMessage(a){
			if(a.type==='absent'){
				return `${a.slot_start||a.slot?.start_time||''} æ—¶æ®µæœªç™»è®°`;
			}
			if(a.type==='anomaly'){
				return `å·²è¶…è¿‡ç»“æŸæ—¶é—´ ${(a.slot_end||a.slot?.end_time||'')}`;
			}
			return '';
		}
		function setupRealtime(){ 
			if(!window.supabaseClient) return; 
			// é˜²æŠ–ï¼šå·²æœ‰è¿æ¥åœ¨è¿›è¡Œä¸­å°±ä¸é‡å¤
			if(AlertStore._rtConnecting) return; 
			AlertStore._rtConnecting = true;
			const MAX_RETRIES = 10;
			AlertStore._rtRetry = AlertStore._rtRetry || 0;
			try{ 
				if(AlertStore._rtChannel){
					try{ supabaseClient.removeChannel(AlertStore._rtChannel); }catch(_e){}
				}
				const channel=supabaseClient.channel('realtime-practice-alerts', { config: { broadcast: { self: false } } });
				AlertStore._rtChannel = channel;
				channel.on('broadcast', {event: 'ignore'}, payload => {
					const id = payload.payload?.id;
					console.log('[PracticeAlerts][BC][ignore] æ”¶åˆ°å¹¿æ’­ id=', id);
					if(id!=null){ removeAlertLocal(id); renderAlerts(); }
				});
				channel
					.on('postgres_changes',{event:'INSERT',schema:'public',table:'practice_alerts'}, payload=>{ 
						const rec=payload.new; 
						console.log('[PracticeAlerts][RT][INSERT]', rec.id, rec.type);
						rec.slot={start_time:rec.slot_start,end_time:rec.slot_end}; 
						if(!AlertStore.byId.has(String(rec.id))){ 
							AlertStore.list.unshift(rec); 
							AlertStore.byId.set(String(rec.id),rec); 
							renderAlerts(); 
						}
					})
					.on('postgres_changes',{event:'DELETE',schema:'public',table:'practice_alerts'}, payload=>{
						const rec=payload.old; 
						console.log('[PracticeAlerts][RT][DELETE]', rec?.id);
						if(rec?.id!=null){ removeAlertLocal(rec.id); renderAlerts(); }
					})
					.on('postgres_changes',{event:'UPDATE',schema:'public',table:'practice_alerts'}, payload=>{ 
						const rec=payload.new; 
						console.log('[PracticeAlerts][RT][UPDATE]', rec.id, 'ignored=', rec.ignored);
						// è‹¥è¢«æ ‡è®°å¿½ç•¥ï¼Œç›´æ¥æœ¬åœ°ç§»é™¤
						if(rec.ignored){ removeAlertLocal(rec.id); return renderAlerts(); }
						const exist=AlertStore.byId.get(String(rec.id)); 
						if(exist){ 
							Object.assign(exist,rec); 
							exist.slot={start_time:rec.slot_start,end_time:rec.slot_end}; 
							renderAlerts(); 
						} else {
							rec.slot={start_time:rec.slot_start,end_time:rec.slot_end};
							AlertStore.list.unshift(rec);
							AlertStore.byId.set(String(rec.id), rec);
							renderAlerts();
						}
					})
					.subscribe(status=>{ 
						console.log('[PracticeAlerts][RT] subscribe status', status); 
						if(status==='SUBSCRIBED'){
							AlertStore._rtRetry = 0;
							AlertStore._rtConnecting=false;
							console.log('[PracticeAlerts][RT] âœ… å·²è¿æ¥');
						}else if(status==='CHANNEL_ERROR' || status==='TIMED_OUT'){
							AlertStore._rtConnecting=false;
							if(AlertStore._rtRetry < MAX_RETRIES){
								const delay = Math.min(30000, 500 * Math.pow(2, AlertStore._rtRetry));
								console.warn('[PracticeAlerts][RT] è¿æ¥å¤±è´¥ï¼Œå‡†å¤‡é‡è¯• #'+(AlertStore._rtRetry+1)+' å»¶è¿Ÿ', delay);
								AlertStore._rtRetry++;
								setTimeout(()=>setupRealtime(), delay);
							}else{
								console.error('[PracticeAlerts][RT] å¤šæ¬¡é‡è¯•å¤±è´¥ï¼Œæ”¾å¼ƒ');
							}
						}else if(status==='CLOSED'){
							AlertStore._rtConnecting=false;
							if(AlertStore._rtRetry < MAX_RETRIES){
								const delay = Math.min(30000, 1000 * Math.pow(1.7, AlertStore._rtRetry));
								console.warn('[PracticeAlerts][RT] è¿æ¥å…³é—­ï¼Œå°è¯•é‡è¿ #'+(AlertStore._rtRetry+1)+' å»¶è¿Ÿ', delay);
								AlertStore._rtRetry++;
								setTimeout(()=>setupRealtime(), delay);
							}
						}
					}); 
			}catch(e){ 
				AlertStore._rtConnecting=false;
				console.error('realtime alerts subscribe fail', e); 
			}
	}
		async function initAlerts(){ 
			console.log('[PracticeAlerts] initAlerts å¼€å§‹');
			await fetchExistingAlerts(); 
			await ensureSlotsLoaded(); 
			startTimer(); 
			setupRealtime(); 
			detectionTick(); 
				// å¯åŠ¨å‘¨æœŸå¯¹è´¦ï¼šæ¯30ç§’è¡¥ä¸€æ¬¡ï¼ˆè½»é‡ in æŸ¥è¯¢ï¼‰
				if(!AlertStore._reconcileInterval){ AlertStore._reconcileInterval = setInterval(()=>reconcileIgnored(), 30000); }
				scheduleReconcile(3000);
			console.log('[PracticeAlerts] initAlerts å®Œæˆ');
		}
		async function refreshSlots(runDetect){ await forceReloadSlots(); if(runDetect) detectionTick(); }
		window.PracticeAlerts={ initAlerts, renderAlerts, detectionTick, ignoreAlert, createAlert, refreshSlots, recalcToday, setFilter(f){ AlertStore.filter=f; renderAlerts(); } };
	document.addEventListener('DOMContentLoaded',()=>{ 
		console.log('[PracticeAlerts] DOMContentLoaded è§¦å‘');
		console.log('[PracticeAlerts] window.supabaseClient:', !!window.supabaseClient);
		
		// ç›´æ¥æ£€æŸ¥ supabaseClient è€Œä¸æ˜¯ supabaseReady
		if(window.supabaseClient) {
			console.log('[PracticeAlerts] supabaseClient å­˜åœ¨ï¼Œ1.2ç§’åå¯åŠ¨');
			setTimeout(()=>initAlerts(), 1200); 
		} else { 
			console.log('[PracticeAlerts] supabaseClient ä¸å­˜åœ¨ï¼Œç­‰å¾…ä¸­...');
			const tick=setInterval(()=>{ 
				console.log('[PracticeAlerts] æ£€æŸ¥ supabaseClient:', !!window.supabaseClient);
				if(window.supabaseClient){ 
					console.log('[PracticeAlerts] supabaseClient å·²å°±ç»ªï¼Œå¯åŠ¨ä¸­...');
					clearInterval(tick); 
					initAlerts(); 
				} 
			},800); 
		} 
		document.addEventListener('click',e=>{ const t=e.target; if(t.classList && t.classList.contains('alert-filter-btn')){ PracticeAlerts.setFilter(t.dataset.filter); }}); 
	});
})();
</script>

</body>
</html>
